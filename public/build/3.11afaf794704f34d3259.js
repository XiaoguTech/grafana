(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{1097:function(e,t){
/*!
 * jquery.flot.gauge v1.1.0 *
 *
 * Flot plugin for rendering gauge charts.
 *
 * Copyright (c) 2015 @toyoty99.
 * Licensed under the MIT license.
 */
!function(e){var t=function(){var t,i,s,o,l,u=function(e,r){t=r,i=e.getPlaceholder(),s=e.getOptions(),o=s.series.gauges,l=e.getData(),a(o.debug)};function c(e,t){"auto"===e.gauge.width&&(e.gauge.width=Math.max(5,t/8)),"auto"===e.label.margin&&(e.label.margin=Math.max(1,t/20)),"auto"===e.label.font.size&&(e.label.font.size=Math.max(5,t/8)),"auto"===e.value.margin&&(e.value.margin=Math.max(1,t/30)),"auto"===e.value.font.size&&(e.value.font.size=Math.max(5,t/9)),"auto"===e.threshold.width&&(e.threshold.width=Math.max(3,t/100)),"auto"===e.threshold.label.margin&&(e.threshold.label.margin=Math.max(3,t/40)),"auto"===e.threshold.label.font.size&&(e.threshold.label.font.size=Math.max(5,t/15))}function d(e,t,a){var r=e.gauge.startAngle+(e.gauge.endAngle-e.gauge.startAngle)*((a-e.gauge.min)/(e.gauge.max-e.gauge.min));return r<e.gauge.startAngle?r=e.gauge.startAngle:r>e.gauge.endAngle&&(r=e.gauge.endAngle),r}function p(e,a,r,i,s,o,l,u,c,d){s!==o&&(t.save(),n(t,e,a,r,i,s,o,l,u,c),d&&(n(t,e,a,r,i,s,o),t.clip(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=10,t.shadowColor="gray",n(t,e,a,r+1,i+2,s,o,l,1)),t.restore())}function h(e,t,a,n,i,s){m(a.cx+(t.thresholdLabelMargin+t.thresholdLabelFontSize/2+t.radius)*Math.cos(r(s)),a.cy+(t.thresholdLabelMargin+t.thresholdLabelFontSize/2+t.radius)*Math.sin(r(s)),"flotGagueThresholdValue"+n,e.threshold.label.formatter?e.threshold.label.formatter(i):i,e.threshold.label,s)}function m(t,a,r,n,s,o){var l=e("."+r,i),u=l.length;u||((l=e("<span></span>")).attr("id",r),l.css("position","absolute"),l.css("top",a+"px"),s.font.size&&l.css("font-size",s.font.size+"px"),s.font.family&&l.css("font-family",s.font.family),s.color&&l.css("color",s.color),s.background.color&&l.css("background-color",s.background.color),s.background.opacity&&l.css("opacity",s.background.opacity),i.append(l)),l.text(n),l.css("left",t+"px"),l.css("left",parseInt(l.css("left"))-l.width()/2+"px"),!u&&o&&(l.css("top",parseInt(l.css("top"))-l.height()/2+"px"),l.css("transform","rotate("+(180*o+90)+"deg)"))}return u.prototype.calculateLayout=function(){var e=i.width(),t=i.height(),a=Math.min(l.length,o.layout.columns),n=Math.ceil(l.length/a),s=o.layout.margin,u=o.layout.hMargin,d=o.layout.vMargin,p=(e-2*s-u*(a-1))/a,h=(t-2*s-d*(n-1))/n;if(o.layout.square){var m=Math.min(p,h);p=m,h=m}c(o,p);var f=o.cell.margin,g=0,v=0;o.label.show&&(g=o.label.margin,v=o.label.font.size);var y=0,b=0;o.value.show&&(y=o.value.margin,b=o.value.font.size);var S=0;o.threshold.show&&(S=o.threshold.width);var x=0,w=0;o.threshold.label.show&&(x=o.threshold.label.margin,w=o.threshold.label.font.size);for(var k=p/2-f-S-2*x-w,C=o.gauge.startAngle,T=o.gauge.endAngle,_=(T-C)/100,M=-1,$=C;$<T;$+=_)M=Math.max(M,Math.sin(r($)));var P=(h-2*f-2*g-v)/(1+(M=Math.max(M,Math.sin(r(T)))));P*M<y+b/2&&(P=h-2*f-2*g-v-y-b/2);var E=P-2*x-w-S,D=Math.min(k,E),A=o.gauge.width;A>=D&&(A=Math.max(3,D/3));var F=2*x+w+S+D;return{canvasWidth:e,canvasHeight:t,margin:s,hMargin:u,vMargin:d,columns:a,rows:n,cellWidth:p,cellHeight:h,cellMargin:f,labelMargin:g,labelFontSize:v,valueMargin:y,valueFontSize:b,width:A,radius:D,thresholdWidth:S,thresholdLabelMargin:x,thresholdLabelFontSize:w,gaugeOuterHeight:Math.max(F*(1+M),F+y+b/2)}},u.prototype.calculateAutoValues=c,u.prototype.calculateCellLayout=function(e,t,a){var r=function(e,t){return t%e}(t.columns,a),n=function(e,t){return Math.floor(t/e)}(t.columns,a),i=t.margin+(t.cellWidth+t.hMargin)*r,s=t.margin+(t.cellHeight+t.vMargin)*n,o=i+t.cellWidth/2,l=s+t.cellMargin+2*t.labelMargin+t.labelFontSize+t.thresholdWidth+t.thresholdLabelFontSize+2*t.thresholdLabelMargin+t.radius,u=t.cellHeight-2*t.cellMargin-2*t.labelMargin-t.labelFontSize-t.gaugeOuterHeight,c=0;return"middle"===e.cell.vAlign?c=u/2:"bottom"===e.cell.vAlign&&(c=u),l+=c,{col:r,row:n,x:i,y:s,offsetY:c,cellWidth:t.cellWidth,cellHeight:t.cellHeight,cellMargin:t.cellMargin,cx:o,cy:l}},u.prototype.drawBackground=function(e){o.frame.show&&(t.save(),t.strokeStyle=s.grid.borderColor,t.lineWidth=s.grid.borderWidth,t.strokeRect(0,0,e.canvasWidth,e.canvasHeight),s.grid.backgroundColor&&(t.fillStyle=s.grid.backgroundColor,t.fillRect(0,0,e.canvasWidth,e.canvasHeight)),t.restore())},u.prototype.drawCellBackground=function(e,a){t.save(),e.cell.border&&e.cell.border.show&&e.cell.border.color&&e.cell.border.width&&(t.strokeStyle=e.cell.border.color,t.lineWidth=e.cell.border.width,t.strokeRect(a.x,a.y,a.cellWidth,a.cellHeight)),e.cell.background&&e.cell.background.color&&(t.fillStyle=e.cell.background.color,t.fillRect(a.x,a.y,a.cellWidth,a.cellHeight)),t.restore()},u.prototype.drawGauge=function(e,t,a,n,i){var s=e.gauge.shadow.show?e.gauge.shadow.blur:0;p(a.cx,a.cy,t.radius,t.width,r(e.gauge.startAngle),r(e.gauge.endAngle),e.gauge.border.color,e.gauge.border.width,e.gauge.background.color,s);var o=function(e,t){for(var a,r=0;r<e.threshold.values.length;r++){var n=e.threshold.values[r];if(a=n.color,t<n.value)break}return a}(e,i),l=d(e,t,i);p(a.cx,a.cy,t.radius-1,t.width-2,r(e.gauge.startAngle),r(l),o,1,o,s)},u.prototype.drawThreshold=function(e,a,i){for(var s=e.gauge.startAngle,o=0;o<e.threshold.values.length;o++){var l=e.threshold.values[o];c1=l.color,a2=d(e,0,l.value),n(t,i.cx,i.cy,a.radius+a.thresholdWidth,a.thresholdWidth-2,r(s),r(a2),c1,1,c1),s=a2}},u.prototype.drawLable=function(e,t,a,r,n){m(a.cx,a.y+a.cellMargin+t.labelMargin+a.offsetY,"flotGagueLabel"+r,e.label.formatter?e.label.formatter(n.label,n.data[0][1]):text,e.label)},u.prototype.drawValue=function(e,t,a,r,n){m(a.cx,a.cy-e.value.font.size/2,"flotGagueValue"+r,e.value.formatter?e.value.formatter(n.label,n.data[0][1]):text,e.value)},u.prototype.drawThresholdValues=function(e,t,a,r){h(e,t,a,"Min"+r,e.gauge.min,e.gauge.startAngle),h(e,t,a,"Max"+r,e.gauge.max,e.gauge.endAngle);for(var n=0;n<e.threshold.values.length;n++){var i=e.threshold.values[n];if(i.value>e.gauge.min&&i.value<e.gauge.max){var s=d(e,0,i.value);h(e,t,a,r+"_"+n,i.value,s)}}},u}();function a(e){return"undefined"!=typeof Logger?new Logger(e):null}function r(e){return e*Math.PI}function n(e,t,a,r,n,i,s,o,l,u){if(i!==s){e.save(),e.beginPath(),e.arc(t,a,r,i,s,!1),e.lineTo(t+(r-n)*Math.cos(s),a+(r-n)*Math.sin(s)),e.arc(t,a,r-n,s,i,!0),e.closePath(),l&&(e.lineWidth=l),o&&(e.strokeStyle=o,e.stroke()),u&&(e.fillStyle=u,e.fill()),e.restore()}}var i={series:{gauges:{debug:{log:!1,layout:!1,alert:!1},show:!1,layout:{margin:5,columns:3,hMargin:5,vMargin:5,square:!1},frame:{show:!0},cell:{background:{color:null},border:{show:!0,color:"black",width:1},margin:5,vAlign:"middle"},gauge:{width:"auto",startAngle:.9,endAngle:2.1,min:0,max:100,background:{color:"white"},border:{color:"lightgray",width:2},shadow:{show:!0,blur:5}},label:{show:!0,margin:"auto",background:{color:null,opacity:0},font:{size:"auto",family:"sans-serif"},color:null,formatter:function(e,t){return e}},value:{show:!0,margin:"auto",background:{color:null,opacity:0},font:{size:"auto",family:"sans-serif"},color:null,formatter:function(e,t){return parseInt(t)}},threshold:{show:!0,width:"auto",label:{show:!0,margin:"auto",background:{color:null,opacity:0},font:{size:"auto",family:",sans-serif"},color:null,formatter:function(e){return e}},values:[{value:50,color:"lightgreen"},{value:80,color:"yellow"},{value:100,color:"red"}]}}}};e.plot.plugins.push({init:function(r){r.hooks.processOptions.push(function(e,t){a(t.series.gauges.debug),t.series.gauges.show&&(t.grid.show=!1,t.legend.show=!1),t.series.gauges.threshold.values.sort(function(e,t){return e.value<t.value?-1:e.value>t.value?1:0})}),r.hooks.draw.push(function(r,n){var i=r.getOptions().series.gauges;if(a(i.debug),i.show){var s=r.getData();if(s&&s.length){var o=new t(r,n),l=o.calculateLayout();i.debug.layout,o.drawBackground(l);for(var u=0;u<s.length;u++){var c=s[u],d=e.extend({},i,c.gauges);c.gauges&&o.calculateAutoValues(d,l.cellWidth);var p=o.calculateCellLayout(d,l,u);o.drawCellBackground(d,p),d.debug.layout,d.label.show&&o.drawLable(d,l,p,u,c),o.drawGauge(d,l,p,c.label,c.data[0][1]),d.threshold.show&&o.drawThreshold(d,l,p),d.threshold.label.show&&o.drawThresholdValues(d,l,p,u),d.value.show&&o.drawValue(d,l,p,u,c)}}}})},options:i,name:"gauge",version:"1.1.0"})}(jQuery)},1098:function(e,t){!function(e){jQuery.plot.plugins.push({init:function(e){e.hooks.processDatapoints.push(function(e,t,a){t.dashes.show&&e.hooks.draw.push(function(e,r){var n=e.getPlotOffset(),i=t.xaxis,s=t.yaxis;function o(e,n){var o,l,u=a.points,c=a.pointsize,d=null,p=null,h=0,m=!0;t.dashes.dashLength[0]?(o=t.dashes.dashLength[0],l=t.dashes.dashLength[1]?t.dashes.dashLength[1]:o):l=o=t.dashes.dashLength,r.beginPath();for(var f=c;f<u.length;f+=c){var g=u[f-c],v=u[f-c+1],y=u[f],b=u[f+1];if(null!=g&&null!=y){if(v<=b&&v<s.min){if(b<s.min)continue;g=(s.min-v)/(b-v)*(y-g)+g,v=s.min}else if(b<=v&&b<s.min){if(v<s.min)continue;y=(s.min-v)/(b-v)*(y-g)+g,b=s.min}if(v>=b&&v>s.max){if(b>s.max)continue;g=(s.max-v)/(b-v)*(y-g)+g,v=s.max}else if(b>=v&&b>s.max){if(v>s.max)continue;y=(s.max-v)/(b-v)*(y-g)+g,b=s.max}if(g<=y&&g<i.min){if(y<i.min)continue;v=(i.min-g)/(y-g)*(b-v)+v,g=i.min}else if(y<=g&&y<i.min){if(g<i.min)continue;b=(i.min-g)/(y-g)*(b-v)+v,y=i.min}if(g>=y&&g>i.max){if(y>i.max)continue;v=(i.max-g)/(y-g)*(b-v)+v,g=i.max}else if(y>=g&&y>i.max){if(g>i.max)continue;b=(i.max-g)/(y-g)*(b-v)+v,y=i.max}g==d&&v==p||r.moveTo(i.p2c(g)+e,s.p2c(v)+n);var S,x=i.p2c(g)+e,w=s.p2c(v)+n,k=i.p2c(y)+e,C=s.p2c(b)+n;do{0==(S=T(h>0?h:m?o:l)).deltaX&&0==S.deltaY||(m?r.lineTo(x+S.deltaX,w+S.deltaY):r.moveTo(x+S.deltaX,w+S.deltaY)),m=!m,h=S.remainder,x+=S.deltaX,w+=S.deltaY}while(S.distance>0);d=y,p=b}function T(e){var t=Math.sqrt(Math.pow(k-x,2)+Math.pow(C-w,2));if(t<=e)return{deltaX:k-x,deltaY:C-w,distance:t,remainder:e-t};var a=C>w?1:-1;return{deltaX:(k>x?1:-1)*Math.sqrt(Math.pow(e,2)/(1+Math.pow((C-w)/(k-x),2))),deltaY:a*Math.sqrt(Math.pow(e,2)-Math.pow(e,2)/(1+Math.pow((C-w)/(k-x),2))),distance:e,remainder:0}}}r.stroke()}r.save(),r.translate(n.left,n.top),r.lineJoin="round";var l=t.dashes.lineWidth,u=t.shadowSize;if(l>0&&u>0){r.lineWidth=u,r.strokeStyle="rgba(0,0,0,0.1)";var c=Math.PI/18;o(Math.sin(c)*(l/2+u/2),Math.cos(c)*(l/2+u/2)),r.lineWidth=u/2,o(Math.sin(c)*(l/2+u/4),Math.cos(c)*(l/2+u/4))}r.lineWidth=l,r.strokeStyle=t.color,l>0&&o(0,0),r.restore()})})},options:{series:{dashes:{show:!1,lineWidth:2,dashLength:10}}},name:"dashes",version:"0.1"})}()},1099:function(e,t){!function(e){jQuery.plot.plugins.push({init:function(e){var t={x:-1,y:-1,locked:!1};function a(a){t.locked||-1!=t.x&&(t.x=-1,e.triggerRedrawOverlay())}function r(a){if(!t.locked)if(e.getSelection&&e.getSelection())t.x=-1;else{var r=e.offset();t.x=Math.max(0,Math.min(a.pageX-r.left,e.width())),t.y=Math.max(0,Math.min(a.pageY-r.top,e.height())),e.triggerRedrawOverlay()}}e.setCrosshair=function(a){if(a){var r=e.p2c(a);t.x=Math.max(0,Math.min(r.left,e.width())),t.y=Math.max(0,Math.min(r.top,e.height()))}else t.x=-1;e.triggerRedrawOverlay()},e.clearCrosshair=e.setCrosshair,e.lockCrosshair=function(a){a&&e.setCrosshair(a),t.locked=!0},e.unlockCrosshair=function(){t.locked=!1},e.hooks.bindEvents.push(function(e,t){e.getOptions().crosshair.mode&&(t.mouseout(a),t.mousemove(r))}),e.hooks.drawOverlay.push(function(e,a){var r=e.getOptions().crosshair;if(r.mode){var n=e.getPlotOffset();if(a.save(),a.translate(n.left,n.top),-1!=t.x){var i=e.getOptions().crosshair.lineWidth%2?.5:0;if(a.strokeStyle=r.color,a.lineWidth=r.lineWidth,a.lineJoin="round",a.beginPath(),-1!=r.mode.indexOf("x")){var s=Math.floor(t.x)+i;a.moveTo(s,0),a.lineTo(s,e.height())}if(-1!=r.mode.indexOf("y")){var o=Math.floor(t.y)+i;a.moveTo(0,o),a.lineTo(e.width(),o)}a.stroke()}a.restore()}}),e.hooks.shutdown.push(function(e,t){t.unbind("mouseout",a),t.unbind("mousemove",r)})},options:{crosshair:{mode:null,color:"rgba(170, 0, 0, 0.80)",lineWidth:1}},name:"crosshair",version:"1.0"})}()},1100:function(e,t){!function(e){"use strict";e.plot.plugins.push({init:function(t){function a(e,t,a,r,n,i,s,o){var l,u,c,d,p,h;return h=((c=s-n)*(t-i)-(d=o-i)*(e-n))/(-c*(u=r-t)+(l=a-e)*d),(p=(-u*(e-n)+l*(t-i))/(-c*u+l*d))>=0&&p<=1&&h>=0&&h<=1?[e+h*l,t+h*u]:null}t.hooks.drawSeries.push(function(t,r,n){var i,s,o,l,u,c,d;function p(e,t){r.beginPath(),r.moveTo(n.xaxis.p2c(e)+c.left,n.yaxis.p2c(t)+c.top)}function h(e,t){console.assert(t>e,"expects the end index to be greater than the start index");var a,r,n=0===e||null===o[e-1]||null===u[e-1],i=!1;for(a=e;a<t;a++)if(null===o[a*s+1]||null===u[a*s+1])i=!1,n=!0;else if(o[a*s+1]===u[a*l+1])i=!0,n=!1;else{if(o[a*s+1]>u[a*l+1])return n?p(o[a*s],o[a*s+1]):i?p(o[(a-1)*s],o[(a-1)*s+1]):p((r=m(a))[0],r[1]),void g(a,t);n=!1,i=!1}}function m(e){var t,r;for(console.assert(e>0,"expects the second point in the series line segment"),t=1;t<u.length/l;t++)if(null!==(r=a(o[(e-1)*s],o[(e-1)*s+1],o[e*s],o[e*s+1],u[(t-1)*l],u[(t-1)*l+1],u[t*l],u[t*l+1])))return r;console.error("intersectionPoint() should only be called when an intersection happens")}function f(e,t){var a;for(console.assert(e>=t,"the start should be the rightmost point, and the end should be the leftmost (excluding the equal or intersecting point)"),a=e;a>=t;a--)r.lineTo(i.xaxis.p2c(u[a*l])+c.left,i.yaxis.p2c(u[a*l+1])+c.top);r.closePath(),r.fill()}function g(e,t){var a,i;for(console.assert(e<=t,"the start should be the rightmost point, and the end should be the leftmost (excluding the equal or intersecting point)"),a=e;a<t;a++){if(null===o[a*s+1]&&a>e)return f(a-1,e),void h(a,t);if(o[a*s+1]===u[a*l+1])return f(a,e),void h(a,t);if(o[a*s+1]<u[a*l+1])return i=m(a),r.lineTo(n.xaxis.p2c(i[0])+c.left,n.yaxis.p2c(i[1])+c.top),f(a,e),void h(a,t);r.lineTo(n.xaxis.p2c(o[a*s])+c.left,n.yaxis.p2c(o[a*s+1])+c.top)}f(t,e)}null!==n.fillBelowTo&&(i=function(e,t){var a;for(a=0;a<t.length;++a)if(t[a].id===e.fillBelowTo)return t[a];return null}(n,t.getData()))&&(s=n.datapoints.pointsize,o=n.datapoints.points,l=i.datapoints.pointsize,u=i.datapoints.points,c=t.getPlotOffset(),function(){if(o.length/s!=u.length/l)return console.error("Refusing to graph inconsistent number of points"),!1;var e;for(e=0;e<o.length/s;e++)if(null!==o[e*s]&&null!==u[e*l]&&o[e*s]!==u[e*l])return console.error("Refusing to graph points without matching value"),!1;return!0}()&&((d=e.color.parse(n.color)).a=.4,d.normalize(),r.fillStyle=d.toString(),h(0,o.length/s)))})},options:{series:{fillBelowTo:null}},name:"fillbelow",version:"0.1.0"})}(jQuery)},1101:function(e,t){!function(e){jQuery.plot.plugins.push({init:function(e){var t={},a=!1,r={};function n(e){var t=e.length,a={};if(t>0)for(var r=0;r<t;r++)if(e[r].stackpercent){var n=0,i=1;e[r].bars&&e[r].bars.horizontal&&!0===e[r].bars.horizontal&&(n=1,i=0);for(var s=e[r].data.length,o=0;o<s;o++){var l=0;null!=e[r].data[o][1]&&(l=e[r].data[o][i]),a[e[r].data[o][n]+""]?a[e[r].data[o][n]+""]+=l:a[e[r].data[o][n]+""]=l}}return a}e.hooks.processRawData.push(function(e,t,i,s){if(a||(a=!0,r=n(e.getData())),1==t.stackpercent){var o=i.length;t.percents=[];var l=0,u=1;t.bars&&t.bars.horizontal&&!0===t.bars.horizontal&&(l=1,u=0);for(var c=0;c<o;c++){var d=r[i[c][l]+""];d>0?t.percents.push(100*i[c][u]/d):t.percents.push(0)}}}),e.hooks.processDatapoints.push(function(e,i,s){if(i.stackpercent){a||(r=n(e.getData()));var o=[],l=0,u=1;i.bars&&i.bars.horizontal&&!0===i.bars.horizontal&&(l=1,u=0);for(var c=0;c<s.points.length;c+=3)t[s.points[c+l]]||(t[s.points[c+l]]=0),o[c+l]=s.points[c+l],o[c+u]=s.points[c+u]+t[s.points[c+l]],o[c+2]=t[s.points[c+l]],t[s.points[c+l]]+=s.points[c+u],r[o[c+l]+""]>0?(o[c+u]=100*o[c+u]/r[o[c+l]+""],o[c+2]=100*o[c+2]/r[o[c+l]+""]):(o[c+u]=0,o[c+2]=0);s.points=o}})},options:{series:{stackpercent:null}},name:"stackpercent",version:"0.1"})}()},1102:function(e,t){!function(e){jQuery.plot.plugins.push({init:function(e){e.hooks.processDatapoints.push(function(e,t,a){if(null!=t.stack&&!1!==t.stack){var r=function(e,t){for(var a=null,r=0;r<t.length&&e!=t[r];++r)t[r].stack==e.stack&&(a=t[r]);return a}(t,e.getData());if(r){for(var n,i,s,o,l,u,c,d,p=a.pointsize,h=a.points,m=r.datapoints.pointsize,f=r.datapoints.points,g=[],v=t.lines.show,y=t.bars.horizontal,b=p>2&&(y?a.format[2].x:a.format[2].y),S=v&&t.lines.steps,x=y?1:0,w=y?0:1,k=0,C=0;!(k>=h.length&&C>=f.length);){if(c=g.length,k<h.length&&null==h[k]){for(d=0;d<p;++d)g.push(h[k+d]);k+=p}else if(k>=h.length){for(d=0;d<p;++d)g.push(f[C+d]);b&&(g[c+2]=f[C+w]),C+=m}else if(C>=f.length){for(d=0;d<p;++d)g.push(h[k+d]);k+=p}else if(C<f.length&&null==f[C])C+=m;else{if(n=h[k+x],i=h[k+w],o=f[C+x],l=f[C+w],u=0,n==o){for(d=0;d<p;++d)g.push(h[k+d]);g[c+w]+=l,u=l,k+=p,C+=m}else if(n>o){if(0==k){for(d=0;d<p;++d)g.push(f[C+d]);u=l}if(k>0&&null!=h[k-p]){for(s=i+(h[k-p+w]-i)*(o-n)/(h[k-p+x]-n),g.push(o),g.push(s+l),d=2;d<p;++d)g.push(h[k+d]);u=l}C+=m}else{for(d=0;d<p;++d)g.push(h[k+d]);C>0&&null!=f[C-m]&&(u=l+(f[C-m+w]-l)*(n-o)/(f[C-m+x]-o)),g[c+w]+=u,k+=p}fromgap=!1,c!=g.length&&b&&(g[c+2]=u)}if(S&&c!=g.length&&c>0&&null!=g[c]&&g[c]!=g[c-p]&&g[c+1]!=g[c-p+1]){for(d=0;d<p;++d)g[c+p+d]=g[c+d];g[c+1]=g[c-p+1]}}a.points=g}}})},options:{series:{stack:null}},name:"stack",version:"1.2"})}()},1103:function(e,t){!function(e){e.plot.plugins.push({init:function(t){var a={first:{x:-1,y:-1},second:{x:-1,y:-1},show:!1,active:!1},r={},n=null;function i(e){a.active&&(d(e),t.getPlaceholder().trigger("plotselecting",[o()]))}function s(i){1==i.which&&(document.body.focus(),void 0!==document.onselectstart&&null==r.onselectstart&&(r.onselectstart=document.onselectstart,document.onselectstart=function(){return!1}),void 0!==document.ondrag&&null==r.ondrag&&(r.ondrag=document.ondrag,document.ondrag=function(){return!1}),c(a.first,i),a.active=!0,n=function(e){!function(e){n=null,void 0!==document.onselectstart&&(document.onselectstart=r.onselectstart),void 0!==document.ondrag&&(document.ondrag=r.ondrag),a.active=!1,d(e),m()?l(e):(t.getPlaceholder().trigger("plotunselected",[]),t.getPlaceholder().trigger("plotselecting",[null])),setTimeout(function(){t.isSelecting=!1},10)}(e)},e(document).one("mouseup",n))}function o(){if(!m())return null;if(!a.show)return null;var r={},n=a.first,i=a.second,s=t.getAxes();return e.each(s,function(e,t){t.used&&(anyUsed=!1)}),e.each(s,function(e,t){t.used;var a=t.c2p(n[t.direction]),s=t.c2p(i[t.direction]);r[e]={from:Math.min(a,s),to:Math.max(a,s)}}),r}function l(e){var a=o();a.ctrlKey=e.ctrlKey,a.metaKey=e.metaKey,t.getPlaceholder().trigger("plotselected",[a]),a.xaxis&&a.yaxis&&t.getPlaceholder().trigger("selected",[{x1:a.xaxis.from,y1:a.yaxis.from,x2:a.xaxis.to,y2:a.yaxis.to}])}function u(e,t,a){return t<e?e:t>a?a:t}function c(e,r){var n=t.getOptions(),i=t.getPlaceholder().offset(),s=t.getPlotOffset();e.x=u(0,r.pageX-i.left-s.left,t.width()),e.y=u(0,r.pageY-i.top-s.top,t.height()),"y"==n.selection.mode&&(e.x=e==a.first?0:t.width()),"x"==n.selection.mode&&(e.y=e==a.first?0:t.height())}function d(e){null!=e.pageX&&(c(a.second,e),m()?(t.isSelecting=!0,a.show=!0,t.triggerRedrawOverlay()):p(!0))}function p(e){a.show&&(a.show=!1,t.triggerRedrawOverlay(),e||t.getPlaceholder().trigger("plotunselected",[]))}function h(e,a){var r,n,i,s,o=t.getAxes();for(var l in o)if((r=o[l]).direction==a&&(e[s=a+r.n+"axis"]||1!=r.n||(s=a+"axis"),e[s])){n=e[s].from,i=e[s].to;break}if(e[s]||(r="x"==a?t.getXAxes()[0]:t.getYAxes()[0],n=e[a+"1"],i=e[a+"2"]),null!=n&&null!=i&&n>i){var u=n;n=i,i=u}return{from:n,to:i,axis:r}}function m(){var e=t.getOptions().selection.minSize;return Math.abs(a.second.x-a.first.x)>=e&&Math.abs(a.second.y-a.first.y)>=e}t.clearSelection=p,t.setSelection=function(e,r){var n,i=t.getOptions();"y"==i.selection.mode?(a.first.x=0,a.second.x=t.width()):(n=h(e,"x"),a.first.x=n.axis.p2c(n.from),a.second.x=n.axis.p2c(n.to)),"x"==i.selection.mode?(a.first.y=0,a.second.y=t.height()):(n=h(e,"y"),a.first.y=n.axis.p2c(n.from),a.second.y=n.axis.p2c(n.to)),a.show=!0,t.triggerRedrawOverlay(),!r&&m()&&l()},t.getSelection=o,t.hooks.bindEvents.push(function(e,t){null!=e.getOptions().selection.mode&&(t.mousemove(i),t.mousedown(s))}),t.hooks.drawOverlay.push(function(t,r){if(a.show&&m()){var n=t.getPlotOffset(),i=t.getOptions();r.save(),r.translate(n.left,n.top);var s=e.color.parse(i.selection.color);r.strokeStyle=s.scale("a",.8).toString(),r.lineWidth=1,r.lineJoin=i.selection.shape,r.fillStyle=s.scale("a",.4).toString();var o=Math.min(a.first.x,a.second.x)+.5,l=Math.min(a.first.y,a.second.y)+.5,u=Math.abs(a.second.x-a.first.x)-1,c=Math.abs(a.second.y-a.first.y)-1;r.fillRect(o,l,u,c),r.strokeRect(o,l,u,c),r.restore()}}),t.hooks.shutdown.push(function(t,a){a.unbind("mousemove",i),a.unbind("mousedown",s),n&&e(document).unbind("mouseup",n)})},options:{selection:{mode:null,color:"#e8cfac",shape:"round",minSize:5}},name:"selection",version:"1.1"})}(jQuery)},1106:function(e,t){!function(e){var t=10,a=.95;var r={series:{pie:{show:!1,radius:"auto",innerRadius:0,startAngle:1.5,tilt:1,shadow:{left:5,top:15,alpha:.02},offset:{top:0,left:"auto"},stroke:{color:"#fff",width:1},label:{show:"auto",formatter:function(e,t){return"<div style='font-size:x-small;text-align:center;padding:2px;color:"+t.color+";'>"+e+"<br/>"+Math.round(t.percent)+"%</div>"},radius:1,background:{color:null,opacity:0},threshold:0},combine:{threshold:-1,color:null,label:"Other"},highlight:{opacity:.5}}}};e.plot.plugins.push({init:function(n){var i=null,s=null,o=null,l=null,u=null,c=!1,d=null,p=[];function h(t,a,n){c||(c=!0,i=t.getCanvas(),s=e(i).parent(),r=t.getOptions(),t.setData(function(t){for(var a=0,n=0,i=0,s=r.series.pie.combine.color,o=[],l=0;l<t.length;++l){var u=t[l].data;e.isArray(u)&&1==u.length&&(u=u[0]),e.isArray(u)?!isNaN(parseFloat(u[1]))&&isFinite(u[1])?u[1]=+u[1]:u[1]=0:u=!isNaN(parseFloat(u))&&isFinite(u)?[1,+u]:[1,0],t[l].data=[u]}for(var l=0;l<t.length;++l)a+=t[l].data[0][1];for(var l=0;l<t.length;++l){var u=t[l].data[0][1];u/a<=r.series.pie.combine.threshold&&(n+=u,i++,s||(s=t[l].color))}for(var l=0;l<t.length;++l){var u=t[l].data[0][1];(i<2||u/a>r.series.pie.combine.threshold)&&o.push({data:[[1,u]],color:t[l].color,label:t[l].label,angle:u*Math.PI*2/a,percent:u/(a/100)})}return i>1&&o.push({data:[[1,n]],color:s,label:r.series.pie.combine.label,angle:n*Math.PI*2/a,percent:n/(a/100)}),o}(t.getData())))}function m(n,i){if(s){var p=n.getPlaceholder().width(),h=n.getPlaceholder().height(),m=s.children().filter(".legend").children().width()||0;d=i,c=!1,o=Math.min(p,h/r.series.pie.tilt)/2,u=h/2+r.series.pie.offset.top,l=p/2,"auto"==r.series.pie.offset.left?r.legend.position.match("w")?l+=m/2:l-=m/2:l+=r.series.pie.offset.left,l<o?l=o:l>p-o&&(l=p-o);var g=n.getData(),v=0;do{v>0&&(o*=a),v+=1,y(),r.series.pie.tilt<=.8&&b()}while(!S()&&v<t);v>=t&&(y(),s.prepend("<div class='error'>Could not draw pie with labels contained inside canvas</div>")),n.setSeries&&n.insertLegend&&(n.setSeries(g),n.insertLegend())}function y(){d.clearRect(0,0,p,h),s.children().filter(".pieLabel, .pieLabelBackground").remove()}function b(){var e=r.series.pie.shadow.left,t=r.series.pie.shadow.top,a=r.series.pie.shadow.alpha,n=r.series.pie.radius>1?r.series.pie.radius:o*r.series.pie.radius;if(!(n>=p/2-e||n*r.series.pie.tilt>=h/2-t||n<=10)){d.save(),d.translate(e,t),d.globalAlpha=a,d.fillStyle="#000",d.translate(l,u),d.scale(1,r.series.pie.tilt);for(var i=1;i<=10;i++)d.beginPath(),d.arc(0,0,n,0,2*Math.PI,!1),d.fill(),n-=i;d.restore()}}function S(){var t=Math.PI*r.series.pie.startAngle,a=r.series.pie.radius>1?r.series.pie.radius:o*r.series.pie.radius;d.save(),d.translate(l,u),d.scale(1,r.series.pie.tilt),d.save();for(var n=t,i=0;i<g.length;++i)g[i].startAngle=n,c(g[i].angle,g[i].color,!0);if(d.restore(),r.series.pie.stroke.width>0){for(d.save(),d.lineWidth=r.series.pie.stroke.width,n=t,i=0;i<g.length;++i)c(g[i].angle,r.series.pie.stroke.color,!1);d.restore()}return f(d),d.restore(),!r.series.pie.label.show||function(){for(var a=t,n=r.series.pie.label.radius>1?r.series.pie.label.radius:o*r.series.pie.label.radius,i=0;i<g.length;++i){if(g[i].percent>=100*r.series.pie.label.threshold&&!c(g[i],a,i))return!1;a+=g[i].angle}return!0;function c(t,a,i){if(0==t.data[0][1])return!0;var o,c=r.legend.labelFormatter,d=r.series.pie.label.formatter;o=c?c(t.label,t):t.label,d&&(o=d(o,t));var m=(a+t.angle+a)/2,f=l+Math.round(Math.cos(m)*n),g=u+Math.round(Math.sin(m)*n)*r.series.pie.tilt,v="<span class='pieLabel' id='pieLabel"+i+"' style='position:absolute;top:"+g+"px;left:"+f+"px;'>"+o+"</span>";s.append(v);var y=s.children("#pieLabel"+i),b=g-y.height()/2,S=f-y.width()/2;if(y.css("top",b),y.css("left",S),0-b>0||0-S>0||h-(b+y.height())<0||p-(S+y.width())<0)return!1;if(0!=r.series.pie.label.background.opacity){var x=r.series.pie.label.background.color;null==x&&(x=t.color);var w="top:"+b+"px;left:"+S+"px;";e("<div class='pieLabelBackground' style='position:absolute;width:"+y.width()+"px;height:"+y.height()+"px;"+w+"background-color:"+x+";'></div>").css("opacity",r.series.pie.label.background.opacity).insertBefore(y)}return!0}}();function c(e,t,r){e<=0||isNaN(e)||(r?d.fillStyle=t:(d.strokeStyle=t,d.lineJoin="round"),d.beginPath(),Math.abs(e-2*Math.PI)>1e-9&&d.moveTo(0,0),d.arc(0,0,a,n,n+e/2,!1),d.arc(0,0,a,n+e/2,n+e,!1),d.closePath(),n+=e,r?d.fill():d.stroke())}}}function f(e){if(r.series.pie.innerRadius>0){e.save();var t=r.series.pie.innerRadius>1?r.series.pie.innerRadius:o*r.series.pie.innerRadius;e.globalCompositeOperation="destination-out",e.beginPath(),e.fillStyle=r.series.pie.stroke.color,e.arc(0,0,t,0,2*Math.PI,!1),e.fill(),e.closePath(),e.restore(),e.save(),e.beginPath(),e.strokeStyle=r.series.pie.stroke.color,e.arc(0,0,t,0,2*Math.PI,!1),e.stroke(),e.closePath(),e.restore()}}function g(e,t){for(var a=!1,r=-1,n=e.length,i=n-1;++r<n;i=r)(e[r][1]<=t[1]&&t[1]<e[i][1]||e[i][1]<=t[1]&&t[1]<e[r][1])&&t[0]<(e[i][0]-e[r][0])*(t[1]-e[r][1])/(e[i][1]-e[r][1])+e[r][0]&&(a=!a);return a}function v(e){b("plothover",e)}function y(e){b("plotclick",e)}function b(e,t){var a=n.offset(),i=function(e,t){for(var a,r,i=n.getData(),s=n.getOptions(),c=s.series.pie.radius>1?s.series.pie.radius:o*s.series.pie.radius,p=0;p<i.length;++p){var h=i[p];if(h.pie.show){if(d.save(),d.beginPath(),d.moveTo(0,0),d.arc(0,0,c,h.startAngle,h.startAngle+h.angle/2,!1),d.arc(0,0,c,h.startAngle+h.angle/2,h.startAngle+h.angle,!1),d.closePath(),a=e-l,r=t-u,d.isPointInPath){if(d.isPointInPath(e-l,t-u))return d.restore(),{datapoint:[h.percent,h.data],dataIndex:0,series:h,seriesIndex:p}}else if(g([[0,0],[c*Math.cos(h.startAngle),c*Math.sin(h.startAngle)],[c*Math.cos(h.startAngle+h.angle/4),c*Math.sin(h.startAngle+h.angle/4)],[c*Math.cos(h.startAngle+h.angle/2),c*Math.sin(h.startAngle+h.angle/2)],[c*Math.cos(h.startAngle+h.angle/1.5),c*Math.sin(h.startAngle+h.angle/1.5)],[c*Math.cos(h.startAngle+h.angle),c*Math.sin(h.startAngle+h.angle)]],[a,r]))return d.restore(),{datapoint:[h.percent,h.data],dataIndex:0,series:h,seriesIndex:p};d.restore()}}return null}(parseInt(t.pageX-a.left),parseInt(t.pageY-a.top));if(r.grid.autoHighlight)for(var c=0;c<p.length;++c){var h=p[c];h.auto!=e||i&&h.series==i.series||S(h.series)}i&&function(e,t){var a=x(e);-1==a?(p.push({series:e,auto:t}),n.triggerRedrawOverlay()):t||(p[a].auto=!1)}(i.series,e);var m={pageX:t.pageX,pageY:t.pageY};s.trigger(e,[m,i])}function S(e){null==e&&(p=[],n.triggerRedrawOverlay());var t=x(e);-1!=t&&(p.splice(t,1),n.triggerRedrawOverlay())}function x(e){for(var t=0;t<p.length;++t)if(p[t].series==e)return t;return-1}n.hooks.processOptions.push(function(e,t){t.series.pie.show&&(t.grid.show=!1,"auto"==t.series.pie.label.show&&(t.legend.show?t.series.pie.label.show=!1:t.series.pie.label.show=!0),"auto"==t.series.pie.radius&&(t.series.pie.label.show?t.series.pie.radius=.75:t.series.pie.radius=1),t.series.pie.tilt>1?t.series.pie.tilt=1:t.series.pie.tilt<0&&(t.series.pie.tilt=0))}),n.hooks.bindEvents.push(function(e,t){var a=e.getOptions();a.series.pie.show&&(a.grid.hoverable&&t.unbind("mousemove").mousemove(v),a.grid.clickable&&t.unbind("click").click(y))}),n.hooks.processDatapoints.push(function(e,t,a,r){e.getOptions().series.pie.show&&h(e)}),n.hooks.drawOverlay.push(function(e,t){e.getOptions().series.pie.show&&function(e,t){var a=e.getOptions(),r=a.series.pie.radius>1?a.series.pie.radius:o*a.series.pie.radius;t.save(),t.translate(l,u),t.scale(1,a.series.pie.tilt);for(var n=0;n<p.length;++n)i(p[n].series);function i(e){e.angle<=0||isNaN(e.angle)||(t.fillStyle="rgba(255, 255, 255, "+a.series.pie.highlight.opacity+")",t.beginPath(),Math.abs(e.angle-2*Math.PI)>1e-9&&t.moveTo(0,0),t.arc(0,0,r,e.startAngle,e.startAngle+e.angle/2,!1),t.arc(0,0,r,e.startAngle+e.angle/2,e.startAngle+e.angle,!1),t.closePath(),t.fill())}f(t),t.restore()}(e,t)}),n.hooks.draw.push(function(e,t){e.getOptions().series.pie.show&&m(e,t)})},options:r,name:"pie",version:"1.1"})}(jQuery)},1107:function(e,t){ace.define("ace/snippets/prometheus",["require","exports","module"],function(e,t,a){"use strict";t.snippets=[{content:"rate(${1:metric}[${2:range}])",name:"rate()",scope:"prometheus",tabTrigger:"r"}],t.scope="prometheus"})},1108:function(e,t){ace.define("ace/mode/prometheus_highlight_rules",["require","exports","module","ace/lib/oop","ace/mode/text_highlight_rules"],function(e,t,a){"use strict";var r=e("../lib/oop"),n=e("./text_highlight_rules").TextHighlightRules,i=function(){var e=this.createKeywordMapper({"support.function":"abs|absent|ceil|changes|clamp_max|clamp_min|count_scalar|day_of_month|day_of_week|days_in_month|delta|deriv|drop_common_labels|exp|floor|histogram_quantile|holt_winters|hour|idelta|increase|irate|label_replace|ln|log2|log10|minute|month|predict_linear|rate|resets|round|scalar|sort|sort_desc|sqrt|time|vector|year|avg_over_time|min_over_time|max_over_time|sum_over_time|count_over_time|quantile_over_time|stddev_over_time|stdvar_over_time",keyword:"count|count_values|min|max|avg|sum|stddev|stdvar|bottomk|topk|quantile","constant.language":"true|false|null|__name__|job"},"identifier",!0);this.$rules={start:[{token:"string",regex:/"(?:[^"\\]|\\.)*?"/},{token:"string",regex:"'.*?'"},{token:"constant.numeric",regex:"[-]?\\d+(?:(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)?\\b"},{token:"constant.language",regex:"\\d+[smhdwy]"},{token:"keyword.operator.binary",regex:"\\+|\\-|\\*|\\/|%|\\^|==|!=|<=|>=|<|>|and|or|unless"},{token:"keyword.other",regex:"keep_common|offset|bool"},{token:"keyword.control",regex:"by|without|on|ignoring|group_left|group_right",next:"start-label-list-matcher"},{token:"variable",regex:"\\$[A-Za-z0-9_]+"},{token:e,regex:"[a-zA-Z_:][a-zA-Z0-9_:]*"},{token:"paren.lparen",regex:"[[(]"},{token:"paren.lparen.label-matcher",regex:"{",next:"start-label-matcher"},{token:"paren.rparen",regex:"[\\])]"},{token:"paren.rparen.label-matcher",regex:"}"},{token:"text",regex:"\\s+"}],"start-label-matcher":[{token:"entity.name.tag.label-matcher",regex:"[a-zA-Z_][a-zA-Z0-9_]*"},{token:"keyword.operator.label-matcher",regex:"=~|=|!~|!="},{token:"string.quoted.label-matcher",regex:"\"[^\"]*\"|'[^']*'"},{token:"punctuation.operator.label-matcher",regex:","},{token:"paren.rparen.label-matcher",regex:"}",next:"start"}],"start-label-list-matcher":[{token:"paren.lparen.label-list-matcher",regex:"[(]"},{token:"entity.name.tag.label-list-matcher",regex:"[a-zA-Z_][a-zA-Z0-9_]*"},{token:"punctuation.operator.label-list-matcher",regex:","},{token:"paren.rparen.label-list-matcher",regex:"[)]",next:"start"}]},this.normalizeRules()};r.inherits(i,n),t.PrometheusHighlightRules=i}),ace.define("ace/mode/prometheus_completions",["require","exports","module","ace/token_iterator","ace/lib/lang"],function(e,t,a){"use strict";var r=e("../lib/lang"),n=["by","without","keep_common","offset","bool","and","or","unless","ignoring","on","group_left","group_right","count","count_values","min","max","avg","sum","stddev","stdvar","bottomk","topk","quantile"].map(function(e){return{caption:e,value:e,meta:"keyword",score:Number.MAX_VALUE}});var i=[{name:"abs()",value:"abs",def:"abs(v instant-vector)",docText:"Returns the input vector with all sample values converted to their absolute value."},{name:"absent()",value:"absent",def:"absent(v instant-vector)",docText:"Returns an empty vector if the vector passed to it has any elements and a 1-element vector with the value 1 if the vector passed to it has no elements. This is useful for alerting on when no time series exist for a given metric name and label combination."},{name:"ceil()",value:"ceil",def:"ceil(v instant-vector)",docText:"Rounds the sample values of all elements in `v` up to the nearest integer."},{name:"changes()",value:"changes",def:"changes(v range-vector)",docText:"For each input time series, `changes(v range-vector)` returns the number of times its value has changed within the provided time range as an instant vector."},{name:"clamp_max()",value:"clamp_max",def:"clamp_max(v instant-vector, max scalar)",docText:"Clamps the sample values of all elements in `v` to have an upper limit of `max`."},{name:"clamp_min()",value:"clamp_min",def:"clamp_min(v instant-vector, min scalar)",docText:"Clamps the sample values of all elements in `v` to have a lower limit of `min`."},{name:"count_scalar()",value:"count_scalar",def:"count_scalar(v instant-vector)",docText:"Returns the number of elements in a time series vector as a scalar. This is in contrast to the `count()` aggregation operator, which always returns a vector (an empty one if the input vector is empty) and allows grouping by labels via a `by` clause."},{name:"day_of_month()",value:"day_of_month",def:"day_of_month(v=vector(time()) instant-vector)",docText:"Returns the day of the month for each of the given times in UTC. Returned values are from 1 to 31."},{name:"day_of_week()",value:"day_of_week",def:"day_of_week(v=vector(time()) instant-vector)",docText:"Returns the day of the week for each of the given times in UTC. Returned values are from 0 to 6, where 0 means Sunday etc."},{name:"days_in_month()",value:"days_in_month",def:"days_in_month(v=vector(time()) instant-vector)",docText:"Returns number of days in the month for each of the given times in UTC. Returned values are from 28 to 31."},{name:"delta()",value:"delta",def:"delta(v range-vector)",docText:"Calculates the difference between the first and last value of each time series element in a range vector `v`, returning an instant vector with the given deltas and equivalent labels. The delta is extrapolated to cover the full time range as specified in the range vector selector, so that it is possible to get a non-integer result even if the sample values are all integers."},{name:"deriv()",value:"deriv",def:"deriv(v range-vector)",docText:"Calculates the per-second derivative of the time series in a range vector `v`, using simple linear regression."},{name:"drop_common_labels()",value:"drop_common_labels",def:"drop_common_labels(instant-vector)",docText:"Drops all labels that have the same name and value across all series in the input vector."},{name:"exp()",value:"exp",def:"exp(v instant-vector)",docText:"Calculates the exponential function for all elements in `v`.\nSpecial cases are:\n* `Exp(+Inf) = +Inf` \n* `Exp(NaN) = NaN`"},{name:"floor()",value:"floor",def:"floor(v instant-vector)",docText:"Rounds the sample values of all elements in `v` down to the nearest integer."},{name:"histogram_quantile()",value:"histogram_quantile",def:"histogram_quantile(φ float, b instant-vector)",docText:"Calculates the φ-quantile (0 ≤ φ ≤ 1) from the buckets `b` of a histogram. The samples in `b` are the counts of observations in each bucket. Each sample must have a label `le` where the label value denotes the inclusive upper bound of the bucket. (Samples without such a label are silently ignored.) The histogram metric type automatically provides time series with the `_bucket` suffix and the appropriate labels."},{name:"holt_winters()",value:"holt_winters",def:"holt_winters(v range-vector, sf scalar, tf scalar)",docText:"Produces a smoothed value for time series based on the range in `v`. The lower the smoothing factor `sf`, the more importance is given to old data. The higher the trend factor `tf`, the more trends in the data is considered. Both `sf` and `tf` must be between 0 and 1."},{name:"hour()",value:"hour",def:"hour(v=vector(time()) instant-vector)",docText:"Returns the hour of the day for each of the given times in UTC. Returned values are from 0 to 23."},{name:"idelta()",value:"idelta",def:"idelta(v range-vector)",docText:"Calculates the difference between the last two samples in the range vector `v`, returning an instant vector with the given deltas and equivalent labels."},{name:"increase()",value:"increase",def:"increase(v range-vector)",docText:"Calculates the increase in the time series in the range vector. Breaks in monotonicity (such as counter resets due to target restarts) are automatically adjusted for. The increase is extrapolated to cover the full time range as specified in the range vector selector, so that it is possible to get a non-integer result even if a counter increases only by integer increments."},{name:"irate()",value:"irate",def:"irate(v range-vector)",docText:"Calculates the per-second instant rate of increase of the time series in the range vector. This is based on the last two data points. Breaks in monotonicity (such as counter resets due to target restarts) are automatically adjusted for."},{name:"label_replace()",value:"label_replace",def:"label_replace(v instant-vector, dst_label string, replacement string, src_label string, regex string)",docText:"For each timeseries in `v`, `label_replace(v instant-vector, dst_label string, replacement string, src_label string, regex string)`  matches the regular expression `regex` against the label `src_label`.  If it matches, then the timeseries is returned with the label `dst_label` replaced by the expansion of `replacement`. `$1` is replaced with the first matching subgroup, `$2` with the second etc. If the regular expression doesn't match then the timeseries is returned unchanged."},{name:"ln()",value:"ln",def:"ln(v instant-vector)",docText:"calculates the natural logarithm for all elements in `v`.\nSpecial cases are:\n * `ln(+Inf) = +Inf`\n * `ln(0) = -Inf`\n * `ln(x < 0) = NaN`\n * `ln(NaN) = NaN`"},{name:"log2()",value:"log2",def:"log2(v instant-vector)",docText:"Calculates the binary logarithm for all elements in `v`. The special cases are equivalent to those in `ln`."},{name:"log10()",value:"log10",def:"log10(v instant-vector)",docText:"Calculates the decimal logarithm for all elements in `v`. The special cases are equivalent to those in `ln`."},{name:"minute()",value:"minute",def:"minute(v=vector(time()) instant-vector)",docText:"Returns the minute of the hour for each of the given times in UTC. Returned values are from 0 to 59."},{name:"month()",value:"month",def:"month(v=vector(time()) instant-vector)",docText:"Returns the month of the year for each of the given times in UTC. Returned values are from 1 to 12, where 1 means January etc."},{name:"predict_linear()",value:"predict_linear",def:"predict_linear(v range-vector, t scalar)",docText:"Predicts the value of time series `t` seconds from now, based on the range vector `v`, using simple linear regression."},{name:"rate()",value:"rate",def:"rate(v range-vector)",docText:"Calculates the per-second average rate of increase of the time series in the range vector. Breaks in monotonicity (such as counter resets due to target restarts) are automatically adjusted for. Also, the calculation extrapolates to the ends of the time range, allowing for missed scrapes or imperfect alignment of scrape cycles with the range's time period."},{name:"resets()",value:"resets",def:"resets(v range-vector)",docText:"For each input time series, `resets(v range-vector)` returns the number of counter resets within the provided time range as an instant vector. Any decrease in the value between two consecutive samples is interpreted as a counter reset."},{name:"round()",value:"round",def:"round(v instant-vector, to_nearest=1 scalar)",docText:"Rounds the sample values of all elements in `v` to the nearest integer. Ties are resolved by rounding up. The optional `to_nearest` argument allows specifying the nearest multiple to which the sample values should be rounded. This multiple may also be a fraction."},{name:"scalar()",value:"scalar",def:"scalar(v instant-vector)",docText:"Given a single-element input vector, `scalar(v instant-vector)` returns the sample value of that single element as a scalar. If the input vector does not have exactly one element, `scalar` will return `NaN`."},{name:"sort()",value:"sort",def:"sort(v instant-vector)",docText:"Returns vector elements sorted by their sample values, in ascending order."},{name:"sort_desc()",value:"sort_desc",def:"sort_desc(v instant-vector)",docText:"Returns vector elements sorted by their sample values, in descending order."},{name:"sqrt()",value:"sqrt",def:"sqrt(v instant-vector)",docText:"Calculates the square root of all elements in `v`."},{name:"time()",value:"time",def:"time()",docText:"Returns the number of seconds since January 1, 1970 UTC. Note that this does not actually return the current time, but the time at which the expression is to be evaluated."},{name:"vector()",value:"vector",def:"vector(s scalar)",docText:"Returns the scalar `s` as a vector with no labels."},{name:"year()",value:"year",def:"year(v=vector(time()) instant-vector)",docText:"Returns the year for each of the given times in UTC."},{name:"avg_over_time()",value:"avg_over_time",def:"avg_over_time(range-vector)",docText:"The average value of all points in the specified interval."},{name:"min_over_time()",value:"min_over_time",def:"min_over_time(range-vector)",docText:"The minimum value of all points in the specified interval."},{name:"max_over_time()",value:"max_over_time",def:"max_over_time(range-vector)",docText:"The maximum value of all points in the specified interval."},{name:"sum_over_time()",value:"sum_over_time",def:"sum_over_time(range-vector)",docText:"The sum of all values in the specified interval."},{name:"count_over_time()",value:"count_over_time",def:"count_over_time(range-vector)",docText:"The count of all values in the specified interval."},{name:"quantile_over_time()",value:"quantile_over_time",def:"quantile_over_time(scalar, range-vector)",docText:"The φ-quantile (0 ≤ φ ≤ 1) of the values in the specified interval."},{name:"stddev_over_time()",value:"stddev_over_time",def:"stddev_over_time(range-vector)",docText:"The population standard deviation of the values in the specified interval."},{name:"stdvar_over_time()",value:"stdvar_over_time",def:"stdvar_over_time(range-vector)",docText:"The population standard variance of the values in the specified interval."}].map(function(e){return{caption:e.name,value:e.value,docHTML:function(e){var t=r.escapeHTML(e.docText);return t=function(e){return e=(e=e.replace(/```(.+)```/,"<pre>$1</pre>")).replace(/`([^`]+)`/,"<code>$1</code>")}(function(e,t){for(var a=[],r=0,n=0,i=t=t||60,s="",o=0;o<e.length;o++)" "===e[o]?r=o:o>=i&&0!=r&&(s=e.slice(n,r),a.push(s),n=r+1,i=o+t,r=0);return s=e.slice(n),a.push(s),a.join("&nbsp<br>")}(t,40)),["<b>",r.escapeHTML(e.def),"</b>","<hr></hr>",t,"<br>&nbsp"].join("")}(e),meta:"function",score:Number.MAX_VALUE}}),s=function(){};(function(){this.getCompletions=function(e,t,a,r,s){var o=t.getTokenAt(a.row,a.column);if("entity.name.tag.label-matcher"===o.type||"string.quoted.label-matcher"===o.type||"entity.name.tag.label-list-matcher"===o.type)return s(null,[]);s(null,n.concat(i))}}).call(s.prototype),t.PrometheusCompletions=s}),ace.define("ace/mode/behaviour/prometheus",["require","exports","module","ace/lib/oop","ace/mode/behaviour","ace/mode/behaviour/cstyle","ace/token_iterator"],function(e,t,a){"use strict";var r=e("../../lib/oop"),n=(e("../behaviour").Behaviour,e("./cstyle").CstyleBehaviour);e("../../token_iterator").TokenIterator;var i=function(){this.inherit(n),this.add("braces","insertion",function(e,t,a,r,i){if("{"==i){var s=a.getSelectionRange(),o=r.doc.getTextRange(s);if(""!==o&&a.getWrapBehavioursEnabled())return function(e,t,a,r){var n=e.end.row-e.start.row;return{text:a+t+r,selection:[0,e.start.column+1,n,e.end.column+(n?0:1)]}}(s,o,"{","}");if(n.isSaneInsertion(a,r))return{text:"{}",selection:[1,1]}}else if("}"==i){var l=a.getCursorPosition(),u=r.doc.getLine(l.row);if("}"==u.substring(l.column,l.column+1))if(null!==r.$findOpeningBracket("}",{column:l.column+1,row:l.row})&&n.isAutoInsertedClosing(l,u,i))return{text:"",selection:[1,1]}}}),this.add("braces","deletion",function(e,t,a,r,n){var i=r.doc.getTextRange(n);if(!n.isMultiLine()&&"{"==i&&"}"==r.doc.getLine(n.start.row).substring(n.start.column+1,n.start.column+2))return n.end.column++,n})};r.inherits(i,n),t.PrometheusBehaviour=i}),ace.define("ace/mode/prometheus",["require","exports","module","ace/lib/oop","ace/mode/text","ace/mode/prometheus_highlight_rules"],function(e,t,a){"use strict";var r=e("../lib/oop"),n=e("./text").Mode,i=e("./prometheus_highlight_rules").PrometheusHighlightRules,s=e("./prometheus_completions").PrometheusCompletions,o=e("./behaviour/prometheus").PrometheusBehaviour,l=function(){this.HighlightRules=i,this.$behaviour=new o,this.$completer=new s,this.completer=this.$completer};r.inherits(l,n),function(){this.$id="ace/mode/prometheus"}.call(l.prototype),t.Mode=l})},1115:function(e,t,a){"use strict";R.$inject=["$compile","$sanitize","linkSrv"],re.$inject=["$sanitize","dashboardSrv","contextSrv","$compile"],Bt.$inject=["instanceSettings","$q","backendSrv","templateSrv"],Wt.$inject=["$compile"],Gt.$inject=["$compile","templateSrv","popoverSrv"],sn.$inject=["element","event","plot"],ln.$inject=["element","event","plot"],pn.$inject=["plot"],Sn.$inject=["timeSrv","popoverSrv","contextSrv"],kn.$inject=["$scope","$element","popoverSrv"],Ci.$inject=["$q","uiSegmentSrv"],_i.$inject=["$q","uiSegmentSrv"],Bi.$inject=["$compile","datasourceSrv","$rootScope","$q","$http","$templateCache"],ls.$inject=["$location","$timeout","$rootScope"],ms.$inject=["$rootScope","$q","$location","$timeout","contextSrv","dashboardSrv","$window"],bs.$inject=["timer","alertSrv","$location"],_s.$inject=["variableSrv"],ro.$inject=["$routeProvider"],oo.$inject=["$compile"],co.$inject=["dynamicDirectiveSrv"],a.r(t);var r={};a.r(r),a.d(r,"PanelCtrl",function(){return Ne}),a.d(r,"MetricsPanelCtrl",function(){return He}),a.d(r,"QueryCtrl",function(){return Ye}),a.d(r,"alertTab",function(){return Je}),a.d(r,"loadPluginCss",function(){return ji});var n={};a.r(n),a.d(n,"convertSeriesListToCsv",function(){return kt}),a.d(n,"exportSeriesListToCsv",function(){return Ct}),a.d(n,"convertSeriesListToCsvColumns",function(){return Tt}),a.d(n,"exportSeriesListToCsvColumns",function(){return _t}),a.d(n,"convertTableDataToCsv",function(){return Mt}),a.d(n,"exportTableDataToCsv",function(){return $t}),a.d(n,"saveSaveBlob",function(){return Pt});var i={};a.r(i),a.d(i,"default",function(){return Et});var s={};a.r(s),a.d(s,"Datasource",function(){return Bt}),a.d(s,"QueryCtrl",function(){return oa}),a.d(s,"ConfigCtrl",function(){return ua}),a.d(s,"AnnotationsQueryCtrl",function(){return ca});var o={};a.r(o),a.d(o,"Datasource",function(){return ha}),a.d(o,"QueryCtrl",function(){return ma}),a.d(o,"ConfigCtrl",function(){return fa}),a.d(o,"AnnotationsQueryCtrl",function(){return ga});var l={};a.r(l),a.d(l,"Datasource",function(){return Oa}),a.d(l,"QueryCtrl",function(){return ja}),a.d(l,"ConfigCtrl",function(){return Ua}),a.d(l,"AnnotationsQueryCtrl",function(){return La});var u={};a.r(u),a.d(u,"Datasource",function(){return Ba}),a.d(u,"QueryCtrl",function(){return Qa}),a.d(u,"ConfigCtrl",function(){return za}),a.d(u,"AnnotationsQueryCtrl",function(){return Ha});var c={};a.r(c),a.d(c,"GrafanaDatasource",function(){return Ya}),a.d(c,"Datasource",function(){return Ya}),a.d(c,"QueryCtrl",function(){return Wa}),a.d(c,"AnnotationsQueryCtrl",function(){return Ga});var d={};a.r(d),a.d(d,"Datasource",function(){return dr}),a.d(d,"QueryCtrl",function(){return pr}),a.d(d,"ConfigCtrl",function(){return hr}),a.d(d,"AnnotationsQueryCtrl",function(){return mr});var p={};a.r(p),a.d(p,"LoggingConfigCtrl",function(){return br}),a.d(p,"Datasource",function(){return yr}),a.d(p,"ConfigCtrl",function(){return br});var h={};a.r(h),a.d(h,"MixedDatasource",function(){return Sr}),a.d(h,"Datasource",function(){return Sr});var m={};a.r(m),a.d(m,"MysqlDatasource",function(){return wr}),a.d(m,"Datasource",function(){return wr}),a.d(m,"QueryCtrl",function(){return Cr}),a.d(m,"ConfigCtrl",function(){return Tr}),a.d(m,"AnnotationsQueryCtrl",function(){return Mr});var f={};a.r(f),a.d(f,"PostgresDatasource",function(){return Pr}),a.d(f,"Datasource",function(){return Pr}),a.d(f,"QueryCtrl",function(){return Dr}),a.d(f,"ConfigCtrl",function(){return Ar}),a.d(f,"AnnotationsQueryCtrl",function(){return Ir});var g={};a.r(g),a.d(g,"Datasource",function(){return Br}),a.d(g,"QueryCtrl",function(){return zr}),a.d(g,"ConfigCtrl",function(){return Hr}),a.d(g,"AnnotationsQueryCtrl",function(){return Yr});var v={};a.r(v),a.d(v,"MssqlDatasource",function(){return Gr}),a.d(v,"Datasource",function(){return Gr}),a.d(v,"QueryCtrl",function(){return Jr}),a.d(v,"ConfigCtrl",function(){return Xr}),a.d(v,"AnnotationsQueryCtrl",function(){return en});var y={};a.r(y),a.d(y,"TestDataDatasource",function(){return tn}),a.d(y,"Datasource",function(){return tn}),a.d(y,"QueryCtrl",function(){return an}),a.d(y,"AnnotationsQueryCtrl",function(){return rn});var b={};a.r(b),a.d(b,"TextPanelCtrl",function(){return nn}),a.d(b,"PanelCtrl",function(){return nn});var S={};a.r(S),a.d(S,"GraphCtrl",function(){return $n}),a.d(S,"PanelCtrl",function(){return $n});var x={};a.r(x),a.d(x,"DashListCtrl",function(){return Pn}),a.d(x,"PanelCtrl",function(){return Pn});var w={};a.r(w),a.d(w,"PluginListCtrl",function(){return En}),a.d(w,"PanelCtrl",function(){return En});var k={};a.r(k),a.d(k,"AlertListPanel",function(){return Dn}),a.d(k,"PanelCtrl",function(){return Dn});var C={};a.r(C),a.d(C,"PanelCtrl",function(){return xi});var T={};a.r(T),a.d(T,"TablePanelCtrl",function(){return $i}),a.d(T,"PanelCtrl",function(){return $i});var _={};a.r(_),a.d(_,"SingleStatCtrl",function(){return Pi}),a.d(_,"PanelCtrl",function(){return Pi}),a.d(_,"getColorForValue",function(){return Ei});var M={};a.r(M),a.d(M,"GettingStartedPanelCtrl",function(){return Di}),a.d(M,"PanelCtrl",function(){return Di});var $=a(13),P=a.n($),E=a(1),D=a.n(E),A=a(96),F=function(){function e(e,t){this.templateSrv=e,this.timeSrv=t}return e.$inject=["templateSrv","timeSrv"],e.prototype.getLinkUrl=function(e){var t=this.templateSrv.replace(e.url||""),a={};if(e.keepTime){var r=this.timeSrv.timeRangeForUrl();a.from=r.from,a.to=r.to}return e.includeVars&&this.templateSrv.fillVariableValuesForUrl(a),this.addParamsToUrl(t,a)},e.prototype.addParamsToUrl=function(e,t){var a=[];return D.a.each(t,function(e,t){null!==e&&(!0===e?a.push(t):D.a.isArray(e)?D.a.each(e,function(e){a.push(t+"="+encodeURIComponent(e))}):a.push(t+"="+encodeURIComponent(e)))}),0===a.length?e:this.appendToQueryString(e,a.join("&"))},e.prototype.appendToQueryString=function(e,t){if(!D.a.isUndefined(t)&&null!==t&&""!==t){var a=e.indexOf("?");-1!==a?e.length-a>1&&(e+="&"):e+="?",e+=t}return e},e.prototype.getAnchorInfo=function(e){var t={};return t.href=this.getLinkUrl(e),t.title=this.templateSrv.replace(e.title||""),t},e.prototype.getPanelLinkAnchorInfo=function(e,t){var a={};if("absolute"===e.type)a.target=e.targetBlank?"_blank":"_self",a.href=this.templateSrv.replace(e.url||"",t),a.title=this.templateSrv.replace(e.title||"",t);else if(e.dashUri)a.href="dashboard/"+e.dashUri+"?",a.title=this.templateSrv.replace(e.title||"",t),a.target=e.targetBlank?"_blank":"";else{a.title=this.templateSrv.replace(e.title||"",t);var r=A.a.slugifyForUrl(e.dashboard||"");a.href="dashboard/db/"+r+"?"}var n={};if(e.keepTime){var i=this.timeSrv.timeRangeForUrl();n.from=i.from,n.to=i.to}return e.includeVars&&this.templateSrv.fillVariableValuesForUrl(n,t),a.href=this.addParamsToUrl(a.href,n),e.params&&(a.href=this.appendToQueryString(a.href,this.templateSrv.replace(e.params,t))),a},e}();P.a.module("grafana.services").service("linkSrv",F);var I=function(){function e(e,t){e.panel.links=e.panel.links||[],e.addLink=function(){e.panel.links.push({type:"dashboard"})},e.searchDashboards=function(e,a){t.search({query:e}).then(function(e){var t=D.a.map(e,function(e){return e.title});a(t)})},e.dashboardChanged=function(e){t.search({query:e.dashboard}).then(function(t){var a=D.a.find(t,{title:e.dashboard});a&&(e.dashUri=a.uri,e.title=a.title)})},e.deleteLink=function(t){e.panel.links=D.a.without(e.panel.links,t)}}return e.$inject=["$scope","backendSrv"],e}();P.a.module("grafana.directives").directive("panelLinksEditor",function(){return{scope:{panel:"="},restrict:"E",controller:"PanelLinksEditorCtrl",templateUrl:"public/app/features/panellinks/module.html",link:function(){}}}).controller("PanelLinksEditorCtrl",I);var O={"external link":"fa-external-link",dashboard:"fa-th-large",question:"fa-question",info:"fa-info",bolt:"fa-bolt",doc:"fa-file-text-o",cloud:"fa-cloud"},q=function(){function e(e,t){this.iconMap=O,this.dashboard.links=this.dashboard.links||[],this.mode="list",e.$on("$destroy",function(){t.appEvent("dash-links-updated")})}return e.$inject=["$scope","$rootScope"],e.prototype.backToList=function(){this.mode="list"},e.prototype.setupNew=function(){this.mode="new",this.link={type:"dashboards",icon:"external link"}},e.prototype.addLink=function(){this.dashboard.links.push(this.link),this.mode="list"},e.prototype.editLink=function(e){this.link=e,this.mode="edit",console.log(this.link)},e.prototype.saveLink=function(){this.backToList()},e.prototype.moveLink=function(e,t){D.a.move(this.dashboard.links,e,e+t)},e.prototype.deleteLink=function(e){this.dashboard.links.splice(e,1),this.dashboard.updateSubmenuVisibility()},e}();function R(e,t,a){return{restrict:"E",link:function(r,n){var i=r.link,s='<div class="gf-form"><a class="pointer gf-form-label" data-placement="bottom"'+(i.asDropdown?' ng-click="fillDropdown(link)" data-toggle="dropdown"':"")+"><i></i> <span></span></a>";function o(){var e=a.getAnchorInfo(i),s=n.find("a");n.find("span").text(e.title),i.asDropdown||(s.attr("href",e.href),function(){var e=n.find("a"),a=t(e.parent().html());e.parent().html(a)}()),s.attr("data-placement","bottom"),s.tooltip({title:t(r.link.tooltip),html:!0,container:"body"})}i.asDropdown&&(s+='<ul class="dropdown-menu" role="menu"><li ng-repeat="dash in link.searchHits"><a href="{{dash.url}}" target="{{dash.target}}">{{dash.title}}</a></li></ul>'),s+="</div>",n.html(s),e(n.contents())(r),n.find("i").attr("class","fa fa-fw "+r.link.icon),n.find("a").attr("target",r.link.target),i.asDropdown&&r.$last&&n.find(".dropdown-menu").addClass("pull-right"),o(),r.$on("refresh",o)}}}P.a.module("grafana.directives").directive("dashLinksEditor",function(){return{restrict:"E",controller:q,templateUrl:"public/app/features/dashlinks/editor.html",bindToController:!0,controllerAs:"ctrl",scope:{dashboard:"="}}});var V=function(){function e(e,t,a,r,n,i){var s=n.getCurrent().id;function o(t){return"dashboards"===t.type?t.tags?t.asDropdown?a.when([{title:t.title,tags:t.tags,keepTime:t.keepTime,includeVars:t.includeVars,target:t.targetBlank?"_blank":"_self",icon:"fa fa-bars",asDropdown:!0}]):e.searchDashboards(t,7):(console.log("Dashboard link missing tag"),a.when([])):"link"===t.type?a.when([{url:t.url,title:t.title,icon:O[t.icon],tooltip:t.tooltip,target:t.targetBlank?"_blank":"_self",keepTime:t.keepTime,includeVars:t.includeVars}]):a.when([])}function l(){var t=D.a.map(e.links,o);a.all(t).then(function(t){e.generatedLinks=D.a.flatten(t)})}e.searchDashboards=function(e,t){return r.search({tag:e.tags,limit:t}).then(function(t){return D.a.reduce(t,function(t,a){return a.id!==s&&t.push({title:a.title,url:"dashboard/"+a.uri,target:e.target,icon:"fa fa-th-large",keepTime:e.keepTime,includeVars:e.includeVars}),t},[])})},e.fillDropdown=function(t){e.searchDashboards(t,100).then(function(e){D.a.each(e,function(e){e.url=i.getLinkUrl(e)}),t.searchHits=e})},l(),t.onAppEvent("dash-links-updated",l,e)}return e.$inject=["$scope","$rootScope","$q","backendSrv","dashboardSrv","linkSrv"],e}();P.a.module("grafana.directives").directive("dashLinksContainer",function(){return{scope:{links:"="},restrict:"E",controller:"DashLinksContainerCtrl",template:'<dash-link ng-repeat="link in generatedLinks" link="link"></dash-link>',link:function(){}}}),P.a.module("grafana.directives").directive("dashLink",R),P.a.module("grafana.directives").controller("DashLinksContainerCtrl",V);var N=a(12),j=a.n(N),U=a(6),L=function(){function e(e,t){this.datasourceSrv=t,this.annotationDefaults={name:"",datasource:null,iconColor:"rgba(255, 96, 96, 1)",enable:!0,showIn:0,hide:!1},this.showOptions=[{text:"所有面板",value:0},{text:"指定面板",value:1}],e.ctrl=this,this.mode="list",this.datasources=t.getAnnotationSources(),this.annotations=e.dashboard.annotations.list,this.reset(),this.onColorChange=this.onColorChange.bind(this)}return e.$inject=["$scope","datasourceSrv"],e.prototype.datasourceChanged=function(){var e=this;return this.datasourceSrv.get(this.currentAnnotation.datasource).then(function(t){e.currentDatasource=t})},e.prototype.edit=function(e){this.currentAnnotation=e,this.currentAnnotation.showIn=this.currentAnnotation.showIn||0,this.currentIsNew=!1,this.datasourceChanged(),this.mode="edit",j()(".tooltip.in").remove()},e.prototype.reset=function(){this.currentAnnotation=P.a.copy(this.annotationDefaults),this.currentAnnotation.datasource=this.datasources[0].name,this.currentIsNew=!0,this.datasourceChanged()},e.prototype.update=function(){this.reset(),this.mode="list"},e.prototype.setupNew=function(){this.mode="new",this.reset()},e.prototype.backToList=function(){this.mode="list"},e.prototype.move=function(e,t){D.a.move(this.annotations,e,e+t)},e.prototype.add=function(){this.annotations.push(this.currentAnnotation),this.reset(),this.mode="list"},e.prototype.removeAnnotation=function(e){var t=D.a.indexOf(this.annotations,e);this.annotations.splice(t,1)},e.prototype.onColorChange=function(e){this.currentAnnotation.iconColor=e},e}();function B(e,t){var a=D.a.partition(e,"regionId"),r=a[0],n=a[1],i=function(e,t){var a=D.a.filter(e,function(e){return e.regionId}),r=D.a.groupBy(a,"regionId");return r=D.a.compact(D.a.map(r,function(e){var a=D.a.head(e);return e&&e.length>1?(a.timeEnd=e[1].time,a.isRegion=!0,a):e&&e.length?(a.time&&a.timeEnd||(function(e){return e.id&&e.id===e.regionId}(a)?a.timeEnd=t.to.valueOf()-1:(a.timeEnd=a.time,a.time=t.from.valueOf()+1),a.isRegion=!0),a):void 0}))}(r,t.range);return e=D.a.concat(i,n)}function Q(e){return"panel-alert"===e.eventType}U.a.controller("AnnotationsEditorCtrl",L);var z=function(){function e(e,t,a,r,n){this.$rootScope=e,this.$q=t,this.datasourceSrv=a,this.backendSrv=r,this.timeSrv=n,e.onAppEvent("refresh",this.clearCache.bind(this),e),e.onAppEvent("dashboard-initialized",this.clearCache.bind(this),e)}return e.$inject=["$rootScope","$q","datasourceSrv","backendSrv","timeSrv"],e.prototype.clearCache=function(){this.globalAnnotationsPromise=null,this.alertStatesPromise=null},e.prototype.getAnnotations=function(e){var t=this;return this.$q.all([this.getGlobalAnnotations(e),this.getAlertStates(e)]).then(function(t){var a=D.a.flattenDeep(t[0]);return{annotations:a=B(a=function(e){var t=[],a=D.a.partition(e,"id"),r=D.a.groupBy(a[0],"id");return t=D.a.map(r,function(e){return e.length>1&&!D.a.every(e,Q)?D.a.find(e,function(e){return"panel-alert"!==e.eventType}):D.a.head(e)}),t=D.a.concat(t,a[1])}(a=D.a.filter(a,function(t){return!t.panelId||"dashboard"!==t.source.type||t.panelId===e.panel.id})),e),alertState:D.a.find(t[1],{panelId:e.panel.id})}}).catch(function(e){return!e.message&&e.data&&e.data.message&&(e.message=e.data.message),console.log("AnnotationSrv.query error",e),t.$rootScope.appEvent("alert-error",["注释查询失败",e.message||e]),[]})},e.prototype.getAlertStates=function(e){return e.dashboard.id?e.panel&&!e.panel.alert?this.$q.when([]):"now"!==e.range.raw.to?this.$q.when([]):this.alertStatesPromise?this.alertStatesPromise:(this.alertStatesPromise=this.backendSrv.get("/api/alerts/states-for-dashboard",{dashboardId:e.dashboard.id}),this.alertStatesPromise):this.$q.when([])},e.prototype.getGlobalAnnotations=function(e){var t=this,a=e.dashboard;if(this.globalAnnotationsPromise)return this.globalAnnotationsPromise;for(var r=this.timeSrv.timeRange(),n=[],i=function(e){return e.enable?e.snapshotData?{value:s.translateQueryResult(e,e.snapshotData)}:void n.push(s.datasourceSrv.get(e.datasource).then(function(t){return t.annotationQuery({range:r,rangeRaw:r.raw,annotation:e,dashboard:a})}).then(function(r){return a.snapshot&&(e.snapshotData=P.a.copy(r)),t.translateQueryResult(e,r)})):"continue"},s=this,o=0,l=a.annotations.list;o<l.length;o++){var u=i(l[o]);if("object"==typeof u)return u.value}return this.globalAnnotationsPromise=this.$q.all(n),this.globalAnnotationsPromise},e.prototype.saveAnnotationEvent=function(e){return this.globalAnnotationsPromise=null,this.backendSrv.post("/api/annotations",e)},e.prototype.updateAnnotationEvent=function(e){return this.globalAnnotationsPromise=null,this.backendSrv.put("/api/annotations/"+e.id,e)},e.prototype.deleteAnnotationEvent=function(e){this.globalAnnotationsPromise=null;var t="/api/annotations/"+e.id;return e.isRegion&&(t="/api/annotations/region/"+e.regionId),this.backendSrv.delete(t)},e.prototype.translateQueryResult=function(e,t){e.snapshotData&&delete(e=P.a.copy(e)).snapshotData;for(var a=0,r=t;a<r.length;a++){r[a].source=e}return t},e}();U.a.service("annotationsSrv",z);var H=a(4),Y=a.n(H),W=a(114),G=function(){function e(e){this.annotationsSrv=e,this.event.panelId=this.panelCtrl.panel.id,this.event.dashboardId=this.panelCtrl.dashboard.id,this.event.time=K(this.event.time),this.event.isRegion&&(this.event.timeEnd=K(this.event.timeEnd)),this.timeFormated=this.panelCtrl.dashboard.formatDate(this.event.time)}return e.$inject=["annotationsSrv"],e.prototype.save=function(){var e=this;if(this.form.$valid){var t=D.a.cloneDeep(this.event);t.time=t.time.valueOf(),t.timeEnd=0,t.isRegion&&(t.timeEnd=this.event.timeEnd.valueOf(),t.timeEnd<t.time)?console.log("invalid time"):t.id?this.annotationsSrv.updateAnnotationEvent(t).then(function(){e.panelCtrl.refresh(),e.close()}).catch(function(){e.panelCtrl.refresh(),e.close()}):this.annotationsSrv.saveAnnotationEvent(t).then(function(){e.panelCtrl.refresh(),e.close()}).catch(function(){e.panelCtrl.refresh(),e.close()})}},e.prototype.delete=function(){var e=this;return this.annotationsSrv.deleteAnnotationEvent(this.event).then(function(){e.panelCtrl.refresh(),e.close()}).catch(function(){e.panelCtrl.refresh(),e.close()})},e}();function K(e){if(e&&D.a.isNumber(e)){var t=Number(e);return Y()(t)}return e}W.d.directive("eventEditor",function(){return{restrict:"E",controller:G,bindToController:!0,controllerAs:"ctrl",templateUrl:"public/app/features/annotations/partials/event_editor.html",scope:{panelCtrl:"=",event:"=",close:"&"}}});var J=a(107),X=a.n(J),Z=function(){return function(){}}(),ee=a(72),te=function(){function e(e){this.panelCtrl=e}return e.prototype.editorClosed=function(){this.event=null,this.editorOpen=!1,this.panelCtrl.render()},e.prototype.editorOpened=function(){this.editorOpen=!0},e.prototype.updateTime=function(e){this.event||(this.event=new Z,this.event.dashboardId=this.panelCtrl.dashboard.id,this.event.panelId=this.panelCtrl.panel.id),this.event.time=Y()(e.from),this.event.isRegion=!1,e.to&&(this.event.timeEnd=Y()(e.to),this.event.isRegion=!0),this.panelCtrl.render()},e.prototype.editEvent=function(e,t){this.event=e,this.panelCtrl.render()},e.prototype.addFlotEvents=function(e,t){if(this.event||0!==e.length){var a={$__alerting:{color:ee.a,position:"BOTTOM",markerSize:5},$__ok:{color:ee.d,position:"BOTTOM",markerSize:5},$__no_data:{color:ee.c,position:"BOTTOM",markerSize:5},$__editing:{color:ee.b,position:"BOTTOM",markerSize:5}};if(this.event)e=this.event.isRegion?[{isRegion:!0,min:this.event.time.valueOf(),timeEnd:this.event.timeEnd.valueOf(),text:this.event.text,eventType:"$__editing",editModel:this.event}]:[{min:this.event.time.valueOf(),text:this.event.text,editModel:this.event,eventType:"$__editing"}];else for(var r=0;r<e.length;r++){var n=e[r];n.min=n.time,n.max=n.time,n.eventType=n.source.name,n.newState?n.eventType="$__"+n.newState:a[n.source.name]||(a[n.source.name]={color:n.source.iconColor,position:"BOTTOM",markerSize:5})}!function(e,t){var a,r=t.grid.markings,n=ee.b;D.a.each(e,function(e){a=function(e,t){var a=X()(e);return a.isValid()?(a.setAlpha(t),a.toRgbString()):e}(a=e.source&&e.source.iconColor||n,ee.e),r.push({xaxis:{from:e.min,to:e.timeEnd},color:a})})}(function(e){return D.a.filter(e,"isRegion")}(e),t);t.grid.eventSectionHeight=7,t.xaxis.eventSectionHeight=20,t.events={levels:D.a.keys(a).length+1,data:e,types:a,manager:this}}},e}();var ae=a(223);function re(e,t,a,r){function n(t){try{return e(t)}catch(e){return console.log("Could not sanitize annotation string, html escaping instead"),D.a.escape(t)}}return{restrict:"E",scope:{event:"=",onEdit:"&"},link:function(e,a){var i=e.event,s=i.title,o=i.text,l=t.getCurrent(),u='<div class="graph-annotation">',c="";if(i.alertId){var d=ae.a.getStateDisplayModel(i.newState);c=d.stateClass,s='<i class="icon-gf '+d.iconClass+'"></i> '+d.text,o=ae.a.getAlertAnnotationInfo(i),i.text&&(o=o+"<br />"+i.text)}else s&&(o=s+"<br />"+(D.a.isString(o)?o:""),s="");var p='<div class="graph-annotation__header">';i.login&&(p+='<div class="graph-annotation__user" bs-tooltip="\'由'+i.login+'创建\'"><img src="'+i.avatarUrl+'" /></div>'),p+='\n          <span class="graph-annotation__title '+c+'">'+n(s)+'</span>\n          <span class="graph-annotation__time">'+l.formatDate(i.min)+"</span>\n      ",i.id&&l.meta.canEdit&&(p+='\n          <span class="pointer graph-annotation__edit-icon" ng-click="onEdit()">\n            <i class="fa fa-pencil-square"></i>\n          </span>\n        '),u+=p+="</div>",u+='<div class="graph-annotation__body">',o&&(u+="<div>"+n(o.replace(/\n/g,"<br>"))+"</div>");var h=i.tags;h&&h.length&&(e.tags=h,u+='<span class="label label-tag small" ng-repeat="tag in tags" tag-color-from-name="tag">{{tag}}</span><br/>'),u+="</div>",u+="</div>",j()(u).appendTo(a),r(a.contents())(e)}}}U.a.directive("annotationTooltip",re);var ne=a(222),ie={};function se(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var a=e[e.length-1],r=e[0]||"",n=1;n<e.length-1;n++)r+=" "+e[n]||"";return a=A.a.regexEscape(a),null!==new RegExp("\\$("+a+")(?:\\W|$)|\\[\\[("+a+")\\]\\]","g").exec(r)}var oe=a(9),le=function(){function e(e,t,a,r){e.variableTypes=ie,e.ctrl={},e.namePattern=/^(?!__).*$/,e._=D.a,e.optionsLimit=20,e.refreshOptions=[{value:0,text:"从不"},{value:1,text:"仪表板加载时"},{value:2,text:"时间区间改变时"}],e.sortOptions=[{value:0,text:"关闭"},{value:1,text:"按字母顺序排列(升序)"},{value:2,text:"按字母顺序排列(降序)"},{value:3,text:"按数值排列(升序)"},{value:4,text:"按数值排列(降序)"},{value:5,text:"按字母顺序排列(不区分大小写, 升序)"},{value:6,text:"按字母顺序排列(不区分大小写, 降序)"}],e.hideOptions=[{value:0,text:""},{value:1,text:"标签"},{value:2,text:"变量"}],e.init=function(){e.mode="list",e.variables=a.variables,e.reset(),e.$watch("mode",function(t){"new"===t&&e.reset()})},e.setMode=function(t){e.mode=t},e.add=function(){e.isValid()&&(a.addVariable(e.current),e.update())},e.isValid=function(){if(!e.ctrl.form.$valid)return!1;if(!e.current.name.match(/^\w+$/))return oe.a.emit("alert-warning",["Validation","变量名中只允许使用单词和数字字符"]),!1;var t=D.a.find(e.variables,{name:e.current.name});return t&&t!==e.current?(oe.a.emit("alert-warning",["Validation","已存在同名的变量"]),!1):"query"!==e.current.type||!e.current.query.match(new RegExp("\\$"+e.current.name+"(/| |$)"))||(oe.a.emit("alert-warning",["Validation","查询不能包含对自身的引用。 变量: $"+e.current.name]),!1)},e.validate=function(){e.infoText="","adhoc"===e.current.type&&null!==e.current.datasource&&(e.infoText="Adhoc过滤器会自动应用于所有以此数据源为目标的查询",t.get(e.current.datasource).then(function(t){t.getTagKeys||(e.infoText="此数据源尚不支持adhoc过滤器。")}))},e.runQuery=function(){return e.optionsLimit=20,a.updateOptions(e.current).catch(function(e){e.data&&e.data.message&&(e.message=e.data.message),oe.a.emit("alert-error",["Templating","无法初始化模板变量: "+e.message])})},e.edit=function(t){e.current=t,e.currentIsNew=!1,e.mode="edit",e.validate()},e.duplicate=function(t){var r=D.a.cloneDeep(t.getSaveModel());e.current=a.createVariableFromModel(r),e.current.name="copy_of_"+t.name,a.addVariable(e.current)},e.update=function(){e.isValid()&&e.runQuery().then(function(){e.reset(),e.mode="list",r.updateTemplateData()})},e.reset=function(){e.currentIsNew=!0,e.current=a.createVariableFromModel({type:"query"}),e.datasources=D.a.filter(t.getMetricSources(),function(e){return!e.meta.mixed&&null!==e.value}),e.datasourceTypes=D()(e.datasources).uniqBy("meta.id").map(function(e){return{text:e.meta.name,value:e.meta.id}}).value()},e.typeChanged=function(){var t=e.current;e.current=a.createVariableFromModel({type:e.current.type}),e.current.name=t.name,e.current.hide=t.hide,e.current.label=t.label;var r=D.a.indexOf(this.variables,t);-1!==r&&(this.variables[r]=e.current),e.validate()},e.removeVariable=function(e){a.removeVariable(e)},e.showMoreOptions=function(){e.optionsLimit+=20}}return e.$inject=["$scope","datasourceSrv","variableSrv","templateSrv"],e}();function ue(e){return e.replace(/([\!\*\+\-\=<>\s\&\|\(\)\[\]\{\}\^\~\?\:\\/"])/g,"\\$1")}U.a.controller("VariableEditorCtrl",le);var ce=new(function(){function e(){this.regex=/\$(\w+)|\[\[([\s\S]+?)(?::(\w+))?\]\]|\${(\w+)(?::(\w+))?}/g,this.index={},this.grafanaVariables={},this.builtIns={},this.builtIns.__interval={text:"1s",value:"1s"},this.builtIns.__interval_ms={text:"100",value:"100"}}return e.prototype.init=function(e){this.variables=e,this.updateTemplateData()},e.prototype.updateTemplateData=function(){this.index={};for(var e=0;e<this.variables.length;e++){var t=this.variables[e];t.current&&(t.current.isNone||t.current.value)&&(this.index[t.name]=t)}},e.prototype.variableInitialized=function(e){this.index[e.name]=e},e.prototype.getAdhocFilters=function(e){for(var t=[],a=0;a<this.variables.length;a++){var r=this.variables[a];"adhoc"===r.type&&(r.datasource===e&&(t=t.concat(r.filters)),0===r.datasource.indexOf("$")&&this.replace(r.datasource)===e&&(t=t.concat(r.filters)))}return t},e.prototype.luceneFormat=function(e){return"string"==typeof e?ue(e):e instanceof Array&&0===e.length?"__empty__":"("+D.a.map(e,function(e){return'"'+ue(e)+'"'}).join(" OR ")+")"},e.prototype.formatValue=function(e,t,a){if(a=a||{},"function"==typeof t)return t(e,a,this.formatValue);switch(t){case"regex":if("string"==typeof e)return A.a.regexEscape(e);var r=D.a.map(e,A.a.regexEscape);return 1===r.length?r[0]:"("+r.join("|")+")";case"lucene":return this.luceneFormat(e);case"pipe":return"string"==typeof e?e:e.join("|");case"distributed":return"string"==typeof e?e:this.distributeVariable(e,a.name);case"csv":return D.a.isArray(e)?e.join(","):e;default:return D.a.isArray(e)?"{"+e.join(",")+"}":e}},e.prototype.setGrafanaVariable=function(e,t){this.grafanaVariables[e]=t},e.prototype.getVariableName=function(e){this.regex.lastIndex=0;var t=this.regex.exec(e);return t?t[1]||t[2]:null},e.prototype.variableExists=function(e){var t=this.getVariableName(e);return t&&void 0!==this.index[t]},e.prototype.highlightVariablesAsHtml=function(e){var t=this;return e&&D.a.isString(e)?(e=D.a.escape(e),this.regex.lastIndex=0,e.replace(this.regex,function(e,a,r,n,i){return t.index[a||r||i]||t.builtIns[a||r||i]?'<span class="template-variable">'+e+"</span>":e})):e},e.prototype.getAllValue=function(e){if(e.allValue)return e.allValue;for(var t=[],a=1;a<e.options.length;a++)t.push(e.options[a].value);return t},e.prototype.replace=function(e,t,a){var r,n,i,s,o=this;return e?(this.regex.lastIndex=0,e.replace(this.regex,function(e,l,u,c,d,p){return r=o.index[l||u||d],s=c||p||a,t&&(i=t[l||u||d])?o.formatValue(i.value,s,r):r?(n=o.grafanaVariables[r.current.value])?o.formatValue(n,s,r):(i=r.current.value,o.isAllValue(i)&&(i=o.getAllValue(r),r.allValue)?i:o.formatValue(i,s,r)):e})):e},e.prototype.isAllValue=function(e){return"$__all"===e||Array.isArray(e)&&"$__all"===e[0]},e.prototype.replaceWithText=function(e,t){var a,r=this;return e?(this.regex.lastIndex=0,e.replace(this.regex,function(e,n,i,s,o){if(t){var l=t[n||i||o];if(l)return l.text}return(a=r.index[n||i||o])?r.grafanaVariables[a.current.value]||a.current.text:e})):e},e.prototype.fillVariableValuesForUrl=function(e,t){D.a.each(this.variables,function(a){if(t&&void 0!==t[a.name]){if(t[a.name].skipUrlSync)return;e["var-"+a.name]=t[a.name].value}else{if(a.skipUrlSync)return;e["var-"+a.name]=a.getValueForUrl()}})},e.prototype.distributeVariable=function(e,t){return(e=D.a.map(e,function(e,a){return 0!==a?t+"="+e:e})).join(",")},e}()),de=function(){function e(e,t,a,r,n){this.$rootScope=e,this.$q=t,this.$location=a,this.$injector=r,this.templateSrv=n,e.$on("refresh",this.onDashboardRefresh.bind(this),e),e.$on("template-variable-value-updated",this.updateUrlParamsWithCurrentVariables.bind(this),e)}return e.$inject=["$rootScope","$q","$location","$injector","templateSrv"],e.prototype.init=function(e){var t=this;this.dashboard=e,this.variables=e.templating.list=e.templating.list.map(this.createVariableFromModel.bind(this)),this.templateSrv.init(this.variables);for(var a=0,r=this.variables;a<r.length;a++){r[a].initLock=this.$q.defer()}var n=this.$location.search();return this.$q.all(this.variables.map(function(e){return t.processVariable(e,n)})).then(function(){t.templateSrv.updateTemplateData()})},e.prototype.onDashboardRefresh=function(e,t){var a=this;if(t&&t.fromVariableValueUpdated)return Promise.resolve({});var r=this.variables.filter(function(e){return 2===e.refresh}).map(function(e){var t=e.options.slice();return e.updateOptions().then(function(){P.a.toJson(t)!==P.a.toJson(e.options)&&a.$rootScope.$emit("template-variable-value-updated")})});return this.$q.all(r)},e.prototype.processVariable=function(e,t){for(var a=this,r=[],n=0,i=this.variables;n<i.length;n++){var s=i[n];e.dependsOn(s)&&r.push(s.initLock.promise)}return this.$q.all(r).then(function(){var a=t["var-"+e.name];return void 0!==a?e.setValueFromUrl(a).then(e.initLock.resolve):1===e.refresh||2===e.refresh?e.updateOptions().then(e.initLock.resolve):void e.initLock.resolve()}).finally(function(){a.templateSrv.variableInitialized(e),delete e.initLock})},e.prototype.createVariableFromModel=function(e){var t=ie[e.type].ctor;if(!t)throw{message:"无法找到变量构造函数 "+e.type};return this.$injector.instantiate(t,{model:e})},e.prototype.addVariable=function(e){this.variables.push(e),this.templateSrv.updateTemplateData(),this.dashboard.updateSubmenuVisibility()},e.prototype.removeVariable=function(e){var t=D.a.indexOf(this.variables,e);this.variables.splice(t,1),this.templateSrv.updateTemplateData(),this.dashboard.updateSubmenuVisibility()},e.prototype.updateOptions=function(e){return e.updateOptions()},e.prototype.variableUpdated=function(e,t){var a=this;if(e.initLock)return this.$q.when();var r=D.a.map(this.variables,function(t){if(t!==e)return t.dependsOn(e)?a.updateOptions(t):void 0});return this.$q.all(r).then(function(){t&&(a.$rootScope.$emit("template-variable-value-updated"),a.$rootScope.$broadcast("refresh",{fromVariableValueUpdated:!0}))})},e.prototype.selectOptionsForCurrentValue=function(e){var t,a,r,n,i=[];for(t=0;t<e.options.length;t++)if((n=e.options[t]).selected=!1,D.a.isArray(e.current.value))for(a=0;a<e.current.value.length;a++)r=e.current.value[a],n.value===r&&(n.selected=!0,i.push(n));else n.value===e.current.value&&(n.selected=!0,i.push(n));return i},e.prototype.validateVariableSelectionState=function(e){if(e.current||(e.current={}),D.a.isArray(e.current.value)){var t=this.selectOptionsForCurrentValue(e);return t=0===t.length?e.options[0]:{value:D.a.map(t,function(e){return e.value}),text:D.a.map(t,function(e){return e.text}).join(" + ")},e.setValue(t)}var a=D.a.find(e.options,{text:e.current.text});return a?e.setValue(a):e.options.length?e.setValue(e.options[0]):Promise.resolve()},e.prototype.setOptionFromUrl=function(e,t){var a=this.$q.when();return e.refresh&&(a=e.updateOptions()),a.then(function(){var a=D.a.find(e.options,function(e){return e.text===t||e.value===t}),r=t,n=t;if(!a&&D.a.isArray(t)){r=[];for(var i=function(a){var n=D.a.find(e.options,function(e){return e.value===t[a]});n&&r.push(n.text)},s=0;s<t.length;s++)i(s)}return a=a||{text:r,value:n},e.setValue(a)})},e.prototype.setOptionAsCurrent=function(e,t){return e.current=D.a.cloneDeep(t),D.a.isArray(e.current.text)&&(e.current.text=e.current.text.join(" + ")),this.selectOptionsForCurrentValue(e),this.variableUpdated(e)},e.prototype.updateUrlParamsWithCurrentVariables=function(){var e=this.$location.search();D.a.each(e,function(t,a){0===a.indexOf("var-")&&delete e[a]}),this.templateSrv.fillVariableValuesForUrl(e),this.$location.search(e)},e.prototype.setAdhocFilter=function(e){var t=D.a.find(this.variables,{type:"adhoc",datasource:e.datasource});t||(t=this.createVariableFromModel({name:"Filters",type:"adhoc",datasource:e.datasource}),this.addVariable(t));var a=t.filters,r=D.a.find(a,{key:e.key,value:e.value});r||(r={key:e.key,value:e.value},a.push(r)),r.operator=e.operator,this.variableUpdated(t,!0)},e}();U.a.service("variableSrv",de);var pe=function(){function e(e,t,a,r){this.model=e,this.timeSrv=t,this.templateSrv=a,this.variableSrv=r,this.defaults={type:"interval",name:"",hide:0,label:"",refresh:2,options:[],current:{},query:"1m,10m,30m,1h,6h,12h,1d,7d,14d,30d",auto:!1,auto_min:"10s",auto_count:30,skipUrlSync:!1},Object(ne.a)(this,e,this.defaults),this.refresh=2}return e.$inject=["model","timeSrv","templateSrv","variableSrv"],e.prototype.getSaveModel=function(){return Object(ne.a)(this.model,this,this.defaults),this.model},e.prototype.setValue=function(e){return this.updateAutoValue(),this.variableSrv.setOptionAsCurrent(this,e)},e.prototype.updateAutoValue=function(){if(this.auto){this.options.length&&"auto"!==this.options[0].text&&this.options.unshift({text:"auto",value:"$__auto_interval_"+this.name});var e=A.a.calculateInterval(this.timeSrv.timeRange(),this.auto_count,this.auto_min);this.templateSrv.setGrafanaVariable("$__auto_interval_"+this.name,e.interval),this.templateSrv.setGrafanaVariable("$__auto_interval",e.interval)}},e.prototype.updateOptions=function(){return this.options=D.a.map(this.query.match(/(["'])(.*?)\1|\w+/g),function(e){return{text:(e=e.replace(/["']+/g,"")).trim(),value:e.trim()}}),this.updateAutoValue(),this.variableSrv.validateVariableSelectionState(this)},e.prototype.dependsOn=function(e){return!1},e.prototype.setValueFromUrl=function(e){return this.updateAutoValue(),this.variableSrv.setOptionFromUrl(this,e)},e.prototype.getValueForUrl=function(){return this.current.value},e}();ie.interval={name:"Interval",ctor:pe,description:"定义时间间隔 (如 1m, 1h, 1d)"};var he=function(){function e(e,t,a,r,n){this.model=e,this.datasourceSrv=t,this.templateSrv=a,this.variableSrv=r,this.timeSrv=n,this.defaults={type:"query",label:null,query:"",regex:"",sort:0,datasource:null,refresh:0,hide:0,name:"",multi:!1,includeAll:!1,allValue:null,options:[],current:{},tags:[],useTags:!1,tagsQuery:"",tagValuesQuery:"",skipUrlSync:!1},Object(ne.a)(this,e,this.defaults)}return e.$inject=["model","datasourceSrv","templateSrv","variableSrv","timeSrv"],e.prototype.getSaveModel=function(){return Object(ne.a)(this.model,this,this.defaults),0!==this.refresh&&(this.model.options=[]),this.model},e.prototype.setValue=function(e){return this.variableSrv.setOptionAsCurrent(this,e)},e.prototype.setValueFromUrl=function(e){return this.variableSrv.setOptionFromUrl(this,e)},e.prototype.getValueForUrl=function(){return"All"===this.current.text?"All":this.current.value},e.prototype.updateOptions=function(){return this.datasourceSrv.get(this.datasource).then(this.updateOptionsFromMetricFindQuery.bind(this)).then(this.updateTags.bind(this)).then(this.variableSrv.validateVariableSelectionState.bind(this.variableSrv,this))},e.prototype.updateTags=function(e){var t=this;return this.useTags?this.metricFindQuery(e,this.tagsQuery).then(function(a){t.tags=[];for(var r=0;r<a.length;r++)t.tags.push(a[r].text);return e}):(delete this.tags,e)},e.prototype.getValuesForTag=function(e){var t=this;return this.datasourceSrv.get(this.datasource).then(function(a){var r=t.tagValuesQuery.replace("$tag",e);return t.metricFindQuery(a,r).then(function(e){return D.a.map(e,function(e){return e.text})})})},e.prototype.updateOptionsFromMetricFindQuery=function(e){var t=this;return this.metricFindQuery(e,this.query).then(function(a){return t.options=t.metricNamesToVariableValues(a),t.includeAll&&t.addAllOption(),t.options.length||t.options.push({text:"None",value:"",isNone:!0}),e})},e.prototype.metricFindQuery=function(e,t){var a={range:void 0,variable:this};return 2===this.refresh&&(a.range=this.timeSrv.timeRange()),e.metricFindQuery(t,a)},e.prototype.addAllOption=function(){this.options.unshift({text:"All",value:"$__all"})},e.prototype.metricNamesToVariableValues=function(e){var t,a,r,n;for(a=[],this.regex&&(t=A.a.stringToJsRegex(this.templateSrv.replace(this.regex,{},"regex"))),r=0;r<e.length;r++){var i=e[r],s=void 0===i.text||null===i.text?i.value:i.text,o=void 0===i.value||null===i.value?i.text:i.value;if(D.a.isNumber(o)&&(o=o.toString()),D.a.isNumber(s)&&(s=s.toString()),t){if(!(n=t.exec(o)))continue;n.length>1&&(o=n[1],s=n[1])}a.push({text:s,value:o})}return a=D.a.uniqBy(a,"value"),this.sortVariableValues(a,this.sort)},e.prototype.sortVariableValues=function(e,t){if(0===t)return e;var a=Math.ceil(t/2),r=t%2==0;return 1===a?e=D.a.sortBy(e,"text"):2===a?e=D.a.sortBy(e,function(e){var t=e.text.match(/.*?(\d+).*/);return!t||t.length<2?-1:parseInt(t[1],10)}):3===a&&(e=D.a.sortBy(e,function(e){return D.a.toLower(e.text)})),r&&(e=e.reverse()),e},e.prototype.dependsOn=function(e){return se(this.query,this.datasource,e.name)},e}();ie.query={name:"Query",ctor:he,description:"从数据源查询中获取变量值",supportsMulti:!0};var me=function(){function e(e,t,a,r){this.model=e,this.datasourceSrv=t,this.variableSrv=a,this.templateSrv=r,this.defaults={type:"datasource",name:"",hide:0,label:"",current:{},regex:"",options:[],query:"",refresh:1,skipUrlSync:!1},Object(ne.a)(this,e,this.defaults),this.refresh=1}return e.$inject=["model","datasourceSrv","variableSrv","templateSrv"],e.prototype.getSaveModel=function(){return Object(ne.a)(this.model,this,this.defaults),this.model.options=[],this.model},e.prototype.setValue=function(e){return this.variableSrv.setOptionAsCurrent(this,e)},e.prototype.updateOptions=function(){var e,t=[],a=this.datasourceSrv.getMetricSources({skipVariables:!0});this.regex&&(e=this.templateSrv.replace(this.regex,null,"regex"),e=A.a.stringToJsRegex(e));for(var r=0;r<a.length;r++){var n=a[r];n.meta.id===this.query&&(e&&!e.exec(n.name)||t.push({text:n.name,value:n.name}))}return 0===t.length&&t.push({text:"未找到任何数据源",value:""}),this.options=t,this.variableSrv.validateVariableSelectionState(this)},e.prototype.dependsOn=function(e){return!!this.regex&&se(this.regex,e.name)},e.prototype.setValueFromUrl=function(e){return this.variableSrv.setOptionFromUrl(this,e)},e.prototype.getValueForUrl=function(){return this.current.value},e}();ie.datasource={name:"Datasource",ctor:me,description:"使您能够动态切换多个面板的数据源"};var fe=function(){function e(e,t){this.model=e,this.variableSrv=t,this.defaults={type:"custom",name:"",label:"",hide:0,options:[],current:{},query:"",includeAll:!1,multi:!1,allValue:null,skipUrlSync:!1},Object(ne.a)(this,e,this.defaults)}return e.$inject=["model","variableSrv"],e.prototype.setValue=function(e){return this.variableSrv.setOptionAsCurrent(this,e)},e.prototype.getSaveModel=function(){return Object(ne.a)(this.model,this,this.defaults),this.model},e.prototype.updateOptions=function(){return this.options=D.a.map(this.query.split(/[,]+/),function(e){return{text:e.trim(),value:e.trim()}}),this.includeAll&&this.addAllOption(),this.variableSrv.validateVariableSelectionState(this)},e.prototype.addAllOption=function(){this.options.unshift({text:"All",value:"$__all"})},e.prototype.dependsOn=function(e){return!1},e.prototype.setValueFromUrl=function(e){return this.variableSrv.setOptionFromUrl(this,e)},e.prototype.getValueForUrl=function(){return"All"===this.current.text?"All":this.current.value},e}();ie.custom={name:"Custom",ctor:fe,description:"手动定义变量值",supportsMulti:!0};var ge=function(){function e(e,t){this.model=e,this.variableSrv=t,this.defaults={type:"constant",name:"",hide:2,label:"",query:"",current:{},options:[],skipUrlSync:!1},Object(ne.a)(this,e,this.defaults)}return e.$inject=["model","variableSrv"],e.prototype.getSaveModel=function(){return Object(ne.a)(this.model,this,this.defaults),this.model},e.prototype.setValue=function(e){this.variableSrv.setOptionAsCurrent(this,e)},e.prototype.updateOptions=function(){return this.options=[{text:this.query.trim(),value:this.query.trim()}],this.setValue(this.options[0]),Promise.resolve()},e.prototype.dependsOn=function(e){return!1},e.prototype.setValueFromUrl=function(e){return this.variableSrv.setOptionFromUrl(this,e)},e.prototype.getValueForUrl=function(){return this.current.value},e}();ie.constant={name:"Constant",ctor:ge,description:"使用一个因此的常, 用于定义你共享的仪表盘的指标前缀"};var ve=function(){function e(e){this.model=e,this.defaults={type:"adhoc",name:"",label:"",hide:0,datasource:null,filters:[],skipUrlSync:!1},Object(ne.a)(this,e,this.defaults)}return e.$inject=["model"],e.prototype.setValue=function(e){return Promise.resolve()},e.prototype.getSaveModel=function(){return Object(ne.a)(this.model,this,this.defaults),this.model},e.prototype.updateOptions=function(){return Promise.resolve()},e.prototype.dependsOn=function(e){return!1},e.prototype.setValueFromUrl=function(e){var t=this;return D.a.isArray(e)||(e=[e]),this.filters=e.map(function(e){var a=e.split("|").map(function(e){return t.unescapeDelimiter(e)});return{key:a[0],operator:a[1],value:a[2]}}),Promise.resolve()},e.prototype.getValueForUrl=function(){var e=this;return this.filters.map(function(t){return[t.key,t.operator,t.value].map(function(t){return e.escapeDelimiter(t)}).join("|")})},e.prototype.escapeDelimiter=function(e){return e.replace(/\|/g,"__gfp__")},e.prototype.unescapeDelimiter=function(e){return e.replace(/__gfp__/g,"|")},e.prototype.setFilters=function(e){this.filters=e},e}();ie.adhoc={name:"Ad hoc filters",ctor:ve,description:"添加键/值对过滤器"},U.a.factory("templateSrv",function(){return ce});var ye=a(1080),be=a.n(ye),Se=function(){function e(e,t,a,r,n,i){this.$scope=e,this.$rootScope=t,this.backendSrv=a,this.$sce=r,this.$routeParams=n,this.pluginId=n.pluginId,this.preUpdateHook=function(){return Promise.resolve()},this.postUpdateHook=function(){return Promise.resolve()},this.init()}return e.$inject=["$scope","$rootScope","backendSrv","$sce","$routeParams","navModelSrv"],e.prototype.setNavModel=function(e){var t="readme";(this.navModel={main:{img:e.info.logos.large,subTitle:e.info.author.name,url:"",text:e.name,breadcrumbs:[{title:"插件",url:"plugins"}],children:[{icon:"fa fa-fw fa-file-text-o",id:"readme",text:"Readme",url:"plugins/"+this.model.id+"/edit?tab=readme"}]}},"app"===e.type)&&(this.navModel.main.children.push({icon:"gicon gicon-cog",id:"config",text:"配置",url:"plugins/"+this.model.id+"/edit?tab=config"}),D.a.find(e.includes,{type:"dashboard"})&&this.navModel.main.children.push({icon:"gicon gicon-dashboard",id:"dashboards",text:"仪表盘",url:"plugins/"+this.model.id+"/edit?tab=dashboards"}),t="config");this.tab=this.$routeParams.tab||t;for(var a=0,r=this.navModel.main.children;a<r.length;a++){var n=r[a];n.id===this.tab&&(n.active=!0)}},e.prototype.init=function(){var e=this;return this.backendSrv.get("/api/plugins/"+this.pluginId+"/settings").then(function(t){return e.model=t,e.pluginIcon=e.getPluginIcon(e.model.type),e.model.dependencies.plugins.forEach(function(t){t.icon=e.getPluginIcon(t.type)}),e.includes=D.a.map(t.includes,function(t){return t.icon=e.getPluginIcon(t.type),t}),e.setNavModel(e.model),e.initReadme()})},e.prototype.initReadme=function(){var e=this;return this.backendSrv.get("/api/plugins/"+this.pluginId+"/markdown/readme").then(function(t){var a=new be.a;e.readmeHtml=e.$sce.trustAsHtml(a.render(t))})},e.prototype.getPluginIcon=function(e){switch(e){case"datasource":return"icon-gf icon-gf-datasources";case"panel":return"icon-gf icon-gf-panel";case"app":return"icon-gf icon-gf-apps";case"page":return"icon-gf icon-gf-endpoint-tiny";case"dashboard":return"icon-gf icon-gf-dashboard";default:return"icon-gf icon-gf-apps"}},e.prototype.update=function(){var e=this;this.preUpdateHook().then(function(){var t=D.a.extend({enabled:e.model.enabled,pinned:e.model.pinned,jsonData:e.model.jsonData,secureJsonData:e.model.secureJsonData},{});return e.backendSrv.post("/api/plugins/"+e.pluginId+"/settings",t)}).then(this.postUpdateHook).then(function(e){window.location.href=window.location.href})},e.prototype.importDashboards=function(){return Promise.resolve()},e.prototype.setPreUpdateHook=function(e){this.preUpdateHook=e},e.prototype.setPostUpdateHook=function(e){this.postUpdateHook=e},e.prototype.updateAvailable=function(){var e=this.$scope.$new(!0);e.plugin=this.model,this.$rootScope.appEvent("show-modal",{src:"public/app/features/plugins/partials/update_instructions.html",scope:e})},e.prototype.enable=function(){this.model.enabled=!0,this.model.pinned=!0,this.update()},e.prototype.disable=function(){this.model.enabled=!1,this.model.pinned=!1,this.update()},e}();P.a.module("grafana.controllers").controller("PluginEditCtrl",Se);var xe={},we=function(){function e(e,t,a,r){this.backendSrv=e,this.$routeParams=t,this.$rootScope=a,this.navModelSrv=r,this.pluginId=t.pluginId,xe[this.pluginId]?this.initPage(xe[this.pluginId]):this.loadPluginInfo()}return e.$inject=["backendSrv","$routeParams","$rootScope","navModelSrv"],e.prototype.initPage=function(e){if(this.appModel=e,this.page=D.a.find(e.includes,{slug:this.$routeParams.slug}),xe[this.pluginId]=e,!this.page)return this.$rootScope.appEvent("alert-error",["App Page Not Found",""]),void(this.navModel=this.navModelSrv.getNotFoundNav());var t=this.navModelSrv.getNav("plugin-page-"+e.id);this.navModel={main:{img:e.info.logos.large,subTitle:e.name,url:"",text:this.page.name,breadcrumbs:[{title:e.name,url:t.main.url}]}}},e.prototype.loadPluginInfo=function(){var e=this;this.backendSrv.get("/api/plugins/"+this.pluginId+"/settings").then(function(t){e.initPage(t)})},e}();P.a.module("grafana.controllers").controller("AppPageCtrl",we);var ke=function(){function e(e,t,a){var r=this;this.backendSrv=e,this.tabIndex=0,this.navModel=a.getNav("cfg","plugins",0),this.backendSrv.get("api/plugins",{embedded:0}).then(function(e){r.plugins=e,r.allPlugins=e})}return e.$inject=["backendSrv","$location","navModelSrv"],e.prototype.onQueryUpdated=function(){var e=new RegExp(this.searchQuery,"ig");this.plugins=D.a.filter(this.allPlugins,function(t){return e.test(t.name)||e.test(t.type)})},e}();P.a.module("grafana.controllers").controller("PluginListCtrl",ke);var Ce=function(){function e(e,t,a){var r=this;this.backendSrv=t,this.$rootScope=a,this.dashboards=[],t.get("/api/plugins/"+this.plugin.id+"/dashboards").then(function(e){r.dashboards=e}),oe.a.on("dashboard-list-import-all",this.importAll.bind(this),e)}return e.$inject=["$scope","backendSrv","$rootScope"],e.prototype.importAll=function(e){return this.importNext(0).then(function(){e.resolve("All dashboards imported")}).catch(function(t){e.reject(t)})},e.prototype.importNext=function(e){var t=this;return this.import(this.dashboards[e],!0).then(function(){return e+1<t.dashboards.length?new Promise(function(a){setTimeout(function(){t.importNext(e+1).then(function(){a()})},500)}):Promise.resolve()})},e.prototype.import=function(e,t){var a=this,r={pluginId:this.plugin.id,path:e.path,overwrite:t,inputs:[]};return this.datasource&&r.inputs.push({name:"*",type:"datasource",pluginId:this.datasource.type,value:this.datasource.name}),this.backendSrv.post("/api/dashboards/import",r).then(function(t){a.$rootScope.appEvent("alert-success",["仪表盘已导入",e.title]),D.a.extend(e,t)})},e.prototype.remove=function(e){var t=this;this.backendSrv.delete("/api/dashboards/"+e.importedUri).then(function(){t.$rootScope.appEvent("alert-success",["仪表盘已删除",e.title]),e.imported=!1})},e}();U.a.directive("dashboardImportList",function(){return{restrict:"E",templateUrl:"public/app/features/plugins/import_list/import_list.html",controller:Ce,bindToController:!0,controllerAs:"ctrl",scope:{plugin:"=",datasource:"="}}});var Te=a(10),_e=a(11),Me=a(41),$e=[],Pe={name:"",type:"graphite",url:"",access:"proxy",jsonData:{},secureJsonFields:{},secureJsonData:{}},Ee=!1,De=function(){function e(e,t,a,r,n){var i=this;this.$q=e,this.backendSrv=t,this.$routeParams=a,this.$location=r,this.datasourceSrv=n,null===Me.b.nav.main&&Me.b.nav.load("cfg","datasources"),this.navModel=Object(Te.r)(Me.b.nav),this.datasources=[],this.loadDatasourceTypes().then(function(){i.$routeParams.id?i.getDatasourceById(i.$routeParams.id):i.initNewDatasourceModel()})}return e.$inject=["$q","backendSrv","$routeParams","$location","datasourceSrv"],e.prototype.initNewDatasourceModel=function(){this.isNew=!0,this.current=D.a.cloneDeep(Pe),this.$location.search().gettingstarted&&(this.gettingStarted=!0,this.current.isDefault=!0),this.typeChanged()},e.prototype.loadDatasourceTypes=function(){var e=this;return $e.length>0?(this.types=$e,this.$q.when(null)):this.backendSrv.get("/api/plugins",{enabled:1,type:"datasource"}).then(function(t){$e=t,e.types=t})},e.prototype.getDatasourceById=function(e){var t=this;this.backendSrv.get("/api/datasources/"+e).then(function(e){return t.isNew=!1,t.current=e,Ee&&(Ee=!1,t.testDatasource()),t.typeChanged()})},e.prototype.userChangedType=function(){this.current=D.a.defaults({id:this.current.id,name:this.current.name,isDefault:this.current.isDefault,type:this.current.type},D.a.cloneDeep(Pe)),this.typeChanged()},e.prototype.updateNav=function(){Me.b.nav.initDatasourceEditNav(this.current,this.datasourceMeta,"datasource-settings"),this.navModel=Object(Te.r)(Me.b.nav)},e.prototype.typeChanged=function(){var e=this;return this.backendSrv.get("/api/plugins/"+this.current.type+"/settings").then(function(t){e.datasourceMeta=t,e.updateNav()})},e.prototype.updateFrontendSettings=function(){var e=this;return this.backendSrv.get("/api/frontend/settings").then(function(t){_e.a.datasources=t.datasources,_e.a.defaultDatasource=t.defaultDatasource,e.datasourceSrv.init()})},e.prototype.testDatasource=function(){var e=this;this.datasourceSrv.get(this.current.name).then(function(t){t.testDatasource&&(e.testing={done:!1,status:"error"},e.backendSrv.withNoBackendCache(function(){return t.testDatasource().then(function(t){e.testing.message=t.message,e.testing.status=t.status}).catch(function(t){t.statusText?e.testing.message="HTTP Error "+t.statusText:e.testing.message=t.message})}).finally(function(){e.testing.done=!0}))})},e.prototype.saveChanges=function(){var e=this;if(this.editForm.$valid&&!this.current.readOnly)return this.current.id?this.backendSrv.put("/api/datasources/"+this.current.id,this.current).then(function(t){e.current=t.datasource,e.updateNav(),e.updateFrontendSettings().then(function(){e.testDatasource()})}):this.backendSrv.post("/api/datasources",this.current).then(function(t){e.current=t.datasource,e.updateFrontendSettings(),Ee=!0,e.$location.path("datasources/edit/"+t.id)})},e.prototype.confirmDelete=function(){var e=this;this.backendSrv.delete("/api/datasources/"+this.current.id).then(function(){e.$location.path("datasources")})},e.prototype.delete=function(e){var t=this;W.b.emit("confirm-modal",{title:"删除",text:"您确定要删除此数据源吗?",yesText:"删除",icon:"fa-trash",onConfirm:function(){t.confirmDelete()}})},e}();W.d.controller("DataSourceEditCtrl",De),W.d.directive("datasourceHttpSettings",function(){return{scope:{current:"=",suggestUrl:"@",noDirectAccess:"@"},templateUrl:"public/app/features/plugins/partials/ds_http_settings.html",link:{pre:function(e,t,a){e.showAccessOption="true"!==e.noDirectAccess,e.showAccessHelp=!1,e.toggleAccessHelp=function(){e.showAccessHelp=!e.showAccessHelp},e.getSuggestUrls=function(){return[e.suggestUrl]}}}}});var Ae=function(){function e(e,t){this.backendSrv=e,this.$routeParams=t,null===Me.b.nav.main&&Me.b.nav.load("cfg","datasources"),this.navModel=Object(Te.r)(Me.b.nav),this.$routeParams.id&&this.getDatasourceById(this.$routeParams.id)}return e.$inject=["backendSrv","$routeParams"],e.prototype.getDatasourceById=function(e){var t=this;this.backendSrv.get("/api/datasources/"+e).then(function(e){t.current=e}).then(this.getPluginInfo.bind(this))},e.prototype.updateNav=function(){Me.b.nav.initDatasourceEditNav(this.current,this.datasourceMeta,"datasource-dashboards"),this.navModel=Object(Te.r)(Me.b.nav)},e.prototype.getPluginInfo=function(){var e=this;return this.backendSrv.get("/api/plugins/"+this.current.type+"/settings").then(function(t){e.datasourceMeta=t,e.updateNav()})},e}();W.d.controller("DataSourceDashboardsCtrl",Ae);var Fe=function(){function e(e,t,a,r){var n=this;this.$scope=e,this.backendSrv=t,this.datasourceSrv=a,this.navModelSrv=r,this.navModel=this.navModelSrv.getNav("cfg","datasources",0),t.get("/api/datasources").then(function(e){n.datasources=e,n.unfiltered=e})}return e.$inject=["$scope","backendSrv","datasourceSrv","navModelSrv"],e.prototype.onQueryUpdated=function(){var e=new RegExp(this.searchQuery,"ig");this.datasources=D.a.filter(this.unfiltered,function(t){return e.lastIndex=0,e.test(t.name)||e.test(t.type)})},e.prototype.removeDataSourceConfirmed=function(e){var t=this;this.backendSrv.delete("/api/datasources/"+e.id).then(function(){t.$scope.appEvent("alert-success",["Datasource deleted",""])},function(){t.$scope.appEvent("alert-error",["Unable to delete datasource",""])}).then(function(){t.backendSrv.get("/api/datasources").then(function(e){t.datasources=e}),t.backendSrv.get("/api/frontend/settings").then(function(e){t.datasourceSrv.init(e.datasources)})})},e.prototype.removeDataSource=function(e){var t=this;this.$scope.appEvent("confirm-modal",{title:"删除",text:"确定要删除数据源: "+e.name+"?",yesText:"删除",icon:"fa-trash",onConfirm:function(){t.removeDataSourceConfirmed(e)}})},e}();U.a.controller("DataSourcesCtrl",Fe);var Ie=a(1093),Oe=a.n(Ie),qe=a(66),Re=a(35),Ve=a(34),Ne=function(){function e(e,t){var a=this;this.$injector=t,this.$location=t.get("$location"),this.$scope=e,this.$timeout=t.get("$timeout"),this.editorTabIndex=0,this.events=this.panel.events,this.timing={};var r=_e.a.panels[this.panel.type];r&&(this.pluginId=r.id,this.pluginName=r.name),e.$on("refresh",function(){return a.refresh()}),e.$on("component-did-mount",function(){return a.panelDidMount()}),e.$on("$destroy",function(){a.events.emit("panel-teardown"),a.events.removeAllListeners()})}return e.prototype.init=function(){this.events.emit("panel-initialized"),this.publishAppEvent("panel-initialized",{scope:this.$scope})},e.prototype.panelDidMount=function(){this.events.emit("component-did-mount")},e.prototype.renderingCompleted=function(){W.e.renderingCompleted(this.panel.id,this.timing)},e.prototype.refresh=function(){this.events.emit("refresh",null)},e.prototype.publishAppEvent=function(e,t){this.$scope.$root.appEvent(e,t)},e.prototype.changeView=function(e,t){this.publishAppEvent("panel-change-view",{fullscreen:e,edit:t,panelId:this.panel.id})},e.prototype.viewPanel=function(){this.changeView(!0,!1)},e.prototype.editPanel=function(){this.changeView(!0,!0)},e.prototype.exitFullscreen=function(){this.changeView(!1,!1)},e.prototype.initEditMode=function(){var e=this;this.editorTabs=[],this.addEditorTab("通用","public/app/partials/panelgeneral.html"),this.editModeInitiated=!0,this.events.emit("init-edit-mode",null);var t=(this.$injector.get("$routeParams").tab||"").toLowerCase();t&&this.editorTabs.forEach(function(a,r){a.title.toLowerCase()===t&&(e.editorTabIndex=r)})},e.prototype.changeTab=function(e){this.editorTabIndex=e;var t=this.$injector.get("$route");t.current.params.tab=this.editorTabs[e].title.toLowerCase(),t.updateParams()},e.prototype.addEditorTab=function(e,t,a){var r={title:e,directiveFn:t};D.a.isString(t)&&(r.directiveFn=function(){return{templateUrl:t}}),a?this.editorTabs.splice(a,0,r):this.editorTabs.push(r)},e.prototype.getMenu=function(){var e=[];e.push({text:"查看",click:"ctrl.viewPanel();",icon:"fa fa-fw fa-eye",shortcut:"v"}),this.dashboard.meta.canEdit&&e.push({text:"编辑",click:"ctrl.editPanel();",role:"Editor",icon:"fa fa-fw fa-edit",shortcut:"e"}),e.push({text:"分享",click:"ctrl.sharePanel();",icon:"fa fa-fw fa-share",shortcut:"p s"}),e.push.apply(e,this.getAdditionalMenuItems());var t=this.getExtendedMenu();return e.push({text:"更多 ...",click:"",icon:"fa fa-fw fa-cube",submenu:t}),this.dashboard.meta.canEdit&&(e.push({divider:!0,role:"Editor"}),e.push({text:"移除",click:"ctrl.removePanel();",role:"Editor",icon:"fa fa-fw fa-trash",shortcut:"p r"})),e},e.prototype.getExtendedMenu=function(){var e=[];return!this.fullscreen&&this.dashboard.meta.canEdit&&(e.push({text:"创建副本",click:"ctrl.duplicate()",role:"Editor",shortcut:"p d"}),e.push({text:"复制",click:"ctrl.copyPanel()",role:"Editor"})),e.push({text:"面板 JSON",click:"ctrl.editPanelJson(); dismiss();"}),this.events.emit("init-panel-actions",e),e},e.prototype.getAdditionalMenuItems=function(){return[]},e.prototype.otherPanelInFullscreenMode=function(){return this.dashboard.meta.fullscreen&&!this.fullscreen},e.prototype.calculatePanelHeight=function(){if(this.fullscreen){var e=j()(window).height(),t=Math.floor(.4*e),a=Math.floor(.8*e);this.containerHeight=this.editMode?t:a}else this.containerHeight=this.panel.gridPos.h*Re.c+(this.panel.gridPos.h-1)*Re.d;this.panel.soloMode&&(this.containerHeight=j()(window).height()),this.height=this.containerHeight-29},e.prototype.render=function(e){this.timing.renderStart=(new Date).getTime(),this.events.emit("render",e)},e.prototype.duplicate=function(){var e=this;this.dashboard.duplicatePanel(this.panel),this.$timeout(function(){e.$scope.$root.$broadcast("render")})},e.prototype.removePanel=function(){this.publishAppEvent("panel-remove",{panelId:this.panel.id})},e.prototype.editPanelJson=function(){var e=this.$scope.$root.$new();e.object=this.panel.getSaveModel(),e.updateHandler=this.replacePanel.bind(this),e.enableCopy=!0,this.publishAppEvent("show-modal",{src:"public/app/partials/edit_json.html",scope:e})},e.prototype.copyPanel=function(){Ve.a.set(Re.f,JSON.stringify(this.panel.getSaveModel())),W.b.emit("alert-success",["面板已复制。 打开添加面板进行粘贴"])},e.prototype.replacePanel=function(e,t){var a=this.dashboard,r=D.a.findIndex(a.panels,function(e){return e.id===t.id}),n=a.panels.splice(r,1);this.dashboard.events.emit("panel-removed",n),(e=new qe.a(e)).id=t.id,a.panels.splice(r,0,e),a.sortPanelsByGridPos(),a.events.emit("panel-added",e)},e.prototype.sharePanel=function(){var e=this.$scope.$new();e.panel=this.panel,e.dashboard=this.dashboard,this.publishAppEvent("show-modal",{src:"public/app/features/dashboard/partials/shareModal.html",scope:e})},e.prototype.getInfoMode=function(){return this.error?"error":this.panel.description?"info":this.panel.links&&this.panel.links.length?"links":""},e.prototype.getInfoContent=function(e){var t=this.panel.description;"tooltip"===e.mode&&(t=this.error||this.panel.description);var a=this.$injector.get("linkSrv"),r=this.$injector.get("$sanitize"),n=this.$injector.get("templateSrv").replace(t,this.panel.scopedVars),i='<div class="markdown-html">';if(i+=(new be.a).render(n),this.panel.links&&this.panel.links.length>0){i+="<ul>";for(var s=0,o=this.panel.links;s<o.length;s++){var l=o[s],u=a.getPanelLinkAnchorInfo(l,this.panel.scopedVars);i+='<li><a class="panel-menu-link" href="'+u.href+'" target="'+u.target+'">'+u.title+"</a></li>"}i+="</ul>"}return r(i+="</div>")},e.prototype.openInspector=function(){var e=this.$scope.$new();e.panel=this.panel,e.dashboard=this.dashboard,e.panelInfoHtml=this.getInfoContent({mode:"inspector"}),e.inspector=j.a.extend(!0,{},this.inspector),this.publishAppEvent("show-modal",{src:"public/app/features/dashboard/partials/inspector.html",scope:e})},e}(),je=a(5),Ue=a(225),Le=a(154),Be=a(71),Qe=function(){function e(e,t,a,r){this.$sce=t,this.backendSrv=r,this.panelCtrl=e.ctrl,e.ctrl=this,this.panel=this.panelCtrl.panel,this.dashboard=this.panelCtrl.dashboard,this.datasources=a.getMetricSources(),this.panelDsValue=this.panelCtrl.panel.datasource;for(var n=0,i=this.datasources;n<i.length;n++){var s=i[n];s.value===this.panelDsValue&&(this.datasourceInstance=s)}this.addQueryDropdown={text:"添加查询",value:null,fake:!0},this.panelCtrl.nextRefId=this.dashboard.getNextQueryLetter(this.panel),this.updateDatasourceOptions()}return e.$inject=["$scope","$sce","datasourceSrv","backendSrv"],e.prototype.updateDatasourceOptions=function(){this.datasourceInstance&&(this.hasQueryHelp=this.datasourceInstance.meta.hasQueryHelp,this.queryOptions=this.datasourceInstance.meta.queryOptions)},e.prototype.getOptions=function(e){return Promise.resolve(this.datasources.filter(function(t){return e||!t.meta.builtIn}).map(function(e){return{value:e.value,text:e.name,datasource:e}}))},e.prototype.datasourceChanged=function(e){e&&(this.datasourceInstance=e.datasource,this.panelCtrl.setDatasource(e.datasource),this.updateDatasourceOptions())},e.prototype.addMixedQuery=function(e){e&&(this.panelCtrl.addQuery({isNew:!0,datasource:e.datasource.name}),this.addQueryDropdown={text:"添加查询",value:null,fake:!0})},e.prototype.addQuery=function(){this.panelCtrl.addQuery({isNew:!0})},e.prototype.toggleHelp=function(){var e=this;this.optionsOpen=!1,this.queryTroubleshooterOpen=!1,this.helpOpen=!this.helpOpen,this.backendSrv.get("/api/plugins/"+this.datasourceInstance.meta.id+"/markdown/query_help").then(function(t){var a=new be.a;e.helpHtml=e.$sce.trustAsHtml(a.render(t))})},e.prototype.toggleOptions=function(){this.helpOpen=!1,this.queryTroubleshooterOpen=!1,this.optionsOpen=!this.optionsOpen},e.prototype.toggleQueryTroubleshooter=function(){this.helpOpen=!1,this.optionsOpen=!1,this.queryTroubleshooterOpen=!this.queryTroubleshooterOpen},e}();function ze(){return{restrict:"E",scope:!0,templateUrl:"public/app/features/panel/partials/metrics_tab.html",controller:Qe}}var He=function(e){function t(t,a){var r=e.call(this,t,a)||this;return r.editorTabIndex=1,r.$q=a.get("$q"),r.contextSrv=a.get("contextSrv"),r.datasourceSrv=a.get("datasourceSrv"),r.timeSrv=a.get("timeSrv"),r.templateSrv=a.get("templateSrv"),r.scope=t,r.panel.datasource=r.panel.datasource||null,r.panel.targets||(r.panel.targets=[{}]),r.events.on("refresh",r.onMetricsPanelRefresh.bind(r)),r.events.on("init-edit-mode",r.onInitMetricsPanelEditMode.bind(r)),r.events.on("panel-teardown",r.onPanelTearDown.bind(r)),r}return je.d(t,e),t.prototype.onPanelTearDown=function(){this.dataSubscription&&(this.dataSubscription.unsubscribe(),this.dataSubscription=null)},t.prototype.onInitMetricsPanelEditMode=function(){this.addEditorTab("度量指标",ze),this.addEditorTab("时间范围","public/app/features/panel/partials/panelTime.html")},t.prototype.onMetricsPanelRefresh=function(){var e=this;if(!this.otherPanelInFullscreenMode()){if(this.panel.snapshotData){this.updateTimeRange();var t=this.panel.snapshotData;return D.a.isArray(t)||(t=t.data),this.$timeout(function(){e.events.emit("data-snapshot-load",t)})}this.dataStream||(delete this.error,this.loading=!0,this.setTimeQueryStart(),this.datasourceSrv.get(this.panel.datasource).then(this.updateTimeRange.bind(this)).then(this.issueQueries.bind(this)).then(this.handleQueryResult.bind(this)).catch(function(t){t.cancelled?console.log("Panel request cancelled",t):(e.loading=!1,e.error=t.message||"Request Error",e.inspector={error:t},t.data&&(t.data.message&&(e.error=t.data.message),t.data.error&&(e.error=t.data.error)),e.events.emit("data-error",t),console.log("Panel data error:",t))}))}},t.prototype.setTimeQueryStart=function(){this.timing.queryStart=(new Date).getTime()},t.prototype.setTimeQueryEnd=function(){this.timing.queryEnd=(new Date).getTime()},t.prototype.updateTimeRange=function(e){return this.datasource=e||this.datasource,this.range=this.timeSrv.timeRange(),this.applyPanelTimeOverrides(),this.panel.maxDataPoints?this.resolution=this.panel.maxDataPoints:this.resolution=Math.ceil(j()(window).width()*(this.panel.gridPos.w/24)),this.calculateInterval(),this.datasource},t.prototype.calculateInterval=function(){var e=this.panel.interval;e?e=this.templateSrv.replace(e,this.panel.scopedVars):this.datasource&&this.datasource.interval&&(e=this.datasource.interval);var t=A.a.calculateInterval(this.range,this.resolution,e);this.interval=t.interval,this.intervalMs=t.intervalMs},t.prototype.applyPanelTimeOverrides=function(){if(this.timeInfo="",this.panel.timeFrom){var e=this.templateSrv.replace(this.panel.timeFrom,this.panel.scopedVars),t=Ue.a(e);if(t.invalid)return void(this.timeInfo="invalid time override");if(D.a.isString(this.range.raw.from)){var a=Le.parse(t.from);this.timeInfo=t.display,this.range.from=a,this.range.to=Le.parse(t.to),this.range.raw.from=t.from,this.range.raw.to=t.to}}if(this.panel.timeShift){var r=this.templateSrv.replace(this.panel.timeShift,this.panel.scopedVars);if(Ue.a(r).invalid)return void(this.timeInfo="invalid timeshift");var n="-"+r;this.timeInfo+=" timeshift "+n,this.range.from=Le.parseDateMath(n,this.range.from,!1),this.range.to=Le.parseDateMath(n,this.range.to,!0),this.range.raw={from:this.range.from,to:this.range.to}}this.panel.hideTimeOverride&&(this.timeInfo="")},t.prototype.issueQueries=function(e){if(this.datasource=e,!this.panel.targets||0===this.panel.targets.length)return this.$q.when([]);var t=Object.assign({},this.panel.scopedVars,{__interval:{text:this.interval,value:this.interval},__interval_ms:{text:this.intervalMs,value:this.intervalMs}}),a={timezone:this.dashboard.getTimezone(),panelId:this.panel.id,dashboardId:this.dashboard.id,range:this.range,rangeRaw:this.range.raw,interval:this.interval,intervalMs:this.intervalMs,targets:this.panel.targets,maxDataPoints:this.resolution,scopedVars:t,cacheTimeout:this.panel.cacheTimeout};return e.query(a)},t.prototype.handleQueryResult=function(e){this.setTimeQueryEnd(),this.loading=!1,e&&e.subscribe?this.handleDataStream(e):(this.dashboard.snapshot&&(this.panel.snapshotData=e.data),e&&e.data||(console.log("Data source query result invalid, missing data field:",e),e={data:[]}),this.events.emit("data-received",e.data))},t.prototype.handleDataStream=function(e){var t=this;this.dataStream?console.log("two stream observables!"):(this.dataStream=e,this.dataSubscription=e.subscribe({next:function(e){console.log("dataSubject next!"),e.range&&(t.range=e.range),t.events.emit("data-received",e.data)},error:function(e){t.events.emit("data-error",e),console.log("panel: observer got error")},complete:function(){console.log("panel: observer got complete"),t.dataStream=null}}))},t.prototype.setDatasource=function(e){var t=this;e.meta.mixed?D.a.each(this.panel.targets,function(e){e.datasource=t.panel.datasource,e.datasource||(e.datasource=_e.a.defaultDatasource)}):this.datasource&&this.datasource.meta.mixed&&D.a.each(this.panel.targets,function(e){delete e.datasource}),this.panel.datasource=e.value,this.datasourceName=e.name,this.datasource=null,this.refresh()},t.prototype.getAdditionalMenuItems=function(){var e=[];return _e.a.exploreEnabled&&this.contextSrv.isEditor&&this.datasource&&this.datasource.supportsExplore&&e.push({text:"Explore",click:"ctrl.explore();",icon:"fa fa-fw fa-rocket",shortcut:"x"}),e},t.prototype.explore=function(){var e=this.timeSrv.timeRangeForUrl(),t=je.a({},this.datasource.getExploreState(this.panel),{range:e}),a=Object(Be.c)(JSON.stringify(t));this.$location.url("/explore?state="+a)},t.prototype.addQuery=function(e){e.refId=this.dashboard.getNextQueryLetter(this.panel),this.panel.targets.push(e),this.nextRefId=this.dashboard.getNextQueryLetter(this.panel)},t.prototype.removeQuery=function(e){var t=D.a.indexOf(this.panel.targets,e);this.panel.targets.splice(t,1),this.nextRefId=this.dashboard.getNextQueryLetter(this.panel),this.refresh()},t.prototype.moveQuery=function(e,t){var a=D.a.indexOf(this.panel.targets,e);D.a.move(this.panel.targets,a,a+t)},t}(Ne),Ye=function(){function e(e,t){this.$scope=e,this.$injector=t,this.panel=this.panelCtrl.panel,this.isLastQuery=D.a.indexOf(this.panel.targets,this.target)===this.panel.targets.length-1}return e.prototype.refresh=function(){this.panelCtrl.refresh()},e}(),We=function(){function e(){}return e.alertToGraphThresholds=function(e){for(var t=0;t<e.alert.conditions.length;t++){var a=e.alert.conditions[t];if("query"===a.type){var r=a.evaluator,n=e.thresholds=[];switch(r.type){case"gt":var i=r.params[0];n.push({value:i,op:"gt"});break;case"lt":i=r.params[0];n.push({value:i,op:"lt"});break;case"outside_range":(s=r.params[0])>(o=r.params[1])?(n.push({value:s,op:"gt"}),n.push({value:o,op:"lt"})):(n.push({value:s,op:"lt"}),n.push({value:o,op:"gt"}));break;case"within_range":var s,o;(s=r.params[0])>(o=r.params[1])?(n.push({value:s,op:"lt"}),n.push({value:o,op:"gt"})):(n.push({value:s,op:"gt"}),n.push({value:o,op:"lt"}))}break}}for(var l=0,u=e.thresholds;l<u.length;l++){var c=u[l];c.fill=!0,c.line=!0,c.colorMode="critical"}return!0},e}(),Ge=a(146),Ke=function(){function e(e,t,a,r,n,i){this.$scope=e,this.backendSrv=t,this.dashboardSrv=a,this.uiSegmentSrv=r,this.$q=n,this.datasourceSrv=i,this.panelCtrl=e.ctrl,this.panel=this.panelCtrl.panel,this.$scope.ctrl=this,this.subTabIndex=0,this.evalFunctions=ae.a.evalFunctions,this.evalOperators=ae.a.evalOperators,this.conditionTypes=ae.a.conditionTypes,this.noDataModes=ae.a.noDataModes,this.executionErrorModes=ae.a.executionErrorModes,this.appSubUrl=_e.a.appSubUrl}return e.$inject=["$scope","backendSrv","dashboardSrv","uiSegmentSrv","$q","datasourceSrv"],e.prototype.$onInit=function(){var e=this;this.addNotificationSegment=this.uiSegmentSrv.newPlusButton();var t=this.graphThresholdChanged.bind(this);return this.panelCtrl.events.on("threshold-changed",t),this.$scope.$on("$destroy",function(){e.panelCtrl.events.off("threshold-changed",t),e.panelCtrl.editingThresholds=!1,e.panelCtrl.render()}),this.notifications=[],this.alertNotifications=[],this.alertHistory=[],this.backendSrv.get("/api/alert-notifications").then(function(t){e.notifications=t,e.initModel(),e.validateModel()})},e.prototype.getAlertHistory=function(){var e=this;this.backendSrv.get("/api/annotations?dashboardId="+this.panelCtrl.dashboard.id+"&panelId="+this.panel.id+"&limit=50&type=alert").then(function(t){e.alertHistory=D.a.map(t,function(t){return t.time=e.dashboardSrv.getCurrent().formatDate(t.time,"MMM D, YYYY HH:mm:ss"),t.stateModel=ae.a.getStateDisplayModel(t.newState),t.info=ae.a.getAlertAnnotationInfo(t),t})})},e.prototype.getNotificationIcon=function(e){switch(e){case"email":return"fa fa-envelope";case"slack":return"fa fa-slack";case"victorops":return"fa fa-pagelines";case"webhook":return"fa fa-cubes";case"pagerduty":return"fa fa-bullhorn";case"opsgenie":return"fa fa-bell";case"hipchat":return"fa fa-mail-forward";case"pushover":return"fa fa-mobile";case"kafka":return"fa fa-random";case"teams":return"fa fa-windows"}return"fa fa-bell"},e.prototype.getNotifications=function(){var e=this;return Promise.resolve(this.notifications.map(function(t){return e.uiSegmentSrv.newSegment(t.name)}))},e.prototype.changeTabIndex=function(e){this.subTabIndex=e,2===this.subTabIndex&&this.getAlertHistory()},e.prototype.notificationAdded=function(){var e=D.a.find(this.notifications,{name:this.addNotificationSegment.value});e&&(this.alertNotifications.push({name:e.name,iconClass:this.getNotificationIcon(e.type),isDefault:!1}),this.alert.notifications.push({id:e.id}),this.addNotificationSegment.value=this.uiSegmentSrv.newPlusButton().value,this.addNotificationSegment.html=this.uiSegmentSrv.newPlusButton().html)},e.prototype.removeNotification=function(e){this.alert.notifications.splice(e,1),this.alertNotifications.splice(e,1)},e.prototype.initModel=function(){var e=this,t=this.alert=this.panel.alert;if(t){t.conditions=t.conditions||[],0===t.conditions.length&&t.conditions.push(this.buildDefaultCondition()),t.noDataState=t.noDataState||"no_data",t.executionErrorState=t.executionErrorState||"alerting",t.frequency=t.frequency||"60s",t.handler=t.handler||1,t.notifications=t.notifications||[];var a=this.panel.title+" 报警";t.name=t.name||a,this.conditionModels=D.a.reduce(t.conditions,function(t,a){return t.push(e.buildConditionModel(a)),t},[]),We.alertToGraphThresholds(this.panel);for(var r=0,n=t.notifications;r<n.length;r++){var i=n[r],s=D.a.find(this.notifications,{id:i.id});s&&!1===s.isDefault&&(s.iconClass=this.getNotificationIcon(s.type),this.alertNotifications.push(s))}for(var o=0,l=this.notifications;o<l.length;o++){var u=l[o];u.isDefault&&(u.iconClass=this.getNotificationIcon(u.type),u.bgColor="#00678b",this.alertNotifications.push(u))}this.panelCtrl.editingThresholds=!0,this.panelCtrl.render()}},e.prototype.graphThresholdChanged=function(e){for(var t=0,a=this.alert.conditions;t<a.length;t++){var r=a[t];if("query"===r.type){r.evaluator.params[e.handleIndex]=e.threshold.value,this.evaluatorParamsChanged();break}}},e.prototype.buildDefaultCondition=function(){return{type:"query",query:{params:["A","5m","now"]},reducer:{type:"avg",params:[]},evaluator:{type:"gt",params:[null]},operator:{type:"and"}}},e.prototype.validateModel=function(){var e=this;if(this.alert)for(var t,a=null,r=0,n=this.alert.conditions;r<n.length;r++){var i=n[r];if("query"===i.type){for(var s=0,o=this.panel.targets;s<o.length;s++){var l=o[s];if(t||(t=l),i.query.params[0]===l.refId){a=l;break}}a||(t?(i.query.params[0]=t.refId,a=t):this.error="Could not find any metric queries");var u=a.datasource||this.panel.datasource;this.datasourceSrv.get(u).then(function(t){t.meta.alerting?t.targetContainsTemplate(a)?e.error="Template variables are not supported in alert queries":e.error="":e.error="The datasource does not support alerting queries"})}}},e.prototype.buildConditionModel=function(e){var t={source:e,type:e.type};return t.queryPart=new Ge.a(e.query,ae.a.alertQueryDef),t.reducerPart=ae.a.createReducerPart(e.reducer),t.evaluator=e.evaluator,t.operator=e.operator,t},e.prototype.handleQueryPartEvent=function(e,t){var a=this;switch(t.name){case"action-remove-part":break;case"get-part-actions":return this.$q.when([]);case"part-param-changed":this.validateModel();case"get-param-options":var r=this.panel.targets.map(function(e){return a.uiSegmentSrv.newSegment({value:e.refId})});return this.$q.when(r)}},e.prototype.handleReducerPartEvent=function(e,t){switch(t.name){case"action":e.source.reducer.type=t.action.value,e.reducerPart=ae.a.createReducerPart(e.source.reducer);break;case"get-part-actions":for(var a=[],r=0,n=ae.a.reducerTypes;r<n.length;r++){var i=n[r];i.value!==e.source.reducer.type&&a.push(i)}return this.$q.when(a)}},e.prototype.addCondition=function(e){var t=this.buildDefaultCondition();this.alert.conditions.push(t),this.conditionModels.push(this.buildConditionModel(t))},e.prototype.removeCondition=function(e){this.alert.conditions.splice(e,1),this.conditionModels.splice(e,1)},e.prototype.delete=function(){var e=this;oe.a.emit("confirm-modal",{title:"删除报警",text:"确定希望删除这条报警规则?",text2:"需要保存仪表盘使删除生效",icon:"fa-trash",yesText:"删除",onConfirm:function(){delete e.panel.alert,e.alert=null,e.panel.thresholds=[],e.conditionModels=[],e.panelCtrl.alertState=null,e.panelCtrl.render()}})},e.prototype.enable=function(){this.panel.alert={},this.initModel()},e.prototype.evaluatorParamsChanged=function(){We.alertToGraphThresholds(this.panel),this.panelCtrl.render()},e.prototype.evaluatorTypeChanged=function(e){switch(e.type){case"lt":case"gt":e.params=[e.params[0]];break;case"within_range":case"outside_range":e.params=[e.params[0],e.params[1]];break;case"no_value":e.params=[]}this.evaluatorParamsChanged()},e.prototype.clearHistory=function(){var e=this;oe.a.emit("confirm-modal",{title:"删除历史状态",text:"您确定要删除此警报的所有历史状态和注释吗?",icon:"fa-trash",yesText:"是",onConfirm:function(){e.backendSrv.post("/api/annotations/mass-delete",{dashboardId:e.panelCtrl.dashboard.id,panelId:e.panel.id}).then(function(t){e.alertHistory=[],e.panelCtrl.refresh()})}})},e.prototype.test=function(){var e=this;this.testing=!0,this.testResult=!1;var t={dashboard:this.dashboardSrv.getCurrent().getSaveModelClone(),panelId:this.panelCtrl.panel.id};return this.backendSrv.post("/api/alerts/test",t).then(function(t){e.testResult=t,e.testing=!1})},e}();function Je(){return{restrict:"E",scope:!0,templateUrl:"public/app/features/alerting/partials/alert_tab.html",controller:Ke}}var Xe=a(1083),Ze=a.n(Xe),et=a(15),tt=a(1081),at=a(227),rt=a(0),nt=a.n(rt),it=a(23),st=a.n(it),ot=a(115),lt=a(1094),ut=a(450),ct=a(1092),dt="YYYY-MM-DDTHH:mm:ssZ",pt=1,ht=0,mt=";",ft="\r\n",gt='"',vt="grafana_data_export.csv";function yt(e){return e?e.split(gt).join(gt+gt):e}var bt=new DOMParser;function St(e){if(!e)return e;var t=/&[^;]+;/g;function a(e){return bt.parseFromString(e,"text/html").body.textContent}return e.replace(t,a).replace(t,a)}function xt(e){return e?"sep="+mt+ft:""}function wt(e,t){void 0===t&&(t=!0);for(var a="",r=0;r<e.length;r+=1)Object(E.isBoolean)(e[r])||Object(ct.isNullOrUndefined)(e[r])?a+=e[r]:Object(E.isNumber)(e[r])?a+=e[r].toLocaleString():a+=""+gt+yt(Object(E.unescape)(St(e[r])))+gt,r<e.length-1&&(a+=mt);return t?a+ft:a}function kt(e,t,a){void 0===t&&(t=dt),void 0===a&&(a=!1);for(var r=xt(a)+wt(["Series","Time","Value"]),n=0;n<e.length;n+=1)for(var i=0;i<e[n].datapoints.length;i+=1)r+=wt([e[n].alias,Y()(e[n].datapoints[i][pt]).format(t),e[n].datapoints[i][ht]],i<e[n].datapoints.length-1||n<e.length-1);return r}function Ct(e,t,a){void 0===t&&(t=dt),void 0===a&&(a=!1),Pt(kt(e,t,a),vt)}function Tt(e,t,a){void 0===t&&(t=dt),void 0===a&&(a=!1);var r=xt(a)+wt(["Time"].concat(e.map(function(e){return e.alias})));e=function(e){for(var t=[],a=0;a<e.length;a++)for(var r=e[a].datapoints,n=0;n<r.length;n++)t.push(r[n][pt]);t=Object(E.sortedUniq)(t.sort());for(var a=0;a<e.length;a++){for(var r=e[a].datapoints,i=r.map(function(e){return e[pt]}),s=[],o=void 0,n=0;n<t.length;n++)-1!==(o=Object(E.sortedIndexOf)(i,t[n]))?s.push(r[o]):s.push([null,t[n]]);e[a].datapoints=s}return e}(e);for(var n=function(a){var n=Y()(e[0].datapoints[a][pt]).format(t);r+=wt([n].concat(e.map(function(e){return e.datapoints[a][ht]})),a<e[0].datapoints.length-1)},i=0;i<e[0].datapoints.length;i+=1)n(i);return r}function _t(e,t,a){void 0===t&&(t=dt),void 0===a&&(a=!1),Pt(Tt(e,t,a),vt)}function Mt(e,t){void 0===t&&(t=!1);var a=xt(t);a+=wt(e.columns.map(function(e){return e.title||e.text}));for(var r=0;r<e.rows.length;r+=1)a+=wt(e.rows[r],r<e.rows.length-1);return a}function $t(e,t){void 0===t&&(t=!1),Pt(Mt(e,t),vt)}function Pt(e,t){var a=new Blob([e],{type:"text/csv;charset=utf-8;header=present;"});Object(ut.saveAs)(a,t)}function Et(e,t){var a=(t=t||{}).delimiter||".",r=t.maxDepth||3,n=1,i={};return function e(s,o){Object.keys(s).forEach(function(l){var u=s[l],c=t.safe&&Array.isArray(u),d="[object Object]"===Object.prototype.toString.call(u),p=o?o+a+l:l;if(t.maxDepth||(r=n+1),!c&&d&&Object.keys(u).length&&n<r)return++n,e(u,p);i[p]=u})}(e,null),i}var Dt=a(220),At=a(224),Ft=/^(\d+)(?:\.(\d+))?(?:\.(\d+))?(?:-([0-9A-Za-z\.]+))?/,It=function(){function e(e){var t=Ft.exec(e);t&&(this.major=Number(t[1]),this.minor=Number(t[2]||0),this.patch=Number(t[3]||0),this.meta=t[4])}return e.prototype.isGtOrEq=function(t){var a=new e(t);return!(this.major<a.major||this.minor<a.minor||this.patch<a.patch)},e.prototype.isValid=function(){return D.a.isNumber(this.major)},e}();function Ot(e,t){return new It(e).isGtOrEq(t)}var qt={};function Rt(e){e.params=e.params||[],e.defaultParams=e.defaultParams||[],qt[e.name]=e,e.shortName&&(qt[e.shortName]=e)}var Vt=[{name:"other",type:"value_or_series",optional:!0,multiple:!0}];function Nt(e,t){return!e.version||Ot(t,e.version)}Rt({name:"scaleToSeconds",category:"Transform",params:[{name:"seconds",type:"int"}],defaultParams:[1]}),Rt({name:"perSecond",category:"Transform",params:[{name:"max value",type:"int",optional:!0}],defaultParams:[]}),Rt({name:"holtWintersForecast",category:"Calculate"}),Rt({name:"holtWintersConfidenceBands",category:"Calculate",params:[{name:"delta",type:"int"}],defaultParams:[3]}),Rt({name:"holtWintersAberration",category:"Calculate",params:[{name:"delta",type:"int"}],defaultParams:[3]}),Rt({name:"nPercentile",category:"Calculate",params:[{name:"Nth percentile",type:"int"}],defaultParams:[95]}),Rt({name:"diffSeries",params:Vt,defaultParams:["#A"],category:"Combine"}),Rt({name:"stddevSeries",params:Vt,defaultParams:[""],category:"Combine"}),Rt({name:"divideSeries",params:Vt,defaultParams:["#A"],category:"Combine"}),Rt({name:"multiplySeries",params:Vt,defaultParams:["#A"],category:"Combine"}),Rt({name:"asPercent",params:Vt,defaultParams:["#A"],category:"Combine"}),Rt({name:"group",params:Vt,defaultParams:["#A","#B"],category:"Combine"}),Rt({name:"sumSeries",shortName:"sum",category:"Combine",params:Vt,defaultParams:[""]}),Rt({name:"averageSeries",shortName:"avg",category:"Combine",params:Vt,defaultParams:[""]}),Rt({name:"rangeOfSeries",category:"Combine"}),Rt({name:"percentileOfSeries",category:"Combine",params:[{name:"n",type:"int"},{name:"interpolate",type:"boolean",options:["true","false"]}],defaultParams:[95,"false"]}),Rt({name:"sumSeriesWithWildcards",category:"Combine",params:[{name:"node",type:"int",multiple:!0}],defaultParams:[3]}),Rt({name:"maxSeries",shortName:"max",category:"Combine"}),Rt({name:"minSeries",shortName:"min",category:"Combine"}),Rt({name:"averageSeriesWithWildcards",category:"Combine",params:[{name:"node",type:"int",multiple:!0}],defaultParams:[3]}),Rt({name:"alias",category:"Alias",params:[{name:"alias",type:"string"}],defaultParams:["alias"]}),Rt({name:"aliasSub",category:"Alias",params:[{name:"search",type:"string"},{name:"replace",type:"string"}],defaultParams:["","\\1"]}),Rt({name:"consolidateBy",category:"Special",params:[{name:"function",type:"string",options:["sum","average","min","max"]}],defaultParams:["max"]}),Rt({name:"cumulative",category:"Special",params:[],defaultParams:[]}),Rt({name:"groupByNode",category:"Combine",params:[{name:"node",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12]},{name:"function",type:"string",options:["sum","avg","maxSeries"]}],defaultParams:[3,"sum"]}),Rt({name:"aliasByNode",category:"Alias",params:[{name:"node",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12],multiple:!0}],defaultParams:[3]}),Rt({name:"substr",category:"Special",params:[{name:"start",type:"int",options:[-6,-5,-4,-3,-2,-1,0,1,2,3,4,5,6,7,8,9,10,12]},{name:"stop",type:"int",options:[-6,-5,-4,-3,-2,-1,0,1,2,3,4,5,6,7,8,9,10,12]}],defaultParams:[0,0]}),Rt({name:"sortByName",category:"Sorting",params:[{name:"natural",type:"boolean",options:["true","false"],optional:!0}],defaultParams:["false"]}),Rt({name:"sortByMaxima",category:"Sorting"}),Rt({name:"sortByMinima",category:"Sorting"}),Rt({name:"sortByTotal",category:"Sorting"}),Rt({name:"aliasByMetric",category:"Alias"}),Rt({name:"randomWalk",fake:!0,category:"Special",params:[{name:"name",type:"string"}],defaultParams:["randomWalk"]}),Rt({name:"countSeries",category:"Combine"}),Rt({name:"constantLine",category:"Special",params:[{name:"value",type:"int"}],defaultParams:[10]}),Rt({name:"cactiStyle",category:"Special"}),Rt({name:"keepLastValue",category:"Transform",params:[{name:"n",type:"int"}],defaultParams:[100]}),Rt({name:"changed",category:"Special",params:[],defaultParams:[]}),Rt({name:"scale",category:"Transform",params:[{name:"factor",type:"int"}],defaultParams:[1]}),Rt({name:"offset",category:"Transform",params:[{name:"amount",type:"int"}],defaultParams:[10]}),Rt({name:"transformNull",category:"Transform",params:[{name:"amount",type:"int"}],defaultParams:[0]}),Rt({name:"integral",category:"Transform"}),Rt({name:"derivative",category:"Transform"}),Rt({name:"nonNegativeDerivative",category:"Transform",params:[{name:"max value or 0",type:"int",optional:!0}],defaultParams:[""]}),Rt({name:"timeShift",category:"Transform",params:[{name:"amount",type:"select",options:["1h","6h","12h","1d","2d","7d","14d","30d"]}],defaultParams:["1d"]}),Rt({name:"timeStack",category:"Transform",params:[{name:"timeShiftUnit",type:"select",options:["1h","6h","12h","1d","2d","7d","14d","30d"]},{name:"timeShiftStart",type:"int"},{name:"timeShiftEnd",type:"int"}],defaultParams:["1d",0,7]}),Rt({name:"summarize",category:"Transform",params:[{name:"interval",type:"string"},{name:"func",type:"select",options:["sum","avg","min","max","last"]},{name:"alignToFrom",type:"boolean",optional:!0,options:["false","true"]}],defaultParams:["1h","sum","false"]}),Rt({name:"smartSummarize",category:"Transform",params:[{name:"interval",type:"string"},{name:"func",type:"select",options:["sum","avg","min","max","last"]}],defaultParams:["1h","sum"]}),Rt({name:"absolute",category:"Transform"}),Rt({name:"hitcount",category:"Transform",params:[{name:"interval",type:"string"}],defaultParams:["10s"]}),Rt({name:"log",category:"Transform",params:[{name:"base",type:"int"}],defaultParams:["10"]}),Rt({name:"averageAbove",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[25]}),Rt({name:"averageBelow",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[25]}),Rt({name:"currentAbove",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[25]}),Rt({name:"currentBelow",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[25]}),Rt({name:"maximumAbove",category:"Filter Series",params:[{name:"value",type:"int"}],defaultParams:[0]}),Rt({name:"maximumBelow",category:"Filter Series",params:[{name:"value",type:"int"}],defaultParams:[0]}),Rt({name:"minimumAbove",category:"Filter Series",params:[{name:"value",type:"int"}],defaultParams:[0]}),Rt({name:"minimumBelow",category:"Filter Series",params:[{name:"value",type:"int"}],defaultParams:[0]}),Rt({name:"limit",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[5]}),Rt({name:"mostDeviant",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[10]}),Rt({name:"exclude",category:"Filter Series",params:[{name:"exclude",type:"string"}],defaultParams:["exclude"]}),Rt({name:"highestCurrent",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),Rt({name:"highestMax",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),Rt({name:"lowestCurrent",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),Rt({name:"movingAverage",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10]}),Rt({name:"movingMedian",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:["5"]}),Rt({name:"stdev",category:"Calculate",params:[{name:"n",type:"int"},{name:"tolerance",type:"int"}],defaultParams:[5,.1]}),Rt({name:"highestAverage",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),Rt({name:"lowestAverage",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),Rt({name:"removeAbovePercentile",category:"Filter Data",params:[{name:"n",type:"int"}],defaultParams:[5]}),Rt({name:"removeAboveValue",category:"Filter Data",params:[{name:"n",type:"int"}],defaultParams:[5]}),Rt({name:"removeBelowPercentile",category:"Filter Data",params:[{name:"n",type:"int"}],defaultParams:[5]}),Rt({name:"removeBelowValue",category:"Filter Data",params:[{name:"n",type:"int"}],defaultParams:[5]}),Rt({name:"useSeriesAbove",category:"Filter Series",params:[{name:"value",type:"int"},{name:"search",type:"string"},{name:"replace",type:"string"}],defaultParams:[0,"search","replace"]}),Rt({name:"aggregateLine",category:"Calculate",params:[{name:"func",type:"select",options:["sum","avg","min","max","last"]}],defaultParams:["avg"],version:"1.0"}),Rt({name:"averageOutsidePercentile",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[95],version:"1.0"}),Rt({name:"delay",category:"Transform",params:[{name:"steps",type:"int"}],defaultParams:[1],version:"1.0"}),Rt({name:"exponentialMovingAverage",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10],version:"1.0"}),Rt({name:"fallbackSeries",category:"Special",params:[{name:"fallback",type:"string"}],defaultParams:["constantLine(0)"],version:"1.0"}),Rt({name:"grep",category:"Filter Series",params:[{name:"grep",type:"string"}],defaultParams:["grep"],version:"1.0"}),Rt({name:"groupByNodes",category:"Combine",params:[{name:"function",type:"string",options:["sum","avg","maxSeries"]},{name:"node",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12],multiple:!0}],defaultParams:["sum",3],version:"1.0"}),Rt({name:"integralByInterval",category:"Transform",params:[{name:"intervalUnit",type:"select",options:["1h","6h","12h","1d","2d","7d","14d","30d"]}],defaultParams:["1d"],version:"1.0"}),Rt({name:"interpolate",category:"Transform",params:[{name:"limit",type:"int",optional:!0}],defaultParams:[],version:"1.0"}),Rt({name:"invert",category:"Transform",version:"1.0"}),Rt({name:"isNonNull",category:"Combine",version:"1.0"}),Rt({name:"linearRegression",category:"Calculate",params:[{name:"startSourceAt",type:"select",options:["-1h","-6h","-12h","-1d","-2d","-7d","-14d","-30d"],optional:!0},{name:"endSourceAt",type:"select",options:["-1h","-6h","-12h","-1d","-2d","-7d","-14d","-30d"],optional:!0}],defaultParams:[],version:"1.0"}),Rt({name:"mapSeries",shortName:"map",params:[{name:"node",type:"int"}],defaultParams:[3],category:"Combine",version:"1.0"}),Rt({name:"movingMin",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10],version:"1.0"}),Rt({name:"movingMax",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10],version:"1.0"}),Rt({name:"movingSum",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10],version:"1.0"}),Rt({name:"multiplySeriesWithWildcards",category:"Combine",params:[{name:"position",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12],multiple:!0}],defaultParams:[2],version:"1.0"}),Rt({name:"offsetToZero",category:"Transform",version:"1.0"}),Rt({name:"pow",category:"Transform",params:[{name:"factor",type:"int"}],defaultParams:[10],version:"1.0"}),Rt({name:"powSeries",category:"Transform",params:Vt,defaultParams:[""],version:"1.0"}),Rt({name:"reduceSeries",shortName:"reduce",params:[{name:"function",type:"string",options:["asPercent","diffSeries","divideSeries"]},{name:"reduceNode",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,11,12,13]},{name:"reduceMatchers",type:"string",multiple:!0}],defaultParams:["asPercent",2,"used_bytes"],category:"Combine",version:"1.0"}),Rt({name:"removeBetweenPercentile",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[95],version:"1.0"}),Rt({name:"removeEmptySeries",category:"Filter Series",version:"1.0"}),Rt({name:"squareRoot",category:"Transform",version:"1.0"}),Rt({name:"timeSlice",category:"Transform",params:[{name:"startSliceAt",type:"select",options:["-1h","-6h","-12h","-1d","-2d","-7d","-14d","-30d"]},{name:"endSliceAt",type:"select",options:["-1h","-6h","-12h","-1d","-2d","-7d","-14d","-30d"],optional:!0}],defaultParams:["-1h"],version:"1.0"}),Rt({name:"weightedAverage",category:"Combine",params:[{name:"other",type:"value_or_series",optional:!0},{name:"node",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12]}],defaultParams:["#A",4],version:"1.0"}),Rt({name:"seriesByTag",category:"Special",params:[{name:"tagExpression",type:"string",multiple:!0}],version:"1.1"}),Rt({name:"groupByTags",category:"Combine",params:[{name:"function",type:"string",options:["sum","avg","maxSeries"]},{name:"tag",type:"string",multiple:!0}],defaultParams:["sum","tag"],version:"1.1"}),Rt({name:"aliasByTags",category:"Alias",params:[{name:"tag",type:"string",multiple:!0}],defaultParams:["tag"],version:"1.1"});var jt=function(){function e(e,t){this.def=e,this.params=[],t&&t.withDefaultParams&&(this.params=e.defaultParams.slice(0)),this.updateText()}return e.prototype.render=function(e){for(var t=this.def.name+"(",a=D.a.map(this.params,function(e,t){var a;return t<this.def.params.length?a=this.def.params[t].type:D.a.get(D.a.last(this.def.params),"multiple")&&(a=D.a.get(D.a.last(this.def.params),"type")),"value_or_series"===a?e:"boolean"===a&&D.a.includes(["true","false"],e)?e:D.a.includes(["int","float","int_or_interval","node_or_tag","node"],a)&&D.a.isFinite(+e)?D.a.toString(+e):"'"+e+"'"}.bind(this));""===a[a.length-1];)a.pop();return e&&a.unshift(e),t+a.join(", ")+")"},e.prototype._hasMultipleParamsInString=function(e,t){return-1!==e.indexOf(",")&&(!(!this.def.params[t+1]||!this.def.params[t+1].optional)||!!(t+1>=this.def.params.length&&D.a.get(D.a.last(this.def.params),"multiple")))},e.prototype.updateParam=function(e,t){this._hasMultipleParamsInString(e,t)?D.a.each(e.split(","),function(e,a){this.updateParam(e.trim(),t+a)}.bind(this)):(""===e&&(t>=this.def.params.length||this.def.params[t].optional)?this.params.splice(t,1):this.params[t]=e,this.updateText())},e.prototype.updateText=function(){if(0!==this.params.length){var e=this.def.name+"(";e+=this.params.join(", "),e+=")",this.text=e}else this.text=this.def.name+"()"},e}();function Ut(e,t){if(!(t||qt)[e])throw{message:"Method not found "+e};return(t||qt)[e]}var Lt={createFuncInstance:function(e,t,a){return D.a.isString(e)&&(e=Ut(e,a)),new jt(e,t)},getFuncDef:Ut,getFuncDefs:function(e,t){var a={};return D.a.forEach(t||qt,function(t){Nt(t,e)&&(a[t.name]=D.a.assign({},t,{params:D.a.filter(t.params,function(t){return Nt(t,e)})}))}),a},parseFuncDefs:function(e){var t={};return D.a.forEach(e||{},function(e,a){if("Graph"!==e.group){var r=e.description;r&&(r=r.replace(/:py:func:`(.+)( <[^>]*>)?`/g,"``$1``").replace(/.. seealso:: /g,"See also: ").replace(/.. code-block *:: *none/g,".. code-block::"));var n={name:e.name,description:r,category:e.group,params:[],defaultParams:[],fake:!1};/^seriesLists?$/.test(D.a.get(e,"params[0].type",""))?e.params[0].multiple?e.params[0].required=!1:e.params.shift():n.fake=!0,D.a.forEach(e.params,function(e){var t={name:e.name,type:"string",optional:!e.required,multiple:!!e.multiple,options:void 0};void 0!==e.default?n.defaultParams.push(D.a.toString(e.default)):e.suggestions?n.defaultParams.push(D.a.toString(e.suggestions[0])):n.defaultParams.push(""),"boolean"===e.type?(t.type="boolean",t.options=["true","false"]):"integer"===e.type?t.type="int":"float"===e.type?t.type="float":"node"===e.type?(t.type="node",t.options=["0","1","2","3","4","5","6","7","8","9","10","11","12"]):"nodeOrTag"===e.type?(t.type="node_or_tag",t.options=["name","0","1","2","3","4","5","6","7","8","9","10","11","12"]):"intOrInterval"===e.type?t.type="int_or_interval":"seriesList"===e.type&&(t.type="value_or_series"),e.options?t.options=D.a.map(e.options,D.a.toString):e.suggestions&&(t.options=D.a.map(e.suggestions,D.a.toString)),n.params.push(t)}),t[a]=n}}),t}};function Bt(e,t,a,r){var n=this;this.basicAuth=e.basicAuth,this.url=e.url,this.name=e.name,this.graphiteVersion=e.jsonData.graphiteVersion||"0.9",this.supportsTags=function(e){return Ot(e,"1.1")}(this.graphiteVersion),this.cacheTimeout=e.cacheTimeout,this.withCredentials=e.withCredentials,this.render_method=e.render_method||"POST",this.funcDefs=null,this.funcDefsPromise=null,this.getQueryOptionsInfo=function(){return{maxDataPoints:!0,cacheTimeout:!0,links:[{text:"帮助",url:"http://docs.grafana.org/features/datasources/graphite/#using-graphite-in-grafana"}]}},this.query=function(e){var a={from:this.translateTime(e.rangeRaw.from,!1),until:this.translateTime(e.rangeRaw.to,!0),targets:e.targets,format:e.format,cacheTimeout:e.cacheTimeout||this.cacheTimeout,maxDataPoints:e.maxDataPoints},r=this.buildGraphiteParams(a,e.scopedVars);if(0===r.length)return t.when({data:[]});var n={method:"POST",url:"/render",data:r.join("&"),headers:{"Content-Type":"application/x-www-form-urlencoded"}};return this.addTracingHeaders(n,e),e.panelId&&(n.requestId=this.name+".panelId."+e.panelId),this.doGraphiteRequest(n).then(this.convertDataPointsToMs)},this.addTracingHeaders=function(e,t){!this.url.match(/^http/)&&(e.headers["X-Dashboard-Id"]=t.dashboardId,e.headers["X-Panel-Id"]=t.panelId)},this.convertDataPointsToMs=function(e){if(!e||!e.data)return[];for(var t=0;t<e.data.length;t++)for(var a=e.data[t],r=0;r<a.datapoints.length;r++)a.datapoints[r][1]*=1e3;return e},this.parseTags=function(e){var t=[];return 1===(t=e.split(",")).length&&""===(t=e.split(" "))[0]&&(t=[]),t},this.annotationQuery=function(e){var t=this;if(e.annotation.target){var a=r.replace(e.annotation.target,{},"glob"),n={rangeRaw:e.rangeRaw,targets:[{target:a}],format:"json",maxDataPoints:100};return this.query(n).then(function(t){for(var a=[],r=0;r<t.data.length;r++)for(var n=t.data[r],i=0;i<n.datapoints.length;i++){var s=n.datapoints[i];s[0]&&a.push({annotation:e.annotation,time:s[1],title:n.target})}return a})}var i=r.replace(e.annotation.tags);return this.events({range:e.rangeRaw,tags:i}).then(function(a){for(var r=[],n=0;n<a.data.length;n++){var i=a.data[n],s=i.tags;D.a.isString(i.tags)&&(s=t.parseTags(i.tags)),r.push({annotation:e.annotation,time:1e3*i.when,title:i.what,tags:s,text:i.data})}return r})},this.events=function(e){try{var a="";return e.tags&&(a="&tags="+e.tags),this.doGraphiteRequest({method:"GET",url:"/events/get_data?from="+this.translateTime(e.range.from,!1)+"&until="+this.translateTime(e.range.to,!0)+a})}catch(e){return t.reject(e)}},this.targetContainsTemplate=function(e){return r.variableExists(e.target)},this.translateTime=function(e,t){if(D.a.isString(e)){if("now"===e)return"now";if(e.indexOf("now-")>=0&&-1===e.indexOf("/"))return e=(e=(e=e.substring(3)).replace("m","min")).replace("M","mon");e=Le.parse(e,t)}return t?e.get("s")&&e.add(1,"m"):!1===t&&e.get("s")&&e.subtract(1,"m"),e.unix()},this.metricFindQuery=function(e,t){var a=t||{},n=r.replace(e),i=n.match(/^tag_values\(([^,]+)((, *[^,]+)*)\)$/);if(i){for(var s=[],o=/, *([^,]+)/g,l=void 0;null!==(l=o.exec(i[2]));)s.push(l[1]);return a.limit=1e4,this.getTagValuesAutoComplete(s,i[1],void 0,a)}if(i=n.match(/^tags\(([^,]*)((, *[^,]+)*)\)$/)){s=[];if(i[1]){s.push(i[1]);for(o=/, *([^,]+)/g,l=void 0;null!==(l=o.exec(i[2]));)s.push(l[1])}return a.limit=1e4,this.getTagsAutoComplete(s,void 0,a)}var u={method:"GET",url:"/metrics/find",params:{query:n},requestId:a.requestId};return a.range&&(u.params.from=this.translateTime(a.range.from,!1),u.params.until=this.translateTime(a.range.to,!0)),this.doGraphiteRequest(u).then(function(e){return D.a.map(e.data,function(e){return{text:e.text,expandable:!!e.expandable}})})},this.getTags=function(e){var t=e||{},a={method:"GET",url:"/tags",requestId:t.requestId};return t.range&&(a.params.from=this.translateTime(t.range.from,!1),a.params.until=this.translateTime(t.range.to,!0)),this.doGraphiteRequest(a).then(function(e){return D.a.map(e.data,function(e){return{text:e.tag,id:e.id}})})},this.getTagValues=function(e,t){var a=t||{},n={method:"GET",url:"/tags/"+r.replace(e),requestId:a.requestId};return a.range&&(n.params.from=this.translateTime(a.range.from,!1),n.params.until=this.translateTime(a.range.to,!0)),this.doGraphiteRequest(n).then(function(e){return e.data&&e.data.values?D.a.map(e.data.values,function(e){return{text:e.value,id:e.id}}):[]})},this.getTagsAutoComplete=function(e,t,a){var i=a||{},s={method:"GET",url:"/tags/autoComplete/tags",params:{expr:D.a.map(e,function(e){return r.replace((e||"").trim())})},requestId:i.requestId};return t&&(s.params.tagPrefix=t),i.limit&&(s.params.limit=i.limit),i.range&&(s.params.from=n.translateTime(i.range.from,!1),s.params.until=n.translateTime(i.range.to,!0)),n.doGraphiteRequest(s).then(function(e){return e.data?D.a.map(e.data,function(e){return{text:e}}):[]})},this.getTagValuesAutoComplete=function(e,t,a,i){var s=i||{},o={method:"GET",url:"/tags/autoComplete/values",params:{expr:D.a.map(e,function(e){return r.replace((e||"").trim())}),tag:r.replace((t||"").trim())},requestId:s.requestId};return a&&(o.params.valuePrefix=a),s.limit&&(o.params.limit=s.limit),s.range&&(o.params.from=n.translateTime(s.range.from,!1),o.params.until=n.translateTime(s.range.to,!0)),n.doGraphiteRequest(o).then(function(e){return e.data?D.a.map(e.data,function(e){return{text:e}}):[]})},this.getVersion=function(e){var t={method:"GET",url:"/version",requestId:(e||{}).requestId};return this.doGraphiteRequest(t).then(function(e){return e.data&&new It(e.data).isValid()?e.data:""}).catch(function(){return""})},this.createFuncInstance=function(e,t){return Lt.createFuncInstance(e,t,this.funcDefs)},this.getFuncDef=function(e){return Lt.getFuncDef(e,this.funcDefs)},this.waitForFuncDefsLoaded=function(){return this.getFuncDefs()},this.getFuncDefs=function(){var e=this;if(null!==this.funcDefsPromise)return this.funcDefsPromise;if(!function(e){return Ot(e,"1.1")}(this.graphiteVersion))return this.funcDefs=Lt.getFuncDefs(this.graphiteVersion),this.funcDefsPromise=Promise.resolve(this.funcDefs),this.funcDefsPromise;return this.funcDefsPromise=this.doGraphiteRequest({method:"GET",url:"/functions"}).then(function(t){return 200!==t.status||"object"!=typeof t.data?e.funcDefs=Lt.getFuncDefs(e.graphiteVersion):e.funcDefs=Lt.parseFuncDefs(t.data),e.funcDefs}).catch(function(t){return console.log("Fetching graphite functions error",t),e.funcDefs=Lt.getFuncDefs(e.graphiteVersion),e.funcDefs}),this.funcDefsPromise},this.testDatasource=function(){return this.query({panelId:3,rangeRaw:{from:"now-1h",to:"now"},targets:[{target:"constantLine(100)"}],maxDataPoints:300}).then(function(){return{status:"success",message:"Data source is working"}})},this.doGraphiteRequest=function(e){return(this.basicAuth||this.withCredentials)&&(e.withCredentials=!0),this.basicAuth&&(e.headers=e.headers||{},e.headers.Authorization=this.basicAuth),e.url=this.url+e.url,e.inspect={type:"graphite"},a.datasourceRequest(e)},this._seriesRefLetters="ABCDEFGHIJKLMNOPQRSTUVWXYZ",this.buildGraphiteParams=function(e,t){var a,n,i,s=["from","until","rawData","format","maxDataPoints","cacheTimeout"],o=[],l={},u=/\#([A-Z])/g,c=/'(\d+)m'/gi,d=!1;function p(e){return e.replace("m","min").replace("M","mon")}for(e.format="json",i=0;i<e.targets.length;i++)(a=e.targets[i]).target&&(a.refId||(a.refId=this._seriesRefLetters[i]),n=(n=r.replace(a.target,t)).replace(c,p),l[a.refId]=n);function h(e,t){return l[t]||e}for(i=0;i<e.targets.length;i++)(a=e.targets[i]).target&&(n=(n=l[a.refId]).replace(u,h),l[a.refId]=n,a.hide||(d=!0,o.push("target="+encodeURIComponent(n))));return D.a.each(e,function(e,t){-1!==D.a.indexOf(s,t)&&e&&o.push(t+"="+encodeURIComponent(e))}),d?o:[]}}var Qt=a(1082),zt=a.n(Qt),Ht=a(76),Yt=a.n(Ht);function Wt(e){return{link:function(t,a){var r,n=t.ctrl,i=j()('<input type="text" class="gf-form-input" spellcheck="false" style="display:none"></input>'),s=j()('<a class="gf-form-label query-part dropdown-toggle" tabindex="1" gf-dropdown="functionMenu" data-toggle="dropdown"><i class="fa fa-plus"></i></a>');i.appendTo(a),s.appendTo(a),n.datasource.getFuncDefs().then(function(r){var o=D.a.map(r,"name").sort();t.functionMenu=function(e){var t={};return D.a.forEach(e,function(e){e.category&&(t[e.category]||(t[e.category]=[]),t[e.category].push({text:e.name,click:"ctrl.addFunction('"+e.name+"')"}))}),D.a.sortBy(D.a.map(t,function(e,t){return{text:t,submenu:D.a.sortBy(e,"text")}}),"text")}(r),i.attr("data-provide","typeahead"),i.typeahead({source:o,minLength:1,items:10,updater:function(e){var a=n.datasource.getFuncDef(e);return a||(e=e.toLowerCase(),a=D.a.find(o,function(t){return 0===t.toLowerCase().indexOf(e)}))?(t.$apply(function(){n.addFunction(a)}),i.trigger("blur"),""):""}}),s.click(function(){s.hide(),i.show(),i.focus()}),i.keyup(function(){a.toggleClass("open",""===i.val())}),i.blur(function(){setTimeout(function(){i.val(""),i.hide(),s.show(),a.removeClass("open")},200)}),e(a.contents())(t)});var o=function(){r&&(r.destroy(),r=null)};j()(a).on("mouseenter","ul.dropdown-menu li",function(){var e;o();try{e=n.datasource.getFuncDef(j()("a",this).text())}catch(e){}if(e&&e.description){var t=e.description;t.length>500&&(t=t.substring(0,497)+"...");var a=document.createElement("div");a.innerHTML="<h4>"+e.name+"</h4>"+zt()(t),r=new Yt.a({target:this,content:a,classes:"drop-popover",openOn:"always",tetherOptions:{attachment:"bottom left",targetAttachment:"bottom right"}})}}).on("mouseout","ul.dropdown-menu li",function(){o()}),t.$on("$destroy",o)}}}function Gt(e,t,a){var r='<input type="text" style="display:none" class="input-small tight-form-func-param"></input>';return{restrict:"A",link:function(n,i){var s=j()('<a ng-click="">{{func.def.name}}</a><span>(</span>'),o=j()('\n    <div class="tight-form-func-controls">\n      <span class="pointer fa fa-arrow-left"></span>\n      <span class="pointer fa fa-question-circle"></span>\n      <span class="pointer fa fa-remove" ></span>\n      <span class="pointer fa fa-arrow-right"></span>\n    </div>'),l=n.ctrl,u=n.func,c=!1,d=0,p=null;function h(e){var t=j()(this),a=t.prev(".comma"),r=t.next();r.val(u.params[e]),a.removeClass("query-part__last"),t.hide(),r.show(),r.focus(),r.select();var n=r.data("typeahead");n&&(r.val(""),n.lookup())}function m(e){return e<u.def.params.length?u.def.params[e]:D.a.last(u.def.params).multiple?D.a.assign({},D.a.last(u.def.params),{optional:!0}):{}}function f(e,a){var r=j()(e);clearTimeout(p),p=null;var i=r.prev(),s=i.prev(".comma"),o=r.val();(""!==o||m(a).optional)&&(u.updateParam(o,a),i.html(o?t.highlightVariablesAsHtml(o):"&nbsp;")),d!==u.params.length&&(c||(c=!0,setTimeout(function(){x(),c=!1},200))),n.$apply(function(){l.targetChanged()}),i.hasClass("query-part__last")&&""===o?s.addClass("query-part__last"):i.removeClass("query-part__last"),r.hide(),i.show()}function g(e){var t=this;p=setTimeout(function(){f(t,e)},200)}function v(e,t){13===t.which&&j()(this).blur()}function y(){this.style.width=8*(3+this.value.length)+"px"}function b(){var e=i.closest(".tight-form");if(i.hasClass("show-function-controls"))return i.removeClass("show-function-controls"),e.removeClass("has-open-function"),void o.hide();i.addClass("show-function-controls"),e.addClass("has-open-function"),o.show()}function S(){o.appendTo(i),s.appendTo(i);for(var a=D.a.clone(u.def.params),l=D.a.last(u.def.params);u.params.length>=a.length&&l&&l.multiple;)a.push(D.a.assign({},l,{optional:!0}));D.a.each(a,function(e,a){if(e.optional&&u.params.length<a)return!1;var n=t.highlightVariablesAsHtml(u.params[a]),s=a>=u.params.length-1&&e.optional&&!n;s&&e.multiple&&(n="+"),a>0&&j()('<span class="comma'+(s?" query-part__last":"")+'">, </span>').appendTo(i);var o=j()('<a ng-click="" class="graphite-func-param-link'+(s?" query-part__last":"")+'">'+(n||"&nbsp;")+"</a>"),l=j()(r);return l.attr("placeholder",e.name),d++,o.appendTo(i),l.appendTo(i),l.blur(D.a.partial(g,a)),l.keyup(y),l.keypress(D.a.partial(v,a)),o.click(D.a.partial(h,a)),e.options&&function(e,t){e.attr("data-provide","typeahead");var a=m(t).options;"int"===m(t).type&&(a=D.a.map(a,function(e){return e.toString()})),e.typeahead({source:a,minLength:0,items:20,updater:function(a){return e.val(a),f(e[0],t),a}}),e.data("typeahead").lookup=function(){return this.query=this.$element.val()||"",this.process(this.source)}}(l,a),!0}),j()("<span>)</span>").appendTo(i),e(i.contents())(n)}function x(){i.children().remove(),S(),n.func.added&&(n.func.added=!1,setTimeout(function(){i.find(".graphite-func-param-link").first().click()},10)),s.click(b),o.click(function(e){var t=j()(e.target);if(t.hasClass("fa-remove"))return b(),void n.$apply(function(){l.removeFunction(n.func)});if(t.hasClass("fa-arrow-left"))n.$apply(function(){D.a.move(l.queryModel.functions,n.$index,n.$index-1),l.targetChanged()});else if(t.hasClass("fa-arrow-right"))n.$apply(function(){D.a.move(l.queryModel.functions,n.$index,n.$index+1),l.targetChanged()});else if(t.hasClass("fa-question-circle")){var r=l.datasource.getFuncDef(u.def.name);r&&r.description?a.show({element:e.target,position:"bottom left",classNames:"drop-popover drop-function-def",template:'\n                  <div style="overflow:auto;max-height:30rem;">\n                    <h4> '+r.name+" </h4>\n                    "+zt()(r.description)+"\n                  </div>",openOn:"click"}):window.open("http://graphite.readthedocs.org/en/latest/functions.html#graphite.render.functions."+u.def.name,"_blank")}})}x()}}}P.a.module("grafana.directives").directive("graphiteAddFunc",Wt),P.a.module("grafana.directives").directive("graphiteFuncEditor",Gt);for(var Kt=[170,170,181,181,186,186,192,214,216,246,248,705,710,721,736,740,748,748,750,750,880,884,886,887,890,893,902,902,904,906,908,908,910,929,931,1013,1015,1153,1162,1319,1329,1366,1369,1369,1377,1415,1488,1514,1520,1522,1568,1610,1646,1647,1649,1747,1749,1749,1765,1766,1774,1775,1786,1788,1791,1791,1808,1808,1810,1839,1869,1957,1969,1969,1994,2026,2036,2037,2042,2042,2048,2069,2074,2074,2084,2084,2088,2088,2112,2136,2308,2361,2365,2365,2384,2384,2392,2401,2417,2423,2425,2431,2437,2444,2447,2448,2451,2472,2474,2480,2482,2482,2486,2489,2493,2493,2510,2510,2524,2525,2527,2529,2544,2545,2565,2570,2575,2576,2579,2600,2602,2608,2610,2611,2613,2614,2616,2617,2649,2652,2654,2654,2674,2676,2693,2701,2703,2705,2707,2728,2730,2736,2738,2739,2741,2745,2749,2749,2768,2768,2784,2785,2821,2828,2831,2832,2835,2856,2858,2864,2866,2867,2869,2873,2877,2877,2908,2909,2911,2913,2929,2929,2947,2947,2949,2954,2958,2960,2962,2965,2969,2970,2972,2972,2974,2975,2979,2980,2984,2986,2990,3001,3024,3024,3077,3084,3086,3088,3090,3112,3114,3123,3125,3129,3133,3133,3160,3161,3168,3169,3205,3212,3214,3216,3218,3240,3242,3251,3253,3257,3261,3261,3294,3294,3296,3297,3313,3314,3333,3340,3342,3344,3346,3386,3389,3389,3406,3406,3424,3425,3450,3455,3461,3478,3482,3505,3507,3515,3517,3517,3520,3526,3585,3632,3634,3635,3648,3654,3713,3714,3716,3716,3719,3720,3722,3722,3725,3725,3732,3735,3737,3743,3745,3747,3749,3749,3751,3751,3754,3755,3757,3760,3762,3763,3773,3773,3776,3780,3782,3782,3804,3805,3840,3840,3904,3911,3913,3948,3976,3980,4096,4138,4159,4159,4176,4181,4186,4189,4193,4193,4197,4198,4206,4208,4213,4225,4238,4238,4256,4293,4304,4346,4348,4348,4352,4680,4682,4685,4688,4694,4696,4696,4698,4701,4704,4744,4746,4749,4752,4784,4786,4789,4792,4798,4800,4800,4802,4805,4808,4822,4824,4880,4882,4885,4888,4954,4992,5007,5024,5108,5121,5740,5743,5759,5761,5786,5792,5866,5870,5872,5888,5900,5902,5905,5920,5937,5952,5969,5984,5996,5998,6e3,6016,6067,6103,6103,6108,6108,6176,6263,6272,6312,6314,6314,6320,6389,6400,6428,6480,6509,6512,6516,6528,6571,6593,6599,6656,6678,6688,6740,6823,6823,6917,6963,6981,6987,7043,7072,7086,7087,7104,7141,7168,7203,7245,7247,7258,7293,7401,7404,7406,7409,7424,7615,7680,7957,7960,7965,7968,8005,8008,8013,8016,8023,8025,8025,8027,8027,8029,8029,8031,8061,8064,8116,8118,8124,8126,8126,8130,8132,8134,8140,8144,8147,8150,8155,8160,8172,8178,8180,8182,8188,8305,8305,8319,8319,8336,8348,8450,8450,8455,8455,8458,8467,8469,8469,8473,8477,8484,8484,8486,8486,8488,8488,8490,8493,8495,8505,8508,8511,8517,8521,8526,8526,8544,8584,11264,11310,11312,11358,11360,11492,11499,11502,11520,11557,11568,11621,11631,11631,11648,11670,11680,11686,11688,11694,11696,11702,11704,11710,11712,11718,11720,11726,11728,11734,11736,11742,11823,11823,12293,12295,12321,12329,12337,12341,12344,12348,12353,12438,12445,12447,12449,12538,12540,12543,12549,12589,12593,12686,12704,12730,12784,12799,13312,13312,19893,19893,19968,19968,40907,40907,40960,42124,42192,42237,42240,42508,42512,42527,42538,42539,42560,42606,42623,42647,42656,42735,42775,42783,42786,42888,42891,42894,42896,42897,42912,42921,43002,43009,43011,43013,43015,43018,43020,43042,43072,43123,43138,43187,43250,43255,43259,43259,43274,43301,43312,43334,43360,43388,43396,43442,43471,43471,43520,43560,43584,43586,43588,43595,43616,43638,43642,43642,43648,43695,43697,43697,43701,43702,43705,43709,43712,43712,43714,43714,43739,43741,43777,43782,43785,43790,43793,43798,43808,43814,43816,43822,43968,44002,44032,44032,55203,55203,55216,55238,55243,55291,63744,64045,64048,64109,64112,64217,64256,64262,64275,64279,64285,64285,64287,64296,64298,64310,64312,64316,64318,64318,64320,64321,64323,64324,64326,64433,64467,64829,64848,64911,64914,64967,65008,65019,65136,65140,65142,65276,65313,65338,65345,65370,65382,65470,65474,65479,65482,65487,65490,65495,65498,65500,65536,65547,65549,65574,65576,65594,65596,65597,65599,65613,65616,65629,65664,65786,65856,65908,66176,66204,66208,66256,66304,66334,66352,66378,66432,66461,66464,66499,66504,66511,66513,66517,66560,66717,67584,67589,67592,67592,67594,67637,67639,67640,67644,67644,67647,67669,67840,67861,67872,67897,68096,68096,68112,68115,68117,68119,68121,68147,68192,68220,68352,68405,68416,68437,68448,68466,68608,68680,69635,69687,69763,69807,73728,74606,74752,74850,77824,78894,92160,92728,110592,110593,119808,119892,119894,119964,119966,119967,119970,119970,119973,119974,119977,119980,119982,119993,119995,119995,119997,120003,120005,120069,120071,120074,120077,120084,120086,120092,120094,120121,120123,120126,120128,120132,120134,120134,120138,120144,120146,120485,120488,120512,120514,120538,120540,120570,120572,120596,120598,120628,120630,120654,120656,120686,120688,120712,120714,120744,120746,120770,120772,120779,131072,131072,173782,173782,173824,173824,177972,177972,177984,177984,178205,178205,194560,195101],Jt=[],Xt=0;Xt<128;Xt++)Jt[Xt]=Xt>=48&&Xt<=57||36===Xt||126===Xt||124===Xt||Xt>=65&&Xt<=90||95===Xt||45===Xt||42===Xt||58===Xt||91===Xt||93===Xt||63===Xt||37===Xt||35===Xt||61===Xt||Xt>=97&&Xt<=122;var Zt=Jt;function ea(e){this.input=e,this.char=1,this.from=1}function ta(e){this.expression=e,this.lexer=new ea(e),this.tokens=this.lexer.tokenize(),this.index=0}ea.prototype={peek:function(e){return this.input.charAt(e||0)},skip:function(e){e=e||1,this.char+=e,this.input=this.input.slice(e)},tokenize:function(){for(var e,t=[];e=this.next();)t.push(e);return t},next:function(){if(this.from=this.char,/\s/.test(this.peek())){for(;/\s/.test(this.peek());)this.from+=1,this.skip();if(""===this.peek())return null}var e=this.scanStringLiteral();return e||((e=this.scanPunctuator()||this.scanNumericLiteral()||this.scanIdentifier()||this.scanTemplateSequence())?(this.skip(e.value.length),e):null)},scanTemplateSequence:function(){return"["===this.peek()&&"["===this.peek(1)?{type:"templateStart",value:"[[",pos:this.char}:"]"===this.peek()&&"]"===this.peek(1)?{type:"templateEnd",value:"[[",pos:this.char}:null},scanIdentifier:function(){var e,t,a="",r=0;function n(e){for(var t=0;t<Kt.length;){if(e<Kt[t++])return!1;if(e<=Kt[t++])return!0}return!1}function i(e){return/^[0-9a-fA-F]$/.test(e)}var s=D.a.bind(function(){if(r+=1,"u"!==this.peek(r))return null;var e=this.peek(r+1),t=this.peek(r+2),a=this.peek(r+3),s=this.peek(r+4);return i(e)&&i(t)&&i(a)&&i(s)&&n(parseInt(e+t+a+s,16))?(r+=5,"\\u"+e+t+a+s):null},this),o=D.a.bind(function(){var e=this.peek(r),t=e.charCodeAt(0);return"*"===e?(r+=1,e):92===t?s():t<128?Jt[t]?(r+=1,e):null:n(t)?(r+=1,e):null},this),l=D.a.bind(function(){var e=this.peek(r),t=e.charCodeAt(0);return 92===t?s():t<128?Zt[t]?(r+=1,e):null:n(t)?(r+=1,e):null},this);if(null===(t=o()))return null;for(a=t;null!==(t=l());)a+=t;switch(a){case"true":case"false":e="bool";break;default:e="identifier"}return{type:e,value:a,pos:this.char}},scanNumericLiteral:function(){var e,t=0,a="",r=this.input.length,n=this.peek(t);function i(e){return/^[0-9]$/.test(e)}function s(e){return/^[0-7]$/.test(e)}function o(e){return/^[0-9a-fA-F]$/.test(e)}function l(e){return"$"===e||"_"===e||"\\"===e||e>="a"&&e<="z"||e>="A"&&e<="Z"}if("-"===n&&(a+=n,t+=1,n=this.peek(t)),"."!==n&&!i(n))return null;if("."!==n){if(a+=this.peek(t),t+=1,n=this.peek(t),"0"===a){if("x"===n||"X"===n){for(t+=1,a+=n;t<r&&o(n=this.peek(t));)a+=n,t+=1;return a.length<=2?{type:"number",value:a,isMalformed:!0,pos:this.char}:t<r&&l(n=this.peek(t))?null:{type:"number",value:a,base:16,isMalformed:!1,pos:this.char}}if(s(n)){for(t+=1,a+=n,e=!1;t<r;){if(i(n=this.peek(t))&&(e=!0),!s(n)){if(!this.isPunctuator(n))return null;break}a+=n,t+=1}return t<r&&l(n=this.peek(t))?null:{type:"number",value:a,base:8,isMalformed:e}}i(n)&&(t+=1,a+=n)}for(;t<r&&i(n=this.peek(t));)a+=n,t+=1}if("."===n)for(a+=n,t+=1;t<r&&i(n=this.peek(t));)a+=n,t+=1;if("e"===n||"E"===n){if(a+=n,t+=1,"+"!==(n=this.peek(t))&&"-"!==n||(a+=this.peek(t),t+=1),!i(n=this.peek(t)))return null;for(a+=n,t+=1;t<r&&i(n=this.peek(t));)a+=n,t+=1}return t<r&&(n=this.peek(t),!this.isPunctuator(n))?null:{type:"number",value:a,base:10,pos:this.char,isMalformed:!isFinite(+a)}},isPunctuator:function(e){switch(e){case".":case"(":case")":case",":case"{":case"}":return!0}return!1},scanPunctuator:function(){var e=this.peek();return this.isPunctuator(e)?{type:e,value:e,pos:this.char}:null},scanStringLiteral:function(){var e=this.peek();if('"'!==e&&"'"!==e)return null;var t="";for(this.skip();this.peek()!==e;){if(""===this.peek())return{type:"string",value:t,isUnclosed:!0,quote:e,pos:this.char};t+=this.peek(),this.skip(1)}return this.skip(),{type:"string",value:t,isUnclosed:!1,quote:e,pos:this.char}}},ta.prototype={getAst:function(){return this.start()},start:function(){try{return this.functionCall()||this.metricExpression()}catch(e){return{type:"error",message:e.message,pos:e.pos}}},curlyBraceSegment:function(){if(this.match("identifier","{")||this.match("{")){for(var e="";!this.match("")&&!this.match("}");)e+=this.consumeToken().value;return this.match("}")||this.errorMark("Expected closing '}'"),e+=this.consumeToken().value,this.match("identifier")&&(e+=this.consumeToken().value),{type:"segment",value:e}}return null},metricSegment:function(){var e=this.curlyBraceSegment();if(e)return e;if(this.match("identifier")||this.match("number")){var t=this.consumeToken().value.split(".");return 2===t.length&&(this.tokens.splice(this.index,0,{type:"."}),this.tokens.splice(this.index+1,0,{type:"number",value:t[1]})),{type:"segment",value:t[0]}}this.match("templateStart")||this.errorMark("Expected metric identifier"),this.consumeToken(),this.match("identifier")||this.errorMark("Expected identifier after templateStart");var a={type:"template",value:this.consumeToken().value};return this.match("templateEnd")||this.errorMark("Expected templateEnd"),this.consumeToken(),a},metricExpression:function(){if(!(this.match("templateStart")||this.match("identifier")||this.match("number")||this.match("{")))return null;var e={type:"metric",segments:[]};for(e.segments.push(this.metricSegment());this.match(".");){this.consumeToken();var t=this.metricSegment();t||this.errorMark("Expected metric identifier"),e.segments.push(t)}return e},functionCall:function(){if(!this.match("identifier","("))return null;var e={type:"function",name:this.consumeToken().value};return this.consumeToken(),e.params=this.functionParameters(),this.match(")")||this.errorMark("Expected closing parenthesis"),this.consumeToken(),e},boolExpression:function(){return this.match("bool")?{type:"bool",value:"true"===this.consumeToken().value}:null},functionParameters:function(){if(this.match(")")||this.match(""))return[];var e=this.functionCall()||this.numericLiteral()||this.seriesRefExpression()||this.boolExpression()||this.metricExpression()||this.stringLiteral();return this.match(",")?(this.consumeToken(),[e].concat(this.functionParameters())):[e]},seriesRefExpression:function(){return this.match("identifier")&&this.tokens[this.index].value.match(/\#[A-Z]/)?{type:"series-ref",value:this.consumeToken().value}:null},numericLiteral:function(){return this.match("number")?{type:"number",value:parseFloat(this.consumeToken().value)}:null},stringLiteral:function(){if(!this.match("string"))return null;var e=this.consumeToken();if(e.isUnclosed)throw{message:"Unclosed string parameter",pos:e.pos};return{type:"string",value:e.value}},errorMark:function(e){var t=this.tokens[this.index];throw{message:e+" instead found "+(t?t.type:"end of string"),pos:t?t.pos:this.lexer.char}},consumeToken:function(){return this.index++,this.tokens[this.index-1]},matchToken:function(e,t){var a=this.tokens[this.index+t];return void 0===a&&""===e||a&&a.type===e},match:function(e,t){return this.matchToken(e,0)&&(!t||this.matchToken(t,1))}};var aa=function(){function e(e,t,a,r){this.datasource=e,this.target=t,this.parseTarget(),this.removeTagValue="-- remove tag --"}return e.$inject=["datasource","target","templateSrv","scopedVars"],e.prototype.parseTarget=function(){if(this.functions=[],this.segments=[],this.tags=[],this.error=null,!this.target.textEditor){var e=new ta(this.target.target).getAst();if(null!==e){if("error"===e.type)return this.error=e.message+" at position: "+e.pos,void(this.target.textEditor=!0);try{this.parseTargetRecursive(e,null)}catch(e){console.log("error parsing target:",e.message),this.error=e.message,this.target.textEditor=!0}this.checkOtherSegmentsIndex=this.segments.length-1,this.checkForSeriesByTag()}else this.checkOtherSegmentsIndex=0}},e.prototype.checkForSeriesByTag=function(){var e=D.a.find(this.functions,function(e){return"seriesByTag"===e.def.name});if(e){this.seriesByTagUsed=!0,e.hidden=!0;var t=this.splitSeriesByTagParams(e);this.tags=t}},e.prototype.getSegmentPathUpTo=function(e){var t=this.segments.slice(0,e);return D.a.reduce(t,function(e,t){return e?e+"."+t.value:t.value},"")},e.prototype.parseTargetRecursive=function(e,t){var a=this;if(null===e)return null;switch(e.type){case"function":var r=this.datasource.createFuncInstance(e.name,{withDefaultParams:!1});D.a.each(e.params,function(e){a.parseTargetRecursive(e,r)}),r.updateText(),this.functions.push(r);break;case"series-ref":this.segments.length>0?this.addFunctionParameter(t,e.value):this.segments.push(e);break;case"bool":case"string":case"number":this.addFunctionParameter(t,e.value);break;case"metric":this.segments.length>0?this.addFunctionParameter(t,D.a.join(D.a.map(e.segments,"value"),".")):this.segments=e.segments}},e.prototype.updateSegmentValue=function(e,t){this.segments[t].value=e.value},e.prototype.addSelectMetricSegment=function(){this.segments.push({value:"select metric"})},e.prototype.addFunction=function(e){this.functions.push(e),this.moveAliasFuncLast()},e.prototype.moveAliasFuncLast=function(){var e=D.a.find(this.functions,function(e){return e.def.name.startsWith("alias")});e&&(this.functions=D.a.without(this.functions,e),this.functions.push(e))},e.prototype.addFunctionParameter=function(e,t){if(e.params.length>=e.def.params.length&&!D.a.get(D.a.last(e.def.params),"multiple",!1))throw{message:"too many parameters for function "+e.def.name};e.params.push(t)},e.prototype.removeFunction=function(e){this.functions=D.a.without(this.functions,e)},e.prototype.updateModelTarget=function(e){if(!this.target.textEditor){var t=this.getSegmentPathUpTo(this.segments.length).replace(/\.select metric$/,"");this.target.target=D.a.reduce(this.functions,ra,t)}this.updateRenderedTarget(this.target,e);for(var a=0,r=e||[];a<r.length;a++){var n=r[a];n.refId!==this.target.refId&&this.updateRenderedTarget(n,e)}},e.prototype.updateRenderedTarget=function(e,t){var a=D.a.keyBy(t,"refId");delete a[e.refId];var r=/\#([A-Z])/g,n=e.target;for(D.a.each(a,function(e,t){!function(e,t){var a=0;D.a.each(e,function(e,n){if(n!==t){var i=r.exec(e.target),s=i&&i.length?i.length-1:0;a+=s}}),e[t].refCount=a}(a,t)});n.match(r);){var i=n.replace(r,function(e,t){var r=a[t];return r?(0===r.refCount&&delete a[t],r.refCount--,r.target):e});if(i===n)break;n=i}delete e.targetFull,e.target!==n&&(e.targetFull=n)},e.prototype.splitSeriesByTagParams=function(e){var t=/([^\!=~]+)(\!?=~?)(.*)/;return D.a.flatten(D.a.map(e.params,function(e){var a=t.exec(e);if(a){var r=a.slice(1);if(3===r.length)return{key:r[0],operator:r[1],value:r[2]}}return[]}))},e.prototype.getSeriesByTagFuncIndex=function(){return D.a.findIndex(this.functions,function(e){return"seriesByTag"===e.def.name})},e.prototype.getSeriesByTagFunc=function(){var e=this.getSeriesByTagFuncIndex();return e>=0?this.functions[e]:void 0},e.prototype.addTag=function(e){var t=na(e);this.getSeriesByTagFunc().params.push(t),this.tags.push(e)},e.prototype.removeTag=function(e){this.getSeriesByTagFunc().params.splice(e,1),this.tags.splice(e,1)},e.prototype.updateTag=function(e,t){if(this.error=null,e.key!==this.removeTagValue){var a=na(e);this.getSeriesByTagFunc().params[t]=a,this.tags[t]=e}else this.removeTag(t)},e.prototype.renderTagExpressions=function(e){return void 0===e&&(e=-1),D.a.compact(D.a.map(this.tags,function(t,a){if(a!==e)return t.key+t.operator+t.value}))},e}();function ra(e,t){return t.render(e)}function na(e){return e.key+e.operator+e.value}var ia=["=","!=","=~","!=~"],sa="tag: ",oa=function(e){function t(t,a,r,n,i){var s=e.call(this,t,a)||this;return s.uiSegmentSrv=r,s.templateSrv=n,s.supportsTags=s.datasource.supportsTags,s.paused=!1,s.target.target=s.target.target||"",s.datasource.waitForFuncDefsLoaded().then(function(){s.queryModel=new aa(s.datasource,s.target,n),s.buildSegments()}),s.removeTagValue="-- remove tag --",s}return t.$inject=["$scope","$injector","uiSegmentSrv","templateSrv","$timeout"],je.d(t,e),t.prototype.parseTarget=function(){this.queryModel.parseTarget(),this.buildSegments()},t.prototype.toggleEditorMode=function(){this.target.textEditor=!this.target.textEditor,this.parseTarget()},t.prototype.buildSegments=function(){var e=this;this.segments=D.a.map(this.queryModel.segments,function(t){return e.uiSegmentSrv.newSegment(t)});var t=this.queryModel.checkOtherSegmentsIndex||0;this.checkOtherSegments(t),this.queryModel.seriesByTagUsed&&this.fixTagSegments()},t.prototype.addSelectMetricSegment=function(){this.queryModel.addSelectMetricSegment(),this.segments.push(this.uiSegmentSrv.newSelectMetric())},t.prototype.checkOtherSegments=function(e){var t=this;if(1!==this.queryModel.segments.length||"series-ref"!==this.queryModel.segments[0].type){if(0!==e){var a=this.queryModel.getSegmentPathUpTo(e+1);return""===a?Promise.resolve():this.datasource.metricFindQuery(a).then(function(r){if(0===r.length)""!==a&&(t.queryModel.segments=t.queryModel.segments.splice(0,e),t.segments=t.segments.splice(0,e),t.addSelectMetricSegment());else if(r[0].expandable){if(t.segments.length!==e)return t.checkOtherSegments(e+1);t.addSelectMetricSegment()}}).catch(function(e){oe.a.emit("alert-error",["Error",e])})}this.addSelectMetricSegment()}},t.prototype.setSegmentFocus=function(e){D.a.each(this.segments,function(t,a){t.focus=e===a})},t.prototype.getAltSegments=function(e,t){var a=this,r=t&&t.length>0?"*"+t+"*":"*";e>0&&(r=this.queryModel.getSegmentPathUpTo(e)+"."+r);var n={range:this.panelCtrl.range,requestId:"get-alt-segments"};return this.datasource.metricFindQuery(r,n).then(function(r){var n=D.a.map(r,function(e){return a.uiSegmentSrv.newSegment({value:e.text,expandable:e.expandable})});return e>0&&0===n.length?n:(0===e&&D.a.eachRight(a.panelCtrl.panel.targets,function(e){e.refId!==a.queryModel.target.refId&&n.unshift(a.uiSegmentSrv.newSegment({type:"series-ref",value:"#"+e.refId,expandable:!1}))}),D.a.eachRight(a.templateSrv.variables,function(e){n.unshift(a.uiSegmentSrv.newSegment({type:"template",value:"$"+e.name,expandable:!0}))}),n.unshift(a.uiSegmentSrv.newSegment("*")),a.supportsTags&&0===e?(a.removeTaggedEntry(n),a.addAltTagSegments(t,n)):n)}).catch(function(e){return[]})},t.prototype.addAltTagSegments=function(e,t){return this.getTagsAsSegments(e).then(function(e){return e=D.a.map(e,function(e){return e.value=sa+e.value,e}),t.concat.apply(t,e)})},t.prototype.removeTaggedEntry=function(e){e=D.a.remove(e,function(e){return"_tagged"===e.value})},t.prototype.segmentValueChanged=function(e,t){var a=this;if(this.error=null,this.queryModel.updateSegmentValue(e,t),this.queryModel.functions.length>0&&this.queryModel.functions[0].def.fake&&(this.queryModel.functions=[]),"tag"===e.type){var r=function(e){return e.replace(sa,"")}(e.value);return this.pause(),void this.addSeriesByTagFunc(r)}if(e.expandable)return this.checkOtherSegments(t+1).then(function(){a.setSegmentFocus(t+1),a.targetChanged()});this.spliceSegments(t+1),this.setSegmentFocus(t+1),this.targetChanged()},t.prototype.spliceSegments=function(e){this.segments=this.segments.splice(0,e),this.queryModel.segments=this.queryModel.segments.splice(0,e)},t.prototype.emptySegments=function(){this.queryModel.segments=[],this.segments=[]},t.prototype.targetTextChanged=function(){this.updateModelTarget(),this.refresh()},t.prototype.updateModelTarget=function(){this.queryModel.updateModelTarget(this.panelCtrl.panel.targets)},t.prototype.targetChanged=function(){if(!this.queryModel.error){var e=this.queryModel.target.target;this.updateModelTarget(),this.queryModel.target===e||this.paused||this.panelCtrl.refresh()}},t.prototype.addFunction=function(e){var t=this.datasource.createFuncInstance(e,{withDefaultParams:!0});t.added=!0,this.queryModel.addFunction(t),this.smartlyHandleNewAliasByNode(t),1===this.segments.length&&this.segments[0].fake&&this.emptySegments(),!t.params.length&&t.added&&this.targetChanged(),"seriesByTag"===t.def.name&&this.parseTarget()},t.prototype.removeFunction=function(e){this.queryModel.removeFunction(e),this.targetChanged()},t.prototype.addSeriesByTagFunc=function(e){var t=this.datasource.createFuncInstance("seriesByTag",{withDefaultParams:!1}),a=e+"=";t.params=[a],this.queryModel.addFunction(t),t.added=!0,this.emptySegments(),this.targetChanged(),this.parseTarget()},t.prototype.smartlyHandleNewAliasByNode=function(e){if("aliasByNode"===e.def.name)for(var t=0;t<this.segments.length;t++)if(this.segments[t].value.indexOf("*")>=0)return e.params[0]=t,e.added=!1,void this.targetChanged()},t.prototype.getAllTags=function(){var e=this;return this.datasource.getTags().then(function(t){var a=D.a.map(t,"text");return a.splice(0,0,e.removeTagValue),la(a)})},t.prototype.getTags=function(e,t){var a=this,r=this.queryModel.renderTagExpressions(e);return this.datasource.getTagsAutoComplete(r,t).then(function(e){var t=D.a.map(e,"text");return t.splice(0,0,a.removeTagValue),la(t)})},t.prototype.getTagsAsSegments=function(e){var t=this,a=this.queryModel.renderTagExpressions();return this.datasource.getTagsAutoComplete(a,e).then(function(e){return D.a.map(e,function(e){return t.uiSegmentSrv.newSegment({value:e.text,type:"tag",expandable:!1})})})},t.prototype.getTagOperators=function(){return la(ia)},t.prototype.getAllTagValues=function(e){var t=e.key;return this.datasource.getTagValues(t).then(function(e){return la(D.a.map(e,"text"))})},t.prototype.getTagValues=function(e,t,a){var r=this,n=this.queryModel.renderTagExpressions(t),i=e.key;return this.datasource.getTagValuesAutoComplete(n,i,a).then(function(e){var t=D.a.map(e,"text");return D.a.eachRight(r.templateSrv.variables,function(e){t.push("${"+e.name+":regex}")}),la(t)})},t.prototype.tagChanged=function(e,t){this.queryModel.updateTag(e,t),this.targetChanged()},t.prototype.addNewTag=function(e){var t={key:e.value,operator:"=",value:""};this.queryModel.addTag(t),this.targetChanged(),this.fixTagSegments()},t.prototype.removeTag=function(e){this.queryModel.removeTag(e),this.targetChanged()},t.prototype.fixTagSegments=function(){this.addTagSegments=[this.uiSegmentSrv.newPlusButton()]},t.prototype.showDelimiter=function(e){return e!==this.queryModel.tags.length-1},t.prototype.pause=function(){this.paused=!0},t.prototype.unpause=function(){this.paused=!1,this.panelCtrl.refresh()},t.templateUrl="partials/query.editor.html",t}(Ye);function la(e){return D.a.map(e,function(e){return{text:e,value:e}})}var ua=function(){function e(e,t){this.graphiteVersions=[{name:"0.9.x",value:"0.9"},{name:"1.0.x",value:"1.0"},{name:"1.1.x",value:"1.1"}],this.datasourceSrv=t,this.current.jsonData=this.current.jsonData||{},this.current.jsonData.graphiteVersion=this.current.jsonData.graphiteVersion||"0.9",this.autoDetectGraphiteVersion()}return e.$inject=["$scope","datasourceSrv"],e.prototype.autoDetectGraphiteVersion=function(){var e=this;this.current.id&&this.datasourceSrv.loadDatasource(this.current.name).then(function(e){return e.getVersion()}).then(function(t){e.graphiteVersions.push({name:t,value:t}),e.current.jsonData.graphiteVersion=t})},e.templateUrl="public/app/plugins/datasource/graphite/partials/config.html",e}(),ca=function(){function e(){}return e.templateUrl="partials/annotations.editor.html",e}(),da=function(){return function(){return{templateUrl:"public/app/plugins/datasource/cloudwatch/partials/query.parameter.html",controller:"CloudWatchQueryParameterCtrl",restrict:"E",scope:{target:"=",datasource:"=",onChange:"&"}}}}(),pa=function(){function e(e,t,a,r,n){e.init=function(){var t=e.target;t.namespace=t.namespace||"",t.metricName=t.metricName||"",t.statistics=t.statistics||["Average"],t.dimensions=t.dimensions||{},t.period=t.period||"",t.region=t.region||"default",t.id=t.id||"",t.expression=t.expression||"",t.returnData=t.returnData||!1,t.highResolution=t.highResolution||!1,e.regionSegment=a.getSegmentForValue(e.target.region,"select region"),e.namespaceSegment=a.getSegmentForValue(e.target.namespace,"select namespace"),e.metricSegment=a.getSegmentForValue(e.target.metricName,"select metric"),e.dimSegments=D.a.reduce(e.target.dimensions,function(e,t,r){return e.push(a.newKey(r)),e.push(a.newOperator("=")),e.push(a.newKeyValue(t)),e},[]),e.statSegments=D.a.map(e.target.statistics,function(e){return a.getSegmentForValue(e)}),e.ensurePlusButton(e.statSegments),e.ensurePlusButton(e.dimSegments),e.removeDimSegment=a.newSegment({fake:!0,value:"-- remove dimension --"}),e.removeStatSegment=a.newSegment({fake:!0,value:"-- remove stat --"}),D.a.isEmpty(e.target.region)&&(e.target.region="default"),e.onChange||(e.onChange=function(){})},e.getStatSegments=function(){return n.when(D.a.flatten([P.a.copy(e.removeStatSegment),D.a.map(e.datasource.standardStatistics,function(e){return a.getSegmentForValue(e)}),a.getSegmentForValue("pNN.NN")]))},e.statSegmentChanged=function(t,a){t.value===e.removeStatSegment.value?e.statSegments.splice(a,1):t.type="value",e.target.statistics=D.a.reduce(e.statSegments,function(e,t){return t.fake||e.push(t.value),e},[]),e.ensurePlusButton(e.statSegments),e.onChange()},e.ensurePlusButton=function(e){var t=e.length,r=e[Math.max(t-1,0)];r&&"plus-button"===r.type||e.push(a.newPlusButton())},e.getDimSegments=function(t,a){if("operator"===t.type)return n.when([]);var r=e.target,i=n.when([]);if("key"===t.type||"plus-button"===t.type)i=e.datasource.getDimensionKeys(e.target.namespace,e.target.region);else if("value"===t.type){var s=e.dimSegments[a-2].value;i=e.datasource.getDimensionValues(r.region,r.namespace,r.metricName,s,r.dimensions)}return i.then(e.transformToSegments(!0)).then(function(a){return"key"===t.type&&a.splice(0,0,P.a.copy(e.removeDimSegment)),a})},e.dimSegmentChanged=function(t,r){e.dimSegments[r]=t,t.value===e.removeDimSegment.value?e.dimSegments.splice(r,3):"plus-button"===t.type&&(e.dimSegments.push(a.newOperator("=")),e.dimSegments.push(a.newFake("select dimension value","value","query-segment-value")),t.type="key",t.cssClass="query-segment-key"),e.syncDimSegmentsWithModel(),e.ensurePlusButton(e.dimSegments),e.onChange()},e.syncDimSegmentsWithModel=function(){for(var t={},a=e.dimSegments.length,r=0;r<a-2;r+=3){var n=e.dimSegments[r],i=e.dimSegments[r+2];i.fake||(t[n.value]=i.value)}e.target.dimensions=t},e.getRegions=function(){return e.datasource.metricFindQuery("regions()").then(function(e){return e.unshift({text:"default"}),e}).then(e.transformToSegments(!0))},e.getNamespaces=function(){return e.datasource.metricFindQuery("namespaces()").then(e.transformToSegments(!0))},e.getMetrics=function(){return e.datasource.metricFindQuery("metrics("+e.target.namespace+","+e.target.region+")").then(e.transformToSegments(!0))},e.regionChanged=function(){e.target.region=e.regionSegment.value,e.onChange()},e.namespaceChanged=function(){e.target.namespace=e.namespaceSegment.value,e.onChange()},e.metricChanged=function(){e.target.metricName=e.metricSegment.value,e.onChange()},e.transformToSegments=function(e){return function(r){var n=D.a.map(r,function(e){return a.newSegment({value:e.text,expandable:e.expandable})});return e&&D.a.each(t.variables,function(e){n.unshift(a.newSegment({type:"template",value:"$"+e.name,expandable:!0}))}),n}},e.init()}return e.$inject=["$scope","templateSrv","uiSegmentSrv","datasourceSrv","$q"],e}();P.a.module("grafana.controllers").directive("cloudwatchQueryParameter",da),P.a.module("grafana.controllers").controller("CloudWatchQueryParameterCtrl",pa);var ha=function(){function e(e,t,a,r,n){this.$q=t,this.backendSrv=a,this.templateSrv=r,this.timeSrv=n,this.type="cloudwatch",this.name=e.name,this.supportMetrics=!0,this.proxyUrl=e.url,this.defaultRegion=e.jsonData.defaultRegion,this.instanceSettings=e,this.standardStatistics=["Average","Maximum","Minimum","Sum","SampleCount"]}return e.$inject=["instanceSettings","$q","backendSrv","templateSrv","timeSrv"],e.prototype.query=function(e){var t=this;(e=P.a.copy(e)).targets=this.expandTemplateVariable(e.targets,e.scopedVars,this.templateSrv);var a=D.a.filter(e.targets,function(e){return(""!==e.id||!0!==e.hide)&&(!!e.region&&!!e.namespace&&!!e.metricName&&!D.a.isEmpty(e.statistics)||e.expression.length>0)}).map(function(a){if(a.region=t.templateSrv.replace(t.getActualRegion(a.region),e.scopedVars),a.namespace=t.templateSrv.replace(a.namespace,e.scopedVars),a.metricName=t.templateSrv.replace(a.metricName,e.scopedVars),a.dimensions=t.convertDimensionFormat(a.dimensions,e.scopedVars),a.period=String(t.getPeriod(a,e)),a.id=t.templateSrv.replace(a.id,e.scopedVars),a.expression=t.templateSrv.replace(a.expression,e.scopedVars),a.returnData=void 0===a.hide||!a.hide,a.statistics.some(function(e){return 0===e.indexOf("p")&&!/p\d{2}\.\d{2}/.test(e)}))throw{message:"Invalid extended statistics"};return D.a.extend({refId:a.refId,intervalMs:e.intervalMs,maxDataPoints:e.maxDataPoints,datasourceId:t.instanceSettings.id,type:"timeSeriesQuery"},a)});if(D.a.isEmpty(a)){var r=this.$q.defer();return r.resolve({data:[]}),r.promise}var n={from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:a};return this.performTimeSeriesQuery(n)},e.prototype.getPeriod=function(e,t,a){var r,n=this.convertToCloudWatchTime(t.range.from,!1),i=this.convertToCloudWatchTime(t.range.to,!0);a=Math.round((a||Date.now())/1e3);var s=i-n,o=60;return e.period?r=/^\d+$/.test(e.period)?parseInt(e.period,10):A.a.interval_to_seconds(this.templateSrv.replace(e.period,t.scopedVars)):o=r=a-n<=1296e3?"AWS/EC2"===e.namespace?300:60:a-n<=5443200?300:3600,r<1&&(r=1),!e.highResolution&&s/r>=1440&&(r=Math.ceil(s/1440/o)*o),r},e.prototype.performTimeSeriesQuery=function(e){return this.awsRequest("/api/tsdb/query",e).then(function(e){var t=[];return e.results&&D.a.forEach(e.results,function(e){D.a.forEach(e.series,function(e){t.push({target:e.name,datapoints:e.points})})}),{data:t}})},e.prototype.transformSuggestDataFromTable=function(e){return D.a.map(e.results.metricFindQuery.tables[0].rows,function(e){return{text:e[0],value:e[1]}})},e.prototype.doMetricQueryRequest=function(e,t){var a=this,r=this.timeSrv.timeRange();return this.awsRequest("/api/tsdb/query",{from:r.from.valueOf().toString(),to:r.to.valueOf().toString(),queries:[D.a.extend({refId:"metricFindQuery",intervalMs:1,maxDataPoints:1,datasourceId:this.instanceSettings.id,type:"metricFindQuery",subtype:e},t)]}).then(function(e){return a.transformSuggestDataFromTable(e)})},e.prototype.getRegions=function(){return this.doMetricQueryRequest("regions",null)},e.prototype.getNamespaces=function(){return this.doMetricQueryRequest("namespaces",null)},e.prototype.getMetrics=function(e,t){return this.doMetricQueryRequest("metrics",{region:this.templateSrv.replace(this.getActualRegion(t)),namespace:this.templateSrv.replace(e)})},e.prototype.getDimensionKeys=function(e,t){return this.doMetricQueryRequest("dimension_keys",{region:this.templateSrv.replace(this.getActualRegion(t)),namespace:this.templateSrv.replace(e)})},e.prototype.getDimensionValues=function(e,t,a,r,n){return this.doMetricQueryRequest("dimension_values",{region:this.templateSrv.replace(this.getActualRegion(e)),namespace:this.templateSrv.replace(t),metricName:this.templateSrv.replace(a),dimensionKey:this.templateSrv.replace(r),dimensions:this.convertDimensionFormat(n,{})})},e.prototype.getEbsVolumeIds=function(e,t){return this.doMetricQueryRequest("ebs_volume_ids",{region:this.templateSrv.replace(this.getActualRegion(e)),instanceId:this.templateSrv.replace(t)})},e.prototype.getEc2InstanceAttribute=function(e,t,a){return this.doMetricQueryRequest("ec2_instance_attribute",{region:this.templateSrv.replace(this.getActualRegion(e)),attributeName:this.templateSrv.replace(t),filters:a})},e.prototype.metricFindQuery=function(e){var t,a,r,n;if(e.match(/^regions\(\)/))return this.getRegions();if(e.match(/^namespaces\(\)/))return this.getNamespaces();var i=e.match(/^metrics\(([^\)]+?)(,\s?([^,]+?))?\)/);if(i)return a=i[1],t=i[3],this.getMetrics(a,t);var s=e.match(/^dimension_keys\(([^\)]+?)(,\s?([^,]+?))?\)/);if(s)return a=s[1],t=s[3],this.getDimensionKeys(a,t);var o=e.match(/^dimension_values\(([^,]+?),\s?([^,]+?),\s?([^,]+?),\s?([^,]+?)(,\s?(.+))?\)/);if(o){t=o[1],a=o[2],r=o[3];var l=o[4];return n={},o[6]&&(n=JSON.parse(this.templateSrv.replace(o[6]))),this.getDimensionValues(t,a,r,l,n)}var u=e.match(/^ebs_volume_ids\(([^,]+?),\s?([^,]+?)\)/);if(u){t=u[1];var c=u[2];return this.getEbsVolumeIds(t,c)}var d=e.match(/^ec2_instance_attribute\(([^,]+?),\s?([^,]+?),\s?(.+?)\)/);if(d){t=d[1];var p=d[2];return n=JSON.parse(this.templateSrv.replace(d[3])),this.getEc2InstanceAttribute(t,p,n)}return this.$q.when([])},e.prototype.annotationQuery=function(e){var t=this,a=e.annotation,r=D.a.map(a.statistics,function(e){return t.templateSrv.replace(e)}),n=a.prefixMatching?"":"300",i=a.period||n;i=parseInt(i,10);var s={prefixMatching:a.prefixMatching,region:this.templateSrv.replace(this.getActualRegion(a.region)),namespace:this.templateSrv.replace(a.namespace),metricName:this.templateSrv.replace(a.metricName),dimensions:this.convertDimensionFormat(a.dimensions,{}),statistics:r,period:i,actionPrefix:a.actionPrefix||"",alarmNamePrefix:a.alarmNamePrefix||""};return this.awsRequest("/api/tsdb/query",{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:[D.a.extend({refId:"annotationQuery",intervalMs:1,maxDataPoints:1,datasourceId:this.instanceSettings.id,type:"annotationQuery"},s)]}).then(function(e){return D.a.map(e.results.annotationQuery.tables[0].rows,function(e){return{annotation:a,time:Date.parse(e[0]),title:e[1],tags:[e[2]],text:e[3]}})})},e.prototype.targetContainsTemplate=function(e){var t=this;return this.templateSrv.variableExists(e.region)||this.templateSrv.variableExists(e.namespace)||this.templateSrv.variableExists(e.metricName)||D.a.find(e.dimensions,function(e,a){return t.templateSrv.variableExists(a)||t.templateSrv.variableExists(e)})},e.prototype.testDatasource=function(){var e=this.defaultRegion;return this.getDimensionValues(e,"AWS/Billing","EstimatedCharges","ServiceName",{}).then(function(){return{status:"success",message:"Data source is working"}},function(e){return{status:"error",message:e.message}})},e.prototype.awsRequest=function(e,t){var a={method:"POST",url:e,data:t};return this.backendSrv.datasourceRequest(a).then(function(e){return e.data})},e.prototype.getDefaultRegion=function(){return this.defaultRegion},e.prototype.getActualRegion=function(e){return"default"===e||D.a.isEmpty(e)?this.getDefaultRegion():e},e.prototype.getExpandedVariables=function(e,t,a,r){var n=D.a.find(a.options,{selected:!0,text:"All"}),i=D.a.filter(a.options,function(e){return n?"All"!==e.text:e.selected}),s=D.a.isArray(a.current.value)?a.current.value.map(function(e){return{text:e,value:e}}):[a.current];return(i.some(function(e){return e.value===s[0].value})||"$__all"===s[0].value?i:s).map(function(n){var i=P.a.copy(e),s={};return s[a.name]=n,i.refId=e.refId+"_"+n.value,i.dimensions[t]=r.replace(i.dimensions[t],s),a.multi&&e.id?i.id=e.id+window.btoa(n.value).replace(/=/g,"0"):i.id=e.id,i})},e.prototype.expandTemplateVariable=function(e,t,a){var r=this;return D.a.chain(e).map(function(e){var n=D.a.findKey(e.dimensions,function(e){return a.variableExists(e)&&!D.a.has(t,a.getVariableName(e))});if(n){var i=D.a.find(a.variables,function(t){return se(e.dimensions[n],t.name)&&t.multi}),s=D.a.find(a.variables,function(t){return se(e.dimensions[n],t.name)});return r.getExpandedVariables(e,n,i||s,a)}return[e]}).flatten().value()},e.prototype.convertToCloudWatchTime=function(e,t){return D.a.isString(e)&&(e=Le.parse(e,t)),Math.round(e.valueOf()/1e3)},e.prototype.convertDimensionFormat=function(e,t){var a=this,r={};return D.a.each(e,function(e,n){r[a.templateSrv.replace(n,t)]=a.templateSrv.replace(e,t)}),r},e}(),ma=function(e){function t(t,a){var r=e.call(this,t,a)||this;return r.aliasSyntax="{{metric}} {{stat}} {{namespace}} {{region}} {{<dimension name>}}",r}return t.$inject=["$scope","$injector"],je.d(t,e),t.templateUrl="partials/query.editor.html",t}(Ye),fa=function(){function e(e){this.accessKeyExist=!1,this.secretKeyExist=!1,this.authTypes=[{name:"Access & secret key",value:"keys"},{name:"Credentials file",value:"credentials"},{name:"ARN",value:"arn"}],this.indexPatternTypes=[{name:"No pattern",value:void 0},{name:"Hourly",value:"Hourly",example:"[logstash-]YYYY.MM.DD.HH"},{name:"Daily",value:"Daily",example:"[logstash-]YYYY.MM.DD"},{name:"Weekly",value:"Weekly",example:"[logstash-]GGGG.WW"},{name:"Monthly",value:"Monthly",example:"[logstash-]YYYY.MM"},{name:"Yearly",value:"Yearly",example:"[logstash-]YYYY"}],this.current.jsonData.timeField=this.current.jsonData.timeField||"@timestamp",this.current.jsonData.authType=this.current.jsonData.authType||"credentials",this.accessKeyExist=this.current.secureJsonFields.accessKey,this.secretKeyExist=this.current.secureJsonFields.secretKey}return e.$inject=["$scope"],e.prototype.resetAccessKey=function(){this.accessKeyExist=!1},e.prototype.resetSecretKey=function(){this.secretKeyExist=!1},e.templateUrl="partials/config.html",e}(),ga=function(){function e(){}return e.templateUrl="partials/annotations.editor.html",e}(),va=[{text:"Count",value:"count",requiresField:!1},{text:"Average",value:"avg",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0},{text:"Sum",value:"sum",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0},{text:"Max",value:"max",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0},{text:"Min",value:"min",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0},{text:"Extended Stats",value:"extended_stats",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0},{text:"Percentiles",value:"percentiles",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0},{text:"Unique Count",value:"cardinality",requiresField:!0,supportsMissing:!0},{text:"Moving Average",value:"moving_avg",requiresField:!1,isPipelineAgg:!0,minVersion:2},{text:"Derivative",value:"derivative",requiresField:!1,isPipelineAgg:!0,minVersion:2},{text:"Raw Document",value:"raw_document",requiresField:!1}],ya=[{text:"Terms",value:"terms",requiresField:!0},{text:"Filters",value:"filters"},{text:"Geo Hash Grid",value:"geohash_grid",requiresField:!0},{text:"Date Histogram",value:"date_histogram",requiresField:!0},{text:"Histogram",value:"histogram",requiresField:!0}],ba=[{text:"Doc Count",value:"_count"},{text:"Term value",value:"_term"}],Sa=[{text:"Top",value:"desc"},{text:"Bottom",value:"asc"}],xa=[{text:"No limit",value:"0"},{text:"1",value:"1"},{text:"2",value:"2"},{text:"3",value:"3"},{text:"5",value:"5"},{text:"10",value:"10"},{text:"15",value:"15"},{text:"20",value:"20"}],wa=[{text:"Avg",value:"avg"},{text:"Min",value:"min"},{text:"Max",value:"max"},{text:"Sum",value:"sum"},{text:"Count",value:"count"},{text:"Std Dev",value:"std_deviation"},{text:"Std Dev Upper",value:"std_deviation_bounds_upper"},{text:"Std Dev Lower",value:"std_deviation_bounds_lower"}],ka=[{text:"auto",value:"auto"},{text:"10s",value:"10s"},{text:"1m",value:"1m"},{text:"5m",value:"5m"},{text:"10m",value:"10m"},{text:"20m",value:"20m"},{text:"1h",value:"1h"},{text:"1d",value:"1d"}],Ca=[{text:"Simple",value:"simple"},{text:"Linear",value:"linear"},{text:"Exponentially Weighted",value:"ewma"},{text:"Holt Linear",value:"holt"},{text:"Holt Winters",value:"holt_winters"}],Ta={moving_avg:[{text:"window",default:5},{text:"model",default:"simple"},{text:"predict",default:void 0},{text:"minimize",default:!1}],derivative:[{text:"unit",default:void 0}]},_a={simple:[],linear:[],ewma:[{text:"Alpha",value:"alpha",default:void 0}],holt:[{text:"Alpha",value:"alpha",default:void 0},{text:"Beta",value:"beta",default:void 0}],holt_winters:[{text:"Alpha",value:"alpha",default:void 0},{text:"Beta",value:"beta",default:void 0},{text:"Gamma",value:"gamma",default:void 0},{text:"Period",value:"period",default:void 0},{text:"Pad",value:"pad",default:void 0,isCheckbox:!0}]};function Ma(e){return D.a.filter(va,function(t){return!t.minVersion||t.minVersion<=e})}function $a(e){if(e){var t=Ta[e];return null!==t&&void 0!==t}return!1}function Pa(e,t){var a=[];return t?(D.a.each(_a[e],function(e){e.isCheckbox||a.push(e)}),a):_a[e]}function Ea(e){return D.a.find(va,{value:e.type}).text+" "+e.field}var Da=function(){function e(e){this.timeField=e.timeField,this.esVersion=e.esVersion}return e.prototype.getRangeFilter=function(){var e={};return e[this.timeField]={gte:"$timeFrom",lte:"$timeTo",format:"epoch_millis"},e},e.prototype.buildTermsAgg=function(e,t,a){var r,n,i;if(t.terms={field:e.field},!e.settings)return t;if(t.terms.size=0===parseInt(e.settings.size,10)?500:parseInt(e.settings.size,10),void 0!==e.settings.orderBy&&(t.terms.order={},t.terms.order[e.settings.orderBy]=e.settings.order,r=parseInt(e.settings.orderBy,10),!isNaN(r)))for(i=0;i<a.metrics.length;i++)if((n=a.metrics[i]).id===e.settings.orderBy){t.aggs={},t.aggs[n.id]={},t.aggs[n.id][n.type]={field:n.field};break}return void 0!==e.settings.min_doc_count&&(t.terms.min_doc_count=parseInt(e.settings.min_doc_count,10)),e.settings.missing&&(t.terms.missing=e.settings.missing),t},e.prototype.getDateHistogramAgg=function(e){var t={},a=e.settings||{};return t.interval=a.interval,t.field=this.timeField,t.min_doc_count=a.min_doc_count||0,t.extended_bounds={min:"$timeFrom",max:"$timeTo"},t.format="epoch_millis","auto"===t.interval&&(t.interval="$__interval"),a.missing&&(t.missing=a.missing),t},e.prototype.getHistogramAgg=function(e){var t={},a=e.settings||{};return t.interval=a.interval,t.field=e.field,t.min_doc_count=a.min_doc_count||0,a.missing&&(t.missing=a.missing),t},e.prototype.getFiltersAgg=function(e){for(var t={},a=0;a<e.settings.filters.length;a++){var r=e.settings.filters[a].query,n=e.settings.filters[a].label;t[n=""===n||void 0===n?r:n]={query_string:{query:r,analyze_wildcard:!0}}}return t},e.prototype.documentQuery=function(e,t){return e.size=t,e.sort={},e.sort[this.timeField]={order:"desc",unmapped_type:"boolean"},this.esVersion<5&&(e.fields=["*","_source"]),e.script_fields={},this.esVersion<5?e.fielddata_fields=[this.timeField]:e.docvalue_fields=[this.timeField],e},e.prototype.addAdhocFilters=function(e,t){var a,r,n,i;if(t)for(a=0;a<t.length;a++)switch((n={})[(r=t[a]).key]=r.value,(i={})[r.key]={query:r.value},r.operator){case"=":e.query.bool.must||(e.query.bool.must=[]),e.query.bool.must.push({match_phrase:i});break;case"!=":e.query.bool.must_not||(e.query.bool.must_not=[]),e.query.bool.must_not.push({match_phrase:i});break;case"<":n[r.key]={lt:r.value},e.query.bool.filter.push({range:n});break;case">":n[r.key]={gt:r.value},e.query.bool.filter.push({range:n});break;case"=~":e.query.bool.filter.push({regexp:n});break;case"!~":e.query.bool.filter.push({bool:{must_not:{regexp:n}}})}},e.prototype.build=function(e,t,a){var r,n,i;e.metrics=e.metrics||[{type:"count",id:"1"}],e.bucketAggs=e.bucketAggs||[{type:"date_histogram",id:"2",settings:{interval:"auto"}}],e.timeField=this.timeField;var s={size:0,query:{bool:{filter:[{range:this.getRangeFilter()},{query_string:{analyze_wildcard:!0,query:a}}]}}};if(this.addAdhocFilters(s,t),0===e.bucketAggs.length){if(!(i=e.metrics[0])||"raw_document"!==i.type)throw{message:"Invalid query"};var o=i.settings&&i.settings.size||500;return this.documentQuery(s,o)}for(n=s,r=0;r<e.bucketAggs.length;r++){var l=e.bucketAggs[r],u={};switch(l.type){case"date_histogram":u.date_histogram=this.getDateHistogramAgg(l);break;case"histogram":u.histogram=this.getHistogramAgg(l);break;case"filters":u.filters={filters:this.getFiltersAgg(l)};break;case"terms":this.buildTermsAgg(l,u,e);break;case"geohash_grid":u.geohash_grid={field:l.field,precision:l.settings.precision}}n.aggs=n.aggs||{},n.aggs[l.id]=u,n=u}for(n.aggs={},r=0;r<e.metrics.length;r++)if("count"!==(i=e.metrics[r]).type){var c={},d=null;if($a(i.type)){if(!i.pipelineAgg||!/^\d*$/.test(i.pipelineAgg))continue;d={buckets_path:i.pipelineAgg}}else d={field:i.field};for(var p in i.settings)i.settings.hasOwnProperty(p)&&null!==i.settings[p]&&(d[p]=i.settings[p]);c[i.type]=d,n.aggs[i.id]=c}return s},e.prototype.getTermsQuery=function(e){var t={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};e.query&&t.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}});var a=500;return e.size&&(a=e.size),t.aggs={1:{terms:{field:e.field,size:a,order:{_term:"asc"}}}},t},e}(),Aa={Hourly:{startOf:"hour",amount:"hours"},Daily:{startOf:"day",amount:"days"},Weekly:{startOf:"isoWeek",amount:"weeks"},Monthly:{startOf:"month",amount:"months"},Yearly:{startOf:"year",amount:"years"}},Fa=function(){function e(e,t){this.pattern=e,this.interval=t}return e.prototype.getIndexForToday=function(){return this.interval?Y.a.utc().format(this.pattern):this.pattern},e.prototype.getIndexList=function(e,t){if(!this.interval)return this.pattern;for(var a=Aa[this.interval],r=Y()(e).utc().startOf(a.startOf),n=Y()(t).utc().startOf(a.startOf).valueOf(),i=[];r.valueOf()<=n;)i.push(r.format(this.pattern)),r.add(1,a.amount);return i},e}(),Ia=function(){function e(e,t){this.targets=e,this.response=t,this.targets=e,this.response=t}return e.prototype.processMetrics=function(e,t,a,r){var n,i,s,o,l,u;for(i=0;i<t.metrics.length;i++)if(!(n=t.metrics[i]).hide)switch(n.type){case"count":for(o={datapoints:[],metric:"count",props:r},s=0;s<e.buckets.length;s++)u=(l=e.buckets[s]).doc_count,o.datapoints.push([u,l.key]);a.push(o);break;case"percentiles":if(0===e.buckets.length)break;var c=e.buckets[0][n.id].values;for(var d in c){for(o={datapoints:[],metric:"p"+d,props:r,field:n.field},s=0;s<e.buckets.length;s++){var p=(l=e.buckets[s])[n.id].values;o.datapoints.push([p[d],l.key])}a.push(o)}break;case"extended_stats":for(var h in n.meta)if(n.meta[h]){for(o={datapoints:[],metric:h,props:r,field:n.field},s=0;s<e.buckets.length;s++){var m=(l=e.buckets[s])[n.id];m.std_deviation_bounds_upper=m.std_deviation_bounds.upper,m.std_deviation_bounds_lower=m.std_deviation_bounds.lower,o.datapoints.push([m[h],l.key])}a.push(o)}break;default:for(o={datapoints:[],metric:n.type,field:n.field,props:r},s=0;s<e.buckets.length;s++)void 0!==(u=(l=e.buckets[s])[n.id])&&(u.normalized_value?o.datapoints.push([u.normalized_value,l.key]):o.datapoints.push([u.value,l.key]));a.push(o)}},e.prototype.processAggregationDocs=function(e,t,a,r,n){if(0===r.columns.length){for(var i=0,s=D.a.keys(n);i<s.length;i++){var o=s[i];r.addColumn({text:o,filterable:!0})}r.addColumn({text:t.field,filterable:!0})}for(var l=function(e,t,a){r.addColumn({text:t}),e.push(a)},u=0,c=e.buckets;u<c.length;u++){for(var d=c[u],p=[],h=0,m=D.a.values(n);h<m.length;h++){var f=m[h];p.push(f)}p.push(d.key);for(var g=0,v=a.metrics;g<v.length;g++){var y=v[g];switch(y.type){case"count":l(p,this.getMetricName(y.type),d.doc_count);break;case"extended_stats":for(var b in y.meta)if(y.meta[b]){var S=d[y.id];S.std_deviation_bounds_upper=S.std_deviation_bounds.upper,S.std_deviation_bounds_lower=S.std_deviation_bounds.lower,l(p,this.getMetricName(b),S[b])}break;default:var x=this.getMetricName(y.type);D.a.filter(a.metrics,{type:y.type}).length>1&&(x+=" "+y.field),l(p,x,d[y.id].value)}}r.rows.push(p)}},e.prototype.processBuckets=function(e,t,a,r,n,i){var s,o,l,u,c=t.bucketAggs.length-1;for(u in e)if(o=D.a.find(t.bucketAggs,{id:u}),l=e[u],o)if(i===c)"date_histogram"===o.type?this.processMetrics(l,t,a,n):this.processAggregationDocs(l,o,t,r,n);else for(var d in l.buckets)s=l.buckets[d],n=D.a.clone(n),void 0!==s.key?n[o.field]=s.key:n.filter=d,s.key_as_string&&(n[o.field]=s.key_as_string),this.processBuckets(s,t,a,r,n,i+1)},e.prototype.getMetricName=function(e){var t=D.a.find(va,{value:e});return t||(t=D.a.find(wa,{value:e})),t?t.text:e},e.prototype.getSeriesName=function(e,t,a){var r=this.getMetricName(e.metric);if(t.alias){return t.alias.replace(/\{\{([\s\S]+?)\}\}/g,function(t,a,n){var i=a||n;return 0===i.indexOf("term ")?e.props[i.substring(5)]:void 0!==e.props[i]?e.props[i]:"metric"===i?r:"field"===i?e.field:t})}if(e.field&&$a(e.metric)){var n=D.a.find(t.metrics,{id:e.field});n?r+=" "+Ea(n):r="Unset"}else e.field&&(r+=" "+e.field);if(0===D.a.keys(e.props).length)return r;var i="";for(var s in e.props)i+=e.props[s]+" ";return 1===a?i.trim():i.trim()+" "+r},e.prototype.nameSeries=function(e,t){for(var a=D.a.uniq(D.a.map(e,"metric")).length,r=0;r<e.length;r++){var n=e[r];n.target=this.getSeriesName(n,t,a)}},e.prototype.processHits=function(e,t){var a,r,n,i,s={target:"docs",type:"docs",datapoints:[],total:e.total,filterable:!0};for(i=0;i<e.hits.length;i++){if(n={_id:(r=e.hits[i])._id,_type:r._type,_index:r._index},r._source)for(a in r._source)n[a]=r._source[a];for(a in r.fields)n[a]=r.fields[a];s.datapoints.push(n)}t.push(s)},e.prototype.trimDatapoints=function(e,t){var a=D.a.find(t.bucketAggs,{type:"date_histogram"});if(a&&a.settings&&a.settings.trimEdges){var r=a.settings.trimEdges;for(var n in e){var i=e[n];i.datapoints.length>2*r&&(i.datapoints=i.datapoints.slice(r,i.datapoints.length-r))}}},e.prototype.getErrorFromElasticResponse=function(e,t){var a={};return a.data=JSON.stringify(t,null,4),t.root_cause&&t.root_cause.length>0&&t.root_cause[0].reason?a.message=t.root_cause[0].reason:a.message=t.reason||"Unkown elastic error response",e.$$config&&(a.config=e.$$config),a},e.prototype.getTimeSeries=function(){for(var e=[],t=0;t<this.response.responses.length;t++){var a=this.response.responses[t];if(a.error)throw this.getErrorFromElasticResponse(this.response,a.error);if(a.hits&&a.hits.hits.length>0&&this.processHits(a.hits,e),a.aggregations){var r=a.aggregations,n=this.targets[t],i=[],s=new lt.a;this.processBuckets(r,n,i,s,{},0),this.trimDatapoints(i,n),this.nameSeries(i,n);for(var o=0;o<i.length;o++)e.push(i[o]);s.rows.length>0&&e.push(s)}}return{data:e}},e}(),Oa=function(){function e(e,t,a,r,n){this.$q=t,this.backendSrv=a,this.templateSrv=r,this.timeSrv=n,this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.url=e.url,this.name=e.name,this.index=e.index,this.timeField=e.jsonData.timeField,this.esVersion=e.jsonData.esVersion,this.indexPattern=new Fa(e.index,e.jsonData.interval),this.interval=e.jsonData.timeInterval,this.maxConcurrentShardRequests=e.jsonData.maxConcurrentShardRequests,this.queryBuilder=new Da({timeField:this.timeField,esVersion:this.esVersion})}return e.$inject=["instanceSettings","$q","backendSrv","templateSrv","timeSrv"],e.prototype.request=function(e,t,a){var r={url:this.url+"/"+t,method:e,data:a};return(this.basicAuth||this.withCredentials)&&(r.withCredentials=!0),this.basicAuth&&(r.headers={Authorization:this.basicAuth}),this.backendSrv.datasourceRequest(r)},e.prototype.get=function(e){var t=this.timeSrv.timeRange(),a=this.indexPattern.getIndexList(t.from.valueOf(),t.to.valueOf());return D.a.isArray(a)&&a.length?this.request("GET",a[0]+e).then(function(e){return e.data.$$config=e.config,e.data}):this.request("GET",this.indexPattern.getIndexForToday()+e).then(function(e){return e.data.$$config=e.config,e.data})},e.prototype.post=function(e,t){return this.request("POST",e,t).then(function(e){return e.data.$$config=e.config,e.data}).catch(function(e){if(e.data&&e.data.error)throw{message:"Elasticsearch error: "+e.data.error.reason,error:e.data.error};throw e})},e.prototype.annotationQuery=function(e){var t=e.annotation,a=t.timeField||"@timestamp",r=t.query||"*",n=t.tagsField||"tags",i=t.textField||null,s={};s[a]={from:e.range.from.valueOf(),to:e.range.to.valueOf(),format:"epoch_millis"};var o={query:{bool:{filter:[{range:s},{query_string:{query:this.templateSrv.replace(r,{},"lucene")}}]}},size:1e4};this.esVersion<5&&(o.fields=[a,"_source"]);var l={search_type:"query_then_fetch",ignore_unavailable:!0};t.index?l.index=t.index:l.index=this.indexPattern.getIndexList(e.range.from,e.range.to);var u=P.a.toJson(l)+"\n"+P.a.toJson(o)+"\n";return this.post("_msearch",u).then(function(e){for(var r=[],s=e.responses[0].hits.hits,o=function(e,t){if(t){for(var a=t.split("."),r=e,n=0;n<a.length;n++)if(!(r=r[a[n]]))return console.log("could not find field in annotation: ",t),"";return r}},l=0;l<s.length;l++){var u=s[l]._source,c=o(u,a);if(void 0!==s[l].fields){var d=s[l].fields;(D.a.isString(d[a])||D.a.isNumber(d[a]))&&(c=d[a])}var p={annotation:t,time:Y.a.utc(c).valueOf(),text:o(u,i),tags:o(u,n)};if(t.titleField){var h=o(u,t.titleField);h&&(p.text=h+"\n"+p.text)}"string"==typeof p.tags&&(p.tags=p.tags.split(",")),r.push(p)}return r})},e.prototype.testDatasource=function(){return this.timeSrv.setTime({from:"now-1m",to:"now"},!0),this.getFields({type:"date"}).then(function(e){return D.a.find(e,{text:this.timeField})?{status:"success",message:"Index OK. Time field name OK."}:{status:"error",message:"No date field named "+this.timeField+" found"}}.bind(this),function(e){if(console.log(e),e.data&&e.data.error){var t=P.a.toJson(e.data.error);return e.data.error.reason&&(t=e.data.error.reason),{status:"error",message:t}}return{status:"error",message:e.status}})},e.prototype.getQueryHeader=function(e,t,a){var r={search_type:e,ignore_unavailable:!0,index:this.indexPattern.getIndexList(t,a)};return this.esVersion>=56&&(r.max_concurrent_shard_requests=this.maxConcurrentShardRequests),P.a.toJson(r)},e.prototype.query=function(e){for(var t,a="",r=[],n=this.templateSrv.getAdhocFilters(this.name),i=0;i<e.targets.length;i++)if(!(t=e.targets[i]).hide){var s=this.templateSrv.replace(t.query||"*",e.scopedVars,"lucene"),o=this.queryBuilder.build(t,n,s),l=P.a.toJson(o),u=0===o.size&&this.esVersion<5?"count":"query_then_fetch";a+=this.getQueryHeader(u,e.range.from,e.range.to)+"\n",a+=l+"\n",r.push(t)}return 0===r.length?this.$q.when([]):(a=(a=a.replace(/\$timeFrom/g,e.range.from.valueOf())).replace(/\$timeTo/g,e.range.to.valueOf()),a=this.templateSrv.replace(a,e.scopedVars),this.post("_msearch",a).then(function(e){return new Ia(r,e).getTimeSeries()}))},e.prototype.getFields=function(e){return this.get("/_mapping").then(function(t){var a={float:"number",double:"number",integer:"number",long:"number",date:"date",string:"string",text:"string",scaled_float:"number",nested:"nested"};function r(e,t,r){return"_"!==t[0]&&(!r.type||(r.type===e.type||r.type===a[e.type]))}var n=[],i={};function s(t){for(var a in t){var o=t[a];if(D.a.isObject(o.properties)&&(n.push(a),s(o.properties)),D.a.isObject(o.fields)&&(n.push(a),s(o.fields)),D.a.isString(o.type)){var l=n.concat(a).join(".");r(o,a,e)&&(i[l]={text:l,type:o.type})}}n.pop()}for(var o in t){var l=t[o];if(l&&l.mappings){var u=l.mappings;for(var c in u){s(u[c].properties)}}}return D.a.map(i,function(e){return e})})},e.prototype.getTerms=function(e){var t=this.timeSrv.timeRange(),a=this.esVersion>=5?"query_then_fetch":"count",r=this.getQueryHeader(a,t.from,t.to),n=P.a.toJson(this.queryBuilder.getTermsQuery(e));return n=r+"\n"+(n=(n=n.replace(/\$timeFrom/g,t.from.valueOf())).replace(/\$timeTo/g,t.to.valueOf()))+"\n",this.post("_msearch?search_type="+a,n).then(function(e){if(!e.responses[0].aggregations)return[];var t=e.responses[0].aggregations[1].buckets;return D.a.map(t,function(e){return{text:e.key_as_string||e.key,value:e.key}})})},e.prototype.metricFindQuery=function(e){return(e=P.a.fromJson(e))?"fields"===e.find?(e.field=this.templateSrv.replace(e.field,{},"lucene"),this.getFields(e)):"terms"===e.find?(e.field=this.templateSrv.replace(e.field,{},"lucene"),e.query=this.templateSrv.replace(e.query||"*",{},"lucene"),this.getTerms(e)):void 0:this.$q.when([])},e.prototype.getTagKeys=function(){return this.getFields({})},e.prototype.getTagValues=function(e){return this.getTerms({field:e.key,query:"*"})},e.prototype.targetContainsTemplate=function(e){if(this.templateSrv.variableExists(e.query)||this.templateSrv.variableExists(e.alias))return!0;for(var t=0,a=e.bucketAggs;t<a.length;t++){var r=a[t];if(this.templateSrv.variableExists(r.field)||this.objectContainsTemplate(r.settings))return!0}for(var n=0,i=e.metrics;n<i.length;n++){var s=i[n];if(this.templateSrv.variableExists(s.field)||this.objectContainsTemplate(s.settings)||this.objectContainsTemplate(s.meta))return!0}return!1},e.prototype.isPrimitive=function(e){return null===e||void 0===e||!!["string","number","boolean"].some(function(e){return e===typeof!0})},e.prototype.objectContainsTemplate=function(e){if(!e)return!1;for(var t=0,a=Object.keys(e);t<a.length;t++){var r=a[t];if(this.isPrimitive(e[r])){if(this.templateSrv.variableExists(e[r]))return!0}else if(Array.isArray(e[r]))for(var n=0,i=e[r];n<i.length;n++){var s=i[n];if(this.objectContainsTemplate(s))return!0}else if(this.objectContainsTemplate(e[r]))return!0}return!1},e}();var qa=function(){function e(e,t,a,r){var n=e.target.bucketAggs;e.orderByOptions=[],e.getBucketAggTypes=function(){return ya},e.getOrderOptions=function(){return Sa},e.getSizeOptions=function(){return xa},r.onAppEvent("elastic-query-updated",function(){e.validateModel()},e),e.init=function(){e.agg=n[e.index],e.validateModel()},e.onChangeInternal=function(){e.onChange()},e.onTypeChanged=function(){switch(e.agg.settings={},e.showOptions=!1,e.agg.type){case"date_histogram":case"histogram":case"terms":delete e.agg.query,e.agg.field="select field";break;case"filters":delete e.agg.field,e.agg.query="*";break;case"geohash_grid":e.agg.settings.precision=3}e.validateModel(),e.onChange()},e.validateModel=function(){e.index=D.a.indexOf(n,e.agg),e.isFirst=0===e.index,e.bucketAggCount=n.length;var t="",a=e.agg.settings||{};switch(e.agg.type){case"terms":a.order=a.order||"desc",a.size=a.size||"10",a.min_doc_count=a.min_doc_count||1,a.orderBy=a.orderBy||"_term","0"!==a.size&&(t=function(e){return D.a.find(Sa,{value:e}).text}(a.order)+" "+a.size+", "),a.min_doc_count>0&&(t+="Min Doc Count: "+a.min_doc_count+", "),t+="Order by: "+function(e,t){var a=D.a.find(ba,{value:e});if(a)return a.text;var r=D.a.find(t.metrics,{id:e});return r?Ea(r):"metric not found"}(a.orderBy,e.target),"0"===a.size&&(t+=" ("+a.order+")");break;case"filters":a.filters=a.filters||[{query:"*"}],(t=D.a.reduce(a.filters,function(e,t,a){return e+="Q"+(a+1)+"  = "+t.query+" "},"")).length>50&&(t=t.substr(0,50)+"..."),t="Filter Queries ("+a.filters.length+")";break;case"date_histogram":a.interval=a.interval||"auto",a.min_doc_count=a.min_doc_count||0,e.agg.field=e.target.timeField,t="Interval: "+a.interval,a.min_doc_count>0&&(t+=", Min Doc Count: "+a.min_doc_count),(void 0===a.trimEdges||a.trimEdges<0)&&(a.trimEdges=0),a.trimEdges&&a.trimEdges>0&&(t+=", Trim edges: "+a.trimEdges);break;case"histogram":a.interval=a.interval||1e3,a.min_doc_count=D.a.defaultTo(a.min_doc_count,1),t="Interval: "+a.interval,a.min_doc_count>0&&(t+=", Min Doc Count: "+a.min_doc_count);break;case"geohash_grid":a.precision=Math.max(Math.min(a.precision,7),1),t="Precision: "+a.precision}return e.settingsLinkText=t,e.agg.settings=a,!0},e.addFiltersQuery=function(){e.agg.settings.filters.push({query:"*"})},e.removeFiltersQuery=function(t){e.agg.settings.filters=D.a.without(e.agg.settings.filters,t)},e.toggleOptions=function(){e.showOptions=!e.showOptions},e.getOrderByOptions=function(){return function(e){var t=[];return D.a.each(e.metrics,function(e){"count"!==e.type&&t.push({text:Ea(e),value:e.id})}),ba.concat(t)}(e.target)},e.getFieldsInternal=function(){return"date_histogram"===e.agg.type?e.getFields({$fieldType:"date"}):e.getFields()},e.getIntervalOptions=function(){return a.when(t.transformToSegments(!0,"interval")(ka))},e.addBucketAgg=function(){var t=n[n.length-1],a=n.length-1;t&&"date_histogram"===t.type&&(a-=1);var r=D.a.reduce(e.target.bucketAggs.concat(e.target.metrics),function(e,t){return parseInt(t.id)>e?parseInt(t.id):e},0);n.splice(a,0,{type:"terms",field:"select field",id:(r+1).toString(),fake:!0}),e.onChange()},e.removeBucketAgg=function(){n.splice(e.index,1),e.onChange()},e.init()}return e.$inject=["$scope","uiSegmentSrv","$q","$rootScope"],e}(),Ra=P.a.module("grafana.directives");Ra.directive("elasticBucketAgg",function(){return{templateUrl:"public/app/plugins/datasource/elasticsearch/partials/bucket_agg.html",controller:"ElasticBucketAggCtrl",restrict:"E",scope:{target:"=",index:"=",onChange:"&",getFields:"&"}}}),Ra.controller("ElasticBucketAggCtrl",qa);var Va=function(){function e(e,t,a,r){var n=e.target.metrics;e.metricAggTypes=Ma(e.esVersion),e.extendedStats=wa,e.pipelineAggOptions=[],e.modelSettingsValues={},e.init=function(){e.agg=n[e.index],e.validateModel(),e.updatePipelineAggOptions()},e.updatePipelineAggOptions=function(){e.pipelineAggOptions=function(e){var t=[];return D.a.each(e.metrics,function(e){$a(e.type)||t.push({text:Ea(e),value:e.id})}),t}(e.target)},r.onAppEvent("elastic-query-updated",function(){e.index=D.a.indexOf(n,e.agg),e.updatePipelineAggOptions(),e.validateModel()},e),e.validateModel=function(){if(e.isFirst=0===e.index,e.isSingle=1===n.length,e.settingsLinkText="",e.aggDef=D.a.find(e.metricAggTypes,{value:e.agg.type}),$a(e.agg.type)){e.agg.pipelineAgg=e.agg.pipelineAgg||"select metric",e.agg.field=e.agg.pipelineAgg;var t=function(e){return $a(e.type)?Ta[e.type]:[]}(e.agg);t.length>0&&(D.a.each(t,function(t){e.agg.settings[t.text]=e.agg.settings[t.text]||t.default}),e.settingsLinkText="Options")}else e.agg.field||(e.agg.field="select field");switch(e.agg.type){case"cardinality":var a=e.agg.settings.precision_threshold||"";e.settingsLinkText="Precision threshold: "+a;break;case"percentiles":e.agg.settings.percents=e.agg.settings.percents||[25,50,75,95,99],e.settingsLinkText="Values: "+e.agg.settings.percents.join(",");break;case"extended_stats":0===D.a.keys(e.agg.meta).length&&(e.agg.meta.std_deviation_bounds_lower=!0,e.agg.meta.std_deviation_bounds_upper=!0);var r=D.a.reduce(e.agg.meta,function(t,a,r){if(a){var n=D.a.find(e.extendedStats,{value:r});t.push(n.text)}return t},[]);e.settingsLinkText="Stats: "+r.join(", ");break;case"moving_avg":e.movingAvgModelTypes=Ca,e.modelSettings=Pa(e.agg.settings.model,!0),e.updateMovingAvgModelSettings();break;case"raw_document":e.agg.settings.size=e.agg.settings.size||500,e.settingsLinkText="Size: "+e.agg.settings.size,e.target.metrics.splice(0,e.target.metrics.length,e.agg),e.target.bucketAggs=[]}if(e.aggDef.supportsInlineScript){var i=e.agg.inlineScript;i?e.agg.settings.script={inline:i}:delete e.agg.settings.script,""===e.settingsLinkText&&(e.settingsLinkText="Options")}},e.toggleOptions=function(){e.showOptions=!e.showOptions,e.updatePipelineAggOptions()},e.onChangeInternal=function(){e.onChange()},e.updateMovingAvgModelSettings=function(){for(var t=[],a=Pa(e.agg.settings.model,!1),r=0;r<a.length;r++)t.push(a[r].value);for(var n in e.agg.settings.settings)null!==e.agg.settings.settings[n]&&-1!==t.indexOf(n)||delete e.agg.settings.settings[n]},e.onChangeClearInternal=function(){delete e.agg.settings.minimize,e.onChange()},e.onTypeChange=function(){e.agg.settings={},e.agg.meta={},e.showOptions=!1,e.updatePipelineAggOptions(),e.onChange()},e.getFieldsInternal=function(){return"cardinality"===e.agg.type?e.getFields():e.getFields({$fieldType:"number"})},e.addMetricAgg=function(){var t=n.length,a=D.a.reduce(e.target.bucketAggs.concat(e.target.metrics),function(e,t){return parseInt(t.id)>e?parseInt(t.id):e},0);n.splice(t,0,{type:"count",field:"select field",id:(a+1).toString()}),e.onChange()},e.removeMetricAgg=function(){n.splice(e.index,1),e.onChange()},e.toggleShowMetric=function(){e.agg.hide=!e.agg.hide,e.agg.hide||delete e.agg.hide,e.onChange()},e.init()}return e.$inject=["$scope","uiSegmentSrv","$q","$rootScope"],e}(),Na=P.a.module("grafana.directives");Na.directive("elasticMetricAgg",function(){return{templateUrl:"public/app/plugins/datasource/elasticsearch/partials/metric_agg.html",controller:"ElasticMetricAggCtrl",restrict:"E",scope:{target:"=",index:"=",onChange:"&",getFields:"&",esVersion:"="}}}),Na.controller("ElasticMetricAggCtrl",Va);var ja=function(e){function t(t,a,r,n){var i=e.call(this,t,a)||this;return i.$rootScope=r,i.uiSegmentSrv=n,i.esVersion=i.datasource.esVersion,i.queryUpdated(),i}return t.$inject=["$scope","$injector","$rootScope","uiSegmentSrv"],je.d(t,e),t.prototype.getFields=function(e){var t=P.a.toJson({find:"fields",type:e});return this.datasource.metricFindQuery(t).then(this.uiSegmentSrv.transformToSegments(!1)).catch(this.handleQueryError.bind(this))},t.prototype.queryUpdated=function(){var e=P.a.toJson(this.datasource.queryBuilder.build(this.target),!0);this.rawQueryOld&&e!==this.rawQueryOld&&this.refresh(),this.rawQueryOld=e,this.$rootScope.appEvent("elastic-query-updated")},t.prototype.getCollapsedText=function(){var e=this.target.metrics,t=this.target.bucketAggs,a=Ma(this.esVersion),r=ya,n="";return this.target.query&&(n+="Query: "+this.target.query+", "),n+="Metrics: ",D.a.each(e,function(e,t){var r=D.a.find(a,{value:e.type});n+=r.text+"(",r.requiresField&&(n+=e.field),n+="), "}),D.a.each(t,function(e,t){0===t&&(n+=" Group by: ");var a=D.a.find(r,{value:e.type});n+=a.text+"(",a.requiresField&&(n+=e.field),n+="), "}),this.target.alias&&(n+="Alias: "+this.target.alias),n},t.prototype.handleQueryError=function(e){return this.error=e.message||"Failed to issue metric query",[]},t.templateUrl="partials/query.editor.html",t}(Ye),Ua=function(){function e(e){this.indexPatternTypes=[{name:"No pattern",value:void 0},{name:"Hourly",value:"Hourly",example:"[logstash-]YYYY.MM.DD.HH"},{name:"Daily",value:"Daily",example:"[logstash-]YYYY.MM.DD"},{name:"Weekly",value:"Weekly",example:"[logstash-]GGGG.WW"},{name:"Monthly",value:"Monthly",example:"[logstash-]YYYY.MM"},{name:"Yearly",value:"Yearly",example:"[logstash-]YYYY"}],this.esVersions=[{name:"2.x",value:2},{name:"5.x",value:5},{name:"5.6+",value:56}],this.current.jsonData.timeField=this.current.jsonData.timeField||"@timestamp",this.current.jsonData.esVersion=this.current.jsonData.esVersion||5,this.current.jsonData.maxConcurrentShardRequests=this.current.jsonData.maxConcurrentShardRequests||256}return e.$inject=["$scope"],e.prototype.indexPatternTypeChanged=function(){var e=D.a.find(this.indexPatternTypes,{value:this.current.jsonData.interval});this.current.database=e.example||"es-index-name"},e.templateUrl="public/app/plugins/datasource/elasticsearch/partials/config.html",e}(),La=function(){function e(){}return e.templateUrl="partials/annotations.editor.html",e}(),Ba=function(){function e(e,t,a,r){this.$q=t,this.backendSrv=a,this.templateSrv=r,this.type="opentsdb",this.url=e.url,this.name=e.name,this.withCredentials=e.withCredentials,this.basicAuth=e.basicAuth,e.jsonData=e.jsonData||{},this.tsdbVersion=e.jsonData.tsdbVersion||1,this.tsdbResolution=e.jsonData.tsdbResolution||1,this.supportMetrics=!0,this.tagKeys={},this.aggregatorsPromise=null,this.filterTypesPromise=null}return e.$inject=["instanceSettings","$q","backendSrv","templateSrv"],e.prototype.query=function(e){var t=this.convertToTSDBTime(e.rangeRaw.from,!1),a=this.convertToTSDBTime(e.rangeRaw.to,!0),r=[];D.a.each(e.targets,function(t){t.metric&&r.push(this.convertTargetToQuery(t,e,this.tsdbVersion))}.bind(this));var n=D.a.compact(r);if(D.a.isEmpty(n)){var i=this.$q.defer();return i.resolve({data:[]}),i.promise}var s={};return D.a.each(n,function(e){e.filters&&e.filters.length>0?D.a.each(e.filters,function(e){s[e.tagk]=!0}):D.a.each(e.tags,function(e,t){s[t]=!0})}),e.targets=D.a.filter(e.targets,function(e){return!0!==e.hide}),this.performTimeSeriesQuery(n,t,a).then(function(t){var a=this.mapMetricsToTargets(t.data,e,this.tsdbVersion);return{data:D.a.map(t.data,function(t,r){return-1===(r=a[r])&&(r=0),this._saveTagKeys(t),this.transformMetricData(t,s,e.targets[r],e,this.tsdbResolution)}.bind(this))}}.bind(this))},e.prototype.annotationQuery=function(e){var t=this.convertToTSDBTime(e.rangeRaw.from,!1),a=this.convertToTSDBTime(e.rangeRaw.to,!0),r=[],n=[];r.push({aggregator:"sum",metric:e.annotation.target});var i=D.a.compact(r);return this.performTimeSeriesQuery(i,t,a).then(function(t){if(t.data[0]){var a=t.data[0].annotations;e.annotation.isGlobal&&(a=t.data[0].globalAnnotations),a&&D.a.each(a,function(t){var a={text:t.description,time:1e3*Math.floor(t.startTime),annotation:e.annotation};n.push(a)})}return n}.bind(this))},e.prototype.targetContainsTemplate=function(e){if(e.filters&&e.filters.length>0)for(var t=0;t<e.filters.length;t++)if(this.templateSrv.variableExists(e.filters[t].filter))return!0;if(e.tags&&Object.keys(e.tags).length>0)for(var a in e.tags)if(this.templateSrv.variableExists(e.tags[a]))return!0;return!1},e.prototype.performTimeSeriesQuery=function(e,t,a){var r=!1;2===this.tsdbResolution&&(r=!0);var n={start:t,queries:e,msResolution:r,globalAnnotations:!0};3===this.tsdbVersion&&(n.showQuery=!0),a&&(n.end=a);var i={method:"POST",url:this.url+"/api/query",data:n};return this._addCredentialOptions(i),this.backendSrv.datasourceRequest(i)},e.prototype.suggestTagKeys=function(e){return this.$q.when(this.tagKeys[e]||[])},e.prototype._saveTagKeys=function(e){var t=Object.keys(e.tags);D.a.each(e.aggregateTags,function(e){t.push(e)}),this.tagKeys[e.metric]=t},e.prototype._performSuggestQuery=function(e,t){return this._get("/api/suggest",{type:t,q:e,max:1e3}).then(function(e){return e.data})},e.prototype._performMetricKeyValueLookup=function(e,t){if(!e||!t)return this.$q.when([]);var a=t.split(",").map(function(e){return e.trim()}),r=a[0],n=r+"=*";a.length>1&&(n+=","+a.splice(1).join(","));var i=e+"{"+n+"}";return this._get("/api/search/lookup",{m:i,limit:3e3}).then(function(e){e=e.data.results;var t=[];return D.a.each(e,function(e){-1===t.indexOf(e.tags[r])&&t.push(e.tags[r])}),t})},e.prototype._performMetricKeyLookup=function(e){return e?this._get("/api/search/lookup",{m:e,limit:1e3}).then(function(e){e=e.data.results;var t=[];return D.a.each(e,function(e){D.a.each(e.tags,function(e,a){-1===t.indexOf(a)&&t.push(a)})}),t}):this.$q.when([])},e.prototype._get=function(e,t){var a={method:"GET",url:this.url+e,params:t};return this._addCredentialOptions(a),this.backendSrv.datasourceRequest(a)},e.prototype._addCredentialOptions=function(e){(this.basicAuth||this.withCredentials)&&(e.withCredentials=!0),this.basicAuth&&(e.headers={Authorization:this.basicAuth})},e.prototype.metricFindQuery=function(e){if(!e)return this.$q.when([]);var t;try{t=this.templateSrv.replace(e,{},"distributed")}catch(e){return this.$q.reject(e)}var a=function(e){return D.a.map(e,function(e){return{text:e}})},r=t.match(/metrics\((.*)\)/);if(r)return this._performSuggestQuery(r[1],"metrics").then(a);var n=t.match(/tag_names\((.*)\)/);if(n)return this._performMetricKeyLookup(n[1]).then(a);var i=t.match(/tag_values\((.*?),\s?(.*)\)/);if(i)return this._performMetricKeyValueLookup(i[1],i[2]).then(a);var s=t.match(/suggest_tagk\((.*)\)/);if(s)return this._performSuggestQuery(s[1],"tagk").then(a);var o=t.match(/suggest_tagv\((.*)\)/);return o?this._performSuggestQuery(o[1],"tagv").then(a):this.$q.when([])},e.prototype.testDatasource=function(){return this._performSuggestQuery("cpu","metrics").then(function(){return{status:"success",message:"Data source is working"}})},e.prototype.getAggregators=function(){return this.aggregatorsPromise?this.aggregatorsPromise:(this.aggregatorsPromise=this._get("/api/aggregators").then(function(e){return e.data&&D.a.isArray(e.data)?e.data.sort():[]}),this.aggregatorsPromise)},e.prototype.getFilterTypes=function(){return this.filterTypesPromise?this.filterTypesPromise:(this.filterTypesPromise=this._get("/api/config/filters").then(function(e){return e.data?Object.keys(e.data).sort():[]}),this.filterTypesPromise)},e.prototype.transformMetricData=function(e,t,a,r,n){var i=this.createMetricLabel(e,a,t,r),s=[];return D.a.each(e.dps,function(e,t){2===n?s.push([e,1*t]):s.push([e,1e3*t])}),{target:i,datapoints:s}},e.prototype.createMetricLabel=function(e,t,a,r){if(t.alias){var n=D.a.clone(r.scopedVars||{});return D.a.each(e.tags,function(e,t){n["tag_"+t]={value:e}}),this.templateSrv.replace(t.alias,n)}var i=e.metric,s=[];return D.a.isEmpty(e.tags)||D.a.each(D.a.toPairs(e.tags),function(e){D.a.has(a,e[0])&&s.push(e[0]+"="+e[1])}),D.a.isEmpty(s)||(i+="{"+s.join(", ")+"}"),i},e.prototype.convertTargetToQuery=function(e,t,a){if(!e.metric||e.hide)return null;var r={metric:this.templateSrv.replace(e.metric,t.scopedVars,"pipe"),aggregator:"avg"};if(e.aggregator&&(r.aggregator=this.templateSrv.replace(e.aggregator)),e.shouldComputeRate&&(r.rate=!0,r.rateOptions={counter:!!e.isCounter},e.counterMax&&e.counterMax.length&&(r.rateOptions.counterMax=parseInt(e.counterMax)),e.counterResetValue&&e.counterResetValue.length&&(r.rateOptions.resetValue=parseInt(e.counterResetValue)),a>=2&&(r.rateOptions.dropResets=!(r.rateOptions.counterMax||r.rateOptions.ResetValue&&0!==r.rateOptions.ResetValue))),!e.disableDownsampling){var n=this.templateSrv.replace(e.downsampleInterval||t.interval);n.match(/\.[0-9]+s/)&&(n=1e3*parseFloat(n)+"ms"),r.downsample=n+"-"+e.downsampleAggregator,e.downsampleFillPolicy&&"none"!==e.downsampleFillPolicy&&(r.downsample+="-"+e.downsampleFillPolicy)}if(e.filters&&e.filters.length>0){if(r.filters=P.a.copy(e.filters),r.filters)for(var i in r.filters)r.filters[i].filter=this.templateSrv.replace(r.filters[i].filter,t.scopedVars,"pipe")}else if(r.tags=P.a.copy(e.tags),r.tags)for(var s in r.tags)r.tags[s]=this.templateSrv.replace(r.tags[s],t.scopedVars,"pipe");return e.explicitTags&&(r.explicitTags=!0),r},e.prototype.mapMetricsToTargets=function(e,t,a){var r,n,i=this;return D.a.map(e,function(e){return 3===a?e.query.index:D.a.findIndex(t.targets,function(a){return a.filters&&a.filters.length>0?a.metric===e.metric:a.metric===e.metric&&D.a.every(a.tags,function(a,s){return r=i.templateSrv.replace(a,t.scopedVars,"pipe"),n=r.split("|"),D.a.includes(n,e.tags[s])||"*"===r})})})},e.prototype.convertToTSDBTime=function(e,t){return"now"===e?null:(e=Le.parse(e,t)).valueOf()},e}(),Qa=function(e){function t(t,a){var r=e.call(this,t,a)||this;return r.errors=r.validateTarget(),r.aggregators=["avg","sum","min","max","dev","zimsum","mimmin","mimmax"],r.fillPolicies=["none","nan","null","zero"],r.filterTypes=["wildcard","iliteral_or","not_iliteral_or","not_literal_or","iwildcard","literal_or","regexp"],r.tsdbVersion=r.datasource.tsdbVersion,r.target.aggregator||(r.target.aggregator="sum"),r.target.downsampleAggregator||(r.target.downsampleAggregator="avg"),r.target.downsampleFillPolicy||(r.target.downsampleFillPolicy="none"),r.datasource.getAggregators().then(function(e){0!==e.length&&(r.aggregators=e)}),r.datasource.getFilterTypes().then(function(e){0!==e.length&&(r.filterTypes=e)}),r.suggestMetrics=function(e,t){r.datasource.metricFindQuery("metrics("+e+")").then(r.getTextValues).then(t)},r.suggestTagKeys=function(e,t){r.datasource.suggestTagKeys(r.target.metric).then(t)},r.suggestTagValues=function(e,t){r.datasource.metricFindQuery("suggest_tagv("+e+")").then(r.getTextValues).then(t)},r}return t.$inject=["$scope","$injector"],je.d(t,e),t.prototype.targetBlur=function(){this.errors=this.validateTarget(),this.refresh()},t.prototype.getTextValues=function(e){return D.a.map(e,function(e){return e.text})},t.prototype.addTag=function(){this.target.filters&&this.target.filters.length>0&&(this.errors.tags="Please remove filters to use tags, tags and filters are mutually exclusive."),this.addTagMode?(this.target.tags||(this.target.tags={}),this.errors=this.validateTarget(),this.errors.tags||(this.target.tags[this.target.currentTagKey]=this.target.currentTagValue,this.target.currentTagKey="",this.target.currentTagValue="",this.targetBlur()),this.addTagMode=!1):this.addTagMode=!0},t.prototype.removeTag=function(e){delete this.target.tags[e],this.targetBlur()},t.prototype.editTag=function(e,t){this.removeTag(e),this.target.currentTagKey=e,this.target.currentTagValue=t,this.addTag()},t.prototype.closeAddTagMode=function(){this.addTagMode=!1},t.prototype.addFilter=function(){if(this.target.tags&&D.a.size(this.target.tags)>0&&(this.errors.filters="Please remove tags to use filters, tags and filters are mutually exclusive."),this.addFilterMode){if(this.target.filters||(this.target.filters=[]),this.target.currentFilterType||(this.target.currentFilterType="iliteral_or"),this.target.currentFilterGroupBy||(this.target.currentFilterGroupBy=!1),this.errors=this.validateTarget(),!this.errors.filters){var e={type:this.target.currentFilterType,tagk:this.target.currentFilterKey,filter:this.target.currentFilterValue,groupBy:this.target.currentFilterGroupBy};this.target.filters.push(e),this.target.currentFilterType="literal_or",this.target.currentFilterKey="",this.target.currentFilterValue="",this.target.currentFilterGroupBy=!1,this.targetBlur()}this.addFilterMode=!1}else this.addFilterMode=!0},t.prototype.removeFilter=function(e){this.target.filters.splice(e,1),this.targetBlur()},t.prototype.editFilter=function(e,t){this.removeFilter(t),this.target.currentFilterKey=e.tagk,this.target.currentFilterValue=e.filter,this.target.currentFilterType=e.type,this.target.currentFilterGroupBy=e.groupBy,this.addFilter()},t.prototype.closeAddFilterMode=function(){this.addFilterMode=!1},t.prototype.validateTarget=function(){var e={};if(this.target.shouldDownsample)try{this.target.downsampleInterval?A.a.describe_interval(this.target.downsampleInterval):e.downsampleInterval="You must supply a downsample interval (e.g. '1m' or '1h')."}catch(t){e.downsampleInterval=t.message}return this.target.tags&&D.a.has(this.target.tags,this.target.currentTagKey)&&(e.tags="Duplicate tag key '"+this.target.currentTagKey+"'."),e},t.templateUrl="partials/query.editor.html",t}(Ye),za=function(){function e(e){this.tsdbVersions=[{name:"<=2.1",value:1},{name:"==2.2",value:2},{name:"==2.3",value:3}],this.tsdbResolutions=[{name:"second",value:1},{name:"millisecond",value:2}],this.current.jsonData=this.current.jsonData||{},this.current.jsonData.tsdbVersion=this.current.jsonData.tsdbVersion||1,this.current.jsonData.tsdbResolution=this.current.jsonData.tsdbResolution||1}return e.$inject=["$scope"],e.templateUrl="public/app/plugins/datasource/opentsdb/partials/config.html",e}(),Ha=function(){function e(){}return e.templateUrl="partials/annotations.editor.html",e}(),Ya=function(){function e(e,t){this.backendSrv=e,this.$q=t}return e.$inject=["backendSrv","$q"],e.prototype.query=function(e){return this.backendSrv.get("/api/tsdb/testdata/random-walk",{from:e.range.from.valueOf(),to:e.range.to.valueOf(),intervalMs:e.intervalMs,maxDataPoints:e.maxDataPoints}).then(function(e){var t=[];return e.results&&D.a.forEach(e.results,function(e){for(var a=0,r=e.series;a<r.length;a++){var n=r[a];t.push({target:n.name,datapoints:n.points})}}),{data:t}})},e.prototype.metricFindQuery=function(e){return this.$q.when({data:[]})},e.prototype.annotationQuery=function(e){var t={from:e.range.from.valueOf(),to:e.range.to.valueOf(),limit:e.annotation.limit,tags:e.annotation.tags};if("dashboard"===e.annotation.type){if(!e.dashboard.id)return this.$q.when([]);t.dashboardId=e.dashboard.id,delete t.tags}else if(!D.a.isArray(e.annotation.tags)||0===e.annotation.tags.length)return this.$q.when([]);return this.backendSrv.get("/api/annotations",t)},e}(),Wa=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return je.d(t,e),t.templateUrl="partials/query.editor.html",t}(Ye),Ga=function(){function e(){this.types=[{text:"仪表盘",value:"dashboard"},{text:"标签",value:"tags"}],this.annotation.type=this.annotation.type||"tags",this.annotation.limit=this.annotation.limit||100}return e.templateUrl="partials/annotations.editor.html",e}(),Ka=function(){function e(e){this.series=e.series,this.alias=e.alias,this.annotation=e.annotation}return e.prototype.getTimeSeries=function(){var e,t,a=this,r=[];return 0===this.series.length?r:(D.a.each(this.series,function(n){var i=n.columns.length,s=D.a.map(n.tags,function(e,t){return t+": "+e});for(t=1;t<i;t++){var o=n.name,l=n.columns[t];"value"!==l&&(o=o+"."+l),a.alias?o=a._getSeriesName(n,t):n.tags&&(o=o+" {"+s.join(", ")+"}");var u=[];if(n.values)for(e=0;e<n.values.length;e++)u[e]=[n.values[e][t],n.values[e][0]];r.push({target:o,datapoints:u})}}),r)},e.prototype._getSeriesName=function(e,t){var a=e.name.split(".");return this.alias.replace(/\$(\w+)|\[\[([\s\S]+?)\]\]/g,function(r,n,i){var s=n||i,o=parseInt(s,10);if("m"===s||"measurement"===s)return e.name;if("col"===s)return e.columns[t];if(!isNaN(o))return a[o];if(0!==s.indexOf("tag_"))return r;var l=s.replace("tag_","");return e.tags?e.tags[l]:r})},e.prototype.getAnnotations=function(){var e=this,t=[];return D.a.each(this.series,function(a){var r=null,n=null,i=[],s=null;D.a.each(a.columns,function(t,a){"time"!==t?"sequence_number"!==t&&(r||(r=a),t!==e.annotation.titleColumn?D.a.includes((e.annotation.tagsColumn||"").replace(" ","").split(","),t)?i.push(a):t!==e.annotation.textColumn||(s=a):r=a):n=a}),D.a.each(a.values,function(a){var o={annotation:e.annotation,time:+new Date(a[n]),title:a[r],tags:D.a.flatten(i.filter(function(e){return a[e]}).map(function(e){return a[e].split(",")})),text:a[s]};t.push(o)})}),t},e.prototype.getTable=function(){var e,t,a=new lt.a;return 0===this.series.length?a:(D.a.each(this.series,function(r,n){if(0===n)for(t=0,"time"===r.columns[0]&&(a.columns.push({text:"Time",type:"time"}),t++),D.a.each(D.a.keys(r.tags),function(e){a.columns.push({text:e})});t<r.columns.length;t++)a.columns.push({text:r.columns[t]});if(r.values)for(e=0;e<r.values.length;e++){var i=r.values[e],s=[i[0]];if(r.tags)for(var o in r.tags)r.tags.hasOwnProperty(o)&&s.push(r.tags[o]);for(t=1;t<i.length;t++)s.push(i[t]);a.rows.push(s)}}),a)},e}(),Ja=[],Xa={Aggregations:[],Selectors:[],Transformations:[],Predictors:[],Math:[],Aliasing:[],Fields:[]};function Za(e){var t=Ja[e.type];if(!t)throw{message:"Could not find query part "+e.type};return new Ge.a(e,t)}function er(e){Ja[e.type]=new Ge.b(e),e.category.push(Ja[e.type])}var tr=[];function ar(e,t){return"*"===e.params[0]?"*":'"'+e.params[0]+'"'}function rr(e,t){for(var a=0;a<e.length;a++){var r=e[a];if(r.def.category===Xa.Aggregations){if(r.def.type===t.def.type)return;if("count"===r.def.type&&"distinct"===t.def.type)break;if("distinct"===r.def.type){var n=e.length>=a+2;if("count"!==t.def.type&&n)e[a+1].def.category===Xa.Aggregations&&e.splice(a+1,1);else if("count"===t.def.type)return void(n&&"count"===e[a+1].def.type||e.splice(a+1,0,t))}return void(e[a]=t)}if(r.def.category===Xa.Selectors)return void(e[a]=t)}e.splice(1,0,t)}function nr(e,t){var a;for(a=0;a<e.length;a++){var r=e[a];if(r.def.category===Xa.Math||r.def.category===Xa.Aliasing)break}e.splice(a,0,t)}er({type:"field",addStrategy:function(e,t,a){var r=D.a.map(e,function(e){return Za({type:e.def.type,params:D.a.clone(e.params)})});a.selectModels.push(r)},category:Xa.Fields,params:[{type:"field",dynamicLookup:!0}],defaultParams:["value"],renderer:ar}),er({type:"count",addStrategy:rr,category:Xa.Aggregations,params:[],defaultParams:[],renderer:Ge.c}),er({type:"distinct",addStrategy:rr,category:Xa.Aggregations,params:[],defaultParams:[],renderer:Ge.c}),er({type:"integral",addStrategy:rr,category:Xa.Aggregations,params:[],defaultParams:[],renderer:Ge.c}),er({type:"mean",addStrategy:rr,category:Xa.Aggregations,params:[],defaultParams:[],renderer:Ge.c}),er({type:"median",addStrategy:rr,category:Xa.Aggregations,params:[],defaultParams:[],renderer:Ge.c}),er({type:"mode",addStrategy:rr,category:Xa.Aggregations,params:[],defaultParams:[],renderer:Ge.c}),er({type:"sum",addStrategy:rr,category:Xa.Aggregations,params:[],defaultParams:[],renderer:Ge.c}),er({type:"derivative",addStrategy:nr,category:Xa.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:Ge.c}),er({type:"spread",addStrategy:nr,category:Xa.Transformations,params:[],defaultParams:[],renderer:Ge.c}),er({type:"non_negative_derivative",addStrategy:nr,category:Xa.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:Ge.c}),er({type:"difference",addStrategy:nr,category:Xa.Transformations,params:[],defaultParams:[],renderer:Ge.c}),er({type:"non_negative_difference",addStrategy:nr,category:Xa.Transformations,params:[],defaultParams:[],renderer:Ge.c}),er({type:"moving_average",addStrategy:nr,category:Xa.Transformations,params:[{name:"window",type:"int",options:[5,10,20,30,40]}],defaultParams:[10],renderer:Ge.c}),er({type:"cumulative_sum",addStrategy:nr,category:Xa.Transformations,params:[],defaultParams:[],renderer:Ge.c}),er({type:"stddev",addStrategy:nr,category:Xa.Transformations,params:[],defaultParams:[],renderer:Ge.c}),er({type:"time",category:tr,params:[{name:"interval",type:"time",options:["$__interval","1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["$__interval"],renderer:Ge.c}),er({type:"fill",category:tr,params:[{name:"fill",type:"string",options:["none","null","0","previous","linear"]}],defaultParams:["null"],renderer:Ge.c}),er({type:"elapsed",addStrategy:nr,category:Xa.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:Ge.c}),er({type:"holt_winters",addStrategy:nr,category:Xa.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:Ge.c}),er({type:"holt_winters_with_fit",addStrategy:nr,category:Xa.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:Ge.c}),er({type:"bottom",addStrategy:rr,category:Xa.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:Ge.c}),er({type:"first",addStrategy:rr,category:Xa.Selectors,params:[],defaultParams:[],renderer:Ge.c}),er({type:"last",addStrategy:rr,category:Xa.Selectors,params:[],defaultParams:[],renderer:Ge.c}),er({type:"max",addStrategy:rr,category:Xa.Selectors,params:[],defaultParams:[],renderer:Ge.c}),er({type:"min",addStrategy:rr,category:Xa.Selectors,params:[],defaultParams:[],renderer:Ge.c}),er({type:"percentile",addStrategy:rr,category:Xa.Selectors,params:[{name:"nth",type:"int"}],defaultParams:[95],renderer:Ge.c}),er({type:"top",addStrategy:rr,category:Xa.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:Ge.c}),er({type:"tag",category:tr,params:[{name:"tag",type:"string",dynamicLookup:!0}],defaultParams:["tag"],renderer:ar}),er({type:"math",addStrategy:function(e,t){var a=e.length;if(a>0){if("math"===e[a-1].def.type)return void(e[a-1]=t);if(a>1&&"math"===e[a-2].def.type)return void(e[a-2]=t);if("alias"===e[a-1].def.type)return void e.splice(a-1,0,t)}e.push(t)},category:Xa.Math,params:[{name:"expr",type:"string"}],defaultParams:[" / 100"],renderer:Ge.d}),er({type:"alias",addStrategy:function(e,t){var a=e.length;a>0&&"alias"===e[a-1].def.type?e[a-1]=t:e.push(t)},category:Xa.Aliasing,params:[{name:"name",type:"string",quote:"double"}],defaultParams:["alias"],renderMode:"suffix",renderer:function(e,t){return t+' AS "'+e.params[0]+'"'}});var ir={create:Za,getCategories:function(){return Xa},replaceAggregationAdd:rr},sr=function(){function e(e,t,a){this.target=e,this.templateSrv=t,this.scopedVars=a,e.policy=e.policy||"default",e.resultFormat=e.resultFormat||"time_series",e.orderByTime=e.orderByTime||"ASC",e.tags=e.tags||[],e.groupBy=e.groupBy||[{type:"time",params:["$__interval"]},{type:"fill",params:["null"]}],e.select=e.select||[[{type:"field",params:["value"]},{type:"mean",params:[]}]],this.updateProjection()}return e.$inject=["target","templateSrv","scopedVars"],e.prototype.updateProjection=function(){this.selectModels=D.a.map(this.target.select,function(e){return D.a.map(e,ir.create)}),this.groupByParts=D.a.map(this.target.groupBy,ir.create)},e.prototype.updatePersistedParts=function(){this.target.select=D.a.map(this.selectModels,function(e){return D.a.map(e,function(e){return{type:e.def.type,params:e.params}})})},e.prototype.hasGroupByTime=function(){return D.a.find(this.target.groupBy,function(e){return"time"===e.type})},e.prototype.hasFill=function(){return D.a.find(this.target.groupBy,function(e){return"fill"===e.type})},e.prototype.addGroupBy=function(e){var t=e.match(/^(\w+)\((.*)\)$/),a=t[1],r=t[2],n=ir.create({type:a,params:[r]}),i=this.target.groupBy.length;0===i?this.target.groupBy.push(n.part):"time"===a?this.target.groupBy.splice(0,0,n.part):"tag"===a&&"fill"===this.target.groupBy[i-1].type?this.target.groupBy.splice(i-1,0,n.part):this.target.groupBy.push(n.part),this.updateProjection()},e.prototype.removeGroupByPart=function(e,t){var a=ir.getCategories();"time"===e.def.type&&(this.target.groupBy=D.a.filter(this.target.groupBy,function(e){return"fill"!==e.type}),this.target.select=D.a.map(this.target.select,function(e){return D.a.filter(e,function(e){var t=ir.create(e);return t.def.category!==a.Aggregations&&t.def.category!==a.Selectors})})),this.target.groupBy.splice(t,1),this.updateProjection()},e.prototype.removeSelect=function(e){this.target.select.splice(e,1),this.updateProjection()},e.prototype.removeSelectPart=function(e,t){if("field"===t.def.type){if(this.selectModels.length>1){var a=D.a.indexOf(this.selectModels,e);this.selectModels.splice(a,1)}}else{var r=D.a.indexOf(e,t);e.splice(r,1)}this.updatePersistedParts()},e.prototype.addSelectPart=function(e,t){var a=ir.create({type:t});a.def.addStrategy(e,a,this),this.updatePersistedParts()},e.prototype.renderTagCondition=function(e,t,a){var r="",n=e.operator,i=e.value;return t>0&&(r=(e.condition||"AND")+" "),n||(n=/^\/.*\/$/.test(i)?"=~":"="),"=~"!==n&&"!~"!==n?(a&&(i=this.templateSrv.replace(i,this.scopedVars)),">"!==n&&"<"!==n&&(i="'"+i.replace(/\\/g,"\\\\")+"'")):a&&(i=this.templateSrv.replace(i,this.scopedVars,"regex")),r+'"'+e.key+'" '+n+" "+i},e.prototype.getMeasurementAndPolicy=function(e){var t=this.target.policy,a=this.target.measurement||"measurement";return a.match("^/.*/$")?e&&(a=this.templateSrv.replace(a,this.scopedVars,"regex")):a='"'+a+'"',(t="default"!==t?'"'+this.target.policy+'".':"")+a},e.prototype.interpolateQueryStr=function(e,t,a){return t.multi||t.includeAll?"string"==typeof e?A.a.regexEscape(e):"("+D.a.map(e,A.a.regexEscape).join("|")+")":e},e.prototype.render=function(e){var t=this,a=this.target;if(a.rawQuery)return e?this.templateSrv.replace(a.query,this.scopedVars,this.interpolateQueryStr):a.query;var r,n,i="SELECT ";for(r=0;r<this.selectModels.length;r++){var s=this.selectModels[r],o="";for(n=0;n<s.length;n++){o=s[n].render(o)}r>0&&(i+=", "),i+=o}i+=" FROM "+this.getMeasurementAndPolicy(e)+" WHERE ";var l=D.a.map(a.tags,function(a,r){return t.renderTagCondition(a,r,e)});l.length>0&&(i+="("+l.join(" ")+") AND "),i+="$timeFilter";var u="";for(r=0;r<this.groupByParts.length;r++){var c=this.groupByParts[r];r>0&&(u+="fill"===c.def.type?" ":", "),u+=c.render("")}return u.length&&(i+=" GROUP BY "+u),a.fill&&(i+=" fill("+a.fill+")"),"DESC"===a.orderByTime&&(i+=" ORDER BY time DESC"),a.limit&&(i+=" LIMIT "+a.limit),a.slimit&&(i+=" SLIMIT "+a.slimit),i},e.prototype.renderAdhocFilters=function(e){var t=this;return D.a.map(e,function(e,a){return t.renderTagCondition(e,a,!1)}).join(" ")},e}(),or=function(){function e(){}return e.prototype.parse=function(e,t){if(!t||0===t.results.length)return[];var a=t.results[0];if(!a.series)return[];var r=e.toLowerCase(),n=r.indexOf("show field keys")>=0||r.indexOf("show retention policies")>=0,i={};return D.a.each(a.series,function(e){D.a.each(e.values,function(e){D.a.isArray(e)?n?lr(i,e[0]):void 0!==e[1]?lr(i,e[1]):lr(i,e[0]):lr(i,e)})}),D.a.map(i,function(e){return{text:e.toString()}})},e}();function lr(e,t){e[t]=t}var ur,cr=function(){function e(e,t){this.target=e,this.database=t}return e.prototype.buildExploreQuery=function(e,t,a){var r,n,i;if("TAG_KEYS"===e)r="SHOW TAG KEYS",n=this.target.measurement,i=this.target.policy;else if("TAG_VALUES"===e)r="SHOW TAG VALUES",n=this.target.measurement,i=this.target.policy;else if("MEASUREMENTS"===e)r="SHOW MEASUREMENTS",a&&(r+=" WITH MEASUREMENT =~ /"+a+"/");else{if("FIELDS"===e)return n=this.target.measurement,i=this.target.policy,n.match("^/.*/")||(n='"'+n+'"',i&&"default"!==i&&(n=(i='"'+i+'"')+"."+n)),"SHOW FIELD KEYS FROM "+n;if("RETENTION POLICIES"===e)return r='SHOW RETENTION POLICIES on "'+this.database+'"'}if(n&&(n.match("^/.*/")||n.match(/^merge\(.*\)/)||(n='"'+n+'"'),i&&"default"!==i&&(n=(i='"'+i+'"')+"."+n),r+=" FROM "+n),t&&(r+=' WITH KEY = "'+t+'"'),this.target.tags&&this.target.tags.length>0){var s=D.a.reduce(this.target.tags,function(e,a){return a.key===t?e:(e.push(function(e,t){var a="",r=e.operator,n=e.value;return t>0&&(a=(e.condition||"AND")+" "),r||(r=/^\/.*\/$/.test(e.value)?"=~":"="),"=~"!==r&&"!~"!==r&&isNaN(+n)&&(n="'"+n+"'"),a+'"'+e.key+'" '+r+" "+n}(a,e.length)),e)},[]);s.length>0&&(r+=" WHERE "+s.join(" "))}return"MEASUREMENTS"===e&&(r+=" LIMIT 100"),r},e}(),dr=function(){function e(e,t,a,r){this.$q=t,this.backendSrv=a,this.templateSrv=r,this.type="influxdb",this.urls=D.a.map(e.url.split(","),function(e){return e.trim()}),this.username=e.username,this.password=e.password,this.name=e.name,this.database=e.database,this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.interval=(e.jsonData||{}).timeInterval,this.supportAnnotations=!0,this.supportMetrics=!0,this.responseParser=new or}return e.$inject=["instanceSettings","$q","backendSrv","templateSrv"],e.prototype.query=function(e){var t,a,r,n=this,i=this.getTimeFilter(e),s=e.scopedVars,o=D.a.cloneDeep(e.targets),l=[],u=D.a.map(o,function(e){return e.hide?"":(l.push(e),s.interval=s.__interval,(t=new sr(e,n.templateSrv,s)).render(!0))}).reduce(function(e,t){return""!==t&&(e+=";"+t),e});if(""===u)return this.$q.when({data:[]});var c=this.templateSrv.getAdhocFilters(this.name);return c.length>0&&(i+=" AND "+t.renderAdhocFilters(c)),s.timeFilter={value:i},u=this.templateSrv.replace(u,s),this._seriesQuery(u,e).then(function(t){if(!t||!t.results)return[];var i=[];for(a=0;a<t.results.length;a++){var s=t.results[a];if(s&&s.series){var o=l[a],u=o.alias;u&&(u=n.templateSrv.replace(o.alias,e.scopedVars));var c=new Ka({series:t.results[a].series,alias:u});switch(o.resultFormat){case"table":i.push(c.getTable());break;default:var d=c.getTimeSeries();for(r=0;r<d.length;r++)i.push(d[r])}}}return{data:i}})},e.prototype.annotationQuery=function(e){if(!e.annotation.query)return this.$q.reject({message:"Query missing in annotation definition"});var t=this.getTimeFilter({rangeRaw:e.rangeRaw}),a=e.annotation.query.replace("$timeFilter",t);return a=this.templateSrv.replace(a,null,"regex"),this._seriesQuery(a,e).then(function(t){if(!t||!t.results||!t.results[0])throw{message:"No results in response from InfluxDB"};return new Ka({series:t.results[0].series,annotation:e.annotation}).getAnnotations()})},e.prototype.targetContainsTemplate=function(e){for(var t=0,a=e.groupBy;t<a.length;t++)for(var r=0,n=a[t].params;r<n.length;r++){var i=n[r];if(this.templateSrv.variableExists(i))return!0}for(var s in e.tags)if(this.templateSrv.variableExists(e.tags[s].value))return!0;return!1},e.prototype.metricFindQuery=function(e,t){var a=this.templateSrv.replace(e,null,"regex");return this._seriesQuery(a,t).then(D.a.curry(this.responseParser.parse)(e))},e.prototype.getTagKeys=function(e){var t=new cr({measurement:"",tags:[]},this.database).buildExploreQuery("TAG_KEYS");return this.metricFindQuery(t,e)},e.prototype.getTagValues=function(e){var t=new cr({measurement:"",tags:[]},this.database).buildExploreQuery("TAG_VALUES",e.key);return this.metricFindQuery(t,e)},e.prototype._seriesQuery=function(e,t){return e?this._influxRequest("GET","/query",{q:e,epoch:"ms"},t):this.$q.when({results:[]})},e.prototype.serializeParams=function(e){return e?D.a.reduce(e,function(e,t,a){return null===t||void 0===t?e:(e.push(encodeURIComponent(a)+"="+encodeURIComponent(t)),e)},[]).join("&"):""},e.prototype.testDatasource=function(){var e=new cr({measurement:"",tags:[]},this.database).buildExploreQuery("RETENTION POLICIES");return this._seriesQuery(e).then(function(e){var t=D.a.get(e,"results[0].error");return t?{status:"error",message:t}:{status:"success",message:"Data source is working"}}).catch(function(e){return{status:"error",message:e.message}})},e.prototype._influxRequest=function(e,t,a,r){var n=this.urls.shift();this.urls.push(n);var i={};this.username&&(i.u=this.username,i.p=this.password),r&&r.database?i.db=r.database:this.database&&(i.db=this.database),"GET"===e&&(D.a.extend(i,a),a=null);var s={method:e,url:n+t,params:i,data:a,precision:"ms",inspect:{type:"influxdb"},paramSerializer:this.serializeParams};return s.headers=s.headers||{},(this.basicAuth||this.withCredentials)&&(s.withCredentials=!0),this.basicAuth&&(s.headers.Authorization=this.basicAuth),this.backendSrv.datasourceRequest(s).then(function(e){return e.data},function(e){if(0!==e.status||e.status>=300)throw e.data&&e.data.error?{message:"InfluxDB Error: "+e.data.error,data:e.data,config:e.config}:{message:"Network Error: "+e.statusText+"("+e.status+")",data:e.data,config:e.config}})},e.prototype.getTimeFilter=function(e){var t=this.getInfluxTime(e.rangeRaw.from,!1),a=this.getInfluxTime(e.rangeRaw.to,!0),r="ms"===t[t.length-1];return"now()"!==a||r?"time >= "+t+" and time <= "+a:"time >= "+t},e.prototype.getInfluxTime=function(e,t){if(D.a.isString(e)){if("now"===e)return"now()";var a=/^now-(\d+)([d|h|m|s])$/.exec(e);if(a)return"now() - "+parseInt(a[1])+a[2];e=Le.parse(e,t)}return e.valueOf()+"ms"},e}(),pr=function(e){function t(t,a,r,n,i){var s=e.call(this,t,a)||this;s.templateSrv=r,s.$q=n,s.uiSegmentSrv=i,s.target=s.target,s.queryModel=new sr(s.target,r,s.panel.scopedVars),s.queryBuilder=new cr(s.target,s.datasource.database),s.groupBySegment=s.uiSegmentSrv.newPlusButton(),s.resultFormats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"}],s.policySegment=i.newSegment(s.target.policy),s.target.measurement?s.measurementSegment=i.newSegment(s.target.measurement):s.measurementSegment=i.newSelectMeasurement(),s.tagSegments=[];for(var o=0,l=s.target.tags;o<l.length;o++){var u=l[o];u.operator||(/^\/.*\/$/.test(u.value)?u.operator="=~":u.operator="="),u.condition&&s.tagSegments.push(i.newCondition(u.condition)),s.tagSegments.push(i.newKey(u.key)),s.tagSegments.push(i.newOperator(u.operator)),s.tagSegments.push(i.newKeyValue(u.value))}return s.fixTagSegments(),s.buildSelectMenu(),s.removeTagFilterSegment=i.newSegment({fake:!0,value:"-- remove tag filter --"}),s}return t.$inject=["$scope","$injector","templateSrv","$q","uiSegmentSrv"],je.d(t,e),t.prototype.removeOrderByTime=function(){this.target.orderByTime="ASC"},t.prototype.buildSelectMenu=function(){var e=ir.getCategories();this.selectMenu=D.a.reduce(e,function(e,t,a){var r={text:a,submenu:t.map(function(e){return{text:e.type,value:e.type}})};return e.push(r),e},[])},t.prototype.getGroupByOptions=function(){var e=this,t=this.queryBuilder.buildExploreQuery("TAG_KEYS");return this.datasource.metricFindQuery(t).then(function(t){var a=[];e.queryModel.hasFill()||a.push(e.uiSegmentSrv.newSegment({value:"fill(null)"})),e.target.limit||a.push(e.uiSegmentSrv.newSegment({value:"LIMIT"})),e.target.slimit||a.push(e.uiSegmentSrv.newSegment({value:"SLIMIT"})),"ASC"===e.target.orderByTime&&a.push(e.uiSegmentSrv.newSegment({value:"ORDER BY time DESC"})),e.queryModel.hasGroupByTime()||a.push(e.uiSegmentSrv.newSegment({value:"time($interval)"}));for(var r=0,n=t;r<n.length;r++){var i=n[r];a.push(e.uiSegmentSrv.newSegment({value:"tag("+i.text+")"}))}return a}).catch(this.handleQueryError.bind(this))},t.prototype.groupByAction=function(){switch(this.groupBySegment.value){case"LIMIT":this.target.limit=10;break;case"SLIMIT":this.target.slimit=10;break;case"ORDER BY time DESC":this.target.orderByTime="DESC";break;default:this.queryModel.addGroupBy(this.groupBySegment.value)}var e=this.uiSegmentSrv.newPlusButton();this.groupBySegment.value=e.value,this.groupBySegment.html=e.html,this.panelCtrl.refresh()},t.prototype.addSelectPart=function(e,t,a){this.queryModel.addSelectPart(e,a.value),this.panelCtrl.refresh()},t.prototype.handleSelectPartEvent=function(e,t,a){switch(a.name){case"get-param-options":var r=this.queryBuilder.buildExploreQuery("FIELDS");return this.datasource.metricFindQuery(r).then(this.transformToSegments(!0)).catch(this.handleQueryError.bind(this));case"part-param-changed":this.panelCtrl.refresh();break;case"action":this.queryModel.removeSelectPart(e,t),this.panelCtrl.refresh();break;case"get-part-actions":return this.$q.when([{text:"Remove",value:"remove-part"}])}},t.prototype.handleGroupByPartEvent=function(e,t,a){switch(a.name){case"get-param-options":var r=this.queryBuilder.buildExploreQuery("TAG_KEYS");return this.datasource.metricFindQuery(r).then(this.transformToSegments(!0)).catch(this.handleQueryError.bind(this));case"part-param-changed":this.panelCtrl.refresh();break;case"action":this.queryModel.removeGroupByPart(e,t),this.panelCtrl.refresh();break;case"get-part-actions":return this.$q.when([{text:"Remove",value:"remove-part"}])}},t.prototype.fixTagSegments=function(){var e=this.tagSegments.length,t=this.tagSegments[Math.max(e-1,0)];t&&"plus-button"===t.type||this.tagSegments.push(this.uiSegmentSrv.newPlusButton())},t.prototype.measurementChanged=function(){this.target.measurement=this.measurementSegment.value,this.panelCtrl.refresh()},t.prototype.getPolicySegments=function(){var e=this.queryBuilder.buildExploreQuery("RETENTION POLICIES");return this.datasource.metricFindQuery(e).then(this.transformToSegments(!1)).catch(this.handleQueryError.bind(this))},t.prototype.policyChanged=function(){this.target.policy=this.policySegment.value,this.panelCtrl.refresh()},t.prototype.toggleEditorMode=function(){try{this.target.query=this.queryModel.render(!1)}catch(e){console.log("query render error")}this.target.rawQuery=!this.target.rawQuery},t.prototype.getMeasurements=function(e){var t=this.queryBuilder.buildExploreQuery("MEASUREMENTS",void 0,e);return this.datasource.metricFindQuery(t).then(this.transformToSegments(!0)).catch(this.handleQueryError.bind(this))},t.prototype.handleQueryError=function(e){return this.error=e.message||"Failed to issue metric query",[]},t.prototype.transformToSegments=function(e){var t=this;return function(a){var r=D.a.map(a,function(e){return t.uiSegmentSrv.newSegment({value:e.text,expandable:e.expandable})});if(e)for(var n=0,i=t.templateSrv.variables;n<i.length;n++){var s=i[n];r.unshift(t.uiSegmentSrv.newSegment({type:"value",value:"/^$"+s.name+"$/",expandable:!0}))}return r}},t.prototype.getTagsOrValues=function(e,t){var a,r,n=this;if("condition"===e.type)return this.$q.when([this.uiSegmentSrv.newSegment("AND"),this.uiSegmentSrv.newSegment("OR")]);if("operator"===e.type){var i=this.tagSegments[t+1].value;return/^\/.*\/$/.test(i)?this.$q.when(this.uiSegmentSrv.newOperators(["=~","!~"])):this.$q.when(this.uiSegmentSrv.newOperators(["=","!=","<>","<",">"]))}return"key"===e.type||"plus-button"===e.type?(a=this.queryBuilder.buildExploreQuery("TAG_KEYS"),r=!1):"value"===e.type&&(a=this.queryBuilder.buildExploreQuery("TAG_VALUES",this.tagSegments[t-2].value),r=!0),this.datasource.metricFindQuery(a).then(this.transformToSegments(r)).then(function(t){return"key"===e.type&&t.splice(0,0,P.a.copy(n.removeTagFilterSegment)),t}).catch(this.handleQueryError.bind(this))},t.prototype.getFieldSegments=function(){var e=this.queryBuilder.buildExploreQuery("FIELDS");return this.datasource.metricFindQuery(e).then(this.transformToSegments(!1)).catch(this.handleQueryError)},t.prototype.tagSegmentUpdated=function(e,t){this.tagSegments[t]=e,e.value===this.removeTagFilterSegment.value?(this.tagSegments.splice(t,3),0===this.tagSegments.length?this.tagSegments.push(this.uiSegmentSrv.newPlusButton()):this.tagSegments.length>2&&(this.tagSegments.splice(Math.max(t-1,0),1),"plus-button"!==this.tagSegments[this.tagSegments.length-1].type&&this.tagSegments.push(this.uiSegmentSrv.newPlusButton()))):("plus-button"===e.type&&(t>2&&this.tagSegments.splice(t,0,this.uiSegmentSrv.newCondition("AND")),this.tagSegments.push(this.uiSegmentSrv.newOperator("=")),this.tagSegments.push(this.uiSegmentSrv.newFake("select tag value","value","query-segment-value")),e.type="key",e.cssClass="query-segment-key"),t+1===this.tagSegments.length&&this.tagSegments.push(this.uiSegmentSrv.newPlusButton())),this.rebuildTargetTagConditions()},t.prototype.rebuildTargetTagConditions=function(){var e=this,t=[],a=0,r="";D.a.each(this.tagSegments,function(n,i){"key"===n.type?(0===t.length&&t.push({}),t[a].key=n.value):"value"===n.type?((r=e.getTagValueOperator(n.value,t[a].operator))&&(e.tagSegments[i-1]=e.uiSegmentSrv.newOperator(r),t[a].operator=r),t[a].value=n.value):"condition"===n.type?(t.push({condition:n.value}),a+=1):"operator"===n.type&&(t[a].operator=n.value)}),this.target.tags=t,this.panelCtrl.refresh()},t.prototype.getTagValueOperator=function(e,t){return"=~"!==t&&"!~"!==t&&/^\/.*\/$/.test(e)?"=~":"=~"!==t&&"!~"!==t||!/^(?!\/.*\/$)/.test(e)?null:"="},t.prototype.getCollapsedText=function(){return this.queryModel.render(!1)},t.templateUrl="partials/query.editor.html",t}(Ye),hr=function(){function e(){}return e.templateUrl="partials/config.html",e}(),mr=function(){function e(){}return e.templateUrl="partials/annotations.editor.html",e}();function fr(e,t){var a=e.line,r=e.timestamp,n="EK"+r+t.labels,i=Y()(r),s=i.fromNow(),o=i.format("YYYY-MM-DD HH:mm:ss"),l=function(e,t){if(!e||!t)return[];for(var a,r=new RegExp("(?:"+t+")","g"),n=[];a=r.exec(e);)n.push({text:a[0],start:a.index,length:a[0].length});return n}(a,t.search);return{key:n,logLevel:function(e){var t;if(e)return Object.keys(ur).forEach(function(a){t||new RegExp("\\b"+a+"\\b","i").test(e)&&(t=ur[a])}),t}(a),searchMatches:l,timeFromNow:s,timeLocal:o,entry:a,timestamp:r}}!function(e){e.crit="crit",e.warn="warn",e.err="error",e.error="error",e.info="info",e.debug="debug",e.trace="trace"}(ur||(ur={}));var gr={direction:"BACKWARD",limit:100,regexp:"",query:""},vr=/({\w+="[^"]+"})?\s*(\w[^{]+)?\s*({\w+="[^"]+"})?/;var yr=function(){function e(e,t,a){this.instanceSettings=e,this.backendSrv=t,this.templateSrv=a}return e.$inject=["instanceSettings","backendSrv","templateSrv"],e.prototype._request=function(e,t,a){var r=""+this.instanceSettings.url+e+"?"+(t?function(e){return Object.keys(e).map(function(t){var a=e[t];return encodeURIComponent(t)+"="+encodeURIComponent(a)}).join("&")}(t):""),n=je.a({},a,{url:r});return this.backendSrv.datasourceRequest(n)},e.prototype.prepareQueryTarget=function(e,t){var a=this.templateSrv.replace(e.expr),r=this.getTime(t.range.from,!1),n=this.getTime(t.range.to,!0);return je.a({},gr,function(e){var t=e.match(vr),a="",r="";return t&&(t[1]&&(a=t[1]),t[2]&&(r=t[2].trim()),t[3]&&(a=t[1]?t[1].slice(0,-1)+","+t[3].slice(1):t[3])),{query:a,regexp:r}}(a),{start:r,end:n})},e.prototype.query=function(e){var t=this,a=e.targets.filter(function(e){return e.expr}).map(function(a){return t.prepareQueryTarget(a,e)});if(0===a.length)return Promise.resolve({data:[]});var r=a.map(function(e){return t._request("/api/prom/query",e)});return Promise.all(r).then(function(e){return{data:function(e,t){var a=e.reduce(function(e,t){return e.concat(t.entries.map(function(e){return fr(e,t)}))},[]);return{rows:D.a.chain(a).sortBy("timestamp").reverse().slice(0,t||a.length).value()}}(e.reduce(function(e,t,r){var n=t.data.streams||[],i=a[r].regexp;return n.forEach(function(e){e.search=i}),e.concat(n)},[]),100)}})},e.prototype.metadataRequest=function(e){var t=e.replace("v1","prom");return this._request(t,{silent:!0}).then(function(e){return{data:{data:e.data.values||[]}}})},e.prototype.getTime=function(e,t){return D.a.isString(e)&&(e=Le.parse(e,t)),Math.ceil(1e6*e.valueOf())},e.prototype.testDatasource=function(){return this._request("/api/prom/label").then(function(e){return e&&e.data&&e.data.values&&e.data.values.length>0?{status:"success",message:"Data source connected and labels found."}:{status:"error",message:"Data source connected, but no labels received. Verify that logging is configured properly."}}).catch(function(e){return{status:"error",message:e.message}})},e}(),br=function(){function e(){}return e.templateUrl="partials/config.html",e}(),Sr=function(){function e(e,t){this.$q=e,this.datasourceSrv=t}return e.$inject=["$q","datasourceSrv"],e.prototype.query=function(e){var t=this,a=D.a.groupBy(e.targets,"datasource"),r=D.a.map(a,function(a){var r=a[0].datasource;return"-- Mixed --"===r?t.$q([]):t.datasourceSrv.get(r).then(function(t){var r=P.a.copy(e);return r.targets=a,t.query(r)})});return this.$q.all(r).then(function(e){return{data:D.a.flatten(D.a.map(e,"data"))}})},e}(),xr=function(){function e(e){this.$q=e}return e.prototype.processQueryResult=function(e){var t=[];if(!e.data.results)return{data:t};for(var a in e.data.results){var r=e.data.results[a];if(r.series)for(var n=0,i=r.series;n<i.length;n++){var s=i[n];t.push({target:s.name,datapoints:s.points,refId:r.refId,meta:r.meta})}if(r.tables)for(var o=0,l=r.tables;o<l.length;o++){var u=l[o];u.type="table",u.refId=r.refId,u.meta=r.meta,t.push(u)}}return{data:t}},e.prototype.parseMetricFindQueryResult=function(e,t){if(!t||0===t.data.length||0===t.data.results[e].meta.rowCount)return[];var a=t.data.results[e].tables[0].columns,r=t.data.results[e].tables[0].rows,n=this.findColIndex(a,"__text"),i=this.findColIndex(a,"__value");return 2===a.length&&-1!==n&&-1!==i?this.transformToKeyValueList(r,n,i):this.transformToSimpleList(r)},e.prototype.transformToKeyValueList=function(e,t,a){for(var r=[],n=0;n<e.length;n++)this.containsKey(r,e[n][t])||r.push({text:e[n][t],value:e[n][a]});return r},e.prototype.transformToSimpleList=function(e){for(var t=[],a=0;a<e.length;a++)for(var r=0;r<e[a].length;r++){var n=e[a][r];-1===t.indexOf(n)&&t.push(n)}return D.a.map(t,function(e){return{text:e}})},e.prototype.findColIndex=function(e,t){for(var a=0;a<e.length;a++)if(e[a].text===t)return a;return-1},e.prototype.containsKey=function(e,t){for(var a=0;a<e.length;a++)if(e[a].text===t)return!0;return!1},e.prototype.transformAnnotationResponse=function(e,t){for(var a=t.data.results[e.annotation.name].tables[0],r=-1,n=-1,i=-1,s=0;s<a.columns.length;s++)if("time_sec"===a.columns[s].text||"time"===a.columns[s].text)r=s;else{if("title"===a.columns[s].text)return this.$q.reject({message:"The title column for annotations is deprecated, now only a column named text is returned"});"text"===a.columns[s].text?n=s:"tags"===a.columns[s].text&&(i=s)}if(-1===r)return this.$q.reject({message:"Missing mandatory time column (with time_sec column alias) in annotation query."});var o=[];for(s=0;s<a.rows.length;s++){var l=a.rows[s];o.push({annotation:e.annotation,time:Math.floor(l[r]),text:l[n]?l[n].toString():"",tags:l[i]?l[i].trim().split(/\s*,\s*/):[]})}return o},e}(),wr=function(){function e(e,t,a,r){this.backendSrv=t,this.$q=a,this.templateSrv=r,this.name=e.name,this.id=e.id,this.responseParser=new xr(this.$q)}return e.$inject=["instanceSettings","backendSrv","$q","templateSrv"],e.prototype.interpolateVariable=function(e,t){return"string"==typeof e?t.multi||t.includeAll?"'"+e.replace(/'/g,"''")+"'":e:"number"==typeof e?e:D.a.map(e,function(t){return"number"==typeof e?e:"'"+t.replace(/'/g,"''")+"'"}).join(",")},e.prototype.query=function(e){var t=this,a=D.a.filter(e.targets,function(e){return!0!==e.hide}).map(function(a){return{refId:a.refId,intervalMs:e.intervalMs,maxDataPoints:e.maxDataPoints,datasourceId:t.id,rawSql:t.templateSrv.replace(a.rawSql,e.scopedVars,t.interpolateVariable),format:a.format}});return 0===a.length?this.$q.when({data:[]}):this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:a}}).then(this.responseParser.processQueryResult)},e.prototype.annotationQuery=function(e){var t=this;if(!e.annotation.rawQuery)return this.$q.reject({message:"Query missing in annotation definition"});var a={refId:e.annotation.name,datasourceId:this.id,rawSql:this.templateSrv.replace(e.annotation.rawQuery,e.scopedVars,this.interpolateVariable),format:"table"};return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:[a]}}).then(function(a){return t.responseParser.transformAnnotationResponse(e,a)})},e.prototype.metricFindQuery=function(e,t){var a=this,r="tempvar";t&&t.variable&&t.variable.name&&(r=t.variable.name);var n={queries:[{refId:r,datasourceId:this.id,rawSql:this.templateSrv.replace(e,{},this.interpolateVariable),format:"table"}]};return t&&t.range&&t.range.from&&(n.from=t.range.from.valueOf().toString()),t&&t.range&&t.range.to&&(n.to=t.range.to.valueOf().toString()),this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:n}).then(function(e){return a.responseParser.parseMetricFindQueryResult(r,e)})},e.prototype.testDatasource=function(){return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:"5m",to:"now",queries:[{refId:"A",intervalMs:1,maxDataPoints:1,datasourceId:this.id,rawSql:"SELECT 1",format:"table"}]}}).then(function(e){return{status:"success",message:"Database Connection OK"}}).catch(function(e){return console.log(e),e.data&&e.data.message?{status:"error",message:e.data.message}:{status:"error",message:e.status}})},e}(),kr="SELECT\n  UNIX_TIMESTAMP(<time_column>) as time_sec,\n  <value column> as value,\n  <series name column> as metric\nFROM <table name>\nWHERE $__timeFilter(time_column)\nORDER BY <time_column> ASC\n",Cr=function(e){function t(t,a){var r=e.call(this,t,a)||this;return r.target.format=r.target.format||"time_series",r.target.alias="",r.formats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"}],r.target.rawSql||("table"===r.panelCtrl.panel.type?(r.target.format="table",r.target.rawSql="SELECT 1"):r.target.rawSql=kr),r.panelCtrl.events.on("data-received",r.onDataReceived.bind(r),t),r.panelCtrl.events.on("data-error",r.onDataError.bind(r),t),r}return t.$inject=["$scope","$injector"],je.d(t,e),t.prototype.onDataReceived=function(e){this.lastQueryMeta=null,this.lastQueryError=null;var t=D.a.find(e,{refId:this.target.refId});t&&(this.lastQueryMeta=t.meta)},t.prototype.onDataError=function(e){if(e.data&&e.data.results){var t=e.data.results[this.target.refId];t&&(this.lastQueryMeta=t.meta,this.lastQueryError=t.error)}},t.templateUrl="partials/query.editor.html",t}(Ye),Tr=function(){function e(){}return e.templateUrl="partials/config.html",e}(),_r="SELECT\n    UNIX_TIMESTAMP(<time_column>) as time_sec,\n    <text_column> as text,\n    <tags_column> as tags\n  FROM <table name>\n  WHERE $__timeFilter(time_column)\n  ORDER BY <time_column> ASC\n  LIMIT 100\n  ",Mr=function(){function e(){this.annotation.rawQuery=this.annotation.rawQuery||_r}return e.templateUrl="partials/annotations.editor.html",e}(),$r=function(){function e(e){this.$q=e}return e.prototype.processQueryResult=function(e){var t=[];if(!e.data.results)return{data:t};for(var a in e.data.results){var r=e.data.results[a];if(r.series)for(var n=0,i=r.series;n<i.length;n++){var s=i[n];t.push({target:s.name,datapoints:s.points,refId:r.refId,meta:r.meta})}if(r.tables)for(var o=0,l=r.tables;o<l.length;o++){var u=l[o];u.type="table",u.refId=r.refId,u.meta=r.meta,t.push(u)}}return{data:t}},e.prototype.parseMetricFindQueryResult=function(e,t){if(!t||0===t.data.length||0===t.data.results[e].meta.rowCount)return[];var a=t.data.results[e].tables[0].columns,r=t.data.results[e].tables[0].rows,n=this.findColIndex(a,"__text"),i=this.findColIndex(a,"__value");return 2===a.length&&-1!==n&&-1!==i?this.transformToKeyValueList(r,n,i):this.transformToSimpleList(r)},e.prototype.transformToKeyValueList=function(e,t,a){for(var r=[],n=0;n<e.length;n++)this.containsKey(r,e[n][t])||r.push({text:e[n][t],value:e[n][a]});return r},e.prototype.transformToSimpleList=function(e){for(var t=[],a=0;a<e.length;a++)for(var r=0;r<e[a].length;r++){var n=e[a][r];-1===t.indexOf(n)&&t.push(n)}return D.a.map(t,function(e){return{text:e}})},e.prototype.findColIndex=function(e,t){for(var a=0;a<e.length;a++)if(e[a].text===t)return a;return-1},e.prototype.containsKey=function(e,t){for(var a=0;a<e.length;a++)if(e[a].text===t)return!0;return!1},e.prototype.transformAnnotationResponse=function(e,t){for(var a=t.data.results[e.annotation.name].tables[0],r=-1,n=-1,i=-1,s=0;s<a.columns.length;s++)"time"===a.columns[s].text?r=s:"text"===a.columns[s].text?n=s:"tags"===a.columns[s].text&&(i=s);if(-1===r)return this.$q.reject({message:"Missing mandatory time column in annotation query."});var o=[];for(s=0;s<a.rows.length;s++){var l=a.rows[s];o.push({annotation:e.annotation,time:Math.floor(l[r]),title:l[-1],text:l[n],tags:l[i]?l[i].trim().split(/\s*,\s*/):[]})}return o},e}(),Pr=function(){function e(e,t,a,r){this.backendSrv=t,this.$q=a,this.templateSrv=r,this.name=e.name,this.id=e.id,this.responseParser=new $r(this.$q)}return e.$inject=["instanceSettings","backendSrv","$q","templateSrv"],e.prototype.interpolateVariable=function(e,t){return"string"==typeof e?t.multi||t.includeAll?"'"+e.replace(/'/g,"''")+"'":e:"number"==typeof e?e:D.a.map(e,function(e){return"'"+e.replace(/'/g,"''")+"'"}).join(",")},e.prototype.query=function(e){var t=this,a=D.a.filter(e.targets,function(e){return!0!==e.hide}).map(function(a){return{refId:a.refId,intervalMs:e.intervalMs,maxDataPoints:e.maxDataPoints,datasourceId:t.id,rawSql:t.templateSrv.replace(a.rawSql,e.scopedVars,t.interpolateVariable),format:a.format}});return 0===a.length?this.$q.when({data:[]}):this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:a}}).then(this.responseParser.processQueryResult)},e.prototype.annotationQuery=function(e){var t=this;if(!e.annotation.rawQuery)return this.$q.reject({message:"Query missing in annotation definition"});var a={refId:e.annotation.name,datasourceId:this.id,rawSql:this.templateSrv.replace(e.annotation.rawQuery,e.scopedVars,this.interpolateVariable),format:"table"};return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:[a]}}).then(function(a){return t.responseParser.transformAnnotationResponse(e,a)})},e.prototype.metricFindQuery=function(e,t){var a=this,r="tempvar";t&&t.variable&&t.variable.name&&(r=t.variable.name);var n={queries:[{refId:r,datasourceId:this.id,rawSql:this.templateSrv.replace(e,{},this.interpolateVariable),format:"table"}]};return t&&t.range&&t.range.from&&(n.from=t.range.from.valueOf().toString()),t&&t.range&&t.range.to&&(n.to=t.range.to.valueOf().toString()),this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:n}).then(function(e){return a.responseParser.parseMetricFindQueryResult(r,e)})},e.prototype.testDatasource=function(){return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:"5m",to:"now",queries:[{refId:"A",intervalMs:1,maxDataPoints:1,datasourceId:this.id,rawSql:"SELECT 1",format:"table"}]}}).then(function(e){return{status:"success",message:"Database Connection OK"}}).catch(function(e){return console.log(e),e.data&&e.data.message?{status:"error",message:e.data.message}:{status:"error",message:e.status}})},e}(),Er="SELECT\n  $__time(time_column),\n  value1\nFROM\n  metric_table\nWHERE\n  $__timeFilter(time_column)\n",Dr=function(e){function t(t,a){var r=e.call(this,t,a)||this;return r.target.format=r.target.format||"time_series",r.target.alias="",r.formats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"}],r.target.rawSql||("table"===r.panelCtrl.panel.type?(r.target.format="table",r.target.rawSql="SELECT 1"):r.target.rawSql=Er),r.panelCtrl.events.on("data-received",r.onDataReceived.bind(r),t),r.panelCtrl.events.on("data-error",r.onDataError.bind(r),t),r}return t.$inject=["$scope","$injector"],je.d(t,e),t.prototype.onDataReceived=function(e){this.lastQueryMeta=null,this.lastQueryError=null;var t=D.a.find(e,{refId:this.target.refId});t&&(this.lastQueryMeta=t.meta)},t.prototype.onDataError=function(e){if(e.data&&e.data.results){var t=e.data.results[this.target.refId];t&&(this.lastQueryMeta=t.meta,this.lastQueryError=t.error)}},t.templateUrl="partials/query.editor.html",t}(Ye),Ar=function(){function e(e){this.current.jsonData.sslmode=this.current.jsonData.sslmode||"verify-full"}return e.$inject=["$scope"],e.templateUrl="partials/config.html",e}(),Fr="SELECT\n  extract(epoch from time_column) AS time,\n  text_column as text,\n  tags_column as tags\nFROM\n  metric_table\nWHERE\n  $__timeFilter(time_column)\n",Ir=function(){function e(){this.annotation.rawQuery=this.annotation.rawQuery||Fr}return e.templateUrl="partials/annotations.editor.html",e}(),Or=function(){function e(e,t,a){this.datasource=e,this.query=t,this.range=a.timeRange()}return e.prototype.process=function(){var e=this.query.match(/^label_values\((?:(.+),\s*)?([a-zA-Z_][a-zA-Z0-9_]+)\)\s*$/);if(e)return e[1]?this.labelValuesQuery(e[2],e[1]):this.labelValuesQuery(e[2],null);var t=this.query.match(/^metrics\((.+)\)\s*$/);if(t)return this.metricNameQuery(t[1]);var a=this.query.match(/^query_result\((.+)\)\s*$/);return a?this.queryResultQuery(a[1]):this.metricNameAndLabelsQuery(this.query)},e.prototype.labelValuesQuery=function(e,t){var a;if(t){var r=this.datasource.getPrometheusTime(this.range.from,!1),n=this.datasource.getPrometheusTime(this.range.to,!0);return a="/api/v1/series?match[]="+encodeURIComponent(t)+"&start="+r+"&end="+n,this.datasource.metadataRequest(a).then(function(t){var a=D.a.map(t.data.data,function(t){return t[e]||""}).filter(function(e){return""!==e});return D.a.uniq(a).map(function(e){return{text:e,expandable:!0}})})}return a="/api/v1/label/"+e+"/values",this.datasource.metadataRequest(a).then(function(e){return D.a.map(e.data.data,function(e){return{text:e}})})},e.prototype.metricNameQuery=function(e){return this.datasource.metadataRequest("/api/v1/label/__name__/values").then(function(t){return D.a.chain(t.data.data).filter(function(t){return new RegExp(e).test(t)}).map(function(e){return{text:e,expandable:!0}}).value()})},e.prototype.queryResultQuery=function(e){var t=this.datasource.getPrometheusTime(this.range.to,!0);return this.datasource.performInstantQuery({expr:e},t).then(function(e){return D.a.map(e.data.data.result,function(e){var t=e.metric.__name__||"";return delete e.metric.__name__,t+="{"+D.a.map(e.metric,function(e,t){return t+'="'+e+'"'}).join(",")+"}",{text:t+=" "+e.value[1]+" "+1e3*e.value[0],expandable:!0}})})},e.prototype.metricNameAndLabelsQuery=function(e){var t=this.datasource.getPrometheusTime(this.range.from,!1),a=this.datasource.getPrometheusTime(this.range.to,!0),r="/api/v1/series?match[]="+encodeURIComponent(e)+"&start="+t+"&end="+a,n=this;return this.datasource.metadataRequest(r).then(function(e){return D.a.map(e.data.data,function(e){return{text:n.datasource.getOriginalMetricName(e),expandable:!0}})})},e}(),qr=function(){function e(e){this.templateSrv=e}return e.prototype.transform=function(e,t,a){var r=t.data.data.result;if("table"===a.format)e.push(this.transformMetricDataToTable(r,a.responseListLength,a.refId));else if("heatmap"===a.format){var n=[];r.sort(Rr);for(var i=0,s=r;i<s.length;i++){var o=s[i];n.push(this.transformMetricData(o,a,a.start,a.end))}n=this.transformToHistogramOverTime(n),e.push.apply(e,n)}else for(var l=0,u=r;l<u.length;l++){o=u[l];"matrix"===t.data.data.resultType?e.push(this.transformMetricData(o,a,a.start,a.end)):"vector"===t.data.data.resultType&&e.push(this.transformInstantMetricData(o,a))}},e.prototype.transformMetricData=function(e,t,a,r){var n,i=[];n=this.createMetricLabel(e.metric,t);var s=1e3*parseInt(t.step),o=1e3*a;if(void 0===e.values)throw new Error("Prometheus heatmap error: data should be a time series");for(var l=0,u=e.values;l<u.length;l++){var c=u[l],d=parseFloat(c[1]);D.a.isNaN(d)&&(d=null);for(var p=1e3*parseFloat(c[0]),h=o;h<p;h+=s)i.push([null,h]);o=p+s,i.push([d,p])}var m=1e3*r;for(h=o;h<=m;h+=s)i.push([null,h]);return{target:n,datapoints:i}},e.prototype.transformMetricDataToTable=function(e,t,a){var r,n,i=new lt.a,s={};if(0===e.length)return i;D.a.each(e,function(e){for(var t in e.metric)s.hasOwnProperty(t)||(s[t]=1)});var o=D.a.keys(s).sort();i.columns.push({text:"Time",type:"time"}),D.a.each(o,function(e,t){s[e]=t+1,i.columns.push({text:e,filterable:!e.startsWith("__")})});var l=t>1?"Value #"+a:"Value";return i.columns.push({text:l}),D.a.each(e,function(e){if(e.value&&(e.values=[e.value]),e.values)for(r=0;r<e.values.length;r++){var t=e.values[r],a=[1e3*t[0]];if(e.metric)for(n=0;n<o.length;n++){var s=o[n];e.metric.hasOwnProperty(s)?a.push(e.metric[s]):a.push("")}a.push(parseFloat(t[1])),i.rows.push(a)}}),i},e.prototype.transformInstantMetricData=function(e,t){var a,r=[];return a=this.createMetricLabel(e.metric,t),r.push([parseFloat(e.value[1]),1e3*e.value[0]]),{target:a,datapoints:r}},e.prototype.createMetricLabel=function(e,t){var a="";return(a=D.a.isUndefined(t)||D.a.isEmpty(t.legendFormat)?this.getOriginalMetricName(e):this.renderTemplate(this.templateSrv.replace(t.legendFormat),e))&&"{}"!==a||(a=t.query),a},e.prototype.renderTemplate=function(e,t){return e.replace(/\{\{\s*(.+?)\s*\}\}/g,function(e,a){return t[a]?t[a]:a})},e.prototype.getOriginalMetricName=function(e){var t=e.__name__||"";return delete e.__name__,t+"{"+D.a.map(D.a.toPairs(e),function(e){return e[0]+'="'+e[1]+'"'}).join(",")+"}"},e.prototype.transformToHistogramOverTime=function(e){for(var t=e.length-1;t>0;t--){var a=e[t].datapoints,r=e[t-1].datapoints;if(!a||!r)throw new Error("Prometheus heatmap transform error: data should be a time series");for(var n=0;n<a.length;n++){var i=r[n]||[0];a[n][0]-=i[0]}}return e},e}();function Rr(e,t){var a,r;try{a=Vr(e.metric.le),r=Vr(t.metric.le)}catch(e){return console.log(e),0}return a>r?1:a<r?-1:0}function Vr(e){return"+Inf"===e?1/0:Number(e)}var Nr="by|without|on|ignoring|group_left|group_right",jr=[Nr,"count|count_values|min|max|avg|sum|stddev|stdvar|bottomk|topk|quantile","true|false|null|__name__|job","abs|absent|ceil|changes|clamp_max|clamp_min|count_scalar|day_of_month|day_of_week|days_in_month|delta|deriv","drop_common_labels|exp|floor|histogram_quantile|holt_winters|hour|idelta|increase|irate|label_replace|ln|log2","log10|minute|month|predict_linear|rate|resets|round|scalar|sort|sort_desc|sqrt|time|vector|year|avg_over_time","min_over_time|max_over_time|sum_over_time|count_over_time|quantile_over_time|stddev_over_time|stdvar_over_time"].join("|").split("|");function Ur(e){return"string"==typeof e?e.replace(/'/g,"\\\\'"):e}function Lr(e){return"string"==typeof e?Ur(e.replace(/\\/g,"\\\\\\\\").replace(/[$^*{}\[\]+?.()]/g,"\\\\$&")):e}var Br=function(){function e(e,t,a,r,n){this.$q=t,this.backendSrv=a,this.templateSrv=r,this.timeSrv=n,this.type="prometheus",this.editorSrc="app/features/prometheus/partials/query.editor.html",this.name=e.name,this.supportsExplore=!0,this.supportMetrics=!0,this.url=e.url,this.directUrl=e.directUrl,this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.interval=e.jsonData.timeInterval||"15s",this.queryTimeout=e.jsonData.queryTimeout,this.httpMethod=e.jsonData.httpMethod||"GET",this.resultTransformer=new qr(r)}return e.$inject=["instanceSettings","$q","backendSrv","templateSrv","timeSrv"],e.prototype._request=function(e,t,a){return"GET"===(a=je.a({url:this.url+e,method:this.httpMethod},a)).method?D.a.isEmpty(t)||(a.url=a.url+"?"+D.a.map(t,function(e,t){return encodeURIComponent(t)+"="+encodeURIComponent(e)}).join("&")):(a.headers={"Content-Type":"application/x-www-form-urlencoded"},a.transformRequest=function(e){return j.a.param(e)},a.data=t),(this.basicAuth||this.withCredentials)&&(a.withCredentials=!0),this.basicAuth&&(a.headers={Authorization:this.basicAuth}),this.backendSrv.datasourceRequest(a)},e.prototype.metadataRequest=function(e){return this._request(e,null,{method:"GET",silent:!0})},e.prototype.interpolateQueryExpr=function(e,t,a){return t.multi||t.includeAll?"string"==typeof e?Lr(e):D.a.map(e,Lr).join("|"):Ur(e)},e.prototype.targetContainsTemplate=function(e){return this.templateSrv.variableExists(e.expr)},e.prototype.query=function(e){for(var t=this,a=this.getPrometheusTime(e.range.from,!1),r=this.getPrometheusTime(e.range.to,!0),n=[],i=[],s=0,o=(e=D.a.clone(e)).targets;s<o.length;s++){var l=o[s];l.expr&&!l.hide&&(i.push(l),n.push(this.createQuery(l,e,a,r)))}if(D.a.isEmpty(n))return this.$q.when({data:[]});var u=D.a.map(n,function(e){return e.instant?t.performInstantQuery(e,r):t.performTimeSeriesQuery(e,e.start,e.end)});return this.$q.all(u).then(function(e){var a=[];return D.a.each(e,function(r,s){if("error"===r.status)throw r.error;var o={format:i[s].format,step:n[s].step,legendFormat:i[s].legendFormat,start:n[s].start,end:n[s].end,query:n[s].expr,responseListLength:e.length,responseIndex:s,refId:i[s].refId};t.resultTransformer.transform(a,r,o)}),{data:a}})},e.prototype.createQuery=function(e,t,a,r){var n={};n.instant=e.instant;var i=Math.ceil(r-a),s=A.a.interval_to_seconds(t.interval),o=A.a.interval_to_seconds(this.templateSrv.replace(e.interval,t.scopedVars)||t.interval),l=e.intervalFactor||1,u=this.adjustInterval(s,o,i,l),c=je.a({},t.scopedVars,this.getRangeScopedVars());s!==u&&(s=u,c=Object.assign({},t.scopedVars,je.a({__interval:{text:s+"s",value:s+"s"},__interval_ms:{text:1e3*s,value:1e3*s}},this.getRangeScopedVars()))),n.step=s,n.expr=this.templateSrv.replace(e.expr,c,this.interpolateQueryExpr),n.requestId=t.panelId+e.refId;var d=function(e,t,a){return{end:Math.ceil(t/a)*a,start:Math.floor(e/a)*a}}(a,r,n.step);return n.start=d.start,n.end=d.end,n},e.prototype.adjustInterval=function(e,t,a,r){return 0!==e&&a/r/e>11e3&&(e=Math.ceil(a/r/11e3)),Math.max(e*r,t,1)},e.prototype.performTimeSeriesQuery=function(e,t,a){if(t>a)throw{message:"Invalid time range"};var r={query:e.expr,start:t,end:a,step:e.step};return this.queryTimeout&&(r.timeout=this.queryTimeout),this._request("/api/v1/query_range",r,{requestId:e.requestId})},e.prototype.performInstantQuery=function(e,t){var a={query:e.expr,time:t};return this.queryTimeout&&(a.timeout=this.queryTimeout),this._request("/api/v1/query",a,{requestId:e.requestId})},e.prototype.performSuggestQuery=function(e,t){var a=this;void 0===t&&(t=!1);return t&&this.metricsNameCache&&this.metricsNameCache.expire>Date.now()?this.$q.when(D.a.filter(this.metricsNameCache.data,function(t){return 1!==t.indexOf(e)})):this.metadataRequest("/api/v1/label/__name__/values").then(function(t){return a.metricsNameCache={data:t.data.data,expire:Date.now()+6e4},D.a.filter(t.data.data,function(t){return 1!==t.indexOf(e)})})},e.prototype.metricFindQuery=function(e){if(!e)return this.$q.when([]);var t=je.a({__interval:{text:this.interval,value:this.interval},__interval_ms:{text:A.a.interval_to_ms(this.interval),value:A.a.interval_to_ms(this.interval)}},this.getRangeScopedVars()),a=this.templateSrv.replace(e,t,this.interpolateQueryExpr);return new Or(this,a,this.timeSrv).process()},e.prototype.getRangeScopedVars=function(){var e=this.timeSrv.timeRange(),t=e.to.diff(e.from),a=A.a.secondsToHms(t/1e3);return{__range_ms:{text:t,value:t},__range:{text:a,value:a}}},e.prototype.annotationQuery=function(e){var t=e.annotation,a=t.expr||"",r=t.tagKeys||"",n=t.titleFormat||"",i=t.textFormat||"";if(!a)return this.$q.when([]);var s=t.step||"60s",o=this.getPrometheusTime(e.range.from,!1),l=this.getPrometheusTime(e.range.to,!0),u=je.a({},e,{interval:"0s"}),c=this.createQuery({expr:a,interval:s},u,o,l),d=this;return this.performTimeSeriesQuery(c,c.start,c.end).then(function(e){var a=[];return r=r.split(","),D.a.each(e.data.data.result,function(e){for(var s=D.a.chain(e.metric).filter(function(e,t){return D.a.includes(r,t)}).value(),o=0,l=e.values;o<l.length;o++){var u=l[o];if("1"===u[1]){var c={annotation:t,time:1e3*Math.floor(parseFloat(u[0])),title:d.resultTransformer.renderTemplate(n,e.metric),tags:s,text:d.resultTransformer.renderTemplate(i,e.metric)};a.push(c)}}}),a})},e.prototype.testDatasource=function(){var e=(new Date).getTime();return this.performInstantQuery({expr:"1+1"},e/1e3).then(function(e){return"success"===e.data.status?{status:"success",message:"Data source is working"}:{status:"error",message:e.error}})},e.prototype.getExploreState=function(e){var t=this,a={};if(e.targets){var r=e.targets.map(function(e){return{query:t.templateSrv.replace(e.expr,{},t.interpolateQueryExpr),format:e.format}});a=je.a({},a,{queries:r,datasource:this.name})}return a},e.prototype.modifyQuery=function(e,t){var a=t.addFilter;return a?function(e,t,a){if(!t||!a)throw new Error("Need label to add to query.");var r;e=e.replace(/(\w+)\b(?![\({=",])/g,function(t,a,n){var i=e.slice(n).indexOf("{"),s=e.slice(n).indexOf("}"),o=s>-1&&(-1===i||i>s),l=r&&Nr.split("|").indexOf(r)>-1;return r=a,o||l||-1!==jr.indexOf(a)?a:a+"{}"});for(var n=/{([^{]*)}/g,i=null,s=[],o=0,l="",u=function(){var r=e.slice(o,i.index),n=i[1].split(",").reduce(function(e,t){var a=t.split("=");return 2===a.length&&(e[a[0]]=a[1]),e},{});n[t]='"'+a+'"';var u=Object.keys(n).sort().map(function(e){return e+"="+n[e]}).join(",");o=i.index+i[1].length+2,l=e.slice(i.index+i[0].length),s.push(r,"{",u,"}")};i=n.exec(e);)u();return s.push(l),s.join("")}(e,a.key,a.value):e},e.prototype.getPrometheusTime=function(e,t){return D.a.isString(e)&&(e=Le.parse(e,t)),Math.ceil(e.valueOf()/1e3)},e.prototype.getOriginalMetricName=function(e){return this.resultTransformer.getOriginalMetricName(e)},e}(),Qr=function(){function e(e,t){this.datasource=e,this.templateSrv=t,this.identifierRegexps=[/\[/,/[a-zA-Z0-9_:]/],this.labelQueryCache={},this.labelNameCache={},this.labelValueCache={},this.templateVariableCompletions=this.templateSrv.variables.map(function(e){return{caption:"$"+e.name,value:"$"+e.name,meta:"variable",score:Number.MAX_VALUE}})}return e.prototype.getCompletions=function(e,t,a,r,n){var i=this,s=function(e,t){return t=t.concat(i.templateVariableCompletions),n(e,t)},o=t.getTokenAt(a.row,a.column);switch(o.type){case"entity.name.tag.label-matcher":return void this.getCompletionsForLabelMatcherName(t,a).then(function(e){s(null,e)});case"string.quoted.label-matcher":return void this.getCompletionsForLabelMatcherValue(t,a).then(function(e){s(null,e)});case"entity.name.tag.label-list-matcher":return void this.getCompletionsForBinaryOperator(t,a).then(function(e){s(null,e)})}if("paren.lparen"===o.type&&"["===o.value){for(var l=[],u=0,c=["s","m","h"];u<c.length;u++)for(var d=c[u],p=0,h=[1,5,10,30];p<h.length;p++){var m=h[p];l.push({caption:m+d,value:"["+m+d,meta:"range vector"})}return l.unshift({caption:"$__interval_ms",value:"[$__interval_ms",meta:"range vector"}),l.unshift({caption:"$__interval",value:"[$__interval",meta:"range vector"}),void s(null,l)}var f=r;return this.datasource.performSuggestQuery(f,!0).then(function(e){s(null,e.map(function(e){var t=e;return"("===r&&(t="("+e),{caption:e,value:t,meta:"metric"}}))})},e.prototype.getCompletionsForLabelMatcherName=function(e,t){var a=this,r=this.findMetricName(e,t.row,t.column);return r?this.labelNameCache[r]?Promise.resolve(this.labelNameCache[r]):this.getLabelNameAndValueForExpression(r,"metricName").then(function(e){var t=a.transformToCompletions(D.a.uniq(D.a.flatten(e.map(function(e){return Object.keys(e.metric)}))),"label name");return a.labelNameCache[r]=t,Promise.resolve(t)}):Promise.resolve(this.transformToCompletions(["__name__","instance","job"],"label name"))},e.prototype.getCompletionsForLabelMatcherValue=function(e,t){var a=this,r=this.findMetricName(e,t.row,t.column);if(!r)return Promise.resolve([]);var n=this.findToken(e,t.row,t.column,"entity.name.tag.label-matcher",null,"paren.lparen.label-matcher");if(!n)return Promise.resolve([]);var i=n.value;return this.labelValueCache[r]&&this.labelValueCache[r][i]?Promise.resolve(this.labelValueCache[r][i]):this.getLabelNameAndValueForExpression(r,"metricName").then(function(e){var t=a.transformToCompletions(D.a.uniq(e.map(function(e){return e.metric[i]})),"label value");return a.labelValueCache[r]=a.labelValueCache[r]||{},a.labelValueCache[r][i]=t,Promise.resolve(t)})},e.prototype.getCompletionsForBinaryOperator=function(e,t){var a,r,n=this,i=this.findToken(e,t.row,t.column,"keyword.control",null,"identifier");if(!i)return Promise.resolve([]);switch(i.value){case"by":case"without":return(a=this.findToken(e,i.row,i.column,"paren.rparen",null,"identifier"))?""===(r=this.findExpressionMatchedParen(e,a.row,a.column))?Promise.resolve([]):this.getLabelNameAndValueForExpression(r,"expression").then(function(e){var t=n.transformToCompletions(D.a.uniq(D.a.flatten(e.map(function(e){return Object.keys(e.metric)}))),"label name");return n.labelNameCache[r]=t,t}):Promise.resolve([]);case"on":case"ignoring":case"group_left":case"group_right":var s=this.findToken(e,i.row,i.column,"keyword.operator.binary",null,"identifier");if(!s)return Promise.resolve([]);if(a=this.findToken(e,s.row,s.column,"paren.rparen",null,"identifier"))return""===(r=this.findExpressionMatchedParen(e,a.row,a.column))?Promise.resolve([]):this.getLabelNameAndValueForExpression(r,"expression").then(function(e){var t=n.transformToCompletions(D.a.uniq(D.a.flatten(e.map(function(e){return Object.keys(e.metric)}))),"label name");return n.labelNameCache[r]=t,t});var o=this.findMetricName(e,s.row,s.column);return this.getLabelNameAndValueForExpression(o,"metricName").then(function(e){var t=n.transformToCompletions(D.a.uniq(D.a.flatten(e.map(function(e){return Object.keys(e.metric)}))),"label name");return n.labelNameCache[o]=t,Promise.resolve(t)})}return Promise.resolve([])},e.prototype.getLabelNameAndValueForExpression=function(e,t){var a=this;if(this.labelQueryCache[e])return Promise.resolve(this.labelQueryCache[e]);var r=e;if("metricName"===t){var n="=~";/[a-zA-Z_:][a-zA-Z0-9_:]*/.test(e)&&(n="="),r="{__name__"+n+'"'+e+'"}'}return this.datasource.performInstantQuery({expr:r},(new Date).getTime()/1e3).then(function(t){return a.labelQueryCache[e]=t.data.data.result,t.data.data.result})},e.prototype.transformToCompletions=function(e,t){return e.map(function(e){return{caption:e,value:e,meta:t,score:Number.MAX_VALUE}})},e.prototype.findMetricName=function(e,t,a){var r="",n=this.findToken(e,t,a,"entity.name.tag.label-matcher","__name__","paren.lparen.label-matcher");if(n){var i=e.getTokens(n.row)[n.index+2];i&&"string.quoted.label-matcher"===i.type&&(r=i.value.slice(1,-1))}else{var s=this.findToken(e,t,a,"identifier",null,null);s&&(e.getTokens(s.row),r=s.value)}return r},e.prototype.findToken=function(e,t,a,r,n,i){for(var s,o,l=t;l>=0;l--){var u=void 0;if(s=e.getTokens(l),l===t)for(u=0,o=0;o<s.length;o++){var c=u+s[o].value.length;if(c>=a)break;u=c}else o=s.length-1,u=D.a.sum(s.map(function(e){return e.value.length}))-s[s.length-1].value.length;for(;o>=0;o--){if(s[o].type===i)return null;if(s[o].type===r&&(!n||s[o].value===n))return s[o].row=l,s[o].column=u,s[o].index=o,s[o];u-=s[o].value.length}}return null},e.prototype.findExpressionMatchedParen=function(e,t,a){for(var r,n,i=1,s=")",o=t;o>=0;o--){if(r=e.getTokens(o),o===t){var l=0;for(n=0;n<r.length&&!((l+=r[n].value.length)>=a);n++);}else n=r.length-1;for(;n>=0;n--)if(s=r[n].value+s,"paren.rparen"===r[n].type)i++;else if("paren.lparen"===r[n].type&&0===--i)return s}return s},e}(),zr=(a(1108),a(1107),function(e){function t(t,a,r){var n=e.call(this,t,a)||this;n.templateSrv=r;var i=n.target;return i.expr=i.expr||"",i.intervalFactor=i.intervalFactor||1,i.format=i.format||n.getDefaultFormat(),n.metric="",n.resolutions=D.a.map([1,2,3,4,5,10],function(e){return{factor:e,label:"1/"+e}}),n.formats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"},{text:"Heatmap",value:"heatmap"}],n.instant=!1,n.updateLink(),n}return t.$inject=["$scope","$injector","templateSrv"],je.d(t,e),t.prototype.getCompleter=function(e){return new Qr(this.datasource,this.templateSrv)},t.prototype.getDefaultFormat=function(){return"table"===this.panelCtrl.panel.type?"table":"heatmap"===this.panelCtrl.panel.type?"heatmap":"time_series"},t.prototype.refreshMetricData=function(){D.a.isEqual(this.oldTarget,this.target)||(this.oldTarget=P.a.copy(this.target),this.panelCtrl.refresh(),this.updateLink())},t.prototype.updateLink=function(){var e=this.panelCtrl.range;if(e){var t=Math.ceil((e.to.valueOf()-e.from.valueOf())/1e3),a=e.to.utc().format("YYYY-MM-DD HH:mm"),r={"g0.expr":this.templateSrv.replace(this.target.expr,this.panelCtrl.panel.scopedVars,this.datasource.interpolateQueryExpr),"g0.range_input":t+"s","g0.end_input":a,"g0.step_input":this.target.step,"g0.stacked":this.panelCtrl.panel.stack?1:0,"g0.tab":0},n=D.a.map(r,function(e,t){return t+"="+encodeURIComponent(e)}).join("&");this.linkToPrometheus=this.datasource.directUrl+"/graph?"+n}},t.prototype.getCollapsedText=function(){return this.target.expr},t.templateUrl="partials/query.editor.html",t}(Ye)),Hr=function(){function e(e){this.current.jsonData.httpMethod=this.current.jsonData.httpMethod||"GET"}return e.$inject=["$scope"],e.templateUrl="public/app/plugins/datasource/prometheus/partials/config.html",e}(),Yr=function(){function e(){}return e.templateUrl="partials/annotations.editor.html",e}(),Wr=function(){function e(e){this.$q=e}return e.prototype.processQueryResult=function(e){var t=[];if(!e.data.results)return{data:t};for(var a in e.data.results){var r=e.data.results[a];if(r.series)for(var n=0,i=r.series;n<i.length;n++){var s=i[n];t.push({target:s.name,datapoints:s.points,refId:r.refId,meta:r.meta})}if(r.tables)for(var o=0,l=r.tables;o<l.length;o++){var u=l[o];u.type="table",u.refId=r.refId,u.meta=r.meta,t.push(u)}}return{data:t}},e.prototype.parseMetricFindQueryResult=function(e,t){if(!t||0===t.data.length||0===t.data.results[e].meta.rowCount)return[];var a=t.data.results[e].tables[0].columns,r=t.data.results[e].tables[0].rows,n=this.findColIndex(a,"__text"),i=this.findColIndex(a,"__value");return 2===a.length&&-1!==n&&-1!==i?this.transformToKeyValueList(r,n,i):this.transformToSimpleList(r)},e.prototype.transformToKeyValueList=function(e,t,a){for(var r=[],n=0;n<e.length;n++)this.containsKey(r,e[n][t])||r.push({text:e[n][t],value:e[n][a]});return r},e.prototype.transformToSimpleList=function(e){for(var t=[],a=0;a<e.length;a++)for(var r=0;r<e[a].length;r++){var n=e[a][r];-1===t.indexOf(n)&&t.push(n)}return D.a.map(t,function(e){return{text:e}})},e.prototype.findColIndex=function(e,t){for(var a=0;a<e.length;a++)if(e[a].text===t)return a;return-1},e.prototype.containsKey=function(e,t){for(var a=0;a<e.length;a++)if(e[a].text===t)return!0;return!1},e.prototype.transformAnnotationResponse=function(e,t){for(var a=t.data.results[e.annotation.name].tables[0],r=-1,n=-1,i=-1,s=0;s<a.columns.length;s++)"time"===a.columns[s].text?r=s:"text"===a.columns[s].text?n=s:"tags"===a.columns[s].text&&(i=s);if(-1===r)return this.$q.reject({message:"Missing mandatory time column (with time column alias) in annotation query."});var o=[];for(s=0;s<a.rows.length;s++){var l=a.rows[s];o.push({annotation:e.annotation,time:Math.floor(l[r]),text:l[n],tags:l[i]?l[i].trim().split(/\s*,\s*/):[]})}return o},e}(),Gr=function(){function e(e,t,a,r){this.backendSrv=t,this.$q=a,this.templateSrv=r,this.name=e.name,this.id=e.id,this.responseParser=new Wr(this.$q)}return e.$inject=["instanceSettings","backendSrv","$q","templateSrv"],e.prototype.interpolateVariable=function(e,t){return"string"==typeof e?t.multi||t.includeAll?"'"+e.replace(/'/g,"''")+"'":e:"number"==typeof e?e:D.a.map(e,function(t){return"number"==typeof e?e:"'"+t.replace(/'/g,"''")+"'"}).join(",")},e.prototype.query=function(e){var t=this,a=D.a.filter(e.targets,function(e){return!0!==e.hide}).map(function(a){return{refId:a.refId,intervalMs:e.intervalMs,maxDataPoints:e.maxDataPoints,datasourceId:t.id,rawSql:t.templateSrv.replace(a.rawSql,e.scopedVars,t.interpolateVariable),format:a.format}});return 0===a.length?this.$q.when({data:[]}):this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:a}}).then(this.responseParser.processQueryResult)},e.prototype.annotationQuery=function(e){var t=this;if(!e.annotation.rawQuery)return this.$q.reject({message:"Query missing in annotation definition"});var a={refId:e.annotation.name,datasourceId:this.id,rawSql:this.templateSrv.replace(e.annotation.rawQuery,e.scopedVars,this.interpolateVariable),format:"table"};return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:[a]}}).then(function(a){return t.responseParser.transformAnnotationResponse(e,a)})},e.prototype.metricFindQuery=function(e,t){var a=this,r="tempvar";t&&t.variable&&t.variable.name&&(r=t.variable.name);var n={refId:r,datasourceId:this.id,rawSql:this.templateSrv.replace(e,{},this.interpolateVariable),format:"table"};return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{queries:[n]}}).then(function(e){return a.responseParser.parseMetricFindQueryResult(r,e)})},e.prototype.testDatasource=function(){return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:"5m",to:"now",queries:[{refId:"A",intervalMs:1,maxDataPoints:1,datasourceId:this.id,rawSql:"SELECT 1",format:"table"}]}}).then(function(e){return{status:"success",message:"Database Connection OK"}}).catch(function(e){return console.log(e),e.data&&e.data.message?{status:"error",message:e.data.message}:{status:"error",message:e.status}})},e}(),Kr="SELECT\n  $__timeEpoch(<time_column>),\n  <value column> as value,\n  <series name column> as metric\nFROM\n  <table name>\nWHERE\n  $__timeFilter(time_column)\nORDER BY\n  <time_column> ASC",Jr=function(e){function t(t,a){var r=e.call(this,t,a)||this;return r.target.format=r.target.format||"time_series",r.target.alias="",r.formats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"}],r.target.rawSql||("table"===r.panelCtrl.panel.type?(r.target.format="table",r.target.rawSql="SELECT 1"):r.target.rawSql=Kr),r.panelCtrl.events.on("data-received",r.onDataReceived.bind(r),t),r.panelCtrl.events.on("data-error",r.onDataError.bind(r),t),r}return t.$inject=["$scope","$injector"],je.d(t,e),t.prototype.onDataReceived=function(e){this.lastQueryMeta=null,this.lastQueryError=null;var t=D.a.find(e,{refId:this.target.refId});t&&(this.lastQueryMeta=t.meta)},t.prototype.onDataError=function(e){if(e.data&&e.data.results){var t=e.data.results[this.target.refId];t&&(this.lastQueryMeta=t.meta,this.lastQueryError=t.error)}},t.templateUrl="partials/query.editor.html",t}(Ye),Xr=function(){function e(){}return e.templateUrl="partials/config.html",e}(),Zr="SELECT\n    <time_column> as time,\n    <text_column> as text,\n    <tags_column> as tags\n  FROM\n    <table name>\n  WHERE\n    $__timeFilter(time_column)\n  ORDER BY\n    <time_column> ASC",en=function(){function e(){this.annotation.rawQuery=this.annotation.rawQuery||Zr}return e.templateUrl="partials/annotations.editor.html",e}(),tn=function(){function e(e,t,a){this.backendSrv=t,this.$q=a,this.id=e.id}return e.$inject=["instanceSettings","backendSrv","$q"],e.prototype.query=function(e){var t=this,a=D.a.filter(e.targets,function(e){return!0!==e.hide}).map(function(a){return{refId:a.refId,scenarioId:a.scenarioId,intervalMs:e.intervalMs,maxDataPoints:e.maxDataPoints,stringInput:a.stringInput,points:a.points,alias:a.alias,datasourceId:t.id}});return 0===a.length?this.$q.when({data:[]}):this.backendSrv.post("/api/tsdb/query",{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:a}).then(function(e){var t=[];return e.results&&D.a.forEach(e.results,function(e){for(var a=0,r=e.series;a<r.length;a++){var n=r[a];t.push({target:n.name,datapoints:n.points})}}),{data:t}})},e.prototype.annotationQuery=function(e){return this.backendSrv.get("/api/annotations",{from:e.range.from.valueOf(),to:e.range.to.valueOf(),limit:e.limit,type:e.type})},e}(),an=function(e){function t(t,a,r){var n=e.call(this,t,a)||this;return n.backendSrv=r,n.target.scenarioId=n.target.scenarioId||"random_walk",n.scenarioList=[],n.newPointTime=Y()(),n.selectedPoint={text:"Select point",value:null},n}return t.$inject=["$scope","$injector","backendSrv"],je.d(t,e),t.prototype.getPoints=function(){return D.a.map(this.target.points,function(e,t){return{text:Y()(e[1]).format("MMMM Do YYYY, H:mm:ss")+" : "+e[0],value:t}})},t.prototype.pointSelected=function(e){this.selectedPoint=e},t.prototype.deletePoint=function(){this.target.points.splice(this.selectedPoint.value,1),this.selectedPoint={text:"Select point",value:null},this.refresh()},t.prototype.addPoint=function(){this.target.points=this.target.points||[],this.target.points.push([this.newPointValue,this.newPointTime.valueOf()]),this.target.points=D.a.sortBy(this.target.points,function(e){return e[1]}),this.refresh()},t.prototype.$onInit=function(){var e=this;return this.backendSrv.get("/api/tsdb/testdata/scenarios").then(function(t){e.scenarioList=t,e.scenario=D.a.find(e.scenarioList,{id:e.target.scenarioId})})},t.prototype.scenarioChanged=function(){this.scenario=D.a.find(this.scenarioList,{id:this.target.scenarioId}),this.target.stringInput=this.scenario.stringInput,"manual_entry"===this.target.scenarioId?this.target.points=this.target.points||[]:delete this.target.points,this.refresh()},t.templateUrl="partials/query.editor.html",t}(Ye),rn=function(){function e(){}return e.template="<h2>test data</h2>",e}(),nn=function(e){function t(t,a,r,n){var i=e.call(this,t,a)||this;return i.templateSrv=r,i.$sce=n,i.panelDefaults={mode:"markdown",content:"# title"},D.a.defaults(i.panel,i.panelDefaults),i.events.on("init-edit-mode",i.onInitEditMode.bind(i)),i.events.on("refresh",i.onRefresh.bind(i)),i.events.on("render",i.onRender.bind(i)),t.$watch("ctrl.panel.content",D.a.throttle(function(){i.render()},1e3)),i}return t.$inject=["$scope","$injector","templateSrv","$sce"],je.d(t,e),t.prototype.onInitEditMode=function(){this.addEditorTab("选项","public/app/plugins/panel/text/editor.html"),this.editorTabIndex=1,"text"===this.panel.mode&&(this.panel.mode="markdown")},t.prototype.onRefresh=function(){this.render()},t.prototype.onRender=function(){"markdown"===this.panel.mode?this.renderMarkdown(this.panel.content):"html"===this.panel.mode&&this.updateContent(this.panel.content),this.renderingCompleted()},t.prototype.renderText=function(e){e=e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/\n/g,"<br/>"),this.updateContent(e)},t.prototype.renderMarkdown=function(e){var t=this;this.remarkable||(this.remarkable=new be.a),this.$scope.$applyAsync(function(){t.updateContent(t.remarkable.render(e))})},t.prototype.updateContent=function(e){try{this.content=this.$sce.trustAsHtml(this.templateSrv.replace(e,this.panel.scopedVars))}catch(t){console.log("Text panel error: ",t),this.content=this.$sce.trustAsHtml(e)}},t.templateUrl="public/app/plugins/panel/text/module.html",t.scrollable=!0,t}(Ne);a(1095),a(1103),a(1096),a(1102),a(1101),a(1100),a(1099),a(1098);function sn(e,t,a){var r=P.a.element(document).injector(),n=document.createElement("div");n.innerHTML='<annotation-tooltip event="event" on-edit="onEdit()"></annotation-tooltip>',r.invoke(["$compile","$rootScope",function(r,i){var s=a.getOptions().events.manager,o=i.$new(!0);o.event=t,o.onEdit=function(){s.editEvent(t)},r(n)(o),o.$digest(),o.$destroy();var l=new Yt.a({target:e[0],content:n,position:"bottom center",classes:"drop-popover drop-popover--annotation",openOn:"hover",hoverCloseDelay:200,tetherOptions:{constraints:[{to:"window",pin:!0,attachment:"both"}]}});l.open(),l.on("close",function(){setTimeout(function(){l.destroy()})})}])}var on=null;function ln(e,t,a){var r=a.getOptions().events.manager;r.editorOpen?on=e:(r.editorOpened(),on=e,setTimeout(function(){var e=P.a.element(document).injector(),a=document.createElement("div");a.innerHTML='<event-editor panel-ctrl="panelCtrl" event="event" close="close()"></event-editor>',e.invoke(["$compile","$rootScope",function(e,n){var i,s=n.$new(!0);s.event=t,s.panelCtrl=r.panelCtrl,s.close=function(){i.close()},e(a)(s),s.$digest(),(i=new Yt.a({target:on[0],content:a,position:"bottom center",classes:"drop-popover drop-popover--form",openOn:"click",tetherOptions:{constraints:[{to:"window",pin:!0,attachment:"both"}]}})).open(),r.editorOpened(),i.on("close",function(){setTimeout(function(){r.editorClosed(),s.$destroy(),i.destroy()})})}])},100))}var un=function(){function e(e,t,a,r,n,i,s,o){this._object=e,this._drawFunc=t,this._clearFunc=a,this._moveFunc=r,this._position={left:n,top:i},this._width=s,this._height=o}return e.$inject=["object","drawFunc","clearFunc","moveFunc","left","top","width","height"],e.prototype.width=function(){return this._width},e.prototype.height=function(){return this._height},e.prototype.position=function(){return this._position},e.prototype.draw=function(){this._drawFunc(this._object)},e.prototype.clear=function(){this._clearFunc(this._object)},e.prototype.getObject=function(){return this._object},e.prototype.moveTo=function(e){this._position=e,this._moveFunc(this._object,this._position)},e}(),cn=function(){function e(e,t){this._options=e,this._drawableEvent=t,this._hidden=!1}return e.$inject=["options","drawableEvent"],e.prototype.visual=function(){return this._drawableEvent},e.prototype.getOptions=function(){return this._options},e.prototype.getParent=function(){return this._parent},e.prototype.isHidden=function(){return this._hidden},e.prototype.hide=function(){this._hidden=!0},e.prototype.unhide=function(){this._hidden=!1},e}(),dn=function(){function e(e){this._events=[],this._types=[],this._plot=e,this.eventsEnabled=!1}return e.$inject=["plot"],e.prototype.getEvents=function(){return this._events},e.prototype.setTypes=function(e){return this._types=e},e.prototype.setupEvents=function(e){var t=this,a=D.a.partition(e,"isRegion"),r=a[0];e=a[1],j.a.each(e,function(e,a){var r=new cn(a,t._buildDiv(a));t._events.push(r)}),j.a.each(r,function(e,a){var r=new cn(a,t._buildRegDiv(a));t._events.push(r)}),this._events.sort(function(e,t){var a=e.getOptions(),r=t.getOptions();return a.min>r.min?1:a.min<r.min?-1:0})},e.prototype.drawEvents=function(){var e=this;j.a.each(this._events,function(t,a){e._insidePlot(a.getOptions().min)&&!a.isHidden()?a.visual().draw():a.visual().getObject().hide()})},e.prototype.updateEvents=function(){var e,t,a=this,r=this._plot.getPlotOffset(),n=this._plot.getXAxes()[this._plot.getOptions().events.xaxis-1];j.a.each(this._events,function(i,s){t=r.top+a._plot.height()-s.visual().height(),e=n.p2c(s.getOptions().min)+r.left-s.visual().width()/2,s.visual().moveTo({top:t,left:e})})},e.prototype._clearEvents=function(){j.a.each(this._events,function(e,t){t.visual().clear()}),this._events=[]},e.prototype._buildDiv=function(e){var t,a,r,n,i,s,o,l,u=this,c=this._plot.getPlaceholder(),d=this._plot.getPlotOffset(),p=this._plot.getXAxes()[this._plot.getOptions().events.xaxis-1],h=e.eventType;r=null!==this._types&&this._types[h]&&this._types[h].color?this._types[h].color:"#666",n=null!==this._types&&this._types[h]&&this._types[h].markerSize?this._types[h].markerSize:8,i=null===this._types||!this._types[h]||void 0===this._types[h].markerShow||this._types[h].markerShow,l=null===this._types||!this._types[h]||void 0===this._types[h].markerTooltip||this._types[h].markerTooltip,s=null!=this._types&&this._types[h]&&this._types[h].lineStyle?this._types[h].lineStyle.toLowerCase():"dashed",o=null!=this._types&&this._types[h]&&void 0!==this._types[h].lineWidth?this._types[h].lineWidth:1;var m=p.options.eventSectionHeight||0;m/=3,t=d.top+this._plot.height()+m,a=p.p2c(e.min)+d.left;var f=j()('<div class="events_line flot-temp-elem"></div>').css({position:"absolute",opacity:.8,left:a+"px",top:8,width:o+"px",height:this._plot.height()+.8*m,"border-left-width":o+"px","border-left-style":s,"border-left-color":r,color:r}).appendTo(c);if(i){var g=j()('<div class="events_marker"></div>').css({position:"absolute",left:-n-Math.round(o/2)+"px","font-size":0,"line-height":0,width:0,height:0,"border-left":n+"px solid transparent","border-right":n+"px solid transparent"});g.appendTo(f),this._types[h]&&this._types[h].position&&"BOTTOM"===this._types[h].position.toUpperCase()?g.css({top:t-n-8+"px","border-top":"none","border-bottom":n+"px solid "+r}):g.css({top:"0px","border-top":n+"px solid "+r,"border-bottom":"none"}),g.data({event:e});e.editModel&&ln(g,e.editModel,u._plot);l&&(g.css({cursor:"help"}),g.hover(function(){sn(g,j()(this).data("event"),u._plot)},function(){u._plot.clearSelection()}))}return new un(f,function(e){e.show()},function(e){e.remove()},function(e,t){e.css({top:t.top,left:t.left})},a,t,f.width(),f.height())},e.prototype._buildRegDiv=function(e){var t,a,r,n,i,s,o,l=this,u=this,c=this._plot.getPlaceholder(),d=this._plot.getPlotOffset(),p=this._plot.getXAxes()[this._plot.getOptions().events.xaxis-1],h=e.eventType;s=null!==this._types&&this._types[h]&&this._types[h].color?this._types[h].color:"#666",o=null===this._types||!this._types[h]||void 0===this._types[h].markerTooltip||this._types[h].markerTooltip,r=null!=this._types&&this._types[h]&&void 0!==this._types[h].lineWidth?this._types[h].lineWidth:1,i=null!=this._types&&this._types[h]&&this._types[h].lineStyle?this._types[h].lineStyle.toLowerCase():"dashed";t=d.top+this._plot.height()+2;var m=Math.min(e.min,e.timeEnd),f=Math.max(e.min,e.timeEnd);a=p.p2c(m)+d.left;var g=p.p2c(f)+d.left;n=g-a,D.a.each([a,g],function(e){j()('<div class="events_line flot-temp-elem"></div>').css({position:"absolute",opacity:.8,left:e+"px",top:8,width:r+"px",height:l._plot.height()+2,"border-left-width":r+"px","border-left-style":i,"border-left-color":s,color:s}).appendTo(c)});var v=j()('<div class="events_marker region_marker flot-temp-elem"></div>').css({position:"absolute",opacity:.5,left:a+"px",top:t,width:Math.round(n+r)+"px",height:"0.5rem","border-left-color":s,color:s,"background-color":s});v.appendTo(c),v.data({event:e});e.editModel&&ln(v,e.editModel,u._plot);return o&&(v.css({cursor:"help"}),v.hover(function(){sn(v,j()(this).data("event"),u._plot)},function(){u._plot.clearSelection()})),new un(v,function(e){e.show()},function(e){e.remove()},function(e,t){e.css({top:t.top,left:t.left})},a,t,v.width(),v.height())},e.prototype._insidePlot=function(e){var t=this._plot.getXAxes()[this._plot.getOptions().events.xaxis-1],a=t.p2c(e);return a>0&&a<t.p2c(t.max)},e}();function pn(e){var t=this,a=new dn(e);e.getEvents=function(){return a._events},e.hideEvents=function(){j.a.each(a._events,function(e,t){t.visual().getObject().hide()})},e.showEvents=function(){e.hideEvents(),j.a.each(a._events,function(e,t){t.hide()}),t.eventMarkers.drawEvents()},e.setEvents=function(e){a.eventsEnabled&&a.setupEvents(e)},e.hooks.processOptions.push(function(e,t){null!=t.events.data&&(a.eventsEnabled=!0)}),e.hooks.draw.push(function(e){var t=e.getOptions();a.eventsEnabled&&(a.getEvents().length<1?(a.setTypes(t.events.types),a.setupEvents(t.events.data)):a.updateEvents()),a.drawEvents()})}j.a.plot.plugins.push({init:pn,options:{events:{data:null,types:null,xaxis:1,position:"BOTTOM"}},name:"events",version:"0.2.5"});var hn=function(){function e(e){this.panelCtrl=e}return e.prototype.getHandleHtml=function(e,t,a){var r=t.colorMode;return"custom"===t.colorMode&&(r="critical"),'\n    <div class="alert-handle-wrapper alert-handle-wrapper--T'+e+'">\n      <div class="alert-handle-line alert-handle-line--'+r+'">\n      </div>\n      <div class="alert-handle" data-handle-index="'+e+'">\n        <i class="icon-gf icon-gf-'+r+" alert-state-"+r+'"></i>\n        <span class="alert-handle-value">'+a+'<i class="alert-handle-grip"></i></span>\n      </div>\n    </div>'},e.prototype.initDragging=function(e){var t,a=j()(e.currentTarget).parents(".alert-handle-wrapper"),r=j()(e.currentTarget).data("handleIndex"),n=null,i=this.plot,s=this.panelCtrl,o=this.thresholds[r];function l(e){if(null===n)n=e.clientY;else{var r=e.clientY-n;t+=r,n=e.clientY,a.css({top:t+r})}}function u(){var e=i.c2p({left:0,top:t}).y;e=parseInt(e.toFixed(0)),o.value=e,a.off("mousemove",l),a.off("mouseup",l),a.off("mouseleave",l),s.$scope.$apply(function(){s.render(),s.events.emit("threshold-changed",{threshold:o,handleIndex:r})})}n=null,t=a.position().top,a.on("mousemove",l),a.on("mouseup",u),a.on("mouseleave",u)},e.prototype.cleanUp=function(){this.placeholder.find(".alert-handle-wrapper").remove(),this.needsCleanup=!1},e.prototype.renderHandle=function(e,t){var a=this.thresholds[e],r=a.value,n=r,i=0;if(D.a.isNumber(r)){var s=this.plot.p2c({x:0,y:r});i=Math.round(Math.min(Math.max(s.top,0),this.height)-6)}else n="",i=t;var o=j()(this.getHandleHtml(e,a,n));this.placeholder.append(o),o.toggleClass("alert-handle-wrapper--no-value",""===n),o.css({top:i})},e.prototype.shouldDrawHandles=function(){return!this.hasSecondYAxis&&this.panelCtrl.editingThresholds&&this.panelCtrl.panel.thresholds.length>0},e.prototype.prepare=function(e,t){this.hasSecondYAxis=!1;for(var a=0;a<t.length;a++)if(t[a].yaxis>1){this.hasSecondYAxis=!0;break}if(this.shouldDrawHandles()){var r=this.panelCtrl.panel.thresholds.length>1?"220px":"110px";e.css("margin-right",r)}else this.needsCleanup&&e.css("margin-right","0")},e.prototype.draw=function(e){this.thresholds=this.panelCtrl.panel.thresholds,this.plot=e,this.placeholder=e.getPlaceholder(),this.needsCleanup&&this.cleanUp(),this.shouldDrawHandles()&&(this.height=e.height(),this.thresholds.length>0&&this.renderHandle(0,10),this.thresholds.length>1&&this.renderHandle(1,this.height-30),this.placeholder.off("mousedown",".alert-handle"),this.placeholder.on("mousedown",".alert-handle",this.initDragging.bind(this)),this.needsCleanup=!0)},e.prototype.addFlotOptions=function(e,t){if(t.thresholds&&0!==t.thresholds.length){var a,r,n,i=1/0,s=-1/0;for(a=0;a<t.thresholds.length;a++)if(r=t.thresholds[a],D.a.isNumber(r.value)){var o,l,u;switch(r.op){case"gt":o=i,t.thresholds.length>a+1&&(n=t.thresholds[a+1]).value>r.value&&(s=o=n.value);break;case"lt":o=s,t.thresholds.length>a+1&&(n=t.thresholds[a+1]).value<r.value&&(i=o=n.value)}switch(r.colorMode){case"critical":l="rgba(234, 112, 112, 0.12)",u="rgba(237, 46, 24, 0.60)";break;case"warning":l="rgba(235, 138, 14, 0.12)",u="rgba(247, 149, 32, 0.60)";break;case"ok":l="rgba(11, 237, 50, 0.090)",u="rgba(6,163,69, 0.60)";break;case"custom":l=r.fillColor,u=r.lineColor}r.fill&&("right"===r.yaxis&&this.hasSecondYAxis?e.grid.markings.push({y2axis:{from:r.value,to:o},color:l}):e.grid.markings.push({yaxis:{from:r.value,to:o},color:l})),r.line&&("right"===r.yaxis&&this.hasSecondYAxis?e.grid.markings.push({y2axis:{from:r.value,to:r.value},color:u}):e.grid.markings.push({yaxis:{from:r.value,to:r.value},color:u}))}}},e}();function mn(e,t,a,r,n){return e.map(function(e){var i=function(e){for(var t=[],a=0;a<e.length;a++)for(var r=e[a].datapoints,n=0;n<r.length;n++)null!==r[n][0]&&t.push(r[n][0]);return t}([e]);if(e.histogram=!0,a[e.alias])e.data=[];else{var s=function(e,t,a,r){for(var n={},i=fn(a,t),s=fn(r,t),o=i,l=0;o<=s;)n[o]=0,o=i+t*l,l++;for(var u=0;u<e.length;u++){var c=fn(e[u],t);n[c]=n[c]+1}var d=D.a.map(n,function(e,t){return[Number(t),e]});return D.a.sortBy(d,function(e){return e[0]})}(i,t,r,n);e.data=s}return e})}function fn(e,t){return Math.floor(e/t)*t}function gn(e,t){if(!isNaN(t)&&function(e){return 2===e.length&&vn(e[0])&&vn(e[1])}(e)){var a=e[0],r=e[1];!function(e,t,a){0!==a&&(e.min-=a,e.max-=a,t.min-=a,t.max-=a)}(a,r,t),function(e,t){e.max===e.min&&(e.min-=.25,e.max+=.25);t.max===t.min&&(t.min-=.25,t.max+=.25)}(a,r);var n=0===a.min||0===r.min||0===a.max||0===r.max,i=yn(a,r);if(n&&i)a.min=a.max>0?0:a.min,a.max=a.max>0?a.max:0,r.min=r.max>0?0:r.min,r.max=r.max>0?r.max:0;else if(function(e,t){return e.min>=0&&t.max<=0||e.max<=0&&t.min>=0}(a,r))a.min>=0?(a.min=-a.max,r.max=-r.min):(a.max=-a.min,r.min=-r.max);else{var s=function(e,t){var a,r;if(bn(e,t))a=t.min?e.min/t.min:0,r=t.max?e.max/t.max:0;else if(yn(e,t)){var n=Math.abs(e.min),i=Math.abs(e.max),s=Math.abs(t.min),o=Math.abs(t.max),l=D.a.max([n,i]),u=D.a.min([n,i]),c=D.a.max([s,o]),d=D.a.min([s,o]);a=u?l/u:l,r=d?c/d:c}else e.min>0||t.min>0?(a=e.max/t.max,r=0):(a=0,r=e.min/t.min);return a>r?a:r}(a,r);i?a.min>0?(a.min=a.max/s,r.min=r.max/s):(a.max=a.min/s,r.max=r.min/s):bn(a,r)?(a.min=r.min?r.min*s:a.min,r.min=a.min?a.min/s:r.min,a.max=r.max?r.max*s:a.max,r.max=a.max?a.max/s:r.max):(a.min=a.min>0?r.min*s:a.min,r.min=r.min>0?a.min/s:r.min,a.max=a.max<0?r.max*s:a.max,r.max=r.max<0?a.max/s:r.max)}!function(e,t,a){0!==a&&(e.min+=a,e.max+=a,t.min+=a,t.max+=a)}(a,r,t)}}function vn(e){return"min"in e&&"max"in e}function yn(e,t){return e.min>=0&&t.min>=0||e.max<=0&&t.max<=0}function bn(e,t){return e.min<=0&&e.max>=0&&t.min<=0&&t.max>=0}function Sn(e,t,a){return{restrict:"A",template:"",link:function(t,a){var r,n,i,s=t.ctrl,o=s.dashboard,l=s.panel,u=[],c=0,d=new te(s),p=new hn(s),h=new function(e,t,a,r){var n=this,i=a.ctrl.panel,s=j()('<div class="graph-tooltip">');this.destroy=function(){s.remove()},this.findHoverIndexFromDataPoints=function(e,t,a){var r,n=t.datapoints.pointsize,i=a*n,s=t.datapoints.points.length;for(r=i;r<s;r+=n)if(!t.lines.steps&&null!=t.datapoints.points[i]&&null==t.datapoints.points[r]||t.datapoints.points[r]>e)return Math.max(r-n,0)/n;return r/n-1},this.findHoverIndexFromData=function(e,t){for(var a,r=0,n=t.data.length-1;;){if(r>n)return Math.max(n,0);if(a=Math.floor((r+n)/2),t.data[a][0]===e)return a;t.data[a][0]<e?r=a+1:n=a-1}},this.renderAndShow=function(e,t,a,r){"time"===r&&(t='<div class="graph-tooltip-time">'+e+"</div>"+t),s.html(t).place_tt(a.pageX+20,a.pageY)},this.getMultiSeriesPlotHoverInfo=function(e,t){var a,r,n,s,o,l,u,c,d,p=[[],[],[]],h=0;for(r=0;r<e.length;r++)!(n=e[r]).data.length||i.legend.hideEmpty&&n.allIsNull?p[0].push({hidden:!0,value:0}):!n.data.length||i.legend.hideZero&&n.allIsZero?p[0].push({hidden:!0,value:0}):n.hideTooltip?p[0].push({hidden:!0,value:0}):(s=this.findHoverIndexFromData(t.x,n),o=t.x-n.data[s][0],l=n.data[s][0],(!c||o>=0&&(o<c||c<0)||o<0&&o>c)&&(c=o,d=l),a=n.stack?"individual"===i.tooltip.value_type?n.data[s][1]:n.stack?h+=n.data[s][1]:n.data[s][1]:n.data[s][1],(n.lines.steps||n.stack)&&(s=this.findHoverIndexFromDataPoints(t.x,n,s)),u=0,n.yaxis&&(u=n.yaxis.n),p[u].push({value:a,hoverIndex:s,color:n.color,label:n.aliasEscaped,time:l,distance:o,index:r}));return(p=p[0].concat(p[1],p[2])).time=d,p},e.mouseleave(function(){if(i.tooltip.shared){var t=e.data().plot;t&&(s.detach(),t.unhighlight())}W.b.emit("graph-hover-clear")}),e.bind("plothover",function(t,a,r){n.show(a,r),a.panelRelY=(a.pageY-e.offset().top)/e.height(),W.b.emit("graph-hover",{pos:a,panel:i})}),e.bind("plotclick",function(e,t,a){W.b.emit("graph-click",{pos:t,panel:i,item:a})}),this.clear=function(e){s.detach(),e.clearCrosshair(),e.unhighlight()},this.show=function(a,o){var l,u,c,d,p,h,m,f,g=e.data().plot,v=g.getData(),y=g.getXAxes()[0].options.mode,b=r(),S=i.tooltip.shared;if(a.panelRelY){var x=g.pointOffset({x:a.x});if(Number.isNaN(x.left)||x.left<0||x.left>e.width())return void n.clear(g);if(a.pageX=e.offset().left+x.left,a.pageY=e.offset().top+e.height()*a.panelRelY,!(a.pageY>=j()(window).scrollTop()&&a.pageY<=j()(window).innerHeight()+j()(window).scrollTop()))return void n.clear(g);if(g.setCrosshair(a),S=!0,t.sharedCrosshairModeOnly())return}if(0!==b.length)if(f=b[0].hasMsResolution?"YYYY-MM-DD HH:mm:ss.SSS":"YYYY-MM-DD HH:mm:ss",S){g.unhighlight();var w=n.getMultiSeriesPlotHoverInfo(v,a);for(m="",c=t.formatDate(w.time,f),2===i.tooltip.sort?w.sort(function(e,t){return t.value-e.value}):1===i.tooltip.sort&&w.sort(function(e,t){return e.value-t.value}),p=0;p<w.length;p++)if(!(d=w[p]).hidden){var k="";o&&d.index===o.seriesIndex&&(k="graph-tooltip-list-item--highlight"),u=(h=b[d.index]).formatValue(d.value),m+='<div class="graph-tooltip-list-item '+k+'"><div class="graph-tooltip-series-name">',m+='<i class="fa fa-minus" style="color:'+d.color+';"></i> '+d.label+":</div>",m+='<div class="graph-tooltip-value">'+u+"</div></div>",g.highlight(d.index,d.hoverIndex)}n.renderAndShow(c,m,a,y)}else o?(h=b[o.seriesIndex],l='<div class="graph-tooltip-list-item"><div class="graph-tooltip-series-name">',l+='<i class="fa fa-minus" style="color:'+o.series.color+';"></i> '+h.aliasEscaped+":</div>",u=i.stack&&"individual"===i.tooltip.value_type?o.datapoint[1]-o.datapoint[2]:o.datapoint[1],u=h.formatValue(u),c=t.formatDate(o.datapoint[0],f),l+='<div class="graph-tooltip-value">'+u+"</div>",n.renderAndShow(c,l,a,y)):s.detach()}}(a,o,t,function(){return i});function m(e){l.yaxes[0].label&&l.yaxes[0].show&&j()("<div class='axisLabel left-yaxis-label flot-temp-elem'></div>").text(l.yaxes[0].label).appendTo(a),l.yaxes[1].label&&l.yaxes[1].show&&j()("<div class='axisLabel right-yaxis-label flot-temp-elem'></div>").text(l.yaxes[1].label).appendTo(a),s.dataWarning&&j()('<div class="datapoints-warning flot-temp-elem">'+s.dataWarning.title+"</div>").appendTo(a),p.draw(e)}function f(e,t){var a=l.yaxes[0],r=l.yaxes[1];a.show&&a.label&&(t.left=20),r.show&&r.label&&(t.right=20);for(var n=e.getYAxes(),i=0;i<n.length;i++){var s=n[i],o=l.yaxes[i];s.options.max=null!==s.options.max?s.options.max:o.max,s.options.min=null!==s.options.min?s.options.min:o.min}}function g(e){var t=e.getYAxes(),a=l.yaxis.align||!1;if(t.length>1&&!0===a){var r=l.yaxis.alignLevel||0;gn(t,parseFloat(r))}}function v(e){for(var t=Number.MAX_VALUE,a=0;a<e.length;a++)if(e[a].stats.timeStep){if(l.bars){if(e[a].bars&&!1===e[a].bars.show)continue}else if(void 0===e[a].bars||void 0===e[a].bars.show||!e[a].bars.show)continue;e[a].stats.timeStep<t&&(t=e[a].stats.timeStep)}return t}function y(e){return l.percentage&&l.stack&&0===e?.001:e/10}function b(e){var t=c/100,a=D.a.isUndefined(s.range.from)?null:s.range.from.valueOf(),r=D.a.isUndefined(s.range.to)?null:s.range.to.valueOf();e.xaxis={timezone:o.getTimezone(),show:l.xaxis.show,mode:"time",min:a,max:r,label:"Datetime",ticks:t,timeformat:function(e,t,a){if(t&&a&&e){var r=a-t,n=r/e/1e3;return n<=45?"%H:%M:%S":n<=7200||r<=864e5?"%H:%M":n<=8e4?"%m/%d %H:%M":n<=2419200||r<=31536e6?"%m/%d":"%Y-%m"}return"%H:%M"}(t,a,r)}}function S(e){var t=D.a.map(r,function(e,t){return[t+1,e.alias]});e.xaxis={timezone:o.getTimezone(),show:l.xaxis.show,mode:null,min:0,max:t.length+1,label:"Datetime",ticks:t}}function x(e,t){var a,n,i,s=c/50;if(r.length&&t){for(var u=[],d=0,p=r;d<p.length;d++)for(var h=0,m=p[d].data;h<m.length;h++){u[m[h][0]]=!0}a=Object.keys(u).map(function(e){return Number(e)}),n=D.a.min(a),i=D.a.max(a);for(var f=t,g=Math.floor((i-n)/f);g>s;)f*=2,g=Math.ceil((i-n)/f);n=Math.floor(n/f)*f,i=Math.ceil(1.01*i/f)*f,a=[];for(var v=n;v<=i;v+=f)a.push(v)}else a=s/2,n=0,i=1;e.xaxis={timezone:o.getTimezone(),show:l.xaxis.show,mode:null,min:n,max:i,label:"Histogram",ticks:a},T(e.xaxis,"short")}function w(e){var t=D.a.map(r,function(e,t){return D.a.map(e.datapoints,function(a,r){return[t*e.datapoints.length+r+1,a[1]]})});t=D.a.flatten(t,!0),e.xaxis={timezone:o.getTimezone(),show:l.xaxis.show,mode:null,min:0,max:t.length+1,label:"Datetime",ticks:t}}function k(e){return null===e||void 0===e?null:D.a.toNumber(e)}function C(e,t){if(1!==e.logBase){var a,r,n=0===e.min;e.min<Number.MIN_VALUE&&(e.min=null),e.max<Number.MIN_VALUE&&(e.max=null);var i=e.max,o=e.min;for(r=0;r<t.length;r++)(a=t[r]).yaxis===e.index&&((!i||i<a.stats.max)&&(i=a.stats.max),(!o||o>a.stats.logmin)&&(o=a.stats.logmin));e.transform=function(t){return t<Number.MIN_VALUE?null:Math.log(t)/Math.log(e.logBase)},e.inverseTransform=function(t){return Math.pow(e.logBase,t)},i||o?i?o||(o=i*e.inverseTransform(-4)):i=o*e.inverseTransform(4):(i=e.inverseTransform(2),o=e.inverseTransform(-2)),o=e.min?e.inverseTransform(Math.ceil(e.transform(e.min))):e.min=e.inverseTransform(Math.floor(e.transform(o))),i=e.max?e.inverseTransform(Math.floor(e.transform(e.max))):e.max=e.inverseTransform(Math.ceil(e.transform(i))),!o||o<Number.MIN_VALUE||!i||i<Number.MIN_VALUE||(Number.isFinite(o)&&Number.isFinite(i)?(n&&(e.min=.1,o=1),e.ticks=function(e,t,a){var r,n=[];for(r=e;r<=t;r*=a)n.push(r);var i=Math.ceil(s.height/25),o=n.length;if(o>i){var l=Math.ceil(o/i)*a;for(n=[],r=e;r<=t*l;r*=l)n.push(r)}return n}(o,i,e.logBase),n&&e.ticks.unshift(.1),e.ticks[e.ticks.length-1]>e.max&&(e.max=e.ticks[e.ticks.length-1])):(e.ticks=[1,2],delete e.min,delete e.max))}}function T(e,t){e.tickFormatter=function(e,a){if(!A.a.valueFormats[t])throw new Error("Unit '"+t+"' is not supported");return A.a.valueFormats[t](e,a.tickDecimals,a.scaledDecimals)}}s.events.on("panel-teardown",function(){p=null,n&&(n.destroy(),n=null)}),s.events.on("render",function(e){if(r=e||r){u=s.annotations||[],function(e){for(var t=0;t<e.length;t++){var a=e[t];a.data=a.getFlotPairs(a.nullPointMode||l.nullPointMode),s.hiddenSeries[a.alias]&&(a.data=[],a.stack=!1)}}(r);var t=a.height();Object(W.g)(r,l,t),s.events.emit("render-legend")}}),s.events.on("legend-rendering-complete",function(){!function(){if(c=a.width(),!r||0===c)return;p.prepare(a,r),l.dashes=!!l.lines&&l.dashes;var e=function(e){var t="#c8c8c8";!0===_e.a.bootData.user.lightTheme&&(t="#a1a1a1");var a=!!e.stack||null;return{hooks:{draw:[m],processOffset:[f],processRange:[g]},legend:{show:!1},series:{stackpercent:!!e.stack&&e.percentage,stack:e.percentage?null:a,lines:{show:e.lines,zero:!1,fill:y(e.fill),lineWidth:e.dashes?0:e.linewidth,steps:e.steppedLine},dashes:{show:e.dashes,lineWidth:e.linewidth,dashLength:[e.dashLength,e.spaceLength]},bars:{show:e.bars,fill:1,barWidth:1,zero:!1,lineWidth:0},points:{show:e.points,fill:1,fillColor:!1,radius:e.points?e.pointradius:2},shadowSize:0},yaxes:[],xaxis:{},grid:{minBorderMargin:0,markings:[],backgroundColor:null,borderWidth:0,hoverable:!0,clickable:!0,color:t,margin:{left:0,right:0},labelMarginX:0},selection:{mode:"x",color:"#666"},crosshair:{mode:"x"}}}(l);(function(e,t){switch(t.xaxis.mode){case"series":e.series.bars.barWidth=.7,e.series.bars.align="center";for(var a=0;a<r.length;a++){var n=r[a];n.data=[[a+1,n.stats[t.xaxis.values[0]]]]}S(e);break;case"histogram":var i=void 0;if(r.length){var o=D.a.min(D.a.map(r,function(e){return e.stats.min})),l=D.a.max(D.a.map(r,function(e){return e.stats.max})),u=t.xaxis.buckets||c/50;i=Object(Dt.tickStep)(o,l,u),e.series.bars.barWidth=.8*i,r=mn(r,i,s.hiddenSeries,o,l)}else i=0;x(e,i);break;case"table":e.series.bars.barWidth=.7,e.series.bars.align="center",w(e);break;default:e.series.bars.barWidth=v(r)/1.5,b(e)}})(e,l),function(e,t){var a={position:"left",show:l.yaxes[0].show,index:1,logBase:l.yaxes[0].logBase||1,min:k(l.yaxes[0].min),max:k(l.yaxes[0].max),tickDecimals:l.yaxes[0].decimals};if(t.yaxes.push(a),D.a.find(e,{yaxis:2})){var r=D.a.clone(a);r.index=2,r.show=l.yaxes[1].show,r.logBase=l.yaxes[1].logBase||1,r.position="right",r.min=k(l.yaxes[1].min),r.max=k(l.yaxes[1].max),r.tickDecimals=l.yaxes[1].decimals,t.yaxes.push(r),C(t.yaxes[1],e),T(t.yaxes[1],l.percentage&&l.stack?"percent":l.yaxes[1].format)}C(t.yaxes[0],e),T(t.yaxes[0],l.percentage&&l.stack?"percent":l.yaxes[0].format)}(r,e),p.addFlotOptions(e,l),d.addFlotEvents(u,e),i=function(e,t){var a=t.legend.sort,r=t.legend.sortDesc,n=null!==a&&void 0!==a,i=null!==r&&void 0!==r,s=t.stack&&n&&i,o=!0===t.legend.sortDesc?-1:1;return s?D.a.sortBy(e,function(e){return e.stats[a]*o}):D.a.sortBy(e,function(e){return e.zindex})}(r,l),function(e,t){try{n=j.a.plot(a,i,e),s.renderError&&(delete s.error,delete s.inspector)}catch(e){console.log("flotcharts error",e),s.error=e.message||"Render Error",s.renderError=!0,s.inspector={error:e}}t&&s.renderingCompleted()}(e,!0)}()}),W.b.on("graph-hover",function(e){o.sharedTooltipModeEnabled()&&n&&e.panel.id!==l.id&&!s.otherPanelInFullscreenMode()&&h.show(e.pos)},t),W.b.on("graph-hover-clear",function(e,t){n&&h.clear(n)},t),a.bind("plotselected",function(a,r){"time"===l.xaxis.mode?(r.ctrlKey||r.metaKey)&&(o.meta.canEdit||o.meta.canMakeEditable)?setTimeout(function(){d.updateTime(r.xaxis)},100):t.$apply(function(){e.setTime({from:Y.a.utc(r.xaxis.from),to:Y.a.utc(r.xaxis.to)})}):n.clearSelection()}),a.bind("plotclick",function(e,t,a){"time"===l.xaxis.mode&&((t.ctrlKey||t.metaKey)&&(o.meta.canEdit||o.meta.canMakeEditable)&&(t.x!==t.x1||setTimeout(function(){d.updateTime({from:t.x,to:null})},100)))}),t.$on("$destroy",function(){h.destroy(),a.off(),a.remove()})}}}W.d.directive("grafanaGraph",Sn);var xn=a(221),wn=a.n(xn);function kn(e,t,a){e.overrideMenu=[],e.currentOverrides=[],e.override=e.override||{},e.addOverrideOption=function(t,a,r){var n={text:t,propertyName:a,index:e.overrideMenu.lenght,values:r,submenu:D.a.map(r,function(e){return{text:String(e),value:e}})};e.overrideMenu.push(n)},e.setOverride=function(t,a){"color"!==t.propertyName?(e.override[t.propertyName]=a.value,"fillBelowTo"===t.propertyName&&(e.override.lines=!1,e.ctrl.addSeriesOverride({alias:a.value,lines:!1})),e.updateCurrentOverrides(),e.ctrl.render()):e.openColorSelector(e.override.color)},e.colorSelected=function(t){e.override.color=t,e.updateCurrentOverrides(),e.ctrl.render()},e.openColorSelector=function(r){var n={color:r};a.show({element:t.find(".dropdown")[0],position:"top center",openOn:"click",template:'<series-color-picker series="series" onColorChange="colorSelected" />',model:{autoClose:!0,colorSelected:e.colorSelected,series:n},onClose:function(){e.ctrl.render()}})},e.removeOverride=function(t){delete e.override[t.propertyName],e.updateCurrentOverrides(),e.ctrl.refresh()},e.getSeriesNames=function(){return D.a.map(e.ctrl.seriesList,function(e){return e.alias})},e.updateCurrentOverrides=function(){e.currentOverrides=[],D.a.each(e.overrideMenu,function(t){var a=e.override[t.propertyName];D.a.isUndefined(a)||e.currentOverrides.push({name:t.text,propertyName:t.propertyName,value:String(a)})})},e.addOverrideOption("条状","bars",[!0,!1]),e.addOverrideOption("线条","lines",[!0,!1]),e.addOverrideOption("填充线条","fill",[0,1,2,3,4,5,6,7,8,9,10]),e.addOverrideOption("线条宽度","linewidth",[0,1,2,3,4,5,6,7,8,9,10]),e.addOverrideOption("空点模式","nullPointMode",["connected","null","null as zero"]),e.addOverrideOption("填满以下","fillBelowTo",e.getSeriesNames()),e.addOverrideOption("楼梯线","steppedLine",[!0,!1]),e.addOverrideOption("虚线","dashes",[!0,!1]),e.addOverrideOption("虚线长度","dashLength",[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]),e.addOverrideOption("虚线空间","spaceLength",[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]),e.addOverrideOption("点状","points",[!0,!1]),e.addOverrideOption("点半径","pointradius",[1,2,3,4,5]),e.addOverrideOption("栈式","stack",[!0,!1,"A","B","C","D"]),e.addOverrideOption("颜色","color",["change"]),e.addOverrideOption("Y-轴","yaxis",[1,2]),e.addOverrideOption("Z-索引","zindex",[-3,-2,-1,0,1,2,3]),e.addOverrideOption("转换","transform",["negative-Y"]),e.addOverrideOption("图例","legend",[!0,!1]),e.addOverrideOption("提示文本框中隐藏","hideTooltip",[!0,!1]),e.updateCurrentOverrides()}P.a.module("grafana.directives").directive("graphLegend",["popoverSrv","$timeout",function(e,t){return{link:function(a,r){var n,i,s,o,l=!0,u=a.ctrl,c=u.panel,d=10,p=r.parent();function h(e){return e.parents("[data-series-index]").data("series-index")}function m(a){if(!j()(a.target).parents(".popover").length){var r=j()(a.currentTarget).find(".fa-minus"),n=h(r),s=i[n];t(function(){e.show({element:r[0],position:"bottom left",targetAttachment:"top left",template:'<series-color-picker series="series" onToggleAxis="toggleAxis" onColorChange="colorSelected"></series-color-picker>',openOn:"hover",model:{series:s,toggleAxis:function(){u.toggleAxis(s)},colorSelected:function(e){u.changeSeriesColor(s,e)}}})})}}function f(e){var t=h(j()(e.currentTarget)),a=i[t],n=j()(r.children("tbody")).scrollTop();u.toggleSeries(a,e),j()(r.children("tbody")).scrollTop(n)}function g(e){var t=j()(e.currentTarget).data("stat");if(t!==c.legend.sort&&(c.legend.sortDesc=null),!1===c.legend.sortDesc)return c.legend.sort=null,c.legend.sortDesc=null,void u.render();c.legend.sortDesc=!c.legend.sortDesc,c.legend.sort=t,u.render()}function v(e){if(!c.legend[e])return"";var t='<th class="pointer" data-stat="'+e+'">'+e;c.legend.sort===e&&(t+=' <span class="'+(c.legend.sortDesc?"fa fa-caret-down":"fa fa-caret-up")+'"></span>');return t+"</th>"}function y(e){var t=r.width(),a=function(){var e=[];for(s=0;s<i.length;s++){var t=i[s];if(!t.hideFromLegend(c.legend)){var a='<div class="graph-legend-series';if(2===t.yaxis&&(a+=" graph-legend-series--right-y"),u.hiddenSeries[t.alias]&&(a+=" graph-legend-series-hidden"),a+='" data-series-index="'+s+'">',a+='<div class="graph-legend-icon">',a+='<i class="fa fa-minus pointer" style="color:'+t.color+'"></i>',a+="</div>",a+='<a class="graph-legend-alias pointer" title="'+t.aliasEscaped+'">'+t.aliasEscaped+"</a>",c.legend.values){var r=t.formatValue(t.stats.avg),n=t.formatValue(t.stats.current),o=t.formatValue(t.stats.min),l=t.formatValue(t.stats.max),d=t.formatValue(t.stats.total);c.legend.min&&(a+='<div class="graph-legend-value min">'+o+"</div>"),c.legend.max&&(a+='<div class="graph-legend-value max">'+l+"</div>"),c.legend.avg&&(a+='<div class="graph-legend-value avg">'+r+"</div>"),c.legend.current&&(a+='<div class="graph-legend-value current">'+n+"</div>"),c.legend.total&&(a+='<div class="graph-legend-value total">'+d+"</div>")}a+="</div>",e.push(j()(a))}}return e}();if(c.legend.alignAsTable){var n=j()("<tbody></tbody>");n.append(e),n.append(a),r.append(n),n.wrap('<div class="graph-legend-scroll"></div>')}else r.append('<div class="graph-legend-scroll"></div>'),r.find(".graph-legend-scroll").append(a);!c.legend.rightSide||c.legend.rightSide&&t!==d?function(){var e=r,t=r.find(".graph-legend-scroll");e.find(".baron__track").remove(),e.addClass("baron baron__root"),j()('\n          <div class="baron__track">\n            <div class="baron__bar"></div>\n          </div>\n        ').appendTo(e),t.addClass("baron__scroller");var a={root:e[0],scroller:t[0],bar:".baron__bar",track:".baron__track",barOnCls:"_scrollbar",scrollingCls:"_scrolling"};o?(b(),o=wn()(a)):o=wn()(a);t[0].style.marginRight="-"+(t[0].offsetWidth-t[0].clientWidth)+"px",o.scroll()}():b()}function b(){o&&(o.dispose(),o=void 0)}a.$on("$destroy",function(){b()}),u.events.on("render-legend",function(){(n=u.seriesList)&&function(){var e=p.width();if(!u.panel.legend.show)return r.empty(),void(l=!0);l&&(r.on("click",".graph-legend-icon",m),r.on("click",".graph-legend-alias",f),r.on("click","th",g),l=!1);i=n,r.empty();var t,a=c.legend.rightSide&&c.legend.sideWidth?c.legend.sideWidth+"px":"",s=c.legend.rightSide&&c.legend.sideWidth?c.legend.sideWidth-1+"px":"";if(p.css("min-width",a),p.css("width",s),r.toggleClass("graph-legend-table",!0===c.legend.alignAsTable),c.legend.alignAsTable){var o="<tr>";o+='<th colspan="2" style="text-align:left"></th>',c.legend.values&&(o+=v("min"),o+=v("max"),o+=v("avg"),o+=v("current"),o+=v("total")),o+="</tr>",t=j()(o)}c.legend.sort&&(i=D.a.sortBy(i,function(e){var t=e.stats[c.legend.sort];return null===t&&(t=-1/0),t}),c.legend.sortDesc&&(i=i.reverse()));(!c.legend.rightSide||c.legend.rightSide&&e!==d)&&(y(t),r.empty());y(t)}(),u.events.emit("legend-rendering-complete")})}}}]),P.a.module("grafana.controllers").controller("SeriesOverridesCtrl",kn);var Cn=function(){function e(e){var t=this;this.panel=this.panelCtrl.panel,this.panel.alert&&(this.disabled=!0);var a=e.$on("$destroy",function(){t.panelCtrl.editingThresholds=!1,t.panelCtrl.render(),a()});this.panelCtrl.editingThresholds=!0}return e.$inject=["$scope"],e.prototype.addThreshold=function(){this.panel.thresholds.push({value:void 0,colorMode:"critical",op:"gt",fill:!0,line:!0,yaxis:"left"}),this.panelCtrl.render()},e.prototype.removeThreshold=function(e){this.panel.thresholds.splice(e,1),this.panelCtrl.render()},e.prototype.render=function(){this.panelCtrl.render()},e.prototype.onFillColorChange=function(e){var t=this;return function(a){t.panel.thresholds[e].fillColor=a,t.render()}},e.prototype.onLineColorChange=function(e){var t=this;return function(a){t.panel.thresholds[e].lineColor=a,t.render()}},e}();U.a.directive("graphThresholdForm",function(){return{restrict:"E",template:'\n<div class="gf-form-group">\n  <h5>阈值</h5>\n  <p class="muted" ng-show="ctrl.disabled">\n    <strong>已禁用</strong>查看阈值选项\n    查看报警选项卡更新阈值。 <br>\n    要重新启用阈值，必须从该面板中删除报警规则。\n  </p>\n  <div ng-class="{\'thresholds-form-disabled\': ctrl.disabled}">\n    <div class="gf-form-inline" ng-repeat="threshold in ctrl.panel.thresholds">\n      <div class="gf-form">\n        <label class="gf-form-label">T{{$index+1}}</label>\n      </div>\n\n      <div class="gf-form">\n        <div class="gf-form-select-wrapper">\n          <select class="gf-form-input" ng-model="threshold.op"\n                  ng-options="f for f in [\'gt\', \'lt\']" ng-change="ctrl.render()" ng-disabled="ctrl.disabled"></select>\n        </div>\n        <input type="number" ng-model="threshold.value" class="gf-form-input width-8"\n               ng-change="ctrl.render()" placeholder="值" ng-disabled="ctrl.disabled">\n      </div>\n\n      <div class="gf-form">\n        <label class="gf-form-label">颜色</label>\n        <div class="gf-form-select-wrapper">\n          <select class="gf-form-input" ng-model="threshold.colorMode"\n                  ng-options="f for f in [\'custom\', \'critical\', \'warning\', \'ok\']" ng-change="ctrl.render()" ng-disabled="ctrl.disabled">\n          </select>\n        </div>\n      </div>\n\n      <gf-form-switch class="gf-form" label="Fill" checked="threshold.fill"\n                      on-change="ctrl.render()" ng-disabled="ctrl.disabled"></gf-form-switch>\n\n      <div class="gf-form" ng-if="threshold.fill && threshold.colorMode === \'custom\'">\n        <label class="gf-form-label">填充颜色</label>\n        <span class="gf-form-label">\n          <color-picker color="threshold.fillColor" onChange="ctrl.onFillColorChange($index)"></color-picker>\n        </span>\n      </div>\n\n      <gf-form-switch class="gf-form" label="线段" checked="threshold.line"\n                      on-change="ctrl.render()" ng-disabled="ctrl.disabled"></gf-form-switch>\n\n      <div class="gf-form" ng-if="threshold.line && threshold.colorMode === \'custom\'">\n        <label class="gf-form-label">线段颜色</label>\n        <span class="gf-form-label">\n          <color-picker color="threshold.lineColor" onChange="ctrl.onLineColorChange($index)"></color-picker>\n        </span>\n      </div>\n\n      <div class="gf-form">\n        <label class="gf-form-label">Y-轴</label>\n        <div class="gf-form-select-wrapper">\n          <select class="gf-form-input" ng-model="threshold.yaxis"\n                  ng-init="threshold.yaxis = threshold.yaxis === \'left\' || threshold.yaxis === \'right\' ? threshold.yaxis : \'left\'"\n                  ng-options="f for f in [\'left\', \'right\']" ng-change="ctrl.render()" ng-disabled="ctrl.disabled">\n          </select>\n        </div>\n      </div>\n\n      <div class="gf-form">\n        <label class="gf-form-label">\n          <a class="pointer" ng-click="ctrl.removeThreshold($index)" ng-disabled="ctrl.disabled">\n            <i class="fa fa-trash"></i>\n          </a>\n        </label>\n      </div>\n    </div>\n\n    <div class="gf-form-button-row">\n      <button class="btn btn-inverse" ng-click="ctrl.addThreshold()" ng-disabled="ctrl.disabled">\n        <i class="fa fa-plus"></i>&nbsp;Add Threshold\n      </button>\n    </div>\n  </div>\n</div>\n',controller:Cn,bindToController:!0,controllerAs:"ctrl",scope:{panelCtrl:"="}}});var Tn=function(){function e(e){this.panel=e}return e.prototype.getSeriesList=function(e){var t,a=this;if(!e.dataList||0===e.dataList.length)return[];if(e.dataList&&e.dataList.length>0){t=e.dataList[0];var r=this.getAutoDetectXAxisMode(t);this.panel.xaxis.mode!==r&&(this.panel.xaxis.mode=r,this.setPanelDefaultsForNewXAxisMode())}switch(this.panel.xaxis.mode){case"series":case"time":return e.dataList.map(function(t,r){return a.timeSeriesHandler(t,r,e)});case"histogram":return(this.panel.stack?e.dataList:[{target:"count",datapoints:D.a.concat([],D.a.flatten(D.a.map(e.dataList,"datapoints")))}]).map(function(t,r){return a.timeSeriesHandler(t,r,e)});case"field":return this.customHandler(t)}},e.prototype.getAutoDetectXAxisMode=function(e){switch(e.type){case"docs":case"table":return"field";default:return"series"===this.panel.xaxis.mode?"series":"histogram"===this.panel.xaxis.mode?"histogram":"time"}},e.prototype.setPanelDefaultsForNewXAxisMode=function(){switch(this.panel.xaxis.mode){case"time":this.panel.bars=!1,this.panel.lines=!0,this.panel.points=!1,this.panel.legend.show=!0,this.panel.tooltip.shared=!0,this.panel.xaxis.values=[];break;case"series":this.panel.bars=!0,this.panel.lines=!1,this.panel.points=!1,this.panel.stack=!1,this.panel.legend.show=!1,this.panel.tooltip.shared=!1,this.panel.xaxis.values=["total"];break;case"histogram":this.panel.bars=!0,this.panel.lines=!1,this.panel.points=!1,this.panel.stack=!1,this.panel.legend.show=!1,this.panel.tooltip.shared=!1}},e.prototype.timeSeriesHandler=function(e,t,a){var r=e.datapoints||[],n=e.target,i=t%ee.f.length,s=this.panel.aliasColors[n]||ee.f[i],o=new ot.a({datapoints:r,alias:n,color:s,unit:e.unit});r&&r.length>0&&(r[r.length-1][1]-a.range.from<-1e4&&(o.isOutsideRange=!0));return o},e.prototype.customHandler=function(e){if(!this.panel.xaxis.name)throw{message:"No field name specified to use for x-axis, check your axes settings"};return[]},e.prototype.validateXAxisSeriesValue=function(){switch(this.panel.xaxis.mode){case"series":if(0===this.panel.xaxis.values.length)return void(this.panel.xaxis.values=["total"]);var e=this.getXAxisValueOptions({});return void(D.a.find(e,{value:this.panel.xaxis.values[0]})||(this.panel.xaxis.values=["total"]))}},e.prototype.getDataFieldNames=function(e,t){if(0===e.length)return[];var a=[],r=e[0],n=[];if("docs"===r.type){if(0===r.datapoints.length)return[];!function e(r){D.a.forEach(r,function(r,i){if(D.a.isObject(r))n.push(i),e(r);else if(!t||D.a.isNumber(r)){var s=n.concat(i).join(".");a.push(s)}}),n.pop()}(r.datapoints[0])}return a},e.prototype.getXAxisValueOptions=function(e){switch(this.panel.xaxis.mode){case"series":return[{text:"Avg",value:"avg"},{text:"Min",value:"min"},{text:"Max",value:"max"},{text:"Total",value:"total"},{text:"Count",value:"count"}]}return[]},e.prototype.pluckDeep=function(e,t){for(var a=t.split("."),r=e,n=0;n<a.length;++n){if(!r[a[n]])return;r=r[a[n]]}return r},e}(),_n=function(){function e(e,t){this.$scope=e,this.$q=t,this.panelCtrl=e.ctrl,this.panel=this.panelCtrl.panel,this.$scope.ctrl=this,this.unitFormats=A.a.getUnitFormats(),this.logScales={linear:1,"log (base 2)":2,"log (base 10)":10,"log (base 32)":32,"log (base 1024)":1024},this.xAxisModes={Time:"time",Series:"series",Histogram:"histogram"},this.xAxisStatOptions=[{text:"Avg",value:"avg"},{text:"Min",value:"min"},{text:"Max",value:"max"},{text:"Total",value:"total"},{text:"Count",value:"count"},{text:"Current",value:"current"}],"custom"===this.panel.xaxis.mode&&(this.panel.xaxis.name||(this.panel.xaxis.name="specify field"))}return e.$inject=["$scope","$q"],e.prototype.setUnitFormat=function(e,t){e.format=t.value,this.panelCtrl.render()},e.prototype.render=function(){this.panelCtrl.render()},e.prototype.xAxisModeChanged=function(){this.panelCtrl.processor.setPanelDefaultsForNewXAxisMode(),this.panelCtrl.onDataReceived(this.panelCtrl.dataList)},e.prototype.xAxisValueChanged=function(){this.panelCtrl.onDataReceived(this.panelCtrl.dataList)},e.prototype.getDataFieldNames=function(e){var t=this.panelCtrl.processor.getDataFieldNames(this.panelCtrl.dataList,e).map(function(e){return{text:e,value:e}});return this.$q.when(t)},e}();function Mn(){return{restrict:"E",scope:!0,templateUrl:"public/app/plugins/panel/graph/axes_editor.html",controller:_n}}var $n=function(e){function t(t,a,r){var n=e.call(this,t,a)||this;return n.annotationsSrv=r,n.hiddenSeries={},n.seriesList=[],n.dataList=[],n.annotations=[],n.colors=[],n.panelDefaults={datasource:null,renderer:"flot",yaxes:[{label:null,show:!0,logBase:1,min:null,max:null,format:"short"},{label:null,show:!0,logBase:1,min:null,max:null,format:"short"}],xaxis:{show:!0,mode:"time",name:null,values:[],buckets:null},yaxis:{align:!1,alignLevel:null},lines:!0,fill:1,linewidth:1,dashes:!1,dashLength:10,spaceLength:10,points:!1,pointradius:5,bars:!1,stack:!1,percentage:!1,legend:{show:!0,values:!1,min:!1,max:!1,current:!1,total:!1,avg:!1},nullPointMode:"null",steppedLine:!1,tooltip:{value_type:"individual",shared:!0,sort:0},timeFrom:null,timeShift:null,targets:[{}],aliasColors:{},seriesOverrides:[],thresholds:[]},D.a.defaults(n.panel,n.panelDefaults),D.a.defaults(n.panel.tooltip,n.panelDefaults.tooltip),D.a.defaults(n.panel.legend,n.panelDefaults.legend),D.a.defaults(n.panel.xaxis,n.panelDefaults.xaxis),n.processor=new Tn(n.panel),n.events.on("render",n.onRender.bind(n)),n.events.on("data-received",n.onDataReceived.bind(n)),n.events.on("data-error",n.onDataError.bind(n)),n.events.on("data-snapshot-load",n.onDataSnapshotLoad.bind(n)),n.events.on("init-edit-mode",n.onInitEditMode.bind(n)),n.events.on("init-panel-actions",n.onInitPanelActions.bind(n)),n}return t.$inject=["$scope","$injector","annotationsSrv"],je.d(t,e),t.prototype.onInitEditMode=function(){this.addEditorTab("坐标轴",Mn,2),this.addEditorTab("图例","public/app/plugins/panel/graph/tab_legend.html",3),this.addEditorTab("展示","public/app/plugins/panel/graph/tab_display.html",4),_e.a.alertingEnabled&&this.addEditorTab("报警",Je,5),this.subTabIndex=0},t.prototype.onInitPanelActions=function(e){e.push({text:"导出 CSV",click:"ctrl.exportCsv()"}),e.push({text:"启用图例",click:"ctrl.toggleLegend()"})},t.prototype.issueQueries=function(t){return this.annotationsPromise=this.annotationsSrv.getAnnotations({dashboard:this.dashboard,panel:this.panel,range:this.range}),e.prototype.issueQueries.call(this,t)},t.prototype.zoomOut=function(e){this.publishAppEvent("zoom-out",2)},t.prototype.onDataSnapshotLoad=function(e){this.annotationsPromise=this.annotationsSrv.getAnnotations({dashboard:this.dashboard,panel:this.panel,range:this.range}),this.onDataReceived(e)},t.prototype.onDataError=function(e){this.seriesList=[],this.annotations=[],this.render([])},t.prototype.onDataReceived=function(e){var t=this;if(this.dataList=e,this.seriesList=this.processor.getSeriesList({dataList:e,range:this.range}),this.dataWarning=null,0===this.seriesList.reduce(function(e,t){return e+t.datapoints.length},0))this.dataWarning={title:"暂无数据点",tip:"数据查询中无数据点返回"};else for(var a=0,r=this.seriesList;a<r.length;a++){if(r[a].isOutsideRange){this.dataWarning={title:"数据点不在时间范围内",tip:"由时区失配或时间过滤设置不当引起"};break}}this.annotationsPromise.then(function(e){t.loading=!1,t.alertState=e.alertState,t.annotations=e.annotations,t.render(t.seriesList)},function(){t.loading=!1,t.render(t.seriesList)})},t.prototype.onRender=function(){if(this.seriesList)for(var e=0,t=this.seriesList;e<t.length;e++){var a=t[e];a.applySeriesOverrides(this.panel.seriesOverrides),a.unit&&(this.panel.yaxes[a.yaxis-1].format=a.unit)}},t.prototype.changeSeriesColor=function(e,t){e.setColor(t),this.panel.aliasColors[e.alias]=e.color,this.render()},t.prototype.toggleSeries=function(e,t){t.ctrlKey||t.metaKey||t.shiftKey?this.hiddenSeries[e.alias]?delete this.hiddenSeries[e.alias]:this.hiddenSeries[e.alias]=!0:this.toggleSeriesExclusiveMode(e),this.render()},t.prototype.toggleSeriesExclusiveMode=function(e){var t=this,a=this.hiddenSeries;a[e.alias]&&delete a[e.alias],D.a.every(this.seriesList,function(t){return t.alias===e.alias||a[t.alias]})?D.a.each(this.seriesList,function(e){delete t.hiddenSeries[e.alias]}):D.a.each(this.seriesList,function(a){a.alias!==e.alias&&(t.hiddenSeries[a.alias]=!0)})},t.prototype.toggleAxis=function(e){var t=D.a.find(this.panel.seriesOverrides,{alias:e.alias});t||(t={alias:e.alias},this.panel.seriesOverrides.push(t)),e.yaxis=t.yaxis=2===e.yaxis?1:2,this.render()},t.prototype.addSeriesOverride=function(e){this.panel.seriesOverrides.push(e||{})},t.prototype.removeSeriesOverride=function(e){this.panel.seriesOverrides=D.a.without(this.panel.seriesOverrides,e),this.render()},t.prototype.toggleLegend=function(){this.panel.legend.show=!this.panel.legend.show,this.refresh()},t.prototype.legendValuesOptionChanged=function(){var e=this.panel.legend;e.values=e.min||e.max||e.avg||e.current||e.total,this.render()},t.prototype.exportCsv=function(){var e=this.$scope.$new(!0);e.seriesList=this.seriesList,this.publishAppEvent("show-modal",{templateHtml:'<export-data-modal data="seriesList"></export-data-modal>',scope:e,modalClass:"modal--narrow"})},t.template='\n<div class="graph-panel" ng-class="{\'graph-panel--legend-right\': ctrl.panel.legend.rightSide}">\n  <div class="graph-panel__chart" grafana-graph ng-dblclick="ctrl.zoomOut()">\n  </div>\n\n  <div class="graph-legend">\n    <div class="graph-legend-content" graph-legend></div>\n  </div>\n</div>\n',t}(He),Pn=function(e){function t(t,a,r,n){var i=e.call(this,t,a)||this;return i.backendSrv=r,i.dashboardSrv=n,i.panelDefaults={query:"",limit:10,tags:[],recent:!1,search:!1,starred:!0,headings:!0,folderId:null},D.a.defaults(i.panel,i.panelDefaults),i.panel.tag&&(i.panel.tags=[i.panel.tag],delete i.panel.tag),i.events.on("refresh",i.onRefresh.bind(i)),i.events.on("init-edit-mode",i.onInitEditMode.bind(i)),i.groups=[{list:[],show:!1,header:"收藏的仪表盘"},{list:[],show:!1,header:"最近查看的仪表盘"},{list:[],show:!1,header:"搜索"}],i.panel.mode&&("starred"===i.panel.mode&&(i.panel.starred=!0,i.panel.headings=!1),"recently viewed"===i.panel.mode&&(i.panel.recent=!0,i.panel.starred=!1,i.panel.headings=!1),"search"===i.panel.mode&&(i.panel.search=!0,i.panel.starred=!1,i.panel.headings=!1),delete i.panel.mode),i}return t.$inject=["$scope","$injector","backendSrv","dashboardSrv"],je.d(t,e),t.prototype.onInitEditMode=function(){this.editorTabIndex=1,this.modes=["starred","search","recently viewed"],this.addEditorTab("选项","public/app/plugins/panel/dashlist/editor.html")},t.prototype.onRefresh=function(){var e=[];return e.push(this.getRecentDashboards()),e.push(this.getStarred()),e.push(this.getSearch()),Promise.all(e).then(this.renderingCompleted.bind(this))},t.prototype.getSearch=function(){var e=this;if(this.groups[2].show=this.panel.search,!this.panel.search)return Promise.resolve();var t={limit:this.panel.limit,query:this.panel.query,tag:this.panel.tags,folderIds:this.panel.folderId,type:"dash-db"};return this.backendSrv.search(t).then(function(t){e.groups[2].list=t})},t.prototype.getStarred=function(){var e=this;if(this.groups[0].show=this.panel.starred,!this.panel.starred)return Promise.resolve();var t={limit:this.panel.limit,starred:"true"};return this.backendSrv.search(t).then(function(t){e.groups[0].list=t})},t.prototype.starDashboard=function(e,t){this.dashboardSrv.starDashboard(e.id,e.isStarred).then(function(t){e.isStarred=t}),t&&(t.stopPropagation(),t.preventDefault())},t.prototype.getRecentDashboards=function(){var e=this;if(this.groups[1].show=this.panel.recent,!this.panel.recent)return Promise.resolve();var t=D.a.take(At.a.getDashboardOpened(),this.panel.limit);return this.backendSrv.search({dashboardIds:t,limit:this.panel.limit}).then(function(a){e.groups[1].list=t.map(function(e){return D.a.find(a,function(t){return t.id===e})}).filter(function(e){return void 0!==e})})},t.prototype.onFolderChange=function(e){this.panel.folderId=e.id,this.refresh()},t.templateUrl="module.html",t.scrollable=!0,t}(Ne),En=function(e){function t(t,a,r){var n=e.call(this,t,a)||this;return n.backendSrv=r,n.panelDefaults={},D.a.defaults(n.panel,n.panelDefaults),n.events.on("init-edit-mode",n.onInitEditMode.bind(n)),n.pluginList=[],n.viewModel=[{header:"已安装应用",list:[],type:"app"},{header:"已安装插件",list:[],type:"panel"},{header:"已安装数据源",list:[],type:"datasource"}],n.update(),n}return t.$inject=["$scope","$injector","backendSrv"],je.d(t,e),t.prototype.onInitEditMode=function(){this.editorTabIndex=1,this.addEditorTab("Options","public/app/plugins/panel/pluginlist/editor.html")},t.prototype.gotoPlugin=function(e,t){t&&t.stopPropagation(),this.$location.url("plugins/"+e.id+"/edit")},t.prototype.updateAvailable=function(e,t){t.stopPropagation(),t.preventDefault();var a=this.$scope.$new(!0);a.plugin=e,this.publishAppEvent("show-modal",{src:"public/app/features/plugins/partials/update_instructions.html",scope:a})},t.prototype.update=function(){var e=this;this.backendSrv.get("api/plugins",{embedded:0,core:0}).then(function(t){e.pluginList=t,e.viewModel[0].list=D.a.filter(t,{type:"app"}),e.viewModel[1].list=D.a.filter(t,{type:"panel"}),e.viewModel[2].list=D.a.filter(t,{type:"datasource"});for(var a=0,r=e.pluginList;a<r.length;a++){var n=r[a];n.hasUpdate?n.state="has-update":n.enabled||(n.state="not-enabled")}})},t.templateUrl="module.html",t.scrollable=!0,t}(Ne),Dn=function(e){function t(t,a,r){var n=e.call(this,t,a)||this;for(var i in n.backendSrv=r,n.showOptions=[{text:"当前状态",value:"current"},{text:"近期状态改变",value:"changes"}],n.sortOrderOptions=[{text:"字母序 (升序)",value:1},{text:"字母序 (降序)",value:2},{text:"重要因子",value:3}],n.stateFilter={},n.currentAlerts=[],n.alertHistory=[],n.panelDefaults={show:"current",limit:10,stateFilter:[],onlyAlertsOnDashboard:!1,sortOrder:1,dashboardFilter:"",nameFilter:"",folderId:null},D.a.defaults(n.panel,n.panelDefaults),n.events.on("init-edit-mode",n.onInitEditMode.bind(n)),n.events.on("refresh",n.onRefresh.bind(n)),n.panel.stateFilter)n.stateFilter[n.panel.stateFilter[i]]=!0;return n}return t.$inject=["$scope","$injector","backendSrv"],je.d(t,e),t.prototype.sortResult=function(e){if(3===this.panel.sortOrder)return D.a.sortBy(e,function(e){return ae.a.alertStateSortScore[e.state]});var t=D.a.sortBy(e,function(e){return e.name.toLowerCase()});return 2===this.panel.sortOrder&&t.reverse(),t},t.prototype.updateStateFilter=function(){var e=[];for(var t in this.stateFilter)this.stateFilter[t]&&e.push(t);this.panel.stateFilter=e,this.onRefresh()},t.prototype.onRefresh=function(){var e,t=this;"current"===this.panel.show&&(e=this.getCurrentAlertState()),"changes"===this.panel.show&&(e=this.getStateChanges()),e.then(function(){t.renderingCompleted()})},t.prototype.onFolderChange=function(e){this.panel.folderId=e.id,this.refresh()},t.prototype.getStateChanges=function(){var e=this,t={limit:this.panel.limit,type:"alert",newState:this.panel.stateFilter};return this.panel.onlyAlertsOnDashboard&&(t.dashboardId=this.dashboard.id),t.from=1e3*Le.parse(this.dashboard.time.from).unix(),t.to=1e3*Le.parse(this.dashboard.time.to).unix(),this.backendSrv.get("/api/annotations",t).then(function(t){return e.alertHistory=D.a.map(t,function(t){return t.time=e.dashboard.formatDate(t.time,"MMM D, YYYY HH:mm:ss"),t.stateModel=ae.a.getStateDisplayModel(t.newState),t.info=ae.a.getAlertAnnotationInfo(t),t}),e.noAlertsMessage=0===e.alertHistory.length?"近期暂无报警状态变更":"",e.alertHistory})},t.prototype.getCurrentAlertState=function(){var e=this,t={state:this.panel.stateFilter};return this.panel.nameFilter&&(t.query=this.panel.nameFilter),this.panel.folderId>=0&&(t.folderId=this.panel.folderId),this.panel.dashboardFilter&&(t.dashboardQuery=this.panel.dashboardFilter),this.panel.onlyAlertsOnDashboard&&(t.dashboardId=this.dashboard.id),this.panel.dashboardTags&&(t.dashboardTag=this.panel.dashboardTags),this.backendSrv.get("/api/alerts",t).then(function(t){return e.currentAlerts=e.sortResult(D.a.map(t,function(e){return e.stateModel=ae.a.getStateDisplayModel(e.state),e.newStateDateAgo=Y()(e.newStateDate).locale("en").fromNow(!0),e})),e.currentAlerts.length>e.panel.limit&&(e.currentAlerts=e.currentAlerts.slice(0,e.panel.limit)),e.noAlertsMessage=0===e.currentAlerts.length?"没有警报":"",e.currentAlerts})},t.prototype.onInitEditMode=function(){this.addEditorTab("选项","public/app/plugins/panel/alertlist/editor.html")},t.templateUrl="module.html",t.scrollable=!0,t}(Ne),An=a(1079),Fn=a(1084);function In(e,t,a,r){void 0===r&&(r=0);var n=Fn[e.value],i="always"===e.invert||e.invert===(t?"light":"dark"),s=i?a:r,o=i?r:a;return An.scaleSequential(n).domain([s,o])}function On(e,t,a){var r;return void 0===a&&(a=0),"linear"===e.colorScale?r=An.scaleLinear().domain([a,t]).range([0,1]):"sqrt"===e.colorScale&&(r=An.scalePow().exponent(e.exponent).domain([a,t]).range([0,1])),r}var qn=P.a.module("grafana.directives"),Rn=0,Vn=0;function Nn(e,t,a,r,n,i,s){var o=j()(e).find("svg"),l=An.select(o.get(0));if(!(s<=0||0===o.get(0).childNodes.length)){var u=An.scaleLinear().domain([0,r]).range([0,s]),c=function(e,t,a,r){for(var n=t-e,i=Object(Dt.tickStep)(e,t,3),s=Math.round(n/i),o=[],l=0;l<s;l++){var u=i*l;Un(r,u,i)?o.push(r):(r<u&&o.push(r),Un(a,u,i)?o.push(a):(a<u&&o.push(a),o.push(i*l)))}Un(a,t,i)||o.push(a);return o.push(t),o=D.a.sortBy(D.a.uniq(o))}(0,r,n,i),d=An.axisBottom(u).tickValues(c).tickSize(Rn),p=o.find(":first-child"),h=function(e){var t=e.get(0);return t&&t.height&&t.height.baseVal?t.height.baseVal.value:0}(o)+Vn,m=function(e){var t=e.get(0);return t&&t.x&&t.x.baseVal?t.x.baseVal.value:0}(p);An.select(o.get(0)).append("g").attr("class","axis").attr("transform","translate("+m+","+h+")").call(d),l.select(".axis").select(".domain").remove()}}function jn(e){j()(e).find("svg").empty()}function Un(e,t,a){return Math.abs(e-t)<.3*a}qn.directive("colorLegend",function(){return{restrict:"E",template:'<div class="heatmap-color-legend"><svg width="16.5rem" height="24px"></svg></div>',link:function(e,t,a){var r=e.ctrl,n=e.ctrl.panel;function i(){var e=j()(t).find("svg"),a=Math.floor(e.outerWidth());if("spectrum"===n.color.mode){var i=In(D.a.find(r.colorSchemes,{value:n.color.colorScheme}),W.c.user.lightTheme,a);!function(e,t){var a=j()(e).find("svg");jn(e);var r=Math.floor(a.outerWidth()),n=a.attr("height");if(r){var i=Math.floor(r/2),s=Math.floor(r/i),o=An.range(0,r,s),l=An.select(a.get(0)),u=l.selectAll(".heatmap-color-legend-rect").data(o);u.enter().append("rect").attr("x",function(e){return e}).attr("y",0).attr("width",s+1).attr("height",n).attr("stroke-width",0).attr("fill",function(e){return t(e)})}}(t,i)}else if("opacity"===n.color.mode){var s=n.color;!function(e,t){var a=j()(e).find("svg");jn(e);var r=An.select(a.get(0)),n=Math.floor(a.outerWidth()),i=a.attr("height");if(n){var s;"linear"===t.colorScale?s=An.scaleLinear().domain([0,n]).range([0,1]):"sqrt"===t.colorScale&&(s=An.scalePow().exponent(t.exponent).domain([0,n]).range([0,1]));var o=An.range(0,n,10),l=r.selectAll(".heatmap-opacity-legend-rect").data(o);l.enter().append("rect").attr("x",function(e){return e}).attr("y",0).attr("width",10).attr("height",i).attr("stroke-width",0).attr("fill",t.cardColor).style("opacity",function(e){return s(e)})}}(t,s)}}i(),r.events.on("render",function(){i()})}}}),qn.directive("heatmapLegend",function(){return{restrict:"E",template:'<div class="heatmap-color-legend"><svg width="100px" height="6px"></svg></div>',link:function(e,t,a){var r=e.ctrl,n=e.ctrl.panel;function i(){if(jn(t),!D.a.isEmpty(r.data)&&!D.a.isEmpty(r.data.cards)){var e=r.data.cardStats.max,a=n.color.max||e,i=n.color.min||0;if("spectrum"===n.color.mode){var s=D.a.find(r.colorSchemes,{value:n.color.colorScheme});!function(e,t,a,r,n,i){var s=j()(e).find("svg"),o=An.select(s.get(0));jn(e);var l=Math.floor(s.outerWidth())-30,u=s.attr("height"),c=1;r-a>l&&(c=Math.floor((r-a)/l));var d=l/(r-a),p=An.range(a,r,c),h=In(t,W.c.user.lightTheme,n,i);o.selectAll(".heatmap-color-legend-rect").data(p).enter().append("rect").attr("x",function(e){return e*d}).attr("y",0).attr("width",c*d+1).attr("height",u).attr("stroke-width",0).attr("fill",function(e){return h(e)}),Nn(e,h,a,r,n,i,l)}(t,s,0,e,a,i)}else if("opacity"===n.color.mode){var o=n.color;!function(e,t,a,r,n,i){var s=j()(e).find("svg"),o=An.select(s.get(0));jn(e);var l=Math.floor(s.outerWidth())-30,u=s.attr("height"),c=1;r-a>l&&(c=Math.floor((r-a)/l));var d=l/(r-a),p=An.range(a,r,c),h=On(t,n,i);o.selectAll(".heatmap-opacity-legend-rect").data(p).enter().append("rect").attr("x",function(e){return e*d}).attr("y",0).attr("width",c*d).attr("height",u).attr("stroke-width",0).attr("fill",t.cardColor).style("opacity",function(e){return h(e)}),Nn(e,h,a,r,n,i,l)}(t,o,0,e,a,i)}}}i(),r.events.on("render",function(){i()})}}});var Ln=function(){function e(e,t){e.editor=this,this.panelCtrl=e.ctrl,this.panel=this.panelCtrl.panel,this.unitFormats=A.a.getUnitFormats(),this.logScales={linear:1,"log (base 2)":2,"log (base 10)":10,"log (base 32)":32,"log (base 1024)":1024},this.dataFormats={"Time series":"timeseries","Time series buckets":"tsbuckets"},this.yBucketBoundModes={Auto:"auto",Upper:"upper",Lower:"lower"}}return e.$inject=["$scope","uiSegmentSrv"],e.prototype.setUnitFormat=function(e){this.panel.yAxis.format=e.value,this.panelCtrl.render()},e}();function Bn(){return{restrict:"E",scope:!0,templateUrl:"public/app/plugins/panel/heatmap/partials/axes_editor.html",controller:Ln}}var Qn=function(){function e(e){e.editor=this,this.panelCtrl=e.ctrl,this.panel=this.panelCtrl.panel,this.panelCtrl.render()}return e.$inject=["$scope"],e}();function zn(){return{restrict:"E",scope:!0,templateUrl:"public/app/plugins/panel/heatmap/partials/display_editor.html",controller:Qn}}var Hn=0,Yn=1;function Wn(e,t){var a,r;try{a=Gn(e.label),r=Gn(t.label)}catch(e){return console.log(e.message||e),0}return a>r?1:a<r?-1:0}function Gn(e){if("+Inf"===e||"inf"===e)return 1/0;var t=Number(e);if(isNaN(t))throw new Error("Error parsing histogram label: "+e+" is not a number");return t}function Kn(e){var t=0,a=0,r=[];return D.a.forEach(e,function(e){D.a.forEach(e.buckets,function(n){var i={x:e.x,y:n.y,yBounds:n.bounds,values:n.values,count:n.count};r.push(i),1===r.length&&(t=n.count,a=n.count),t=n.count<t?n.count:t,a=n.count>a?n.count:a})}),{cards:r,cardStats:{min:t,max:a}}}function Jn(e,t,a,r){void 0===r&&(r=1);for(var n={},i=function(e){var t=e.datapoints,r=e.label;D.a.forEach(t,function(e){var t=ti(e[Yn],a);!function(e,t,a,r){var n=t[Hn];if(null===n||void 0===n||isNaN(n))return;var i=D.a.concat(t,r);e[a]&&e[a].values?(e[a].values.push(n),e[a].points.push(i)):e[a]={x:a,values:[n],points:[i]}}(n,e,t,r)})},s=0,o=e;s<o.length;s++){i(o[s])}return D.a.forEach(n,function(e){e.buckets=1!==r?function(e,t,a){var r=e.values,n=e.points,i={};return D.a.forEach(r,function(e,r){var s=ai(e,t,a),o=s.bottom;Xn(i,o,e,n[r],s)}),i}(e,t,r):function(e,t){var a=e.values,r=e.points,n={};return D.a.forEach(a,function(e,a){var i=ei(e,t),s=i.bottom;Xn(n,s,e,r[a],i)}),n}(e,t)}),n}function Xn(e,t,a,r,n){var i=1;r.length>3&&(i=parseInt(r[2])),e[t]?(e[t].values.push(a),e[t].points.push(r),e[t].count+=i):e[t]={y:t,bounds:n,values:[a],points:[r],count:i}}function Zn(e,t,a){return 1===a?ti(e,t):function(e,t,a){return ai(e,t,a).bottom}(e,t,a)}function ei(e,t){return{bottom:Math.floor(e/t)*t,top:(Math.floor(e/t)+1)*t}}function ti(e,t){return ei(e,t).bottom}function ai(e,t,a){if(0===e)return{bottom:0,top:0};var r,n,i=ri(e,a);if(1!==t&&t){var s=1/t,o=i-Math.floor(i);o=Math.floor(o/s)*s,n=(r=Math.floor(i)+o)+s}else n=(r=Math.floor(i))+1;return{bottom:Math.pow(a,r),top:Math.pow(a,n)}}function ri(e,t){return Math.log(e)/Math.log(t)}function ni(e,t,a){return void 0===a&&(a=1),1===a?Math.abs(t-e):ri(Math.max(e,t)/Math.min(e,t),a)}var ii=function(){function e(e,t){this.scope=t,this.dashboard=t.ctrl.dashboard,this.panelCtrl=t.ctrl,this.panel=t.ctrl.panel,this.heatmapPanel=e,this.mouseOverBucket=!1,this.originalFillColor=null,e.on("mouseover",this.onMouseOver.bind(this)),e.on("mouseleave",this.onMouseLeave.bind(this))}return e.prototype.onMouseOver=function(e){this.panel.tooltip.show&&this.scope.ctrl.data&&!D.a.isEmpty(this.scope.ctrl.data.buckets)&&(this.tooltip||(this.add(),this.move(e)))},e.prototype.onMouseLeave=function(){this.destroy()},e.prototype.onMouseMove=function(e){this.panel.tooltip.show&&this.move(e)},e.prototype.add=function(){this.tooltip=An.select("body").append("div").attr("class","heatmap-tooltip graph-tooltip grafana-tooltip")},e.prototype.destroy=function(){this.tooltip&&this.tooltip.remove(),this.tooltip=null},e.prototype.show=function(e,t){if(this.panel.tooltip.show&&t&&!e.panelRelY){var a=this.getBucketIndexes(e,t),r=a.xBucketIndex,n=a.yBucketIndex;if(t.buckets[r]&&this.tooltip){var i,s,o,l,u=t.buckets[r],c=D.a.find(u.buckets,function(e,t){return e.bounds.bottom===n||t===n.toString()}),d=this.dashboard.formatDate(u.x,"YYYY-MM-DD HH:mm:ss");if(D.a.isNumber(this.panel.tooltipDecimals))o=this.countValueFormatter(this.panel.tooltipDecimals,null),l=this.panelCtrl.tickValueFormatter(this.panelCtrl.decimals,null);else{var p=(this.panelCtrl.decimals||-1)+1;o=this.countValueFormatter(p,this.panelCtrl.scaledDecimals+2),l=this.panelCtrl.tickValueFormatter(p,this.panelCtrl.scaledDecimals+2)}var h='<div class="graph-tooltip-time">'+d+'</div>\n      <div class="heatmap-histogram"></div>';if(c)if(c.bounds){if(t.tsBuckets){var m=function(e){return t.tsBucketsFormatted?t.tsBucketsFormatted[e]:t.tsBuckets[e]};i=m(n),s=n<t.tsBuckets.length-1?m(n+1):""}else{i=l(c.y?c.bounds.bottom:0),s=l(c.bounds.top)}h+="<div>\n          bucket: <b>"+i+" - "+s+"</b> <br>\n          count: <b>"+o(c.count)+"</b> <br>\n        </div>"}else h+="<div>count: <b>"+c.count+"</b><br></div>";else{if(!this.panel.tooltip.showHistogram)return void this.destroy();i=n,s="",0}this.tooltip.html(h),this.panel.tooltip.showHistogram&&this.addHistogram(u),this.move(e)}else this.destroy()}},e.prototype.getBucketIndexes=function(e,t){return{xBucketIndex:this.getXBucketIndex(e.offsetX,t),yBucketIndex:this.getYBucketIndex(e.offsetY,t)}},e.prototype.getXBucketIndex=function(e,t){var a=this.scope.xScale.invert(e-this.scope.yAxisWidth).valueOf(),r=D.a.find(t.buckets,function(e){return a>e.x&&a-e.x<=t.xBucketSize});return r?r.x:Zn(a,t.xBucketSize,1)},e.prototype.getYBucketIndex=function(e,t){var a=this.scope.yScale.invert(e-this.scope.chartTop);return t.tsBuckets?Math.floor(a):Zn(a,t.yBucketSize,this.panel.yAxis.logBase)},e.prototype.getSharedTooltipPos=function(e){return e.pageX=this.heatmapPanel.offset().left+this.scope.xScale(e.x),e.pageY=this.heatmapPanel.offset().top+this.scope.chartHeight*e.panelRelY,e},e.prototype.addHistogram=function(e){var t,a,r,n=this.scope.ctrl.data.buckets[e.x],i=this.scope.ctrl.data.yBucketSize;this.scope.ctrl.data.tsBuckets?(t=0,a=this.scope.ctrl.data.tsBuckets.length-1,r=this.scope.ctrl.data.tsBuckets.length):(t=this.scope.ctrl.data.yAxis.min,a=this.scope.ctrl.data.yAxis.max,r=this.scope.ctrl.data.yAxis.ticks);var s=D.a.map(n.buckets,function(e){var t=void 0!==e.count?e.count:e.values.length;return[e.bounds.bottom,t]});s=D.a.filter(s,function(e){return e[0]>=t&&e[0]<=a});var o,l=this.scope.yScale.copy().domain([t,a]).range([0,160]);if(1===this.panel.yAxis.logBase)o=Math.floor(160/(a-t)*i*.9);else{var u=i||1;o=Math.floor(160/r/u*.9)}o=Math.max(o,1);var c=D.a.reduce(D.a.map(s,function(e){return e[1]}),function(e,t){return e+t},0),d=An.scaleLinear().domain([0,c]).range([0,40]);this.tooltip.select(".heatmap-histogram").append("svg").attr("width",160).attr("height",40).selectAll(".bar").data(s).enter().append("rect").attr("x",function(e){return l(e[0])}).attr("width",o).attr("y",function(e){return 40-d(e[1])}).attr("height",function(e){return d(e[1])})},e.prototype.move=function(e){if(this.tooltip){var t=j()(this.tooltip.node())[0],a=t.clientWidth,r=t.clientHeight,n=e.pageX+30,i=e.pageY+5;return e.pageX+a+40>window.innerWidth&&(n=e.pageX-a-30),e.pageY-window.pageYOffset+r+20>window.innerHeight&&(i=e.pageY-r-5),this.tooltip.style("left",n+"px").style("top",i+"px")}},e.prototype.countValueFormatter=function(e,t){void 0===t&&(t=null);return function(a){return A.a.valueFormats.short(a,e,t)}},e}(),si=1,oi=1,li=0,ui=1.2,ci=100,di=50,pi=10,hi=5,mi=2;function fi(e,t,a,r){var n,i,s,o,l,u,c,d,p,h,m,f,g,v,y,b,S,x,w,k,C,T=t.find(".heatmap-panel"),_=new ii(T,e),M={active:!1,x1:-1,x2:-1},$={left:0,right:0,top:0,bottom:0},P={left:25,right:15,top:10,bottom:20},E=ui;function F(e){var t=e.selectAll(".axis-y text").nodes();return D.a.max(D.a.map(t,function(e){return e.getBBox().width}))}function I(){var t=Math.ceil(h/di),a=Dt.tickStep(n.heatmapStats.min,n.heatmapStats.max,t),i=function(e,t,a){var r,n,i=(t*(E-1)-e*(E-1))/2;0===a?a=((n=t*E)-(r=e-e*(E-1)))/2:(n=Math.ceil((t+i)/a)*a,r=Math.floor((e-i)/a)*a);e>=0&&r<0&&(r=0);return{y_min:r,y_max:n}}(n.heatmapStats.min,n.heatmapStats.max,a),u=i.y_min,d=i.y_max;u=null!==s.yAxis.min?s.yAxis.min:u,d=null!==s.yAxis.max?s.yAxis.max:d,a=Dt.tickStep(u,d,t),t=Math.ceil((d-u)/a);var p=Dt.getPrecision(a),m=null===s.yAxis.decimals?p:s.yAxis.decimals,f=Dt.getFlotTickSize(u,d,t,p),g=Dt.getScaledDecimals(m,f);r.decimals=m,r.scaledDecimals=g,D.a.isEmpty(n.buckets)&&(d=1,u=-1,t=3,m=1),n.yAxis={min:u,max:d,ticks:t},e.yScale=c=An.scaleLinear().domain([u,d]).range([h,0]);var v=An.axisLeft(c).ticks(t).tickFormat(N(m,g)).tickSizeInner(0-l).tickSizeOuter(0).tickPadding(hi);o.append("g").attr("class","axis axis-y").call(v);var y=P.top,b=F(o)+hi;o.select(".axis-y").attr("transform","translate("+b+","+y+")"),o.select(".axis-y").select(".domain").remove()}function O(){var t=s.yAxis.logBase,a=function(e,t,a){var r,i;r=n.heatmapStats.minLog,r=n.heatmapStats.minLog>1||!n.heatmapStats.minLog?1:R(n.heatmapStats.minLog,a);return i=q(n.heatmapStats.max,a),{y_min:r,y_max:i}}(n.heatmapStats.minLog,n.heatmapStats.max,t),i=a.y_min,u=a.y_max;i=s.yAxis.min&&"0"!==s.yAxis.min?R(s.yAxis.min,t):i,u=null!==s.yAxis.max?q(s.yAxis.max,t):u,D.a.isEmpty(n.buckets)&&(u=Math.pow(t,2),i=1),e.yScale=c=An.scaleLog().base(s.yAxis.logBase).domain([i,u]).range([h,0]);var d=V(c.domain(),t),p=Dt.getPrecision(i),m=s.yAxis.decimals||p,f=Dt.getFlotTickSize(i,u,d.length,p),g=Dt.getScaledDecimals(m,f);r.decimals=m,r.scaledDecimals=g,n.yAxis={min:i,max:u,ticks:d.length};var v=An.axisLeft(c).tickValues(d).tickFormat(N(m,g)).tickSizeInner(0-l).tickSizeOuter(0).tickPadding(hi);o.append("g").attr("class","axis axis-y").call(v);var y=P.top,b=F(o)+hi;o.select(".axis-y").attr("transform","translate("+b+","+y+")"),i<1&&o.select(".axis-y").select(".tick text").text("0"),o.select(".axis-y").select(".domain").remove()}function q(e,t){return Math.pow(t,Math.ceil(Dt.logp(e,t)))}function R(e,t){return Math.pow(t,Math.floor(Dt.logp(e,t)))}function V(e,t){var a=e[0],r=e[1],n=[];if(a<1)for(var i=Math.floor(Dt.logp(a,t));i<0;i++){var s=Math.pow(t,i);n.push(s)}var o=Math.ceil(Dt.logp(r,t));for(i=0;i<=o;i++){s=Math.pow(t,i);n.push(s)}return n}function N(e,t){void 0===t&&(t=null);var a=s.yAxis.format;return function(r){try{return"none"!==a?A.a.valueFormats[a](r,e,t):r}catch(e){return console.error(e.message||e),r}}}function U(){h=u-P.top-P.bottom,m=P.top,f=m+h,"tsbuckets"===s.dataFormat?function(){var t=n.tsBuckets;e.yScale=c=An.scaleLinear().domain([0,t.length-1]).range([h,0]);var a=D.a.map(t,function(e,t){return t}),i=D.a.max(D.a.map(t,Dt.getStringPrecision)),u=null===s.yAxis.decimals?i:s.yAxis.decimals;function d(e){var a=t[e];return D.a.isNaN(D.a.toNumber(a))||""===a||(a=N(u)(D.a.toNumber(a))),a}r.decimals=u;var p=D.a.map(t,function(e,t){return d(t)});n.tsBucketsFormatted=p;var m=An.axisLeft(c).tickValues(a).tickFormat(d).tickSizeInner(0-l).tickSizeOuter(0).tickPadding(hi);o.append("g").attr("class","axis axis-y").call(m);var f=P.top,g=F(o)+hi;o.select(".axis-y").attr("transform","translate("+g+","+f+")"),o.select(".axis-y").select(".domain").remove()}():1===s.yAxis.logBase?I():O(),g=F(o)+hi,p=l-g-P.right,o.select(".axis-y").selectAll(".tick line").attr("x2",p),function(){e.xScale=d=An.scaleTime().domain([i.from,i.to]).range([0,p]);var t,a=p/ci,n=Dt.grafanaTimeFormat(a,i.from,i.to);t="utc"===r.dashboard.getTimezone()?An.utcFormat(n):An.timeFormat(n);var s=An.axisBottom(d).ticks(a).tickFormat(t).tickPadding(pi).tickSize(h),l=P.top,u=g;o.append("g").attr("class","axis axis-x").attr("transform","translate("+u+","+l+")").call(s),o.select(".axis-x").select(".domain").remove()}(),v=function(e){if(e.select(".axis-x line").empty())return 30;var t=parseFloat(e.select(".axis-x line").attr("y2"));return parseFloat(e.attr("height"))-t}(o),s.yAxis.show||o.select(".axis-y").selectAll("line").style("opacity",0),s.xAxis.show||o.select(".axis-x").selectAll("line").style("opacity",0)}function L(){var e=T[0];l=Math.floor(T.width())-$.right,u=Math.floor(T.height())-$.bottom,y=null!==s.cards.cardPadding?s.cards.cardPadding:oi,b=null!==s.cards.cardRound?s.cards.cardRound:li,o&&o.remove(),o=An.select(e).append("svg").attr("width",l).attr("height",u)}function B(e){return d(e.x)<0?g+y:d(e.x)+g+y}function Q(e){var t;if(d(e.x)<0){var a=d(e.x)+S;t=a>0?a:0}else t=d(e.x)+S>p?p-d(e.x)-y:S;return t=Math.max(t,si)}function z(e){var t=c(e.y)+m-x-y;return 1!==s.yAxis.logBase&&0===e.y?t=f-x-y:t<m&&(t=m),t}function H(e){var t=c(e.y)+m-x-y,a=x;return 1!==s.yAxis.logBase&&0===e.y?x:(t<m?a=c(e.y)-y:c(e.y)>f?a=f-t:t+x>f&&(a=f-t),a=Math.min(a,h),a=Math.max(a,si))}function G(e){return"opacity"===s.color.mode?s.color.cardColor:w(e.count)}function K(e){return"opacity"===s.color.mode?k(e.count):1}function J(e){if(o){o.selectAll(".heatmap-crosshair").remove();var t=e;t=Math.max(t,g),t=Math.min(t,p+g),o.append("g").attr("class","heatmap-crosshair").attr("transform","translate("+t+",0)").append("line").attr("x1",1).attr("y1",m).attr("x2",1).attr("y2",f).attr("stroke-width",1)}}function X(){o&&o.selectAll(".heatmap-crosshair").remove()}r.events.on("render",function(){!function(){if(n=r.data,s=r.panel,i=r.range,!function(){try{var e=r.height||s.height||r.row.height;return D.a.isString(e)&&(e=parseInt(e.replace("px",""),10)),e-=s.legend.show?28:11,T.css("height",e+"px"),!0}catch(e){return!1}}()||!n)return;if(D.a.isEmpty(n.buckets))return L(),void U();(function(){if(L(),U(),1!==s.yAxis.logBase&&"tsbuckets"!==s.dataFormat){var e=s.yAxis.logBase,t=c.domain(),a=V(t,e);n.buckets=function(e,t){return D.a.forEach(e,function(e){var a=e.buckets,r={bounds:{bottom:0,top:0},values:[],points:[],count:0},n=a[0]||r,i=a[t]||r,s={y:0,bounds:{bottom:t,top:i.bounds.top||t},values:[],points:[],count:0};s.points=n.points.concat(i.points),s.values=n.values.concat(i.values),s.count=s.values.length,0!==s.count&&(delete a[t],a[0]=s)}),e}(n.buckets,D.a.min(a))}var i=n.cards,l=n.cardStats.max,u=s.color.max||l,p=s.color.min||0,h=D.a.find(r.colorSchemes,{value:s.color.colorScheme});w=In(h,W.c.user.lightTheme,u,p),k=On(s.color,u),function(){var e=Math.floor(d(n.xBucketSize)-d(0)),t=Math.floor(c(c.invert(0)-n.yBucketSize));if(1!==s.yAxis.logBase){var a=s.yAxis.logBase,r=n.yBucketSize||1;t=Math.floor((c(1)-c(a))/r)}S=e-2*y,x=t?t-2*y:0}();var m=o.selectAll(".heatmap-card").data(i);m.append("title"),m=m.enter().append("rect").attr("x",B).attr("width",Q).attr("y",z).attr("height",H).attr("rx",b).attr("ry",b).attr("class","bordered heatmap-card").style("fill",G).style("stroke",G).style("stroke-width",0).style("opacity",K),T.find(".heatmap-card").on("mouseenter",function(e){_.mouseOverBucket=!0,function(e){var t=An.select(e.target).style("fill"),a=An.color(t).darker(2),r=An.color(t).brighter(4),n=An.select(e.target);_.originalFillColor=t,n.style("fill",a.toString()).style("stroke",r.toString()).style("stroke-width",1)}(e)}).on("mouseleave",function(e){_.mouseOverBucket=!1,function(e){An.select(e.target).style("fill",_.originalFillColor).style("stroke",_.originalFillColor).style("stroke-width",0)}(e)})})(),e.yAxisWidth=g,e.xAxisHeight=v,e.chartHeight=h,e.chartWidth=p,e.chartTop=m}(),r.renderingCompleted()}),r.tickValueFormatter=N,W.b.on("graph-hover",function(e){!function(e){if(o&&0!==r.dashboard.graphTooltip){var t=d(e.x)+g;J(t)}}(e.pos)},e),W.b.on("graph-hover-clear",function(){X()},e),T.on("mousedown",function(e){M.active=!0,M.x1=e.offsetX,C=function(){!function(){j()(document).unbind("mouseup",C),C=null,M.active=!1;var e=Math.abs(M.x2-M.x1);if(M.x2>=0&&e>mi){var t=d.invert(Math.min(M.x1,M.x2)-g),a=d.invert(Math.max(M.x1,M.x2)-g);r.timeSrv.setTime({from:Y.a.utc(t),to:Y.a.utc(a)})}M.x1=-1,M.x2=-1,o&&o.selectAll(".heatmap-selection").remove()}()},j()(document).one("mouseup",C)}),T.on("mousemove",function(e){o&&(M.active?(X(),_.destroy(),M.x2=function(e){return e=Math.max(e,g),e=Math.min(e,p+g)}(e.offsetX),function(e,t){if(o){o.selectAll(".heatmap-selection").remove();var a=Math.min(e,t),r=Math.abs(e-t);r>mi&&o.append("rect").attr("class","heatmap-selection").attr("x",a).attr("width",r).attr("y",m).attr("height",h)}}(M.x1,M.x2)):(function(e){var t=d.invert(e.offsetX-g).valueOf(),a=c.invert(e.offsetY),r={pageX:e.pageX,pageY:e.pageY,x:t,x1:t,y:a,y1:a,panelRelY:null};r.panelRelY=Math.max(e.offsetY/u,.001),W.b.emit("graph-hover",{pos:r,panel:s})}(e),J(e.offsetX),_.show(e,n)))}),T.on("mouseleave",function(){W.b.emit("graph-hover-clear"),X()})}var gi={heatmap:{},cards:{cardPadding:null,cardRound:null},color:{mode:"spectrum",cardColor:"#b4ff00",colorScale:"sqrt",exponent:.5,colorScheme:"interpolateOranges"},legend:{show:!1},dataFormat:"timeseries",yBucketBound:"auto",xAxis:{show:!0},yAxis:{show:!0,format:"short",decimals:null,logBase:1,splitFactor:null,min:null,max:null},xBucketSize:null,xBucketNumber:null,yBucketSize:null,yBucketNumber:null,tooltip:{show:!0,showHistogram:!1},highlightCards:!0},vi=["opacity","spectrum"],yi=["linear","sqrt"],bi=[{name:"Spectral",value:"interpolateSpectral",invert:"always"},{name:"RdYlGn",value:"interpolateRdYlGn",invert:"always"},{name:"Blues",value:"interpolateBlues",invert:"dark"},{name:"Greens",value:"interpolateGreens",invert:"dark"},{name:"Greys",value:"interpolateGreys",invert:"dark"},{name:"Oranges",value:"interpolateOranges",invert:"dark"},{name:"Purples",value:"interpolatePurples",invert:"dark"},{name:"Reds",value:"interpolateReds",invert:"dark"},{name:"Viridis",value:"interpolateViridis",invert:"light"},{name:"Magma",value:"interpolateMagma",invert:"light"},{name:"Inferno",value:"interpolateInferno",invert:"light"},{name:"Plasma",value:"interpolatePlasma",invert:"light"},{name:"Warm",value:"interpolateWarm",invert:"light"},{name:"Cool",value:"interpolateCool",invert:"light"},{name:"Cubehelix",value:"interpolateCubehelixDefault",invert:"light"},{name:"BuGn",value:"interpolateBuGn",invert:"dark"},{name:"BuPu",value:"interpolateBuPu",invert:"dark"},{name:"GnBu",value:"interpolateGnBu",invert:"dark"},{name:"OrRd",value:"interpolateOrRd",invert:"dark"},{name:"PuBuGn",value:"interpolatePuBuGn",invert:"dark"},{name:"PuBu",value:"interpolatePuBu",invert:"dark"},{name:"PuRd",value:"interpolatePuRd",invert:"dark"},{name:"RdPu",value:"interpolateRdPu",invert:"dark"},{name:"YlGnBu",value:"interpolateYlGnBu",invert:"dark"},{name:"YlGn",value:"interpolateYlGn",invert:"dark"},{name:"YlOrBr",value:"interpolateYlOrBr",invert:"dark"},{name:"YlOrRd",value:"interpolateYlOrRd",invert:"dark"}],Si=["prometheus","elasticsearch"],xi=function(e){function t(t,a,r){var n=e.call(this,t,a)||this;return n.opacityScales=[],n.colorModes=[],n.colorSchemes=[],n.timeSrv=r,n.selectionActivated=!1,D.a.defaultsDeep(n.panel,gi),n.opacityScales=yi,n.colorModes=vi,n.colorSchemes=bi,n.events.on("render",n.onRender.bind(n)),n.events.on("data-received",n.onDataReceived.bind(n)),n.events.on("data-error",n.onDataError.bind(n)),n.events.on("data-snapshot-load",n.onDataReceived.bind(n)),n.events.on("init-edit-mode",n.onInitEditMode.bind(n)),n.onCardColorChange=n.onCardColorChange.bind(n),n}return t.$inject=["$scope","$injector","timeSrv"],je.d(t,e),t.prototype.onInitEditMode=function(){this.addEditorTab("Axes",Bn,2),this.addEditorTab("Display",zn,3),this.unitFormats=A.a.getUnitFormats()},t.prototype.zoomOut=function(e){this.publishAppEvent("zoom-out",2)},t.prototype.onRender=function(){this.range&&("tsbuckets"===this.panel.dataFormat?this.convertHistogramToHeatmapData():this.convertTimeSeriesToHeatmapData())},t.prototype.convertTimeSeriesToHeatmapData=function(){var e,t,a,r,n=this.panel.yAxis.logBase,i=this.panel.xBucketNumber||30,s=Math.floor((this.range.to-this.range.from)/i);e=A.a.interval_regex.test(this.panel.xBucketSize)?A.a.interval_to_ms(this.panel.xBucketSize):isNaN(Number(this.panel.xBucketSize))||""===this.panel.xBucketSize||null===this.panel.xBucketSize?s:Number(this.panel.xBucketSize),r=this.parseSeries(this.series);var o=this.panel.yBucketNumber||10;1!==n?t=this.panel.yAxis.splitFactor:(t=r.max===r.min?r.max?r.max/10:1:(r.max-r.min)/o,t=this.panel.yBucketSize||t),a=Jn(this.series,t,e,n),r.min||r.max||(r={min:-1,max:1,minLog:1},t=1);var l=Kn(a),u=l.cards,c=l.cardStats;this.data={buckets:a,heatmapStats:r,xBucketSize:e,yBucketSize:t,cards:u,cardStats:c}},t.prototype.convertHistogramToHeatmapData=function(){var e,t,a,r=this.getPanelDataSourceType();D.a.includes(Si,r)||this.series.sort(Wn),t=function(e){for(var t={},a=0;a<e.length;a++){var r=e[a],n=a;if(isNaN(n))return t;for(var i=0,s=r.datapoints;i<s.length;i++){var o=s[i],l=o[Hn],u=o[Yn];if(D.a.isNumber(l)){var c=t[u];c||(c=t[u]={x:u,buckets:{}}),c.buckets[n]={y:n,count:l,bounds:{top:null,bottom:n},values:[],points:[]}}}}return t}(this.series),a=D.a.map(this.series,"label");var n=this.panel.yBucketBound;"prometheus"===r&&"lower"!==n||"upper"===n?a=[""].concat(a):a.push(""),e=function(e,t){void 0===t&&(t=1);var a=1/0;if(0===e.length)return 0;if(1===e.length)return e[0];e=D.a.sortBy(e);for(var r=1;r<e.length;r++){var n=ni(e[r],e[r-1],t);a=n<a?n:a}return a}(D.a.map(D.a.keys(t),function(e){return Number(e)}));var i=Kn(t),s=i.cards,o=i.cardStats;this.data={buckets:t,xBucketSize:e,yBucketSize:1,tsBuckets:a,cards:s,cardStats:o}},t.prototype.getPanelDataSourceType=function(){return this.datasource.meta&&this.datasource.meta.id?this.datasource.meta.id:"unknown"},t.prototype.onDataReceived=function(e){if(this.series=e.map(this.seriesHandler.bind(this)),this.dataWarning=null,0===D.a.reduce(this.series,function(e,t){return e+t.datapoints.length},0))this.dataWarning={title:"No data points",tip:"No datapoints returned from data query"};else for(var t=0,a=this.series;t<a.length;t++){if(a[t].isOutsideRange){this.dataWarning={title:"Data points outside time range",tip:"Can be caused by timezone mismatch or missing time filter in query"};break}}this.render()},t.prototype.onDataError=function(){this.series=[],this.render()},t.prototype.onCardColorChange=function(e){this.panel.color.cardColor=e,this.render()},t.prototype.seriesHandler=function(e){if(void 0===e.datapoints)throw new Error("Heatmap error: data should be a time series");var t=new ot.a({datapoints:e.datapoints,alias:e.target});t.flotpairs=t.getFlotPairs(this.panel.nullPointMode);var a=e.datapoints||[];a&&a.length>0&&(a[a.length-1][1]-this.range.from<-1e4&&(t.isOutsideRange=!0));return t},t.prototype.parseSeries=function(e){var t=D.a.min(D.a.map(e,function(e){return e.stats.min})),a=D.a.min(D.a.map(e,function(e){return e.stats.logmin}));return{max:D.a.max(D.a.map(e,function(e){return e.stats.max})),min:t,minLog:a}},t.prototype.parseHistogramSeries=function(e){var t=D.a.map(e,function(e){return Number(e.alias)}),a=D.a.min(t),r=D.a.min(t);return{max:D.a.max(t),min:a,minLog:r}},t.prototype.link=function(e,t,a,r){fi(e,t,0,r)},t.templateUrl="module.html",t}(He),wi={};wi.timeseries_to_rows={description:"时间序列转到行",getColumns:function(){return[]},transform:function(e,t,a){a.columns=[{text:"Time",type:"date"},{text:"Metric"},{text:"Value"}];for(var r=0;r<e.length;r++)for(var n=e[r],i=0;i<n.datapoints.length;i++){var s=n.datapoints[i];a.rows.push([s[1],n.target,s[0]])}}},wi.timeseries_to_columns={description:"时间序列转到列",getColumns:function(){return[]},transform:function(e,t,a){a.columns.push({text:"日期",type:"date"});for(var r={},n=0;n<e.length;n++){var i=e[n];a.columns.push({text:i.target});for(var s=0;s<i.datapoints.length;s++){var o=i.datapoints[s],l=o[1].toString();r[l]?r[l][n]=o[0]:(r[l]={time:o[1]},r[l][n]=o[0])}}for(var u in r){var c=r[u],d=[c.time];for(n=0;n<e.length;n++){var p=c[n];d.push(p)}a.rows.push(d)}}},wi.timeseries_aggregations={description:"时间序列聚合",getColumns:function(){return[{text:"Avg",value:"avg"},{text:"Min",value:"min"},{text:"Max",value:"max"},{text:"Total",value:"total"},{text:"Current",value:"current"},{text:"Count",value:"count"}]},transform:function(e,t,a){var r,n;for(a.columns.push({text:"Metric"}),r=0;r<t.columns.length;r++)a.columns.push({text:t.columns[r].text});for(r=0;r<e.length;r++){var i=new ot.a({datapoints:e[r].datapoints,alias:e[r].target});i.getFlotPairs("connected");var s=[i.alias];for(n=0;n<t.columns.length;n++)s.push(i.stats[t.columns[n].value]);a.rows.push(s)}}},wi.annotations={description:"注释",getColumns:function(){return[]},transform:function(e,t,a){if(a.columns.push({text:"日期",type:"date"}),a.columns.push({text:"标题"}),a.columns.push({text:"文本"}),a.columns.push({text:"标签"}),e&&e.annotations&&0!==e.annotations.length)for(var r=0;r<e.annotations.length;r++){var n=e.annotations[r];a.rows.push([n.time,n.title,n.text,n.tags])}}},wi.table={description:"表格",getColumns:function(e){if(!e||0===e.length)return[];if(1===e.length)return e[0].columns.slice();var t={};return e.reduce(function(e,a){return a.columns.forEach(function(a){var r=a.text;void 0===t[r]&&(t[r]=e.length,e.push(a))}),e},[])},transform:function(e,t,a){if(e&&0!==e.length){var r=D.a.findIndex(e,function(e){return"table"!==e.type});if(r>-1)throw{message:"查询为 #"+String.fromCharCode(65+r)+" 的结果不是表格格式，尝试使用其他的转换格式。"};if(1===e.length)return a.columns=e[0].columns.slice(),void(a.rows=e[0].rows.slice());var n={},i=e.reduce(function(e,t){return t.columns.forEach(function(t){var a=t.text;void 0===n[a]&&(n[a]=e.length,e.push(t))}),e},[]),s=e.map(function(e){return e.columns.map(function(e){return n[e.text]})}),o=e.reduce(function(e,t,a){var r=s[a];return t.rows.forEach(function(t){var a=[];r.forEach(function(e,r){a[e]=t[r]}),e.push(a)}),e},[]),l={},u=o.reduce(function(e,t,a){if(!l[a]){for(var r=a+1;r<o.length;){var n=D.a.findIndex(o,function(e){return c(i,t,e)},r);if(!(n>-1))break;for(var s=o[n],u=0;u<i.length;u++)void 0===t[u]&&void 0!==s[u]&&(t[u]=s[u]);l[n]=s,r=n+1}e.push(t)}return e},[]);a.columns=i,a.rows=u}function c(e,t,a){for(var r=!1,n=0;n<e.length;n++)if(void 0!==t[n]&&void 0!==a[n]){if(t[n]!==a[n])return!1}else void 0!==t[n]&&void 0!==a[n]||(r=!0);return r}}},wi.json={description:"JSON 数据",getColumns:function(e){if(!e||0===e.length)return[];for(var t={},a=0;a<e.length;a++){var r=e[a];if("docs"===r.type)for(var n=Math.min(r.datapoints.length,100),i=0;i<n;i++){var s=Et(r.datapoints[i],null);for(var o in s)t[o]=!0}}return D.a.map(t,function(e,t){return{text:t,value:t}})},transform:function(e,t,a){for(var r,n,i,s=0,o=t.columns;s<o.length;s++){var l={text:o[s].text};e.length>0&&e[0].filterable&&(l.filterable=!0),a.columns.push(l)}for(0===a.columns.length&&a.columns.push({text:"JSON"}),r=0;r<e.length;r++){var u=e[r];for(n=0;n<u.datapoints.length;n++){var c=u.datapoints[n],d=[];if(D.a.isObject(c)&&t.columns.length>0){var p=Et(c,null);for(i=0;i<t.columns.length;i++)d.push(p[t.columns[i].value])}else d.push(JSON.stringify(c));a.rows.push(d)}}}};var ki=function(){function e(e,t,a){this.$q=t,this.uiSegmentSrv=a,e.editor=this,this.panelCtrl=e.ctrl,this.panel=this.panelCtrl.panel,this.transformers=wi,this.fontSizes=["80%","90%","100%","110%","120%","130%","150%","160%","180%","200%","220%","250%"],this.addColumnSegment=a.newPlusButton(),this.updateTransformHints()}return e.$inject=["$scope","$q","uiSegmentSrv"],e.prototype.updateTransformHints=function(){switch(this.canSetColumns=!1,this.columnsHelpMessage="",this.panel.transform){case"timeseries_aggregations":case"json":this.canSetColumns=!0;break;case"table":this.columnsHelpMessage="列的内容及顺序由数据查询决定"}},e.prototype.getColumnOptions=function(){var e=this;if(!this.panelCtrl.dataRaw)return this.$q.when([]);var t=this.transformers[this.panel.transform].getColumns(this.panelCtrl.dataRaw),a=D.a.map(t,function(t){return e.uiSegmentSrv.newSegment({value:t.text})});return this.$q.when(a)},e.prototype.addColumn=function(){var e=wi[this.panel.transform].getColumns(this.panelCtrl.dataRaw),t=D.a.find(e,{text:this.addColumnSegment.value});t&&(this.panel.columns.push(t),this.render());var a=this.uiSegmentSrv.newPlusButton();this.addColumnSegment.html=a.html,this.addColumnSegment.value=a.value},e.prototype.transformChanged=function(){this.panel.columns=[],"timeseries_aggregations"===this.panel.transform&&this.panel.columns.push({text:"Avg",value:"avg"}),this.updateTransformHints(),this.render()},e.prototype.render=function(){this.panelCtrl.render()},e.prototype.removeColumn=function(e){this.panel.columns=D.a.without(this.panel.columns,e),this.panelCtrl.render()},e}();function Ci(e,t){return{restrict:"E",scope:!0,templateUrl:"public/app/plugins/panel/table/editor.html",controller:ki}}var Ti=function(){function e(e){var t=this;e.editor=this,this.activeStyleIndex=0,this.panelCtrl=e.ctrl,this.panel=this.panelCtrl.panel,this.unitFormats=A.a.getUnitFormats(),this.colorModes=[{text:"关闭",value:null},{text:"单元格",value:"cell"},{text:"值",value:"value"},{text:"行",value:"row"}],this.columnTypes=[{text:"数值",value:"number"},{text:"字符串",value:"string"},{text:"日期",value:"date"},{text:"隐藏",value:"hidden"}],this.fontSizes=["80%","90%","100%","110%","120%","130%","150%","160%","180%","200%","220%","250%"],this.dateFormats=[{text:"YYYY-MM-DD HH:mm:ss",value:"YYYY-MM-DD HH:mm:ss"},{text:"YYYY-MM-DD HH:mm:ss.SSS",value:"YYYY-MM-DD HH:mm:ss.SSS"},{text:"MM/DD/YY h:mm:ss a",value:"MM/DD/YY h:mm:ss a"},{text:"MMMM D, YYYY LT",value:"MMMM D, YYYY LT"}],this.mappingTypes=[{text:"数据值转文本",value:1},{text:"数值范围转文本",value:2}],this.getColumnNames=function(){return t.panelCtrl.table?D.a.map(t.panelCtrl.table.columns,function(e){return e.text}):[]},this.onColorChange=this.onColorChange.bind(this)}return e.$inject=["$scope"],e.prototype.render=function(){this.panelCtrl.render()},e.prototype.setUnitFormat=function(e,t){e.unit=t.value,this.panelCtrl.render()},e.prototype.addColumnStyle=function(){var e=this.panel.styles,t=e.length,a=t;t>0&&("/.*/"===e[t-1].pattern&&(a=t-1));e.splice(a,0,{unit:"short",type:"number",alias:"",decimals:2,colors:["rgba(245, 54, 54, 0.9)","rgba(237, 129, 40, 0.89)","rgba(50, 172, 45, 0.97)"],colorMode:null,pattern:"",dateFormat:"YYYY-MM-DD HH:mm:ss",thresholds:[],mappingType:1}),this.activeStyleIndex=a},e.prototype.removeColumnStyle=function(e){this.panel.styles=D.a.without(this.panel.styles,e)},e.prototype.invertColorOrder=function(e){var t=this.panel.styles[e].colors,a=t[0];t[0]=t[2],t[2]=a,this.panelCtrl.render()},e.prototype.onColorChange=function(e,t){var a=this;return function(r){a.panel.styles[e].colors[t]=r,a.render()}},e.prototype.addValueMap=function(e){e.valueMaps||(e.valueMaps=[]),e.valueMaps.push({value:"",text:""}),this.panelCtrl.render()},e.prototype.removeValueMap=function(e,t){e.valueMaps.splice(t,1),this.panelCtrl.render()},e.prototype.addRangeMap=function(e){e.rangeMaps||(e.rangeMaps=[]),e.rangeMaps.push({from:"",to:"",text:""}),this.panelCtrl.render()},e.prototype.removeRangeMap=function(e,t){e.rangeMaps.splice(t,1),this.panelCtrl.render()},e}();function _i(e,t){return{restrict:"E",scope:!0,templateUrl:"public/app/plugins/panel/table/column_options.html",controller:Ti}}var Mi=function(){function e(e,t,a,r,n){this.panel=e,this.table=t,this.isUtc=a,this.sanitize=r,this.templateSrv=n,this.initColumns()}return e.prototype.setTable=function(e){this.table=e,this.initColumns()},e.prototype.initColumns=function(){this.formatters=[],this.colorState={};for(var e=0;e<this.table.columns.length;e++){var t=this.table.columns[e];t.title=t.text;for(var a=0;a<this.panel.styles.length;a++){var r=this.panel.styles[a],n=A.a.stringToJsRegex(r.pattern);if(t.text.match(n)){t.style=r,r.alias&&(t.title=t.text.replace(n,r.alias));break}}this.formatters[e]=this.createColumnFormatter(t)}},e.prototype.getColorForValue=function(e,t){if(!t.thresholds)return null;for(var a=t.thresholds.length;a>0;a--)if(e>=t.thresholds[a-1])return t.colors[a];return D.a.first(t.colors)},e.prototype.defaultCellFormatter=function(e,t){return null===e||void 0===e||void 0===e?"":(D.a.isArray(e)&&(e=e.join(", ")),t&&t.sanitize?this.sanitize(e):D.a.escape(e))},e.prototype.createColumnFormatter=function(e){var t=this;if(!e.style)return this.defaultCellFormatter;if("hidden"===e.style.type)return function(e){};if("date"===e.style.type)return function(a){if(void 0===a||null===a)return"-";D.a.isArray(a)&&(a=a[0]);var r=Y()(a);return t.isUtc&&(r=r.utc()),r.format(e.style.dateFormat)};if("string"===e.style.type)return function(a){D.a.isArray(a)&&(a=a.join(", "));var r=e.style.mappingType||0;if(1===r&&e.style.valueMaps)for(var n=0;n<e.style.valueMaps.length;n++){var i=e.style.valueMaps[n];if(null!==a){if(!D.a.isString(a)&&Number(i.value)===Number(a)||i.value===a)return t.setColorState(a,e.style),t.defaultCellFormatter(i.text,e.style)}else if("null"===i.value)return i.text}if(2===r&&e.style.rangeMaps)for(n=0;n<e.style.rangeMaps.length;n++){i=e.style.rangeMaps[n];if(null!==a){if(Number(i.from)<=Number(a)&&Number(i.to)>=Number(a))return t.setColorState(a,e.style),t.defaultCellFormatter(i.text,e.style)}else if("null"===i.from&&"null"===i.to)return i.text}return null===a||void 0===a?"-":(t.setColorState(a,e.style),t.defaultCellFormatter(a,e.style))};if("number"===e.style.type){var a=A.a.valueFormats[e.unit||e.style.unit];return function(r){return null===r||void 0===r?"-":D.a.isString(r)||D.a.isArray(r)?t.defaultCellFormatter(r,e.style):(t.setColorState(r,e.style),a(r,e.style.decimals,null))}}return function(a){return t.defaultCellFormatter(a,e.style)}},e.prototype.setColorState=function(e,t){if(t.colorMode&&null!==e&&void 0!==e&&!D.a.isArray(e)){var a=Number(e);NaN!==a&&(this.colorState[t.colorMode]=this.getColorForValue(a,t))}},e.prototype.renderRowVariables=function(e){for(var t={},a=this.table.rows[e],r=0;r<a.length;r++)t["__cell_"+r]={value:a[r]};return t},e.prototype.formatColumnValue=function(e,t){return this.formatters[e]?this.formatters[e](t):t},e.prototype.renderCell=function(e,t,a,r){void 0===r&&(r=!1),a=this.formatColumnValue(e,a);var n=this.table.columns[e],i="",s=[],o="";this.colorState.cell?(i=' style="background-color:'+this.colorState.cell+'"',s.push("table-panel-color-cell"),this.colorState.cell=null):this.colorState.value&&(i=' style="color:'+this.colorState.value+'"',this.colorState.value=null);var l="";if(r&&(l='<div class="table-panel-width-hack">'+this.table.columns[e].title+"</div>"),void 0===a?(i=' style="display:none;"',n.hidden=!0):n.hidden=!1,n.style&&n.style.preserveFormat&&s.push("table-panel-cell-pre"),n.style&&n.style.link){var u=this.renderRowVariables(t);u.__cell={value:a};var c=this.templateSrv.replace(n.style.linkUrl,u,encodeURIComponent),d=this.templateSrv.replace(n.style.linkTooltip,u),p=n.style.linkTargetBlank?"_blank":"";s.push("table-panel-cell-link"),l+='\n        <a href="'+c+'" target="'+p+'" data-link-tooltip data-original-title="'+d+'" data-placement="right"'+i+">\n          "+a+"\n        </a>\n      "}else l+=a;return n.filterable&&(s.push("table-panel-cell-filterable"),l+='\n        <a class="table-panel-filter-link" data-link-tooltip data-original-title="Filter out value" data-placement="bottom"\n           data-row="'+t+'" data-column="'+e+'" data-operator="!=">\n          <i class="fa fa-search-minus"></i>\n        </a>\n        <a class="table-panel-filter-link" data-link-tooltip data-original-title="Filter for value" data-placement="bottom"\n           data-row="'+t+'" data-column="'+e+'" data-operator="=">\n          <i class="fa fa-search-plus"></i>\n        </a>'),s.length&&(o=' class="'+s.join(" ")+'"'),l="<td"+o+i+">"+l+"</td>"},e.prototype.render=function(e){for(var t=this.panel.pageSize||100,a=e*t,r=Math.min(a+t,this.table.rows.length),n="",i=[],s="",o=a;o<r;o++){for(var l=this.table.rows[o],u="",c="",d=0;d<this.table.columns.length;d++)u+=this.renderCell(d,o,l[d],o===a);this.colorState.row&&(c=' style="background-color:'+this.colorState.row+'"',i.push("table-panel-color-row"),this.colorState.row=null),i.length&&(s=' class="'+i.join(" ")+'"'),n+="<tr "+s+c+">"+u+"</tr>"}return n},e.prototype.render_values=function(){for(var e=[],t=0;t<this.table.rows.length;t++){for(var a=this.table.rows[t],r=[],n=0;n<this.table.columns.length;n++)r.push(this.formatColumnValue(n,a[n]));e.push(r)}return{columns:this.table.columns,rows:e}},e}(),$i=function(e){function t(t,a,r,n,i,s){var o=e.call(this,t,a)||this;return o.annotationsSrv=n,o.$sanitize=i,o.variableSrv=s,o.panelDefaults={targets:[{}],transform:"timeseries_to_columns",pageSize:null,showHeader:!0,styles:[{type:"date",pattern:"Time",alias:"日期",dateFormat:"YYYY-MM-DD HH:mm:ss"},{unit:"short",type:"number",alias:"",decimals:2,colors:["rgba(245, 54, 54, 0.9)","rgba(237, 129, 40, 0.89)","rgba(50, 172, 45, 0.97)"],colorMode:null,pattern:"/.*/",thresholds:[]}],columns:[],scroll:!0,fontSize:"100%",sort:{col:0,desc:!0}},o.pageIndex=0,void 0===o.panel.styles&&(o.panel.styles=o.panel.columns,o.panel.columns=o.panel.fields,delete o.panel.columns,delete o.panel.fields),D.a.defaults(o.panel,o.panelDefaults),o.events.on("data-received",o.onDataReceived.bind(o)),o.events.on("data-error",o.onDataError.bind(o)),o.events.on("data-snapshot-load",o.onDataReceived.bind(o)),o.events.on("init-edit-mode",o.onInitEditMode.bind(o)),o.events.on("init-panel-actions",o.onInitPanelActions.bind(o)),o}return t.$inject=["$scope","$injector","templateSrv","annotationsSrv","$sanitize","variableSrv"],je.d(t,e),t.prototype.onInitEditMode=function(){this.addEditorTab("选项",Ci,2),this.addEditorTab("列风格",_i,3)},t.prototype.onInitPanelActions=function(e){e.push({text:"导出 CSV",click:"ctrl.exportCsv()"})},t.prototype.issueQueries=function(t){return this.pageIndex=0,"annotations"===this.panel.transform?(this.setTimeQueryStart(),this.annotationsSrv.getAnnotations({dashboard:this.dashboard,panel:this.panel,range:this.range}).then(function(e){return{data:e}})):e.prototype.issueQueries.call(this,t)},t.prototype.onDataError=function(e){this.dataRaw=[],this.render()},t.prototype.onDataReceived=function(e){this.dataRaw=e,this.pageIndex=0,this.dataRaw&&this.dataRaw.length&&("table"===this.dataRaw[0].type?this.panel.transform="table":"docs"===this.dataRaw[0].type?this.panel.transform="json":"table"!==this.panel.transform&&"json"!==this.panel.transform||(this.panel.transform="timeseries_to_rows")),this.render()},t.prototype.render=function(){return this.table=function(e,t){var a=new lt.a;if(!e||0===e.length)return a;var r=wi[t.transform];if(!r)throw{message:"Transformer "+t.transform+" not found"};return r.transform(e,t,a),a}(this.dataRaw,this.panel),this.table.sort(this.panel.sort),this.renderer=new Mi(this.panel,this.table,this.dashboard.isTimezoneUtc(),this.$sanitize,this.templateSrv),e.prototype.render.call(this,this.table)},t.prototype.toggleColumnSort=function(e,t){this.table.columns[this.panel.sort.col]&&(this.table.columns[this.panel.sort.col].sort=!1),this.panel.sort.col===t?this.panel.sort.desc?this.panel.sort.desc=!1:this.panel.sort.col=null:(this.panel.sort.col=t,this.panel.sort.desc=!0),this.render()},t.prototype.moveQuery=function(t,a){e.prototype.moveQuery.call(this,t,a),e.prototype.refresh.call(this)},t.prototype.exportCsv=function(){var e=this.$scope.$new(!0);e.tableData=this.renderer.render_values(),e.panel="table",this.publishAppEvent("show-modal",{templateHtml:'<export-data-modal panel="panel" data="tableData"></export-data-modal>',scope:e,modalClass:"modal--narrow"})},t.prototype.link=function(e,t,a,r){var n,i=r.panel,s=0;function o(){var e=t.parents(".panel-content"),a=t.find(".table-panel-scroll"),o=t.find("tbody"),l=t.find(".table-panel-footer");t.css({"font-size":i.fontSize}),e.addClass("table-panel-content"),function(e){r.renderer.setTable(n),e.empty(),e.html(r.renderer.render(r.pageIndex))}(o),function(e){e.empty();var t=i.pageSize||100;if(1!==(s=Math.ceil(n.rows.length/t))){for(var a=Math.max(r.pageIndex-3,0),o=Math.min(s,a+9),l=j()("<ul></ul>"),u=a;u<o;u++){var c=u===r.pageIndex?"active":"",d=j()('<li><a class="table-panel-page-link pointer '+c+'">'+(u+1)+"</a></li>");l.append(d)}e.append(l)}}(l),a.css({"max-height":i.scroll?function(){var e=r.height;return s>1&&(e-=26),e-31+"px"}():""})}t.tooltip({selector:"[data-link-tooltip]"}),t.on("click",".table-panel-page-link",function(e){var t=j()(e.currentTarget);r.pageIndex=parseInt(t.text(),10)-1,o()}),t.on("click",".table-panel-filter-link",function(e){var t=j()(e.currentTarget).data(),a={datasource:i.datasource,key:n.columns[t.column].text,value:n.rows[t.row][t.column],operator:t.operator};r.variableSrv.setAdhocFilter(a)});var l=e.$on("$destroy",function(){t.off("click",".table-panel-page-link"),t.off("click",".table-panel-filter-link"),l()});r.events.on("render",function(e){(n=e||n)&&o(),r.renderingCompleted()})},t.templateUrl="module.html",t}(He),Pi=(a(1097),function(e){function t(t,a,r){var n=e.call(this,t,a)||this;return n.linkSrv=r,n.dataType="timeseries",n.valueNameOptions=[{value:"min",text:"最小"},{value:"max",text:"最大"},{value:"avg",text:"平均"},{value:"current",text:"当前"},{value:"total",text:"总和"},{value:"name",text:"名称"},{value:"first",text:"首个"},{value:"delta",text:"Delta"},{value:"diff",text:"差值"},{value:"range",text:"范围"},{value:"last_time",text:"上个数据点的时间"}],n.panelDefaults={links:[],datasource:null,maxDataPoints:100,interval:null,targets:[{}],cacheTimeout:null,format:"none",prefix:"",postfix:"",nullText:null,valueMaps:[{value:"null",op:"=",text:"N/A"}],mappingTypes:[{name:"value to text",value:1},{name:"range to text",value:2}],rangeMaps:[{from:"null",to:"null",text:"N/A"}],mappingType:1,nullPointMode:"connected",valueName:"avg",prefixFontSize:"50%",valueFontSize:"80%",postfixFontSize:"50%",thresholds:"",colorBackground:!1,colorValue:!1,colors:["#299c46","rgba(237, 129, 40, 0.89)","#d44a3a"],sparkline:{show:!1,full:!1,lineColor:"rgb(31, 120, 193)",fillColor:"rgba(31, 118, 189, 0.18)"},gauge:{show:!1,minValue:0,maxValue:100,thresholdMarkers:!0,thresholdLabels:!1},tableColumn:""},D.a.defaults(n.panel,n.panelDefaults),n.events.on("data-received",n.onDataReceived.bind(n)),n.events.on("data-error",n.onDataError.bind(n)),n.events.on("data-snapshot-load",n.onDataReceived.bind(n)),n.events.on("init-edit-mode",n.onInitEditMode.bind(n)),n.onSparklineColorChange=n.onSparklineColorChange.bind(n),n.onSparklineFillChange=n.onSparklineFillChange.bind(n),n}return t.$inject=["$scope","$injector","linkSrv"],je.d(t,e),t.prototype.onInitEditMode=function(){this.fontSizes=["20%","30%","50%","70%","80%","100%","110%","120%","150%","170%","200%"],this.addEditorTab("选项","public/app/plugins/panel/singlestat/editor.html",2),this.addEditorTab("值映射","public/app/plugins/panel/singlestat/mappings.html",3),this.unitFormats=A.a.getUnitFormats()},t.prototype.setUnitFormat=function(e){this.panel.format=e.value,this.refresh()},t.prototype.onDataError=function(e){this.onDataReceived([])},t.prototype.onDataReceived=function(e){var t={};if(e.length>0&&"table"===e[0].type){this.dataType="table";var a=e.map(this.tableHandler.bind(this));this.setTableValues(a,t)}else this.dataType="timeseries",this.series=e.map(this.seriesHandler.bind(this)),this.setValues(t);this.data=t,this.render()},t.prototype.seriesHandler=function(e){var t=new ot.a({datapoints:e.datapoints||[],alias:e.target});return t.flotpairs=t.getFlotPairs(this.panel.nullPointMode),t},t.prototype.tableHandler=function(e){var t=[],a={};return e.columns.forEach(function(e,t){a[t]=e.text}),this.tableColumnOptions=a,D.a.find(e.columns,["text",this.panel.tableColumn])||this.setTableColumnToSensibleDefault(e),e.rows.forEach(function(e){var r={};e.forEach(function(e,t){var n=a[t];r[n]=e}),t.push(r)}),t},t.prototype.setTableColumnToSensibleDefault=function(e){1===e.columns.length?this.panel.tableColumn=e.columns[0].text:this.panel.tableColumn=D.a.find(e.columns,function(e){return"time"!==e.type}).text},t.prototype.setTableValues=function(e,t){if(e&&0!==e.length&&0!==e[0].length&&void 0!==e[0][0][this.panel.tableColumn]){var a=e[0][0];if(t.value=a[this.panel.tableColumn],D.a.isString(t.value))t.valueFormatted=D.a.escape(t.value),t.value=0,t.valueRounded=0;else{var r=this.getDecimalsForValue(t.value),n=A.a.valueFormats[this.panel.format];t.valueFormatted=n(a[this.panel.tableColumn],r.decimals,r.scaledDecimals),t.valueRounded=A.a.roundValue(t.value,this.panel.decimals||0)}this.setValueMapping(t)}},t.prototype.canModifyText=function(){return!this.panel.gauge.show},t.prototype.setColoring=function(e){e.background?(this.panel.colorValue=!1,this.panel.colors=["rgba(71, 212, 59, 0.4)","rgba(245, 150, 40, 0.73)","rgba(225, 40, 40, 0.59)"]):(this.panel.colorBackground=!1,this.panel.colors=["rgba(50, 172, 45, 0.97)","rgba(237, 129, 40, 0.89)","rgba(245, 54, 54, 0.9)"]),this.render()},t.prototype.invertColorOrder=function(){var e=this.panel.colors[0];this.panel.colors[0]=this.panel.colors[2],this.panel.colors[2]=e,this.render()},t.prototype.onColorChange=function(e){var t=this;return function(a){t.panel.colors[e]=a,t.render()}},t.prototype.onSparklineColorChange=function(e){this.panel.sparkline.lineColor=e,this.render()},t.prototype.onSparklineFillChange=function(e){this.panel.sparkline.fillColor=e,this.render()},t.prototype.getDecimalsForValue=function(e){if(D.a.isNumber(this.panel.decimals))return{decimals:this.panel.decimals,scaledDecimals:null};var t,a=e/2,r=-Math.floor(Math.log(a)/Math.LN10),n=Math.pow(10,-r),i=a/n;i<1.5?t=1:i<3?(t=2,i>2.25&&(t=2.5,++r)):t=i<7.5?5:10,t*=n,Math.floor(e)===e&&(r=0);var s={};return s.decimals=Math.max(0,r),s.scaledDecimals=s.decimals-Math.floor(Math.log(t)/Math.LN10)+2,s},t.prototype.setValues=function(e){if(e.flotpairs=[],this.series.length>1){var t=new Error;throw t.message="Multiple Series Error",t.data="Metric query returns "+this.series.length+" series. Single Stat Panel expects a single series.\n\nResponse:\n"+JSON.stringify(this.series),t}if(this.series&&this.series.length>0){var a=D.a.last(this.series[0].datapoints),r=D.a.isArray(a)?a[0]:null;if("name"===this.panel.valueName)e.value=0,e.valueRounded=0,e.valueFormatted=this.series[0].alias;else if(D.a.isString(r))e.value=0,e.valueFormatted=D.a.escape(r),e.valueRounded=0;else if("last_time"===this.panel.valueName){var n=A.a.valueFormats[this.panel.format];e.value=a[1],e.valueRounded=e.value,e.valueFormatted=n(e.value,this.dashboard.isTimezoneUtc())}else{e.value=this.series[0].stats[this.panel.valueName],e.flotpairs=this.series[0].flotpairs;var i=this.getDecimalsForValue(e.value);n=A.a.valueFormats[this.panel.format];e.valueFormatted=n(e.value,i.decimals,i.scaledDecimals),e.valueRounded=A.a.roundValue(e.value,i.decimals)}e.scopedVars=D.a.extend({},this.panel.scopedVars),e.scopedVars.__name={value:this.series[0].label}}this.setValueMapping(e)},t.prototype.setValueMapping=function(e){if(1===this.panel.mappingType)for(var t=0;t<this.panel.valueMaps.length;t++){if("null"!==(a=this.panel.valueMaps[t]).value){if(parseFloat(a.value)===e.valueRounded)return void(e.valueFormatted=a.text)}else if(null===e.value||void 0===e.value)return void(e.valueFormatted=a.text)}else if(2===this.panel.mappingType)for(t=0;t<this.panel.rangeMaps.length;t++){var a;if("null"!==(a=this.panel.rangeMaps[t]).from||"null"!==a.to){var r=parseFloat(a.from);if(parseFloat(a.to)>=e.valueRounded&&r<=e.valueRounded)return void(e.valueFormatted=a.text)}else if(null===e.value||void 0===e.value)return void(e.valueFormatted=a.text)}null!==e.value&&void 0!==e.value||(e.valueFormatted="no value")},t.prototype.removeValueMap=function(e){var t=D.a.indexOf(this.panel.valueMaps,e);this.panel.valueMaps.splice(t,1),this.render()},t.prototype.addValueMap=function(){this.panel.valueMaps.push({value:"",op:"=",text:""})},t.prototype.removeRangeMap=function(e){var t=D.a.indexOf(this.panel.rangeMaps,e);this.panel.rangeMaps.splice(t,1),this.render()},t.prototype.addRangeMap=function(){this.panel.rangeMaps.push({from:"",to:"",text:""})},t.prototype.link=function(e,t,a,r){var n,i,s=this.$location,o=this.linkSrv,l=this.$timeout,u=r.panel,c=this.templateSrv,d=t.find(".panel-container");function p(e,t){var a=Ei(n,e);return a?'<span style="color:'+a+'">'+t+"</span>":t}function h(e,t,a){return'<span class="'+e+'" style="font-size:'+t+'">'+(a=c.replace(a,n.scopedVars))+"</span>"}function m(){var e=t.width(),a=t.height(),i=Math.min(e,1.3*a);if(r.invalidGaugeRange=!1,u.gauge.minValue>u.gauge.maxValue)r.invalidGaugeRange=!0;else{var s=j()("<div></div>"),o={top:"10px",margin:"auto",position:"relative",height:.9*a+"px",width:i+"px"};s.css(o);for(var l=[],d=0;d<n.thresholds.length;d++)l.push({value:n.thresholds[d],color:n.colorMap[d]});l.push({value:u.gauge.maxValue,color:n.colorMap[n.colorMap.length-1]});var p=_e.a.bootData.user.lightTheme?"rgb(230,230,230)":"rgb(38,38,38)",h=parseInt(u.valueFontSize)/100,m=Math.min(i/5,100)*h,f=u.gauge.thresholdLabels?1.5:1,g=Math.min(i/6,60)/f,v=g/5,y=m/2.5,b={series:{gauges:{gauge:{min:u.gauge.minValue,max:u.gauge.maxValue,background:{color:p},border:{color:null},shadow:{show:!1},width:g},frame:{show:!1},label:{show:!1},layout:{margin:0,thresholdWidth:0},cell:{border:{width:0}},threshold:{values:l,label:{show:u.gauge.thresholdLabels,margin:v+1,font:{size:y}},show:u.gauge.thresholdMarkers,width:v},value:{color:u.colorValue?Ei(n,n.valueRounded):null,formatter:function(){return function(){var e=u.prefix?c.replace(u.prefix,n.scopedVars):"";return e+=n.valueFormatted,e+=u.postfix?c.replace(u.postfix,n.scopedVars):""}()},font:{size:m,family:'"Helvetica Neue", Helvetica, Arial, sans-serif'}},show:!0}}};t.append(s);var S={data:[[0,n.valueRounded]]};j.a.plot(s,[S],b)}}function f(){var e=t.width()+20;if(e<30)setTimeout(f,30);else{var a=r.height,i=j()("<div></div>"),s={position:"absolute"};if(u.sparkline.full){s.bottom="5px",s.left="-5px",s.width=e-10+"px";var o=a<=100?5:15*Math.round(a/100)+5;s.height=a-o+"px"}else s.bottom="0px",s.left="-5px",s.width=e-10+"px",s.height=Math.floor(.25*a)+"px";i.css(s);var l={legend:{show:!1},series:{lines:{show:!0,fill:1,zero:!1,lineWidth:1,fillColor:u.sparkline.fillColor}},yaxes:{show:!1},xaxis:{show:!1,mode:"time",min:r.range.from.valueOf(),max:r.range.to.valueOf()},grid:{hoverable:!1,show:!1}};t.append(i);var c={data:n.flotpairs,color:u.sparkline.lineColor};j.a.plot(i,[c],l)}}function g(){if(r.data){(n=r.data).thresholds=u.thresholds.split(",").map(function(e){return Number(e.trim())}),n.colorMap=u.colors;var a=u.gauge.show?"":function(){var e='<div class="singlestat-panel-value-container">';if(u.prefix){var t=u.prefix;u.colorPrefix&&(t=p(n.value,u.prefix)),e+=h("singlestat-panel-prefix",u.prefixFontSize,t)}var a=n.valueFormatted;if(u.colorValue&&(a=p(n.value,a)),e+=h("singlestat-panel-value",u.valueFontSize,a),u.postfix){var r=u.postfix;u.colorPostfix&&(r=p(n.value,u.postfix)),e+=h("singlestat-panel-postfix",u.postfixFontSize,r)}return e+="</div>"}();if(u.colorBackground){var s=Ei(n,n.value);s&&(d.css("background-color",s),e.fullscreen?t.css("background-color",s):t.css("background-color",""))}else d.css("background-color",""),t.css("background-color","");t.html(a),u.sparkline.show&&f(),u.gauge.show&&m(),t.toggleClass("pointer",u.links.length>0),i=u.links.length>0?o.getPanelLinkAnchorInfo(u.links[0],n.scopedVars):null}}t=t.find(".singlestat-panel"),function(){var e=j()('<div id="tooltip" class="">hello</div>"');t.mouseleave(function(){0!==u.links.length&&l(function(){e.detach()})}),t.click(function(t){i&&(j()(t).parents(".panel-header").length>0||("_blank"!==i.target?(0===i.href.indexOf("http")?window.location.href=i.href:l(function(){s.url(i.href)}),e.detach()):window.open(i.href,"_blank")))}),t.mousemove(function(t){i&&(e.text("click to go to: "+i.title),e.place_tt(t.pageX,t.pageY-50))})}(),this.events.on("render",function(){g(),r.renderingCompleted()})},t.templateUrl="module.html",t}(He));function Ei(e,t){if(!D.a.isFinite(t))return null;for(var a=e.thresholds.length;a>0;a--)if(t>=e.thresholds[a-1])return e.colorMap[a];return D.a.first(e.colorMap)}var Di=function(e){function t(t,a,r,n,i){var s=e.call(this,t,a)||this;return s.backendSrv=r,s.$q=i,s.stepIndex=0,s.steps=[],s.steps.push({title:"安装 Grafana",icon:"icon-gf icon-gf-check",href:"http://docs.grafana.org/",target:"_blank",note:"查看安装过程文档",check:function(){return i.when(!0)}}),s.steps.push({title:"添加你的第一个数据源",cta:"添加数据源",icon:"icon-gf icon-gf-datasources",href:"datasources/new?gettingstarted",check:function(){return i.when(n.getMetricSources().filter(function(e){return!0!==e.meta.builtIn}).length>0)}}),s.steps.push({title:"添加你的第一个仪表盘",cta:"创建仪表盘",icon:"icon-gf icon-gf-dashboard",href:"dashboard/new?gettingstarted",check:function(){return s.backendSrv.search({limit:1}).then(function(e){return e.length>0})}}),s.steps.push({title:"邀请你的团队",cta:"添加成员",icon:"icon-gf icon-gf-users",href:"org/users?gettingstarted",check:function(){return s.backendSrv.get("/api/org/users").then(function(e){return e.length>1})}}),s.steps.push({title:"安装应用与插件",cta:"探索插件仓库",icon:"icon-gf icon-gf-apps",href:"https://grafana.com/plugins?utm_source=grafana_getting_started",check:function(){return s.backendSrv.get("/api/plugins",{embedded:0,core:0}).then(function(e){return e.length>0})}}),s}return t.$inject=["$scope","$injector","backendSrv","datasourceSrv","$q"],je.d(t,e),t.prototype.$onInit=function(){var e=this;return this.stepIndex=-1,this.nextStep().then(function(t){e.checksDone=!0})},t.prototype.nextStep=function(){var e=this;if(this.stepIndex===this.steps.length-1)return this.$q.when();this.stepIndex+=1;var t=this.steps[this.stepIndex];return t.check().then(function(a){return a?(t.cssClass="completed",e.nextStep()):(t.cssClass="active",e.$q.when())})},t.prototype.dismiss=function(){this.dashboard.removePanel(this.panel,!1),this.backendSrv.request({method:"PUT",url:"/api/user/helpflags/1",showSuccessAlert:!1}).then(function(e){W.c.user.helpFlags1=e.helpFlags1})},t.templateUrl="public/app/plugins/panel/gettingstarted/module.html",t}(Ne),Ai={"app/plugins/datasource/graphite/module":s,"app/plugins/datasource/cloudwatch/module":o,"app/plugins/datasource/elasticsearch/module":l,"app/plugins/datasource/opentsdb/module":u,"app/plugins/datasource/grafana/module":c,"app/plugins/datasource/influxdb/module":d,"app/plugins/datasource/logging/module":p,"app/plugins/datasource/mixed/module":h,"app/plugins/datasource/mysql/module":m,"app/plugins/datasource/postgres/module":f,"app/plugins/datasource/mssql/module":v,"app/plugins/datasource/prometheus/module":g,"app/plugins/datasource/testdata/module":y,"app/plugins/panel/text/module":b,"app/plugins/panel/graph/module":S,"app/plugins/panel/dashlist/module":x,"app/plugins/panel/pluginlist/module":w,"app/plugins/panel/alertlist/module":k,"app/plugins/panel/heatmap/module":C,"app/plugins/panel/table/module":T,"app/plugins/panel/singlestat/module":_,"app/plugins/panel/gettingstarted/module":M},Fi=a(37),Ii=a(1091),Oi=(a(1090),a(1089),a(1088),a(1087),a(1106),"?_cache="+Date.now());function qi(e,t){Oe.a.registerDynamic(e,[],!0,function(e,a,r){r.exports=t})}Oe.a.registry.set("plugin-loader",Oe.a.newModule({locate:function(e){return e.address+Oi}})),Oe.a.config({baseURL:"public",defaultExtension:"js",packages:{plugins:{defaultExtension:"js"}},map:{text:"vendor/plugin-text/text.js",css:"vendor/plugin-css/css.js"},meta:{"/*":{esModule:!0,authorization:!0,loader:"plugin-loader"}}}),qi("lodash",D.a),qi("moment",Y.a),qi("jquery",j.a),qi("angular",P.a),qi("d3",An),qi("rxjs/Subject",Ii.Subject),qi("rxjs/Observable",Fi.Observable),qi("prismjs",Ze.a),qi("slate",et.p),qi("slate-react",tt.b),qi("slate-plain-serializer",at.a),qi("react",nt.a),qi("react-dom",st.a),qi("vendor/npm/rxjs/Rx",{Subject:Ii.Subject,Observable:Fi.Observable}),qi("app/features/dashboard/impression_store",{impressions:At.a,__esModule:!0}),qi("app/plugins/sdk",r),qi("app/core/utils/datemath",Le),qi("app/core/utils/file_export",n),qi("app/core/utils/flatten",i),qi("app/core/utils/kbn",A.a),qi("app/core/utils/ticks",Dt),qi("app/core/config",_e.a),qi("app/core/time_series",ot.a),qi("app/core/time_series2",ot.a),qi("app/core/table_model",lt.a),qi("app/core/app_events",W.b),qi("app/core/core_module",W.d),qi("app/core/core",{coreModule:W.d,appEvents:W.b,contextSrv:W.c,__esModule:!0});for(var Ri=0,Vi=["jquery.flot","jquery.flot.pie","jquery.flot.time","jquery.flot.fillbelow","jquery.flot.crosshair","jquery.flot.stack","jquery.flot.selection","jquery.flot.stackpercent","jquery.flot.events","jquery.flot.gauge"];Ri<Vi.length;Ri++){qi(Vi[Ri],{fakeDep:1})}function Ni(e){var t=Ai[e];return t?Promise.resolve(t):Oe.a.import(e)}function ji(e){_e.a.bootData.user.lightTheme?Oe.a.import(e.light+"!css"):Oe.a.import(e.dark+"!css")}var Ui=function(){function e(e,t,a,r){this.$q=e,this.$injector=t,this.$rootScope=a,this.templateSrv=r,this.init()}return e.$inject=["$q","$injector","$rootScope","templateSrv"],e.prototype.init=function(){this.datasources={}},e.prototype.get=function(e){return e?"default"===(e=this.templateSrv.replace(e))?this.get(_e.a.defaultDatasource):this.datasources[e]?this.$q.when(this.datasources[e]):this.loadDatasource(e):this.get(_e.a.defaultDatasource)},e.prototype.loadDatasource=function(e){var t=this,a=_e.a.datasources[e];if(!a)return this.$q.reject({message:"找不到名为： "+e+" 的数据源"});var r=this.$q.defer(),n=a.meta;return Ni(n.module).then(function(i){if(t.datasources[e])r.resolve(t.datasources[e]);else{if(!i.Datasource)throw new Error("Plugin module is missing Datasource constructor");var s=t.$injector.instantiate(i.Datasource,{instanceSettings:a});s.meta=n,s.name=e,t.datasources[e]=s,r.resolve(s)}}).catch(function(e){t.$rootScope.appEvent("alert-error",[a.name+" plugin failed",e.toString()])}),r.promise},e.prototype.getAll=function(){return _e.a.datasources},e.prototype.getAnnotationSources=function(){var e=[];return this.addDataSourceVariables(e),D.a.each(_e.a.datasources,function(t){t.meta&&t.meta.annotations&&e.push(t)}),e},e.prototype.getExploreSources=function(){var e=_e.a.datasources,t=Object.keys(e).map(function(t){return e[t]}).filter(function(e){return e.meta&&e.meta.explore});return D.a.sortBy(t,["name"])},e.prototype.getMetricSources=function(e){var t=[];return D.a.each(_e.a.datasources,function(e,a){if(e.meta&&e.meta.metrics){var r={value:a,name:a,meta:e.meta,sort:a};"grafana"===e.meta.id?r.sort=String.fromCharCode(253):"mixed"===e.meta.id&&(r.sort=String.fromCharCode(254)),t.push(r),a===_e.a.defaultDatasource&&(r={value:null,name:"default",meta:e.meta,sort:a},t.push(r))}}),e&&e.skipVariables||this.addDataSourceVariables(t),t.sort(function(e,t){return e.sort.toLowerCase()>t.sort.toLowerCase()?1:e.sort.toLowerCase()<t.sort.toLowerCase()?-1:0}),t},e.prototype.addDataSourceVariables=function(e){for(var t=0;t<this.templateSrv.variables.length;t++){var a=this.templateSrv.variables[t];if("datasource"===a.type){var r=a.current.value;"default"===r&&(r=_e.a.defaultDatasource);var n=_e.a.datasources[r];if(n){var i="$"+a.name;e.push({name:i,value:i,meta:n.meta,sort:i})}}}},e}();U.a.service("datasourceSrv",Ui);var Li=function(e){function t(t,a){return e.call(this,t,a)||this}return t.$inject=["$scope","$injector"],je.d(t,e),t.templateUrl="public/app/plugins/panel/unknown/module.html",t}(Ne);function Bi(e,t,a,r,n,i){function s(e,t){if(e)return 0===e.indexOf("public")?e:t+"/"+e}function o(e,t){var a={name:"panel-plugin-"+e.panel.type,bindings:{dashboard:"=",panel:"=",row:"="},attrs:{dashboard:"dashboard",panel:"panel",class:"panel-height-helper"}},o=_e.a.panels[e.panel.type],l=Promise.resolve(Li);return o&&(l=Ni(o.module).then(function(e){return e.PanelCtrl})),l.then(function(e){return a.Component=e,!e||e.registered?a:e.templatePromise?e.templatePromise.then(function(e){return a}):(o&&(e.templateUrl=s(e.templateUrl,o.baseUrl)),e.templatePromise=function(e){if(e.template)return r.when(e.template);var t=i.get(e.templateUrl);return t?r.when(t):n.get(e.templateUrl).then(function(e){return e.data})}(e).then(function(t){return e.templateUrl=null,e.template='<grafana-panel ctrl="ctrl" class="panel-height-helper">'+t+"</grafana-panel>",a}),e.templatePromise)})}function l(t,a,r,n){if(n.notFound)a.empty();else{if(!n.Component)throw{message:"Failed to find exported plugin component for "+n.name};if(!n.Component.registered){var i=r.$normalize(n.name),o=function(e){return e.Component.templateUrl=s(e.Component.templateUrl,e.baseUrl),function(){return{templateUrl:e.Component.templateUrl,template:e.Component.template,restrict:"E",controller:e.Component,controllerAs:"ctrl",bindToController:!0,scope:e.bindings,link:function(e,t,a,r){r.link&&r.link(e,t,a,r),r.init&&r.init()}}}}(n);U.a.directive(i,o),n.Component.registered=!0}!function(t,a,r){var n=P.a.element(document.createElement(r.name));D.a.each(r.attrs,function(e,t){n.attr(t,e)}),e(n)(t),a.empty(),setTimeout(function(){a.append(n),t.$applyAsync(function(){t.$broadcast("component-did-mount"),t.$broadcast("refresh")})})}(t,a,n)}}return{restrict:"E",link:function(e,n,i){(function(e,a){switch(a.type){case"query-ctrl":var n=e.target.datasource||e.ctrl.panel.datasource;return t.get(n).then(function(t){return e.datasource=t,Ni(t.meta.module).then(function(e){return{baseUrl:t.meta.baseUrl,name:"query-ctrl-"+t.meta.id,bindings:{target:"=",panelCtrl:"=",datasource:"="},attrs:{target:"target","panel-ctrl":"ctrl.panelCtrl",datasource:"datasource"},Component:e.QueryCtrl}})});case"annotations-query-ctrl":return Ni(e.ctrl.currentDatasource.meta.module).then(function(t){return{baseUrl:e.ctrl.currentDatasource.meta.baseUrl,name:"annotations-query-ctrl-"+e.ctrl.currentDatasource.meta.id,bindings:{annotation:"=",datasource:"="},attrs:{annotation:"ctrl.currentAnnotation",datasource:"ctrl.currentDatasource"},Component:t.AnnotationsQueryCtrl}});case"datasource-config-ctrl":var i=e.ctrl.datasourceMeta;return Ni(i.module).then(function(e){return e.ConfigCtrl?{baseUrl:i.baseUrl,name:"ds-config-"+i.id,bindings:{meta:"=",current:"="},attrs:{meta:"ctrl.datasourceMeta",current:"ctrl.current"},Component:e.ConfigCtrl}:{notFound:!0}});case"app-config-ctrl":var s=e.ctrl.model;return Ni(s.module).then(function(e){return{baseUrl:s.baseUrl,name:"app-config-"+s.id,bindings:{appModel:"=",appEditCtrl:"="},attrs:{"app-model":"ctrl.model","app-edit-ctrl":"ctrl"},Component:e.ConfigCtrl}});case"app-page":var l=e.ctrl.appModel;return Ni(l.module).then(function(t){return{baseUrl:l.baseUrl,name:"app-page-"+l.id+"-"+e.ctrl.page.slug,bindings:{appModel:"="},attrs:{"app-model":"ctrl.appModel"},Component:t[e.ctrl.page.component]}});case"panel":return o(e);default:return r.reject({message:"Could not find component type: "+a.type})}})(e,i).then(function(t){l(e,n,i,t)}).catch(function(e){a.appEvent("alert-error",["插件报错",e.message||e]),console.log("Plugin component error",e)})}}}U.a.directive("pluginComponent",Bi);var Qi=function(){function e(e,t,a,r,n,i,s,o,l,u,c){this.$scope=e,this.$rootScope=t,this.keybindingSrv=a,this.timeSrv=r,this.variableSrv=n,this.alertingSrv=i,this.dashboardSrv=s,this.unsavedChangesSrv=o,this.dashboardViewStateSrv=l,this.playlistSrv=u,this.panelLoader=c,e.ctrl=this,this.editTab=0,this.getPanelContainer=this.getPanelContainer.bind(this)}return e.$inject=["$scope","$rootScope","keybindingSrv","timeSrv","variableSrv","alertingSrv","dashboardSrv","unsavedChangesSrv","dashboardViewStateSrv","playlistSrv","panelLoader"],e.prototype.setupDashboard=function(e){try{this.setupDashboardInternal(e)}catch(e){this.onInitFailed(e,"仪表盘初始化失败",!0)}},e.prototype.setupDashboardInternal=function(e){var t=this,a=this.dashboardSrv.create(e.dashboard,e.meta);this.dashboardSrv.setCurrent(a),this.timeSrv.init(a),this.alertingSrv.init(a,e.alerts),this.variableSrv.init(a).catch(this.onInitFailed.bind(this,"模板初始化失败",!1)).finally(function(){t.dashboard=a,t.dashboard.processRepeats(),t.unsavedChangesSrv.init(a,t.$scope),t.$scope.dashboard=a,t.dashboardViewState=t.dashboardViewStateSrv.create(t.$scope),t.keybindingSrv.setupDashboardBindings(t.$scope,a),t.dashboard.updateSubmenuVisibility(),t.setWindowTitleAndTheme(),t.$scope.appEvent("dashboard-initialized",a)}).catch(this.onInitFailed.bind(this,"仪表盘初始化失败",!0))},e.prototype.onInitFailed=function(e,t,a){console.log(e,a),a.data&&a.data.message?a.message=a.data.message:a.message||(a={message:a.toString()}),this.$scope.appEvent("alert-error",[e,a.message]),t&&!this.loadedFallbackDashboard&&(this.loadedFallbackDashboard=!0,this.setupDashboard({dashboard:{title:"仪表盘初始化失败"}}))},e.prototype.templateVariableUpdated=function(){this.dashboard.processRepeats()},e.prototype.setWindowTitleAndTheme=function(){window.document.title=_e.a.window_title_prefix+this.dashboard.title},e.prototype.showJsonEditor=function(e,t){var a=this.$rootScope.$new();a.object=t.object,a.updateHandler=t.updateHandler,this.$scope.appEvent("show-dash-editor",{src:"public/app/partials/edit_json.html",scope:a})},e.prototype.getDashboard=function(){return this.dashboard},e.prototype.getPanelLoader=function(){return this.panelLoader},e.prototype.timezoneChanged=function(){this.$rootScope.$broadcast("refresh")},e.prototype.getPanelContainer=function(){return this},e.prototype.onRemovingPanel=function(e,t){if((t=t||{}).panelId){var a=this.dashboard.getPanelInfoById(t.panelId);this.removePanel(a.panel,!0)}},e.prototype.removePanel=function(e,t){var a,r,n=this;if(!1!==t)return e.alert&&(a="面板包含报警规则，删除面板也将删除报警规则",r="确认"),void this.$scope.appEvent("confirm-modal",{title:"删除面板",text:"确定要删除此面板吗?",text2:a,icon:"fa-trash",confirmText:r,yesText:"删除",onConfirm:function(){n.removePanel(e,!1)}});this.dashboard.removePanel(e)},e.prototype.init=function(e){this.$scope.onAppEvent("show-json-editor",this.showJsonEditor.bind(this)),this.$scope.onAppEvent("template-variable-value-updated",this.templateVariableUpdated.bind(this)),this.$scope.onAppEvent("panel-remove",this.onRemovingPanel.bind(this)),this.setupDashboard(e)},e}();U.a.controller("DashboardCtrl",Qi);var zi=function(){function e(){}return e.prototype.init=function(e,t){this.dashboard=e,this.alerts=t||[]},e}();U.a.service("alertingSrv",zi);var Hi=function(){function e(e){this.backendSrv=e}return e.$inject=["backendSrv"],e.prototype.getHistoryList=function(e,t){var a=e&&e.id?e.id:void 0;return a?this.backendSrv.get("api/dashboards/id/"+a+"/versions",t):Promise.resolve([])},e.prototype.calculateDiff=function(e){return this.backendSrv.post("api/dashboards/calculate-diff",e)},e.prototype.restoreDashboard=function(e,t){var a=e&&e.id?e.id:void 0,r="api/dashboards/id/"+a+"/restore";return a&&D.a.isNumber(t)?this.backendSrv.post(r,{version:t}):Promise.resolve({})},e}();U.a.service("historySrv",Hi);var Yi=function(){function e(e,t,a,r,n,i){this.$route=e,this.$rootScope=t,this.$location=a,this.$q=r,this.historySrv=n,this.$scope=i,this.appending=!1,this.diff="basic",this.limit=10,this.loading=!1,this.max=2,this.mode="list",this.start=0,this.canCompare=!1,this.$rootScope.onAppEvent("dashboard-saved",this.onDashboardSaved.bind(this),i),this.resetFromSource()}return e.$inject=["$route","$rootScope","$location","$q","historySrv","$scope"],e.prototype.onDashboardSaved=function(){this.resetFromSource()},e.prototype.switchMode=function(e){this.mode=e,"list"===this.mode&&this.reset()},e.prototype.dismiss=function(){this.$rootScope.appEvent("hide-dash-editor")},e.prototype.addToLog=function(){this.start=this.start+this.limit,this.getLog(!0)},e.prototype.revisionSelectionChanged=function(){var e=D.a.filter(this.revisions,{checked:!0}).length;this.canCompare=2===e},e.prototype.formatDate=function(e){return this.dashboard.formatDate(e)},e.prototype.formatBasicDate=function(e){var t="browser"===this.dashboard.timezone?Y()():Y.a.utc();return("browser"===this.dashboard.timezone?Y()(e):Y.a.utc(e)).from(t)},e.prototype.getDiff=function(e){var t=this;if(this.diff=e,this.mode="compare",this.delta[this.diff])return this.$q.when(this.delta[this.diff]);var a=D.a.filter(this.revisions,{checked:!0});this.newInfo=a[0],this.baseInfo=a[1],this.isNewLatest=this.newInfo.version===this.dashboard.version,this.loading=!0;var r={new:{dashboardId:this.dashboard.id,version:this.newInfo.version},base:{dashboardId:this.dashboard.id,version:this.baseInfo.version},diffType:e};return this.historySrv.calculateDiff(r).then(function(e){t.delta[t.diff]=e}).catch(function(){t.mode="list"}).finally(function(){t.loading=!1})},e.prototype.getLog=function(e){var t=this;void 0===e&&(e=!1),this.loading=!e,this.appending=e;var a={limit:this.limit,start:this.start};return this.historySrv.getHistoryList(this.dashboard,a).then(function(a){for(var r=0,n=a;r<n.length;r++){var i=n[r];i.createdDateString=t.formatDate(i.created),i.ageString=t.formatBasicDate(i.created),i.checked=!1}t.revisions=e?t.revisions.concat(a):a}).catch(function(e){t.loading=!1}).finally(function(){t.loading=!1,t.appending=!1})},e.prototype.isLastPage=function(){return D.a.find(this.revisions,function(e){return 1===e.version})},e.prototype.reset=function(){this.delta={basic:"",json:""},this.diff="basic",this.mode="list",this.revisions=D.a.map(this.revisions,function(e){return D.a.extend({},e,{checked:!1})}),this.canCompare=!1,this.start=0,this.isNewLatest=!1},e.prototype.resetFromSource=function(){return this.revisions=[],this.getLog().then(this.reset.bind(this))},e.prototype.restore=function(e){this.$rootScope.appEvent("confirm-modal",{title:"还原版本",text:"",text2:"您确定要将仪表盘还原到版本 "+e+"吗？ 所有未保存的更改都将丢失。",icon:"fa-history",yesText:"是的，恢复到版本 "+e,onConfirm:this.restoreConfirm.bind(this,e)})},e.prototype.restoreConfirm=function(e){var t=this;return this.loading=!0,this.historySrv.restoreDashboard(this.dashboard,e).then(function(a){t.$location.url(Be.b.stripBaseFromUrl(a.url)).replace(),t.$route.reload(),t.$rootScope.appEvent("alert-success",["仪表盘已恢复","恢复到版本 "+e])}).catch(function(){t.mode="list",t.loading=!1})},e}();P.a.module("grafana.directives").directive("gfDashboardHistory",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/history/history.html",controller:Yi,bindToController:!0,controllerAs:"ctrl",scope:{dashboard:"="}}});var Wi=function(){function e(e,t,a,r,n,i,s,o,l){this.backendSrv=e,this.dashboardSrv=t,this.datasourceSrv=a,this.$http=r,this.$q=n,this.$timeout=i,this.$routeParams=o,this.$rootScope=l}return e.$inject=["backendSrv","dashboardSrv","datasourceSrv","$http","$q","$timeout","contextSrv","$routeParams","$rootScope"],e.prototype._dashboardLoadFailed=function(e,t){return{meta:{canStar:!1,isSnapshot:t=t||!1,canDelete:!1,canSave:!1,canEdit:!1,dashboardNotFound:!0},dashboard:{title:e}}},e.prototype.loadDashboard=function(e,t,a){var r,n=this;return(r="script"===e?this._loadScriptedDashboard(t):"snapshot"===e?this.backendSrv.get("/api/snapshots/"+t).catch(function(){return n._dashboardLoadFailed("未找到快照",!0)}):this.backendSrv.getDashboardByUid(a).then(function(e){if(e.meta.isFolder)throw n.$rootScope.appEvent("alert-error",["未找到仪表板"]),new Error("Dashboard not found");return e}).catch(function(){return n._dashboardLoadFailed("未找到",!0)})).then(function(e){return!0!==e.meta.dashboardNotFound&&At.a.addDashboardImpression(e.dashboard.id),e}),r},e.prototype._loadScriptedDashboard=function(e){var t=this,a="public/dashboards/"+e.replace(/\.(?!js)/,"/")+"?"+(new Date).getTime();return this.$http({url:a,method:"GET"}).then(this._executeScript.bind(this)).then(function(e){return{meta:{fromScript:!0,canDelete:!1,canSave:!1,canStar:!1},dashboard:e.data}},function(e){return console.log("Script dashboard error "+e),t.$rootScope.appEvent("alert-error",["脚本错误","请确保它存在并返回有效的仪表盘"]),t._dashboardLoadFailed("Scripted dashboard")})},e.prototype._executeScript=function(e){var t=this,a={dashboardSrv:this.dashboardSrv,datasourceSrv:this.datasourceSrv,$q:this.$q},r=new Function("ARGS","kbn","dateMath","_","moment","window","document","$","jQuery","services",e.data)(this.$routeParams,A.a,Le,D.a,Y.a,window,document,j.a,j.a,a);if(D.a.isFunction(r)){var n=this.$q.defer();return r(function(e){t.$timeout(function(){n.resolve({data:e})})}),n.promise}return{data:r}},e}();P.a.module("grafana.services").service("dashboardLoaderSrv",Wi);var Gi=function(){function e(e,t,a,r){if(this.$scope=e,this.dashboardSrv=t,this.$location=a,this.playlistSrv=r,W.b.on("save-dashboard",this.saveDashboard.bind(this),e),this.dashboard.meta.isSnapshot){var n=this.dashboard.meta;this.titleTooltip="创建于: &nbsp;"+Y()(n.created).calendar(),n.expires&&(this.titleTooltip+="<br>失效于: &nbsp;"+Y()(n.expires).fromNow()+"<br>")}}return e.$inject=["$scope","dashboardSrv","$location","playlistSrv"],e.prototype.toggleSettings=function(){var e=this.$location.search();e.editview?delete e.editview:e.editview="settings",this.$location.search(e)},e.prototype.close=function(){var e=this.$location.search();e.editview?delete e.editview:e.fullscreen&&(delete e.fullscreen,delete e.edit),this.$location.search(e)},e.prototype.starDashboard=function(){var e=this;this.dashboardSrv.starDashboard(this.dashboard.id,this.dashboard.meta.isStarred).then(function(t){e.dashboard.meta.isStarred=t})},e.prototype.shareDashboard=function(e){var t=this.$scope.$new();t.tabIndex=e,t.dashboard=this.dashboard,W.b.emit("show-modal",{src:"public/app/features/dashboard/partials/shareModal.html",scope:t})},e.prototype.hideTooltip=function(e){P.a.element(e.currentTarget).tooltip("hide")},e.prototype.saveDashboard=function(){return this.dashboardSrv.saveDashboard()},e.prototype.showSearch=function(){W.b.emit("show-dash-search")},e.prototype.addPanel=function(){W.b.emit("dash-scroll",{animate:!0,evt:0}),this.dashboard.panels.length>0&&"add-panel"===this.dashboard.panels[0].type||this.dashboard.addPanel({type:"add-panel",gridPos:{x:0,y:0,w:12,h:9},title:"面板标题"})},e.prototype.navItemClicked=function(e,t){e.clickHandler&&(e.clickHandler(),t.preventDefault())},e}();P.a.module("grafana.directives").directive("dashnav",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/dashnav/dashnav.html",controller:Gi,bindToController:!0,controllerAs:"ctrl",transclude:!0,scope:{dashboard:"="}}});var Ki=function(){function e(e,t,a){this.$rootScope=e,this.variableSrv=t,this.$location=a,this.annotations=this.dashboard.templating.list,this.variables=this.variableSrv.variables}return e.$inject=["$rootScope","variableSrv","$location"],e.prototype.annotationStateChanged=function(){this.$rootScope.$broadcast("refresh")},e.prototype.variableUpdated=function(e){this.variableSrv.variableUpdated(e,!0)},e.prototype.openEditView=function(e){var t=D.a.extend(this.$location.search(),{editview:e});this.$location.search(t)},e}();P.a.module("grafana.directives").directive("dashboardSubmenu",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/submenu/submenu.html",controller:Ki,bindToController:!0,controllerAs:"ctrl",scope:{dashboard:"="}}});var Ji='\n<div class="modal-body">\n\t<div class="modal-header">\n\t\t<h2 class="modal-header-title">\n\t\t\t<i class="fa fa-copy"></i>\n\t\t\t<span class="p-l-1">另存为...</span>\n\t\t</h2>\n\n\t\t<a class="modal-header-close" ng-click="ctrl.dismiss();">\n\t\t\t<i class="fa fa-remove"></i>\n\t\t</a>\n\t</div>\n\n\t<form name="ctrl.saveForm" class="modal-content" novalidate>\n\t\t<div class="p-t-2">\n\t\t\t<div class="gf-form">\n\t\t\t\t<label class="gf-form-label width-7">新名称</label>\n\t\t\t\t<input type="text" class="gf-form-input" ng-model="ctrl.clone.title" give-focus="true" required>\n\t\t\t</div>\n      <div class="gf-form">\n        <folder-picker initial-folder-id="ctrl.folderId"\n                       on-change="ctrl.onFolderChange($folder)"\n                       enter-folder-creation="ctrl.onEnterFolderCreation()"\n                       exit-folder-creation="ctrl.onExitFolderCreation()"\n                       enable-create-new="true"\n                       label-class="width-7">\n        </folder-picker>\n      </div>\n\t\t</div>\n\n\t\t<div class="gf-form-button-row text-center">\n\t\t\t<button type="submit" class="btn btn-success" ng-click="ctrl.save()" ng-disabled="!ctrl.isValidFolderSelection">保存</button>\n\t\t\t<a class="btn-text" ng-click="ctrl.dismiss();">取消</a>\n\t\t</div>\n\t</form>\n</div>\n',Xi=function(){function e(e){this.dashboardSrv=e,this.isValidFolderSelection=!0;var t=this.dashboardSrv.getCurrent();this.clone=t.getSaveModelClone(),this.clone.id=null,this.clone.uid="",this.clone.title+=" 副本",this.clone.editable=!0,this.clone.hideControls=!1,this.folderId=t.meta.folderId,t.id>0&&this.clone.panels.forEach(function(e){"graph"===e.type&&e.alert&&delete e.thresholds,delete e.alert}),delete this.clone.autoUpdate}return e.$inject=["dashboardSrv"],e.prototype.save=function(){return this.dashboardSrv.save(this.clone,{folderId:this.folderId}).then(this.dismiss)},e.prototype.keyDown=function(e){13===e.keyCode&&this.save()},e.prototype.onFolderChange=function(e){this.folderId=e.id},e.prototype.onEnterFolderCreation=function(){this.isValidFolderSelection=!1},e.prototype.onExitFolderCreation=function(){this.isValidFolderSelection=!0},e}();U.a.directive("saveDashboardAsModal",function(){return{restrict:"E",template:Ji,controller:Xi,bindToController:!0,controllerAs:"ctrl",scope:{dismiss:"&"}}});var Zi='\n<div class="modal-body">\n  <div class="modal-header">\n    <h2 class="modal-header-title">\n      <i class="fa fa-save"></i>\n      <span class="p-l-1">保存更改</span>\n    </h2>\n\n    <a class="modal-header-close" ng-click="ctrl.dismiss();">\n      <i class="fa fa-remove"></i>\n    </a>\n  </div>\n\n  <form name="ctrl.saveForm" ng-submit="ctrl.save()" class="modal-content" novalidate>\n    <div class="p-t-1">\n      <div class="gf-form-group" ng-if="ctrl.timeChange || ctrl.variableValueChange">\n\t\t    <gf-form-switch class="gf-form"\n\t\t\t    label="保存当前的时间范围" ng-if="ctrl.timeChange" label-class="width-12" switch-class="max-width-6"\n\t\t\t    checked="ctrl.saveTimerange" on-change="buildUrl()">\n\t\t    </gf-form-switch>\n\t\t    <gf-form-switch class="gf-form"\n\t\t\t    label="保存当前的所有变量" ng-if="ctrl.variableValueChange" label-class="width-12" switch-class="max-width-6"\n\t\t\t    checked="ctrl.saveVariables" on-change="buildUrl()">\n\t\t    </gf-form-switch>\n\t    </div>\n      <div class="gf-form">\n        <label class="gf-form-hint">\n          <input\n            type="text"\n            name="message"\n            class="gf-form-input"\n            placeholder="添加备注以描述您的更改 &hellip;"\n            give-focus="true"\n            ng-model="ctrl.message"\n            ng-model-options="{allowInvalid: true}"\n            ng-maxlength="this.max"\n            maxlength="64"\n            autocomplete="off" />\n          <small class="gf-form-hint-text muted" ng-cloak>\n            <span ng-class="{\'text-error\': ctrl.saveForm.message.$invalid && ctrl.saveForm.message.$dirty }">\n              {{ctrl.message.length || 0}}\n            </span>\n            / {{ctrl.max}} 字符\n          </small>\n        </label>\n      </div>\n    </div>\n\n    <div class="gf-form-button-row text-center">\n      <button\n        id="saveBtn"\n        type="submit"\n        class="btn btn-success"\n        ng-class="{\'btn-success--processing\': ctrl.isSaving}"\n        ng-disabled="ctrl.saveForm.$invalid || ctrl.isSaving"\n      >\n        <span ng-if="!ctrl.isSaving">保存</span>\n        <span ng-if="ctrl.isSaving === true">保存中...</span>\n      </button>\n      <button class="btn btn-inverse" ng-click="ctrl.dismiss();">取消</button>\n    </div>\n  </form>\n</div>\n',es=function(){function e(e){this.dashboardSrv=e,this.saveVariables=!1,this.saveTimerange=!1,this.current=[],this.originalCurrent=[],this.timeChange=!1,this.variableValueChange=!1,this.message="",this.max=64,this.isSaving=!1,this.timeChange=this.dashboardSrv.getCurrent().hasTimeChanged(),this.variableValueChange=this.dashboardSrv.getCurrent().hasVariableValuesChanged()}return e.$inject=["dashboardSrv"],e.prototype.save=function(){if(this.saveForm.$valid){var e={saveVariables:this.saveVariables,saveTimerange:this.saveTimerange,message:this.message},t=this.dashboardSrv.getCurrent().getSaveModelClone(e);return this.isSaving=!0,this.dashboardSrv.save(t,e).then(this.postSave.bind(this,e))}},e.prototype.postSave=function(e){e.saveVariables&&this.dashboardSrv.getCurrent().resetOriginalVariables(),e.saveTimerange&&this.dashboardSrv.getCurrent().resetOriginalTime(),this.dismiss()},e}();U.a.directive("saveDashboardModal",function(){return{restrict:"E",template:Zi,controller:es,bindToController:!0,controllerAs:"ctrl",scope:{dismiss:"&"}}});var ts='\n<div class="modal-body">\n  <div class="modal-header">\n    <h2 class="modal-header-title">\n      <i class="fa fa-save"></i><span class="p-l-1">无法保存配置的仪表盘</span>\n    </h2>\n\n    <a class="modal-header-close" ng-click="ctrl.dismiss();">\n      <i class="fa fa-remove"></i>\n    </a>\n  </div>\n\n  <div class="modal-content">\n    <small>\n      此仪表盘无法从Grafana的UI中保存，因为它已从其他来源进行配置。\n      复制JSON或将其保存到下面的文件中。 然后，您可以在相应的配置源中更新仪表盘。<br/>\n      <i>查看 <a class="external-link" href="http://docs.grafana.org/administration/provisioning/#dashboards" target="_blank">\n      文档</a> 获取有关配置的更多信息。</i>\n    </small>\n    <div class="p-t-2">\n      <div class="gf-form">\n        <code-editor content="ctrl.dashboardJson" data-mode="json" data-max-lines=15></code-editor>\n      </div>\n      <div class="gf-form-button-row">\n        <button class="btn btn-success" clipboard-button="ctrl.getJsonForClipboard()">\n          <i class="fa fa-clipboard"></i>&nbsp;将JSON复制到剪贴板\n        </button>\n        <button class="btn btn-secondary" clipboard-button="ctrl.save()">\n          <i class="fa fa-save"></i>&nbsp;将JSON保存到文件\n        </button>\n        <a class="btn btn-link" ng-click="ctrl.dismiss();">取消</a>\n      </div>\n    </div>\n  </div>\n</div>\n',as=function(){function e(e){this.dash=e.getCurrent().getSaveModelClone(),delete this.dash.id,this.dashboardJson=P.a.toJson(this.dash,!0)}return e.$inject=["dashboardSrv"],e.prototype.save=function(){var e=new Blob([P.a.toJson(this.dash,!0)],{type:"application/json;charset=utf-8"});Object(ut.saveAs)(e,this.dash.title+"-"+(new Date).getTime()+".json")},e.prototype.getJsonForClipboard=function(){return this.dashboardJson},e}();U.a.directive("saveProvisionedDashboardModal",function(){return{restrict:"E",template:ts,controller:as,bindToController:!0,controllerAs:"ctrl",scope:{dismiss:"&"}}});var rs=function(){function e(e,t,a,r,n,i,s){e.options={forCurrent:!0,includeTemplateVars:!0,theme:"current"},e.editor={index:e.tabIndex||0},e.init=function(){e.modeSharePanel=!!e.panel,e.tabs=[{title:"链接",src:"shareLink.html"}],e.modeSharePanel?(e.modalTitle="分享面板",e.tabs.push({title:"嵌入式",src:"shareEmbed.html"})):e.modalTitle="分享",e.dashboard.meta.isSnapshot||e.tabs.push({title:"快照",src:"shareSnapshot.html"}),e.dashboard.meta.isSnapshot||e.modeSharePanel||e.tabs.push({title:"导出",src:"shareExport.html"}),e.buildUrl()},e.buildUrl=function(){var t=a.absUrl(),r=t.indexOf("?");-1!==r&&(t=t.substring(0,r));var o=P.a.copy(a.search()),l=n.timeRange();o.from=l.from.valueOf(),o.to=l.to.valueOf(),o.orgId=_e.a.bootData.user.orgId,e.options.includeTemplateVars&&i.fillVariableValuesForUrl(o),e.options.forCurrent||(delete o.from,delete o.to),"current"!==e.options.theme&&(o.theme=e.options.theme),e.modeSharePanel?(o.panelId=e.panel.id,o.fullscreen=!0):(delete o.panelId,delete o.fullscreen),e.shareUrl=s.addParamsToUrl(t,o);var u=t.replace(_e.a.appSubUrl+"/dashboard/",_e.a.appSubUrl+"/dashboard-solo/");u=u.replace(_e.a.appSubUrl+"/d/",_e.a.appSubUrl+"/d-solo/"),delete o.fullscreen,delete o.edit,u=s.addParamsToUrl(u,o),e.iframeHtml='<iframe src="'+u+'" width="450" height="200" frameborder="0"></iframe>',e.imageUrl=u.replace(_e.a.appSubUrl+"/dashboard-solo/",_e.a.appSubUrl+"/render/dashboard-solo/"),e.imageUrl=e.imageUrl.replace(_e.a.appSubUrl+"/d-solo/",_e.a.appSubUrl+"/render/d-solo/"),e.imageUrl+="&width=1000&height=500"+e.getLocalTimeZone()},e.getLocalTimeZone=function(){var e="&tz=UTC"+encodeURIComponent(Y()().format("Z"));if(!window.Intl)return e;var t=window.Intl.DateTimeFormat();if(!t.resolvedOptions)return e;var a=t.resolvedOptions();return a.timeZone?"&tz="+encodeURIComponent(a.timeZone):e},e.getShareUrl=function(){return e.shareUrl}}return e.$inject=["$scope","$rootScope","$location","$timeout","timeSrv","templateSrv","linkSrv"],e}();P.a.module("grafana.controllers").controller("ShareModalCtrl",rs);var ns=function(){function e(e,t,a,r,n,i){e.snapshot={name:e.dashboard.title,expires:0,timeoutSeconds:4},e.step=1,e.expireOptions=[{text:"1 小时",value:3600},{text:"1 天",value:86400},{text:"7 天",value:604800},{text:"从不",value:0}],e.accessOptions=[{text:"拥有链接的任何人",value:1},{text:"组织用户",value:2},{text:"在网上公开",value:3}],e.init=function(){r.get("/api/snapshot/shared-options").then(function(t){e.externalUrl=t.externalSnapshotURL,e.sharingButtonText=t.externalSnapshotName,e.externalEnabled=t.externalEnabled})},e.apiUrl="/api/snapshots",e.createSnapshot=function(r){e.dashboard.snapshot={timestamp:new Date},r||(e.dashboard.snapshot.originalUrl=a.absUrl()),e.loading=!0,e.snapshot.external=r,t.$broadcast("refresh"),n(function(){e.saveSnapshot(r)},1e3*e.snapshot.timeoutSeconds)},e.saveSnapshot=function(t){var n=e.dashboard.getSaveModelClone();e.scrubDashboard(n);var i={dashboard:n,name:n.title,expires:e.snapshot.expires},s=t?e.externalUrl+e.apiUrl:e.apiUrl;r.post(s,i).then(function(r){if(e.loading=!1,t)e.deleteUrl=r.deleteUrl,e.snapshotUrl=r.url,e.saveExternalSnapshotRef(i,r);else{var n=a.url(),s=a.absUrl();"/"!==n&&(s=s.replace(n,"")+"/"),e.snapshotUrl=s+"dashboard/snapshot/"+r.key,e.deleteUrl=s+"api/snapshots-delete/"+r.deleteKey}e.step=2},function(){e.loading=!1})},e.getSnapshotUrl=function(){return e.snapshotUrl},e.scrubDashboard=function(t){if(t.title=e.snapshot.name,t.time=i.timeRange(),D.a.each(t.panels,function(e){e.targets=[],e.links=[],e.datasource=null}),t.annotations.list=D.a.chain(t.annotations.list).filter(function(e){return e.enable}).map(function(e){return{name:e.name,enable:e.enable,iconColor:e.iconColor,snapshotData:e.snapshotData,type:e.type,builtIn:e.builtIn,hide:e.hide}}).value(),D.a.each(t.templating.list,function(e){e.query="",e.options=e.current,e.refresh=!1}),e.modeSharePanel){var a=e.panel.getSaveModel();a.gridPos.w=24,a.gridPos.x=0,a.gridPos.y=0,a.gridPos.h=20,t.panels=[a]}delete e.dashboard.snapshot,e.dashboard.forEachPanel(function(e){delete e.snapshotData}),D.a.each(e.dashboard.annotations.list,function(e){delete e.snapshotData})},e.deleteSnapshot=function(){r.get(e.deleteUrl).then(function(){e.step=3})},e.saveExternalSnapshotRef=function(e,t){e.external=!0,e.key=t.key,e.deleteKey=t.deleteKey,r.post("/api/snapshots/",e)}}return e.$inject=["$scope","$rootScope","$location","backendSrv","$timeout","timeSrv"],e}();P.a.module("grafana.controllers").controller("ShareSnapshotCtrl",ns);var is=a(226),ss=function(){function e(e,t,a){this.backendSrv=e,this.$rootScope=t,this.$location=a}return e.$inject=["backendSrv","$rootScope","$location"],e.prototype.create=function(e,t){return new is.a(e,t)},e.prototype.setCurrent=function(e){this.dash=e},e.prototype.getCurrent=function(){return this.dash},e.prototype.handleSaveDashboardError=function(e,t,a){var r=this;(t=t||{}).overwrite=!0,a.data&&"version-mismatch"===a.data.status&&(a.isHandled=!0,this.$rootScope.appEvent("confirm-modal",{title:"冲突",text:"其他人已更新此仪表板。",text2:"你还想保存这个仪表板吗?",yesText:"保存并覆盖",icon:"fa-warning",onConfirm:function(){r.save(e,t)}})),a.data&&"name-exists"===a.data.status&&(a.isHandled=!0,this.$rootScope.appEvent("confirm-modal",{title:"冲突",text:"所选文件夹中已存在相同名称的仪表板。",text2:"你还想保存这个仪表板吗?",yesText:"保存并覆盖",icon:"fa-warning",onConfirm:function(){r.save(e,t)}})),a.data&&"plugin-dashboard"===a.data.status&&(a.isHandled=!0,this.$rootScope.appEvent("confirm-modal",{title:"插件仪表板",text:a.data.message,text2:"更新插件时，您的更改将丢失。 使用“另存为”创建自定义版本。",yesText:"覆盖",icon:"fa-warning",altActionText:"另存为",onAltAction:function(){r.showSaveAsModal()},onConfirm:function(){r.save(e,{overwrite:!0})}}))},e.prototype.postSave=function(e,t){this.dash.version=t.version;var a=Be.b.stripBaseFromUrl(t.url);return a!==this.$location.path()&&this.$location.url(a).replace(),this.$rootScope.appEvent("dashboard-saved",this.dash),this.$rootScope.appEvent("alert-success",["仪表盘已保存"]),this.dash},e.prototype.save=function(e,t){return(t=t||{}).folderId=t.folderId>=0?t.folderId:this.dash.meta.folderId||e.folderId,this.backendSrv.saveDashboard(e,t).then(this.postSave.bind(this,e)).catch(this.handleSaveDashboardError.bind(this,e,t))},e.prototype.saveDashboard=function(e,t){return t&&this.setCurrent(this.create(t,this.dash.meta)),this.dash.meta.provisioned?this.showDashboardProvisionedModal():this.dash.meta.canSave||!0===e.makeEditable?"New dashboard"===this.dash.title?this.showSaveAsModal():this.dash.version>0?this.showSaveModal():this.save(this.dash.getSaveModelClone(),e):Promise.resolve()},e.prototype.saveJSONDashboard=function(e){return this.save(JSON.parse(e),{})},e.prototype.showDashboardProvisionedModal=function(){this.$rootScope.appEvent("show-modal",{templateHtml:'<save-provisioned-dashboard-modal dismiss="dismiss()"></save-provisioned-dashboard-modal>'})},e.prototype.showSaveAsModal=function(){this.$rootScope.appEvent("show-modal",{templateHtml:'<save-dashboard-as-modal dismiss="dismiss()"></save-dashboard-as-modal>',modalClass:"modal--narrow"})},e.prototype.showSaveModal=function(){this.$rootScope.appEvent("show-modal",{templateHtml:'<save-dashboard-modal dismiss="dismiss()"></save-dashboard-modal>',modalClass:"modal--narrow"})},e.prototype.starDashboard=function(e,t){var a=this;return(t?this.backendSrv.delete("/api/user/stars/dashboard/"+e).then(function(){return!1}):this.backendSrv.post("/api/user/stars/dashboard/"+e).then(function(){return!0})).then(function(t){return a.dash&&a.dash.id===e&&(a.dash.meta.isStarred=t),t})},e}();U.a.service("dashboardSrv",ss);var os=function(){function e(e,t,a,r){this.$location=t,this.$timeout=a,this.$rootScope=r;var n=this;n.state={},n.panelScopes=[],n.$scope=e,n.dashboard=e.dashboard,e.onAppEvent("$routeUpdate",function(){var e=n.getQueryStringState();n.needsSync(e)&&n.update(e,!0)}),e.onAppEvent("panel-change-view",function(e,t){n.update(t)}),e.onAppEvent("panel-initialized",function(e,t){n.registerPanel(t.scope)}),t.replace(),this.update(this.getQueryStringState())}return e.$inject=["$scope","$location","$timeout","$rootScope"],e.prototype.needsSync=function(e){return!1===D.a.isEqual(this.state,e)},e.prototype.getQueryStringState=function(){var e=this.$location.search();return e.panelId=parseInt(e.panelId)||null,e.fullscreen=!!e.fullscreen||null,e.edit="true"===e.edit||!0===e.edit||null,e.editview=e.editview||null,e.orgId=_e.a.bootData.user.orgId,e},e.prototype.serializeToUrl=function(){var e=D.a.clone(this.state);return e.fullscreen=!!this.state.fullscreen||null,e.edit=!!this.state.edit||null,e},e.prototype.update=function(e,t){e.toggle&&(delete e.toggle,this.state.fullscreen&&e.fullscreen&&this.state.edit===e.edit&&(e.fullscreen=!e.fullscreen)),this.editStateChanged=(e.edit||!1)!==(this.state.edit||!1),D.a.extend(this.state,e),this.dashboard.meta.fullscreen=this.state.fullscreen,this.state.fullscreen||(this.state.fullscreen=null,this.state.edit=null,this.dashboard.meta.soloMode||(this.state.panelId=null)),(this.state.fullscreen||this.dashboard.meta.soloMode)&&this.state.panelId&&this.toggleCollapsedPanelRow(this.state.panelId),this.state.edit||delete this.state.tab,!0!==t&&this.$location.search(this.serializeToUrl()),this.syncState()},e.prototype.toggleCollapsedPanelRow=function(e){for(var t=0,a=this.dashboard.panels;t<a.length;t++){var r=a[t];if(r.collapsed)for(var n=0,i=r.panels;n<i.length;n++){if(i[n].id===e)return void this.dashboard.toggleRow(r)}}},e.prototype.syncState=function(){if(0!==this.panelScopes.length)if(this.dashboard.meta.fullscreen){var e=this.getPanelScope(this.state.panelId);if(!e)return;if(this.fullscreenPanel){if(this.fullscreenPanel===e&&!1===this.editStateChanged)return;this.leaveFullscreen(!1)}e.ctrl.editModeInitiated||e.ctrl.initEditMode(),e.ctrl.fullscreen||this.enterFullscreen(e)}else this.fullscreenPanel&&this.leaveFullscreen(!0)},e.prototype.getPanelScope=function(e){return D.a.find(this.panelScopes,function(t){return t.ctrl.panel.id===e})},e.prototype.leaveFullscreen=function(e){var t=this,a=t.fullscreenPanel.ctrl;return a.editMode=!1,a.fullscreen=!1,this.dashboard.setViewMode(a.panel,!1,!1),this.$scope.appEvent("panel-fullscreen-exit",{panelId:a.panel.id}),this.$scope.appEvent("dash-scroll",{restore:!0}),!!e&&(this.$timeout(function(){t.oldTimeRange!==a.range?t.$rootScope.$broadcast("refresh"):t.$rootScope.$broadcast("render"),delete t.fullscreenPanel}),!0)},e.prototype.enterFullscreen=function(e){var t=e.ctrl;t.editMode=this.state.edit&&this.dashboard.meta.canEdit,t.fullscreen=!0,this.oldTimeRange=t.range,this.fullscreenPanel=e,this.$scope.appEvent("dash-scroll",{animate:!1,pos:0}),this.dashboard.setViewMode(t.panel,!0,t.editMode),this.$scope.appEvent("panel-fullscreen-enter",{panelId:t.panel.id})},e.prototype.registerPanel=function(e){var t=this;t.panelScopes.push(e),t.dashboard.meta.soloMode||t.state.panelId===e.ctrl.panel.id&&(t.state.edit?e.ctrl.editPanel():e.ctrl.viewPanel());var a=e.$on("$destroy",function(){t.panelScopes=D.a.without(t.panelScopes,e),a()})},e}();function ls(e,t,a){return{create:function(r){return new os(r,e,t,a)}}}P.a.module("grafana.services").factory("dashboardViewStateSrv",ls);var us="dash-folder",cs="dash-db",ds=function(){function e(e,t){this.$q=e,this.backendSrv=t,this.rootName="general"}return e.$inject=["$q","backendSrv"],e.prototype.validateNewDashboardName=function(e,t){return this.validate(e,t,"此文件夹中已存在同名的仪表盘")},e.prototype.validateNewFolderName=function(e){return this.validate(0,e,"默认文件夹中已存在同名的仪表盘或文件夹")},e.prototype.validate=function(e,t,a){var r=(t=(t||"").trim()).toLowerCase();if(0===t.length)return this.$q.reject({type:"REQUIRED",message:"名称是必需的"});if(0===e&&r===this.rootName)return this.$q.reject({type:"EXISTING",message:"这是保留名称，不能用于文件夹命名。"});var n=this.$q.defer(),i=[];return i.push(this.backendSrv.search({type:us,folderIds:[e],query:t})),i.push(this.backendSrv.search({type:cs,folderIds:[e],query:t})),this.$q.all(i).then(function(e){var t=[];e.length>0&&e[0].length>0&&(t=e[0]),e.length>1&&e[1].length>0&&(t=t.concat(e[1]));for(var i=0,s=t;i<s.length;i++){var o=s[i];if(r===o.title.toLowerCase()){n.reject({type:"EXISTING",message:a});break}}n.resolve()}),n.promise},e}();U.a.service("validationSrv",ds);var ps=function(){function e(e,t,a,r,n){var i=this;this.$rootScope=e,this.$timeout=t,this.$location=a,this.timer=r,this.contextSrv=n,this.time={from:"6h",to:"now"},e.$on("zoom-out",this.zoomOut.bind(this)),e.$on("$routeUpdate",this.routeUpdated.bind(this)),document.addEventListener("visibilitychange",function(){i.autoRefreshBlocked&&"visible"===document.visibilityState&&(i.autoRefreshBlocked=!1,i.refreshDashboard())})}return e.$inject=["$rootScope","$timeout","$location","timer","contextSrv"],e.prototype.init=function(e){this.timer.cancelAll(),this.dashboard=e,this.time=e.time,this.refresh=e.refresh,this.initTimeFromUrl(),this.parseTime(),this.timeAtLoad=D.a.cloneDeep(this.time),this.refresh&&this.setAutoRefresh(this.refresh)},e.prototype.parseTime=function(){D.a.isString(this.time.from)&&this.time.from.indexOf("Z")>=0&&(this.time.from=Y()(this.time.from).utc()),D.a.isString(this.time.to)&&this.time.to.indexOf("Z")>=0&&(this.time.to=Y()(this.time.to).utc())},e.prototype.parseUrlParam=function(e){if(-1!==e.indexOf("now"))return e;if(8===e.length)return Y.a.utc(e,"YYYYMMDD");if(15===e.length)return Y.a.utc(e,"YYYYMMDDTHHmmss");if(!isNaN(e)){var t=parseInt(e);return Y.a.utc(t)}return null},e.prototype.initTimeFromUrl=function(){var e=this.$location.search();e.from&&(this.time.from=this.parseUrlParam(e.from)||this.time.from),e.to&&(this.time.to=this.parseUrlParam(e.to)||this.time.to),e.refresh&&(this.refresh=e.refresh||this.refresh)},e.prototype.routeUpdated=function(){var e=this.$location.search(),t=this.timeRangeForUrl();e.from&&e.to?e.from===t.from&&e.to===t.to||(this.initTimeFromUrl(),this.setTime(this.time,!0)):this.timeHasChangedSinceLoad()&&this.setTime(this.timeAtLoad,!0)},e.prototype.timeHasChangedSinceLoad=function(){return this.timeAtLoad.from!==this.time.from||this.timeAtLoad.to!==this.time.to},e.prototype.setAutoRefresh=function(e){var t=this;if(this.dashboard.refresh=e,this.cancelNextRefresh(),e){var a=A.a.interval_to_ms(e);this.refreshTimer=this.timer.register(this.$timeout(function(){t.startNextRefreshTimer(a),t.refreshDashboard()},a))}var r=this.$location.search();e?(r.refresh=e,this.$location.search(r)):r.refresh&&(delete r.refresh,this.$location.search(r))},e.prototype.refreshDashboard=function(){this.$rootScope.$broadcast("refresh")},e.prototype.startNextRefreshTimer=function(e){var t=this;this.cancelNextRefresh(),this.refreshTimer=this.timer.register(this.$timeout(function(){t.startNextRefreshTimer(e),t.contextSrv.isGrafanaVisible()?t.refreshDashboard():t.autoRefreshBlocked=!0},e))},e.prototype.cancelNextRefresh=function(){this.timer.cancel(this.refreshTimer)},e.prototype.setTime=function(e,t){if(D.a.extend(this.time,e),Y.a.isMoment(e.to)?(this.oldRefresh=this.dashboard.refresh||this.oldRefresh,this.setAutoRefresh(!1)):this.oldRefresh&&this.oldRefresh!==this.dashboard.refresh&&(this.setAutoRefresh(this.oldRefresh),this.oldRefresh=null),!0!==t){var a=this.timeRangeForUrl(),r=this.$location.search();r.from=a.from,r.to=a.to,this.$location.search(r)}this.$rootScope.appEvent("time-range-changed",this.time),this.$timeout(this.refreshDashboard.bind(this),0)},e.prototype.timeRangeForUrl=function(){var e=this.timeRange().raw;return Y.a.isMoment(e.from)&&(e.from=e.from.valueOf().toString()),Y.a.isMoment(e.to)&&(e.to=e.to.valueOf().toString()),e},e.prototype.timeRange=function(){var e={from:Y.a.isMoment(this.time.from)?Y()(this.time.from):this.time.from,to:Y.a.isMoment(this.time.to)?Y()(this.time.to):this.time.to},t=this.dashboard&&this.dashboard.getTimezone();return{from:Le.parse(e.from,!1,t),to:Le.parse(e.to,!0,t),raw:e}},e.prototype.zoomOut=function(e,t){var a=this.timeRange(),r=a.to.valueOf()-a.from.valueOf(),n=a.to.valueOf()-r/2,i=n+r*t/2,s=n-r*t/2;i>Date.now()&&a.to<=Date.now()&&(s-=i-Date.now(),i=Date.now());this.setTime({from:Y.a.utc(s),to:Y.a.utc(i)})},e}();U.a.service("timeSrv",ps);var hs=function(){function e(e,t,a,r,n,i,s,o){var l=this;this.$location=r,this.$timeout=i,this.contextSrv=s,this.$rootScope=o,this.$location=r,this.$window=n,this.current=e,this.originalPath=r.path(),this.scope=t,t.onAppEvent("dashboard-saved",function(){l.original=l.current.getSaveModelClone(),l.originalPath=r.path()}),n.onbeforeunload=function(){if(!l.ignoreChanges())return l.hasChanges()?"此仪表盘有未保存的更改":void 0},t.$on("$locationChangeStart",function(e,t){return l.originalPath===r.path()||(!!l.ignoreChanges()||(l.hasChanges()&&(e.preventDefault(),l.next=t,l.$timeout(function(){l.open_modal()})),!1))}),a?this.$timeout(function(){l.original=e.getSaveModelClone()},a):this.original=e.getSaveModelClone()}return e.$inject=["dashboard","scope","originalCopyDelay","$location","$window","$timeout","contextSrv","$rootScope"],e.prototype.ignoreChanges=function(){if(!this.original)return!0;if(!this.contextSrv.isEditor)return!0;if(!this.current||!this.current.meta)return!0;var e=this.current.meta;return!e.canSave||e.fromScript||e.fromFile},e.prototype.cleanDashboardFromIgnoredChanges=function(e){var t=new is.a(e);t.expandRows();var a=t.getSaveModelClone();return a.time=0,a.refresh=0,a.schemaVersion=0,delete a.iteration,a.panels=D.a.filter(a.panels,function(e){return!e.repeatPanelId&&(e.scopedVars=null,e.legend&&(delete e.legend.sort,delete e.legend.sortDesc),!0)}),D.a.each(a.templating.list,function(e){e.current=null,e.options=null,e.filters=null}),a},e.prototype.hasChanges=function(){var e=this.cleanDashboardFromIgnoredChanges(this.current.getSaveModelClone()),t=this.cleanDashboardFromIgnoredChanges(this.original),a=D.a.find(e.nav,{type:"timepicker"}),r=D.a.find(t.nav,{type:"timepicker"});return a&&r&&(a.now=r.now),P.a.toJson(e,!0)!==P.a.toJson(t,!0)},e.prototype.discardChanges=function(){this.original=null,this.gotoNext()},e.prototype.open_modal=function(){this.$rootScope.appEvent("show-modal",{templateHtml:'<unsaved-changes-modal dismiss="dismiss()"></unsaved-changes-modal>',modalClass:"modal--narrow confirm-modal"})},e.prototype.saveChanges=function(){var e=this,t=this,a=this.$rootScope.$on("dashboard-saved",function(){a(),e.$timeout(function(){t.gotoNext()})});this.$rootScope.appEvent("save-dashboard")},e.prototype.gotoNext=function(){var e=this.$location.absUrl().length-this.$location.url().length,t=this.next.substring(e);this.$location.url(t)},e}();function ms(e,t,a,r,n,i,s){this.init=function(t,i){return this.tracker=new hs(t,i,1e3,a,s,r,n,e),this.tracker}}P.a.module("grafana.services").service("unsavedChangesSrv",ms);var fs='\n<div class="modal-body">\n  <div class="modal-header">\n    <h2 class="modal-header-title">\n      <i class="fa fa-exclamation"></i>\n      <span class="p-l-1">未保存的更改</span>\n    </h2>\n\n    <a class="modal-header-close" ng-click="ctrl.dismiss();">\n      <i class="fa fa-remove"></i>\n    </a>\n  </div>\n\n  <div class="modal-content text-center">\n\n    <div class="confirm-modal-text">\n      要保存更改吗?\n    </div>\n\n    <div class="confirm-modal-buttons">\n      <button type="button" class="btn btn-success" ng-click="ctrl.save()">保存</button>\n      <button type="button" class="btn btn-danger" ng-click="ctrl.discard()">放弃</button>\n      <button type="button" class="btn btn-inverse" ng-click="ctrl.dismiss()">取消</button>\n    </div>\n  </div>\n</div>\n',gs=function(){function e(e){this.unsavedChangesSrv=e}return e.$inject=["unsavedChangesSrv"],e.prototype.discard=function(){this.dismiss(),this.unsavedChangesSrv.tracker.discardChanges()},e.prototype.save=function(){this.dismiss(),this.unsavedChangesSrv.tracker.saveChanges()},e}();U.a.directive("unsavedChangesModal",function(){return{restrict:"E",template:fs,controller:gs,bindToController:!0,controllerAs:"ctrl",scope:{dismiss:"&"}}});var vs=function(){function e(t,a,r){var n=this;this.$scope=t,this.$rootScope=a,this.timeSrv=r,this.$scope.ctrl=this,a.onAppEvent("shift-time-forward",function(){return n.move(1)},t),a.onAppEvent("shift-time-backward",function(){return n.move(-1)},t),a.onAppEvent("refresh",this.onRefresh.bind(this),t),a.onAppEvent("closeTimepicker",this.openDropdown.bind(this),t),this.panel=this.dashboard.timepicker,D.a.defaults(this.panel,e.defaults),this.firstDayOfWeek=Y.a.localeData().firstDayOfWeek(),this.onRefresh()}return e.$inject=["$scope","$rootScope","timeSrv"],e.prototype.onRefresh=function(){var e=P.a.copy(this.timeSrv.timeRange()),t=P.a.copy(e.raw);this.dashboard.isTimezoneUtc()?this.isUtc=!0:(e.from.local(),e.to.local(),Y.a.isMoment(t.from)&&t.from.local(),Y.a.isMoment(t.to)&&t.to.local(),this.isUtc=!1),this.rangeString=Ue.b(t),this.absolute={fromJs:e.from.toDate(),toJs:e.to.toDate()},this.tooltip=this.dashboard.formatDate(e.from)+" <br>to<br>",this.tooltip+=this.dashboard.formatDate(e.to),this.timeRaw=t},e.prototype.zoom=function(e){this.$rootScope.appEvent("zoom-out",2)},e.prototype.move=function(e){var t,a,r=this.timeSrv.timeRange(),n=(r.to.valueOf()-r.from.valueOf())/2;-1===e?(t=r.to.valueOf()-n,a=r.from.valueOf()-n):1===e?(t=r.to.valueOf()+n,a=r.from.valueOf()+n,t>Date.now()&&r.to<Date.now()&&(t=Date.now(),a=r.from.valueOf())):(t=r.to.valueOf(),a=r.from.valueOf()),this.timeSrv.setTime({from:Y.a.utc(a),to:Y.a.utc(t)})},e.prototype.openDropdown=function(){this.isOpen?this.closeDropdown():(this.onRefresh(),this.editTimeRaw=this.timeRaw,this.timeOptions=Ue.c(this.panel,this.rangeString),this.refresh={value:this.dashboard.refresh,options:D.a.map(this.panel.refresh_intervals,function(e){return{text:e,value:e}})},this.refresh.options.unshift({text:"off"}),this.isOpen=!0,this.$rootScope.appEvent("timepickerOpen"))},e.prototype.closeDropdown=function(){this.isOpen=!1,this.$rootScope.appEvent("timepickerClosed")},e.prototype.applyCustom=function(){this.refresh.value!==this.dashboard.refresh&&this.timeSrv.setAutoRefresh(this.refresh.value),this.timeSrv.setTime(this.editTimeRaw),this.closeDropdown()},e.prototype.absoluteFromChanged=function(){this.editTimeRaw.from=this.getAbsoluteMomentForTimezone(this.absolute.fromJs)},e.prototype.absoluteToChanged=function(){this.editTimeRaw.to=this.getAbsoluteMomentForTimezone(this.absolute.toJs)},e.prototype.getAbsoluteMomentForTimezone=function(e){return this.dashboard.isTimezoneUtc()?Y()(e).utc():Y()(e)},e.prototype.setRelativeFilter=function(e){var t={from:e.from,to:e.to};this.panel.nowDelay&&"now"===t.to&&(t.to="now-"+this.panel.nowDelay),this.timeSrv.setTime(t),this.closeDropdown()},e.tooltipFormat="MMM D, YYYY HH:mm:ss",e.defaults={time_options:["5m","15m","1h","6h","12h","24h","2d","7d","30d"],refresh_intervals:["5s","10s","30s","1m","5m","15m","30m","1h","2h","1d"]},e}();P.a.module("grafana.directives").directive("gfTimePickerSettings",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/timepicker/settings.html",controller:vs,bindToController:!0,controllerAs:"ctrl",scope:{dashboard:"="}}}),P.a.module("grafana.directives").directive("gfTimePicker",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/timepicker/timepicker.html",controller:vs,bindToController:!0,controllerAs:"ctrl",scope:{dashboard:"="}}}),P.a.module("grafana.directives").directive("inputDatetime",function(){return{restrict:"A",require:"ngModel",link:function(e,t,a,r){var n="YYYY-MM-DD HH:mm:ss";r.$parsers.push(function(t){return-1!==t.indexOf("now")?Le.isValid(t)?(r.$setValidity("error",!0),t):void r.$setValidity("error",!1):(a=e.ctrl.isUtc?Y.a.utc(t,n):Y()(t,n)).isValid()?(r.$setValidity("error",!0),a):void r.$setValidity("error",!1);var a}),r.$formatters.push(function(e){return Y.a.isMoment(e)?e.format(n):e})}}});var ys='\n<input type="file" id="dashupload" name="dashupload" class="hide"/>\n<label class="btn btn-success" for="dashupload">\n  <i class="fa fa-upload"></i>\n  上传 .json 文件\n</label>\n';function bs(e,t,a){return{restrict:"E",template:ys,scope:{onUpload:"&"},link:function(e){var a=window;a.File&&a.FileReader&&a.FileList&&a.Blob?document.getElementById("dashupload").addEventListener("change",function(t){for(var a,r=t.target.files,n=0;a=r[n];n++){var i=new FileReader;i.onload=function(t){var a;try{a=JSON.parse(t.target.result)}catch(t){return console.log(t),void e.appEvent("alert-error",["导入失败","JSON -> JS序列化失败: "+t.message])}e.$apply(function(){e.onUpload({dash:a})})},i.readAsText(a)}},!1):t.set("Oops","抱歉，此浏览器不完全支持HTML5文件API","error")}}}U.a.directive("dashUpload",bs);var Ss=function(){function e(e){this.datasourceSrv=e}return e.prototype.makeExportable=function(e){var t=this;e.cleanUpRepeats();var a=e.getSaveModelClone();a.id=null,e.processRepeats();for(var r=[],n={},i={},s=[],o={},l=0,u=a.templating.list;l<u.length;l++){var c=u[l];o[c.name]=c}for(var d=function(e){e.datasource&&0===e.datasource.indexOf("$")&&o[e.datasource.substring(1)]||s.push(t.datasourceSrv.get(e.datasource).then(function(t){if(!t.meta.builtIn){var a="DS_"+t.name.replace(" ","_").toUpperCase();i[a]={name:a,label:t.name,description:"",type:"datasource",pluginId:t.meta.id,pluginName:t.meta.name},e.datasource="${"+a+"}",n["datasource"+t.meta.id]={type:"datasource",id:t.meta.id,name:t.meta.name,version:t.meta.info.version||"1.0.0"}}}))},p=function(e){if(void 0!==e.datasource&&d(e),e.targets)for(var t=0,a=e.targets;t<a.length;t++){var r=a[t];void 0!==r.datasource&&d(r)}var i=_e.a.panels[e.type];i&&(n["panel"+i.id]={type:"panel",id:i.id,name:i.name,version:i.info.version})},h=0,m=a.panels;h<m.length;h++){var f=m[h];if(p(f),void 0!==f.collapsed&&!0===f.collapsed&&f.panels)for(var g=0,v=f.panels;g<v.length;g++){p(v[g])}}for(var y=0,b=a.templating.list;y<b.length;y++){"query"===(c=b[y]).type&&(d(c),c.options=[],c.current={},c.refresh=c.refresh>0?c.refresh:1)}for(var S=0,x=a.annotations.list;S<x.length;S++){var w=x[S];d(w)}return n.grafana={type:"grafana",id:"grafana",name:"Grafana",version:_e.a.buildInfo.version},Promise.all(s).then(function(){D.a.each(i,function(e,t){r.push(e)});for(var e=0,t=a.templating.list;e<t.length;e++){var s=t[e];if("constant"===s.type){var o="VAR_"+s.name.replace(" ","_").toUpperCase();r.push({name:o,type:"constant",label:s.label||s.name,value:s.current.value,description:""}),s.query="${"+o+"}",s.options[0]=s.current={value:s.query,text:s.query}}}var l={};return l.__inputs=r,l.__requires=D.a.sortBy(n,["id"]),D.a.defaults(l,a),l}).catch(function(e){return console.log("Export failed:",e),{error:e}})},e}(),xs=function(){function e(e,t,a,r){var n=this;this.dashboardSrv=e,this.$scope=a,this.$rootScope=r,this.exporter=new Ss(t),this.exporter.makeExportable(this.dashboardSrv.getCurrent()).then(function(e){n.$scope.$apply(function(){n.dash=e})})}return e.$inject=["dashboardSrv","datasourceSrv","$scope","$rootScope"],e.prototype.save=function(){var e=new Blob([P.a.toJson(this.dash,!0)],{type:"application/json;charset=utf-8"});Object(ut.saveAs)(e,this.dash.title+"-"+(new Date).getTime()+".json")},e.prototype.saveJson=function(){var e=this.dash,t=this.$rootScope.$new();t.object=e,t.enableCopy=!0,this.$rootScope.appEvent("show-modal",{src:"public/app/partials/edit_json.html",scope:t}),this.dismiss()},e}();U.a.directive("dashExportModal",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/export/export_modal.html",controller:xs,bindToController:!0,controllerAs:"ctrl",scope:{dismiss:"&"}}});var ws=function(){function e(){this.asRows=!0,this.dateTimeFormat="YYYY-MM-DDTHH:mm:ssZ"}return e.prototype.export=function(){"table"===this.panel?$t(this.data,this.excel):this.asRows?Ct(this.data,this.dateTimeFormat,this.excel):_t(this.data,this.dateTimeFormat,this.excel),this.dismiss()},e.prototype.dismiss=function(){oe.a.emit("hide-modal")},e}();P.a.module("grafana.directives").directive("exportDataModal",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/export_data/export_data_modal.html",controller:ws,controllerAs:"ctrl",scope:{panel:"<",data:"<"},bindToController:!0}});var ks=function(){function e(e,t,a,r,n,i){this.uiSegmentSrv=e,this.datasourceSrv=t,this.$q=a,this.variableSrv=r,this.$rootScope=i,this.removeTagFilterSegment=e.newSegment({fake:!0,value:"-- remove filter --"}),this.buildSegmentModel(),this.$rootScope.onAppEvent("template-variable-value-updated",this.buildSegmentModel.bind(this),n)}return e.$inject=["uiSegmentSrv","datasourceSrv","$q","variableSrv","$scope","$rootScope"],e.prototype.buildSegmentModel=function(){this.segments=[],this.variable.value&&D.a.isArray(this.variable.value);for(var e=0,t=this.variable.filters;e<t.length;e++){var a=t[e];this.segments.length>0&&this.segments.push(this.uiSegmentSrv.newCondition("AND")),void 0!==a.key&&void 0!==a.value&&(this.segments.push(this.uiSegmentSrv.newKey(a.key)),this.segments.push(this.uiSegmentSrv.newOperator(a.operator)),this.segments.push(this.uiSegmentSrv.newKeyValue(a.value)))}this.segments.push(this.uiSegmentSrv.newPlusButton())},e.prototype.getOptions=function(e,t){var a=this;return"operator"===e.type?this.$q.when(this.uiSegmentSrv.newOperators(["=","!=","<",">","=~","!~"])):"condition"===e.type?this.$q.when([this.uiSegmentSrv.newSegment("AND")]):this.datasourceSrv.get(this.variable.datasource).then(function(r){var n={},i=null;return"value"!==e.type?i=r.getTagKeys():(n.key=a.segments[t-2].value,i=r.getTagValues(n)),i.then(function(t){return t=D.a.map(t,function(e){return a.uiSegmentSrv.newSegment({value:e.text})}),"key"===e.type&&t.splice(0,0,P.a.copy(a.removeTagFilterSegment)),t})})},e.prototype.segmentChanged=function(e,t){this.segments[t]=e,e.value===this.removeTagFilterSegment.value?(this.segments.splice(t,3),0===this.segments.length?this.segments.push(this.uiSegmentSrv.newPlusButton()):this.segments.length>2&&(this.segments.splice(Math.max(t-1,0),1),"plus-button"!==this.segments[this.segments.length-1].type&&this.segments.push(this.uiSegmentSrv.newPlusButton()))):("plus-button"===e.type&&(t>2&&this.segments.splice(t,0,this.uiSegmentSrv.newCondition("AND")),this.segments.push(this.uiSegmentSrv.newOperator("=")),this.segments.push(this.uiSegmentSrv.newFake("select tag value","value","query-segment-value")),e.type="key",e.cssClass="query-segment-key"),t+1===this.segments.length&&this.segments.push(this.uiSegmentSrv.newPlusButton())),this.updateVariableModel()},e.prototype.updateVariableModel=function(){var e=[],t=-1,a=!1;this.segments.forEach(function(r){if("value"===r.type&&r.fake)a=!0;else switch(r.type){case"key":e.push({key:r.value}),t+=1;break;case"value":e[t].value=r.value;break;case"operator":e[t].operator=r.value;break;case"condition":e[t].condition=r.value}}),a||(this.variable.setFilters(e),this.variableSrv.variableUpdated(this.variable,!0))},e}(),Cs='\n<div class="gf-form-inline">\n  <div class="gf-form" ng-repeat="segment in ctrl.segments">\n    <metric-segment segment="segment" get-options="ctrl.getOptions(segment, $index)"\n                    on-change="ctrl.segmentChanged(segment, $index)"></metric-segment>\n  </div>\n</div>\n';U.a.directive("adHocFilters",function(){return{restrict:"E",template:Cs,controller:ks,bindToController:!0,controllerAs:"ctrl",scope:{variable:"="}}});var Ts='\n<div class="gf-form-select-wrapper max-width-18">\n  <select class="gf-form-input" ng-model="panel.repeat" ng-options="f.value as f.text for f in variables" ng-change="optionChanged()">\n  <option value=""></option>\n</div>\n';function _s(e){return{restrict:"E",template:Ts,scope:{panel:"="},link:function(t,a){a.css({display:"block",width:"100%"}),t.variables=e.variables.map(function(e){return{text:e.name,value:e.name}}),0===t.variables.length&&t.variables.unshift({text:"暂无模板变量",value:null}),t.variables.unshift({text:"Disabled",value:null}),t.panel.repeat&&!t.panel.repeatDirection&&(t.panel.repeatDirection="h"),t.optionChanged=function(){t.panel.repeat&&(t.panel.repeatDirection="h")}}}}W.d.directive("dashRepeatOption",_s);var Ms=a(52),$s=a(1086),Ps=a.n($s),Es=a(36),Ds=a.n(Es),As=function(e){function t(t){var a=e.call(this,t)||this;return a.state={collapsed:a.props.panel.collapsed},a.panelContainer=a.props.getPanelContainer(),a.dashboard=a.panelContainer.getDashboard(),a.toggle=a.toggle.bind(a),a.openSettings=a.openSettings.bind(a),a.delete=a.delete.bind(a),a.update=a.update.bind(a),a}return je.d(t,e),t.prototype.toggle=function(){this.dashboard.toggleRow(this.props.panel),this.setState(function(e){return{collapsed:!e.collapsed}})},t.prototype.update=function(){this.dashboard.processRepeats(),this.forceUpdate()},t.prototype.openSettings=function(){oe.a.emit("show-modal",{templateHtml:'<row-options row="model.row" on-updated="model.onUpdated()" dismiss="dismiss()"></row-options>',modalClass:"modal--narrow",model:{row:this.props.panel,onUpdated:this.update.bind(this)}})},t.prototype.delete=function(){var e=this;oe.a.emit("confirm-modal",{title:"删除行",text:"确定想要删除删除该行及下属所有面板?",altActionText:"只删除行",icon:"fa-trash",onConfirm:function(){e.props.getPanelContainer().getDashboard().removeRow(e.props.panel,!0)},onAltAction:function(){e.props.getPanelContainer().getDashboard().removeRow(e.props.panel,!1)}})},t.prototype.render=function(){var e=Ds()({"dashboard-row":!0,"dashboard-row--collapsed":this.state.collapsed}),t=Ds()({fa:!0,"fa-chevron-down":!this.state.collapsed,"fa-chevron-right":this.state.collapsed}),a=ce.replaceWithText(this.props.panel.title,this.props.panel.scopedVars),r=this.props.panel.panels?this.props.panel.panels.length:0,n=1===r?"panel":"panels";return nt.a.createElement("div",{className:e},nt.a.createElement("a",{className:"dashboard-row__title pointer",onClick:this.toggle},nt.a.createElement("i",{className:t}),a,nt.a.createElement("span",{className:"dashboard-row__panel_count"},"(",r," ",n,")")),!0===this.dashboard.meta.canEdit&&nt.a.createElement("div",{className:"dashboard-row__actions"},nt.a.createElement("a",{className:"pointer",onClick:this.openSettings},nt.a.createElement("i",{className:"fa fa-cog"})),nt.a.createElement("a",{className:"pointer",onClick:this.delete},nt.a.createElement("i",{className:"fa fa-trash"}))),!0===this.state.collapsed&&nt.a.createElement("div",{className:"dashboard-row__toggle-target",onClick:this.toggle}," "),nt.a.createElement("div",{className:"dashboard-row__drag grid-drag-handle"}))},t}(nt.a.Component),Fs=function(e){function t(t){var a=e.call(this,t)||this;return a.handleRef=function(e){a.container=e},a}return je.d(t,e),t.prototype.componentDidMount=function(){this.scrollbar=wn()({root:this.container.parentElement,scroller:this.container,bar:".baron__bar",barOnCls:"_scrollbar",scrollingCls:"_scrolling",track:".baron__track"})},t.prototype.componentDidUpdate=function(){this.scrollbar.update()},t.prototype.componentWillUnmount=function(){this.scrollbar.dispose()},t.prototype.setScrollTop=function(e){return!!this.container&&(this.container.scrollTop=e,this.scrollbar.update(),!0)},t.prototype.setScrollLeft=function(e){return!!this.container&&(this.container.scrollLeft=e,this.scrollbar.update(),!0)},t.prototype.update=function(){this.scrollbar.update()},t.prototype.render=function(){return nt.a.createElement("div",{className:"baron baron__root baron__clipper"},nt.a.createElement("div",{className:this.props.className+" baron__scroller",ref:this.handleRef},this.props.children),nt.a.createElement("div",{className:"baron__track"},nt.a.createElement("div",{className:"baron__bar"})))},t}(nt.a.Component),Is=a(268),Os=a.n(Is),qs=function(e){function t(t){var a=e.call(this,t)||this;return a.onAddPanel=function(e){var t=a.props.getPanelContainer().getDashboard(),r=a.props.panel.gridPos,n={type:e.id,title:"面板标题",gridPos:{x:r.x,y:r.y,w:r.w,h:r.h}};"row"===e.id&&(n.title="行标题",n.gridPos={x:0,y:0}),e.defaults&&(D.a.defaults(n,e.defaults),n.gridPos.w=e.defaults.gridPos.w,n.gridPos.h=e.defaults.gridPos.h,n.title=e.defaults.title,Ve.a.delete(Re.f)),t.addPanel(n),t.removePanel(a.props.panel)},a.handleCloseAddPanel=a.handleCloseAddPanel.bind(a),a.renderPanelItem=a.renderPanelItem.bind(a),a.panelSizeChanged=a.panelSizeChanged.bind(a),a.state={panelPlugins:a.getPanelPlugins(""),copiedPanelPlugins:a.getCopiedPanelPlugins(""),filter:"",tab:"Add"},a}return je.d(t,e),t.prototype.componentDidMount=function(){this.props.panel.events.on("panel-size-changed",this.panelSizeChanged)},t.prototype.componentWillUnmount=function(){this.props.panel.events.off("panel-size-changed",this.panelSizeChanged)},t.prototype.panelSizeChanged=function(){var e=this;setTimeout(function(){e.scrollbar.update()})},t.prototype.getPanelPlugins=function(e){var t=D.a.chain(_e.a.panels).filter({hideFromList:!1}).map(function(e){return e}).value();return t.push({id:"row",name:"Row",sort:8,info:{logos:{small:"public/img/icn-row.svg"}}}),t=this.filterPanels(t,e),D.a.sortBy(t,"sort")},t.prototype.getCopiedPanelPlugins=function(e){var t=D.a.chain(_e.a.panels).filter({hideFromList:!1}).map(function(e){return e}).value(),a=[],r=Ve.a.get(Re.f);if(r){var n=JSON.parse(r),i=D.a.find(t,{id:n.type});if(i){var s=D.a.cloneDeep(i);s.name=n.title,s.sort=-1,s.defaults=n,a.push(s)}}return a=this.filterPanels(a,e),D.a.sortBy(a,"sort")},t.prototype.handleCloseAddPanel=function(e){e.preventDefault();var t=this.props.getPanelContainer().getDashboard();t.removePanel(t.panels[0])},t.prototype.renderText=function(e){var t=this.state.filter.split("");return nt.a.createElement(Os.a,{highlightClassName:"highlight-search-match",textToHighlight:e,searchWords:t})},t.prototype.renderPanelItem=function(e,t){var a=this;return nt.a.createElement("div",{key:t,className:"add-panel__item",onClick:function(){return a.onAddPanel(e)},title:e.name},nt.a.createElement("img",{className:"add-panel__item-img",src:e.info.logos.small}),nt.a.createElement("div",{className:"add-panel__item-name"},this.renderText(e.name)))},t.prototype.noCopiedPanelPlugins=function(){return nt.a.createElement("div",{className:"add-panel__no-panels"},"No copied panels yet.")},t.prototype.filterChange=function(e){this.setState({filter:e.target.value,panelPlugins:this.getPanelPlugins(e.target.value),copiedPanelPlugins:this.getCopiedPanelPlugins(e.target.value)})},t.prototype.filterKeyPress=function(e){if("Enter"===e.key){var t=D.a.head(this.state.panelPlugins);t&&this.onAddPanel(t)}},t.prototype.filterPanels=function(e,t){var a=new RegExp(t,"i");return e.filter(function(e){return a.test(e.name)})},t.prototype.openCopy=function(){this.setState({tab:"Copy",filter:"",panelPlugins:this.getPanelPlugins(""),copiedPanelPlugins:this.getCopiedPanelPlugins("")})},t.prototype.openAdd=function(){this.setState({tab:"Add",filter:"",panelPlugins:this.getPanelPlugins(""),copiedPanelPlugins:this.getCopiedPanelPlugins("")})},t.prototype.render=function(){var e,t=this,a=Ds()({"active active--panel":"Add"===this.state.tab,"":"Copy"===this.state.tab}),r=Ds()({"":"Add"===this.state.tab,"active active--panel":"Copy"===this.state.tab});return"Add"===this.state.tab?e=this.state.panelPlugins.map(this.renderPanelItem):"Copy"===this.state.tab&&(e=this.state.copiedPanelPlugins.length>0?this.state.copiedPanelPlugins.map(this.renderPanelItem):this.noCopiedPanelPlugins()),nt.a.createElement("div",{className:"panel-container add-panel-container"},nt.a.createElement("div",{className:"add-panel"},nt.a.createElement("div",{className:"add-panel__header"},nt.a.createElement("i",{className:"gicon gicon-add-panel"}),nt.a.createElement("span",{className:"add-panel__title"},"添加面板"),nt.a.createElement("ul",{className:"gf-tabs"},nt.a.createElement("li",{className:"gf-tabs-item"},nt.a.createElement("div",{className:"gf-tabs-link pointer "+a,onClick:this.openAdd.bind(this)},"添加")),nt.a.createElement("li",{className:"gf-tabs-item"},nt.a.createElement("div",{className:"gf-tabs-link pointer "+r,onClick:this.openCopy.bind(this)},"粘贴"))),nt.a.createElement("button",{className:"add-panel__close",onClick:this.handleCloseAddPanel},nt.a.createElement("i",{className:"fa fa-close"}))),nt.a.createElement(Fs,{ref:function(e){return t.scrollbar=e},className:"add-panel__items"},nt.a.createElement("div",{className:"add-panel__searchbar"},nt.a.createElement("label",{className:"gf-form gf-form--grow gf-form--has-input-icon"},nt.a.createElement("input",{type:"text",autoFocus:!0,className:"gf-form-input gf-form--grow",placeholder:"过滤搜索面板插件",value:this.state.filter,onChange:this.filterChange.bind(this),onKeyPress:this.filterKeyPress.bind(this)}),nt.a.createElement("i",{className:"gf-form-input-icon fa fa-search"}))),e)))},t}(nt.a.Component),Rs=function(e){function t(t){var a=e.call(this,t)||this;return a.state={},a}return je.d(t,e),t.prototype.componentDidMount=function(){if(this.element){var e=this.props.getPanelContainer(),t=e.getDashboard(),a=e.getPanelLoader();this.attachedPanel=a.load(this.element,this.props.panel,t)}},t.prototype.componentWillUnmount=function(){this.attachedPanel&&this.attachedPanel.destroy()},t.prototype.render=function(){var e=this;return"row"===this.props.panel.type?nt.a.createElement(As,{panel:this.props.panel,getPanelContainer:this.props.getPanelContainer}):"add-panel"===this.props.panel.type?nt.a.createElement(qs,{panel:this.props.panel,getPanelContainer:this.props.getPanelContainer}):nt.a.createElement("div",{ref:function(t){return e.element=t},className:"panel-height-helper"})},t}(nt.a.Component),Vs=a(1085),Ns=1200;var js=a.n(Vs)()({monitorWidth:!0})(function(e){var t=e.size,a=e.layout,r=e.onLayoutChange,n=e.children,i=e.onDragStop,s=e.onResize,o=e.onResizeStop,l=e.onWidthChange,u=e.className,c=e.isResizable,d=e.isDraggable;0===t.width&&console.log("size is zero!");var p=t.width>0?t.width:Ns;return p!==Ns&&(l(),Ns=p),nt.a.createElement(Ps.a,{width:Ns,className:u,isDraggable:d,isResizable:c,measureBeforeMount:!1,containerPadding:[0,0],useCSSTransforms:!0,margin:[Re.d,Re.d],cols:Re.e,rowHeight:Re.c,draggableHandle:".grid-drag-handle",layout:a,onResize:s,onResizeStop:o,onDragStop:i,onLayoutChange:r},n)}),Us=function(e){function t(t){var a=e.call(this,t)||this;return a.panelContainer=a.props.getPanelContainer(),a.onLayoutChange=a.onLayoutChange.bind(a),a.onResize=a.onResize.bind(a),a.onResizeStop=a.onResizeStop.bind(a),a.onDragStop=a.onDragStop.bind(a),a.onWidthChange=a.onWidthChange.bind(a),a.state={animated:!1},a.dashboard=a.panelContainer.getDashboard(),a.dashboard.on("panel-added",a.triggerForceUpdate.bind(a)),a.dashboard.on("panel-removed",a.triggerForceUpdate.bind(a)),a.dashboard.on("repeats-processed",a.triggerForceUpdate.bind(a)),a.dashboard.on("view-mode-changed",a.triggerForceUpdate.bind(a)),a.dashboard.on("row-collapsed",a.triggerForceUpdate.bind(a)),a.dashboard.on("row-expanded",a.triggerForceUpdate.bind(a)),a}return je.d(t,e),t.prototype.buildLayout=function(){var e=[];this.panelMap={};for(var t=0,a=this.dashboard.panels;t<a.length;t++){var r=a[t],n=r.id.toString();if(this.panelMap[n]=r,r.gridPos){var i={i:n,x:r.gridPos.x,y:r.gridPos.y,w:r.gridPos.w,h:r.gridPos.h};"row"===r.type&&(i.w=Re.e,i.h=1,i.isResizable=!1,i.isDraggable=r.collapsed),e.push(i)}else console.log("panel without gridpos")}return e},t.prototype.onLayoutChange=function(e){for(var t=0,a=e;t<a.length;t++){var r=a[t];this.panelMap[r.i].updateGridPos(r)}this.dashboard.sortPanelsByGridPos()},t.prototype.triggerForceUpdate=function(){this.forceUpdate()},t.prototype.onWidthChange=function(){for(var e=0,t=this.dashboard.panels;e<t.length;e++){t[e].resizeDone()}},t.prototype.updateGridPos=function(e,t){this.panelMap[e.i].updateGridPos(e),this.onLayoutChange(t)},t.prototype.onResize=function(e,t,a){this.panelMap[a.i].updateGridPos(a)},t.prototype.onResizeStop=function(e,t,a){this.updateGridPos(a,e),this.panelMap[a.i].resizeDone()},t.prototype.onDragStop=function(e,t,a){this.updateGridPos(a,e)},t.prototype.componentDidMount=function(){var e=this;setTimeout(function(){e.setState(function(){return{animated:!0}})})},t.prototype.renderPanels=function(){for(var e=[],t=0,a=this.dashboard.panels;t<a.length;t++){var r=a[t],n=Ds()({panel:!0,"panel--fullscreen":r.fullscreen});e.push(nt.a.createElement("div",{key:r.id.toString(),className:n},nt.a.createElement(Rs,{panel:r,getPanelContainer:this.props.getPanelContainer})))}return e},t.prototype.render=function(){return nt.a.createElement(js,{className:Ds()({layout:!0,animated:this.state.animated}),layout:this.buildLayout(),isResizable:this.dashboard.meta.canEdit,isDraggable:this.dashboard.meta.canEdit,onLayoutChange:this.onLayoutChange,onWidthChange:this.onWidthChange,onDragStop:this.onDragStop,onResize:this.onResize,onResizeStop:this.onResizeStop},this.renderPanels())},t}(nt.a.Component);Object(Ms.a)("dashboardGrid",Us,[["getPanelContainer",{watchDepth:"reference",wrapApply:!1}]]);var Ls=function(){function e(e,t){this.$compile=e,this.$rootScope=t}return e.$inject=["$compile","$rootScope"],e.prototype.load=function(e,t,a){var r=this.$rootScope.$new();r.panel=t,r.dashboard=a;var n=this.$compile('<plugin-component type="panel" class="panel-height-helper"></plugin-component>')(r);return P.a.element(e).append(n),{destroy:function(){r.$destroy(),n.remove()}}},e}();U.a.service("panelLoader",Ls);var Bs=function(){function e(){this.source=this.row,this.row=this.row.getSaveModel()}return e.prototype.update=function(){this.source.title=this.row.title,this.source.repeat=this.row.repeat,this.onUpdated(),this.dismiss()},e}();W.d.directive("rowOptions",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/partials/row_options.html",controller:Bs,bindToController:!0,controllerAs:"ctrl",scope:{row:"=",dismiss:"&",onUpdated:"&"}}});var Qs=function(){function e(e,t,a){this.backendSrv=e,this.validationSrv=t,this.contextSrv=a,this.rootName="通用",this.isEditor=this.contextSrv.isEditor,this.labelClass||(this.labelClass="width-7"),this.loadInitialValue()}return e.$inject=["backendSrv","validationSrv","contextSrv"],e.prototype.getOptions=function(e){var t=this,a={query:e,type:"dash-folder",permission:"Edit"};return this.backendSrv.get("api/search",a).then(function(a){return!t.isEditor||""!==e&&"g"!==e.toLowerCase()&&"ge"!==e.toLowerCase()&&"gen"!==e.toLowerCase()&&"gene"!==e.toLowerCase()&&"gener"!==e.toLowerCase()&&"genera"!==e.toLowerCase()&&"general"!==e.toLowerCase()||a.unshift({title:t.rootName,id:0}),t.isEditor&&t.enableCreateNew&&""===e&&a.unshift({title:"-- 新建文件夹 --",id:-1}),t.enableReset&&""===e&&""!==t.initialTitle&&a.unshift({title:t.initialTitle,id:null}),D.a.map(a,function(e){return{text:e.title,value:e.id}})})},e.prototype.onFolderChange=function(e){if(e){if(-1===e.value)return this.createNewFolder=!0,void this.enterFolderCreation()}else e={value:0,text:this.rootName};this.onChange({$folder:{id:e.value,title:e.text}})},e.prototype.newFolderNameChanged=function(){var e=this;this.newFolderNameTouched=!0,this.validationSrv.validateNewFolderName(this.newFolderName).then(function(){e.hasValidationError=!1}).catch(function(t){e.hasValidationError=!0,e.validationError=t.message})},e.prototype.createFolder=function(e){var t=this;return e&&(e.stopPropagation(),e.preventDefault()),this.backendSrv.createFolder({title:this.newFolderName}).then(function(e){oe.a.emit("alert-success",["文件夹已创建","OK"]),t.closeCreateFolder(),t.folder={text:e.title,value:e.id},t.onFolderChange(t.folder)})},e.prototype.cancelCreateFolder=function(e){e&&(e.stopPropagation(),e.preventDefault()),this.closeCreateFolder(),this.loadInitialValue()},e.prototype.closeCreateFolder=function(){this.exitFolderCreation(),this.createNewFolder=!1,this.hasValidationError=!1,this.validationError=null,this.newFolderName="",this.newFolderNameTouched=!1},e.prototype.loadInitialValue=function(){var e=this,t={text:this.initialTitle,value:null},a={text:this.rootName,value:0};this.getOptions("").then(function(r){var n;e.initialFolderId?n=D.a.find(r,{value:e.initialFolderId}):e.enableReset&&e.initialTitle&&null===e.initialFolderId&&(n=t),n||(n=e.isEditor?a:r.length>0?r[0]:t),e.folder=n,e.folder.id!==e.initialFolderId&&e.onChange({$folder:{id:e.folder.value,title:e.folder.text}})})},e}();U.a.directive("folderPicker",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/folder_picker/folder_picker.html",controller:Qs,bindToController:!0,controllerAs:"ctrl",scope:{initialTitle:"<",initialFolderId:"<",labelClass:"@",rootName:"@",onChange:"&",onCreateFolder:"&",enterFolderCreation:"&",exitFolderCreation:"&",enableCreateNew:"@",enableReset:"@"}}});var zs=function(){function e(e){this.backendSrv=e,this.isValidFolderSelection=!0}return e.$inject=["backendSrv"],e.prototype.onFolderChange=function(e){this.folder=e},e.prototype.save=function(){var e=this;return this.backendSrv.moveDashboards(this.dashboards,this.folder).then(function(t){if(t.successCount>0){var a=(1===t.successCount?"":"s")+" 个仪表盘已移动",r=t.successCount+" 个仪表盘 "+(1===t.successCount?"":"s")+" 移动到 "+e.folder.title;oe.a.emit("alert-success",[a,r])}return t.totalCount===t.alreadyInFolderCount&&oe.a.emit("alert-error",["错误","该仪表盘已存在文件夹 "+e.folder.title+" 中"]),e.dismiss(),e.afterSave()})},e.prototype.onEnterFolderCreation=function(){this.isValidFolderSelection=!1},e.prototype.onExitFolderCreation=function(){this.isValidFolderSelection=!0},e}();U.a.directive("moveToFolderModal",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/move_to_folder_modal/move_to_folder.html",controller:zs,bindToController:!0,controllerAs:"ctrl",scope:{dismiss:"&",dashboards:"=",afterSave:"&"}}});var Hs=function(){function e(e,t,a,r,n,i){var s=this;this.$scope=e,this.$route=t,this.$location=a,this.$rootScope=r,this.backendSrv=n,this.dashboardSrv=i,e.dashboard=this.dashboard,this.$scope.$on("$destroy",function(){s.dashboard.updateSubmenuVisibility(),s.$rootScope.$broadcast("refresh"),setTimeout(function(){s.$rootScope.appEvent("dash-scroll",{restore:!0})})}),this.canSaveAs=this.dashboard.meta.canEdit&&W.c.hasEditPermissionInFolders,this.canSave=this.dashboard.meta.canSave,this.canDelete=this.dashboard.meta.canSave,this.buildSectionList(),this.onRouteUpdated(),this.$rootScope.onAppEvent("$routeUpdate",this.onRouteUpdated.bind(this),e),this.$rootScope.appEvent("dash-scroll",{animate:!1,pos:0}),this.$rootScope.onAppEvent("dashboard-saved",this.onPostSave.bind(this),e)}return e.$inject=["$scope","$route","$location","$rootScope","backendSrv","dashboardSrv"],e.prototype.buildSectionList=function(){this.sections=[],this.dashboard.meta.canEdit&&(this.sections.push({title:"通用",id:"settings",icon:"gicon gicon-preferences"}),this.sections.push({title:"注释",id:"annotations",icon:"gicon gicon-annotation"}),this.sections.push({title:"变量",id:"templating",icon:"gicon gicon-variable"}),this.sections.push({title:"链接",id:"links",icon:"gicon gicon-link"})),this.dashboard.id&&this.dashboard.meta.canSave&&this.sections.push({title:"版本",id:"versions",icon:"fa fa-fw fa-history"}),this.dashboard.id&&this.dashboard.meta.canAdmin&&this.sections.push({title:"权限",id:"permissions",icon:"fa fa-fw fa-lock"}),this.dashboard.meta.canMakeEditable&&this.sections.push({title:"通用",icon:"gicon gicon-preferences",id:"make_editable"}),this.sections.push({title:"JSON 模型",id:"dashboard_json",icon:"gicon gicon-json"});for(var e=this.$location.search(),t=this.$location.path(),a=0,r=this.sections;a<r.length;a++){var n=r[a],i=D.a.defaults({editview:n.id},e);n.url=_e.a.appSubUrl+t+"?"+j.a.param(i)}},e.prototype.onRouteUpdated=function(){this.viewId=this.$location.search().editview,this.viewId&&(this.json=P.a.toJson(this.dashboard.getSaveModelClone(),!0)),"settings"===this.viewId&&this.dashboard.meta.canMakeEditable&&(this.viewId="make_editable"),D.a.find(this.sections,{id:this.viewId})||(this.sections.unshift({title:"暂无",id:"404",icon:"fa fa-fw fa-warning"}),this.viewId="404")},e.prototype.openSaveAsModal=function(){this.dashboardSrv.showSaveAsModal()},e.prototype.saveDashboard=function(){this.dashboardSrv.saveDashboard()},e.prototype.saveDashboardJson=function(){var e=this;this.dashboardSrv.saveJSONDashboard(this.json).then(function(){e.$route.reload()})},e.prototype.onPostSave=function(){this.hasUnsavedFolderChange=!1},e.prototype.hideSettings=function(){var e=this,t=this.$location.search();delete t.editview,setTimeout(function(){e.$rootScope.$apply(function(){e.$location.search(t)})})},e.prototype.makeEditable=function(){this.dashboard.editable=!0,this.dashboard.meta.canMakeEditable=!1,this.dashboard.meta.canEdit=!0,this.dashboard.meta.canSave=!0,this.canDelete=!0,this.viewId="settings",this.buildSectionList();var e=D.a.find(this.sections,{id:this.viewId});this.$location.url(e.url)},e.prototype.deleteDashboard=function(){var e=this,t="",a=this.dashboard.title,r=D.a.sumBy(this.dashboard.panels,function(e){return e.alert?1:0});r>0&&(t="删除",a="此仪表盘包含 "+r+" 报警。 删除此仪表板也会删除这些报警"),W.b.emit("confirm-modal",{title:"删除",text:"希望删除此仪表盘?",text2:a,icon:"fa-trash",confirmText:t,yesText:"删除",onConfirm:function(){e.dashboard.meta.canSave=!1,e.deleteDashboardConfirmed()}})},e.prototype.deleteDashboardConfirmed=function(){var e=this;this.backendSrv.deleteDashboard(this.dashboard.uid).then(function(){W.b.emit("alert-success",["仪表盘已删除",e.dashboard.title+" 已删除"]),e.$location.url("/")})},e.prototype.onFolderChange=function(e){this.dashboard.meta.folderId=e.id,this.dashboard.meta.folderTitle=e.title,this.hasUnsavedFolderChange=!0},e.prototype.getFolder=function(){return{id:this.dashboard.meta.folderId,title:this.dashboard.meta.folderTitle,url:this.dashboard.meta.folderUrl}},e}();W.d.directive("dashboardSettings",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/settings/settings.html",controller:Hs,bindToController:!0,controllerAs:"ctrl",transclude:!0,scope:{dashboard:"="}}});var Ys=function(){function e(e){this.navModel=e.getNav("dashboards","manage-dashboards",0)}return e.$inject=["navModelSrv"],e}(),Ws=function(){function e(e){this.backendSrv=e}return e.prototype.load=function(e,t,a){return e.navModel={main:{icon:"fa fa-folder-open",id:"manage-folder",subTitle:"管理文件夹仪表盘与权限",url:"",text:"",breadcrumbs:[{title:"仪表盘",url:"dashboards"}],children:[{active:"manage-folder-dashboards"===a,icon:"fa fa-fw fa-th-large",id:"manage-folder-dashboards",text:"仪表盘",url:"dashboards"},{active:"manage-folder-permissions"===a,icon:"fa fa-fw fa-lock",id:"manage-folder-permissions",text:"权限",url:"dashboards/permissions"},{active:"manage-folder-settings"===a,icon:"fa fa-fw fa-cog",id:"manage-folder-settings",text:"设置",url:"dashboards/settings"}]}},this.backendSrv.getFolderByUid(t).then(function(t){e.folderId=t.id;var a=t.title,r=t.url;e.navModel.main.text=a;var n=e.navModel.main.children.find(function(e){return"manage-folder-dashboards"===e.id});(n.url=r,t.canAdmin)?(e.navModel.main.children.find(function(e){return"manage-folder-permissions"===e.id}).url=r+"/permissions",e.navModel.main.children.find(function(e){return"manage-folder-settings"===e.id}).url=r+"/settings"):e.navModel.main.children=[n];return t})},e}(),Gs=function(){function e(e,t,a,r){(this.backendSrv=e,this.$routeParams=a,this.$routeParams.uid)&&(this.uid=a.uid,new Ws(this.backendSrv).load(this,this.uid,"manage-folder-dashboards").then(function(e){var t=Be.b.stripBaseFromUrl(e.url);t!==r.path()&&r.path(t).replace()}))}return e.$inject=["backendSrv","navModelSrv","$routeParams","$location"],e}(),Ks=function(){function e(e,t,a,r){var n=this;this.backendSrv=e,this.$routeParams=a,this.$location=r,this.canSave=!1,this.$routeParams.uid&&(this.uid=a.uid,this.folderPageLoader=new Ws(this.backendSrv),this.folderPageLoader.load(this,this.uid,"manage-folder-settings").then(function(e){r.path()!==e.meta.url&&r.path(e.meta.url+"/settings").replace(),n.folder=e,n.canSave=n.folder.canSave,n.title=n.folder.title}))}return e.$inject=["backendSrv","navModelSrv","$routeParams","$location"],e.prototype.save=function(){var e=this;if(this.titleChanged(),this.hasChanged)return this.folder.title=this.title.trim(),this.backendSrv.updateFolder(this.folder).then(function(t){t.url!==e.$location.path()&&e.$location.url(t.url+"/settings"),oe.a.emit("dashboard-saved"),oe.a.emit("alert-success",["文件夹已保存"])}).catch(this.handleSaveFolderError)},e.prototype.titleChanged=function(){this.hasChanged=this.folder.title.toLowerCase()!==this.title.trim().toLowerCase()},e.prototype.delete=function(e){var t=this;e&&(e.stopPropagation(),e.preventDefault()),oe.a.emit("confirm-modal",{title:"删除",text:"要删除此文件夹及其所有仪表盘吗?",icon:"fa-trash",yesText:"删除",onConfirm:function(){return t.backendSrv.deleteFolder(t.uid).then(function(){oe.a.emit("alert-success",["文件夹已删除",t.folder.title+" 已被删除"]),t.$location.url("dashboards")})}})},e.prototype.handleSaveFolderError=function(e){var t=this;e.data&&"version-mismatch"===e.data.status&&(e.isHandled=!0,oe.a.emit("confirm-modal",{title:"冲突",text:"其他人已更新此文件夹。",text2:"你还想保存这个文件夹吗?",yesText:"保存 & 覆盖",icon:"fa-warning",onConfirm:function(){t.backendSrv.updateFolder(t.folder,{overwrite:!0})}}))},e}(),Js=function(){function e(e,t,a,r,n){this.backendSrv=e,this.validationSrv=t,this.$location=r,this.navModel=a.getNav("create","import"),this.step=1,this.nameExists=!1,this.uidExists=!1,this.autoGenerateUid=!0,this.autoGenerateUidValue="auto-generated",this.folderId=n.folderId?Number(n.folderId)||0:null,this.initialFolderTitle="选择一个文件夹",n.gnetId&&(this.gnetUrl=n.gnetId,this.checkGnetDashboard())}return e.$inject=["backendSrv","validationSrv","navModelSrv","$location","$routeParams"],e.prototype.onUpload=function(e){if(this.dash=e,this.dash.id=null,this.step=2,this.inputs=[],this.dash.__inputs)for(var t=0,a=this.dash.__inputs;t<a.length;t++){var r=a[t],n={name:r.name,label:r.label,info:r.description,value:r.value,type:r.type,pluginId:r.pluginId,options:[]};"datasource"===r.type?this.setDatasourceOptions(r,n):n.info||(n.info="指定字符串常量"),this.inputs.push(n)}this.inputsValid=0===this.inputs.length,this.titleChanged(),this.uidChanged(!0)},e.prototype.setDatasourceOptions=function(e,t){var a=D.a.filter(_e.a.datasources,function(t){return t.type===e.pluginId});0===a.length?t.info="没有找到 "+e.pluginName+" 类型的数据源":t.info||(t.info="选择一个 "+e.pluginName+" 数据源"),t.options=a.map(function(e){return{text:e.name,value:e.name}})},e.prototype.inputValueChanged=function(){this.inputsValid=!0;for(var e=0,t=this.inputs;e<t.length;e++){t[e].value||(this.inputsValid=!1)}},e.prototype.titleChanged=function(){var e=this;this.titleTouched=!0,this.nameExists=!1,this.validationSrv.validateNewDashboardName(this.folderId,this.dash.title).then(function(){e.nameExists=!1,e.hasNameValidationError=!1}).catch(function(t){"EXISTING"===t.type&&(e.nameExists=!0),e.hasNameValidationError=!0,e.nameValidationError=t.message})},e.prototype.uidChanged=function(e){var t=this;this.uidExists=!1,this.hasUidValidationError=!1,!0===e&&this.dash.uid&&(this.autoGenerateUidValue="value set"),this.backendSrv.getDashboardByUid(this.dash.uid).then(function(e){t.uidExists=!0,t.hasUidValidationError=!0,t.uidValidationError="名为 '"+e.dashboard.title+"' 的仪表盘在文件夹 '"+e.meta.folderTitle+"' 中存在相同的 uid"}).catch(function(e){e.isHandled=!0})},e.prototype.onFolderChange=function(e){this.folderId=e.id,this.titleChanged()},e.prototype.onEnterFolderCreation=function(){this.inputsValid=!1},e.prototype.onExitFolderCreation=function(){this.inputValueChanged()},e.prototype.isValid=function(){return this.inputsValid&&null!==this.folderId},e.prototype.saveDashboard=function(){var e=this,t=this.inputs.map(function(e){return{name:e.name,type:e.type,pluginId:e.pluginId,value:e.value}});return this.backendSrv.post("api/dashboards/import",{dashboard:this.dash,overwrite:!0,inputs:t,folderId:this.folderId}).then(function(t){e.$location.url(t.importedUrl)})},e.prototype.loadJsonText=function(){try{this.parseError="";var e=JSON.parse(this.jsonText);this.onUpload(e)}catch(e){return console.log(e),void(this.parseError=e.message)}},e.prototype.checkGnetDashboard=function(){var e=this;this.gnetError="";var t,a=/(^\d+$)|dashboards\/(\d+)/.exec(this.gnetUrl);return a&&a[1]?t=a[1]:a&&a[2]?t=a[2]:this.gnetError="Could not find dashboard",this.backendSrv.get("api/gnet/dashboards/"+t).then(function(t){e.gnetInfo=t,t.json.gnetId=t.id,e.onUpload(t.json)}).catch(function(t){t.isHandled=!0,e.gnetError=t.data.message||t})},e.prototype.back=function(){this.gnetUrl="",this.step=1,this.gnetError="",this.gnetInfo=""},e}(),Xs=function(){function e(e,t,a,r){this.backendSrv=e,this.$location=t,this.validationSrv=a,this.title="",this.titleTouched=!1,this.navModel=r.getNav("dashboards","manage-dashboards",0)}return e.$inject=["backendSrv","$location","validationSrv","navModelSrv"],e.prototype.create=function(){var e=this;if(!this.hasValidationError)return this.backendSrv.createFolder({title:this.title}).then(function(t){oe.a.emit("alert-success",["文件夹已创建","完成"]),e.$location.url(Be.b.stripBaseFromUrl(t.url))})},e.prototype.titleChanged=function(){var e=this;this.titleTouched=!0,this.validationSrv.validateNewFolderName(this.title).then(function(){e.hasValidationError=!1}).catch(function(t){e.hasValidationError=!0,e.validationError=t.message})},e}();U.a.controller("DashboardListCtrl",Ys),U.a.controller("FolderDashboardsCtrl",Gs),U.a.controller("FolderSettingsCtrl",Ks),U.a.controller("DashboardImportCtrl",Js),U.a.controller("CreateFolderCtrl",Xs);var Zs=function(){function e(e,t,a){var r=this;this.$scope=e,this.backendSrv=t,this.navModel=a.getNav("dashboards","playlists",0),t.get("/api/playlists").then(function(e){r.playlists=e})}return e.$inject=["$scope","backendSrv","navModelSrv"],e.prototype.removePlaylistConfirmed=function(e){var t=this;D.a.remove(this.playlists,{id:e.id}),this.backendSrv.delete("/api/playlists/"+e.id).then(function(){t.$scope.appEvent("alert-success",["播放列表已删除",""])},function(){t.$scope.appEvent("alert-error",["无法删除播放列表",""]),t.playlists.push(e)})},e.prototype.removePlaylist=function(e){var t=this;this.$scope.appEvent("confirm-modal",{title:"删除",text:"确定想要删除播放列表 "+e.name+"?",yesText:"删除",icon:"fa-trash",onConfirm:function(){t.removePlaylistConfirmed(e)}})},e}();U.a.controller("PlaylistsCtrl",Zs);var eo=function(){function e(e,t){var a=this;this.backendSrv=t,this.query={query:"",tag:[],starred:!1,limit:30},e(function(){a.query.query="",a.query.type="dash-db",a.searchDashboards()},100)}return e.$inject=["$timeout","backendSrv"],e.prototype.searchDashboards=function(){this.tagsMode=!1;var e={};e.promise=this.backendSrv.search(this.query).then(function(e){return{dashboardResult:e,tagResult:[]}}),this.searchStarted(e)},e.prototype.showStarred=function(){this.query.starred=!this.query.starred,this.searchDashboards()},e.prototype.queryHasNoFilters=function(){return""===this.query.query&&!1===this.query.starred&&0===this.query.tag.length},e.prototype.filterByTag=function(e,t){this.query.tag.push(e),this.searchDashboards(),t&&(t.stopPropagation(),t.preventDefault())},e.prototype.getTags=function(){var e={};e.promise=this.backendSrv.get("/api/dashboards/tags").then(function(e){return{dashboardResult:[],tagResult:e}}),this.searchStarted(e)},e}();U.a.directive("playlistSearch",function(){return{restrict:"E",templateUrl:"public/app/features/playlist/partials/playlist_search.html",controller:eo,bindToController:!0,controllerAs:"ctrl",scope:{searchStarted:"&"}}});var to=function(){function e(e,t,a,r){this.$location=e,this.$timeout=t,this.backendSrv=a,this.$routeParams=r}return e.$inject=["$location","$timeout","backendSrv","$routeParams"],e.prototype.next=function(){var e=this;if(this.$timeout.cancel(this.cancelPromise),this.index>this.dashboards.length-1)window.location.href=this.getUrlWithKioskMode();else{var t=this.dashboards[this.index];this.$location.url("dashboard/"+t.uri),this.index++,this.cancelPromise=this.$timeout(function(){return e.next()},this.interval)}},e.prototype.getUrlWithKioskMode=function(){var e=document.body.classList.contains("page-kiosk-mode");return e&&-1===this.startUrl.indexOf("kiosk")?this.startUrl+"?kiosk=true":e?this.startUrl:this.startUrl.split("?")[0]},e.prototype.prev=function(){this.index=Math.max(this.index-2,0),this.next()},e.prototype.start=function(e){var t=this;this.stop(),this.startUrl=window.location.href,this.index=0,this.isPlaying=!0,this.$routeParams.kiosk&&oe.a.emit("toggle-kiosk-mode"),this.backendSrv.get("/api/playlists/"+e).then(function(a){t.backendSrv.get("/api/playlists/"+e+"/dashboards").then(function(e){t.dashboards=e,t.interval=A.a.interval_to_ms(a.interval),t.next()})})},e.prototype.stop=function(){this.index=0,this.isPlaying=!1,this.cancelPromise&&this.$timeout.cancel(this.cancelPromise)},e}();U.a.service("playlistSrv",to);var ao=function(){function e(e,t,a,r,n){var i=this;if(this.$scope=e,this.backendSrv=t,this.$location=a,this.filteredDashboards=[],this.filteredTags=[],this.searchQuery="",this.loading=!1,this.playlist={interval:"5m"},this.playlistItems=[],this.dashboardresult=[],this.tagresult=[],this.navModel=n.getNav("dashboards","playlists",0),this.isNew=r.current.params.id,r.current.params.id){var s=r.current.params.id;t.get("/api/playlists/"+s).then(function(e){i.playlist=e,i.navModel.node={text:e.name,icon:i.navModel.node.icon},i.navModel.breadcrumbs.push(i.navModel.node)}),t.get("/api/playlists/"+s+"/items").then(function(e){i.playlistItems=e})}else this.navModel.node={text:"New playlist",icon:this.navModel.node.icon},this.navModel.breadcrumbs.push(this.navModel.node)}return e.$inject=["$scope","backendSrv","$location","$route","navModelSrv"],e.prototype.filterFoundPlaylistItems=function(){var e=this;this.filteredDashboards=D.a.reject(this.dashboardresult,function(t){return D.a.find(e.playlistItems,function(e){return parseInt(e.value)===t.id})}),this.filteredTags=D.a.reject(this.tagresult,function(t){return D.a.find(e.playlistItems,function(e){return e.value===t.term})})},e.prototype.addPlaylistItem=function(e){e.value=e.id.toString(),e.type="dashboard_by_id",e.order=this.playlistItems.length+1,this.playlistItems.push(e),this.filterFoundPlaylistItems()},e.prototype.addTagPlaylistItem=function(e){var t={value:e.term,type:"dashboard_by_tag",order:this.playlistItems.length+1,title:e.term};this.playlistItems.push(t),this.filterFoundPlaylistItems()},e.prototype.removePlaylistItem=function(e){D.a.remove(this.playlistItems,function(t){return e===t}),this.filterFoundPlaylistItems()},e.prototype.savePlaylist=function(e,t){var a=this;e.items=t,(e.id?this.backendSrv.put("/api/playlists/"+e.id,e):this.backendSrv.post("/api/playlists",e)).then(function(){a.$scope.appEvent("alert-success",["播放列表已保存",""]),a.$location.path("/playlists")},function(){a.$scope.appEvent("alert-error",["无法保存播放列表",""])})},e.prototype.isPlaylistEmpty=function(){return!this.playlistItems.length},e.prototype.backToList=function(){this.$location.path("/playlists")},e.prototype.searchStarted=function(e){var t=this;e.then(function(e){t.dashboardresult=e.dashboardResult,t.tagresult=e.tagResult,t.filterFoundPlaylistItems()})},e.prototype.movePlaylistItem=function(e,t){var a=this.playlistItems.indexOf(e),r=a+t;r>=0&&r<this.playlistItems.length&&(this.playlistItems.splice(a,1),this.playlistItems.splice(r,0,e))},e.prototype.movePlaylistItemUp=function(e){this.movePlaylistItem(e,-1)},e.prototype.movePlaylistItemDown=function(e){this.movePlaylistItem(e,1)},e}();function ro(e){e.when("/playlists",{templateUrl:"public/app/features/playlist/partials/playlists.html",controllerAs:"ctrl",controller:"PlaylistsCtrl"}).when("/playlists/create",{templateUrl:"public/app/features/playlist/partials/playlist.html",controllerAs:"ctrl",controller:"PlaylistEditCtrl"}).when("/playlists/edit/:id",{templateUrl:"public/app/features/playlist/partials/playlist.html",controllerAs:"ctrl",controller:"PlaylistEditCtrl"}).when("/playlists/play/:id",{templateUrl:"public/app/features/playlist/partials/playlists.html",controllerAs:"ctrl",controller:"PlaylistsCtrl",resolve:{init:["playlistSrv","$route",function(e,t){var a=t.current.params.id;e.start(a)}]}})}U.a.controller("PlaylistEditCtrl",ao),P.a.module("grafana.routes").config(ro);var no=function(){function e(e,t,a){var r=this;this.$rootScope=e,this.backendSrv=t,this.navModel=a.getNav("dashboards","snapshots",0),this.backendSrv.get("/api/dashboard/snapshots").then(function(e){r.snapshots=e})}return e.$inject=["$rootScope","backendSrv","navModelSrv"],e.prototype.removeSnapshotConfirmed=function(e){var t=this;D.a.remove(this.snapshots,{key:e.key}),this.backendSrv.delete("/api/snapshots/"+e.key).then(function(){},function(){t.snapshots.push(e)})},e.prototype.removeSnapshot=function(e){var t=this;this.$rootScope.appEvent("confirm-modal",{title:"删除",text:"确定要删除快照： "+e.name+"?",yesText:"删除",icon:"fa-trash",onConfirm:function(){t.removeSnapshotConfirmed(e)}})},e}();P.a.module("grafana.controllers").controller("SnapshotsCtrl",no);var io='\n<span class="panel-title">\n  <span class="icon-gf panel-alert-icon"></span>\n  <span class="panel-title-text">{{ctrl.panel.title | interpolateTemplateVars:this}}</span>\n  <span class="panel-menu-container dropdown">\n    <span class="fa fa-caret-down panel-menu-toggle" data-toggle="dropdown"></span>\n    <ul class="dropdown-menu dropdown-menu--menu panel-menu" role="menu">\n      <li>\n        <a ng-click="ctrl.addDataQuery(datasource);">\n          <i class="fa fa-cog"></i> 编辑 <span class="dropdown-menu-item-shortcut">e</span>\n        </a>\n      </li>\n      <li class="dropdown-submenu">\n        <a ng-click="ctrl.addDataQuery(datasource);"><i class="fa fa-cube"></i> Actions</a>\n        <ul class="dropdown-menu panel-menu">\n          <li><a ng-click="ctrl.addDataQuery(datasource);"><i class="fa fa-flash"></i> 添加注释</a></li>\n          <li><a ng-click="ctrl.addDataQuery(datasource);"><i class="fa fa-bullseye"></i> 切换图例</a></li>\n          <li><a ng-click="ctrl.addDataQuery(datasource);"><i class="fa fa-download"></i> 导出CSV</a></li>\n          <li><a ng-click="ctrl.addDataQuery(datasource);"><i class="fa fa-eye"></i> 查看JSON</a></li>\n        </ul>\n      </li>\n      <li><a ng-click="ctrl.addDataQuery(datasource);"><i class="fa fa-trash"></i> 移除</a></li>\n    </ul>\n  </span>\n  <span class="panel-time-info" ng-if="ctrl.timeInfo"><i class="fa fa-clock-o"></i> {{ctrl.timeInfo}}</span>\n</span>';function so(e,t){var a="",r="";if(e.divider)return'<li class="divider"></li>';if(e.submenu&&(r="dropdown-submenu"),a+='<li class="'+r+'"><a ',e.click&&(a+=' ng-click="'+e.click+'"'),e.href&&(a+=' href="'+e.href+'"'),a+='><i class="'+e.icon+'"></i>',a+='<span class="dropdown-item-text">'+e.text+"</span>",e.shortcut&&(a+='<span class="dropdown-menu-item-shortcut">'+e.shortcut+"</span>"),a+="</a>",e.submenu){a+='<ul class="dropdown-menu dropdown-menu--menu panel-menu">';for(var n=0,i=e.submenu;n<i.length;n++){a+=so(i[n],t)}a+="</ul>"}return a+="</li>"}function oo(e){return{restrict:"E",template:io,link:function(t,a,r){var n,i,s,o,l=a.find(".panel-menu");function u(){var e=a.find("[data-toggle=dropdown]").parentsUntil(".panel").parent(),t=a.find("[data-toggle=dropdown]").parent();if(e=e&&e.length?e[0]:void 0){e=j()(e),j()(".react-grid-item.panel").removeClass("dropdown-menu-open");var r=!t.hasClass("open");e.toggleClass("dropdown-menu-open",r)}}a.click(function(r){var s=r.target.className;n&&n.$destroy(),n=t.$new();var o=function(e){for(var t="",a=0,r=e.getMenu();a<r.length;a++)t+=so(r[a],e);return t}(t.ctrl);l.html(o),e(l)(n),(s.indexOf("panel-title-text")>=0||s.indexOf("panel-title")>=0)&&function(e){i||(e.stopPropagation(),u(),a.find("[data-toggle=dropdown]").dropdown("toggle"))}(r)}),a.find(".panel-menu-toggle").click(function(){u()}),a.mousedown(function(e){s=e.pageX,o=e.pageY}),a.mouseup(function(e){i=s!==e.pageX||o!==e.pageY})}}}W.d.directive("panelHeader",oo);var lo=P.a.module("grafana.directives");lo.directive("grafanaPanel",["$rootScope","$document","$timeout",function(e,t,a){return{restrict:"E",template:'\n  <div class="panel-container">\n    <div class="panel-header" ng-class="{\'grid-drag-handle\': !ctrl.fullscreen}">\n      <span class="panel-info-corner">\n        <i class="fa"></i>\n        <span class="panel-info-corner-inner"></span>\n      </span>\n\n      <span class="panel-loading" ng-show="ctrl.loading">\n        <i class="fa fa-spinner fa-spin"></i>\n      </span>\n\n      <panel-header class="panel-title-container" panel-ctrl="ctrl"></panel-header>\n    </div>\n\n    <div class="panel-content">\n      <ng-transclude class="panel-height-helper"></ng-transclude>\n    </div>\n  </div>\n\n  <div class="panel-full-edit" ng-if="ctrl.editMode">\n    <div class="tabbed-view tabbed-view--panel-edit">\n      <div class="tabbed-view-header">\n        <h3 class="tabbed-view-panel-title">\n          {{ctrl.pluginName}}\n        </h3>\n\n        <ul class="gf-tabs">\n          <li class="gf-tabs-item" ng-repeat="tab in ::ctrl.editorTabs">\n            <a class="gf-tabs-link" ng-click="ctrl.changeTab($index)" ng-class="{active: ctrl.editorTabIndex === $index}">\n              {{::tab.title}}\n            </a>\n          </li>\n        </ul>\n\n        <button class="tabbed-view-close-btn" ng-click="ctrl.exitFullscreen();">\n          <i class="fa fa-remove"></i>\n        </button>\n      </div>\n\n      <div class="tabbed-view-body">\n        <div ng-repeat="tab in ctrl.editorTabs" ng-if="ctrl.editorTabIndex === $index">\n          <panel-editor-tab editor-tab="tab" ctrl="ctrl" index="$index"></panel-editor-tab>\n        </div>\n      </div>\n    </div>\n  </div>\n',transclude:!0,scope:{ctrl:"="},link:function(e,t){var r,n,i,s,o=t.find(".panel-container"),l=t.find(".panel-content"),u=t.find(".panel-info-corner"),c=e.ctrl,d=!1,p=!1;function h(){l.css({height:c.height+"px"})}function m(){var e=c.getInfoMode();u[0].className="panel-info-corner panel-info-corner--"+e,e&&(r&&r.destroy(),r=new Yt.a({target:u[0],content:function(){return c.getInfoContent({mode:"tooltip"})},classes:c.error?"drop-error":"drop-help",openOn:"hover",hoverOpenDelay:100,tetherOptions:{attachment:"bottom left",targetAttachment:"top left",constraints:[{to:"window",attachment:"together",pin:!0}]}}))}c.panel.transparent&&(d=!0,o.addClass("panel-transparent",!0)),c.events.on("component-did-mount",function(){if(c.__proto__.constructor.scrollable){var e=l,t=l.find(":first").find(":first");e.addClass("baron baron__root baron__clipper panel-content--scrollable"),j()('\n            <div class="baron__track">\n              <div class="baron__bar"></div>\n            </div>\n          ').appendTo(e),t.addClass("baron__scroller"),(n=wn()({root:e[0],scroller:t[0],bar:".baron__bar",barOnCls:"_scrollbar",scrollingCls:"_scrolling"})).scroll()}}),c.events.on("panel-size-changed",function(){c.calculatePanelHeight(),h(),a(function(){n&&n.update(),c.render()})}),c.calculatePanelHeight(),h(),c.events.on("render",function(){d!==c.panel.transparent&&(o.toggleClass("panel-transparent",!0===c.panel.transparent),d=c.panel.transparent),s=void 0!==c.panel.alert,p!==s&&(o.toggleClass("panel-has-alert",s),p=s),c.alertState?(i&&o.removeClass("panel-alert-state--"+i),"ok"!==c.alertState.state&&"alerting"!==c.alertState.state||o.addClass("panel-alert-state--"+c.alertState.state),i=c.alertState.state):i&&(o.removeClass("panel-alert-state--"+i),i=null)}),e.$watchGroup(["ctrl.error","ctrl.panel.description"],m),e.$watchCollection("ctrl.panel.links",m),u.on("click",function(){r.close(),e.$apply(c.openInspector.bind(c))}),t.on("mouseenter",function(){o.toggleClass("panel-hover-highlight",!0),c.dashboard.setPanelFocus(c.panel.id)}),t.on("mouseleave",function(){o.toggleClass("panel-hover-highlight",!1),c.dashboard.setPanelFocus(0)}),e.$on("$destroy",function(){t.off(),u.off(),r&&r.destroy(),n&&n.dispose()})}}}]),lo.directive("panelHelpCorner",["$rootScope",function(e){return{restrict:"E",template:'\n    <span class="alert-error panel-error small pointer" ng-if="ctrl.error" ng-click="ctrl.openInspector()">\n    <span data-placement="top" bs-tooltip="ctrl.error">\n    <i class="fa fa-exclamation"></i><span class="panel-error-arrow"></span>\n    </span>\n    </span>\n    ',link:function(e,t){}}}]);var uo=function(){function e(e,t,a,r,n,i){var s;e.init=function(){n.sidemenu=!1,oe.a.emit("toggle-sidemenu-hidden");var o=a.search();s=parseInt(o.panelId),e.onAppEvent("dashboard-initialized",e.initPanelScope),"script"===t.type||"snapshot"===t.type||t.uid?r.loadDashboard(t.type,t.slug,t.uid).then(function(t){t.meta.soloMode=!0,e.initDashboard(t,e)}):i.getDashboardBySlug(t.slug).then(function(e){if(e){var t=Be.b.stripBaseFromUrl(e.meta.url.replace("/d/","/d-solo/"));a.path(t).replace()}})},e.initPanelScope=function(){var t=e.dashboard.getPanelInfoById(s);e.ctrl={dashboard:e.dashboard},e.panel=t.panel,e.panel.soloMode=!0,e.$index=0,e.panel||e.appEvent("alert-error",["未找到面板",""])},e.init()}return e.$inject=["$scope","$routeParams","$location","dashboardLoaderSrv","contextSrv","backendSrv"],e}();function co(e){return e.create({scope:{ctrl:"=",editorTab:"=",index:"="},directive:function(e){var t=e.ctrl.pluginId,a=e.index;return Promise.resolve({name:"panel-editor-tab-"+t+a,fn:function(){return e.editorTab.directiveFn()}})}})}P.a.module("grafana.routes").controller("SoloPanelCtrl",uo),P.a.module("grafana.directives").directive("panelEditorTab",co);var po=P.a.module("grafana.directives"),ho=function(){function e(){this.panelCtrl=this.queryCtrl.panelCtrl,this.target=this.queryCtrl.target,this.panel=this.panelCtrl.panel,this.target.refId||(this.target.refId=this.panelCtrl.dashboard.getNextQueryLetter(this.panel)),this.toggleCollapse(!0),this.target.isNew&&(delete this.target.isNew,this.toggleCollapse(!1)),this.panel.targets.length<4&&(this.collapsed=!1)}return e.prototype.toggleHideQuery=function(){this.target.hide=!this.target.hide,this.panelCtrl.refresh()},e.prototype.toggleCollapse=function(e){if(this.canCollapse){this.panelCtrl.__collapsedQueryCache||(this.panelCtrl.__collapsedQueryCache={}),e?this.collapsed=!1!==this.panelCtrl.__collapsedQueryCache[this.target.refId]:(this.collapsed=!this.collapsed,this.panelCtrl.__collapsedQueryCache[this.target.refId]=this.collapsed);try{this.collapsedText=this.queryCtrl.getCollapsedText()}catch(e){var t=e.message||e.toString();this.collapsedText="Error: "+t}}},e.prototype.toggleEditorMode=function(){this.canCollapse&&this.collapsed&&(this.collapsed=!1),this.queryCtrl.toggleEditorMode()},e.prototype.removeQuery=function(){this.panelCtrl.__collapsedQueryCache&&delete this.panelCtrl.__collapsedQueryCache[this.target.refId],this.panelCtrl.removeQuery(this.target)},e.prototype.duplicateQuery=function(){var e=P.a.copy(this.target);this.panelCtrl.addQuery(e)},e.prototype.moveQuery=function(e){this.panelCtrl.moveQuery(this.target,e)},e}();po.directive("queryEditorRow",function(){return{restrict:"E",controller:ho,bindToController:!0,controllerAs:"ctrl",templateUrl:"public/app/features/panel/partials/query_editor_row.html",transclude:!0,scope:{queryCtrl:"=",canCollapse:"=",hasTextEditMode:"="}}});var mo='\n<div class="query-troubleshooter" ng-if="ctrl.isOpen">\n  <div class="query-troubleshooter__header">\n    <a class="pointer" ng-click="ctrl.toggleMocking()">模拟响应</a>\n    <a class="pointer" ng-click="ctrl.toggleExpand()" ng-hide="ctrl.allNodesExpanded">\n      <i class="fa fa-plus-square-o"></i> 展开全部\n    </a>\n    <a class="pointer" ng-click="ctrl.toggleExpand()" ng-show="ctrl.allNodesExpanded">\n      <i class="fa fa-minus-square-o"></i> 折叠全部\n    </a>\n    <a class="pointer" clipboard-button="ctrl.getClipboardText()"><i class="fa fa-clipboard"></i> 复制到剪贴板</a>\n  </div>\n  <div class="query-troubleshooter__body" ng-hide="ctrl.isMocking">\n    <i class="fa fa-spinner fa-spin" ng-show="ctrl.isLoading"></i>\n    <div class="query-troubleshooter-json"></div>\n  </div>\n  <div class="query-troubleshooter__body" ng-show="ctrl.isMocking">\n    <div class="gf-form p-l-1 gf-form--v-stretch">\n\t\t\t<textarea class="gf-form-input" style="width: 95%" rows="10" ng-model="ctrl.mockedResponse"  placeholder="JSON"></textarea>\n    </div>\n  </div>\n</div>\n',fo=function(){function e(e,t){this.$timeout=t,this.onRequestErrorEventListener=this.onRequestError.bind(this),this.onRequestResponseEventListener=this.onRequestResponse.bind(this),oe.a.on("ds-request-response",this.onRequestResponseEventListener),oe.a.on("ds-request-error",this.onRequestErrorEventListener),e.$on("$destroy",this.removeEventsListeners.bind(this)),e.$watch("ctrl.isOpen",this.stateChanged.bind(this))}return e.$inject=["$scope","$timeout"],e.prototype.removeEventsListeners=function(){oe.a.off("ds-request-response",this.onRequestResponseEventListener),oe.a.off("ds-request-error",this.onRequestErrorEventListener)},e.prototype.toggleMocking=function(){this.isMocking=!this.isMocking},e.prototype.onRequestError=function(e){this.isOpen&&(this.isOpen=!0,this.hasError=!0,this.onRequestResponse(e))},e.prototype.stateChanged=function(){this.isOpen&&(this.panelCtrl.refresh(),this.isLoading=!0)},e.prototype.getClipboardText=function(){return this.jsonExplorer?JSON.stringify(this.jsonExplorer.json,null,2):""},e.prototype.handleMocking=function(e){var t;try{t=JSON.parse(this.mockedResponse)}catch(e){return void oe.a.emit("alert-error",["无法解析模拟的响应"])}e.data=t},e.prototype.onRequestResponse=function(e){this.isOpen&&(this.isMocking?this.handleMocking(e):(this.isLoading=!1,(e=D.a.cloneDeep(e)).headers&&delete e.headers,e.config&&(e.request=e.config,delete e.config,delete e.request.transformRequest,delete e.request.transformResponse,delete e.request.paramSerializer,delete e.request.jsonpCallbackParam,delete e.request.headers,delete e.request.requestId,delete e.request.inspect,delete e.request.retry,delete e.request.timeout),e.data&&(e.response=e.data,200===e.status&&this.hasError&&(this.hasError=!1,this.isOpen=!1),delete e.data,delete e.status,delete e.statusText,delete e.$$config),this.$timeout(D.a.partial(this.renderJsonExplorer,e))))},e.prototype.toggleExpand=function(e){this.jsonExplorer&&(this.allNodesExpanded=!this.allNodesExpanded,this.jsonExplorer.openAtDepth(this.allNodesExpanded?20:1))},e}();W.d.directive("queryTroubleshooter",function(){return{restrict:"E",template:mo,controller:fo,bindToController:!0,controllerAs:"ctrl",scope:{panelCtrl:"=",isOpen:"="},link:function(e,t,a,r){r.renderJsonExplorer=function(e){var a=t.find(".query-troubleshooter-json");r.jsonExplorer=new W.a(e,3,{animateOpen:!0});var n=r.jsonExplorer.render(!0);a.html(n)}}}});var go=function(){function e(e,t,a,r){this.$scope=e,this.backendSrv=t,this.navModel=a.getNav("cfg","users",0),this.get(),this.externalUserMngLinkUrl=_e.a.externalUserMngLinkUrl,this.externalUserMngLinkName=_e.a.externalUserMngLinkName,this.canInvite=!_e.a.disableLoginForm&&!_e.a.externalUserMngLinkName,_e.a.externalUserMngInfo&&(this.externalUserMngInfo=new be.a({linkTarget:"__blank"}).render(_e.a.externalUserMngInfo))}return e.$inject=["$scope","backendSrv","navModelSrv","$sce"],e.prototype.get=function(){var e=this;this.backendSrv.get("/api/org/users").then(function(t){e.users=t,e.unfiltered=t}),this.backendSrv.get("/api/org/invites").then(function(t){e.pendingInvites=t})},e.prototype.onQueryUpdated=function(){var e=new RegExp(this.searchQuery,"ig");this.users=D.a.filter(this.unfiltered,function(t){return e.test(t.email)||e.test(t.login)})},e.prototype.updateOrgUser=function(e){this.backendSrv.patch("/api/org/users/"+e.userId,e)},e.prototype.removeUser=function(e){var t=this;this.$scope.appEvent("confirm-modal",{title:"删除",text:"您确定要删除用户 "+e.login+"?",yesText:"删除",icon:"fa-warning",onConfirm:function(){t.removeUserConfirmed(e)}})},e.prototype.removeUserConfirmed=function(e){this.backendSrv.delete("/api/org/users/"+e.userId).then(this.get.bind(this))},e.prototype.revokeInvite=function(e,t){t.stopPropagation(),this.backendSrv.patch("/api/org/invites/"+e.code+"/revoke").then(this.get.bind(this))},e.prototype.copyInviteToClipboard=function(e){e.stopPropagation()},e.prototype.getInviteUrl=function(e){return e.url},e}();U.a.controller("OrgUsersCtrl",go);var vo=function(){function e(e,t,a,r){this.backendSrv=e,this.contextSrv=t,this.$location=a,this.orgs=[],this.showOrgsList=!1,this.readonlyLoginFields=_e.a.disableLoginForm,this.getUser(),this.getUserOrgs(),this.navModel=r.getNav("profile","profile-settings",0)}return e.$inject=["backendSrv","contextSrv","$location","navModelSrv"],e.prototype.getUser=function(){var e=this;this.backendSrv.get("/api/user").then(function(t){e.user=t,e.user.theme=t.theme||"dark"})},e.prototype.getUserOrgs=function(){var e=this;this.backendSrv.get("/api/user/orgs").then(function(t){e.orgs=t,e.showOrgsList=t.length>1})},e.prototype.setUsingOrg=function(e){this.backendSrv.post("/api/user/using/"+e.orgId).then(function(){window.location.href=_e.a.appSubUrl+"/profile"})},e.prototype.update=function(){var e=this;this.userForm.$valid&&this.backendSrv.put("/api/user/",this.user).then(function(){e.contextSrv.user.name=e.user.name||e.user.login,e.old_theme!==e.user.theme&&(window.location.href=_e.a.appSubUrl+e.$location.path())})},e}();W.d.controller("ProfileCtrl",vo);var yo=function(){function e(e,t,a){a.sidemenu=!1,e.navModel={main:{icon:"gicon gicon-branding",subTitle:"偏好",text:"选择活跃组织"}},e.init=function(){e.getUserOrgs()},e.getUserOrgs=function(){t.get("/api/user/orgs").then(function(t){e.orgs=t})},e.setUsingOrg=function(e){t.post("/api/user/using/"+e.orgId).then(function(){window.location.href=_e.a.appSubUrl+"/"})},e.init()}return e.$inject=["$scope","backendSrv","contextSrv"],e}();P.a.module("grafana.controllers").controller("SelectOrgCtrl",yo);var bo=function(){function e(e,t,a,r){e.command={},e.authProxyEnabled=_e.a.authProxyEnabled,e.ldapEnabled=_e.a.ldapEnabled,e.navModel=r.getNav("profile","change-password",0),e.changePassword=function(){e.userForm.$valid&&(e.command.newPassword===e.command.confirmNew?t.put("/api/user/password",e.command).then(function(){a.path("profile")}):e.appEvent("alert-warning",["新旧密码不匹配",""]))}}return e.$inject=["$scope","backendSrv","$location","navModelSrv"],e}();P.a.module("grafana.controllers").controller("ChangePasswordCtrl",bo);var So=function(){function e(e,t,a,r){e.navModel=r.getNav("cfg","admin","global-orgs",1),e.newOrg={name:""},e.createOrg=function(){a.post("/api/orgs/",e.newOrg).then(function(e){a.post("/api/user/using/"+e.orgId).then(function(){window.location.href=_e.a.appSubUrl+"/org"})})}}return e.$inject=["$scope","$http","backendSrv","navModelSrv"],e}();P.a.module("grafana.controllers").controller("NewOrgCtrl",So);var xo=function(){function e(e,t,a){this.backendSrv=e,this.$location=a,this.navModel=t.getNav("cfg","users",0),this.invite={name:"",email:"",role:"Editor",sendEmail:!0}}return e.$inject=["backendSrv","navModelSrv","$location"],e.prototype.sendInvite=function(){var e=this;if(this.inviteForm.$valid)return this.backendSrv.post("/api/org/invites",this.invite).then(function(){e.$location.path("org/users/")})},e}();U.a.controller("UserInviteCtrl",xo);var wo=function(){function e(e,t,a){this.backendSrv=e,this.$location=t,this.navModel=a.getNav("cfg","teams",0)}return e.$inject=["backendSrv","$location","navModelSrv"],e.prototype.create=function(){var e=this,t={name:this.name,email:this.email};this.backendSrv.post("/api/teams",t).then(function(t){t.teamId&&e.$location.path("/org/teams/edit/"+t.teamId)})},e}();U.a.controller("CreateTeamCtrl",wo);var ko=function(){function e(e,t,a,r){e.navModel=r.getNav("cfg","apikeys",0),e.roleTypes=[{text:"观看者",value:"Viewer"},{text:"编辑者",value:"Editor"},{text:"管理员",value:"Admin"}],e.token={role:"Viewer"},e.init=function(){e.getTokens()},e.getTokens=function(){a.get("/api/auth/keys").then(function(t){P.a.forEach(t,function(a,r){P.a.forEach(e.roleTypes,function(e,n){a.role===e.value&&(t[r].roleText=e.text)})}),e.tokens=t})},e.removeToken=function(t){a.delete("/api/auth/keys/"+t).then(e.getTokens)},e.addToken=function(){a.post("/api/auth/keys",e.token).then(function(t){var a=e.$new(!0);a.key=t.key,a.rootPath=window.location.origin+e.$root.appSubUrl,e.appEvent("show-modal",{src:"public/app/features/org/partials/apikeyModal.html",scope:a}),e.getTokens()})},e.init()}return e.$inject=["$scope","$http","backendSrv","navModelSrv"],e}();P.a.module("grafana.controllers").controller("OrgApiKeysCtrl",ko);var Co=function(){function e(e,t,a,r,n){e.init=function(){e.getOrgInfo(),e.navModel=n.getNav("cfg","org-settings",0)},e.getOrgInfo=function(){a.get("/api/org").then(function(t){e.org=t,e.address=t.address,r.user.orgName=t.name})},e.update=function(){if(e.orgForm.$valid){var t={name:e.org.name};a.put("/api/org",t).then(e.getOrgInfo)}},e.updateAddress=function(){e.addressForm.$valid&&a.put("/api/org/address",e.address).then(e.getOrgInfo)},e.init()}return e.$inject=["$scope","$http","backendSrv","contextSrv","navModelSrv"],e}();P.a.module("grafana.controllers").controller("OrgDetailsCtrl",Co);var To=function(){function e(e,t){this.backendSrv=e,this.$location=t,this.timezones=[{value:"",text:"默认"},{value:"browser",text:"本地浏览器时间"},{value:"utc",text:"UTC"}],this.themes=[{value:"",text:"默认"},{value:"dark",text:"Dark"},{value:"light",text:"Light"}]}return e.$inject=["backendSrv","$location"],e.prototype.$onInit=function(){var e=this;return this.backendSrv.get("/api/"+this.mode+"/preferences").then(function(t){e.prefs=t,e.oldTheme=t.theme})},e.prototype.updatePrefs=function(){var e=this;if(this.prefsForm.$valid){var t={theme:this.prefs.theme,timezone:this.prefs.timezone,homeDashboardId:this.prefs.homeDashboardId};this.backendSrv.put("/api/"+this.mode+"/preferences",t).then(function(){window.location.href=_e.a.appSubUrl+e.$location.path()})}},e}(),_o='\n<form name="ctrl.prefsForm" class="section gf-form-group">\n  <h3 class="page-heading">偏好</h3>\n\n  <div class="gf-form">\n    <span class="gf-form-label width-11">UI主题</span>\n    <div class="gf-form-select-wrapper max-width-20">\n      <select class="gf-form-input" ng-model="ctrl.prefs.theme" ng-options="f.value as f.text for f in ctrl.themes"></select>\n    </div>\n  </div>\n\n  <div class="gf-form">\n    <span class="gf-form-label width-11">\n      主页仪表盘\n      <info-popover mode="right-normal">\n        找不到你想要的仪表板？ 首先加注星标收藏，然后它将出现在此下拉框中。\n      </info-popover>\n    </span>\n    <dashboard-selector class="gf-form-select-wrapper max-width-20" model="ctrl.prefs.homeDashboardId">\n    </dashboard-selector>\n  </div>\n\n  <div class="gf-form">\n    <label class="gf-form-label width-11">时区</label>\n    <div class="gf-form-select-wrapper max-width-20">\n      <select class="gf-form-input" ng-model="ctrl.prefs.timezone" ng-options="f.value as f.text for f in ctrl.timezones"></select>\n    </div>\n  </div>\n\n  <div class="gf-form-button-row">\n    <button type="submit" class="btn btn-success" ng-click="ctrl.updatePrefs()">保存</button>\n  </div>\n</form>\n';U.a.directive("prefsControl",function(){return{restrict:"E",controller:To,bindToController:!0,controllerAs:"ctrl",template:_o,scope:{mode:"@"}}});var Mo=function(){function e(e,t,a){this.$scope=e,this.backendSrv=t,this.pages=[],this.perPage=50,this.page=1,this.showPaging=!1,this.navModel=a.getNav("cfg","admin","global-users",1),this.query="",this.getUsers()}return e.$inject=["$scope","backendSrv","navModelSrv"],e.prototype.getUsers=function(){var e=this;this.backendSrv.get("/api/users/search?perpage="+this.perPage+"&page="+this.page+"&query="+this.query).then(function(t){e.users=t.users,e.page=t.page,e.perPage=t.perPage,e.totalPages=Math.ceil(t.totalCount/t.perPage),e.showPaging=e.totalPages>1,e.pages=[];for(var a=1;a<e.totalPages+1;a++)e.pages.push({page:a,current:a===e.page})})},e.prototype.navigateToPage=function(e){this.page=e.page,this.getUsers()},e.prototype.deleteUser=function(e){var t=this;this.$scope.appEvent("confirm-modal",{title:"删除",text:"确定希望删除 "+e.login+"?",icon:"fa-trash",yesText:"删除",onConfirm:function(){t.backendSrv.delete("/api/admin/users/"+e.id).then(function(){t.getUsers()})}})},e}(),$o=function(){function e(e,t,a){e.init=function(){e.navModel=a.getNav("cfg","admin","global-orgs",1),e.getOrgs()},e.getOrgs=function(){t.get("/api/orgs").then(function(t){e.orgs=t})},e.deleteOrg=function(a){e.appEvent("confirm-modal",{title:"删除",text:"希望删除组织 "+a.name+"?",text2:"该组织下的所有仪表盘也会被删除!",icon:"fa-trash",yesText:"删除",onConfirm:function(){t.delete("/api/orgs/"+a.id).then(function(){e.getOrgs()})}})},e.init()}return e.$inject=["$scope","backendSrv","navModelSrv"],e}();P.a.module("grafana.controllers").controller("AdminListOrgsCtrl",$o);var Po=function(){function e(e,t,a,r,n){e.init=function(){e.navModel=n.getNav("cfg","admin","global-orgs",1),t.id&&(e.getOrg(t.id),e.getOrgUsers(t.id))},e.getOrg=function(t){a.get("/api/orgs/"+t).then(function(t){e.org=t})},e.getOrgUsers=function(t){a.get("/api/orgs/"+t+"/users").then(function(t){e.orgUsers=t})},e.update=function(){e.orgDetailsForm.$valid&&a.put("/api/orgs/"+e.org.id,e.org).then(function(){r.path("/admin/orgs")})},e.updateOrgUser=function(e){a.patch("/api/orgs/"+e.orgId+"/users/"+e.userId,e)},e.removeOrgUser=function(t){a.delete("/api/orgs/"+t.orgId+"/users/"+t.userId).then(function(){e.getOrgUsers(e.org.id)})},e.init()}return e.$inject=["$scope","$routeParams","backendSrv","$location","navModelSrv"],e}();P.a.module("grafana.controllers").controller("AdminEditOrgCtrl",Po);var Eo=function(){function e(e,t,a,r,n){e.user={},e.newOrg={name:"",role:"Editor"},e.permissions={},e.navModel=n.getNav("cfg","admin","global-users",1),e.init=function(){t.id&&(e.getUser(t.id),e.getUserOrgs(t.id))},e.getUser=function(t){a.get("/api/users/"+t).then(function(a){e.user=a,e.user_id=t,e.permissions.isGrafanaAdmin=a.isGrafanaAdmin})},e.setPassword=function(){if(e.passwordForm.$valid){var t={password:e.password};a.put("/api/admin/users/"+e.user_id+"/password",t).then(function(){r.path("/admin/users")})}},e.updatePermissions=function(){var t=e.permissions;a.put("/api/admin/users/"+e.user_id+"/permissions",t).then(function(){r.path("/admin/users")})},e.create=function(){e.userForm.$valid&&a.post("/api/admin/users",e.user).then(function(){r.path("/admin/users")})},e.getUserOrgs=function(t){a.get("/api/users/"+t+"/orgs").then(function(t){e.orgs=t})},e.update=function(){e.userForm.$valid&&a.put("/api/users/"+e.user_id,e.user).then(function(){r.path("/admin/users")})},e.updateOrgUser=function(t){a.patch("/api/orgs/"+t.orgId+"/users/"+e.user_id,t).then(function(){})},e.removeOrgUser=function(t){a.delete("/api/orgs/"+t.orgId+"/users/"+e.user_id).then(function(){e.getUser(e.user_id),e.getUserOrgs(e.user_id)})},e.orgsSearchCache=[],e.searchOrgs=function(t,r){e.orgsSearchCache.length>0?r(D.a.map(e.orgsSearchCache,"name")):a.get("/api/orgs",{query:""}).then(function(t){e.orgsSearchCache=t,r(D.a.map(t,"name"))})},e.addOrgUser=function(){if(e.addOrgForm.$valid){var t=D.a.find(e.orgsSearchCache,{name:e.newOrg.name});t&&(e.newOrg.loginOrEmail=e.user.login,a.post("/api/orgs/"+t.id+"/users/",e.newOrg).then(function(){e.getUser(e.user_id),e.getUserOrgs(e.user_id)}))}},e.init()}return e.$inject=["$scope","$routeParams","backendSrv","$location","navModelSrv"],e}();P.a.module("grafana.controllers").controller("AdminEditUserCtrl",Eo);var Do=function(){function e(e,t,a){this.navModel=a.getNav("cfg","admin","server-settings",1),t.get("/api/admin/settings").then(function(t){e.settings=t})}return e.$inject=["$scope","backendSrv","navModelSrv"],e}(),Ao=function(){function e(e){this.navModel=e.getNav("cfg","admin",1)}return e.$inject=["navModelSrv"],e}(),Fo=function(){function e(e,t){var a=this;this.navModel=t.getNav("cfg","admin","server-stats",1),e.get("/api/admin/stats").then(function(e){a.stats=e})}return e.$inject=["backendSrv","navModelSrv"],e}();U.a.controller("AdminSettingsCtrl",Do),U.a.controller("AdminHomeCtrl",Ao),U.a.controller("AdminStatsCtrl",Fo),U.a.controller("AdminListUsersCtrl",Mo);var Io=function(){function e(e,t){this.backendSrv=e,this.loadNotifications(),this.navModel=t.getNav("alerting","channels",0)}return e.$inject=["backendSrv","navModelSrv"],e.prototype.loadNotifications=function(){var e=this;this.backendSrv.get("/api/alert-notifications").then(function(t){e.notifications=t})},e.prototype.deleteNotification=function(e){var t=this;this.backendSrv.delete("/api/alert-notifications/"+e).then(function(){t.notifications=t.notifications.filter(function(t){return t.id!==e})})},e}();W.d.controller("AlertNotificationsListCtrl",Io);var Oo=function(){function e(e,t,a,r,n){var i=this;this.$routeParams=e,this.backendSrv=t,this.$location=a,this.$templateCache=r,this.testSeverity="critical",this.defaults={type:"email",settings:{httpMethod:"POST",autoResolve:!0,uploadImage:!0},isDefault:!1},this.navModel=n.getNav("alerting","channels",0),this.isNew=!this.$routeParams.id,this.backendSrv.get("/api/alert-notifiers").then(function(e){i.notifiers=e;for(var t=0,a=i.notifiers;t<a.length;t++){var r=a[t];i.$templateCache.put(i.getNotifierTemplateId(r.type),r.optionsTemplate)}return i.$routeParams.id?i.backendSrv.get("/api/alert-notifications/"+i.$routeParams.id).then(function(e){return i.navModel.breadcrumbs.push({text:e.name}),i.navModel.node={text:e.name},e.settings=D.a.defaults(e.settings,i.defaults.settings),e}):(i.navModel.breadcrumbs.push({text:"New channel"}),i.navModel.node={text:"New channel"},D.a.defaults(i.model,i.defaults))}).then(function(e){i.model=e,i.notifierTemplateId=i.getNotifierTemplateId(i.model.type)})}return e.$inject=["$routeParams","backendSrv","$location","$templateCache","navModelSrv"],e.prototype.save=function(){var e=this;this.theForm.$valid&&(this.model.id?this.backendSrv.put("/api/alert-notifications/"+this.model.id,this.model).then(function(t){e.model=t,W.b.emit("alert-success",["通知已更新",""])}).catch(function(e){e.data&&e.data.error&&W.b.emit("alert-error",[e.data.error])}):this.backendSrv.post("/api/alert-notifications",this.model).then(function(t){W.b.emit("alert-success",["通知已创建",""]),e.$location.path("alerting/notifications")}).catch(function(e){e.data&&e.data.error&&W.b.emit("alert-error",[e.data.error])}))},e.prototype.getNotifierTemplateId=function(e){return"notifier-options-"+e},e.prototype.typeChanged=function(){this.model.settings=D.a.defaults({},this.defaults.settings),this.notifierTemplateId=this.getNotifierTemplateId(this.model.type)},e.prototype.testNotification=function(){if(this.theForm.$valid){var e={name:this.model.name,type:this.model.type,settings:this.model.settings};this.backendSrv.post("/api/alert-notifications/test",e).then(function(e){W.b.emit("alert-success",["通知测试已发出",""])})}},e}();W.d.controller("AlertNotificationEditCtrl",Oo);var qo=function(){function e(e,t,a){this.$routeParams=e,this.backendSrv=t,this.buttonNames=["primary","secondary","inverse","success","warning","danger"],this.buttonSizes=["btn-small","","btn-large"],this.buttonVariants=["-"],this.navModel=a.getNav("cfg","admin","styleguide",1),this.theme=_e.a.bootData.user.lightTheme?"light":"dark"}return e.$inject=["$routeParams","backendSrv","navModelSrv"],e.prototype.switchTheme=function(){this.$routeParams.theme="dark"===this.theme?"light":"dark";var e={theme:this.$routeParams.theme};this.backendSrv.put("/api/user/preferences",e).then(function(){window.location.href=window.location.href})},e}();U.a.controller("StyleGuideCtrl",qo)}}]);
//# sourceMappingURL=3.11afaf794704f34d3259.js.map