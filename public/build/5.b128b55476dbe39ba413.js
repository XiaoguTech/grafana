(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{1214:function(t,e){!function(t){t.plot.plugins.push({init:function(e){var a={first:{x:-1,y:-1},second:{x:-1,y:-1},show:!1,active:!1},r={},n=null;function i(t){a.active&&(h(t),e.getPlaceholder().trigger("plotselecting",[o()]))}function s(i){1==i.which&&(document.body.focus(),void 0!==document.onselectstart&&null==r.onselectstart&&(r.onselectstart=document.onselectstart,document.onselectstart=function(){return!1}),void 0!==document.ondrag&&null==r.ondrag&&(r.ondrag=document.ondrag,document.ondrag=function(){return!1}),c(a.first,i),a.active=!0,n=function(t){!function(t){n=null,void 0!==document.onselectstart&&(document.onselectstart=r.onselectstart),void 0!==document.ondrag&&(document.ondrag=r.ondrag),a.active=!1,h(t),m()?l(t):(e.getPlaceholder().trigger("plotunselected",[]),e.getPlaceholder().trigger("plotselecting",[null])),setTimeout(function(){e.isSelecting=!1},10)}(t)},t(document).one("mouseup",n))}function o(){if(!m())return null;if(!a.show)return null;var r={},n=a.first,i=a.second,s=e.getAxes();return t.each(s,function(t,e){e.used&&(anyUsed=!1)}),t.each(s,function(t,e){e.used;var a=e.c2p(n[e.direction]),s=e.c2p(i[e.direction]);r[t]={from:Math.min(a,s),to:Math.max(a,s)}}),r}function l(t){var a=o();a.ctrlKey=t.ctrlKey,a.metaKey=t.metaKey,e.getPlaceholder().trigger("plotselected",[a]),a.xaxis&&a.yaxis&&e.getPlaceholder().trigger("selected",[{x1:a.xaxis.from,y1:a.yaxis.from,x2:a.xaxis.to,y2:a.yaxis.to}])}function u(t,e,a){return e<t?t:e>a?a:e}function c(t,r){var n=e.getOptions(),i=e.getPlaceholder().offset(),s=e.getPlotOffset();t.x=u(0,r.pageX-i.left-s.left,e.width()),t.y=u(0,r.pageY-i.top-s.top,e.height()),"y"==n.selection.mode&&(t.x=t==a.first?0:e.width()),"x"==n.selection.mode&&(t.y=t==a.first?0:e.height())}function h(t){null!=t.pageX&&(c(a.second,t),m()?(e.isSelecting=!0,a.show=!0,e.triggerRedrawOverlay()):p(!0))}function p(t){a.show&&(a.show=!1,e.triggerRedrawOverlay(),t||e.getPlaceholder().trigger("plotunselected",[]))}function d(t,a){var r,n,i,s,o=e.getAxes();for(var l in o)if((r=o[l]).direction==a&&(t[s=a+r.n+"axis"]||1!=r.n||(s=a+"axis"),t[s])){n=t[s].from,i=t[s].to;break}if(t[s]||(r="x"==a?e.getXAxes()[0]:e.getYAxes()[0],n=t[a+"1"],i=t[a+"2"]),null!=n&&null!=i&&n>i){var u=n;n=i,i=u}return{from:n,to:i,axis:r}}function m(){var t=e.getOptions().selection.minSize;return Math.abs(a.second.x-a.first.x)>=t&&Math.abs(a.second.y-a.first.y)>=t}e.clearSelection=p,e.setSelection=function(t,r){var n,i=e.getOptions();"y"==i.selection.mode?(a.first.x=0,a.second.x=e.width()):(n=d(t,"x"),a.first.x=n.axis.p2c(n.from),a.second.x=n.axis.p2c(n.to)),"x"==i.selection.mode?(a.first.y=0,a.second.y=e.height()):(n=d(t,"y"),a.first.y=n.axis.p2c(n.from),a.second.y=n.axis.p2c(n.to)),a.show=!0,e.triggerRedrawOverlay(),!r&&m()&&l()},e.getSelection=o,e.hooks.bindEvents.push(function(t,e){null!=t.getOptions().selection.mode&&(e.mousemove(i),e.mousedown(s))}),e.hooks.drawOverlay.push(function(e,r){if(a.show&&m()){var n=e.getPlotOffset(),i=e.getOptions();r.save(),r.translate(n.left,n.top);var s=t.color.parse(i.selection.color);r.strokeStyle=s.scale("a",.8).toString(),r.lineWidth=1,r.lineJoin=i.selection.shape,r.fillStyle=s.scale("a",.4).toString();var o=Math.min(a.first.x,a.second.x)+.5,l=Math.min(a.first.y,a.second.y)+.5,u=Math.abs(a.second.x-a.first.x)-1,c=Math.abs(a.second.y-a.first.y)-1;r.fillRect(o,l,u,c),r.strokeRect(o,l,u,c),r.restore()}}),e.hooks.shutdown.push(function(e,a){a.unbind("mousemove",i),a.unbind("mousedown",s),n&&t(document).unbind("mouseup",n)})},options:{selection:{mode:null,color:"#e8cfac",shape:"round",minSize:5}},name:"selection",version:"1.1"})}(jQuery)},1215:function(t,e){!function(t){jQuery.plot.plugins.push({init:function(t){t.hooks.processDatapoints.push(function(t,e,a){if(null!=e.stack&&!1!==e.stack){var r=function(t,e){for(var a=null,r=0;r<e.length&&t!=e[r];++r)e[r].stack==t.stack&&(a=e[r]);return a}(e,t.getData());if(r){for(var n,i,s,o,l,u,c,h,p=a.pointsize,d=a.points,m=r.datapoints.pointsize,f=r.datapoints.points,g=[],v=e.lines.show,y=e.bars.horizontal,b=p>2&&(y?a.format[2].x:a.format[2].y),S=v&&e.lines.steps,x=y?1:0,w=y?0:1,k=0,C=0;!(k>=d.length&&C>=f.length);){if(c=g.length,k<d.length&&null==d[k]){for(h=0;h<p;++h)g.push(d[k+h]);k+=p}else if(k>=d.length){for(h=0;h<p;++h)g.push(f[C+h]);b&&(g[c+2]=f[C+w]),C+=m}else if(C>=f.length){for(h=0;h<p;++h)g.push(d[k+h]);k+=p}else if(C<f.length&&null==f[C])C+=m;else{if(n=d[k+x],i=d[k+w],o=f[C+x],l=f[C+w],u=0,n==o){for(h=0;h<p;++h)g.push(d[k+h]);g[c+w]+=l,u=l,k+=p,C+=m}else if(n>o){if(0==k){for(h=0;h<p;++h)g.push(f[C+h]);u=l}if(k>0&&null!=d[k-p]){for(s=i+(d[k-p+w]-i)*(o-n)/(d[k-p+x]-n),g.push(o),g.push(s+l),h=2;h<p;++h)g.push(d[k+h]);u=l}C+=m}else{for(h=0;h<p;++h)g.push(d[k+h]);C>0&&null!=f[C-m]&&(u=l+(f[C-m+w]-l)*(n-o)/(f[C-m+x]-o)),g[c+w]+=u,k+=p}fromgap=!1,c!=g.length&&b&&(g[c+2]=u)}if(S&&c!=g.length&&c>0&&null!=g[c]&&g[c]!=g[c-p]&&g[c+1]!=g[c-p+1]){for(h=0;h<p;++h)g[c+p+h]=g[c+h];g[c+1]=g[c-p+1]}}a.points=g}}})},options:{series:{stack:null}},name:"stack",version:"1.2"})}()},1216:function(t,e){!function(t){jQuery.plot.plugins.push({init:function(t){var e={},a=!1,r={};function n(t){var e=t.length,a={};if(e>0)for(var r=0;r<e;r++)if(t[r].stackpercent){var n=0,i=1;t[r].bars&&t[r].bars.horizontal&&!0===t[r].bars.horizontal&&(n=1,i=0);for(var s=t[r].data.length,o=0;o<s;o++){var l=0;null!=t[r].data[o][1]&&(l=t[r].data[o][i]),a[t[r].data[o][n]+""]?a[t[r].data[o][n]+""]+=l:a[t[r].data[o][n]+""]=l}}return a}t.hooks.processRawData.push(function(t,e,i,s){if(a||(a=!0,r=n(t.getData())),1==e.stackpercent){var o=i.length;e.percents=[];var l=0,u=1;e.bars&&e.bars.horizontal&&!0===e.bars.horizontal&&(l=1,u=0);for(var c=0;c<o;c++){var h=r[i[c][l]+""];h>0?e.percents.push(100*i[c][u]/h):e.percents.push(0)}}}),t.hooks.processDatapoints.push(function(t,i,s){if(i.stackpercent){a||(r=n(t.getData()));var o=[],l=0,u=1;i.bars&&i.bars.horizontal&&!0===i.bars.horizontal&&(l=1,u=0);for(var c=0;c<s.points.length;c+=3)e[s.points[c+l]]||(e[s.points[c+l]]=0),o[c+l]=s.points[c+l],o[c+u]=s.points[c+u]+e[s.points[c+l]],o[c+2]=e[s.points[c+l]],e[s.points[c+l]]+=s.points[c+u],r[o[c+l]+""]>0?(o[c+u]=100*o[c+u]/r[o[c+l]+""],o[c+2]=100*o[c+2]/r[o[c+l]+""]):(o[c+u]=0,o[c+2]=0);s.points=o}})},options:{series:{stackpercent:null}},name:"stackpercent",version:"0.1"})}()},1217:function(t,e){!function(t){"use strict";t.plot.plugins.push({init:function(e){function a(t,e,a,r,n,i,s,o){var l,u,c,h,p,d;return d=((c=s-n)*(e-i)-(h=o-i)*(t-n))/(-c*(u=r-e)+(l=a-t)*h),(p=(-u*(t-n)+l*(e-i))/(-c*u+l*h))>=0&&p<=1&&d>=0&&d<=1?[t+d*l,e+d*u]:null}e.hooks.drawSeries.push(function(e,r,n){var i,s,o,l,u,c,h;function p(t,e){r.beginPath(),r.moveTo(n.xaxis.p2c(t)+c.left,n.yaxis.p2c(e)+c.top)}function d(t,e){console.assert(e>t,"expects the end index to be greater than the start index");var a,r,n=0===t||null===o[t-1]||null===u[t-1],i=!1;for(a=t;a<e;a++)if(null===o[a*s+1]||null===u[a*s+1])i=!1,n=!0;else if(o[a*s+1]===u[a*l+1])i=!0,n=!1;else{if(o[a*s+1]>u[a*l+1])return n?p(o[a*s],o[a*s+1]):i?p(o[(a-1)*s],o[(a-1)*s+1]):p((r=m(a))[0],r[1]),void g(a,e);n=!1,i=!1}}function m(t){var e,r;for(console.assert(t>0,"expects the second point in the series line segment"),e=1;e<u.length/l;e++)if(null!==(r=a(o[(t-1)*s],o[(t-1)*s+1],o[t*s],o[t*s+1],u[(e-1)*l],u[(e-1)*l+1],u[e*l],u[e*l+1])))return r;console.error("intersectionPoint() should only be called when an intersection happens")}function f(t,e){var a;for(console.assert(t>=e,"the start should be the rightmost point, and the end should be the leftmost (excluding the equal or intersecting point)"),a=t;a>=e;a--)r.lineTo(i.xaxis.p2c(u[a*l])+c.left,i.yaxis.p2c(u[a*l+1])+c.top);r.closePath(),r.fill()}function g(t,e){var a,i;for(console.assert(t<=e,"the start should be the rightmost point, and the end should be the leftmost (excluding the equal or intersecting point)"),a=t;a<e;a++){if(null===o[a*s+1]&&a>t)return f(a-1,t),void d(a,e);if(o[a*s+1]===u[a*l+1])return f(a,t),void d(a,e);if(o[a*s+1]<u[a*l+1])return i=m(a),r.lineTo(n.xaxis.p2c(i[0])+c.left,n.yaxis.p2c(i[1])+c.top),f(a,t),void d(a,e);r.lineTo(n.xaxis.p2c(o[a*s])+c.left,n.yaxis.p2c(o[a*s+1])+c.top)}f(e,t)}null!==n.fillBelowTo&&(i=function(t,e){var a;for(a=0;a<e.length;++a)if(e[a].id===t.fillBelowTo)return e[a];return null}(n,e.getData()))&&(s=n.datapoints.pointsize,o=n.datapoints.points,l=i.datapoints.pointsize,u=i.datapoints.points,c=e.getPlotOffset(),function(){if(o.length/s!=u.length/l)return console.error("Refusing to graph inconsistent number of points"),!1;var t;for(t=0;t<o.length/s;t++)if(null!==o[t*s]&&null!==u[t*l]&&o[t*s]!==u[t*l])return console.error("Refusing to graph points without matching value"),!1;return!0}()&&((h=t.color.parse(n.color)).a=.4,h.normalize(),r.fillStyle=h.toString(),d(0,o.length/s)))})},options:{series:{fillBelowTo:null}},name:"fillbelow",version:"0.1.0"})}(jQuery)},1218:function(t,e){!function(t){jQuery.plot.plugins.push({init:function(t){var e={x:-1,y:-1,locked:!1};function a(a){e.locked||-1!=e.x&&(e.x=-1,t.triggerRedrawOverlay())}function r(a){if(!e.locked)if(t.getSelection&&t.getSelection())e.x=-1;else{var r=t.offset();e.x=Math.max(0,Math.min(a.pageX-r.left,t.width())),e.y=Math.max(0,Math.min(a.pageY-r.top,t.height())),t.triggerRedrawOverlay()}}t.setCrosshair=function(a){if(a){var r=t.p2c(a);e.x=Math.max(0,Math.min(r.left,t.width())),e.y=Math.max(0,Math.min(r.top,t.height()))}else e.x=-1;t.triggerRedrawOverlay()},t.clearCrosshair=t.setCrosshair,t.lockCrosshair=function(a){a&&t.setCrosshair(a),e.locked=!0},t.unlockCrosshair=function(){e.locked=!1},t.hooks.bindEvents.push(function(t,e){t.getOptions().crosshair.mode&&(e.mouseout(a),e.mousemove(r))}),t.hooks.drawOverlay.push(function(t,a){var r=t.getOptions().crosshair;if(r.mode){var n=t.getPlotOffset();if(a.save(),a.translate(n.left,n.top),-1!=e.x){var i=t.getOptions().crosshair.lineWidth%2?.5:0;if(a.strokeStyle=r.color,a.lineWidth=r.lineWidth,a.lineJoin="round",a.beginPath(),-1!=r.mode.indexOf("x")){var s=Math.floor(e.x)+i;a.moveTo(s,0),a.lineTo(s,t.height())}if(-1!=r.mode.indexOf("y")){var o=Math.floor(e.y)+i;a.moveTo(0,o),a.lineTo(t.width(),o)}a.stroke()}a.restore()}}),t.hooks.shutdown.push(function(t,e){e.unbind("mouseout",a),e.unbind("mousemove",r)})},options:{crosshair:{mode:null,color:"rgba(170, 0, 0, 0.80)",lineWidth:1}},name:"crosshair",version:"1.0"})}()},1219:function(t,e){!function(t){jQuery.plot.plugins.push({init:function(t){t.hooks.processDatapoints.push(function(t,e,a){e.dashes.show&&t.hooks.draw.push(function(t,r){var n=t.getPlotOffset(),i=e.xaxis,s=e.yaxis;function o(t,n){var o,l,u=a.points,c=a.pointsize,h=null,p=null,d=0,m=!0;e.dashes.dashLength[0]?(o=e.dashes.dashLength[0],l=e.dashes.dashLength[1]?e.dashes.dashLength[1]:o):l=o=e.dashes.dashLength,r.beginPath();for(var f=c;f<u.length;f+=c){var g=u[f-c],v=u[f-c+1],y=u[f],b=u[f+1];if(null!=g&&null!=y){if(v<=b&&v<s.min){if(b<s.min)continue;g=(s.min-v)/(b-v)*(y-g)+g,v=s.min}else if(b<=v&&b<s.min){if(v<s.min)continue;y=(s.min-v)/(b-v)*(y-g)+g,b=s.min}if(v>=b&&v>s.max){if(b>s.max)continue;g=(s.max-v)/(b-v)*(y-g)+g,v=s.max}else if(b>=v&&b>s.max){if(v>s.max)continue;y=(s.max-v)/(b-v)*(y-g)+g,b=s.max}if(g<=y&&g<i.min){if(y<i.min)continue;v=(i.min-g)/(y-g)*(b-v)+v,g=i.min}else if(y<=g&&y<i.min){if(g<i.min)continue;b=(i.min-g)/(y-g)*(b-v)+v,y=i.min}if(g>=y&&g>i.max){if(y>i.max)continue;v=(i.max-g)/(y-g)*(b-v)+v,g=i.max}else if(y>=g&&y>i.max){if(g>i.max)continue;b=(i.max-g)/(y-g)*(b-v)+v,y=i.max}g==h&&v==p||r.moveTo(i.p2c(g)+t,s.p2c(v)+n);var S,x=i.p2c(g)+t,w=s.p2c(v)+n,k=i.p2c(y)+t,C=s.p2c(b)+n;do{0==(S=T(d>0?d:m?o:l)).deltaX&&0==S.deltaY||(m?r.lineTo(x+S.deltaX,w+S.deltaY):r.moveTo(x+S.deltaX,w+S.deltaY)),m=!m,d=S.remainder,x+=S.deltaX,w+=S.deltaY}while(S.distance>0);h=y,p=b}function T(t){var e=Math.sqrt(Math.pow(k-x,2)+Math.pow(C-w,2));if(e<=t)return{deltaX:k-x,deltaY:C-w,distance:e,remainder:t-e};var a=C>w?1:-1;return{deltaX:(k>x?1:-1)*Math.sqrt(Math.pow(t,2)/(1+Math.pow((C-w)/(k-x),2))),deltaY:a*Math.sqrt(Math.pow(t,2)-Math.pow(t,2)/(1+Math.pow((C-w)/(k-x),2))),distance:t,remainder:0}}}r.stroke()}r.save(),r.translate(n.left,n.top),r.lineJoin="round";var l=e.dashes.lineWidth,u=e.shadowSize;if(l>0&&u>0){r.lineWidth=u,r.strokeStyle="rgba(0,0,0,0.1)";var c=Math.PI/18;o(Math.sin(c)*(l/2+u/2),Math.cos(c)*(l/2+u/2)),r.lineWidth=u/2,o(Math.sin(c)*(l/2+u/4),Math.cos(c)*(l/2+u/4))}r.lineWidth=l,r.strokeStyle=e.color,l>0&&o(0,0),r.restore()})})},options:{series:{dashes:{show:!1,lineWidth:2,dashLength:10}}},name:"dashes",version:"0.1"})}()},1220:function(t,e){
/*!
 * jquery.flot.gauge v1.1.0 *
 *
 * Flot plugin for rendering gauge charts.
 *
 * Copyright (c) 2015 @toyoty99.
 * Licensed under the MIT license.
 */
!function(t){var e=function(){var e,i,s,o,l,u=function(t,r){e=r,i=t.getPlaceholder(),s=t.getOptions(),o=s.series.gauges,l=t.getData(),a(o.debug)};function c(t,e){"auto"===t.gauge.width&&(t.gauge.width=Math.max(5,e/8)),"auto"===t.label.margin&&(t.label.margin=Math.max(1,e/20)),"auto"===t.label.font.size&&(t.label.font.size=Math.max(5,e/8)),"auto"===t.value.margin&&(t.value.margin=Math.max(1,e/30)),"auto"===t.value.font.size&&(t.value.font.size=Math.max(5,e/9)),"auto"===t.threshold.width&&(t.threshold.width=Math.max(3,e/100)),"auto"===t.threshold.label.margin&&(t.threshold.label.margin=Math.max(3,e/40)),"auto"===t.threshold.label.font.size&&(t.threshold.label.font.size=Math.max(5,e/15))}function h(t,e,a){var r=t.gauge.startAngle+(t.gauge.endAngle-t.gauge.startAngle)*((a-t.gauge.min)/(t.gauge.max-t.gauge.min));return r<t.gauge.startAngle?r=t.gauge.startAngle:r>t.gauge.endAngle&&(r=t.gauge.endAngle),r}function p(t,a,r,i,s,o,l,u,c,h){s!==o&&(e.save(),n(e,t,a,r,i,s,o,l,u,c),h&&(n(e,t,a,r,i,s,o),e.clip(),e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=10,e.shadowColor="gray",n(e,t,a,r+1,i+2,s,o,l,1)),e.restore())}function d(t,e,a,n,i,s){m(a.cx+(e.thresholdLabelMargin+e.thresholdLabelFontSize/2+e.radius)*Math.cos(r(s)),a.cy+(e.thresholdLabelMargin+e.thresholdLabelFontSize/2+e.radius)*Math.sin(r(s)),"flotGagueThresholdValue"+n,t.threshold.label.formatter?t.threshold.label.formatter(i):i,t.threshold.label,s)}function m(e,a,r,n,s,o){var l=t("."+r,i),u=l.length;u||((l=t("<span></span>")).attr("id",r),l.css("position","absolute"),l.css("top",a+"px"),s.font.size&&l.css("font-size",s.font.size+"px"),s.font.family&&l.css("font-family",s.font.family),s.color&&l.css("color",s.color),s.background.color&&l.css("background-color",s.background.color),s.background.opacity&&l.css("opacity",s.background.opacity),i.append(l)),l.text(n),l.css("left",e+"px"),l.css("left",parseInt(l.css("left"))-l.width()/2+"px"),!u&&o&&(l.css("top",parseInt(l.css("top"))-l.height()/2+"px"),l.css("transform","rotate("+(180*o+90)+"deg)"))}return u.prototype.calculateLayout=function(){var t=i.width(),e=i.height(),a=Math.min(l.length,o.layout.columns),n=Math.ceil(l.length/a),s=o.layout.margin,u=o.layout.hMargin,h=o.layout.vMargin,p=(t-2*s-u*(a-1))/a,d=(e-2*s-h*(n-1))/n;if(o.layout.square){var m=Math.min(p,d);p=m,d=m}c(o,p);var f=o.cell.margin,g=0,v=0;o.label.show&&(g=o.label.margin,v=o.label.font.size);var y=0,b=0;o.value.show&&(y=o.value.margin,b=o.value.font.size);var S=0;o.threshold.show&&(S=o.threshold.width);var x=0,w=0;o.threshold.label.show&&(x=o.threshold.label.margin,w=o.threshold.label.font.size);for(var k=p/2-f-S-2*x-w,C=o.gauge.startAngle,T=o.gauge.endAngle,_=(T-C)/100,M=-1,$=C;$<T;$+=_)M=Math.max(M,Math.sin(r($)));var P=(d-2*f-2*g-v)/(1+(M=Math.max(M,Math.sin(r(T)))));P*M<y+b/2&&(P=d-2*f-2*g-v-y-b/2);var E=P-2*x-w-S,A=Math.min(k,E),D=o.gauge.width;D>=A&&(D=Math.max(3,A/3));var F=2*x+w+S+A;return{canvasWidth:t,canvasHeight:e,margin:s,hMargin:u,vMargin:h,columns:a,rows:n,cellWidth:p,cellHeight:d,cellMargin:f,labelMargin:g,labelFontSize:v,valueMargin:y,valueFontSize:b,width:D,radius:A,thresholdWidth:S,thresholdLabelMargin:x,thresholdLabelFontSize:w,gaugeOuterHeight:Math.max(F*(1+M),F+y+b/2)}},u.prototype.calculateAutoValues=c,u.prototype.calculateCellLayout=function(t,e,a){var r=function(t,e){return e%t}(e.columns,a),n=function(t,e){return Math.floor(e/t)}(e.columns,a),i=e.margin+(e.cellWidth+e.hMargin)*r,s=e.margin+(e.cellHeight+e.vMargin)*n,o=i+e.cellWidth/2,l=s+e.cellMargin+2*e.labelMargin+e.labelFontSize+e.thresholdWidth+e.thresholdLabelFontSize+2*e.thresholdLabelMargin+e.radius,u=e.cellHeight-2*e.cellMargin-2*e.labelMargin-e.labelFontSize-e.gaugeOuterHeight,c=0;return"middle"===t.cell.vAlign?c=u/2:"bottom"===t.cell.vAlign&&(c=u),l+=c,{col:r,row:n,x:i,y:s,offsetY:c,cellWidth:e.cellWidth,cellHeight:e.cellHeight,cellMargin:e.cellMargin,cx:o,cy:l}},u.prototype.drawBackground=function(t){o.frame.show&&(e.save(),e.strokeStyle=s.grid.borderColor,e.lineWidth=s.grid.borderWidth,e.strokeRect(0,0,t.canvasWidth,t.canvasHeight),s.grid.backgroundColor&&(e.fillStyle=s.grid.backgroundColor,e.fillRect(0,0,t.canvasWidth,t.canvasHeight)),e.restore())},u.prototype.drawCellBackground=function(t,a){e.save(),t.cell.border&&t.cell.border.show&&t.cell.border.color&&t.cell.border.width&&(e.strokeStyle=t.cell.border.color,e.lineWidth=t.cell.border.width,e.strokeRect(a.x,a.y,a.cellWidth,a.cellHeight)),t.cell.background&&t.cell.background.color&&(e.fillStyle=t.cell.background.color,e.fillRect(a.x,a.y,a.cellWidth,a.cellHeight)),e.restore()},u.prototype.drawGauge=function(t,e,a,n,i){var s=t.gauge.shadow.show?t.gauge.shadow.blur:0;p(a.cx,a.cy,e.radius,e.width,r(t.gauge.startAngle),r(t.gauge.endAngle),t.gauge.border.color,t.gauge.border.width,t.gauge.background.color,s);var o=function(t,e){for(var a,r=0;r<t.threshold.values.length;r++){var n=t.threshold.values[r];if(a=n.color,e<n.value)break}return a}(t,i),l=h(t,e,i);p(a.cx,a.cy,e.radius-1,e.width-2,r(t.gauge.startAngle),r(l),o,1,o,s)},u.prototype.drawThreshold=function(t,a,i){for(var s=t.gauge.startAngle,o=0;o<t.threshold.values.length;o++){var l=t.threshold.values[o];c1=l.color,a2=h(t,0,l.value),n(e,i.cx,i.cy,a.radius+a.thresholdWidth,a.thresholdWidth-2,r(s),r(a2),c1,1,c1),s=a2}},u.prototype.drawLable=function(t,e,a,r,n){m(a.cx,a.y+a.cellMargin+e.labelMargin+a.offsetY,"flotGagueLabel"+r,t.label.formatter?t.label.formatter(n.label,n.data[0][1]):text,t.label)},u.prototype.drawValue=function(t,e,a,r,n){m(a.cx,a.cy-t.value.font.size/2,"flotGagueValue"+r,t.value.formatter?t.value.formatter(n.label,n.data[0][1]):text,t.value)},u.prototype.drawThresholdValues=function(t,e,a,r){d(t,e,a,"Min"+r,t.gauge.min,t.gauge.startAngle),d(t,e,a,"Max"+r,t.gauge.max,t.gauge.endAngle);for(var n=0;n<t.threshold.values.length;n++){var i=t.threshold.values[n];if(i.value>t.gauge.min&&i.value<t.gauge.max){var s=h(t,0,i.value);d(t,e,a,r+"_"+n,i.value,s)}}},u}();function a(t){return"undefined"!=typeof Logger?new Logger(t):null}function r(t){return t*Math.PI}function n(t,e,a,r,n,i,s,o,l,u){if(i!==s){t.save(),t.beginPath(),t.arc(e,a,r,i,s,!1),t.lineTo(e+(r-n)*Math.cos(s),a+(r-n)*Math.sin(s)),t.arc(e,a,r-n,s,i,!0),t.closePath(),l&&(t.lineWidth=l),o&&(t.strokeStyle=o,t.stroke()),u&&(t.fillStyle=u,t.fill()),t.restore()}}var i={series:{gauges:{debug:{log:!1,layout:!1,alert:!1},show:!1,layout:{margin:5,columns:3,hMargin:5,vMargin:5,square:!1},frame:{show:!0},cell:{background:{color:null},border:{show:!0,color:"black",width:1},margin:5,vAlign:"middle"},gauge:{width:"auto",startAngle:.9,endAngle:2.1,min:0,max:100,background:{color:"white"},border:{color:"lightgray",width:2},shadow:{show:!0,blur:5}},label:{show:!0,margin:"auto",background:{color:null,opacity:0},font:{size:"auto",family:"sans-serif"},color:null,formatter:function(t,e){return t}},value:{show:!0,margin:"auto",background:{color:null,opacity:0},font:{size:"auto",family:"sans-serif"},color:null,formatter:function(t,e){return parseInt(e)}},threshold:{show:!0,width:"auto",label:{show:!0,margin:"auto",background:{color:null,opacity:0},font:{size:"auto",family:",sans-serif"},color:null,formatter:function(t){return t}},values:[{value:50,color:"lightgreen"},{value:80,color:"yellow"},{value:100,color:"red"}]}}}};t.plot.plugins.push({init:function(r){r.hooks.processOptions.push(function(t,e){a(e.series.gauges.debug),e.series.gauges.show&&(e.grid.show=!1,e.legend.show=!1),e.series.gauges.threshold.values.sort(function(t,e){return t.value<e.value?-1:t.value>e.value?1:0})}),r.hooks.draw.push(function(r,n){var i=r.getOptions().series.gauges;if(a(i.debug),i.show){var s=r.getData();if(s&&s.length){var o=new e(r,n),l=o.calculateLayout();i.debug.layout,o.drawBackground(l);for(var u=0;u<s.length;u++){var c=s[u],h=t.extend({},i,c.gauges);c.gauges&&o.calculateAutoValues(h,l.cellWidth);var p=o.calculateCellLayout(h,l,u);o.drawCellBackground(h,p),h.debug.layout,h.label.show&&o.drawLable(h,l,p,u,c),o.drawGauge(h,l,p,c.label,c.data[0][1]),h.threshold.show&&o.drawThreshold(h,l,p),h.threshold.label.show&&o.drawThresholdValues(h,l,p,u),h.value.show&&o.drawValue(h,l,p,u,c)}}}})},options:i,name:"gauge",version:"1.1.0"})}(jQuery)},1221:function(t,e){ace.define("ace/mode/prometheus_highlight_rules",["require","exports","module","ace/lib/oop","ace/mode/text_highlight_rules"],function(t,e,a){"use strict";var r=t("../lib/oop"),n=t("./text_highlight_rules").TextHighlightRules,i=function(){var t=this.createKeywordMapper({"support.function":"abs|absent|ceil|changes|clamp_max|clamp_min|count_scalar|day_of_month|day_of_week|days_in_month|delta|deriv|drop_common_labels|exp|floor|histogram_quantile|holt_winters|hour|idelta|increase|irate|label_replace|ln|log2|log10|minute|month|predict_linear|rate|resets|round|scalar|sort|sort_desc|sqrt|time|vector|year|avg_over_time|min_over_time|max_over_time|sum_over_time|count_over_time|quantile_over_time|stddev_over_time|stdvar_over_time",keyword:"count|count_values|min|max|avg|sum|stddev|stdvar|bottomk|topk|quantile","constant.language":"true|false|null|__name__|job"},"identifier",!0);this.$rules={start:[{token:"string",regex:/"(?:[^"\\]|\\.)*?"/},{token:"string",regex:"'.*?'"},{token:"constant.numeric",regex:"[-]?\\d+(?:(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)?\\b"},{token:"constant.language",regex:"\\d+[smhdwy]"},{token:"keyword.operator.binary",regex:"\\+|\\-|\\*|\\/|%|\\^|==|!=|<=|>=|<|>|and|or|unless"},{token:"keyword.other",regex:"keep_common|offset|bool"},{token:"keyword.control",regex:"by|without|on|ignoring|group_left|group_right",next:"start-label-list-matcher"},{token:"variable",regex:"\\$[A-Za-z0-9_]+"},{token:t,regex:"[a-zA-Z_:][a-zA-Z0-9_:]*"},{token:"paren.lparen",regex:"[[(]"},{token:"paren.lparen.label-matcher",regex:"{",next:"start-label-matcher"},{token:"paren.rparen",regex:"[\\])]"},{token:"paren.rparen.label-matcher",regex:"}"},{token:"text",regex:"\\s+"}],"start-label-matcher":[{token:"entity.name.tag.label-matcher",regex:"[a-zA-Z_][a-zA-Z0-9_]*"},{token:"keyword.operator.label-matcher",regex:"=~|=|!~|!="},{token:"string.quoted.label-matcher",regex:"\"[^\"]*\"|'[^']*'"},{token:"punctuation.operator.label-matcher",regex:","},{token:"paren.rparen.label-matcher",regex:"}",next:"start"}],"start-label-list-matcher":[{token:"paren.lparen.label-list-matcher",regex:"[(]"},{token:"entity.name.tag.label-list-matcher",regex:"[a-zA-Z_][a-zA-Z0-9_]*"},{token:"punctuation.operator.label-list-matcher",regex:","},{token:"paren.rparen.label-list-matcher",regex:"[)]",next:"start"}]},this.normalizeRules()};r.inherits(i,n),e.PrometheusHighlightRules=i}),ace.define("ace/mode/prometheus_completions",["require","exports","module","ace/token_iterator","ace/lib/lang"],function(t,e,a){"use strict";var r=t("../lib/lang"),n=["by","without","keep_common","offset","bool","and","or","unless","ignoring","on","group_left","group_right","count","count_values","min","max","avg","sum","stddev","stdvar","bottomk","topk","quantile"].map(function(t){return{caption:t,value:t,meta:"keyword",score:Number.MAX_VALUE}});var i=[{name:"abs()",value:"abs",def:"abs(v instant-vector)",docText:"Returns the input vector with all sample values converted to their absolute value."},{name:"absent()",value:"absent",def:"absent(v instant-vector)",docText:"Returns an empty vector if the vector passed to it has any elements and a 1-element vector with the value 1 if the vector passed to it has no elements. This is useful for alerting on when no time series exist for a given metric name and label combination."},{name:"ceil()",value:"ceil",def:"ceil(v instant-vector)",docText:"Rounds the sample values of all elements in `v` up to the nearest integer."},{name:"changes()",value:"changes",def:"changes(v range-vector)",docText:"For each input time series, `changes(v range-vector)` returns the number of times its value has changed within the provided time range as an instant vector."},{name:"clamp_max()",value:"clamp_max",def:"clamp_max(v instant-vector, max scalar)",docText:"Clamps the sample values of all elements in `v` to have an upper limit of `max`."},{name:"clamp_min()",value:"clamp_min",def:"clamp_min(v instant-vector, min scalar)",docText:"Clamps the sample values of all elements in `v` to have a lower limit of `min`."},{name:"count_scalar()",value:"count_scalar",def:"count_scalar(v instant-vector)",docText:"Returns the number of elements in a time series vector as a scalar. This is in contrast to the `count()` aggregation operator, which always returns a vector (an empty one if the input vector is empty) and allows grouping by labels via a `by` clause."},{name:"day_of_month()",value:"day_of_month",def:"day_of_month(v=vector(time()) instant-vector)",docText:"Returns the day of the month for each of the given times in UTC. Returned values are from 1 to 31."},{name:"day_of_week()",value:"day_of_week",def:"day_of_week(v=vector(time()) instant-vector)",docText:"Returns the day of the week for each of the given times in UTC. Returned values are from 0 to 6, where 0 means Sunday etc."},{name:"days_in_month()",value:"days_in_month",def:"days_in_month(v=vector(time()) instant-vector)",docText:"Returns number of days in the month for each of the given times in UTC. Returned values are from 28 to 31."},{name:"delta()",value:"delta",def:"delta(v range-vector)",docText:"Calculates the difference between the first and last value of each time series element in a range vector `v`, returning an instant vector with the given deltas and equivalent labels. The delta is extrapolated to cover the full time range as specified in the range vector selector, so that it is possible to get a non-integer result even if the sample values are all integers."},{name:"deriv()",value:"deriv",def:"deriv(v range-vector)",docText:"Calculates the per-second derivative of the time series in a range vector `v`, using simple linear regression."},{name:"drop_common_labels()",value:"drop_common_labels",def:"drop_common_labels(instant-vector)",docText:"Drops all labels that have the same name and value across all series in the input vector."},{name:"exp()",value:"exp",def:"exp(v instant-vector)",docText:"Calculates the exponential function for all elements in `v`.\nSpecial cases are:\n* `Exp(+Inf) = +Inf` \n* `Exp(NaN) = NaN`"},{name:"floor()",value:"floor",def:"floor(v instant-vector)",docText:"Rounds the sample values of all elements in `v` down to the nearest integer."},{name:"histogram_quantile()",value:"histogram_quantile",def:"histogram_quantile(φ float, b instant-vector)",docText:"Calculates the φ-quantile (0 ≤ φ ≤ 1) from the buckets `b` of a histogram. The samples in `b` are the counts of observations in each bucket. Each sample must have a label `le` where the label value denotes the inclusive upper bound of the bucket. (Samples without such a label are silently ignored.) The histogram metric type automatically provides time series with the `_bucket` suffix and the appropriate labels."},{name:"holt_winters()",value:"holt_winters",def:"holt_winters(v range-vector, sf scalar, tf scalar)",docText:"Produces a smoothed value for time series based on the range in `v`. The lower the smoothing factor `sf`, the more importance is given to old data. The higher the trend factor `tf`, the more trends in the data is considered. Both `sf` and `tf` must be between 0 and 1."},{name:"hour()",value:"hour",def:"hour(v=vector(time()) instant-vector)",docText:"Returns the hour of the day for each of the given times in UTC. Returned values are from 0 to 23."},{name:"idelta()",value:"idelta",def:"idelta(v range-vector)",docText:"Calculates the difference between the last two samples in the range vector `v`, returning an instant vector with the given deltas and equivalent labels."},{name:"increase()",value:"increase",def:"increase(v range-vector)",docText:"Calculates the increase in the time series in the range vector. Breaks in monotonicity (such as counter resets due to target restarts) are automatically adjusted for. The increase is extrapolated to cover the full time range as specified in the range vector selector, so that it is possible to get a non-integer result even if a counter increases only by integer increments."},{name:"irate()",value:"irate",def:"irate(v range-vector)",docText:"Calculates the per-second instant rate of increase of the time series in the range vector. This is based on the last two data points. Breaks in monotonicity (such as counter resets due to target restarts) are automatically adjusted for."},{name:"label_replace()",value:"label_replace",def:"label_replace(v instant-vector, dst_label string, replacement string, src_label string, regex string)",docText:"For each timeseries in `v`, `label_replace(v instant-vector, dst_label string, replacement string, src_label string, regex string)`  matches the regular expression `regex` against the label `src_label`.  If it matches, then the timeseries is returned with the label `dst_label` replaced by the expansion of `replacement`. `$1` is replaced with the first matching subgroup, `$2` with the second etc. If the regular expression doesn't match then the timeseries is returned unchanged."},{name:"ln()",value:"ln",def:"ln(v instant-vector)",docText:"calculates the natural logarithm for all elements in `v`.\nSpecial cases are:\n * `ln(+Inf) = +Inf`\n * `ln(0) = -Inf`\n * `ln(x < 0) = NaN`\n * `ln(NaN) = NaN`"},{name:"log2()",value:"log2",def:"log2(v instant-vector)",docText:"Calculates the binary logarithm for all elements in `v`. The special cases are equivalent to those in `ln`."},{name:"log10()",value:"log10",def:"log10(v instant-vector)",docText:"Calculates the decimal logarithm for all elements in `v`. The special cases are equivalent to those in `ln`."},{name:"minute()",value:"minute",def:"minute(v=vector(time()) instant-vector)",docText:"Returns the minute of the hour for each of the given times in UTC. Returned values are from 0 to 59."},{name:"month()",value:"month",def:"month(v=vector(time()) instant-vector)",docText:"Returns the month of the year for each of the given times in UTC. Returned values are from 1 to 12, where 1 means January etc."},{name:"predict_linear()",value:"predict_linear",def:"predict_linear(v range-vector, t scalar)",docText:"Predicts the value of time series `t` seconds from now, based on the range vector `v`, using simple linear regression."},{name:"rate()",value:"rate",def:"rate(v range-vector)",docText:"Calculates the per-second average rate of increase of the time series in the range vector. Breaks in monotonicity (such as counter resets due to target restarts) are automatically adjusted for. Also, the calculation extrapolates to the ends of the time range, allowing for missed scrapes or imperfect alignment of scrape cycles with the range's time period."},{name:"resets()",value:"resets",def:"resets(v range-vector)",docText:"For each input time series, `resets(v range-vector)` returns the number of counter resets within the provided time range as an instant vector. Any decrease in the value between two consecutive samples is interpreted as a counter reset."},{name:"round()",value:"round",def:"round(v instant-vector, to_nearest=1 scalar)",docText:"Rounds the sample values of all elements in `v` to the nearest integer. Ties are resolved by rounding up. The optional `to_nearest` argument allows specifying the nearest multiple to which the sample values should be rounded. This multiple may also be a fraction."},{name:"scalar()",value:"scalar",def:"scalar(v instant-vector)",docText:"Given a single-element input vector, `scalar(v instant-vector)` returns the sample value of that single element as a scalar. If the input vector does not have exactly one element, `scalar` will return `NaN`."},{name:"sort()",value:"sort",def:"sort(v instant-vector)",docText:"Returns vector elements sorted by their sample values, in ascending order."},{name:"sort_desc()",value:"sort_desc",def:"sort_desc(v instant-vector)",docText:"Returns vector elements sorted by their sample values, in descending order."},{name:"sqrt()",value:"sqrt",def:"sqrt(v instant-vector)",docText:"Calculates the square root of all elements in `v`."},{name:"time()",value:"time",def:"time()",docText:"Returns the number of seconds since January 1, 1970 UTC. Note that this does not actually return the current time, but the time at which the expression is to be evaluated."},{name:"vector()",value:"vector",def:"vector(s scalar)",docText:"Returns the scalar `s` as a vector with no labels."},{name:"year()",value:"year",def:"year(v=vector(time()) instant-vector)",docText:"Returns the year for each of the given times in UTC."},{name:"avg_over_time()",value:"avg_over_time",def:"avg_over_time(range-vector)",docText:"The average value of all points in the specified interval."},{name:"min_over_time()",value:"min_over_time",def:"min_over_time(range-vector)",docText:"The minimum value of all points in the specified interval."},{name:"max_over_time()",value:"max_over_time",def:"max_over_time(range-vector)",docText:"The maximum value of all points in the specified interval."},{name:"sum_over_time()",value:"sum_over_time",def:"sum_over_time(range-vector)",docText:"The sum of all values in the specified interval."},{name:"count_over_time()",value:"count_over_time",def:"count_over_time(range-vector)",docText:"The count of all values in the specified interval."},{name:"quantile_over_time()",value:"quantile_over_time",def:"quantile_over_time(scalar, range-vector)",docText:"The φ-quantile (0 ≤ φ ≤ 1) of the values in the specified interval."},{name:"stddev_over_time()",value:"stddev_over_time",def:"stddev_over_time(range-vector)",docText:"The population standard deviation of the values in the specified interval."},{name:"stdvar_over_time()",value:"stdvar_over_time",def:"stdvar_over_time(range-vector)",docText:"The population standard variance of the values in the specified interval."}].map(function(t){return{caption:t.name,value:t.value,docHTML:function(t){var e=r.escapeHTML(t.docText);return e=function(t){return t=(t=t.replace(/```(.+)```/,"<pre>$1</pre>")).replace(/`([^`]+)`/,"<code>$1</code>")}(function(t,e){for(var a=[],r=0,n=0,i=e=e||60,s="",o=0;o<t.length;o++)" "===t[o]?r=o:o>=i&&0!=r&&(s=t.slice(n,r),a.push(s),n=r+1,i=o+e,r=0);return s=t.slice(n),a.push(s),a.join("&nbsp<br>")}(e,40)),["<b>",r.escapeHTML(t.def),"</b>","<hr></hr>",e,"<br>&nbsp"].join("")}(t),meta:"function",score:Number.MAX_VALUE}}),s=function(){};(function(){this.getCompletions=function(t,e,a,r,s){var o=e.getTokenAt(a.row,a.column);if("entity.name.tag.label-matcher"===o.type||"string.quoted.label-matcher"===o.type||"entity.name.tag.label-list-matcher"===o.type)return s(null,[]);s(null,n.concat(i))}}).call(s.prototype),e.PrometheusCompletions=s}),ace.define("ace/mode/behaviour/prometheus",["require","exports","module","ace/lib/oop","ace/mode/behaviour","ace/mode/behaviour/cstyle","ace/token_iterator"],function(t,e,a){"use strict";var r=t("../../lib/oop"),n=(t("../behaviour").Behaviour,t("./cstyle").CstyleBehaviour);t("../../token_iterator").TokenIterator;var i=function(){this.inherit(n),this.add("braces","insertion",function(t,e,a,r,i){if("{"==i){var s=a.getSelectionRange(),o=r.doc.getTextRange(s);if(""!==o&&a.getWrapBehavioursEnabled())return function(t,e,a,r){var n=t.end.row-t.start.row;return{text:a+e+r,selection:[0,t.start.column+1,n,t.end.column+(n?0:1)]}}(s,o,"{","}");if(n.isSaneInsertion(a,r))return{text:"{}",selection:[1,1]}}else if("}"==i){var l=a.getCursorPosition(),u=r.doc.getLine(l.row);if("}"==u.substring(l.column,l.column+1))if(null!==r.$findOpeningBracket("}",{column:l.column+1,row:l.row})&&n.isAutoInsertedClosing(l,u,i))return{text:"",selection:[1,1]}}}),this.add("braces","deletion",function(t,e,a,r,n){var i=r.doc.getTextRange(n);if(!n.isMultiLine()&&"{"==i&&"}"==r.doc.getLine(n.start.row).substring(n.start.column+1,n.start.column+2))return n.end.column++,n})};r.inherits(i,n),e.PrometheusBehaviour=i}),ace.define("ace/mode/prometheus",["require","exports","module","ace/lib/oop","ace/mode/text","ace/mode/prometheus_highlight_rules"],function(t,e,a){"use strict";var r=t("../lib/oop"),n=t("./text").Mode,i=t("./prometheus_highlight_rules").PrometheusHighlightRules,s=t("./prometheus_completions").PrometheusCompletions,o=t("./behaviour/prometheus").PrometheusBehaviour,l=function(){this.HighlightRules=i,this.$behaviour=new o,this.$completer=new s,this.completer=this.$completer};r.inherits(l,n),function(){this.$id="ace/mode/prometheus"}.call(l.prototype),e.Mode=l})},1222:function(t,e){ace.define("ace/snippets/prometheus",["require","exports","module"],function(t,e,a){"use strict";e.snippets=[{content:"rate(${1:metric}[${2:range}])",name:"rate()",scope:"prometheus",tabTrigger:"r"}],e.scope="prometheus"})},1223:function(t,e){!function(t){var e=10,a=.95;var r={series:{pie:{show:!1,radius:"auto",innerRadius:0,startAngle:1.5,tilt:1,shadow:{left:5,top:15,alpha:.02},offset:{top:0,left:"auto"},stroke:{color:"#fff",width:1},label:{show:"auto",formatter:function(t,e){return"<div style='font-size:x-small;text-align:center;padding:2px;color:"+e.color+";'>"+t+"<br/>"+Math.round(e.percent)+"%</div>"},radius:1,background:{color:null,opacity:0},threshold:0},combine:{threshold:-1,color:null,label:"Other"},highlight:{opacity:.5}}}};t.plot.plugins.push({init:function(n){var i=null,s=null,o=null,l=null,u=null,c=!1,h=null,p=[];function d(e,a,n){c||(c=!0,i=e.getCanvas(),s=t(i).parent(),r=e.getOptions(),e.setData(function(e){for(var a=0,n=0,i=0,s=r.series.pie.combine.color,o=[],l=0;l<e.length;++l){var u=e[l].data;t.isArray(u)&&1==u.length&&(u=u[0]),t.isArray(u)?!isNaN(parseFloat(u[1]))&&isFinite(u[1])?u[1]=+u[1]:u[1]=0:u=!isNaN(parseFloat(u))&&isFinite(u)?[1,+u]:[1,0],e[l].data=[u]}for(var l=0;l<e.length;++l)a+=e[l].data[0][1];for(var l=0;l<e.length;++l){var u=e[l].data[0][1];u/a<=r.series.pie.combine.threshold&&(n+=u,i++,s||(s=e[l].color))}for(var l=0;l<e.length;++l){var u=e[l].data[0][1];(i<2||u/a>r.series.pie.combine.threshold)&&o.push({data:[[1,u]],color:e[l].color,label:e[l].label,angle:u*Math.PI*2/a,percent:u/(a/100)})}return i>1&&o.push({data:[[1,n]],color:s,label:r.series.pie.combine.label,angle:n*Math.PI*2/a,percent:n/(a/100)}),o}(e.getData())))}function m(n,i){if(s){var p=n.getPlaceholder().width(),d=n.getPlaceholder().height(),m=s.children().filter(".legend").children().width()||0;h=i,c=!1,o=Math.min(p,d/r.series.pie.tilt)/2,u=d/2+r.series.pie.offset.top,l=p/2,"auto"==r.series.pie.offset.left?r.legend.position.match("w")?l+=m/2:l-=m/2:l+=r.series.pie.offset.left,l<o?l=o:l>p-o&&(l=p-o);var g=n.getData(),v=0;do{v>0&&(o*=a),v+=1,y(),r.series.pie.tilt<=.8&&b()}while(!S()&&v<e);v>=e&&(y(),s.prepend("<div class='error'>Could not draw pie with labels contained inside canvas</div>")),n.setSeries&&n.insertLegend&&(n.setSeries(g),n.insertLegend())}function y(){h.clearRect(0,0,p,d),s.children().filter(".pieLabel, .pieLabelBackground").remove()}function b(){var t=r.series.pie.shadow.left,e=r.series.pie.shadow.top,a=r.series.pie.shadow.alpha,n=r.series.pie.radius>1?r.series.pie.radius:o*r.series.pie.radius;if(!(n>=p/2-t||n*r.series.pie.tilt>=d/2-e||n<=10)){h.save(),h.translate(t,e),h.globalAlpha=a,h.fillStyle="#000",h.translate(l,u),h.scale(1,r.series.pie.tilt);for(var i=1;i<=10;i++)h.beginPath(),h.arc(0,0,n,0,2*Math.PI,!1),h.fill(),n-=i;h.restore()}}function S(){var e=Math.PI*r.series.pie.startAngle,a=r.series.pie.radius>1?r.series.pie.radius:o*r.series.pie.radius;h.save(),h.translate(l,u),h.scale(1,r.series.pie.tilt),h.save();for(var n=e,i=0;i<g.length;++i)g[i].startAngle=n,c(g[i].angle,g[i].color,!0);if(h.restore(),r.series.pie.stroke.width>0){for(h.save(),h.lineWidth=r.series.pie.stroke.width,n=e,i=0;i<g.length;++i)c(g[i].angle,r.series.pie.stroke.color,!1);h.restore()}return f(h),h.restore(),!r.series.pie.label.show||function(){for(var a=e,n=r.series.pie.label.radius>1?r.series.pie.label.radius:o*r.series.pie.label.radius,i=0;i<g.length;++i){if(g[i].percent>=100*r.series.pie.label.threshold&&!c(g[i],a,i))return!1;a+=g[i].angle}return!0;function c(e,a,i){if(0==e.data[0][1])return!0;var o,c=r.legend.labelFormatter,h=r.series.pie.label.formatter;o=c?c(e.label,e):e.label,h&&(o=h(o,e));var m=(a+e.angle+a)/2,f=l+Math.round(Math.cos(m)*n),g=u+Math.round(Math.sin(m)*n)*r.series.pie.tilt,v="<span class='pieLabel' id='pieLabel"+i+"' style='position:absolute;top:"+g+"px;left:"+f+"px;'>"+o+"</span>";s.append(v);var y=s.children("#pieLabel"+i),b=g-y.height()/2,S=f-y.width()/2;if(y.css("top",b),y.css("left",S),0-b>0||0-S>0||d-(b+y.height())<0||p-(S+y.width())<0)return!1;if(0!=r.series.pie.label.background.opacity){var x=r.series.pie.label.background.color;null==x&&(x=e.color);var w="top:"+b+"px;left:"+S+"px;";t("<div class='pieLabelBackground' style='position:absolute;width:"+y.width()+"px;height:"+y.height()+"px;"+w+"background-color:"+x+";'></div>").css("opacity",r.series.pie.label.background.opacity).insertBefore(y)}return!0}}();function c(t,e,r){t<=0||isNaN(t)||(r?h.fillStyle=e:(h.strokeStyle=e,h.lineJoin="round"),h.beginPath(),Math.abs(t-2*Math.PI)>1e-9&&h.moveTo(0,0),h.arc(0,0,a,n,n+t/2,!1),h.arc(0,0,a,n+t/2,n+t,!1),h.closePath(),n+=t,r?h.fill():h.stroke())}}}function f(t){if(r.series.pie.innerRadius>0){t.save();var e=r.series.pie.innerRadius>1?r.series.pie.innerRadius:o*r.series.pie.innerRadius;t.globalCompositeOperation="destination-out",t.beginPath(),t.fillStyle=r.series.pie.stroke.color,t.arc(0,0,e,0,2*Math.PI,!1),t.fill(),t.closePath(),t.restore(),t.save(),t.beginPath(),t.strokeStyle=r.series.pie.stroke.color,t.arc(0,0,e,0,2*Math.PI,!1),t.stroke(),t.closePath(),t.restore()}}function g(t,e){for(var a=!1,r=-1,n=t.length,i=n-1;++r<n;i=r)(t[r][1]<=e[1]&&e[1]<t[i][1]||t[i][1]<=e[1]&&e[1]<t[r][1])&&e[0]<(t[i][0]-t[r][0])*(e[1]-t[r][1])/(t[i][1]-t[r][1])+t[r][0]&&(a=!a);return a}function v(t){b("plothover",t)}function y(t){b("plotclick",t)}function b(t,e){var a=n.offset(),i=function(t,e){for(var a,r,i=n.getData(),s=n.getOptions(),c=s.series.pie.radius>1?s.series.pie.radius:o*s.series.pie.radius,p=0;p<i.length;++p){var d=i[p];if(d.pie.show){if(h.save(),h.beginPath(),h.moveTo(0,0),h.arc(0,0,c,d.startAngle,d.startAngle+d.angle/2,!1),h.arc(0,0,c,d.startAngle+d.angle/2,d.startAngle+d.angle,!1),h.closePath(),a=t-l,r=e-u,h.isPointInPath){if(h.isPointInPath(t-l,e-u))return h.restore(),{datapoint:[d.percent,d.data],dataIndex:0,series:d,seriesIndex:p}}else if(g([[0,0],[c*Math.cos(d.startAngle),c*Math.sin(d.startAngle)],[c*Math.cos(d.startAngle+d.angle/4),c*Math.sin(d.startAngle+d.angle/4)],[c*Math.cos(d.startAngle+d.angle/2),c*Math.sin(d.startAngle+d.angle/2)],[c*Math.cos(d.startAngle+d.angle/1.5),c*Math.sin(d.startAngle+d.angle/1.5)],[c*Math.cos(d.startAngle+d.angle),c*Math.sin(d.startAngle+d.angle)]],[a,r]))return h.restore(),{datapoint:[d.percent,d.data],dataIndex:0,series:d,seriesIndex:p};h.restore()}}return null}(parseInt(e.pageX-a.left),parseInt(e.pageY-a.top));if(r.grid.autoHighlight)for(var c=0;c<p.length;++c){var d=p[c];d.auto!=t||i&&d.series==i.series||S(d.series)}i&&function(t,e){var a=x(t);-1==a?(p.push({series:t,auto:e}),n.triggerRedrawOverlay()):e||(p[a].auto=!1)}(i.series,t);var m={pageX:e.pageX,pageY:e.pageY};s.trigger(t,[m,i])}function S(t){null==t&&(p=[],n.triggerRedrawOverlay());var e=x(t);-1!=e&&(p.splice(e,1),n.triggerRedrawOverlay())}function x(t){for(var e=0;e<p.length;++e)if(p[e].series==t)return e;return-1}n.hooks.processOptions.push(function(t,e){e.series.pie.show&&(e.grid.show=!1,"auto"==e.series.pie.label.show&&(e.legend.show?e.series.pie.label.show=!1:e.series.pie.label.show=!0),"auto"==e.series.pie.radius&&(e.series.pie.label.show?e.series.pie.radius=.75:e.series.pie.radius=1),e.series.pie.tilt>1?e.series.pie.tilt=1:e.series.pie.tilt<0&&(e.series.pie.tilt=0))}),n.hooks.bindEvents.push(function(t,e){var a=t.getOptions();a.series.pie.show&&(a.grid.hoverable&&e.unbind("mousemove").mousemove(v),a.grid.clickable&&e.unbind("click").click(y))}),n.hooks.processDatapoints.push(function(t,e,a,r){t.getOptions().series.pie.show&&d(t)}),n.hooks.drawOverlay.push(function(t,e){t.getOptions().series.pie.show&&function(t,e){var a=t.getOptions(),r=a.series.pie.radius>1?a.series.pie.radius:o*a.series.pie.radius;e.save(),e.translate(l,u),e.scale(1,a.series.pie.tilt);for(var n=0;n<p.length;++n)i(p[n].series);function i(t){t.angle<=0||isNaN(t.angle)||(e.fillStyle="rgba(255, 255, 255, "+a.series.pie.highlight.opacity+")",e.beginPath(),Math.abs(t.angle-2*Math.PI)>1e-9&&e.moveTo(0,0),e.arc(0,0,r,t.startAngle,t.startAngle+t.angle/2,!1),e.arc(0,0,r,t.startAngle+t.angle/2,t.startAngle+t.angle,!1),e.closePath(),e.fill())}f(e),e.restore()}(t,e)}),n.hooks.draw.push(function(t,e){t.getOptions().series.pie.show&&m(t,e)})},options:r,name:"pie",version:"1.1"})}(jQuery)},1233:function(t,e,a){"use strict";K.$inject=["$sanitize","dashboardSrv","contextSrv","$compile"],Le.$inject=["instanceSettings","$q","backendSrv","templateSrv"],He.$inject=["$compile"],ze.$inject=["$compile","templateSrv","popoverSrv"],cn.$inject=["element","event","plot"],pn.$inject=["element","event","plot"],gn.$inject=["plot"],Tn.$inject=["timeSrv","popoverSrv","contextSrv"],$n.$inject=["$scope","$element","popoverSrv"],xi.$inject=["$q","uiSegmentSrv"],ki.$inject=["$q","uiSegmentSrv"],ji.$inject=["$compile","datasourceSrv","$rootScope","$q","$http","$templateCache"],es.$inject=["$scope","$rootScope","$location","$timeout","timeSrv","templateSrv","linkSrv"],ss.$inject=["$location","$timeout","$rootScope"],ps.$inject=["$rootScope","$q","$location","$timeout","contextSrv","dashboardSrv","$window"],vs.$inject=["timer","alertSrv","$location"],Cs.$inject=["variableSrv"],Ws.$inject=["$compile","$sanitize","linkSrv"],so.$inject=["$routeProvider"],uo.$inject=["$compile"],po.$inject=["dynamicDirectiveSrv"],a.r(e);var r={};a.r(r),a.d(r,"PanelCtrl",function(){return qt}),a.d(r,"MetricsPanelCtrl",function(){return Bt}),a.d(r,"QueryCtrl",function(){return Qt}),a.d(r,"alertTab",function(){return Wt}),a.d(r,"loadPluginCss",function(){return Ni});var n={};a.r(n),a.d(n,"convertSeriesListToCsv",function(){return Se}),a.d(n,"exportSeriesListToCsv",function(){return xe}),a.d(n,"convertSeriesListToCsvColumns",function(){return we}),a.d(n,"exportSeriesListToCsvColumns",function(){return ke}),a.d(n,"convertTableDataToCsv",function(){return Ce}),a.d(n,"exportTableDataToCsv",function(){return Te}),a.d(n,"saveSaveBlob",function(){return _e});var i={};a.r(i),a.d(i,"default",function(){return Me});var s={};a.r(s),a.d(s,"Datasource",function(){return Le}),a.d(s,"QueryCtrl",function(){return na}),a.d(s,"ConfigCtrl",function(){return sa}),a.d(s,"AnnotationsQueryCtrl",function(){return oa});var o={};a.r(o),a.d(o,"Datasource",function(){return ca}),a.d(o,"QueryCtrl",function(){return ha}),a.d(o,"ConfigCtrl",function(){return pa}),a.d(o,"AnnotationsQueryCtrl",function(){return da});var l={};a.r(l),a.d(l,"Datasource",function(){return Da}),a.d(l,"QueryCtrl",function(){return Ra}),a.d(l,"ConfigCtrl",function(){return Na}),a.d(l,"AnnotationsQueryCtrl",function(){return Va});var u={};a.r(u),a.d(u,"Datasource",function(){return La}),a.d(u,"QueryCtrl",function(){return ja}),a.d(u,"ConfigCtrl",function(){return Ua}),a.d(u,"AnnotationsQueryCtrl",function(){return Ba});var c={};a.r(c),a.d(c,"GrafanaDatasource",function(){return Qa}),a.d(c,"Datasource",function(){return Qa}),a.d(c,"QueryCtrl",function(){return Ha}),a.d(c,"AnnotationsQueryCtrl",function(){return za});var h={};a.r(h),a.d(h,"Datasource",function(){return lr}),a.d(h,"QueryCtrl",function(){return ur}),a.d(h,"ConfigCtrl",function(){return cr}),a.d(h,"AnnotationsQueryCtrl",function(){return hr});var p={};a.r(p),a.d(p,"LoggingConfigCtrl",function(){return gr}),a.d(p,"Datasource",function(){return fr}),a.d(p,"ConfigCtrl",function(){return gr});var d={};a.r(d),a.d(d,"MixedDatasource",function(){return vr}),a.d(d,"Datasource",function(){return vr});var m={};a.r(m),a.d(m,"MysqlDatasource",function(){return br}),a.d(m,"Datasource",function(){return br}),a.d(m,"QueryCtrl",function(){return xr}),a.d(m,"ConfigCtrl",function(){return wr}),a.d(m,"AnnotationsQueryCtrl",function(){return Cr});var f={};a.r(f),a.d(f,"PostgresDatasource",function(){return Mr}),a.d(f,"Datasource",function(){return Mr}),a.d(f,"QueryCtrl",function(){return Or}),a.d(f,"ConfigCtrl",function(){return qr}),a.d(f,"AnnotationsQueryCtrl",function(){return Nr});var g={};a.r(g),a.d(g,"Datasource",function(){return Yr}),a.d(g,"QueryCtrl",function(){return Gr}),a.d(g,"ConfigCtrl",function(){return Kr}),a.d(g,"AnnotationsQueryCtrl",function(){return Jr});var v={};a.r(v),a.d(v,"MssqlDatasource",function(){return Zr}),a.d(v,"Datasource",function(){return Zr}),a.d(v,"QueryCtrl",function(){return en}),a.d(v,"ConfigCtrl",function(){return an}),a.d(v,"AnnotationsQueryCtrl",function(){return nn});var y={};a.r(y),a.d(y,"TestDataDatasource",function(){return sn}),a.d(y,"Datasource",function(){return sn}),a.d(y,"QueryCtrl",function(){return on}),a.d(y,"AnnotationsQueryCtrl",function(){return ln});var b={};a.r(b),a.d(b,"TextPanelCtrl",function(){return un}),a.d(b,"PanelCtrl",function(){return un});var S={};a.r(S),a.d(S,"GraphCtrl",function(){return Fn}),a.d(S,"PanelCtrl",function(){return Fn});var x={};a.r(x),a.d(x,"DashListCtrl",function(){return In}),a.d(x,"PanelCtrl",function(){return In});var w={};a.r(w),a.d(w,"PluginListCtrl",function(){return On}),a.d(w,"PanelCtrl",function(){return On});var k={};a.r(k),a.d(k,"AlertListPanel",function(){return qn}),a.d(k,"PanelCtrl",function(){return qn});var C={};a.r(C),a.d(C,"PanelCtrl",function(){return yi});var T={};a.r(T),a.d(T,"TablePanelCtrl",function(){return Ti}),a.d(T,"PanelCtrl",function(){return Ti});var _={};a.r(_),a.d(_,"SingleStatCtrl",function(){return Mi}),a.d(_,"PanelCtrl",function(){return Mi}),a.d(_,"getColorForValue",function(){return $i});var M={};a.r(M),a.d(M,"GettingStartedPanelCtrl",function(){return Pi}),a.d(M,"PanelCtrl",function(){return Pi});var $=a(14),P=a.n($),E=a(2),A=a.n(E),D=a(12),F=a.n(D),I=a(6),O=function(){function t(t,e){this.datasourceSrv=e,this.annotationDefaults={name:"",datasource:null,iconColor:"rgba(255, 96, 96, 1)",enable:!0,showIn:0,hide:!1},this.showOptions=[{text:"所有面板",value:0},{text:"指定面板",value:1}],t.ctrl=this,this.mode="list",this.datasources=e.getAnnotationSources(),this.annotations=t.dashboard.annotations.list,this.reset(),this.onColorChange=this.onColorChange.bind(this)}return t.$inject=["$scope","datasourceSrv"],t.prototype.datasourceChanged=function(){var t=this;return this.datasourceSrv.get(this.currentAnnotation.datasource).then(function(e){t.currentDatasource=e})},t.prototype.edit=function(t){this.currentAnnotation=t,this.currentAnnotation.showIn=this.currentAnnotation.showIn||0,this.currentIsNew=!1,this.datasourceChanged(),this.mode="edit",F()(".tooltip.in").remove()},t.prototype.reset=function(){this.currentAnnotation=P.a.copy(this.annotationDefaults),this.currentAnnotation.datasource=this.datasources[0].name,this.currentIsNew=!0,this.datasourceChanged()},t.prototype.update=function(){this.reset(),this.mode="list"},t.prototype.setupNew=function(){this.mode="new",this.reset()},t.prototype.backToList=function(){this.mode="list"},t.prototype.move=function(t,e){A.a.move(this.annotations,t,t+e)},t.prototype.add=function(){this.annotations.push(this.currentAnnotation),this.reset(),this.mode="list"},t.prototype.removeAnnotation=function(t){var e=A.a.indexOf(this.annotations,t);this.annotations.splice(e,1)},t.prototype.onColorChange=function(t){this.currentAnnotation.iconColor=t},t}();function q(t,e){var a=A.a.partition(t,"regionId"),r=a[0],n=a[1],i=function(t,e){var a=A.a.filter(t,function(t){return t.regionId}),r=A.a.groupBy(a,"regionId");return r=A.a.compact(A.a.map(r,function(t){var a=A.a.head(t);return t&&t.length>1?(a.timeEnd=t[1].time,a.isRegion=!0,a):t&&t.length?(a.time&&a.timeEnd||(function(t){return t.id&&t.id===t.regionId}(a)?a.timeEnd=e.to.valueOf()-1:(a.timeEnd=a.time,a.time=e.from.valueOf()+1),a.isRegion=!0),a):void 0}))}(r,e.range);return t=A.a.concat(i,n)}function R(t){return"panel-alert"===t.eventType}I.a.controller("AnnotationsEditorCtrl",O);var N=function(){function t(t,e,a,r,n){this.$rootScope=t,this.$q=e,this.datasourceSrv=a,this.backendSrv=r,this.timeSrv=n,t.onAppEvent("refresh",this.clearCache.bind(this),t),t.onAppEvent("dashboard-initialized",this.clearCache.bind(this),t)}return t.$inject=["$rootScope","$q","datasourceSrv","backendSrv","timeSrv"],t.prototype.clearCache=function(){this.globalAnnotationsPromise=null,this.alertStatesPromise=null},t.prototype.getAnnotations=function(t){var e=this;return this.$q.all([this.getGlobalAnnotations(t),this.getAlertStates(t)]).then(function(e){var a=A.a.flattenDeep(e[0]);return{annotations:a=q(a=function(t){var e=[],a=A.a.partition(t,"id"),r=A.a.groupBy(a[0],"id");return e=A.a.map(r,function(t){return t.length>1&&!A.a.every(t,R)?A.a.find(t,function(t){return"panel-alert"!==t.eventType}):A.a.head(t)}),e=A.a.concat(e,a[1])}(a=A.a.filter(a,function(e){return!e.panelId||"dashboard"!==e.source.type||e.panelId===t.panel.id})),t),alertState:A.a.find(e[1],{panelId:t.panel.id})}}).catch(function(t){return!t.message&&t.data&&t.data.message&&(t.message=t.data.message),console.log("AnnotationSrv.query error",t),e.$rootScope.appEvent("alert-error",["注释查询失败",t.message||t]),[]})},t.prototype.getAlertStates=function(t){return t.dashboard.id?t.panel&&!t.panel.alert?this.$q.when([]):"now"!==t.range.raw.to?this.$q.when([]):this.alertStatesPromise?this.alertStatesPromise:(this.alertStatesPromise=this.backendSrv.get("/api/alerts/states-for-dashboard",{dashboardId:t.dashboard.id}),this.alertStatesPromise):this.$q.when([])},t.prototype.getGlobalAnnotations=function(t){var e=this,a=t.dashboard;if(this.globalAnnotationsPromise)return this.globalAnnotationsPromise;for(var r=this.timeSrv.timeRange(),n=[],i=function(t){return t.enable?t.snapshotData?{value:s.translateQueryResult(t,t.snapshotData)}:void n.push(s.datasourceSrv.get(t.datasource).then(function(e){return e.annotationQuery({range:r,rangeRaw:r.raw,annotation:t,dashboard:a})}).then(function(r){return a.snapshot&&(t.snapshotData=P.a.copy(r)),e.translateQueryResult(t,r)})):"continue"},s=this,o=0,l=a.annotations.list;o<l.length;o++){var u=i(l[o]);if("object"==typeof u)return u.value}return this.globalAnnotationsPromise=this.$q.all(n),this.globalAnnotationsPromise},t.prototype.saveAnnotationEvent=function(t){return this.globalAnnotationsPromise=null,this.backendSrv.post("/api/annotations",t)},t.prototype.updateAnnotationEvent=function(t){return this.globalAnnotationsPromise=null,this.backendSrv.put("/api/annotations/"+t.id,t)},t.prototype.deleteAnnotationEvent=function(t){this.globalAnnotationsPromise=null;var e="/api/annotations/"+t.id;return t.isRegion&&(e="/api/annotations/region/"+t.regionId),this.backendSrv.delete(e)},t.prototype.translateQueryResult=function(t,e){t.snapshotData&&delete(t=P.a.copy(t)).snapshotData;for(var a=0,r=e;a<r.length;a++){r[a].source=t}return e},t}();I.a.service("annotationsSrv",N);var V=a(4),L=a.n(V),j=a(144),U=function(){function t(t){this.annotationsSrv=t,this.event.panelId=this.panelCtrl.panel.id,this.event.dashboardId=this.panelCtrl.dashboard.id,this.event.time=B(this.event.time),this.event.isRegion&&(this.event.timeEnd=B(this.event.timeEnd)),this.timeFormated=this.panelCtrl.dashboard.formatDate(this.event.time)}return t.$inject=["annotationsSrv"],t.prototype.save=function(){var t=this;if(this.form.$valid){var e=A.a.cloneDeep(this.event);e.time=e.time.valueOf(),e.timeEnd=0,e.isRegion&&(e.timeEnd=this.event.timeEnd.valueOf(),e.timeEnd<e.time)?console.log("invalid time"):e.id?this.annotationsSrv.updateAnnotationEvent(e).then(function(){t.panelCtrl.refresh(),t.close()}).catch(function(){t.panelCtrl.refresh(),t.close()}):this.annotationsSrv.saveAnnotationEvent(e).then(function(){t.panelCtrl.refresh(),t.close()}).catch(function(){t.panelCtrl.refresh(),t.close()})}},t.prototype.delete=function(){var t=this;return this.annotationsSrv.deleteAnnotationEvent(this.event).then(function(){t.panelCtrl.refresh(),t.close()}).catch(function(){t.panelCtrl.refresh(),t.close()})},t}();function B(t){if(t&&A.a.isNumber(t)){var e=Number(t);return L()(e)}return t}j.d.directive("eventEditor",function(){return{restrict:"E",controller:U,bindToController:!0,controllerAs:"ctrl",templateUrl:"public/app/features/annotations/partials/event_editor.html",scope:{panelCtrl:"=",event:"=",close:"&"}}});var Q=a(130),H=a.n(Q),z=function(){return function(){}}(),Y=a(83),W=function(){function t(t){this.panelCtrl=t}return t.prototype.editorClosed=function(){this.event=null,this.editorOpen=!1,this.panelCtrl.render()},t.prototype.editorOpened=function(){this.editorOpen=!0},t.prototype.updateTime=function(t){this.event||(this.event=new z,this.event.dashboardId=this.panelCtrl.dashboard.id,this.event.panelId=this.panelCtrl.panel.id),this.event.time=L()(t.from),this.event.isRegion=!1,t.to&&(this.event.timeEnd=L()(t.to),this.event.isRegion=!0),this.panelCtrl.render()},t.prototype.editEvent=function(t,e){this.event=t,this.panelCtrl.render()},t.prototype.addFlotEvents=function(t,e){if(this.event||0!==t.length){var a={$__alerting:{color:Y.a,position:"BOTTOM",markerSize:5},$__ok:{color:Y.d,position:"BOTTOM",markerSize:5},$__no_data:{color:Y.c,position:"BOTTOM",markerSize:5},$__editing:{color:Y.b,position:"BOTTOM",markerSize:5}};if(this.event)t=this.event.isRegion?[{isRegion:!0,min:this.event.time.valueOf(),timeEnd:this.event.timeEnd.valueOf(),text:this.event.text,eventType:"$__editing",editModel:this.event}]:[{min:this.event.time.valueOf(),text:this.event.text,editModel:this.event,eventType:"$__editing"}];else for(var r=0;r<t.length;r++){var n=t[r];n.min=n.time,n.max=n.time,n.eventType=n.source.name,n.newState?n.eventType="$__"+n.newState:a[n.source.name]||(a[n.source.name]={color:n.source.iconColor,position:"BOTTOM",markerSize:5})}!function(t,e){var a,r=e.grid.markings,n=Y.b;A.a.each(t,function(t){a=function(t,e){var a=H()(t);return a.isValid()?(a.setAlpha(e),a.toRgbString()):t}(a=t.source&&t.source.iconColor||n,Y.e),r.push({xaxis:{from:t.min,to:t.timeEnd},color:a})})}(function(t){return A.a.filter(t,"isRegion")}(t),e);e.grid.eventSectionHeight=7,e.xaxis.eventSectionHeight=20,e.events={levels:A.a.keys(a).length+1,data:t,types:a,manager:this}}},t}();var G=a(273);function K(t,e,a,r){function n(e){try{return t(e)}catch(t){return console.log("Could not sanitize annotation string, html escaping instead"),A.a.escape(e)}}return{restrict:"E",scope:{event:"=",onEdit:"&"},link:function(t,a){var i=t.event,s=i.title,o=i.text,l=e.getCurrent(),u='<div class="graph-annotation">',c="";if(i.alertId){var h=G.a.getStateDisplayModel(i.newState);c=h.stateClass,s='<i class="icon-gf '+h.iconClass+'"></i> '+h.text,o=G.a.getAlertAnnotationInfo(i),i.text&&(o=o+"<br />"+i.text)}else s&&(o=s+"<br />"+(A.a.isString(o)?o:""),s="");var p='<div class="graph-annotation__header">';i.login&&(p+='<div class="graph-annotation__user" bs-tooltip="\'由'+i.login+'创建\'"><img src="'+i.avatarUrl+'" /></div>'),p+='\n          <span class="graph-annotation__title '+c+'">'+n(s)+'</span>\n          <span class="graph-annotation__time">'+l.formatDate(i.min)+"</span>\n      ",i.id&&l.meta.canEdit&&(p+='\n          <span class="pointer graph-annotation__edit-icon" ng-click="onEdit()">\n            <i class="fa fa-pencil-square"></i>\n          </span>\n        '),u+=p+="</div>",u+='<div class="graph-annotation__body">',o&&(u+="<div>"+n(o.replace(/\n/g,"<br>"))+"</div>");var d=i.tags;d&&d.length&&(t.tags=d,u+='<span class="label label-tag small" ng-repeat="tag in tags" tag-color-from-name="tag">{{tag}}</span><br/>'),u+="</div>",u+="</div>",F()(u).appendTo(a),r(a.contents())(t)}}}I.a.directive("annotationTooltip",K);var J=a(114),X=a(274),Z={};function tt(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var a=t[t.length-1],r=t[0]||"",n=1;n<t.length-1;n++)r+=" "+t[n]||"";return a=J.a.regexEscape(a),null!==new RegExp("\\$("+a+")(?:\\W|$)|\\[\\[("+a+")\\]\\]","g").exec(r)}var et=a(9),at=function(){function t(t,e,a,r){t.variableTypes=Z,t.ctrl={},t.namePattern=/^(?!__).*$/,t._=A.a,t.optionsLimit=20,t.refreshOptions=[{value:0,text:"从不"},{value:1,text:"仪表盘加载时"},{value:2,text:"时间区间改变时"}],t.sortOptions=[{value:0,text:"关闭"},{value:1,text:"按字母顺序排列(升序)"},{value:2,text:"按字母顺序排列(降序)"},{value:3,text:"按数值排列(升序)"},{value:4,text:"按数值排列(降序)"},{value:5,text:"按字母顺序排列(不区分大小写, 升序)"},{value:6,text:"按字母顺序排列(不区分大小写, 降序)"}],t.hideOptions=[{value:0,text:""},{value:1,text:"标签"},{value:2,text:"变量"}],t.init=function(){t.mode="list",t.variables=a.variables,t.reset(),t.$watch("mode",function(e){"new"===e&&t.reset()})},t.setMode=function(e){t.mode=e},t.add=function(){t.isValid()&&(a.addVariable(t.current),t.update())},t.isValid=function(){if(!t.ctrl.form.$valid)return!1;if(!t.current.name.match(/^\w+$/))return et.a.emit("alert-warning",["Validation","变量名中只允许使用单词和数字字符"]),!1;var e=A.a.find(t.variables,{name:t.current.name});return e&&e!==t.current?(et.a.emit("alert-warning",["Validation","已存在同名的变量"]),!1):"query"!==t.current.type||!t.current.query.match(new RegExp("\\$"+t.current.name+"(/| |$)"))||(et.a.emit("alert-warning",["Validation","查询不能包含对自身的引用。 变量: $"+t.current.name]),!1)},t.validate=function(){t.infoText="","adhoc"===t.current.type&&null!==t.current.datasource&&(t.infoText="Adhoc过滤器会自动应用于所有以此数据源为目标的查询",e.get(t.current.datasource).then(function(e){e.getTagKeys||(t.infoText="此数据源尚不支持adhoc过滤器。")}))},t.runQuery=function(){return t.optionsLimit=20,a.updateOptions(t.current).catch(function(t){t.data&&t.data.message&&(t.message=t.data.message),et.a.emit("alert-error",["Templating","无法初始化模板变量: "+t.message])})},t.edit=function(e){t.current=e,t.currentIsNew=!1,t.mode="edit",t.validate()},t.duplicate=function(e){var r=A.a.cloneDeep(e.getSaveModel());t.current=a.createVariableFromModel(r),t.current.name="copy_of_"+e.name,a.addVariable(t.current)},t.update=function(){t.isValid()&&t.runQuery().then(function(){t.reset(),t.mode="list",r.updateTemplateData()})},t.reset=function(){t.currentIsNew=!0,t.current=a.createVariableFromModel({type:"query"}),t.datasources=A.a.filter(e.getMetricSources(),function(t){return!t.meta.mixed&&null!==t.value}),t.datasourceTypes=A()(t.datasources).uniqBy("meta.id").map(function(t){return{text:t.meta.name,value:t.meta.id}}).value()},t.typeChanged=function(){var e=t.current;t.current=a.createVariableFromModel({type:t.current.type}),t.current.name=e.name,t.current.hide=e.hide,t.current.label=e.label;var r=A.a.indexOf(this.variables,e);-1!==r&&(this.variables[r]=t.current),t.validate()},t.removeVariable=function(t){a.removeVariable(t)},t.showMoreOptions=function(){t.optionsLimit+=20}}return t.$inject=["$scope","datasourceSrv","variableSrv","templateSrv"],t}();function rt(t){return t.replace(/([\!\*\+\-\=<>\s\&\|\(\)\[\]\{\}\^\~\?\:\\/"])/g,"\\$1")}I.a.controller("VariableEditorCtrl",at);var nt=new(function(){function t(){this.regex=/\$(\w+)|\[\[([\s\S]+?)(?::(\w+))?\]\]|\${(\w+)(?::(\w+))?}/g,this.index={},this.grafanaVariables={},this.builtIns={},this.builtIns.__interval={text:"1s",value:"1s"},this.builtIns.__interval_ms={text:"100",value:"100"}}return t.prototype.init=function(t){this.variables=t,this.updateTemplateData()},t.prototype.updateTemplateData=function(){this.index={};for(var t=0;t<this.variables.length;t++){var e=this.variables[t];e.current&&(e.current.isNone||e.current.value)&&(this.index[e.name]=e)}},t.prototype.variableInitialized=function(t){this.index[t.name]=t},t.prototype.getAdhocFilters=function(t){for(var e=[],a=0;a<this.variables.length;a++){var r=this.variables[a];"adhoc"===r.type&&(r.datasource===t&&(e=e.concat(r.filters)),0===r.datasource.indexOf("$")&&this.replace(r.datasource)===t&&(e=e.concat(r.filters)))}return e},t.prototype.luceneFormat=function(t){return"string"==typeof t?rt(t):t instanceof Array&&0===t.length?"__empty__":"("+A.a.map(t,function(t){return'"'+rt(t)+'"'}).join(" OR ")+")"},t.prototype.formatValue=function(t,e,a){if(a=a||{},"function"==typeof e)return e(t,a,this.formatValue);switch(e){case"regex":if("string"==typeof t)return J.a.regexEscape(t);var r=A.a.map(t,J.a.regexEscape);return 1===r.length?r[0]:"("+r.join("|")+")";case"lucene":return this.luceneFormat(t);case"pipe":return"string"==typeof t?t:t.join("|");case"distributed":return"string"==typeof t?t:this.distributeVariable(t,a.name);case"csv":return A.a.isArray(t)?t.join(","):t;default:return A.a.isArray(t)?"{"+t.join(",")+"}":t}},t.prototype.setGrafanaVariable=function(t,e){this.grafanaVariables[t]=e},t.prototype.getVariableName=function(t){this.regex.lastIndex=0;var e=this.regex.exec(t);return e?e[1]||e[2]:null},t.prototype.variableExists=function(t){var e=this.getVariableName(t);return e&&void 0!==this.index[e]},t.prototype.highlightVariablesAsHtml=function(t){var e=this;return t&&A.a.isString(t)?(t=A.a.escape(t),this.regex.lastIndex=0,t.replace(this.regex,function(t,a,r,n,i){return e.index[a||r||i]||e.builtIns[a||r||i]?'<span class="template-variable">'+t+"</span>":t})):t},t.prototype.getAllValue=function(t){if(t.allValue)return t.allValue;for(var e=[],a=1;a<t.options.length;a++)e.push(t.options[a].value);return e},t.prototype.replace=function(t,e,a){var r,n,i,s,o=this;return t?(this.regex.lastIndex=0,t.replace(this.regex,function(t,l,u,c,h,p){return r=o.index[l||u||h],s=c||p||a,e&&(i=e[l||u||h])?o.formatValue(i.value,s,r):r?(n=o.grafanaVariables[r.current.value])?o.formatValue(n,s,r):(i=r.current.value,o.isAllValue(i)&&(i=o.getAllValue(r),r.allValue)?o.replace(i):o.formatValue(i,s,r)):t})):t},t.prototype.isAllValue=function(t){return"$__all"===t||Array.isArray(t)&&"$__all"===t[0]},t.prototype.replaceWithText=function(t,e){var a,r=this;return t?(this.regex.lastIndex=0,t.replace(this.regex,function(t,n,i,s,o){if(e){var l=e[n||i||o];if(l)return l.text}return(a=r.index[n||i||o])?r.grafanaVariables[a.current.value]||a.current.text:t})):t},t.prototype.fillVariableValuesForUrl=function(t,e){A.a.each(this.variables,function(a){if(e&&void 0!==e[a.name]){if(e[a.name].skipUrlSync)return;t["var-"+a.name]=e[a.name].value}else{if(a.skipUrlSync)return;t["var-"+a.name]=a.getValueForUrl()}})},t.prototype.distributeVariable=function(t,e){return(t=A.a.map(t,function(t,a){return 0!==a?e+"="+t:t})).join(",")},t}()),it=function(){function t(){}return t.prototype._linkTo=function(t,e){e<=0&&t.inputEdges.push(this),e>=0&&t.outputEdges.push(this),t.edges.push(this)},t.prototype.link=function(t,e){return this.unlink(),this.inputNode=t,this.outputNode=e,this._linkTo(t,1),this._linkTo(e,-1),this},t.prototype.unlink=function(){var t,e=this.inputNode,a=this.outputNode;e&&a&&((t=e.edges.indexOf(this))>-1&&e.edges.splice(t,1),(t=a.edges.indexOf(this))>-1&&a.edges.splice(t,1),(t=e.outputEdges.indexOf(this))>-1&&e.outputEdges.splice(t,1),(t=a.inputEdges.indexOf(this))>-1&&a.inputEdges.splice(t,1),this.inputNode=null,this.outputNode=null)},t}(),st=function(){function t(t){this.name=t,this.edges=[],this.inputEdges=[],this.outputEdges=[]}return t.prototype.getEdgeFrom=function(t){return t?"object"==typeof t?this.inputEdges.find(function(e){return e.inputNode.name===t.name}):this.inputEdges.find(function(e){return e.inputNode.name===t}):null},t.prototype.getEdgeTo=function(t){return t?"object"==typeof t?this.outputEdges.find(function(e){return e.outputNode.name===t.name}):this.outputEdges.find(function(e){return e.outputNode.name===t}):null},t.prototype.getOptimizedInputEdges=function(){var t=this,e=[];return this.inputEdges.forEach(function(a){a.inputNode.inputEdges.map(function(t){return t.inputNode}).forEach(function(a){var r=a.getEdgeTo(t.name);r&&e.push(r)})}),this.inputEdges.filter(function(t){return-1===e.indexOf(t)})},t}(),ot=function(){function t(){this.nodes={}}return t.prototype.createNode=function(t){var e=new st(t);return this.nodes[t]=e,e},t.prototype.createNodes=function(t){var e=this,a=[];return t.forEach(function(t){a.push(e.createNode(t))}),a},t.prototype.link=function(t,e){var a=this,r=[],n=[],i=[],s=[];r=t instanceof Array?t:[t],n=e instanceof Array?e:[e];for(var o=0;o<r.length;o++){"string"==typeof(l=r[o])?i.push(this.getNode(l)):i.push(l)}for(o=0;o<n.length;o++){var l;"string"==typeof(l=n[o])?s.push(this.getNode(l)):s.push(l)}var u=[];return i.forEach(function(t){s.forEach(function(e){u.push(a.createEdge().link(t,e))})}),u},t.prototype.createEdge=function(){return new it},t.prototype.getNode=function(t){return this.nodes[t]},t}(),lt=function(){function t(t,e,a,r,n){this.$rootScope=t,this.$q=e,this.$location=a,this.$injector=r,this.templateSrv=n,t.$on("refresh",this.onDashboardRefresh.bind(this),t),t.$on("template-variable-value-updated",this.updateUrlParamsWithCurrentVariables.bind(this),t)}return t.$inject=["$rootScope","$q","$location","$injector","templateSrv"],t.prototype.init=function(t){var e=this;this.dashboard=t,this.variables=t.templating.list=t.templating.list.map(this.createVariableFromModel.bind(this)),this.templateSrv.init(this.variables);for(var a=0,r=this.variables;a<r.length;a++){r[a].initLock=this.$q.defer()}var n=this.$location.search();return this.$q.all(this.variables.map(function(t){return e.processVariable(t,n)})).then(function(){e.templateSrv.updateTemplateData()})},t.prototype.onDashboardRefresh=function(t,e){var a=this;if(e&&e.fromVariableValueUpdated)return Promise.resolve({});var r=this.variables.filter(function(t){return 2===t.refresh}).map(function(t){var e=t.options.slice();return t.updateOptions().then(function(){P.a.toJson(e)!==P.a.toJson(t.options)&&a.$rootScope.$emit("template-variable-value-updated")})});return this.$q.all(r)},t.prototype.processVariable=function(t,e){for(var a=this,r=[],n=0,i=this.variables;n<i.length;n++){var s=i[n];t.dependsOn(s)&&r.push(s.initLock.promise)}return this.$q.all(r).then(function(){var a=e["var-"+t.name];return void 0!==a?t.setValueFromUrl(a).then(t.initLock.resolve):1===t.refresh||2===t.refresh?t.updateOptions().then(t.initLock.resolve):void t.initLock.resolve()}).finally(function(){a.templateSrv.variableInitialized(t),delete t.initLock})},t.prototype.createVariableFromModel=function(t){var e=Z[t.type].ctor;if(!e)throw{message:"无法找到变量构造函数 "+t.type};return this.$injector.instantiate(e,{model:t})},t.prototype.addVariable=function(t){this.variables.push(t),this.templateSrv.updateTemplateData(),this.dashboard.updateSubmenuVisibility()},t.prototype.removeVariable=function(t){var e=A.a.indexOf(this.variables,t);this.variables.splice(e,1),this.templateSrv.updateTemplateData(),this.dashboard.updateSubmenuVisibility()},t.prototype.updateOptions=function(t){return t.updateOptions()},t.prototype.variableUpdated=function(t,e){var a=this;if(t.initLock)return this.$q.when();var r=this.createGraph().getNode(t.name),n=[];return r&&(n=r.getOptimizedInputEdges().map(function(t){return a.updateOptions(a.variables.find(function(e){return e.name===t.inputNode.name}))})),this.$q.all(n).then(function(){e&&(a.$rootScope.$emit("template-variable-value-updated"),a.$rootScope.$broadcast("refresh",{fromVariableValueUpdated:!0}))})},t.prototype.selectOptionsForCurrentValue=function(t){var e,a,r,n,i=[];for(e=0;e<t.options.length;e++)if((n=t.options[e]).selected=!1,A.a.isArray(t.current.value))for(a=0;a<t.current.value.length;a++)r=t.current.value[a],n.value===r&&(n.selected=!0,i.push(n));else n.value===t.current.value&&(n.selected=!0,i.push(n));return i},t.prototype.validateVariableSelectionState=function(t){if(t.current||(t.current={}),A.a.isArray(t.current.value)){var e=this.selectOptionsForCurrentValue(t);return e=0===e.length?t.options[0]:{value:A.a.map(e,function(t){return t.value}),text:A.a.map(e,function(t){return t.text}).join(" + ")},t.setValue(e)}var a=A.a.find(t.options,{text:t.current.text});return a?t.setValue(a):t.options.length?t.setValue(t.options[0]):Promise.resolve()},t.prototype.setOptionFromUrl=function(t,e){var a=this.$q.when();return t.refresh&&(a=t.updateOptions()),a.then(function(){var a=A.a.find(t.options,function(t){return t.text===e||t.value===e}),r=e,n=e;if(!a&&A.a.isArray(e)){r=[];for(var i=function(a){var n=A.a.find(t.options,function(t){return t.value===e[a]});n&&r.push(n.text)},s=0;s<e.length;s++)i(s)}return a=a||{text:r,value:n},t.setValue(a)})},t.prototype.setOptionAsCurrent=function(t,e){return t.current=A.a.cloneDeep(e),A.a.isArray(t.current.text)&&(t.current.text=t.current.text.join(" + ")),this.selectOptionsForCurrentValue(t),this.variableUpdated(t)},t.prototype.updateUrlParamsWithCurrentVariables=function(){var t=this.$location.search();A.a.each(t,function(e,a){0===a.indexOf("var-")&&delete t[a]}),this.templateSrv.fillVariableValuesForUrl(t),this.$location.search(t)},t.prototype.setAdhocFilter=function(t){var e=A.a.find(this.variables,{type:"adhoc",datasource:t.datasource});e||(e=this.createVariableFromModel({name:"Filters",type:"adhoc",datasource:t.datasource}),this.addVariable(e));var a=e.filters,r=A.a.find(a,{key:t.key,value:t.value});r||(r={key:t.key,value:t.value},a.push(r)),r.operator=t.operator,this.variableUpdated(e,!0)},t.prototype.createGraph=function(){var t=this,e=new ot;return this.variables.forEach(function(a){e.createNode(a.name),t.variables.forEach(function(t){a!==t&&a.dependsOn(t)&&e.link(a.name,t.name)})}),e},t}();I.a.service("variableSrv",lt);var ut=function(){function t(t,e,a,r){this.model=t,this.timeSrv=e,this.templateSrv=a,this.variableSrv=r,this.defaults={type:"interval",name:"",hide:0,label:"",refresh:2,options:[],current:{},query:"1m,10m,30m,1h,6h,12h,1d,7d,14d,30d",auto:!1,auto_min:"10s",auto_count:30,skipUrlSync:!1},Object(X.a)(this,t,this.defaults),this.refresh=2}return t.$inject=["model","timeSrv","templateSrv","variableSrv"],t.prototype.getSaveModel=function(){return Object(X.a)(this.model,this,this.defaults),this.model},t.prototype.setValue=function(t){return this.updateAutoValue(),this.variableSrv.setOptionAsCurrent(this,t)},t.prototype.updateAutoValue=function(){if(this.auto){this.options.length&&"auto"!==this.options[0].text&&this.options.unshift({text:"auto",value:"$__auto_interval_"+this.name});var t=J.a.calculateInterval(this.timeSrv.timeRange(),this.auto_count,this.auto_min);this.templateSrv.setGrafanaVariable("$__auto_interval_"+this.name,t.interval),this.templateSrv.setGrafanaVariable("$__auto_interval",t.interval)}},t.prototype.updateOptions=function(){return this.options=A.a.map(this.query.match(/(["'])(.*?)\1|\w+/g),function(t){return{text:(t=t.replace(/["']+/g,"")).trim(),value:t.trim()}}),this.updateAutoValue(),this.variableSrv.validateVariableSelectionState(this)},t.prototype.dependsOn=function(t){return!1},t.prototype.setValueFromUrl=function(t){return this.updateAutoValue(),this.variableSrv.setOptionFromUrl(this,t)},t.prototype.getValueForUrl=function(){return this.current.value},t}();Z.interval={name:"Interval",ctor:ut,description:"定义时间间隔 (如 1m, 1h, 1d)"};var ct=function(){function t(t,e,a,r,n){this.model=t,this.datasourceSrv=e,this.templateSrv=a,this.variableSrv=r,this.timeSrv=n,this.defaults={type:"query",label:null,query:"",regex:"",sort:0,datasource:null,refresh:0,hide:0,name:"",multi:!1,includeAll:!1,allValue:null,options:[],current:{},tags:[],useTags:!1,tagsQuery:"",tagValuesQuery:"",skipUrlSync:!1},Object(X.a)(this,t,this.defaults)}return t.$inject=["model","datasourceSrv","templateSrv","variableSrv","timeSrv"],t.prototype.getSaveModel=function(){return Object(X.a)(this.model,this,this.defaults),0!==this.refresh&&(this.model.options=[]),this.model},t.prototype.setValue=function(t){return this.variableSrv.setOptionAsCurrent(this,t)},t.prototype.setValueFromUrl=function(t){return this.variableSrv.setOptionFromUrl(this,t)},t.prototype.getValueForUrl=function(){return"All"===this.current.text?"All":this.current.value},t.prototype.updateOptions=function(){return this.datasourceSrv.get(this.datasource).then(this.updateOptionsFromMetricFindQuery.bind(this)).then(this.updateTags.bind(this)).then(this.variableSrv.validateVariableSelectionState.bind(this.variableSrv,this))},t.prototype.updateTags=function(t){var e=this;return this.useTags?this.metricFindQuery(t,this.tagsQuery).then(function(a){e.tags=[];for(var r=0;r<a.length;r++)e.tags.push(a[r].text);return t}):(delete this.tags,t)},t.prototype.getValuesForTag=function(t){var e=this;return this.datasourceSrv.get(this.datasource).then(function(a){var r=e.tagValuesQuery.replace("$tag",t);return e.metricFindQuery(a,r).then(function(t){return A.a.map(t,function(t){return t.text})})})},t.prototype.updateOptionsFromMetricFindQuery=function(t){var e=this;return this.metricFindQuery(t,this.query).then(function(a){return e.options=e.metricNamesToVariableValues(a),e.includeAll&&e.addAllOption(),e.options.length||e.options.push({text:"None",value:"",isNone:!0}),t})},t.prototype.metricFindQuery=function(t,e){var a={range:void 0,variable:this};return 2===this.refresh&&(a.range=this.timeSrv.timeRange()),t.metricFindQuery(e,a)},t.prototype.addAllOption=function(){this.options.unshift({text:"All",value:"$__all"})},t.prototype.metricNamesToVariableValues=function(t){var e,a,r,n;for(a=[],this.regex&&(e=J.a.stringToJsRegex(this.templateSrv.replace(this.regex,{},"regex"))),r=0;r<t.length;r++){var i=t[r],s=void 0===i.text||null===i.text?i.value:i.text,o=void 0===i.value||null===i.value?i.text:i.value;if(A.a.isNumber(o)&&(o=o.toString()),A.a.isNumber(s)&&(s=s.toString()),e){if(!(n=e.exec(o)))continue;n.length>1&&(o=n[1],s=n[1])}a.push({text:s,value:o})}return a=A.a.uniqBy(a,"value"),this.sortVariableValues(a,this.sort)},t.prototype.sortVariableValues=function(t,e){if(0===e)return t;var a=Math.ceil(e/2),r=e%2==0;return 1===a?t=A.a.sortBy(t,"text"):2===a?t=A.a.sortBy(t,function(t){var e=t.text.match(/.*?(\d+).*/);return!e||e.length<2?-1:parseInt(e[1],10)}):3===a&&(t=A.a.sortBy(t,function(t){return A.a.toLower(t.text)})),r&&(t=t.reverse()),t},t.prototype.dependsOn=function(t){return tt(this.query,this.datasource,this.regex,t.name)},t}();Z.query={name:"Query",ctor:ct,description:"从数据源查询中获取变量值",supportsMulti:!0};var ht=function(){function t(t,e,a,r){this.model=t,this.datasourceSrv=e,this.variableSrv=a,this.templateSrv=r,this.defaults={type:"datasource",name:"",hide:0,label:"",current:{},regex:"",options:[],query:"",refresh:1,skipUrlSync:!1},Object(X.a)(this,t,this.defaults),this.refresh=1}return t.$inject=["model","datasourceSrv","variableSrv","templateSrv"],t.prototype.getSaveModel=function(){return Object(X.a)(this.model,this,this.defaults),this.model.options=[],this.model},t.prototype.setValue=function(t){return this.variableSrv.setOptionAsCurrent(this,t)},t.prototype.updateOptions=function(){var t,e=[],a=this.datasourceSrv.getMetricSources({skipVariables:!0});this.regex&&(t=this.templateSrv.replace(this.regex,null,"regex"),t=J.a.stringToJsRegex(t));for(var r=0;r<a.length;r++){var n=a[r];n.meta.id===this.query&&(t&&!t.exec(n.name)||e.push({text:n.name,value:n.name}))}return 0===e.length&&e.push({text:"未找到任何数据源",value:""}),this.options=e,this.variableSrv.validateVariableSelectionState(this)},t.prototype.dependsOn=function(t){return!!this.regex&&tt(this.regex,t.name)},t.prototype.setValueFromUrl=function(t){return this.variableSrv.setOptionFromUrl(this,t)},t.prototype.getValueForUrl=function(){return this.current.value},t}();Z.datasource={name:"Datasource",ctor:ht,description:"使您能够动态切换多个面板的数据源"};var pt=function(){function t(t,e){this.model=t,this.variableSrv=e,this.defaults={type:"custom",name:"",label:"",hide:0,options:[],current:{},query:"",includeAll:!1,multi:!1,allValue:null,skipUrlSync:!1},Object(X.a)(this,t,this.defaults)}return t.$inject=["model","variableSrv"],t.prototype.setValue=function(t){return this.variableSrv.setOptionAsCurrent(this,t)},t.prototype.getSaveModel=function(){return Object(X.a)(this.model,this,this.defaults),this.model},t.prototype.updateOptions=function(){return this.options=A.a.map(this.query.split(/[,]+/),function(t){return{text:t.trim(),value:t.trim()}}),this.includeAll&&this.addAllOption(),this.variableSrv.validateVariableSelectionState(this)},t.prototype.addAllOption=function(){this.options.unshift({text:"All",value:"$__all"})},t.prototype.dependsOn=function(t){return!1},t.prototype.setValueFromUrl=function(t){return this.variableSrv.setOptionFromUrl(this,t)},t.prototype.getValueForUrl=function(){return"All"===this.current.text?"All":this.current.value},t}();Z.custom={name:"Custom",ctor:pt,description:"手动定义变量值",supportsMulti:!0};var dt=function(){function t(t,e){this.model=t,this.variableSrv=e,this.defaults={type:"constant",name:"",hide:2,label:"",query:"",current:{},options:[],skipUrlSync:!1},Object(X.a)(this,t,this.defaults)}return t.$inject=["model","variableSrv"],t.prototype.getSaveModel=function(){return Object(X.a)(this.model,this,this.defaults),this.model},t.prototype.setValue=function(t){this.variableSrv.setOptionAsCurrent(this,t)},t.prototype.updateOptions=function(){return this.options=[{text:this.query.trim(),value:this.query.trim()}],this.setValue(this.options[0]),Promise.resolve()},t.prototype.dependsOn=function(t){return!1},t.prototype.setValueFromUrl=function(t){return this.variableSrv.setOptionFromUrl(this,t)},t.prototype.getValueForUrl=function(){return this.current.value},t}();Z.constant={name:"Constant",ctor:dt,description:"使用一个因此的常, 用于定义你共享的仪表盘的指标前缀"};var mt=function(){function t(t){this.model=t,this.defaults={type:"adhoc",name:"",label:"",hide:0,datasource:null,filters:[],skipUrlSync:!1},Object(X.a)(this,t,this.defaults)}return t.$inject=["model"],t.prototype.setValue=function(t){return Promise.resolve()},t.prototype.getSaveModel=function(){return Object(X.a)(this.model,this,this.defaults),this.model},t.prototype.updateOptions=function(){return Promise.resolve()},t.prototype.dependsOn=function(t){return!1},t.prototype.setValueFromUrl=function(t){var e=this;return A.a.isArray(t)||(t=[t]),this.filters=t.map(function(t){var a=t.split("|").map(function(t){return e.unescapeDelimiter(t)});return{key:a[0],operator:a[1],value:a[2]}}),Promise.resolve()},t.prototype.getValueForUrl=function(){var t=this;return this.filters.map(function(e){return[e.key,e.operator,e.value].map(function(e){return t.escapeDelimiter(e)}).join("|")})},t.prototype.escapeDelimiter=function(t){return t.replace(/\|/g,"__gfp__")},t.prototype.unescapeDelimiter=function(t){return t.replace(/__gfp__/g,"|")},t.prototype.setFilters=function(t){this.filters=t},t}();Z.adhoc={name:"Ad hoc filters",ctor:mt,description:"添加键/值对过滤器"},I.a.factory("templateSrv",function(){return nt});var ft=a(1195),gt=a.n(ft),vt=function(){function t(t,e,a,r,n,i){this.$scope=t,this.$rootScope=e,this.backendSrv=a,this.$sce=r,this.$routeParams=n,this.pluginId=n.pluginId,this.preUpdateHook=function(){return Promise.resolve()},this.postUpdateHook=function(){return Promise.resolve()},this.init()}return t.$inject=["$scope","$rootScope","backendSrv","$sce","$routeParams","navModelSrv"],t.prototype.setNavModel=function(t){var e="readme";(this.navModel={main:{img:t.info.logos.large,subTitle:t.info.author.name,url:"",text:t.name,breadcrumbs:[{title:"插件",url:"plugins"}],children:[{icon:"fa fa-fw fa-file-text-o",id:"readme",text:"Readme",url:"plugins/"+this.model.id+"/edit?tab=readme"}]}},"app"===t.type)&&(this.navModel.main.children.push({icon:"gicon gicon-cog",id:"config",text:"配置",url:"plugins/"+this.model.id+"/edit?tab=config"}),A.a.find(t.includes,{type:"dashboard"})&&this.navModel.main.children.push({icon:"gicon gicon-dashboard",id:"dashboards",text:"仪表盘",url:"plugins/"+this.model.id+"/edit?tab=dashboards"}),e="config");this.tab=this.$routeParams.tab||e;for(var a=0,r=this.navModel.main.children;a<r.length;a++){var n=r[a];n.id===this.tab&&(n.active=!0)}},t.prototype.init=function(){var t=this;return this.backendSrv.get("/api/plugins/"+this.pluginId+"/settings").then(function(e){return t.model=e,t.pluginIcon=t.getPluginIcon(t.model.type),t.model.dependencies.plugins.forEach(function(e){e.icon=t.getPluginIcon(e.type)}),t.includes=A.a.map(e.includes,function(e){return e.icon=t.getPluginIcon(e.type),e}),t.setNavModel(t.model),t.initReadme()})},t.prototype.initReadme=function(){var t=this;return this.backendSrv.get("/api/plugins/"+this.pluginId+"/markdown/readme").then(function(e){var a=new gt.a({linkify:!0});t.readmeHtml=t.$sce.trustAsHtml(a.render(e))})},t.prototype.getPluginIcon=function(t){switch(t){case"datasource":return"icon-gf icon-gf-datasources";case"panel":return"icon-gf icon-gf-panel";case"app":return"icon-gf icon-gf-apps";case"page":return"icon-gf icon-gf-endpoint-tiny";case"dashboard":return"icon-gf icon-gf-dashboard";default:return"icon-gf icon-gf-apps"}},t.prototype.update=function(){var t=this;this.preUpdateHook().then(function(){var e=A.a.extend({enabled:t.model.enabled,pinned:t.model.pinned,jsonData:t.model.jsonData,secureJsonData:t.model.secureJsonData},{});return t.backendSrv.post("/api/plugins/"+t.pluginId+"/settings",e)}).then(this.postUpdateHook).then(function(t){window.location.href=window.location.href})},t.prototype.importDashboards=function(){return Promise.resolve()},t.prototype.setPreUpdateHook=function(t){this.preUpdateHook=t},t.prototype.setPostUpdateHook=function(t){this.postUpdateHook=t},t.prototype.updateAvailable=function(){var t=this.$scope.$new(!0);t.plugin=this.model,this.$rootScope.appEvent("show-modal",{src:"public/app/features/plugins/partials/update_instructions.html",scope:t})},t.prototype.enable=function(){this.model.enabled=!0,this.model.pinned=!0,this.update()},t.prototype.disable=function(){this.model.enabled=!1,this.model.pinned=!1,this.update()},t}();P.a.module("grafana.controllers").controller("PluginEditCtrl",vt);var yt={},bt=function(){function t(t,e,a,r){this.backendSrv=t,this.$routeParams=e,this.$rootScope=a,this.navModelSrv=r,this.pluginId=e.pluginId,yt[this.pluginId]?this.initPage(yt[this.pluginId]):this.loadPluginInfo()}return t.$inject=["backendSrv","$routeParams","$rootScope","navModelSrv"],t.prototype.initPage=function(t){if(this.appModel=t,this.page=A.a.find(t.includes,{slug:this.$routeParams.slug}),yt[this.pluginId]=t,!this.page)return this.$rootScope.appEvent("alert-error",["App Page Not Found",""]),void(this.navModel=this.navModelSrv.getNotFoundNav());var e=this.navModelSrv.getNav("plugin-page-"+t.id);this.navModel={main:{img:t.info.logos.large,subTitle:t.name,url:"",text:this.page.name,breadcrumbs:[{title:t.name,url:e.main.url}]}}},t.prototype.loadPluginInfo=function(){var t=this;this.backendSrv.get("/api/plugins/"+this.pluginId+"/settings").then(function(e){t.initPage(e)})},t}();P.a.module("grafana.controllers").controller("AppPageCtrl",bt);var St=function(){function t(t,e,a){var r=this;this.backendSrv=t,this.tabIndex=0,this.navModel=a.getNav("cfg","plugins",0),this.backendSrv.get("api/plugins",{embedded:0}).then(function(t){r.plugins=t,r.allPlugins=t})}return t.$inject=["backendSrv","$location","navModelSrv"],t.prototype.onQueryUpdated=function(){var t=new RegExp(this.searchQuery,"ig");this.plugins=A.a.filter(this.allPlugins,function(e){return t.test(e.name)||t.test(e.type)})},t}();P.a.module("grafana.controllers").controller("PluginListCtrl",St);var xt=function(){function t(t,e,a){var r=this;this.backendSrv=e,this.$rootScope=a,this.dashboards=[],e.get("/api/plugins/"+this.plugin.id+"/dashboards").then(function(t){r.dashboards=t}),et.a.on("dashboard-list-import-all",this.importAll.bind(this),t)}return t.$inject=["$scope","backendSrv","$rootScope"],t.prototype.importAll=function(t){return this.importNext(0).then(function(){t.resolve("All dashboards imported")}).catch(function(e){t.reject(e)})},t.prototype.importNext=function(t){var e=this;return this.import(this.dashboards[t],!0).then(function(){return t+1<e.dashboards.length?new Promise(function(a){setTimeout(function(){e.importNext(t+1).then(function(){a()})},500)}):Promise.resolve()})},t.prototype.import=function(t,e){var a=this,r={pluginId:this.plugin.id,path:t.path,overwrite:e,inputs:[]};return this.datasource&&r.inputs.push({name:"*",type:"datasource",pluginId:this.datasource.type,value:this.datasource.name}),this.backendSrv.post("/api/dashboards/import",r).then(function(e){a.$rootScope.appEvent("alert-success",["仪表盘已导入",t.title]),A.a.extend(t,e)})},t.prototype.remove=function(t){var e=this;this.backendSrv.delete("/api/dashboards/"+t.importedUri).then(function(){e.$rootScope.appEvent("alert-success",["仪表盘已删除",t.title]),t.imported=!1})},t}();I.a.directive("dashboardImportList",function(){return{restrict:"E",templateUrl:"public/app/features/plugins/import_list/import_list.html",controller:xt,bindToController:!0,controllerAs:"ctrl",scope:{plugin:"=",datasource:"="}}});var wt=a(10),kt=a(11),Ct=a(65),Tt=[],_t={name:"",type:"graphite",url:"",access:"proxy",jsonData:{},secureJsonFields:{},secureJsonData:{}},Mt=!1,$t=function(){function t(t,e,a,r,n){var i=this;this.$q=t,this.backendSrv=e,this.$routeParams=a,this.$location=r,this.datasourceSrv=n,null===Ct.b.nav.main&&Ct.b.nav.load("cfg","datasources"),this.navModel=Object(wt.r)(Ct.b.nav),this.datasources=[],this.loadDatasourceTypes().then(function(){i.$routeParams.id?i.getDatasourceById(i.$routeParams.id):i.initNewDatasourceModel()})}return t.$inject=["$q","backendSrv","$routeParams","$location","datasourceSrv"],t.prototype.initNewDatasourceModel=function(){this.isNew=!0,this.current=A.a.cloneDeep(_t),this.$location.search().gettingstarted&&(this.gettingStarted=!0,this.current.isDefault=!0),this.typeChanged()},t.prototype.loadDatasourceTypes=function(){var t=this;return Tt.length>0?(this.types=Tt,this.$q.when(null)):this.backendSrv.get("/api/plugins",{enabled:1,type:"datasource"}).then(function(e){Tt=e,t.types=e})},t.prototype.getDatasourceById=function(t){var e=this;this.backendSrv.get("/api/datasources/"+t).then(function(t){return e.isNew=!1,e.current=t,Mt&&(Mt=!1,e.testDatasource()),e.typeChanged()})},t.prototype.userChangedType=function(){this.current=A.a.defaults({id:this.current.id,name:this.current.name,isDefault:this.current.isDefault,type:this.current.type},A.a.cloneDeep(_t)),this.typeChanged()},t.prototype.updateNav=function(){Ct.b.nav.initDatasourceEditNav(this.current,this.datasourceMeta,"datasource-settings"),this.navModel=Object(wt.r)(Ct.b.nav)},t.prototype.typeChanged=function(){var t=this;return this.backendSrv.get("/api/plugins/"+this.current.type+"/settings").then(function(e){t.datasourceMeta=e,t.updateNav()})},t.prototype.updateFrontendSettings=function(){var t=this;return this.backendSrv.get("/api/frontend/settings").then(function(e){kt.a.datasources=e.datasources,kt.a.defaultDatasource=e.defaultDatasource,t.datasourceSrv.init()})},t.prototype.testDatasource=function(){var t=this;this.datasourceSrv.get(this.current.name).then(function(e){e.testDatasource&&(t.testing={done:!1,status:"error"},t.backendSrv.withNoBackendCache(function(){return e.testDatasource().then(function(e){t.testing.message=e.message,t.testing.status=e.status}).catch(function(e){e.statusText?t.testing.message="HTTP Error "+e.statusText:t.testing.message=e.message})}).finally(function(){t.testing.done=!0}))})},t.prototype.saveChanges=function(){var t=this;if(this.editForm.$valid&&!this.current.readOnly)return this.current.id?this.backendSrv.put("/api/datasources/"+this.current.id,this.current).then(function(e){t.current=e.datasource,t.updateNav(),t.updateFrontendSettings().then(function(){t.testDatasource()})}):this.backendSrv.post("/api/datasources",this.current).then(function(e){t.current=e.datasource,t.updateFrontendSettings(),Mt=!0,t.$location.path("datasources/edit/"+e.id)})},t.prototype.confirmDelete=function(){var t=this;this.backendSrv.delete("/api/datasources/"+this.current.id).then(function(){t.$location.path("datasources")})},t.prototype.delete=function(t){var e=this;j.b.emit("confirm-modal",{title:"删除",text:"您确定要删除此数据源吗?",yesText:"删除",icon:"fa-trash",onConfirm:function(){e.confirmDelete()}})},t}();j.d.controller("DataSourceEditCtrl",$t),j.d.directive("datasourceHttpSettings",function(){return{scope:{current:"=",suggestUrl:"@",noDirectAccess:"@"},templateUrl:"public/app/features/plugins/partials/ds_http_settings.html",link:{pre:function(t,e,a){t.showAccessOption="true"!==t.noDirectAccess,t.showAccessHelp=!1,t.toggleAccessHelp=function(){t.showAccessHelp=!t.showAccessHelp},t.getSuggestUrls=function(){return[t.suggestUrl]}}}}});var Pt=function(){function t(t,e){this.backendSrv=t,this.$routeParams=e,null===Ct.b.nav.main&&Ct.b.nav.load("cfg","datasources"),this.navModel=Object(wt.r)(Ct.b.nav),this.$routeParams.id&&this.getDatasourceById(this.$routeParams.id)}return t.$inject=["backendSrv","$routeParams"],t.prototype.getDatasourceById=function(t){var e=this;this.backendSrv.get("/api/datasources/"+t).then(function(t){e.current=t}).then(this.getPluginInfo.bind(this))},t.prototype.updateNav=function(){Ct.b.nav.initDatasourceEditNav(this.current,this.datasourceMeta,"datasource-dashboards"),this.navModel=Object(wt.r)(Ct.b.nav)},t.prototype.getPluginInfo=function(){var t=this;return this.backendSrv.get("/api/plugins/"+this.current.type+"/settings").then(function(e){t.datasourceMeta=e,t.updateNav()})},t}();j.d.controller("DataSourceDashboardsCtrl",Pt);var Et=function(){function t(t,e,a,r){var n=this;this.$scope=t,this.backendSrv=e,this.datasourceSrv=a,this.navModelSrv=r,this.navModel=this.navModelSrv.getNav("cfg","datasources",0),e.get("/api/datasources").then(function(t){n.datasources=t,n.unfiltered=t})}return t.$inject=["$scope","backendSrv","datasourceSrv","navModelSrv"],t.prototype.onQueryUpdated=function(){var t=new RegExp(this.searchQuery,"ig");this.datasources=A.a.filter(this.unfiltered,function(e){return t.lastIndex=0,t.test(e.name)||t.test(e.type)})},t.prototype.removeDataSourceConfirmed=function(t){var e=this;this.backendSrv.delete("/api/datasources/"+t.id).then(function(){e.$scope.appEvent("alert-success",["Datasource deleted",""])},function(){e.$scope.appEvent("alert-error",["Unable to delete datasource",""])}).then(function(){e.backendSrv.get("/api/datasources").then(function(t){e.datasources=t}),e.backendSrv.get("/api/frontend/settings").then(function(t){e.datasourceSrv.init(t.datasources)})})},t.prototype.removeDataSource=function(t){var e=this;this.$scope.appEvent("confirm-modal",{title:"删除",text:"确定要删除数据源: "+t.name+"?",yesText:"删除",icon:"fa-trash",onConfirm:function(){e.removeDataSourceConfirmed(t)}})},t}();I.a.controller("DataSourcesCtrl",Et);var At=a(1200),Dt=a.n(At),Ft=a(75),It=a(33),Ot=a(39),qt=function(){function t(t,e){var a=this;this.$injector=e,this.$location=e.get("$location"),this.$scope=t,this.$timeout=e.get("$timeout"),this.editorTabIndex=0,this.events=this.panel.events,this.timing={};var r=kt.a.panels[this.panel.type];r&&(this.pluginId=r.id,this.pluginName=r.name),t.$on("refresh",function(){return a.refresh()}),t.$on("component-did-mount",function(){return a.panelDidMount()}),t.$on("$destroy",function(){a.events.emit("panel-teardown"),a.events.removeAllListeners()})}return t.prototype.init=function(){this.events.emit("panel-initialized"),this.publishAppEvent("panel-initialized",{scope:this.$scope})},t.prototype.panelDidMount=function(){this.events.emit("component-did-mount")},t.prototype.renderingCompleted=function(){j.e.renderingCompleted(this.panel.id,this.timing)},t.prototype.refresh=function(){this.events.emit("refresh",null)},t.prototype.publishAppEvent=function(t,e){this.$scope.$root.appEvent(t,e)},t.prototype.changeView=function(t,e){this.publishAppEvent("panel-change-view",{fullscreen:t,edit:e,panelId:this.panel.id})},t.prototype.viewPanel=function(){this.changeView(!0,!1)},t.prototype.editPanel=function(){this.changeView(!0,!0)},t.prototype.exitFullscreen=function(){this.changeView(!1,!1)},t.prototype.initEditMode=function(){var t=this;this.editorTabs=[],this.addEditorTab("通用","public/app/partials/panelgeneral.html"),this.editModeInitiated=!0,this.events.emit("init-edit-mode",null);var e=(this.$injector.get("$routeParams").tab||"").toLowerCase();e&&this.editorTabs.forEach(function(a,r){a.title.toLowerCase()===e&&(t.editorTabIndex=r)})},t.prototype.changeTab=function(t){this.editorTabIndex=t;var e=this.$injector.get("$route");e.current.params.tab=this.editorTabs[t].title.toLowerCase(),e.updateParams()},t.prototype.addEditorTab=function(t,e,a){var r={title:t,directiveFn:e};A.a.isString(e)&&(r.directiveFn=function(){return{templateUrl:e}}),a?this.editorTabs.splice(a,0,r):this.editorTabs.push(r)},t.prototype.getMenu=function(){var t=[];t.push({text:"查看",click:"ctrl.viewPanel();",icon:"fa fa-fw fa-eye",shortcut:"v"}),this.dashboard.meta.canEdit&&t.push({text:"编辑",click:"ctrl.editPanel();",role:"Editor",icon:"fa fa-fw fa-edit",shortcut:"e"}),t.push({text:"分享",click:"ctrl.sharePanel();",icon:"fa fa-fw fa-share",shortcut:"p s"}),t.push.apply(t,this.getAdditionalMenuItems());var e=this.getExtendedMenu();return t.push({text:"更多 ...",click:"",icon:"fa fa-fw fa-cube",submenu:e}),this.dashboard.meta.canEdit&&(t.push({divider:!0,role:"Editor"}),t.push({text:"移除",click:"ctrl.removePanel();",role:"Editor",icon:"fa fa-fw fa-trash",shortcut:"p r"})),t},t.prototype.getExtendedMenu=function(){var t=[];return!this.fullscreen&&this.dashboard.meta.canEdit&&(t.push({text:"创建副本",click:"ctrl.duplicate()",role:"Editor",shortcut:"p d"}),t.push({text:"复制",click:"ctrl.copyPanel()",role:"Editor"})),t.push({text:"面板 JSON",click:"ctrl.editPanelJson(); dismiss();"}),this.events.emit("init-panel-actions",t),t},t.prototype.getAdditionalMenuItems=function(){return[]},t.prototype.otherPanelInFullscreenMode=function(){return this.dashboard.meta.fullscreen&&!this.fullscreen},t.prototype.calculatePanelHeight=function(){if(this.fullscreen){var t=F()(window).height(),e=Math.floor(.4*t),a=Math.floor(.8*t);this.containerHeight=this.editMode?e:a}else this.containerHeight=this.panel.gridPos.h*It.c+(this.panel.gridPos.h-1)*It.d;this.panel.soloMode&&(this.containerHeight=F()(window).height()),this.height=this.containerHeight-29},t.prototype.render=function(t){this.timing.renderStart=(new Date).getTime(),this.events.emit("render",t)},t.prototype.duplicate=function(){var t=this;this.dashboard.duplicatePanel(this.panel),this.$timeout(function(){t.$scope.$root.$broadcast("render")})},t.prototype.removePanel=function(){this.publishAppEvent("panel-remove",{panelId:this.panel.id})},t.prototype.editPanelJson=function(){var t=this.$scope.$root.$new();t.object=this.panel.getSaveModel(),t.updateHandler=this.replacePanel.bind(this),t.enableCopy=!0,this.publishAppEvent("show-modal",{src:"public/app/partials/edit_json.html",scope:t})},t.prototype.copyPanel=function(){Ot.a.set(It.f,JSON.stringify(this.panel.getSaveModel())),j.b.emit("alert-success",["面板已复制。 打开添加面板进行粘贴"])},t.prototype.replacePanel=function(t,e){var a=this.dashboard,r=A.a.findIndex(a.panels,function(t){return t.id===e.id}),n=a.panels.splice(r,1);this.dashboard.events.emit("panel-removed",n),(t=new Ft.a(t)).id=e.id,a.panels.splice(r,0,t),a.sortPanelsByGridPos(),a.events.emit("panel-added",t)},t.prototype.sharePanel=function(){var t=this.$scope.$new();t.panel=this.panel,t.dashboard=this.dashboard,this.publishAppEvent("show-modal",{src:"public/app/features/dashboard/partials/shareModal.html",scope:t})},t.prototype.getInfoMode=function(){return this.error?"error":this.panel.description?"info":this.panel.links&&this.panel.links.length?"links":""},t.prototype.getInfoContent=function(t){var e=this.panel.description;"tooltip"===t.mode&&(e=this.error||this.panel.description);var a=this.$injector.get("linkSrv"),r=this.$injector.get("$sanitize"),n=this.$injector.get("templateSrv").replace(e,this.panel.scopedVars),i='<div class="markdown-html">';if(i+=(new gt.a).render(n),this.panel.links&&this.panel.links.length>0){i+="<ul>";for(var s=0,o=this.panel.links;s<o.length;s++){var l=o[s],u=a.getPanelLinkAnchorInfo(l,this.panel.scopedVars);i+='<li><a class="panel-menu-link" href="'+u.href+'" target="'+u.target+'">'+u.title+"</a></li>"}i+="</ul>"}return r(i+="</div>")},t.prototype.openInspector=function(){var t=this.$scope.$new();t.panel=this.panel,t.dashboard=this.dashboard,t.panelInfoHtml=this.getInfoContent({mode:"inspector"}),t.inspector=F.a.extend(!0,{},this.inspector),this.publishAppEvent("show-modal",{src:"public/app/features/dashboard/partials/inspector.html",scope:t})},t}(),Rt=a(3),Nt=a(271),Vt=a(192),Lt=a(66),jt=function(){function t(t,e,a,r){this.$sce=e,this.backendSrv=r,this.panelCtrl=t.ctrl,t.ctrl=this,this.panel=this.panelCtrl.panel,this.dashboard=this.panelCtrl.dashboard,this.datasources=a.getMetricSources(),this.panelDsValue=this.panelCtrl.panel.datasource;for(var n=0,i=this.datasources;n<i.length;n++){var s=i[n];s.value===this.panelDsValue&&(this.datasourceInstance=s)}this.addQueryDropdown={text:"添加查询",value:null,fake:!0},this.panelCtrl.nextRefId=this.dashboard.getNextQueryLetter(this.panel),this.updateDatasourceOptions()}return t.$inject=["$scope","$sce","datasourceSrv","backendSrv"],t.prototype.updateDatasourceOptions=function(){this.datasourceInstance&&(this.hasQueryHelp=this.datasourceInstance.meta.hasQueryHelp,this.queryOptions=this.datasourceInstance.meta.queryOptions)},t.prototype.getOptions=function(t){return Promise.resolve(this.datasources.filter(function(e){return t||!e.meta.builtIn}).map(function(t){return{value:t.value,text:t.name,datasource:t}}))},t.prototype.datasourceChanged=function(t){t&&(this.datasourceInstance=t.datasource,this.panelCtrl.setDatasource(t.datasource),this.updateDatasourceOptions())},t.prototype.addMixedQuery=function(t){t&&(this.panelCtrl.addQuery({isNew:!0,datasource:t.datasource.name}),this.addQueryDropdown={text:"添加查询",value:null,fake:!0})},t.prototype.addQuery=function(){this.panelCtrl.addQuery({isNew:!0})},t.prototype.toggleHelp=function(){var t=this;this.optionsOpen=!1,this.queryTroubleshooterOpen=!1,this.helpOpen=!this.helpOpen,this.backendSrv.get("/api/plugins/"+this.datasourceInstance.meta.id+"/markdown/query_help").then(function(e){var a=new gt.a;t.helpHtml=t.$sce.trustAsHtml(a.render(e))})},t.prototype.toggleOptions=function(){this.helpOpen=!1,this.queryTroubleshooterOpen=!1,this.optionsOpen=!this.optionsOpen},t.prototype.toggleQueryTroubleshooter=function(){this.helpOpen=!1,this.optionsOpen=!1,this.queryTroubleshooterOpen=!this.queryTroubleshooterOpen},t}();function Ut(){return{restrict:"E",scope:!0,templateUrl:"public/app/features/panel/partials/metrics_tab.html",controller:jt}}var Bt=function(t){function e(e,a){var r=t.call(this,e,a)||this;return r.editorTabIndex=1,r.$q=a.get("$q"),r.contextSrv=a.get("contextSrv"),r.datasourceSrv=a.get("datasourceSrv"),r.timeSrv=a.get("timeSrv"),r.templateSrv=a.get("templateSrv"),r.scope=e,r.panel.datasource=r.panel.datasource||null,r.panel.targets||(r.panel.targets=[{}]),r.events.on("refresh",r.onMetricsPanelRefresh.bind(r)),r.events.on("init-edit-mode",r.onInitMetricsPanelEditMode.bind(r)),r.events.on("panel-teardown",r.onPanelTearDown.bind(r)),r}return Rt.d(e,t),e.prototype.onPanelTearDown=function(){this.dataSubscription&&(this.dataSubscription.unsubscribe(),this.dataSubscription=null)},e.prototype.onInitMetricsPanelEditMode=function(){this.addEditorTab("度量指标",Ut),this.addEditorTab("时间范围","public/app/features/panel/partials/panelTime.html")},e.prototype.onMetricsPanelRefresh=function(){var t=this;if(!this.otherPanelInFullscreenMode()){if(this.panel.snapshotData){this.updateTimeRange();var e=this.panel.snapshotData;return A.a.isArray(e)||(e=e.data),this.$timeout(function(){t.events.emit("data-snapshot-load",e)})}this.dataStream||(delete this.error,this.loading=!0,this.setTimeQueryStart(),this.datasourceSrv.get(this.panel.datasource).then(this.updateTimeRange.bind(this)).then(this.issueQueries.bind(this)).then(this.handleQueryResult.bind(this)).catch(function(e){e.cancelled?console.log("Panel request cancelled",e):(t.loading=!1,t.error=e.message||"Request Error",t.inspector={error:e},e.data&&(e.data.message&&(t.error=e.data.message),e.data.error&&(t.error=e.data.error)),t.events.emit("data-error",e),console.log("Panel data error:",e))}))}},e.prototype.setTimeQueryStart=function(){this.timing.queryStart=(new Date).getTime()},e.prototype.setTimeQueryEnd=function(){this.timing.queryEnd=(new Date).getTime()},e.prototype.updateTimeRange=function(t){return this.datasource=t||this.datasource,this.range=this.timeSrv.timeRange(),this.applyPanelTimeOverrides(),this.panel.maxDataPoints?this.resolution=this.panel.maxDataPoints:this.resolution=Math.ceil(F()(window).width()*(this.panel.gridPos.w/24)),this.calculateInterval(),this.datasource},e.prototype.calculateInterval=function(){var t=this.panel.interval;t?t=this.templateSrv.replace(t,this.panel.scopedVars):this.datasource&&this.datasource.interval&&(t=this.datasource.interval);var e=J.a.calculateInterval(this.range,this.resolution,t);this.interval=e.interval,this.intervalMs=e.intervalMs},e.prototype.applyPanelTimeOverrides=function(){if(this.timeInfo="",this.panel.timeFrom){var t=this.templateSrv.replace(this.panel.timeFrom,this.panel.scopedVars),e=Nt.a(t);if(e.invalid)return void(this.timeInfo="invalid time override");if(A.a.isString(this.range.raw.from)){var a=Vt.parse(e.from);this.timeInfo=e.display,this.range.from=a,this.range.to=Vt.parse(e.to),this.range.raw.from=e.from,this.range.raw.to=e.to}}if(this.panel.timeShift){var r=this.templateSrv.replace(this.panel.timeShift,this.panel.scopedVars);if(Nt.a(r).invalid)return void(this.timeInfo="invalid timeshift");var n="-"+r;this.timeInfo+=" timeshift "+n,this.range.from=Vt.parseDateMath(n,this.range.from,!1),this.range.to=Vt.parseDateMath(n,this.range.to,!0),this.range.raw={from:this.range.from,to:this.range.to}}this.panel.hideTimeOverride&&(this.timeInfo="")},e.prototype.issueQueries=function(t){if(this.datasource=t,!this.panel.targets||0===this.panel.targets.length)return this.$q.when([]);var e=Object.assign({},this.panel.scopedVars,{__interval:{text:this.interval,value:this.interval},__interval_ms:{text:this.intervalMs,value:this.intervalMs}}),a={timezone:this.dashboard.getTimezone(),panelId:this.panel.id,dashboardId:this.dashboard.id,range:this.range,rangeRaw:this.range.raw,interval:this.interval,intervalMs:this.intervalMs,targets:this.panel.targets,maxDataPoints:this.resolution,scopedVars:e,cacheTimeout:this.panel.cacheTimeout};return t.query(a)},e.prototype.handleQueryResult=function(t){this.setTimeQueryEnd(),this.loading=!1,t&&t.subscribe?this.handleDataStream(t):(this.dashboard.snapshot&&(this.panel.snapshotData=t.data),t&&t.data||(console.log("Data source query result invalid, missing data field:",t),t={data:[]}),this.events.emit("data-received",t.data))},e.prototype.handleDataStream=function(t){var e=this;this.dataStream?console.log("two stream observables!"):(this.dataStream=t,this.dataSubscription=t.subscribe({next:function(t){console.log("dataSubject next!"),t.range&&(e.range=t.range),e.events.emit("data-received",t.data)},error:function(t){e.events.emit("data-error",t),console.log("panel: observer got error")},complete:function(){console.log("panel: observer got complete"),e.dataStream=null}}))},e.prototype.setDatasource=function(t){var e=this;t.meta.mixed?A.a.each(this.panel.targets,function(t){t.datasource=e.panel.datasource,t.datasource||(t.datasource=kt.a.defaultDatasource)}):this.datasource&&this.datasource.meta.mixed&&A.a.each(this.panel.targets,function(t){delete t.datasource}),this.panel.datasource=t.value,this.datasourceName=t.name,this.datasource=null,this.refresh()},e.prototype.getAdditionalMenuItems=function(){var t=[];return kt.a.exploreEnabled&&this.contextSrv.isEditor&&this.datasource&&this.datasource.supportsExplore&&t.push({text:"Explore",click:"ctrl.explore();",icon:"fa fa-fw fa-rocket",shortcut:"x"}),t},e.prototype.explore=function(){var t=this.timeSrv.timeRangeForUrl(),e=Rt.a({},this.datasource.getExploreState(this.panel),{range:t}),a=Object(Lt.c)(JSON.stringify(e));this.$location.url("/explore?state="+a)},e.prototype.addQuery=function(t){t.refId=this.dashboard.getNextQueryLetter(this.panel),this.panel.targets.push(t),this.nextRefId=this.dashboard.getNextQueryLetter(this.panel)},e.prototype.removeQuery=function(t){var e=A.a.indexOf(this.panel.targets,t);this.panel.targets.splice(e,1),this.nextRefId=this.dashboard.getNextQueryLetter(this.panel),this.refresh()},e.prototype.moveQuery=function(t,e){var a=A.a.indexOf(this.panel.targets,t);A.a.move(this.panel.targets,a,a+e)},e}(qt),Qt=function(){function t(t,e){this.$scope=t,this.$injector=e,this.panel=this.panelCtrl.panel,this.isLastQuery=A.a.indexOf(this.panel.targets,this.target)===this.panel.targets.length-1}return t.prototype.refresh=function(){this.panelCtrl.refresh()},t}(),Ht=function(){function t(){}return t.alertToGraphThresholds=function(t){for(var e=0;e<t.alert.conditions.length;e++){var a=t.alert.conditions[e];if("query"===a.type){var r=a.evaluator,n=t.thresholds=[];switch(r.type){case"gt":var i=r.params[0];n.push({value:i,op:"gt"});break;case"lt":i=r.params[0];n.push({value:i,op:"lt"});break;case"outside_range":(s=r.params[0])>(o=r.params[1])?(n.push({value:s,op:"gt"}),n.push({value:o,op:"lt"})):(n.push({value:s,op:"lt"}),n.push({value:o,op:"gt"}));break;case"within_range":var s,o;(s=r.params[0])>(o=r.params[1])?(n.push({value:s,op:"lt"}),n.push({value:o,op:"gt"})):(n.push({value:s,op:"gt"}),n.push({value:o,op:"lt"}))}break}}for(var l=0,u=t.thresholds;l<u.length;l++){var c=u[l];c.fill=!0,c.line=!0,c.colorMode="critical"}return!0},t}(),zt=a(182),Yt=function(){function t(t,e,a,r,n,i){this.$scope=t,this.backendSrv=e,this.dashboardSrv=a,this.uiSegmentSrv=r,this.$q=n,this.datasourceSrv=i,this.panelCtrl=t.ctrl,this.panel=this.panelCtrl.panel,this.$scope.ctrl=this,this.subTabIndex=0,this.evalFunctions=G.a.evalFunctions,this.evalOperators=G.a.evalOperators,this.conditionTypes=G.a.conditionTypes,this.noDataModes=G.a.noDataModes,this.executionErrorModes=G.a.executionErrorModes,this.appSubUrl=kt.a.appSubUrl}return t.$inject=["$scope","backendSrv","dashboardSrv","uiSegmentSrv","$q","datasourceSrv"],t.prototype.$onInit=function(){var t=this;this.addNotificationSegment=this.uiSegmentSrv.newPlusButton();var e=this.graphThresholdChanged.bind(this);return this.panelCtrl.events.on("threshold-changed",e),this.$scope.$on("$destroy",function(){t.panelCtrl.events.off("threshold-changed",e),t.panelCtrl.editingThresholds=!1,t.panelCtrl.render()}),this.notifications=[],this.alertNotifications=[],this.alertHistory=[],this.backendSrv.get("/api/alert-notifications").then(function(e){t.notifications=e,t.initModel(),t.validateModel()})},t.prototype.getAlertHistory=function(){var t=this;this.backendSrv.get("/api/annotations?dashboardId="+this.panelCtrl.dashboard.id+"&panelId="+this.panel.id+"&limit=50&type=alert").then(function(e){t.alertHistory=A.a.map(e,function(e){return e.time=t.dashboardSrv.getCurrent().formatDate(e.time,"MMM D, YYYY HH:mm:ss"),e.stateModel=G.a.getStateDisplayModel(e.newState),e.info=G.a.getAlertAnnotationInfo(e),e})})},t.prototype.getNotificationIcon=function(t){switch(t){case"email":return"fa fa-envelope";case"slack":return"fa fa-slack";case"victorops":return"fa fa-pagelines";case"webhook":return"fa fa-cubes";case"pagerduty":return"fa fa-bullhorn";case"opsgenie":return"fa fa-bell";case"hipchat":return"fa fa-mail-forward";case"pushover":return"fa fa-mobile";case"kafka":return"fa fa-random";case"teams":return"fa fa-windows"}return"fa fa-bell"},t.prototype.getNotifications=function(){var t=this;return Promise.resolve(this.notifications.map(function(e){return t.uiSegmentSrv.newSegment(e.name)}))},t.prototype.changeTabIndex=function(t){this.subTabIndex=t,2===this.subTabIndex&&this.getAlertHistory()},t.prototype.notificationAdded=function(){var t=A.a.find(this.notifications,{name:this.addNotificationSegment.value});t&&(this.alertNotifications.push({name:t.name,iconClass:this.getNotificationIcon(t.type),isDefault:!1}),this.alert.notifications.push({id:t.id}),this.addNotificationSegment.value=this.uiSegmentSrv.newPlusButton().value,this.addNotificationSegment.html=this.uiSegmentSrv.newPlusButton().html)},t.prototype.removeNotification=function(t){this.alert.notifications.splice(t,1),this.alertNotifications.splice(t,1)},t.prototype.initModel=function(){var t=this,e=this.alert=this.panel.alert;if(e){e.conditions=e.conditions||[],0===e.conditions.length&&e.conditions.push(this.buildDefaultCondition()),e.noDataState=e.noDataState||kt.a.alertingNoDataOrNullValues,e.executionErrorState=e.executionErrorState||kt.a.alertingErrorOrTimeout,e.frequency=e.frequency||"60s",e.handler=e.handler||1,e.notifications=e.notifications||[];var a=this.panel.title+" 告警";e.name=e.name||a,this.conditionModels=A.a.reduce(e.conditions,function(e,a){return e.push(t.buildConditionModel(a)),e},[]),Ht.alertToGraphThresholds(this.panel);for(var r=0,n=e.notifications;r<n.length;r++){var i=n[r],s=A.a.find(this.notifications,{id:i.id});s&&!1===s.isDefault&&(s.iconClass=this.getNotificationIcon(s.type),this.alertNotifications.push(s))}for(var o=0,l=this.notifications;o<l.length;o++){var u=l[o];u.isDefault&&(u.iconClass=this.getNotificationIcon(u.type),u.bgColor="#00678b",this.alertNotifications.push(u))}this.panelCtrl.editingThresholds=!0,this.panelCtrl.render()}},t.prototype.graphThresholdChanged=function(t){for(var e=0,a=this.alert.conditions;e<a.length;e++){var r=a[e];if("query"===r.type){r.evaluator.params[t.handleIndex]=t.threshold.value,this.evaluatorParamsChanged();break}}},t.prototype.buildDefaultCondition=function(){return{type:"query",query:{params:["A","5m","now"]},reducer:{type:"avg",params:[]},evaluator:{type:"gt",params:[null]},operator:{type:"and"}}},t.prototype.validateModel=function(){var t=this;if(this.alert)for(var e,a=null,r=0,n=this.alert.conditions;r<n.length;r++){var i=n[r];if("query"===i.type){for(var s=0,o=this.panel.targets;s<o.length;s++){var l=o[s];if(e||(e=l),i.query.params[0]===l.refId){a=l;break}}a||(e?(i.query.params[0]=e.refId,a=e):this.error="Could not find any metric queries");var u=a.datasource||this.panel.datasource;this.datasourceSrv.get(u).then(function(e){e.meta.alerting?e.targetContainsTemplate(a)?t.error="Template variables are not supported in alert queries":t.error="":t.error="The datasource does not support alerting queries"})}}},t.prototype.buildConditionModel=function(t){var e={source:t,type:t.type};return e.queryPart=new zt.a(t.query,G.a.alertQueryDef),e.reducerPart=G.a.createReducerPart(t.reducer),e.evaluator=t.evaluator,e.operator=t.operator,e},t.prototype.handleQueryPartEvent=function(t,e){var a=this;switch(e.name){case"action-remove-part":break;case"get-part-actions":return this.$q.when([]);case"part-param-changed":this.validateModel();case"get-param-options":var r=this.panel.targets.map(function(t){return a.uiSegmentSrv.newSegment({value:t.refId})});return this.$q.when(r)}},t.prototype.handleReducerPartEvent=function(t,e){switch(e.name){case"action":t.source.reducer.type=e.action.value,t.reducerPart=G.a.createReducerPart(t.source.reducer);break;case"get-part-actions":for(var a=[],r=0,n=G.a.reducerTypes;r<n.length;r++){var i=n[r];i.value!==t.source.reducer.type&&a.push(i)}return this.$q.when(a)}},t.prototype.addCondition=function(t){var e=this.buildDefaultCondition();this.alert.conditions.push(e),this.conditionModels.push(this.buildConditionModel(e))},t.prototype.removeCondition=function(t){this.alert.conditions.splice(t,1),this.conditionModels.splice(t,1)},t.prototype.delete=function(){var t=this;et.a.emit("confirm-modal",{title:"删除告警",text:"确定希望删除这条告警规则?",text2:"需要保存仪表盘使删除生效",icon:"fa-trash",yesText:"删除",onConfirm:function(){delete t.panel.alert,t.alert=null,t.panel.thresholds=[],t.conditionModels=[],t.panelCtrl.alertState=null,t.panelCtrl.render()}})},t.prototype.enable=function(){this.panel.alert={},this.initModel()},t.prototype.evaluatorParamsChanged=function(){Ht.alertToGraphThresholds(this.panel),this.panelCtrl.render()},t.prototype.evaluatorTypeChanged=function(t){switch(t.type){case"lt":case"gt":t.params=[t.params[0]];break;case"within_range":case"outside_range":t.params=[t.params[0],t.params[1]];break;case"no_value":t.params=[]}this.evaluatorParamsChanged()},t.prototype.clearHistory=function(){var t=this;et.a.emit("confirm-modal",{title:"删除历史状态",text:"您确定要删除此告警的所有历史状态和注释吗?",icon:"fa-trash",yesText:"是",onConfirm:function(){t.backendSrv.post("/api/annotations/mass-delete",{dashboardId:t.panelCtrl.dashboard.id,panelId:t.panel.id}).then(function(e){t.alertHistory=[],t.panelCtrl.refresh()})}})},t.prototype.test=function(){var t=this;this.testing=!0,this.testResult=!1;var e={dashboard:this.dashboardSrv.getCurrent().getSaveModelClone(),panelId:this.panelCtrl.panel.id};return this.backendSrv.post("/api/alerts/test",e).then(function(e){t.testResult=e,t.testing=!1})},t}();function Wt(){return{restrict:"E",scope:!0,templateUrl:"public/app/features/alerting/partials/alert_tab.html",controller:Yt}}var Gt=a(1197),Kt=a.n(Gt),Jt=a(16),Xt=a(1199),Zt=a(276),te=a(0),ee=a.n(te),ae=a(13),re=a.n(ae),ne=a(145),ie=a(1211),se=a(523),oe=a(1201),le="YYYY-MM-DDTHH:mm:ssZ",ue=1,ce=0,he=";",pe="\r\n",de='"',me="grafana_data_export.csv";function fe(t){return t?t.split(de).join(de+de):t}var ge=new DOMParser;function ve(t){if(!t)return t;var e=/&[^;]+;/g;function a(t){return ge.parseFromString(t,"text/html").body.textContent}return t.replace(e,a).replace(e,a)}function ye(t){return t?"sep="+he+pe:""}function be(t,e){void 0===e&&(e=!0);for(var a="",r=0;r<t.length;r+=1)Object(E.isBoolean)(t[r])||Object(oe.isNullOrUndefined)(t[r])?a+=t[r]:Object(E.isNumber)(t[r])?a+=t[r].toLocaleString():a+=""+de+fe(Object(E.unescape)(ve(t[r])))+de,r<t.length-1&&(a+=he);return e?a+pe:a}function Se(t,e,a){void 0===e&&(e=le),void 0===a&&(a=!1);for(var r=ye(a)+be(["Series","Time","Value"]),n=0;n<t.length;n+=1)for(var i=0;i<t[n].datapoints.length;i+=1)r+=be([t[n].alias,L()(t[n].datapoints[i][ue]).format(e),t[n].datapoints[i][ce]],i<t[n].datapoints.length-1||n<t.length-1);return r}function xe(t,e,a){void 0===e&&(e=le),void 0===a&&(a=!1),_e(Se(t,e,a),me)}function we(t,e,a){void 0===e&&(e=le),void 0===a&&(a=!1);var r=ye(a)+be(["Time"].concat(t.map(function(t){return t.alias})));t=function(t){for(var e=[],a=0;a<t.length;a++)for(var r=t[a].datapoints,n=0;n<r.length;n++)e.push(r[n][ue]);e=Object(E.sortedUniq)(e.sort());for(var a=0;a<t.length;a++){for(var r=t[a].datapoints,i=r.map(function(t){return t[ue]}),s=[],o=void 0,n=0;n<e.length;n++)-1!==(o=Object(E.sortedIndexOf)(i,e[n]))?s.push(r[o]):s.push([null,e[n]]);t[a].datapoints=s}return t}(t);for(var n=function(a){var n=L()(t[0].datapoints[a][ue]).format(e);r+=be([n].concat(t.map(function(t){return t.datapoints[a][ce]})),a<t[0].datapoints.length-1)},i=0;i<t[0].datapoints.length;i+=1)n(i);return r}function ke(t,e,a){void 0===e&&(e=le),void 0===a&&(a=!1),_e(we(t,e,a),me)}function Ce(t,e){void 0===e&&(e=!1);var a=ye(e);a+=be(t.columns.map(function(t){return t.title||t.text}));for(var r=0;r<t.rows.length;r+=1)a+=be(t.rows[r],r<t.rows.length-1);return a}function Te(t,e){void 0===e&&(e=!1),_e(Ce(t,e),me)}function _e(t,e){var a=new Blob([t],{type:"text/csv;charset=utf-8;header=present;"});Object(se.saveAs)(a,e)}function Me(t,e){var a=(e=e||{}).delimiter||".",r=e.maxDepth||3,n=1,i={};return function t(s,o){Object.keys(s).forEach(function(l){var u=s[l],c=e.safe&&Array.isArray(u),h="[object Object]"===Object.prototype.toString.call(u),p=o?o+a+l:l;if(e.maxDepth||(r=n+1),!c&&h&&Object.keys(u).length&&n<r)return++n,t(u,p);i[p]=u})}(t,null),i}var $e=a(270),Pe=a(272),Ee=/^(\d+)(?:\.(\d+))?(?:\.(\d+))?(?:-([0-9A-Za-z\.]+))?/,Ae=function(){function t(t){var e=Ee.exec(t);e&&(this.major=Number(e[1]),this.minor=Number(e[2]||0),this.patch=Number(e[3]||0),this.meta=e[4])}return t.prototype.isGtOrEq=function(e){var a=new t(e);return!(this.major<a.major||this.minor<a.minor||this.patch<a.patch)},t.prototype.isValid=function(){return A.a.isNumber(this.major)},t}();function De(t,e){return new Ae(t).isGtOrEq(e)}var Fe={};function Ie(t){t.params=t.params||[],t.defaultParams=t.defaultParams||[],Fe[t.name]=t,t.shortName&&(Fe[t.shortName]=t)}var Oe=[{name:"other",type:"value_or_series",optional:!0,multiple:!0}];function qe(t,e){return!t.version||De(e,t.version)}Ie({name:"scaleToSeconds",category:"Transform",params:[{name:"seconds",type:"int"}],defaultParams:[1]}),Ie({name:"perSecond",category:"Transform",params:[{name:"max value",type:"int",optional:!0}],defaultParams:[]}),Ie({name:"holtWintersForecast",category:"Calculate"}),Ie({name:"holtWintersConfidenceBands",category:"Calculate",params:[{name:"delta",type:"int"}],defaultParams:[3]}),Ie({name:"holtWintersAberration",category:"Calculate",params:[{name:"delta",type:"int"}],defaultParams:[3]}),Ie({name:"nPercentile",category:"Calculate",params:[{name:"Nth percentile",type:"int"}],defaultParams:[95]}),Ie({name:"diffSeries",params:Oe,defaultParams:["#A"],category:"Combine"}),Ie({name:"stddevSeries",params:Oe,defaultParams:[""],category:"Combine"}),Ie({name:"divideSeries",params:Oe,defaultParams:["#A"],category:"Combine"}),Ie({name:"multiplySeries",params:Oe,defaultParams:["#A"],category:"Combine"}),Ie({name:"asPercent",params:Oe,defaultParams:["#A"],category:"Combine"}),Ie({name:"group",params:Oe,defaultParams:["#A","#B"],category:"Combine"}),Ie({name:"sumSeries",shortName:"sum",category:"Combine",params:Oe,defaultParams:[""]}),Ie({name:"averageSeries",shortName:"avg",category:"Combine",params:Oe,defaultParams:[""]}),Ie({name:"rangeOfSeries",category:"Combine"}),Ie({name:"percentileOfSeries",category:"Combine",params:[{name:"n",type:"int"},{name:"interpolate",type:"boolean",options:["true","false"]}],defaultParams:[95,"false"]}),Ie({name:"sumSeriesWithWildcards",category:"Combine",params:[{name:"node",type:"int",multiple:!0}],defaultParams:[3]}),Ie({name:"maxSeries",shortName:"max",category:"Combine"}),Ie({name:"minSeries",shortName:"min",category:"Combine"}),Ie({name:"averageSeriesWithWildcards",category:"Combine",params:[{name:"node",type:"int",multiple:!0}],defaultParams:[3]}),Ie({name:"alias",category:"Alias",params:[{name:"alias",type:"string"}],defaultParams:["alias"]}),Ie({name:"aliasSub",category:"Alias",params:[{name:"search",type:"string"},{name:"replace",type:"string"}],defaultParams:["","\\1"]}),Ie({name:"consolidateBy",category:"Special",params:[{name:"function",type:"string",options:["sum","average","min","max"]}],defaultParams:["max"]}),Ie({name:"cumulative",category:"Special",params:[],defaultParams:[]}),Ie({name:"groupByNode",category:"Combine",params:[{name:"node",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12]},{name:"function",type:"string",options:["sum","avg","maxSeries"]}],defaultParams:[3,"sum"]}),Ie({name:"aliasByNode",category:"Alias",params:[{name:"node",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12],multiple:!0}],defaultParams:[3]}),Ie({name:"substr",category:"Special",params:[{name:"start",type:"int",options:[-6,-5,-4,-3,-2,-1,0,1,2,3,4,5,6,7,8,9,10,12]},{name:"stop",type:"int",options:[-6,-5,-4,-3,-2,-1,0,1,2,3,4,5,6,7,8,9,10,12]}],defaultParams:[0,0]}),Ie({name:"sortByName",category:"Sorting",params:[{name:"natural",type:"boolean",options:["true","false"],optional:!0}],defaultParams:["false"]}),Ie({name:"sortByMaxima",category:"Sorting"}),Ie({name:"sortByMinima",category:"Sorting"}),Ie({name:"sortByTotal",category:"Sorting"}),Ie({name:"aliasByMetric",category:"Alias"}),Ie({name:"randomWalk",fake:!0,category:"Special",params:[{name:"name",type:"string"}],defaultParams:["randomWalk"]}),Ie({name:"countSeries",category:"Combine"}),Ie({name:"constantLine",category:"Special",params:[{name:"value",type:"int"}],defaultParams:[10]}),Ie({name:"cactiStyle",category:"Special"}),Ie({name:"keepLastValue",category:"Transform",params:[{name:"n",type:"int"}],defaultParams:[100]}),Ie({name:"changed",category:"Special",params:[],defaultParams:[]}),Ie({name:"scale",category:"Transform",params:[{name:"factor",type:"int"}],defaultParams:[1]}),Ie({name:"offset",category:"Transform",params:[{name:"amount",type:"int"}],defaultParams:[10]}),Ie({name:"transformNull",category:"Transform",params:[{name:"amount",type:"int"}],defaultParams:[0]}),Ie({name:"integral",category:"Transform"}),Ie({name:"derivative",category:"Transform"}),Ie({name:"nonNegativeDerivative",category:"Transform",params:[{name:"max value or 0",type:"int",optional:!0}],defaultParams:[""]}),Ie({name:"timeShift",category:"Transform",params:[{name:"amount",type:"select",options:["1h","6h","12h","1d","2d","7d","14d","30d"]}],defaultParams:["1d"]}),Ie({name:"timeStack",category:"Transform",params:[{name:"timeShiftUnit",type:"select",options:["1h","6h","12h","1d","2d","7d","14d","30d"]},{name:"timeShiftStart",type:"int"},{name:"timeShiftEnd",type:"int"}],defaultParams:["1d",0,7]}),Ie({name:"summarize",category:"Transform",params:[{name:"interval",type:"string"},{name:"func",type:"select",options:["sum","avg","min","max","last"]},{name:"alignToFrom",type:"boolean",optional:!0,options:["false","true"]}],defaultParams:["1h","sum","false"]}),Ie({name:"smartSummarize",category:"Transform",params:[{name:"interval",type:"string"},{name:"func",type:"select",options:["sum","avg","min","max","last"]}],defaultParams:["1h","sum"]}),Ie({name:"absolute",category:"Transform"}),Ie({name:"hitcount",category:"Transform",params:[{name:"interval",type:"string"}],defaultParams:["10s"]}),Ie({name:"log",category:"Transform",params:[{name:"base",type:"int"}],defaultParams:["10"]}),Ie({name:"averageAbove",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[25]}),Ie({name:"averageBelow",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[25]}),Ie({name:"currentAbove",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[25]}),Ie({name:"currentBelow",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[25]}),Ie({name:"maximumAbove",category:"Filter Series",params:[{name:"value",type:"int"}],defaultParams:[0]}),Ie({name:"maximumBelow",category:"Filter Series",params:[{name:"value",type:"int"}],defaultParams:[0]}),Ie({name:"minimumAbove",category:"Filter Series",params:[{name:"value",type:"int"}],defaultParams:[0]}),Ie({name:"minimumBelow",category:"Filter Series",params:[{name:"value",type:"int"}],defaultParams:[0]}),Ie({name:"limit",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[5]}),Ie({name:"mostDeviant",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[10]}),Ie({name:"exclude",category:"Filter Series",params:[{name:"exclude",type:"string"}],defaultParams:["exclude"]}),Ie({name:"highestCurrent",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),Ie({name:"highestMax",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),Ie({name:"lowestCurrent",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),Ie({name:"movingAverage",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10]}),Ie({name:"movingMedian",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:["5"]}),Ie({name:"stdev",category:"Calculate",params:[{name:"n",type:"int"},{name:"tolerance",type:"int"}],defaultParams:[5,.1]}),Ie({name:"highestAverage",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),Ie({name:"lowestAverage",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),Ie({name:"removeAbovePercentile",category:"Filter Data",params:[{name:"n",type:"int"}],defaultParams:[5]}),Ie({name:"removeAboveValue",category:"Filter Data",params:[{name:"n",type:"int"}],defaultParams:[5]}),Ie({name:"removeBelowPercentile",category:"Filter Data",params:[{name:"n",type:"int"}],defaultParams:[5]}),Ie({name:"removeBelowValue",category:"Filter Data",params:[{name:"n",type:"int"}],defaultParams:[5]}),Ie({name:"useSeriesAbove",category:"Filter Series",params:[{name:"value",type:"int"},{name:"search",type:"string"},{name:"replace",type:"string"}],defaultParams:[0,"search","replace"]}),Ie({name:"aggregateLine",category:"Calculate",params:[{name:"func",type:"select",options:["sum","avg","min","max","last"]}],defaultParams:["avg"],version:"1.0"}),Ie({name:"averageOutsidePercentile",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[95],version:"1.0"}),Ie({name:"delay",category:"Transform",params:[{name:"steps",type:"int"}],defaultParams:[1],version:"1.0"}),Ie({name:"exponentialMovingAverage",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10],version:"1.0"}),Ie({name:"fallbackSeries",category:"Special",params:[{name:"fallback",type:"string"}],defaultParams:["constantLine(0)"],version:"1.0"}),Ie({name:"grep",category:"Filter Series",params:[{name:"grep",type:"string"}],defaultParams:["grep"],version:"1.0"}),Ie({name:"groupByNodes",category:"Combine",params:[{name:"function",type:"string",options:["sum","avg","maxSeries"]},{name:"node",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12],multiple:!0}],defaultParams:["sum",3],version:"1.0"}),Ie({name:"integralByInterval",category:"Transform",params:[{name:"intervalUnit",type:"select",options:["1h","6h","12h","1d","2d","7d","14d","30d"]}],defaultParams:["1d"],version:"1.0"}),Ie({name:"interpolate",category:"Transform",params:[{name:"limit",type:"int",optional:!0}],defaultParams:[],version:"1.0"}),Ie({name:"invert",category:"Transform",version:"1.0"}),Ie({name:"isNonNull",category:"Combine",version:"1.0"}),Ie({name:"linearRegression",category:"Calculate",params:[{name:"startSourceAt",type:"select",options:["-1h","-6h","-12h","-1d","-2d","-7d","-14d","-30d"],optional:!0},{name:"endSourceAt",type:"select",options:["-1h","-6h","-12h","-1d","-2d","-7d","-14d","-30d"],optional:!0}],defaultParams:[],version:"1.0"}),Ie({name:"mapSeries",shortName:"map",params:[{name:"node",type:"int"}],defaultParams:[3],category:"Combine",version:"1.0"}),Ie({name:"movingMin",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10],version:"1.0"}),Ie({name:"movingMax",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10],version:"1.0"}),Ie({name:"movingSum",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10],version:"1.0"}),Ie({name:"multiplySeriesWithWildcards",category:"Combine",params:[{name:"position",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12],multiple:!0}],defaultParams:[2],version:"1.0"}),Ie({name:"offsetToZero",category:"Transform",version:"1.0"}),Ie({name:"pow",category:"Transform",params:[{name:"factor",type:"int"}],defaultParams:[10],version:"1.0"}),Ie({name:"powSeries",category:"Transform",params:Oe,defaultParams:[""],version:"1.0"}),Ie({name:"reduceSeries",shortName:"reduce",params:[{name:"function",type:"string",options:["asPercent","diffSeries","divideSeries"]},{name:"reduceNode",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,11,12,13]},{name:"reduceMatchers",type:"string",multiple:!0}],defaultParams:["asPercent",2,"used_bytes"],category:"Combine",version:"1.0"}),Ie({name:"removeBetweenPercentile",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[95],version:"1.0"}),Ie({name:"removeEmptySeries",category:"Filter Series",version:"1.0"}),Ie({name:"squareRoot",category:"Transform",version:"1.0"}),Ie({name:"timeSlice",category:"Transform",params:[{name:"startSliceAt",type:"select",options:["-1h","-6h","-12h","-1d","-2d","-7d","-14d","-30d"]},{name:"endSliceAt",type:"select",options:["-1h","-6h","-12h","-1d","-2d","-7d","-14d","-30d"],optional:!0}],defaultParams:["-1h"],version:"1.0"}),Ie({name:"weightedAverage",category:"Combine",params:[{name:"other",type:"value_or_series",optional:!0},{name:"node",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12]}],defaultParams:["#A",4],version:"1.0"}),Ie({name:"seriesByTag",category:"Special",params:[{name:"tagExpression",type:"string",multiple:!0}],version:"1.1"}),Ie({name:"groupByTags",category:"Combine",params:[{name:"function",type:"string",options:["sum","avg","maxSeries"]},{name:"tag",type:"string",multiple:!0}],defaultParams:["sum","tag"],version:"1.1"}),Ie({name:"aliasByTags",category:"Alias",params:[{name:"tag",type:"string",multiple:!0}],defaultParams:["tag"],version:"1.1"});var Re=function(){function t(t,e){this.def=t,this.params=[],e&&e.withDefaultParams&&(this.params=t.defaultParams.slice(0)),this.updateText()}return t.prototype.render=function(t){for(var e=this,a=this.def.name+"(",r=A.a.map(this.params,function(t,a){var r;return a<e.def.params.length?r=e.def.params[a].type:A.a.get(A.a.last(e.def.params),"multiple")&&(r=A.a.get(A.a.last(e.def.params),"type")),A.a.includes(["value_or_series","boolean","int","float","node"],r)?t:A.a.includes(["int_or_interval","node_or_tag"],r)&&A.a.isFinite(+t)?A.a.toString(+t):"'"+t+"'"});""===r[r.length-1];)r.pop();return t&&r.unshift(t),a+r.join(", ")+")"},t.prototype._hasMultipleParamsInString=function(t,e){return-1!==t.indexOf(",")&&(!(!this.def.params[e+1]||!this.def.params[e+1].optional)||!!(e+1>=this.def.params.length&&A.a.get(A.a.last(this.def.params),"multiple")))},t.prototype.updateParam=function(t,e){var a=this;this._hasMultipleParamsInString(t,e)?A.a.each(t.split(","),function(t,r){a.updateParam(t.trim(),e+r)}):(""===t&&(e>=this.def.params.length||this.def.params[e].optional)?this.params.splice(e,1):this.params[e]=t,this.updateText())},t.prototype.updateText=function(){if(0!==this.params.length){var t=this.def.name+"(";t+=this.params.join(", "),t+=")",this.text=t}else this.text=this.def.name+"()"},t}();function Ne(t,e){if(!(e||Fe)[t])throw{message:"Method not found "+t};return(e||Fe)[t]}var Ve={createFuncInstance:function(t,e,a){return A.a.isString(t)&&(t=Ne(t,a)),new Re(t,e)},getFuncDef:Ne,getFuncDefs:function(t,e){var a={};return A.a.forEach(e||Fe,function(e){qe(e,t)&&(a[e.name]=A.a.assign({},e,{params:A.a.filter(e.params,function(e){return qe(e,t)})}))}),a},parseFuncDefs:function(t){var e={};return A.a.forEach(t||{},function(t,a){if("Graph"!==t.group){var r=t.description;r&&(r=r.replace(/:py:func:`(.+)( <[^>]*>)?`/g,"``$1``").replace(/.. seealso:: /g,"See also: ").replace(/.. code-block *:: *none/g,".. code-block::"));var n={name:t.name,description:r,category:t.group,params:[],defaultParams:[],fake:!1};/^seriesLists?$/.test(A.a.get(t,"params[0].type",""))?t.params[0].multiple?t.params[0].required=!1:t.params.shift():n.fake=!0,A.a.forEach(t.params,function(t){var e={name:t.name,type:"string",optional:!t.required,multiple:!!t.multiple,options:void 0};void 0!==t.default?n.defaultParams.push(A.a.toString(t.default)):t.suggestions?n.defaultParams.push(A.a.toString(t.suggestions[0])):n.defaultParams.push(""),"boolean"===t.type?(e.type="boolean",e.options=["true","false"]):"integer"===t.type?e.type="int":"float"===t.type?e.type="float":"node"===t.type?(e.type="node",e.options=["0","1","2","3","4","5","6","7","8","9","10","11","12"]):"nodeOrTag"===t.type?(e.type="node_or_tag",e.options=["name","0","1","2","3","4","5","6","7","8","9","10","11","12"]):"intOrInterval"===t.type?e.type="int_or_interval":"seriesList"===t.type&&(e.type="value_or_series"),t.options?e.options=A.a.map(t.options,A.a.toString):t.suggestions&&(e.options=A.a.map(t.suggestions,A.a.toString)),n.params.push(e)}),e[a]=n}}),e}};function Le(t,e,a,r){var n=this;this.basicAuth=t.basicAuth,this.url=t.url,this.name=t.name,this.graphiteVersion=t.jsonData.graphiteVersion||"0.9",this.supportsTags=function(t){return De(t,"1.1")}(this.graphiteVersion),this.cacheTimeout=t.cacheTimeout,this.withCredentials=t.withCredentials,this.render_method=t.render_method||"POST",this.funcDefs=null,this.funcDefsPromise=null,this.getQueryOptionsInfo=function(){return{maxDataPoints:!0,cacheTimeout:!0,links:[{text:"帮助",url:"http://docs.grafana.org/features/datasources/graphite/#using-graphite-in-grafana"}]}},this.query=function(t){var a={from:this.translateTime(t.rangeRaw.from,!1),until:this.translateTime(t.rangeRaw.to,!0),targets:t.targets,format:t.format,cacheTimeout:t.cacheTimeout||this.cacheTimeout,maxDataPoints:t.maxDataPoints},r=this.buildGraphiteParams(a,t.scopedVars);if(0===r.length)return e.when({data:[]});var n={method:"POST",url:"/render",data:r.join("&"),headers:{"Content-Type":"application/x-www-form-urlencoded"}};return this.addTracingHeaders(n,t),t.panelId&&(n.requestId=this.name+".panelId."+t.panelId),this.doGraphiteRequest(n).then(this.convertDataPointsToMs)},this.addTracingHeaders=function(t,e){!this.url.match(/^http/)&&(t.headers["X-Dashboard-Id"]=e.dashboardId,t.headers["X-Panel-Id"]=e.panelId)},this.convertDataPointsToMs=function(t){if(!t||!t.data)return[];for(var e=0;e<t.data.length;e++)for(var a=t.data[e],r=0;r<a.datapoints.length;r++)a.datapoints[r][1]*=1e3;return t},this.parseTags=function(t){var e=[];return 1===(e=t.split(",")).length&&""===(e=t.split(" "))[0]&&(e=[]),e},this.annotationQuery=function(t){var e=this;if(t.annotation.target){var a=r.replace(t.annotation.target,{},"glob"),n={rangeRaw:t.rangeRaw,targets:[{target:a}],format:"json",maxDataPoints:100};return this.query(n).then(function(e){for(var a=[],r=0;r<e.data.length;r++)for(var n=e.data[r],i=0;i<n.datapoints.length;i++){var s=n.datapoints[i];s[0]&&a.push({annotation:t.annotation,time:s[1],title:n.target})}return a})}var i=r.replace(t.annotation.tags);return this.events({range:t.rangeRaw,tags:i}).then(function(a){for(var r=[],n=0;n<a.data.length;n++){var i=a.data[n],s=i.tags;A.a.isString(i.tags)&&(s=e.parseTags(i.tags)),r.push({annotation:t.annotation,time:1e3*i.when,title:i.what,tags:s,text:i.data})}return r})},this.events=function(t){try{var a="";return t.tags&&(a="&tags="+t.tags),this.doGraphiteRequest({method:"GET",url:"/events/get_data?from="+this.translateTime(t.range.from,!1)+"&until="+this.translateTime(t.range.to,!0)+a})}catch(t){return e.reject(t)}},this.targetContainsTemplate=function(t){return r.variableExists(t.target)},this.translateTime=function(t,e){if(A.a.isString(t)){if("now"===t)return"now";if(t.indexOf("now-")>=0&&-1===t.indexOf("/"))return t=(t=(t=t.substring(3)).replace("m","min")).replace("M","mon");t=Vt.parse(t,e)}return e?t.get("s")&&t.add(1,"m"):!1===e&&t.get("s")&&t.subtract(1,"m"),t.unix()},this.metricFindQuery=function(t,e){var a=e||{},n=r.replace(t),i=n.match(/^tag_values\(([^,]+)((, *[^,]+)*)\)$/);if(i){for(var s=[],o=(l=/, *([^,]+)/g).exec(i[2]);null!==o;)s.push(o[1]),o=l.exec(i[2]);return a.limit=1e4,this.getTagValuesAutoComplete(s,i[1],void 0,a)}if(i=n.match(/^tags\(([^,]*)((, *[^,]+)*)\)$/)){s=[];if(i[1]){s.push(i[1]);var l;for(o=(l=/, *([^,]+)/g).exec(i[2]);null!==o;)s.push(o[1]),o=l.exec(i[2])}return a.limit=1e4,this.getTagsAutoComplete(s,void 0,a)}var u={method:"GET",url:"/metrics/find",params:{query:n},requestId:a.requestId};return a.range&&(u.params.from=this.translateTime(a.range.from,!1),u.params.until=this.translateTime(a.range.to,!0)),this.doGraphiteRequest(u).then(function(t){return A.a.map(t.data,function(t){return{text:t.text,expandable:!!t.expandable}})})},this.getTags=function(t){var e=t||{},a={method:"GET",url:"/tags",requestId:e.requestId};return e.range&&(a.params.from=this.translateTime(e.range.from,!1),a.params.until=this.translateTime(e.range.to,!0)),this.doGraphiteRequest(a).then(function(t){return A.a.map(t.data,function(t){return{text:t.tag,id:t.id}})})},this.getTagValues=function(t,e){var a=e||{},n={method:"GET",url:"/tags/"+r.replace(t),requestId:a.requestId};return a.range&&(n.params.from=this.translateTime(a.range.from,!1),n.params.until=this.translateTime(a.range.to,!0)),this.doGraphiteRequest(n).then(function(t){return t.data&&t.data.values?A.a.map(t.data.values,function(t){return{text:t.value,id:t.id}}):[]})},this.getTagsAutoComplete=function(t,e,a){var i=a||{},s={method:"GET",url:"/tags/autoComplete/tags",params:{expr:A.a.map(t,function(t){return r.replace((t||"").trim())})},requestId:i.requestId};return e&&(s.params.tagPrefix=e),i.limit&&(s.params.limit=i.limit),i.range&&(s.params.from=n.translateTime(i.range.from,!1),s.params.until=n.translateTime(i.range.to,!0)),n.doGraphiteRequest(s).then(function(t){return t.data?A.a.map(t.data,function(t){return{text:t}}):[]})},this.getTagValuesAutoComplete=function(t,e,a,i){var s=i||{},o={method:"GET",url:"/tags/autoComplete/values",params:{expr:A.a.map(t,function(t){return r.replace((t||"").trim())}),tag:r.replace((e||"").trim())},requestId:s.requestId};return a&&(o.params.valuePrefix=a),s.limit&&(o.params.limit=s.limit),s.range&&(o.params.from=n.translateTime(s.range.from,!1),o.params.until=n.translateTime(s.range.to,!0)),n.doGraphiteRequest(o).then(function(t){return t.data?A.a.map(t.data,function(t){return{text:t}}):[]})},this.getVersion=function(t){var e={method:"GET",url:"/version",requestId:(t||{}).requestId};return this.doGraphiteRequest(e).then(function(t){return t.data&&new Ae(t.data).isValid()?t.data:""}).catch(function(){return""})},this.createFuncInstance=function(t,e){return Ve.createFuncInstance(t,e,this.funcDefs)},this.getFuncDef=function(t){return Ve.getFuncDef(t,this.funcDefs)},this.waitForFuncDefsLoaded=function(){return this.getFuncDefs()},this.getFuncDefs=function(){var t=this;if(null!==this.funcDefsPromise)return this.funcDefsPromise;if(!function(t){return De(t,"1.1")}(this.graphiteVersion))return this.funcDefs=Ve.getFuncDefs(this.graphiteVersion),this.funcDefsPromise=Promise.resolve(this.funcDefs),this.funcDefsPromise;return this.funcDefsPromise=this.doGraphiteRequest({method:"GET",url:"/functions"}).then(function(e){return 200!==e.status||"object"!=typeof e.data?t.funcDefs=Ve.getFuncDefs(t.graphiteVersion):t.funcDefs=Ve.parseFuncDefs(e.data),t.funcDefs}).catch(function(e){return console.log("Fetching graphite functions error",e),t.funcDefs=Ve.getFuncDefs(t.graphiteVersion),t.funcDefs}),this.funcDefsPromise},this.testDatasource=function(){return this.query({panelId:3,rangeRaw:{from:"now-1h",to:"now"},targets:[{target:"constantLine(100)"}],maxDataPoints:300}).then(function(){return{status:"success",message:"Data source is working"}})},this.doGraphiteRequest=function(t){return(this.basicAuth||this.withCredentials)&&(t.withCredentials=!0),this.basicAuth&&(t.headers=t.headers||{},t.headers.Authorization=this.basicAuth),t.url=this.url+t.url,t.inspect={type:"graphite"},a.datasourceRequest(t)},this._seriesRefLetters="ABCDEFGHIJKLMNOPQRSTUVWXYZ",this.buildGraphiteParams=function(t,e){var a,n,i,s=["from","until","rawData","format","maxDataPoints","cacheTimeout"],o=[],l={},u=/\#([A-Z])/g,c=/'(\d+)m'/gi,h=!1;function p(t){return t.replace("m","min").replace("M","mon")}for(t.format="json",i=0;i<t.targets.length;i++)(a=t.targets[i]).target&&(a.refId||(a.refId=this._seriesRefLetters[i]),n=(n=r.replace(a.target,e)).replace(c,p),l[a.refId]=n);function d(t,e){return l[e]||t}for(i=0;i<t.targets.length;i++)(a=t.targets[i]).target&&(n=(n=l[a.refId]).replace(u,d),l[a.refId]=n,a.hide||(h=!0,o.push("target="+encodeURIComponent(n))));return A.a.each(t,function(t,e){-1!==A.a.indexOf(s,e)&&t&&o.push(e+"="+encodeURIComponent(t))}),h?o:[]}}var je=a(1198),Ue=a.n(je),Be=a(86),Qe=a.n(Be);function He(t){return{link:function(e,a){var r,n=this,i=e.ctrl,s=F()('<input type="text" class="gf-form-input" spellcheck="false" style="display:none"></input>'),o=F()('<a class="gf-form-label query-part dropdown-toggle" tabindex="1" gf-dropdown="functionMenu" data-toggle="dropdown"><i class="fa fa-plus"></i></a>');s.appendTo(a),o.appendTo(a),i.datasource.getFuncDefs().then(function(r){var n=A.a.map(r,"name").sort();e.functionMenu=function(t){var e={};return A.a.forEach(t,function(t){t.category&&(e[t.category]||(e[t.category]=[]),e[t.category].push({text:t.name,click:"ctrl.addFunction('"+t.name+"')"}))}),A.a.sortBy(A.a.map(e,function(t,e){return{text:e,submenu:A.a.sortBy(t,"text")}}),"text")}(r),s.attr("data-provide","typeahead"),s.typeahead({source:n,minLength:1,items:10,updater:function(t){var a=i.datasource.getFuncDef(t);return a||(t=t.toLowerCase(),a=A.a.find(n,function(e){return 0===e.toLowerCase().indexOf(t)}))?(e.$apply(function(){i.addFunction(a)}),s.trigger("blur"),""):""}}),o.click(function(){o.hide(),s.show(),s.focus()}),s.keyup(function(){a.toggleClass("open",""===s.val())}),s.blur(function(){setTimeout(function(){s.val(""),s.hide(),o.show(),a.removeClass("open")},200)}),t(a.contents())(e)});var l=function(){r&&(r.destroy(),r=null)};F()(a).on("mouseenter","ul.dropdown-menu li",function(){var t;l();try{t=i.datasource.getFuncDef(F()("a",n).text())}catch(t){}if(t&&t.description){var e=t.description;e.length>500&&(e=e.substring(0,497)+"...");var a=document.createElement("div");a.innerHTML="<h4>"+t.name+"</h4>"+Ue()(e),r=new Qe.a({target:n,content:a,classes:"drop-popover",openOn:"always",tetherOptions:{attachment:"bottom left",targetAttachment:"bottom right"}})}}).on("mouseout","ul.dropdown-menu li",function(){l()}),e.$on("$destroy",l)}}}function ze(t,e,a){var r='<input type="text" style="display:none" class="input-small tight-form-func-param"></input>';return{restrict:"A",link:function(n,i){var s=F()('<a ng-click="">{{func.def.name}}</a><span>(</span>'),o=F()('\n    <div class="tight-form-func-controls">\n      <span class="pointer fa fa-arrow-left"></span>\n      <span class="pointer fa fa-question-circle"></span>\n      <span class="pointer fa fa-remove" ></span>\n      <span class="pointer fa fa-arrow-right"></span>\n    </div>'),l=n.ctrl,u=n.func,c=!1,h=0,p=null;function d(t){var e=F()(this),a=e.prev(".comma"),r=e.next();r.val(u.params[t]),a.removeClass("query-part__last"),e.hide(),r.show(),r.focus(),r.select();var n=r.data("typeahead");n&&(r.val(""),n.lookup())}function m(t){return t<u.def.params.length?u.def.params[t]:A.a.last(u.def.params).multiple?A.a.assign({},A.a.last(u.def.params),{optional:!0}):{}}function f(t,a){var r=F()(t);clearTimeout(p),p=null;var i=r.prev(),s=i.prev(".comma"),o=r.val();(""!==o||m(a).optional)&&(u.updateParam(o,a),i.html(o?e.highlightVariablesAsHtml(o):"&nbsp;")),h!==u.params.length&&(c||(c=!0,setTimeout(function(){x(),c=!1},200))),n.$apply(function(){l.targetChanged()}),i.hasClass("query-part__last")&&""===o?s.addClass("query-part__last"):i.removeClass("query-part__last"),r.hide(),i.show()}function g(t){var e=this;p=setTimeout(function(){f(e,t)},200)}function v(t,e){13===e.which&&F()(this).blur()}function y(){this.style.width=8*(3+this.value.length)+"px"}function b(){var t=i.closest(".tight-form");if(i.hasClass("show-function-controls"))return i.removeClass("show-function-controls"),t.removeClass("has-open-function"),void o.hide();i.addClass("show-function-controls"),t.addClass("has-open-function"),o.show()}function S(){o.appendTo(i),s.appendTo(i);for(var a=A.a.clone(u.def.params),l=A.a.last(u.def.params);u.params.length>=a.length&&l&&l.multiple;)a.push(A.a.assign({},l,{optional:!0}));A.a.each(a,function(t,a){if(t.optional&&u.params.length<a)return!1;var n=e.highlightVariablesAsHtml(u.params[a]),s=a>=u.params.length-1&&t.optional&&!n;s&&t.multiple&&(n="+"),a>0&&F()('<span class="comma'+(s?" query-part__last":"")+'">, </span>').appendTo(i);var o=F()('<a ng-click="" class="graphite-func-param-link'+(s?" query-part__last":"")+'">'+(n||"&nbsp;")+"</a>"),l=F()(r);return l.attr("placeholder",t.name),h++,o.appendTo(i),l.appendTo(i),l.blur(A.a.partial(g,a)),l.keyup(y),l.keypress(A.a.partial(v,a)),o.click(A.a.partial(d,a)),t.options&&function(t,e){t.attr("data-provide","typeahead");var a=m(e).options;"int"===m(e).type&&(a=A.a.map(a,function(t){return t.toString()})),t.typeahead({source:a,minLength:0,items:20,updater:function(a){return t.val(a),f(t[0],e),a}}),t.data("typeahead").lookup=function(){return this.query=this.$element.val()||"",this.process(this.source)}}(l,a),!0}),F()("<span>)</span>").appendTo(i),t(i.contents())(n)}function x(){i.children().remove(),S(),n.func.added&&(n.func.added=!1,setTimeout(function(){i.find(".graphite-func-param-link").first().click()},10)),s.click(b),o.click(function(t){var e=F()(t.target);if(e.hasClass("fa-remove"))return b(),void n.$apply(function(){l.removeFunction(n.func)});if(e.hasClass("fa-arrow-left"))n.$apply(function(){A.a.move(l.queryModel.functions,n.$index,n.$index-1),l.targetChanged()});else if(e.hasClass("fa-arrow-right"))n.$apply(function(){A.a.move(l.queryModel.functions,n.$index,n.$index+1),l.targetChanged()});else if(e.hasClass("fa-question-circle")){var r=l.datasource.getFuncDef(u.def.name);r&&r.description?a.show({element:t.target,position:"bottom left",classNames:"drop-popover drop-function-def",template:'\n                  <div style="overflow:auto;max-height:30rem;">\n                    <h4> '+r.name+" </h4>\n                    "+Ue()(r.description)+"\n                  </div>",openOn:"click"}):window.open("http://graphite.readthedocs.org/en/latest/functions.html#graphite.render.functions."+u.def.name,"_blank")}})}x()}}}P.a.module("grafana.directives").directive("graphiteAddFunc",He),P.a.module("grafana.directives").directive("graphiteFuncEditor",ze);for(var Ye=[170,170,181,181,186,186,192,214,216,246,248,705,710,721,736,740,748,748,750,750,880,884,886,887,890,893,902,902,904,906,908,908,910,929,931,1013,1015,1153,1162,1319,1329,1366,1369,1369,1377,1415,1488,1514,1520,1522,1568,1610,1646,1647,1649,1747,1749,1749,1765,1766,1774,1775,1786,1788,1791,1791,1808,1808,1810,1839,1869,1957,1969,1969,1994,2026,2036,2037,2042,2042,2048,2069,2074,2074,2084,2084,2088,2088,2112,2136,2308,2361,2365,2365,2384,2384,2392,2401,2417,2423,2425,2431,2437,2444,2447,2448,2451,2472,2474,2480,2482,2482,2486,2489,2493,2493,2510,2510,2524,2525,2527,2529,2544,2545,2565,2570,2575,2576,2579,2600,2602,2608,2610,2611,2613,2614,2616,2617,2649,2652,2654,2654,2674,2676,2693,2701,2703,2705,2707,2728,2730,2736,2738,2739,2741,2745,2749,2749,2768,2768,2784,2785,2821,2828,2831,2832,2835,2856,2858,2864,2866,2867,2869,2873,2877,2877,2908,2909,2911,2913,2929,2929,2947,2947,2949,2954,2958,2960,2962,2965,2969,2970,2972,2972,2974,2975,2979,2980,2984,2986,2990,3001,3024,3024,3077,3084,3086,3088,3090,3112,3114,3123,3125,3129,3133,3133,3160,3161,3168,3169,3205,3212,3214,3216,3218,3240,3242,3251,3253,3257,3261,3261,3294,3294,3296,3297,3313,3314,3333,3340,3342,3344,3346,3386,3389,3389,3406,3406,3424,3425,3450,3455,3461,3478,3482,3505,3507,3515,3517,3517,3520,3526,3585,3632,3634,3635,3648,3654,3713,3714,3716,3716,3719,3720,3722,3722,3725,3725,3732,3735,3737,3743,3745,3747,3749,3749,3751,3751,3754,3755,3757,3760,3762,3763,3773,3773,3776,3780,3782,3782,3804,3805,3840,3840,3904,3911,3913,3948,3976,3980,4096,4138,4159,4159,4176,4181,4186,4189,4193,4193,4197,4198,4206,4208,4213,4225,4238,4238,4256,4293,4304,4346,4348,4348,4352,4680,4682,4685,4688,4694,4696,4696,4698,4701,4704,4744,4746,4749,4752,4784,4786,4789,4792,4798,4800,4800,4802,4805,4808,4822,4824,4880,4882,4885,4888,4954,4992,5007,5024,5108,5121,5740,5743,5759,5761,5786,5792,5866,5870,5872,5888,5900,5902,5905,5920,5937,5952,5969,5984,5996,5998,6e3,6016,6067,6103,6103,6108,6108,6176,6263,6272,6312,6314,6314,6320,6389,6400,6428,6480,6509,6512,6516,6528,6571,6593,6599,6656,6678,6688,6740,6823,6823,6917,6963,6981,6987,7043,7072,7086,7087,7104,7141,7168,7203,7245,7247,7258,7293,7401,7404,7406,7409,7424,7615,7680,7957,7960,7965,7968,8005,8008,8013,8016,8023,8025,8025,8027,8027,8029,8029,8031,8061,8064,8116,8118,8124,8126,8126,8130,8132,8134,8140,8144,8147,8150,8155,8160,8172,8178,8180,8182,8188,8305,8305,8319,8319,8336,8348,8450,8450,8455,8455,8458,8467,8469,8469,8473,8477,8484,8484,8486,8486,8488,8488,8490,8493,8495,8505,8508,8511,8517,8521,8526,8526,8544,8584,11264,11310,11312,11358,11360,11492,11499,11502,11520,11557,11568,11621,11631,11631,11648,11670,11680,11686,11688,11694,11696,11702,11704,11710,11712,11718,11720,11726,11728,11734,11736,11742,11823,11823,12293,12295,12321,12329,12337,12341,12344,12348,12353,12438,12445,12447,12449,12538,12540,12543,12549,12589,12593,12686,12704,12730,12784,12799,13312,13312,19893,19893,19968,19968,40907,40907,40960,42124,42192,42237,42240,42508,42512,42527,42538,42539,42560,42606,42623,42647,42656,42735,42775,42783,42786,42888,42891,42894,42896,42897,42912,42921,43002,43009,43011,43013,43015,43018,43020,43042,43072,43123,43138,43187,43250,43255,43259,43259,43274,43301,43312,43334,43360,43388,43396,43442,43471,43471,43520,43560,43584,43586,43588,43595,43616,43638,43642,43642,43648,43695,43697,43697,43701,43702,43705,43709,43712,43712,43714,43714,43739,43741,43777,43782,43785,43790,43793,43798,43808,43814,43816,43822,43968,44002,44032,44032,55203,55203,55216,55238,55243,55291,63744,64045,64048,64109,64112,64217,64256,64262,64275,64279,64285,64285,64287,64296,64298,64310,64312,64316,64318,64318,64320,64321,64323,64324,64326,64433,64467,64829,64848,64911,64914,64967,65008,65019,65136,65140,65142,65276,65313,65338,65345,65370,65382,65470,65474,65479,65482,65487,65490,65495,65498,65500,65536,65547,65549,65574,65576,65594,65596,65597,65599,65613,65616,65629,65664,65786,65856,65908,66176,66204,66208,66256,66304,66334,66352,66378,66432,66461,66464,66499,66504,66511,66513,66517,66560,66717,67584,67589,67592,67592,67594,67637,67639,67640,67644,67644,67647,67669,67840,67861,67872,67897,68096,68096,68112,68115,68117,68119,68121,68147,68192,68220,68352,68405,68416,68437,68448,68466,68608,68680,69635,69687,69763,69807,73728,74606,74752,74850,77824,78894,92160,92728,110592,110593,119808,119892,119894,119964,119966,119967,119970,119970,119973,119974,119977,119980,119982,119993,119995,119995,119997,120003,120005,120069,120071,120074,120077,120084,120086,120092,120094,120121,120123,120126,120128,120132,120134,120134,120138,120144,120146,120485,120488,120512,120514,120538,120540,120570,120572,120596,120598,120628,120630,120654,120656,120686,120688,120712,120714,120744,120746,120770,120772,120779,131072,131072,173782,173782,173824,173824,177972,177972,177984,177984,178205,178205,194560,195101],We=[],Ge=0;Ge<128;Ge++)We[Ge]=Ge>=48&&Ge<=57||36===Ge||126===Ge||124===Ge||Ge>=65&&Ge<=90||95===Ge||45===Ge||42===Ge||58===Ge||91===Ge||93===Ge||63===Ge||37===Ge||35===Ge||61===Ge||Ge>=97&&Ge<=122;var Ke=We;function Je(t){this.input=t,this.char=1,this.from=1}function Xe(t){this.expression=t,this.lexer=new Je(t),this.tokens=this.lexer.tokenize(),this.index=0}Je.prototype={peek:function(t){return this.input.charAt(t||0)},skip:function(t){t=t||1,this.char+=t,this.input=this.input.slice(t)},tokenize:function(){for(var t=[],e=this.next();e;)t.push(e),e=this.next();return t},next:function(){if(this.from=this.char,/\s/.test(this.peek())){for(;/\s/.test(this.peek());)this.from+=1,this.skip();if(""===this.peek())return null}var t=this.scanStringLiteral();return t||((t=this.scanPunctuator()||this.scanNumericLiteral()||this.scanIdentifier()||this.scanTemplateSequence())?(this.skip(t.value.length),t):null)},scanTemplateSequence:function(){return"["===this.peek()&&"["===this.peek(1)?{type:"templateStart",value:"[[",pos:this.char}:"]"===this.peek()&&"]"===this.peek(1)?{type:"templateEnd",value:"[[",pos:this.char}:null},scanIdentifier:function(){var t,e,a="",r=0;function n(t){for(var e=0;e<Ye.length;){if(t<Ye[e++])return!1;if(t<=Ye[e++])return!0}return!1}function i(t){return/^[0-9a-fA-F]$/.test(t)}var s=A.a.bind(function(){if(r+=1,"u"!==this.peek(r))return null;var t=this.peek(r+1),e=this.peek(r+2),a=this.peek(r+3),s=this.peek(r+4);return i(t)&&i(e)&&i(a)&&i(s)&&n(parseInt(t+e+a+s,16))?(r+=5,"\\u"+t+e+a+s):null},this),o=A.a.bind(function(){var t=this.peek(r),e=t.charCodeAt(0);return"*"===t?(r+=1,t):92===e?s():e<128?We[e]?(r+=1,t):null:n(e)?(r+=1,t):null},this),l=A.a.bind(function(){var t=this.peek(r),e=t.charCodeAt(0);return 92===e?s():e<128?Ke[e]?(r+=1,t):null:n(e)?(r+=1,t):null},this);if(null===(e=o()))return null;for(a=e;null!==(e=l());)a+=e;switch(a){case"true":case"false":t="bool";break;default:t="identifier"}return{type:t,value:a,pos:this.char}},scanNumericLiteral:function(){var t,e=0,a="",r=this.input.length,n=this.peek(e);function i(t){return/^[0-9]$/.test(t)}function s(t){return/^[0-7]$/.test(t)}function o(t){return/^[0-9a-fA-F]$/.test(t)}function l(t){return"$"===t||"_"===t||"\\"===t||t>="a"&&t<="z"||t>="A"&&t<="Z"}if("-"===n&&(a+=n,e+=1,n=this.peek(e)),"."!==n&&!i(n))return null;if("."!==n){if(a+=this.peek(e),e+=1,n=this.peek(e),"0"===a){if("x"===n||"X"===n){for(e+=1,a+=n;e<r&&o(n=this.peek(e));)a+=n,e+=1;return a.length<=2?{type:"number",value:a,isMalformed:!0,pos:this.char}:e<r&&l(n=this.peek(e))?null:{type:"number",value:a,base:16,isMalformed:!1,pos:this.char}}if(s(n)){for(e+=1,a+=n,t=!1;e<r;){if(i(n=this.peek(e))&&(t=!0),!s(n)){if(!this.isPunctuator(n))return null;break}a+=n,e+=1}return e<r&&l(n=this.peek(e))?null:{type:"number",value:a,base:8,isMalformed:t}}i(n)&&(e+=1,a+=n)}for(;e<r&&i(n=this.peek(e));)a+=n,e+=1}if("."===n)for(a+=n,e+=1;e<r&&i(n=this.peek(e));)a+=n,e+=1;if("e"===n||"E"===n){if(a+=n,e+=1,"+"!==(n=this.peek(e))&&"-"!==n||(a+=this.peek(e),e+=1),!i(n=this.peek(e)))return null;for(a+=n,e+=1;e<r&&i(n=this.peek(e));)a+=n,e+=1}return e<r&&(n=this.peek(e),!this.isPunctuator(n))?null:{type:"number",value:a,base:10,pos:this.char,isMalformed:!isFinite(+a)}},isPunctuator:function(t){switch(t){case".":case"(":case")":case",":case"{":case"}":return!0}return!1},scanPunctuator:function(){var t=this.peek();return this.isPunctuator(t)?{type:t,value:t,pos:this.char}:null},scanStringLiteral:function(){var t=this.peek();if('"'!==t&&"'"!==t)return null;var e="";for(this.skip();this.peek()!==t;){if(""===this.peek())return{type:"string",value:e,isUnclosed:!0,quote:t,pos:this.char};e+=this.peek(),this.skip(1)}return this.skip(),{type:"string",value:e,isUnclosed:!1,quote:t,pos:this.char}}},Xe.prototype={getAst:function(){return this.start()},start:function(){try{return this.functionCall()||this.metricExpression()}catch(t){return{type:"error",message:t.message,pos:t.pos}}},curlyBraceSegment:function(){if(this.match("identifier","{")||this.match("{")){for(var t="";!this.match("")&&!this.match("}");)t+=this.consumeToken().value;return this.match("}")||this.errorMark("Expected closing '}'"),t+=this.consumeToken().value,this.match("identifier")&&(t+=this.consumeToken().value),{type:"segment",value:t}}return null},metricSegment:function(){var t=this.curlyBraceSegment();if(t)return t;if(this.match("identifier")||this.match("number")){var e=this.consumeToken().value.split(".");return 2===e.length&&(this.tokens.splice(this.index,0,{type:"."}),this.tokens.splice(this.index+1,0,{type:"number",value:e[1]})),{type:"segment",value:e[0]}}this.match("templateStart")||this.errorMark("Expected metric identifier"),this.consumeToken(),this.match("identifier")||this.errorMark("Expected identifier after templateStart");var a={type:"template",value:this.consumeToken().value};return this.match("templateEnd")||this.errorMark("Expected templateEnd"),this.consumeToken(),a},metricExpression:function(){if(!(this.match("templateStart")||this.match("identifier")||this.match("number")||this.match("{")))return null;var t={type:"metric",segments:[]};for(t.segments.push(this.metricSegment());this.match(".");){this.consumeToken();var e=this.metricSegment();e||this.errorMark("Expected metric identifier"),t.segments.push(e)}return t},functionCall:function(){if(!this.match("identifier","("))return null;var t={type:"function",name:this.consumeToken().value};return this.consumeToken(),t.params=this.functionParameters(),this.match(")")||this.errorMark("Expected closing parenthesis"),this.consumeToken(),t},boolExpression:function(){return this.match("bool")?{type:"bool",value:"true"===this.consumeToken().value}:null},functionParameters:function(){if(this.match(")")||this.match(""))return[];var t=this.functionCall()||this.numericLiteral()||this.seriesRefExpression()||this.boolExpression()||this.metricExpression()||this.stringLiteral();return this.match(",")?(this.consumeToken(),[t].concat(this.functionParameters())):[t]},seriesRefExpression:function(){return this.match("identifier")&&this.tokens[this.index].value.match(/\#[A-Z]/)?{type:"series-ref",value:this.consumeToken().value}:null},numericLiteral:function(){return this.match("number")?{type:"number",value:parseFloat(this.consumeToken().value)}:null},stringLiteral:function(){if(!this.match("string"))return null;var t=this.consumeToken();if(t.isUnclosed)throw{message:"Unclosed string parameter",pos:t.pos};return{type:"string",value:t.value}},errorMark:function(t){var e=this.tokens[this.index];throw{message:t+" instead found "+(e?e.type:"end of string"),pos:e?e.pos:this.lexer.char}},consumeToken:function(){return this.index++,this.tokens[this.index-1]},matchToken:function(t,e){var a=this.tokens[this.index+e];return void 0===a&&""===t||a&&a.type===t},match:function(t,e){return this.matchToken(t,0)&&(!e||this.matchToken(e,1))}};var Ze=function(){function t(t,e,a,r){this.datasource=t,this.target=e,this.parseTarget(),this.removeTagValue="-- remove tag --"}return t.$inject=["datasource","target","templateSrv","scopedVars"],t.prototype.parseTarget=function(){if(this.functions=[],this.segments=[],this.tags=[],this.error=null,!this.target.textEditor){var t=new Xe(this.target.target).getAst();if(null!==t){if("error"===t.type)return this.error=t.message+" at position: "+t.pos,void(this.target.textEditor=!0);try{this.parseTargetRecursive(t,null)}catch(t){console.log("error parsing target:",t.message),this.error=t.message,this.target.textEditor=!0}this.checkOtherSegmentsIndex=this.segments.length-1,this.checkForSeriesByTag()}else this.checkOtherSegmentsIndex=0}},t.prototype.checkForSeriesByTag=function(){var t=A.a.find(this.functions,function(t){return"seriesByTag"===t.def.name});if(t){this.seriesByTagUsed=!0,t.hidden=!0;var e=this.splitSeriesByTagParams(t);this.tags=e}},t.prototype.getSegmentPathUpTo=function(t){var e=this.segments.slice(0,t);return A.a.reduce(e,function(t,e){return t?t+"."+e.value:e.value},"")},t.prototype.parseTargetRecursive=function(t,e){var a=this;if(null===t)return null;switch(t.type){case"function":var r=this.datasource.createFuncInstance(t.name,{withDefaultParams:!1});A.a.each(t.params,function(t){a.parseTargetRecursive(t,r)}),r.updateText(),this.functions.push(r);break;case"series-ref":this.segments.length>0?this.addFunctionParameter(e,t.value):this.segments.push(t);break;case"bool":case"string":case"number":this.addFunctionParameter(e,t.value);break;case"metric":this.segments.length>0?this.addFunctionParameter(e,A.a.join(A.a.map(t.segments,"value"),".")):this.segments=t.segments}},t.prototype.updateSegmentValue=function(t,e){this.segments[e].value=t.value},t.prototype.addSelectMetricSegment=function(){this.segments.push({value:"select metric"})},t.prototype.addFunction=function(t){this.functions.push(t),this.moveAliasFuncLast()},t.prototype.moveAliasFuncLast=function(){var t=A.a.find(this.functions,function(t){return t.def.name.startsWith("alias")});t&&(this.functions=A.a.without(this.functions,t),this.functions.push(t))},t.prototype.addFunctionParameter=function(t,e){if(t.params.length>=t.def.params.length&&!A.a.get(A.a.last(t.def.params),"multiple",!1))throw{message:"too many parameters for function "+t.def.name};t.params.push(e)},t.prototype.removeFunction=function(t){this.functions=A.a.without(this.functions,t)},t.prototype.updateModelTarget=function(t){if(!this.target.textEditor){var e=this.getSegmentPathUpTo(this.segments.length).replace(/\.select metric$/,"");this.target.target=A.a.reduce(this.functions,ta,e)}this.updateRenderedTarget(this.target,t);for(var a=0,r=t||[];a<r.length;a++){var n=r[a];n.refId!==this.target.refId&&this.updateRenderedTarget(n,t)}},t.prototype.updateRenderedTarget=function(t,e){var a=A.a.keyBy(e,"refId");delete a[t.refId];var r=/\#([A-Z])/g,n=t.target;for(A.a.each(a,function(t,e){!function(t,e){var a=0;A.a.each(t,function(t,n){if(n!==e){var i=r.exec(t.target),s=i&&i.length?i.length-1:0;a+=s}}),t[e].refCount=a}(a,e)});n.match(r);){var i=n.replace(r,function(t,e){var r=a[e];return r?(0===r.refCount&&delete a[e],r.refCount--,r.target):t});if(i===n)break;n=i}delete t.targetFull,t.target!==n&&(t.targetFull=n)},t.prototype.splitSeriesByTagParams=function(t){var e=/([^\!=~]+)(\!?=~?)(.*)/;return A.a.flatten(A.a.map(t.params,function(t){var a=e.exec(t);if(a){var r=a.slice(1);if(3===r.length)return{key:r[0],operator:r[1],value:r[2]}}return[]}))},t.prototype.getSeriesByTagFuncIndex=function(){return A.a.findIndex(this.functions,function(t){return"seriesByTag"===t.def.name})},t.prototype.getSeriesByTagFunc=function(){var t=this.getSeriesByTagFuncIndex();return t>=0?this.functions[t]:void 0},t.prototype.addTag=function(t){var e=ea(t);this.getSeriesByTagFunc().params.push(e),this.tags.push(t)},t.prototype.removeTag=function(t){this.getSeriesByTagFunc().params.splice(t,1),this.tags.splice(t,1)},t.prototype.updateTag=function(t,e){if(this.error=null,t.key!==this.removeTagValue){var a=ea(t);this.getSeriesByTagFunc().params[e]=a,this.tags[e]=t}else this.removeTag(e)},t.prototype.renderTagExpressions=function(t){return void 0===t&&(t=-1),A.a.compact(A.a.map(this.tags,function(e,a){if(a!==t)return e.key+e.operator+e.value}))},t}();function ta(t,e){return e.render(t)}function ea(t){return t.key+t.operator+t.value}var aa=["=","!=","=~","!=~"],ra="tag: ",na=function(t){function e(e,a,r,n,i){var s=t.call(this,e,a)||this;return s.uiSegmentSrv=r,s.templateSrv=n,s.supportsTags=s.datasource.supportsTags,s.paused=!1,s.target.target=s.target.target||"",s.datasource.waitForFuncDefsLoaded().then(function(){s.queryModel=new Ze(s.datasource,s.target,n),s.buildSegments()}),s.removeTagValue="-- remove tag --",s}return e.$inject=["$scope","$injector","uiSegmentSrv","templateSrv","$timeout"],Rt.d(e,t),e.prototype.parseTarget=function(){this.queryModel.parseTarget(),this.buildSegments()},e.prototype.toggleEditorMode=function(){this.target.textEditor=!this.target.textEditor,this.parseTarget()},e.prototype.buildSegments=function(){var t=this;this.segments=A.a.map(this.queryModel.segments,function(e){return t.uiSegmentSrv.newSegment(e)});var e=this.queryModel.checkOtherSegmentsIndex||0;this.checkOtherSegments(e),this.queryModel.seriesByTagUsed&&this.fixTagSegments()},e.prototype.addSelectMetricSegment=function(){this.queryModel.addSelectMetricSegment(),this.segments.push(this.uiSegmentSrv.newSelectMetric())},e.prototype.checkOtherSegments=function(t){var e=this;if(1!==this.queryModel.segments.length||"series-ref"!==this.queryModel.segments[0].type){if(0!==t){var a=this.queryModel.getSegmentPathUpTo(t+1);return""===a?Promise.resolve():this.datasource.metricFindQuery(a).then(function(r){if(0===r.length)""!==a&&(e.queryModel.segments=e.queryModel.segments.splice(0,t),e.segments=e.segments.splice(0,t),e.addSelectMetricSegment());else if(r[0].expandable){if(e.segments.length!==t)return e.checkOtherSegments(t+1);e.addSelectMetricSegment()}}).catch(function(t){et.a.emit("alert-error",["Error",t])})}this.addSelectMetricSegment()}},e.prototype.setSegmentFocus=function(t){A.a.each(this.segments,function(e,a){e.focus=t===a})},e.prototype.getAltSegments=function(t,e){var a=this,r=e&&e.length>0?"*"+e+"*":"*";t>0&&(r=this.queryModel.getSegmentPathUpTo(t)+"."+r);var n={range:this.panelCtrl.range,requestId:"get-alt-segments"};return this.datasource.metricFindQuery(r,n).then(function(r){var n=A.a.map(r,function(t){return a.uiSegmentSrv.newSegment({value:t.text,expandable:t.expandable})});return t>0&&0===n.length?n:(0===t&&A.a.eachRight(a.panelCtrl.panel.targets,function(t){t.refId!==a.queryModel.target.refId&&n.unshift(a.uiSegmentSrv.newSegment({type:"series-ref",value:"#"+t.refId,expandable:!1}))}),A.a.eachRight(a.templateSrv.variables,function(t){n.unshift(a.uiSegmentSrv.newSegment({type:"template",value:"$"+t.name,expandable:!0}))}),n.unshift(a.uiSegmentSrv.newSegment("*")),a.supportsTags&&0===t?(a.removeTaggedEntry(n),a.addAltTagSegments(e,n)):n)}).catch(function(t){return[]})},e.prototype.addAltTagSegments=function(t,e){return this.getTagsAsSegments(t).then(function(t){return t=A.a.map(t,function(t){return t.value=ra+t.value,t}),e.concat.apply(e,t)})},e.prototype.removeTaggedEntry=function(t){t=A.a.remove(t,function(t){return"_tagged"===t.value})},e.prototype.segmentValueChanged=function(t,e){var a=this;if(this.error=null,this.queryModel.updateSegmentValue(t,e),this.queryModel.functions.length>0&&this.queryModel.functions[0].def.fake&&(this.queryModel.functions=[]),"tag"===t.type){var r=function(t){return t.replace(ra,"")}(t.value);return this.pause(),void this.addSeriesByTagFunc(r)}if(t.expandable)return this.checkOtherSegments(e+1).then(function(){a.setSegmentFocus(e+1),a.targetChanged()});this.spliceSegments(e+1),this.setSegmentFocus(e+1),this.targetChanged()},e.prototype.spliceSegments=function(t){this.segments=this.segments.splice(0,t),this.queryModel.segments=this.queryModel.segments.splice(0,t)},e.prototype.emptySegments=function(){this.queryModel.segments=[],this.segments=[]},e.prototype.targetTextChanged=function(){this.updateModelTarget(),this.refresh()},e.prototype.updateModelTarget=function(){this.queryModel.updateModelTarget(this.panelCtrl.panel.targets)},e.prototype.targetChanged=function(){if(!this.queryModel.error){var t=this.queryModel.target.target;this.updateModelTarget(),this.queryModel.target===t||this.paused||this.panelCtrl.refresh()}},e.prototype.addFunction=function(t){var e=this.datasource.createFuncInstance(t,{withDefaultParams:!0});e.added=!0,this.queryModel.addFunction(e),this.smartlyHandleNewAliasByNode(e),1===this.segments.length&&this.segments[0].fake&&this.emptySegments(),!e.params.length&&e.added&&this.targetChanged(),"seriesByTag"===e.def.name&&this.parseTarget()},e.prototype.removeFunction=function(t){this.queryModel.removeFunction(t),this.targetChanged()},e.prototype.addSeriesByTagFunc=function(t){var e=this.datasource.createFuncInstance("seriesByTag",{withDefaultParams:!1}),a=t+"=";e.params=[a],this.queryModel.addFunction(e),e.added=!0,this.emptySegments(),this.targetChanged(),this.parseTarget()},e.prototype.smartlyHandleNewAliasByNode=function(t){if("aliasByNode"===t.def.name)for(var e=0;e<this.segments.length;e++)if(this.segments[e].value.indexOf("*")>=0)return t.params[0]=e,t.added=!1,void this.targetChanged()},e.prototype.getAllTags=function(){var t=this;return this.datasource.getTags().then(function(e){var a=A.a.map(e,"text");return a.splice(0,0,t.removeTagValue),ia(a)})},e.prototype.getTags=function(t,e){var a=this,r=this.queryModel.renderTagExpressions(t);return this.datasource.getTagsAutoComplete(r,e).then(function(t){var e=A.a.map(t,"text");return e.splice(0,0,a.removeTagValue),ia(e)})},e.prototype.getTagsAsSegments=function(t){var e=this,a=this.queryModel.renderTagExpressions();return this.datasource.getTagsAutoComplete(a,t).then(function(t){return A.a.map(t,function(t){return e.uiSegmentSrv.newSegment({value:t.text,type:"tag",expandable:!1})})})},e.prototype.getTagOperators=function(){return ia(aa)},e.prototype.getAllTagValues=function(t){var e=t.key;return this.datasource.getTagValues(e).then(function(t){return ia(A.a.map(t,"text"))})},e.prototype.getTagValues=function(t,e,a){var r=this,n=this.queryModel.renderTagExpressions(e),i=t.key;return this.datasource.getTagValuesAutoComplete(n,i,a).then(function(t){var e=A.a.map(t,"text");return A.a.eachRight(r.templateSrv.variables,function(t){e.push("${"+t.name+":regex}")}),ia(e)})},e.prototype.tagChanged=function(t,e){this.queryModel.updateTag(t,e),this.targetChanged()},e.prototype.addNewTag=function(t){var e={key:t.value,operator:"=",value:""};this.queryModel.addTag(e),this.targetChanged(),this.fixTagSegments()},e.prototype.removeTag=function(t){this.queryModel.removeTag(t),this.targetChanged()},e.prototype.fixTagSegments=function(){this.addTagSegments=[this.uiSegmentSrv.newPlusButton()]},e.prototype.showDelimiter=function(t){return t!==this.queryModel.tags.length-1},e.prototype.pause=function(){this.paused=!0},e.prototype.unpause=function(){this.paused=!1,this.panelCtrl.refresh()},e.templateUrl="partials/query.editor.html",e}(Qt);function ia(t){return A.a.map(t,function(t){return{text:t,value:t}})}var sa=function(){function t(t,e){this.graphiteVersions=[{name:"0.9.x",value:"0.9"},{name:"1.0.x",value:"1.0"},{name:"1.1.x",value:"1.1"}],this.datasourceSrv=e,this.current.jsonData=this.current.jsonData||{},this.current.jsonData.graphiteVersion=this.current.jsonData.graphiteVersion||"0.9",this.autoDetectGraphiteVersion()}return t.$inject=["$scope","datasourceSrv"],t.prototype.autoDetectGraphiteVersion=function(){var t=this;this.current.id&&this.datasourceSrv.loadDatasource(this.current.name).then(function(t){return t.getVersion()}).then(function(e){t.graphiteVersions.push({name:e,value:e}),t.current.jsonData.graphiteVersion=e})},t.templateUrl="public/app/plugins/datasource/graphite/partials/config.html",t}(),oa=function(){function t(){}return t.templateUrl="partials/annotations.editor.html",t}(),la=function(){return function(){return{templateUrl:"public/app/plugins/datasource/cloudwatch/partials/query.parameter.html",controller:"CloudWatchQueryParameterCtrl",restrict:"E",scope:{target:"=",datasource:"=",onChange:"&"}}}}(),ua=function(){function t(t,e,a,r,n){t.init=function(){var e=t.target;e.namespace=e.namespace||"",e.metricName=e.metricName||"",e.statistics=e.statistics||["Average"],e.dimensions=e.dimensions||{},e.period=e.period||"",e.region=e.region||"default",e.id=e.id||"",e.expression=e.expression||"",e.returnData=e.returnData||!1,e.highResolution=e.highResolution||!1,t.regionSegment=a.getSegmentForValue(t.target.region,"select region"),t.namespaceSegment=a.getSegmentForValue(t.target.namespace,"select namespace"),t.metricSegment=a.getSegmentForValue(t.target.metricName,"select metric"),t.dimSegments=A.a.reduce(t.target.dimensions,function(t,e,r){return t.push(a.newKey(r)),t.push(a.newOperator("=")),t.push(a.newKeyValue(e)),t},[]),t.statSegments=A.a.map(t.target.statistics,function(t){return a.getSegmentForValue(t)}),t.ensurePlusButton(t.statSegments),t.ensurePlusButton(t.dimSegments),t.removeDimSegment=a.newSegment({fake:!0,value:"-- remove dimension --"}),t.removeStatSegment=a.newSegment({fake:!0,value:"-- remove stat --"}),A.a.isEmpty(t.target.region)&&(t.target.region="default"),t.onChange||(t.onChange=function(){})},t.getStatSegments=function(){return n.when(A.a.flatten([P.a.copy(t.removeStatSegment),A.a.map(t.datasource.standardStatistics,function(t){return a.getSegmentForValue(t)}),a.getSegmentForValue("pNN.NN")]))},t.statSegmentChanged=function(e,a){e.value===t.removeStatSegment.value?t.statSegments.splice(a,1):e.type="value",t.target.statistics=A.a.reduce(t.statSegments,function(t,e){return e.fake||t.push(e.value),t},[]),t.ensurePlusButton(t.statSegments),t.onChange()},t.ensurePlusButton=function(t){var e=t.length,r=t[Math.max(e-1,0)];r&&"plus-button"===r.type||t.push(a.newPlusButton())},t.getDimSegments=function(e,a){if("operator"===e.type)return n.when([]);var r=t.target,i=n.when([]);if("key"===e.type||"plus-button"===e.type)i=t.datasource.getDimensionKeys(t.target.namespace,t.target.region);else if("value"===e.type){var s=t.dimSegments[a-2].value;i=t.datasource.getDimensionValues(r.region,r.namespace,r.metricName,s,r.dimensions)}return i.then(t.transformToSegments(!0)).then(function(a){return"key"===e.type&&a.splice(0,0,P.a.copy(t.removeDimSegment)),a})},t.dimSegmentChanged=function(e,r){t.dimSegments[r]=e,e.value===t.removeDimSegment.value?t.dimSegments.splice(r,3):"plus-button"===e.type&&(t.dimSegments.push(a.newOperator("=")),t.dimSegments.push(a.newFake("select dimension value","value","query-segment-value")),e.type="key",e.cssClass="query-segment-key"),t.syncDimSegmentsWithModel(),t.ensurePlusButton(t.dimSegments),t.onChange()},t.syncDimSegmentsWithModel=function(){for(var e={},a=t.dimSegments.length,r=0;r<a-2;r+=3){var n=t.dimSegments[r],i=t.dimSegments[r+2];i.fake||(e[n.value]=i.value)}t.target.dimensions=e},t.getRegions=function(){return t.datasource.metricFindQuery("regions()").then(function(t){return t.unshift({text:"default"}),t}).then(t.transformToSegments(!0))},t.getNamespaces=function(){return t.datasource.metricFindQuery("namespaces()").then(t.transformToSegments(!0))},t.getMetrics=function(){return t.datasource.metricFindQuery("metrics("+t.target.namespace+","+t.target.region+")").then(t.transformToSegments(!0))},t.regionChanged=function(){t.target.region=t.regionSegment.value,t.onChange()},t.namespaceChanged=function(){t.target.namespace=t.namespaceSegment.value,t.onChange()},t.metricChanged=function(){t.target.metricName=t.metricSegment.value,t.onChange()},t.transformToSegments=function(t){return function(r){var n=A.a.map(r,function(t){return a.newSegment({value:t.text,expandable:t.expandable})});return t&&A.a.each(e.variables,function(t){n.unshift(a.newSegment({type:"template",value:"$"+t.name,expandable:!0}))}),n}},t.init()}return t.$inject=["$scope","templateSrv","uiSegmentSrv","datasourceSrv","$q"],t}();P.a.module("grafana.controllers").directive("cloudwatchQueryParameter",la),P.a.module("grafana.controllers").controller("CloudWatchQueryParameterCtrl",ua);var ca=function(){function t(t,e,a,r,n){this.$q=e,this.backendSrv=a,this.templateSrv=r,this.timeSrv=n,this.type="cloudwatch",this.name=t.name,this.supportMetrics=!0,this.proxyUrl=t.url,this.defaultRegion=t.jsonData.defaultRegion,this.instanceSettings=t,this.standardStatistics=["Average","Maximum","Minimum","Sum","SampleCount"]}return t.$inject=["instanceSettings","$q","backendSrv","templateSrv","timeSrv"],t.prototype.query=function(t){var e=this;(t=P.a.copy(t)).targets=this.expandTemplateVariable(t.targets,t.scopedVars,this.templateSrv);var a=A.a.filter(t.targets,function(t){return(""!==t.id||!0!==t.hide)&&(!!t.region&&!!t.namespace&&!!t.metricName&&!A.a.isEmpty(t.statistics)||t.expression.length>0)}).map(function(a){if(a.region=e.templateSrv.replace(e.getActualRegion(a.region),t.scopedVars),a.namespace=e.templateSrv.replace(a.namespace,t.scopedVars),a.metricName=e.templateSrv.replace(a.metricName,t.scopedVars),a.dimensions=e.convertDimensionFormat(a.dimensions,t.scopedVars),a.period=String(e.getPeriod(a,t)),a.id=e.templateSrv.replace(a.id,t.scopedVars),a.expression=e.templateSrv.replace(a.expression,t.scopedVars),a.returnData=void 0===a.hide||!a.hide,a.statistics.some(function(t){return 0===t.indexOf("p")&&!/p\d{2}\.\d{2}/.test(t)}))throw{message:"Invalid extended statistics"};return A.a.extend({refId:a.refId,intervalMs:t.intervalMs,maxDataPoints:t.maxDataPoints,datasourceId:e.instanceSettings.id,type:"timeSeriesQuery"},a)});if(A.a.isEmpty(a)){var r=this.$q.defer();return r.resolve({data:[]}),r.promise}var n={from:t.range.from.valueOf().toString(),to:t.range.to.valueOf().toString(),queries:a};return this.performTimeSeriesQuery(n)},t.prototype.getPeriod=function(t,e,a){var r,n=this.convertToCloudWatchTime(e.range.from,!1),i=this.convertToCloudWatchTime(e.range.to,!0);a=Math.round((a||Date.now())/1e3);var s=i-n,o=60;return t.period?r=/^\d+$/.test(t.period)?parseInt(t.period,10):J.a.interval_to_seconds(this.templateSrv.replace(t.period,e.scopedVars)):o=r=a-n<=1296e3?"AWS/EC2"===t.namespace?300:60:a-n<=5443200?300:3600,r<1&&(r=1),!t.highResolution&&s/r>=1440&&(r=Math.ceil(s/1440/o)*o),r},t.prototype.performTimeSeriesQuery=function(t){return this.awsRequest("/api/tsdb/query",t).then(function(t){var e=[];return t.results&&A.a.forEach(t.results,function(t){A.a.forEach(t.series,function(t){e.push({target:t.name,datapoints:t.points})})}),{data:e}})},t.prototype.transformSuggestDataFromTable=function(t){return A.a.map(t.results.metricFindQuery.tables[0].rows,function(t){return{text:t[0],value:t[1]}})},t.prototype.doMetricQueryRequest=function(t,e){var a=this,r=this.timeSrv.timeRange();return this.awsRequest("/api/tsdb/query",{from:r.from.valueOf().toString(),to:r.to.valueOf().toString(),queries:[A.a.extend({refId:"metricFindQuery",intervalMs:1,maxDataPoints:1,datasourceId:this.instanceSettings.id,type:"metricFindQuery",subtype:t},e)]}).then(function(t){return a.transformSuggestDataFromTable(t)})},t.prototype.getRegions=function(){return this.doMetricQueryRequest("regions",null)},t.prototype.getNamespaces=function(){return this.doMetricQueryRequest("namespaces",null)},t.prototype.getMetrics=function(t,e){return this.doMetricQueryRequest("metrics",{region:this.templateSrv.replace(this.getActualRegion(e)),namespace:this.templateSrv.replace(t)})},t.prototype.getDimensionKeys=function(t,e){return this.doMetricQueryRequest("dimension_keys",{region:this.templateSrv.replace(this.getActualRegion(e)),namespace:this.templateSrv.replace(t)})},t.prototype.getDimensionValues=function(t,e,a,r,n){return this.doMetricQueryRequest("dimension_values",{region:this.templateSrv.replace(this.getActualRegion(t)),namespace:this.templateSrv.replace(e),metricName:this.templateSrv.replace(a),dimensionKey:this.templateSrv.replace(r),dimensions:this.convertDimensionFormat(n,{})})},t.prototype.getEbsVolumeIds=function(t,e){return this.doMetricQueryRequest("ebs_volume_ids",{region:this.templateSrv.replace(this.getActualRegion(t)),instanceId:this.templateSrv.replace(e)})},t.prototype.getEc2InstanceAttribute=function(t,e,a){return this.doMetricQueryRequest("ec2_instance_attribute",{region:this.templateSrv.replace(this.getActualRegion(t)),attributeName:this.templateSrv.replace(e),filters:a})},t.prototype.metricFindQuery=function(t){var e,a,r,n;if(t.match(/^regions\(\)/))return this.getRegions();if(t.match(/^namespaces\(\)/))return this.getNamespaces();var i=t.match(/^metrics\(([^\)]+?)(,\s?([^,]+?))?\)/);if(i)return a=i[1],e=i[3],this.getMetrics(a,e);var s=t.match(/^dimension_keys\(([^\)]+?)(,\s?([^,]+?))?\)/);if(s)return a=s[1],e=s[3],this.getDimensionKeys(a,e);var o=t.match(/^dimension_values\(([^,]+?),\s?([^,]+?),\s?([^,]+?),\s?([^,]+?)(,\s?(.+))?\)/);if(o){e=o[1],a=o[2],r=o[3];var l=o[4];return n={},o[6]&&(n=JSON.parse(this.templateSrv.replace(o[6]))),this.getDimensionValues(e,a,r,l,n)}var u=t.match(/^ebs_volume_ids\(([^,]+?),\s?([^,]+?)\)/);if(u){e=u[1];var c=u[2];return this.getEbsVolumeIds(e,c)}var h=t.match(/^ec2_instance_attribute\(([^,]+?),\s?([^,]+?),\s?(.+?)\)/);if(h){e=h[1];var p=h[2];return n=JSON.parse(this.templateSrv.replace(h[3])),this.getEc2InstanceAttribute(e,p,n)}return this.$q.when([])},t.prototype.annotationQuery=function(t){var e=this,a=t.annotation,r=A.a.map(a.statistics,function(t){return e.templateSrv.replace(t)}),n=a.prefixMatching?"":"300",i=a.period||n;i=parseInt(i,10);var s={prefixMatching:a.prefixMatching,region:this.templateSrv.replace(this.getActualRegion(a.region)),namespace:this.templateSrv.replace(a.namespace),metricName:this.templateSrv.replace(a.metricName),dimensions:this.convertDimensionFormat(a.dimensions,{}),statistics:r,period:i,actionPrefix:a.actionPrefix||"",alarmNamePrefix:a.alarmNamePrefix||""};return this.awsRequest("/api/tsdb/query",{from:t.range.from.valueOf().toString(),to:t.range.to.valueOf().toString(),queries:[A.a.extend({refId:"annotationQuery",intervalMs:1,maxDataPoints:1,datasourceId:this.instanceSettings.id,type:"annotationQuery"},s)]}).then(function(t){return A.a.map(t.results.annotationQuery.tables[0].rows,function(t){return{annotation:a,time:Date.parse(t[0]),title:t[1],tags:[t[2]],text:t[3]}})})},t.prototype.targetContainsTemplate=function(t){var e=this;return this.templateSrv.variableExists(t.region)||this.templateSrv.variableExists(t.namespace)||this.templateSrv.variableExists(t.metricName)||A.a.find(t.dimensions,function(t,a){return e.templateSrv.variableExists(a)||e.templateSrv.variableExists(t)})},t.prototype.testDatasource=function(){var t=this.defaultRegion;return this.getDimensionValues(t,"AWS/Billing","EstimatedCharges","ServiceName",{}).then(function(){return{status:"success",message:"Data source is working"}},function(t){return{status:"error",message:t.message}})},t.prototype.awsRequest=function(t,e){var a={method:"POST",url:t,data:e};return this.backendSrv.datasourceRequest(a).then(function(t){return t.data})},t.prototype.getDefaultRegion=function(){return this.defaultRegion},t.prototype.getActualRegion=function(t){return"default"===t||A.a.isEmpty(t)?this.getDefaultRegion():t},t.prototype.getExpandedVariables=function(t,e,a,r){var n=A.a.find(a.options,{selected:!0,text:"All"}),i=A.a.filter(a.options,function(t){return n?"All"!==t.text:t.selected}),s=A.a.isArray(a.current.value)?a.current.value.map(function(t){return{text:t,value:t}}):[a.current];return(i.some(function(t){return t.value===s[0].value})||"$__all"===s[0].value?i:s).map(function(n){var i=P.a.copy(t),s={};return s[a.name]=n,i.refId=t.refId+"_"+n.value,i.dimensions[e]=r.replace(i.dimensions[e],s),a.multi&&t.id?i.id=t.id+window.btoa(n.value).replace(/=/g,"0"):i.id=t.id,i})},t.prototype.expandTemplateVariable=function(t,e,a){var r=this;return A.a.chain(t).map(function(t){var n=A.a.findKey(t.dimensions,function(t){return a.variableExists(t)&&!A.a.has(e,a.getVariableName(t))});if(n){var i=A.a.find(a.variables,function(e){return tt(t.dimensions[n],e.name)&&e.multi}),s=A.a.find(a.variables,function(e){return tt(t.dimensions[n],e.name)});return r.getExpandedVariables(t,n,i||s,a)}return[t]}).flatten().value()},t.prototype.convertToCloudWatchTime=function(t,e){return A.a.isString(t)&&(t=Vt.parse(t,e)),Math.round(t.valueOf()/1e3)},t.prototype.convertDimensionFormat=function(t,e){var a=this,r={};return A.a.each(t,function(t,n){r[a.templateSrv.replace(n,e)]=a.templateSrv.replace(t,e)}),r},t}(),ha=function(t){function e(e,a){var r=t.call(this,e,a)||this;return r.aliasSyntax="{{metric}} {{stat}} {{namespace}} {{region}} {{<dimension name>}}",r}return e.$inject=["$scope","$injector"],Rt.d(e,t),e.templateUrl="partials/query.editor.html",e}(Qt),pa=function(){function t(t){this.accessKeyExist=!1,this.secretKeyExist=!1,this.authTypes=[{name:"存取密钥",value:"keys"},{name:"凭证",value:"credentials"},{name:"ARN",value:"arn"}],this.indexPatternTypes=[{name:"无模式",value:void 0},{name:"每时",value:"Hourly",example:"[logstash-]YYYY.MM.DD.HH"},{name:"每天",value:"Daily",example:"[logstash-]YYYY.MM.DD"},{name:"每周",value:"Weekly",example:"[logstash-]GGGG.WW"},{name:"每月",value:"Monthly",example:"[logstash-]YYYY.MM"},{name:"每年",value:"Yearly",example:"[logstash-]YYYY"}],this.current.jsonData.timeField=this.current.jsonData.timeField||"@timestamp",this.current.jsonData.authType=this.current.jsonData.authType||"credentials",this.accessKeyExist=this.current.secureJsonFields.accessKey,this.secretKeyExist=this.current.secureJsonFields.secretKey}return t.$inject=["$scope"],t.prototype.resetAccessKey=function(){this.accessKeyExist=!1},t.prototype.resetSecretKey=function(){this.secretKeyExist=!1},t.templateUrl="partials/config.html",t}(),da=function(){function t(){}return t.templateUrl="partials/annotations.editor.html",t}(),ma=[{text:"Count",value:"count",requiresField:!1},{text:"Average",value:"avg",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0},{text:"Sum",value:"sum",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0},{text:"Max",value:"max",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0},{text:"Min",value:"min",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0},{text:"Extended Stats",value:"extended_stats",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0},{text:"Percentiles",value:"percentiles",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0},{text:"Unique Count",value:"cardinality",requiresField:!0,supportsMissing:!0},{text:"Moving Average",value:"moving_avg",requiresField:!1,isPipelineAgg:!0,minVersion:2},{text:"Derivative",value:"derivative",requiresField:!1,isPipelineAgg:!0,minVersion:2},{text:"Raw Document",value:"raw_document",requiresField:!1}],fa=[{text:"Terms",value:"terms",requiresField:!0},{text:"Filters",value:"filters"},{text:"Geo Hash Grid",value:"geohash_grid",requiresField:!0},{text:"Date Histogram",value:"date_histogram",requiresField:!0},{text:"Histogram",value:"histogram",requiresField:!0}],ga=[{text:"Doc Count",value:"_count"},{text:"Term value",value:"_term"}],va=[{text:"Top",value:"desc"},{text:"Bottom",value:"asc"}],ya=[{text:"No limit",value:"0"},{text:"1",value:"1"},{text:"2",value:"2"},{text:"3",value:"3"},{text:"5",value:"5"},{text:"10",value:"10"},{text:"15",value:"15"},{text:"20",value:"20"}],ba=[{text:"Avg",value:"avg"},{text:"Min",value:"min"},{text:"Max",value:"max"},{text:"Sum",value:"sum"},{text:"Count",value:"count"},{text:"Std Dev",value:"std_deviation"},{text:"Std Dev Upper",value:"std_deviation_bounds_upper"},{text:"Std Dev Lower",value:"std_deviation_bounds_lower"}],Sa=[{text:"auto",value:"auto"},{text:"10s",value:"10s"},{text:"1m",value:"1m"},{text:"5m",value:"5m"},{text:"10m",value:"10m"},{text:"20m",value:"20m"},{text:"1h",value:"1h"},{text:"1d",value:"1d"}],xa=[{text:"Simple",value:"simple"},{text:"Linear",value:"linear"},{text:"Exponentially Weighted",value:"ewma"},{text:"Holt Linear",value:"holt"},{text:"Holt Winters",value:"holt_winters"}],wa={moving_avg:[{text:"window",default:5},{text:"model",default:"simple"},{text:"predict",default:void 0},{text:"minimize",default:!1}],derivative:[{text:"unit",default:void 0}]},ka={simple:[],linear:[],ewma:[{text:"Alpha",value:"alpha",default:void 0}],holt:[{text:"Alpha",value:"alpha",default:void 0},{text:"Beta",value:"beta",default:void 0}],holt_winters:[{text:"Alpha",value:"alpha",default:void 0},{text:"Beta",value:"beta",default:void 0},{text:"Gamma",value:"gamma",default:void 0},{text:"Period",value:"period",default:void 0},{text:"Pad",value:"pad",default:void 0,isCheckbox:!0}]};function Ca(t){return A.a.filter(ma,function(e){return!e.minVersion||e.minVersion<=t})}function Ta(t){if(t){var e=wa[t];return null!==e&&void 0!==e}return!1}function _a(t,e){var a=[];return e?(A.a.each(ka[t],function(t){t.isCheckbox||a.push(t)}),a):ka[t]}function Ma(t){return A.a.find(ma,{value:t.type}).text+" "+t.field}var $a=function(){function t(t){this.timeField=t.timeField,this.esVersion=t.esVersion}return t.prototype.getRangeFilter=function(){var t={};return t[this.timeField]={gte:"$timeFrom",lte:"$timeTo",format:"epoch_millis"},t},t.prototype.buildTermsAgg=function(t,e,a){var r,n,i;if(e.terms={field:t.field},!t.settings)return e;if(e.terms.size=0===parseInt(t.settings.size,10)?500:parseInt(t.settings.size,10),void 0!==t.settings.orderBy&&(e.terms.order={},e.terms.order[t.settings.orderBy]=t.settings.order,r=parseInt(t.settings.orderBy,10),!isNaN(r)))for(i=0;i<a.metrics.length;i++)if((n=a.metrics[i]).id===t.settings.orderBy){e.aggs={},e.aggs[n.id]={},e.aggs[n.id][n.type]={field:n.field};break}return void 0!==t.settings.min_doc_count&&(e.terms.min_doc_count=parseInt(t.settings.min_doc_count,10)),t.settings.missing&&(e.terms.missing=t.settings.missing),e},t.prototype.getDateHistogramAgg=function(t){var e={},a=t.settings||{};return e.interval=a.interval,e.field=this.timeField,e.min_doc_count=a.min_doc_count||0,e.extended_bounds={min:"$timeFrom",max:"$timeTo"},e.format="epoch_millis","auto"===e.interval&&(e.interval="$__interval"),a.missing&&(e.missing=a.missing),e},t.prototype.getHistogramAgg=function(t){var e={},a=t.settings||{};return e.interval=a.interval,e.field=t.field,e.min_doc_count=a.min_doc_count||0,a.missing&&(e.missing=a.missing),e},t.prototype.getFiltersAgg=function(t){for(var e={},a=0;a<t.settings.filters.length;a++){var r=t.settings.filters[a].query,n=t.settings.filters[a].label;e[n=""===n||void 0===n?r:n]={query_string:{query:r,analyze_wildcard:!0}}}return e},t.prototype.documentQuery=function(t,e){return t.size=e,t.sort={},t.sort[this.timeField]={order:"desc",unmapped_type:"boolean"},this.esVersion<5&&(t.fields=["*","_source"]),t.script_fields={},this.esVersion<5?t.fielddata_fields=[this.timeField]:t.docvalue_fields=[this.timeField],t},t.prototype.addAdhocFilters=function(t,e){var a,r,n,i;if(e)for(a=0;a<e.length;a++)switch((n={})[(r=e[a]).key]=r.value,(i={})[r.key]={query:r.value},r.operator){case"=":t.query.bool.must||(t.query.bool.must=[]),t.query.bool.must.push({match_phrase:i});break;case"!=":t.query.bool.must_not||(t.query.bool.must_not=[]),t.query.bool.must_not.push({match_phrase:i});break;case"<":n[r.key]={lt:r.value},t.query.bool.filter.push({range:n});break;case">":n[r.key]={gt:r.value},t.query.bool.filter.push({range:n});break;case"=~":t.query.bool.filter.push({regexp:n});break;case"!~":t.query.bool.filter.push({bool:{must_not:{regexp:n}}})}},t.prototype.build=function(t,e,a){var r,n,i;t.metrics=t.metrics||[{type:"count",id:"1"}],t.bucketAggs=t.bucketAggs||[{type:"date_histogram",id:"2",settings:{interval:"auto"}}],t.timeField=this.timeField;var s={size:0,query:{bool:{filter:[{range:this.getRangeFilter()},{query_string:{analyze_wildcard:!0,query:a}}]}}};if(this.addAdhocFilters(s,e),0===t.bucketAggs.length){if(!(i=t.metrics[0])||"raw_document"!==i.type)throw{message:"Invalid query"};var o=i.settings&&i.settings.size||500;return this.documentQuery(s,o)}for(n=s,r=0;r<t.bucketAggs.length;r++){var l=t.bucketAggs[r],u={};switch(l.type){case"date_histogram":u.date_histogram=this.getDateHistogramAgg(l);break;case"histogram":u.histogram=this.getHistogramAgg(l);break;case"filters":u.filters={filters:this.getFiltersAgg(l)};break;case"terms":this.buildTermsAgg(l,u,t);break;case"geohash_grid":u.geohash_grid={field:l.field,precision:l.settings.precision}}n.aggs=n.aggs||{},n.aggs[l.id]=u,n=u}for(n.aggs={},r=0;r<t.metrics.length;r++)if("count"!==(i=t.metrics[r]).type){var c={},h=null;if(Ta(i.type)){if(!i.pipelineAgg||!/^\d*$/.test(i.pipelineAgg))continue;h={buckets_path:i.pipelineAgg}}else h={field:i.field};for(var p in i.settings)i.settings.hasOwnProperty(p)&&null!==i.settings[p]&&(h[p]=i.settings[p]);c[i.type]=h,n.aggs[i.id]=c}return s},t.prototype.getTermsQuery=function(t){var e={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};t.query&&e.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:t.query}});var a=500;return t.size&&(a=t.size),e.aggs={1:{terms:{field:t.field,size:a,order:{_term:"asc"}}}},e},t}(),Pa={Hourly:{startOf:"hour",amount:"hours"},Daily:{startOf:"day",amount:"days"},Weekly:{startOf:"isoWeek",amount:"weeks"},Monthly:{startOf:"month",amount:"months"},Yearly:{startOf:"year",amount:"years"}},Ea=function(){function t(t,e){this.pattern=t,this.interval=e}return t.prototype.getIndexForToday=function(){return this.interval?L.a.utc().format(this.pattern):this.pattern},t.prototype.getIndexList=function(t,e){if(!this.interval)return this.pattern;for(var a=Pa[this.interval],r=L()(t).utc().startOf(a.startOf),n=L()(e).utc().startOf(a.startOf).valueOf(),i=[];r.valueOf()<=n;)i.push(r.format(this.pattern)),r.add(1,a.amount);return i},t}(),Aa=function(){function t(t,e){this.targets=t,this.response=e,this.targets=t,this.response=e}return t.prototype.processMetrics=function(t,e,a,r){var n,i,s,o,l,u;for(i=0;i<e.metrics.length;i++)if(!(n=e.metrics[i]).hide)switch(n.type){case"count":for(o={datapoints:[],metric:"count",props:r},s=0;s<t.buckets.length;s++)u=(l=t.buckets[s]).doc_count,o.datapoints.push([u,l.key]);a.push(o);break;case"percentiles":if(0===t.buckets.length)break;var c=t.buckets[0][n.id].values;for(var h in c){for(o={datapoints:[],metric:"p"+h,props:r,field:n.field},s=0;s<t.buckets.length;s++){var p=(l=t.buckets[s])[n.id].values;o.datapoints.push([p[h],l.key])}a.push(o)}break;case"extended_stats":for(var d in n.meta)if(n.meta[d]){for(o={datapoints:[],metric:d,props:r,field:n.field},s=0;s<t.buckets.length;s++){var m=(l=t.buckets[s])[n.id];m.std_deviation_bounds_upper=m.std_deviation_bounds.upper,m.std_deviation_bounds_lower=m.std_deviation_bounds.lower,o.datapoints.push([m[d],l.key])}a.push(o)}break;default:for(o={datapoints:[],metric:n.type,field:n.field,props:r},s=0;s<t.buckets.length;s++)void 0!==(u=(l=t.buckets[s])[n.id])&&(u.normalized_value?o.datapoints.push([u.normalized_value,l.key]):o.datapoints.push([u.value,l.key]));a.push(o)}},t.prototype.processAggregationDocs=function(t,e,a,r,n){if(0===r.columns.length){for(var i=0,s=A.a.keys(n);i<s.length;i++){var o=s[i];r.addColumn({text:o,filterable:!0})}r.addColumn({text:e.field,filterable:!0})}for(var l=function(t,e,a){r.addColumn({text:e}),t.push(a)},u=0,c=t.buckets;u<c.length;u++){for(var h=c[u],p=[],d=0,m=A.a.values(n);d<m.length;d++){var f=m[d];p.push(f)}p.push(h.key);for(var g=0,v=a.metrics;g<v.length;g++){var y=v[g];switch(y.type){case"count":l(p,this.getMetricName(y.type),h.doc_count);break;case"extended_stats":for(var b in y.meta)if(y.meta[b]){var S=h[y.id];S.std_deviation_bounds_upper=S.std_deviation_bounds.upper,S.std_deviation_bounds_lower=S.std_deviation_bounds.lower,l(p,this.getMetricName(b),S[b])}break;default:var x=this.getMetricName(y.type);A.a.filter(a.metrics,{type:y.type}).length>1&&(x+=" "+y.field),l(p,x,h[y.id].value)}}r.rows.push(p)}},t.prototype.processBuckets=function(t,e,a,r,n,i){var s,o,l,u,c=e.bucketAggs.length-1;for(u in t)if(o=A.a.find(e.bucketAggs,{id:u}),l=t[u],o)if(i===c)"date_histogram"===o.type?this.processMetrics(l,e,a,n):this.processAggregationDocs(l,o,e,r,n);else for(var h in l.buckets)s=l.buckets[h],n=A.a.clone(n),void 0!==s.key?n[o.field]=s.key:n.filter=h,s.key_as_string&&(n[o.field]=s.key_as_string),this.processBuckets(s,e,a,r,n,i+1)},t.prototype.getMetricName=function(t){var e=A.a.find(ma,{value:t});return e||(e=A.a.find(ba,{value:t})),e?e.text:t},t.prototype.getSeriesName=function(t,e,a){var r=this.getMetricName(t.metric);if(e.alias){return e.alias.replace(/\{\{([\s\S]+?)\}\}/g,function(e,a,n){var i=a||n;return 0===i.indexOf("term ")?t.props[i.substring(5)]:void 0!==t.props[i]?t.props[i]:"metric"===i?r:"field"===i?t.field:e})}if(t.field&&Ta(t.metric)){var n=A.a.find(e.metrics,{id:t.field});n?r+=" "+Ma(n):r="Unset"}else t.field&&(r+=" "+t.field);if(0===A.a.keys(t.props).length)return r;var i="";for(var s in t.props)i+=t.props[s]+" ";return 1===a?i.trim():i.trim()+" "+r},t.prototype.nameSeries=function(t,e){for(var a=A.a.uniq(A.a.map(t,"metric")).length,r=0;r<t.length;r++){var n=t[r];n.target=this.getSeriesName(n,e,a)}},t.prototype.processHits=function(t,e){var a,r,n,i,s={target:"docs",type:"docs",datapoints:[],total:t.total,filterable:!0};for(i=0;i<t.hits.length;i++){if(n={_id:(r=t.hits[i])._id,_type:r._type,_index:r._index},r._source)for(a in r._source)n[a]=r._source[a];for(a in r.fields)n[a]=r.fields[a];s.datapoints.push(n)}e.push(s)},t.prototype.trimDatapoints=function(t,e){var a=A.a.find(e.bucketAggs,{type:"date_histogram"});if(a&&a.settings&&a.settings.trimEdges){var r=a.settings.trimEdges;for(var n in t){var i=t[n];i.datapoints.length>2*r&&(i.datapoints=i.datapoints.slice(r,i.datapoints.length-r))}}},t.prototype.getErrorFromElasticResponse=function(t,e){var a={};return a.data=JSON.stringify(e,null,4),e.root_cause&&e.root_cause.length>0&&e.root_cause[0].reason?a.message=e.root_cause[0].reason:a.message=e.reason||"Unkown elastic error response",t.$$config&&(a.config=t.$$config),a},t.prototype.getTimeSeries=function(){for(var t=[],e=0;e<this.response.responses.length;e++){var a=this.response.responses[e];if(a.error)throw this.getErrorFromElasticResponse(this.response,a.error);if(a.hits&&a.hits.hits.length>0&&this.processHits(a.hits,t),a.aggregations){var r=a.aggregations,n=this.targets[e],i=[],s=new ie.a;this.processBuckets(r,n,i,s,{},0),this.trimDatapoints(i,n),this.nameSeries(i,n);for(var o=0;o<i.length;o++)t.push(i[o]);s.rows.length>0&&t.push(s)}}return{data:t}},t}(),Da=function(){function t(t,e,a,r,n){this.$q=e,this.backendSrv=a,this.templateSrv=r,this.timeSrv=n,this.basicAuth=t.basicAuth,this.withCredentials=t.withCredentials,this.url=t.url,this.name=t.name,this.index=t.index,this.timeField=t.jsonData.timeField,this.esVersion=t.jsonData.esVersion,this.indexPattern=new Ea(t.index,t.jsonData.interval),this.interval=t.jsonData.timeInterval,this.maxConcurrentShardRequests=t.jsonData.maxConcurrentShardRequests,this.queryBuilder=new $a({timeField:this.timeField,esVersion:this.esVersion})}return t.$inject=["instanceSettings","$q","backendSrv","templateSrv","timeSrv"],t.prototype.request=function(t,e,a){var r={url:this.url+"/"+e,method:t,data:a};return(this.basicAuth||this.withCredentials)&&(r.withCredentials=!0),this.basicAuth&&(r.headers={Authorization:this.basicAuth}),this.backendSrv.datasourceRequest(r)},t.prototype.get=function(t){var e=this.timeSrv.timeRange(),a=this.indexPattern.getIndexList(e.from.valueOf(),e.to.valueOf());return A.a.isArray(a)&&a.length?this.request("GET",a[0]+t).then(function(t){return t.data.$$config=t.config,t.data}):this.request("GET",this.indexPattern.getIndexForToday()+t).then(function(t){return t.data.$$config=t.config,t.data})},t.prototype.post=function(t,e){return this.request("POST",t,e).then(function(t){return t.data.$$config=t.config,t.data}).catch(function(t){if(t.data&&t.data.error)throw{message:"Elasticsearch error: "+t.data.error.reason,error:t.data.error};throw t})},t.prototype.annotationQuery=function(t){var e=t.annotation,a=e.timeField||"@timestamp",r=e.query||"*",n=e.tagsField||"tags",i=e.textField||null,s={};s[a]={from:t.range.from.valueOf(),to:t.range.to.valueOf(),format:"epoch_millis"};var o={query:{bool:{filter:[{range:s},{query_string:{query:this.templateSrv.replace(r,{},"lucene")}}]}},size:1e4};this.esVersion<5&&(o.fields=[a,"_source"]);var l={search_type:"query_then_fetch",ignore_unavailable:!0};e.index?l.index=e.index:l.index=this.indexPattern.getIndexList(t.range.from,t.range.to);var u=P.a.toJson(l)+"\n"+P.a.toJson(o)+"\n";return this.post("_msearch",u).then(function(t){for(var r=[],s=t.responses[0].hits.hits,o=function(t,e){if(e){for(var a=e.split("."),r=t,n=0;n<a.length;n++)if(!(r=r[a[n]]))return console.log("could not find field in annotation: ",e),"";return r}},l=0;l<s.length;l++){var u=s[l]._source,c=o(u,a);if(void 0!==s[l].fields){var h=s[l].fields;(A.a.isString(h[a])||A.a.isNumber(h[a]))&&(c=h[a])}var p={annotation:e,time:L.a.utc(c).valueOf(),text:o(u,i),tags:o(u,n)};if(e.titleField){var d=o(u,e.titleField);d&&(p.text=d+"\n"+p.text)}"string"==typeof p.tags&&(p.tags=p.tags.split(",")),r.push(p)}return r})},t.prototype.testDatasource=function(){var t=this;return this.timeSrv.setTime({from:"now-1m",to:"now"},!0),this.getFields({type:"date"}).then(function(e){return A.a.find(e,{text:t.timeField})?{status:"success",message:"Index OK. Time field name OK."}:{status:"error",message:"No date field named "+t.timeField+" found"}},function(t){if(console.log(t),t.data&&t.data.error){var e=P.a.toJson(t.data.error);return t.data.error.reason&&(e=t.data.error.reason),{status:"error",message:e}}return{status:"error",message:t.status}})},t.prototype.getQueryHeader=function(t,e,a){var r={search_type:t,ignore_unavailable:!0,index:this.indexPattern.getIndexList(e,a)};return this.esVersion>=56&&(r.max_concurrent_shard_requests=this.maxConcurrentShardRequests),P.a.toJson(r)},t.prototype.query=function(t){for(var e,a="",r=[],n=this.templateSrv.getAdhocFilters(this.name),i=0;i<t.targets.length;i++)if(!(e=t.targets[i]).hide){var s=this.templateSrv.replace(e.query||"*",t.scopedVars,"lucene"),o=this.queryBuilder.build(e,n,s),l=P.a.toJson(o),u=0===o.size&&this.esVersion<5?"count":"query_then_fetch";a+=this.getQueryHeader(u,t.range.from,t.range.to)+"\n",a+=l+"\n",r.push(e)}return 0===r.length?this.$q.when([]):(a=(a=a.replace(/\$timeFrom/g,t.range.from.valueOf())).replace(/\$timeTo/g,t.range.to.valueOf()),a=this.templateSrv.replace(a,t.scopedVars),this.post("_msearch",a).then(function(t){return new Aa(r,t).getTimeSeries()}))},t.prototype.getFields=function(t){return this.get("/_mapping").then(function(e){var a={float:"number",double:"number",integer:"number",long:"number",date:"date",string:"string",text:"string",scaled_float:"number",nested:"nested"};function r(t,e,r){return"_"!==e[0]&&(!r.type||(r.type===t.type||r.type===a[t.type]))}var n=[],i={};function s(e){for(var a in e){var o=e[a];if(A.a.isObject(o.properties)&&(n.push(a),s(o.properties)),A.a.isObject(o.fields)&&(n.push(a),s(o.fields)),A.a.isString(o.type)){var l=n.concat(a).join(".");r(o,a,t)&&(i[l]={text:l,type:o.type})}}n.pop()}for(var o in e){var l=e[o];if(l&&l.mappings){var u=l.mappings;for(var c in u){s(u[c].properties)}}}return A.a.map(i,function(t){return t})})},t.prototype.getTerms=function(t){var e=this.timeSrv.timeRange(),a=this.esVersion>=5?"query_then_fetch":"count",r=this.getQueryHeader(a,e.from,e.to),n=P.a.toJson(this.queryBuilder.getTermsQuery(t));return n=r+"\n"+(n=(n=n.replace(/\$timeFrom/g,e.from.valueOf())).replace(/\$timeTo/g,e.to.valueOf()))+"\n",this.post("_msearch?search_type="+a,n).then(function(t){if(!t.responses[0].aggregations)return[];var e=t.responses[0].aggregations[1].buckets;return A.a.map(e,function(t){return{text:t.key_as_string||t.key,value:t.key}})})},t.prototype.metricFindQuery=function(t){return(t=P.a.fromJson(t))?"fields"===t.find?(t.field=this.templateSrv.replace(t.field,{},"lucene"),this.getFields(t)):"terms"===t.find?(t.field=this.templateSrv.replace(t.field,{},"lucene"),t.query=this.templateSrv.replace(t.query||"*",{},"lucene"),this.getTerms(t)):void 0:this.$q.when([])},t.prototype.getTagKeys=function(){return this.getFields({})},t.prototype.getTagValues=function(t){return this.getTerms({field:t.key,query:"*"})},t.prototype.targetContainsTemplate=function(t){if(this.templateSrv.variableExists(t.query)||this.templateSrv.variableExists(t.alias))return!0;for(var e=0,a=t.bucketAggs;e<a.length;e++){var r=a[e];if(this.templateSrv.variableExists(r.field)||this.objectContainsTemplate(r.settings))return!0}for(var n=0,i=t.metrics;n<i.length;n++){var s=i[n];if(this.templateSrv.variableExists(s.field)||this.objectContainsTemplate(s.settings)||this.objectContainsTemplate(s.meta))return!0}return!1},t.prototype.isPrimitive=function(t){return null===t||void 0===t||!!["string","number","boolean"].some(function(t){return t===typeof!0})},t.prototype.objectContainsTemplate=function(t){if(!t)return!1;for(var e=0,a=Object.keys(t);e<a.length;e++){var r=a[e];if(this.isPrimitive(t[r])){if(this.templateSrv.variableExists(t[r]))return!0}else if(Array.isArray(t[r]))for(var n=0,i=t[r];n<i.length;n++){var s=i[n];if(this.objectContainsTemplate(s))return!0}else if(this.objectContainsTemplate(t[r]))return!0}return!1},t}();var Fa=function(){function t(t,e,a,r){var n=t.target.bucketAggs;t.orderByOptions=[],t.getBucketAggTypes=function(){return fa},t.getOrderOptions=function(){return va},t.getSizeOptions=function(){return ya},r.onAppEvent("elastic-query-updated",function(){t.validateModel()},t),t.init=function(){t.agg=n[t.index],t.validateModel()},t.onChangeInternal=function(){t.onChange()},t.onTypeChanged=function(){switch(t.agg.settings={},t.showOptions=!1,t.agg.type){case"date_histogram":case"histogram":case"terms":delete t.agg.query,t.agg.field="select field";break;case"filters":delete t.agg.field,t.agg.query="*";break;case"geohash_grid":t.agg.settings.precision=3}t.validateModel(),t.onChange()},t.validateModel=function(){t.index=A.a.indexOf(n,t.agg),t.isFirst=0===t.index,t.bucketAggCount=n.length;var e="",a=t.agg.settings||{};switch(t.agg.type){case"terms":a.order=a.order||"desc",a.size=a.size||"10",a.min_doc_count=a.min_doc_count||1,a.orderBy=a.orderBy||"_term","0"!==a.size&&(e=function(t){return A.a.find(va,{value:t}).text}(a.order)+" "+a.size+", "),a.min_doc_count>0&&(e+="Min Doc Count: "+a.min_doc_count+", "),e+="Order by: "+function(t,e){var a=A.a.find(ga,{value:t});if(a)return a.text;var r=A.a.find(e.metrics,{id:t});return r?Ma(r):"metric not found"}(a.orderBy,t.target),"0"===a.size&&(e+=" ("+a.order+")");break;case"filters":a.filters=a.filters||[{query:"*"}],(e=A.a.reduce(a.filters,function(t,e,a){return t+="Q"+(a+1)+"  = "+e.query+" "},"")).length>50&&(e=e.substr(0,50)+"..."),e="Filter Queries ("+a.filters.length+")";break;case"date_histogram":a.interval=a.interval||"auto",a.min_doc_count=a.min_doc_count||0,t.agg.field=t.target.timeField,e="Interval: "+a.interval,a.min_doc_count>0&&(e+=", Min Doc Count: "+a.min_doc_count),(void 0===a.trimEdges||a.trimEdges<0)&&(a.trimEdges=0),a.trimEdges&&a.trimEdges>0&&(e+=", Trim edges: "+a.trimEdges);break;case"histogram":a.interval=a.interval||1e3,a.min_doc_count=A.a.defaultTo(a.min_doc_count,1),e="Interval: "+a.interval,a.min_doc_count>0&&(e+=", Min Doc Count: "+a.min_doc_count);break;case"geohash_grid":a.precision=Math.max(Math.min(a.precision,7),1),e="Precision: "+a.precision}return t.settingsLinkText=e,t.agg.settings=a,!0},t.addFiltersQuery=function(){t.agg.settings.filters.push({query:"*"})},t.removeFiltersQuery=function(e){t.agg.settings.filters=A.a.without(t.agg.settings.filters,e)},t.toggleOptions=function(){t.showOptions=!t.showOptions},t.getOrderByOptions=function(){return function(t){var e=[];return A.a.each(t.metrics,function(t){"count"!==t.type&&e.push({text:Ma(t),value:t.id})}),ga.concat(e)}(t.target)},t.getFieldsInternal=function(){return"date_histogram"===t.agg.type?t.getFields({$fieldType:"date"}):t.getFields()},t.getIntervalOptions=function(){return a.when(e.transformToSegments(!0,"interval")(Sa))},t.addBucketAgg=function(){var e=n[n.length-1],a=n.length-1;e&&"date_histogram"===e.type&&(a-=1);var r=A.a.reduce(t.target.bucketAggs.concat(t.target.metrics),function(t,e){return parseInt(e.id,10)>t?parseInt(e.id,10):t},0);n.splice(a,0,{type:"terms",field:"select field",id:(r+1).toString(),fake:!0}),t.onChange()},t.removeBucketAgg=function(){n.splice(t.index,1),t.onChange()},t.init()}return t.$inject=["$scope","uiSegmentSrv","$q","$rootScope"],t}(),Ia=P.a.module("grafana.directives");Ia.directive("elasticBucketAgg",function(){return{templateUrl:"public/app/plugins/datasource/elasticsearch/partials/bucket_agg.html",controller:"ElasticBucketAggCtrl",restrict:"E",scope:{target:"=",index:"=",onChange:"&",getFields:"&"}}}),Ia.controller("ElasticBucketAggCtrl",Fa);var Oa=function(){function t(t,e,a,r){var n=t.target.metrics;t.metricAggTypes=Ca(t.esVersion),t.extendedStats=ba,t.pipelineAggOptions=[],t.modelSettingsValues={},t.init=function(){t.agg=n[t.index],t.validateModel(),t.updatePipelineAggOptions()},t.updatePipelineAggOptions=function(){t.pipelineAggOptions=function(t){var e=[];return A.a.each(t.metrics,function(t){Ta(t.type)||e.push({text:Ma(t),value:t.id})}),e}(t.target)},r.onAppEvent("elastic-query-updated",function(){t.index=A.a.indexOf(n,t.agg),t.updatePipelineAggOptions(),t.validateModel()},t),t.validateModel=function(){if(t.isFirst=0===t.index,t.isSingle=1===n.length,t.settingsLinkText="",t.aggDef=A.a.find(t.metricAggTypes,{value:t.agg.type}),Ta(t.agg.type)){t.agg.pipelineAgg=t.agg.pipelineAgg||"select metric",t.agg.field=t.agg.pipelineAgg;var e=function(t){return Ta(t.type)?wa[t.type]:[]}(t.agg);e.length>0&&(A.a.each(e,function(e){t.agg.settings[e.text]=t.agg.settings[e.text]||e.default}),t.settingsLinkText="Options")}else t.agg.field||(t.agg.field="select field");switch(t.agg.type){case"cardinality":var a=t.agg.settings.precision_threshold||"";t.settingsLinkText="Precision threshold: "+a;break;case"percentiles":t.agg.settings.percents=t.agg.settings.percents||[25,50,75,95,99],t.settingsLinkText="Values: "+t.agg.settings.percents.join(",");break;case"extended_stats":0===A.a.keys(t.agg.meta).length&&(t.agg.meta.std_deviation_bounds_lower=!0,t.agg.meta.std_deviation_bounds_upper=!0);var r=A.a.reduce(t.agg.meta,function(e,a,r){if(a){var n=A.a.find(t.extendedStats,{value:r});e.push(n.text)}return e},[]);t.settingsLinkText="Stats: "+r.join(", ");break;case"moving_avg":t.movingAvgModelTypes=xa,t.modelSettings=_a(t.agg.settings.model,!0),t.updateMovingAvgModelSettings();break;case"raw_document":t.agg.settings.size=t.agg.settings.size||500,t.settingsLinkText="Size: "+t.agg.settings.size,t.target.metrics.splice(0,t.target.metrics.length,t.agg),t.target.bucketAggs=[]}if(t.aggDef.supportsInlineScript){var i=t.agg.inlineScript;i?t.agg.settings.script={inline:i}:delete t.agg.settings.script,""===t.settingsLinkText&&(t.settingsLinkText="Options")}},t.toggleOptions=function(){t.showOptions=!t.showOptions,t.updatePipelineAggOptions()},t.onChangeInternal=function(){t.onChange()},t.updateMovingAvgModelSettings=function(){for(var e=[],a=_a(t.agg.settings.model,!1),r=0;r<a.length;r++)e.push(a[r].value);for(var n in t.agg.settings.settings)null!==t.agg.settings.settings[n]&&-1!==e.indexOf(n)||delete t.agg.settings.settings[n]},t.onChangeClearInternal=function(){delete t.agg.settings.minimize,t.onChange()},t.onTypeChange=function(){t.agg.settings={},t.agg.meta={},t.showOptions=!1,t.updatePipelineAggOptions(),t.onChange()},t.getFieldsInternal=function(){return"cardinality"===t.agg.type?t.getFields():t.getFields({$fieldType:"number"})},t.addMetricAgg=function(){var e=n.length,a=A.a.reduce(t.target.bucketAggs.concat(t.target.metrics),function(t,e){return parseInt(e.id,10)>t?parseInt(e.id,10):t},0);n.splice(e,0,{type:"count",field:"select field",id:(a+1).toString()}),t.onChange()},t.removeMetricAgg=function(){n.splice(t.index,1),t.onChange()},t.toggleShowMetric=function(){t.agg.hide=!t.agg.hide,t.agg.hide||delete t.agg.hide,t.onChange()},t.init()}return t.$inject=["$scope","uiSegmentSrv","$q","$rootScope"],t}(),qa=P.a.module("grafana.directives");qa.directive("elasticMetricAgg",function(){return{templateUrl:"public/app/plugins/datasource/elasticsearch/partials/metric_agg.html",controller:"ElasticMetricAggCtrl",restrict:"E",scope:{target:"=",index:"=",onChange:"&",getFields:"&",esVersion:"="}}}),qa.controller("ElasticMetricAggCtrl",Oa);var Ra=function(t){function e(e,a,r,n){var i=t.call(this,e,a)||this;return i.$rootScope=r,i.uiSegmentSrv=n,i.esVersion=i.datasource.esVersion,i.queryUpdated(),i}return e.$inject=["$scope","$injector","$rootScope","uiSegmentSrv"],Rt.d(e,t),e.prototype.getFields=function(t){var e=P.a.toJson({find:"fields",type:t});return this.datasource.metricFindQuery(e).then(this.uiSegmentSrv.transformToSegments(!1)).catch(this.handleQueryError.bind(this))},e.prototype.queryUpdated=function(){var t=P.a.toJson(this.datasource.queryBuilder.build(this.target),!0);this.rawQueryOld&&t!==this.rawQueryOld&&this.refresh(),this.rawQueryOld=t,this.$rootScope.appEvent("elastic-query-updated")},e.prototype.getCollapsedText=function(){var t=this.target.metrics,e=this.target.bucketAggs,a=Ca(this.esVersion),r=fa,n="";return this.target.query&&(n+="Query: "+this.target.query+", "),n+="Metrics: ",A.a.each(t,function(t,e){var r=A.a.find(a,{value:t.type});n+=r.text+"(",r.requiresField&&(n+=t.field),n+="), "}),A.a.each(e,function(t,e){0===e&&(n+=" Group by: ");var a=A.a.find(r,{value:t.type});n+=a.text+"(",a.requiresField&&(n+=t.field),n+="), "}),this.target.alias&&(n+="Alias: "+this.target.alias),n},e.prototype.handleQueryError=function(t){return this.error=t.message||"Failed to issue metric query",[]},e.templateUrl="partials/query.editor.html",e}(Qt),Na=function(){function t(t){this.indexPatternTypes=[{name:"No pattern",value:void 0},{name:"Hourly",value:"Hourly",example:"[logstash-]YYYY.MM.DD.HH"},{name:"Daily",value:"Daily",example:"[logstash-]YYYY.MM.DD"},{name:"Weekly",value:"Weekly",example:"[logstash-]GGGG.WW"},{name:"Monthly",value:"Monthly",example:"[logstash-]YYYY.MM"},{name:"Yearly",value:"Yearly",example:"[logstash-]YYYY"}],this.esVersions=[{name:"2.x",value:2},{name:"5.x",value:5},{name:"5.6+",value:56}],this.current.jsonData.timeField=this.current.jsonData.timeField||"@timestamp",this.current.jsonData.esVersion=this.current.jsonData.esVersion||5,this.current.jsonData.maxConcurrentShardRequests=this.current.jsonData.maxConcurrentShardRequests||256}return t.$inject=["$scope"],t.prototype.indexPatternTypeChanged=function(){var t=A.a.find(this.indexPatternTypes,{value:this.current.jsonData.interval});this.current.database=t.example||"es-index-name"},t.templateUrl="public/app/plugins/datasource/elasticsearch/partials/config.html",t}(),Va=function(){function t(){}return t.templateUrl="partials/annotations.editor.html",t}(),La=function(){function t(t,e,a,r){this.$q=e,this.backendSrv=a,this.templateSrv=r,this.type="opentsdb",this.url=t.url,this.name=t.name,this.withCredentials=t.withCredentials,this.basicAuth=t.basicAuth,t.jsonData=t.jsonData||{},this.tsdbVersion=t.jsonData.tsdbVersion||1,this.tsdbResolution=t.jsonData.tsdbResolution||1,this.supportMetrics=!0,this.tagKeys={},this.aggregatorsPromise=null,this.filterTypesPromise=null}return t.$inject=["instanceSettings","$q","backendSrv","templateSrv"],t.prototype.query=function(t){var e=this,a=this.convertToTSDBTime(t.rangeRaw.from,!1),r=this.convertToTSDBTime(t.rangeRaw.to,!0),n=[];A.a.each(t.targets,function(a){a.metric&&n.push(e.convertTargetToQuery(a,t,e.tsdbVersion))});var i=A.a.compact(n);if(A.a.isEmpty(i)){var s=this.$q.defer();return s.resolve({data:[]}),s.promise}var o={};return A.a.each(i,function(t){t.filters&&t.filters.length>0?A.a.each(t.filters,function(t){o[t.tagk]=!0}):A.a.each(t.tags,function(t,e){o[e]=!0})}),t.targets=A.a.filter(t.targets,function(t){return!0!==t.hide}),this.performTimeSeriesQuery(i,a,r).then(function(a){var r=e.mapMetricsToTargets(a.data,t,e.tsdbVersion);return{data:A.a.map(a.data,function(a,n){return-1===(n=r[n])&&(n=0),e._saveTagKeys(a),e.transformMetricData(a,o,t.targets[n],t,e.tsdbResolution)})}})},t.prototype.annotationQuery=function(t){var e=this.convertToTSDBTime(t.rangeRaw.from,!1),a=this.convertToTSDBTime(t.rangeRaw.to,!0),r=[],n=[];r.push({aggregator:"sum",metric:t.annotation.target});var i=A.a.compact(r);return this.performTimeSeriesQuery(i,e,a).then(function(e){if(e.data[0]){var a=e.data[0].annotations;t.annotation.isGlobal&&(a=e.data[0].globalAnnotations),a&&A.a.each(a,function(e){var a={text:e.description,time:1e3*Math.floor(e.startTime),annotation:t.annotation};n.push(a)})}return n})},t.prototype.targetContainsTemplate=function(t){if(t.filters&&t.filters.length>0)for(var e=0;e<t.filters.length;e++)if(this.templateSrv.variableExists(t.filters[e].filter))return!0;if(t.tags&&Object.keys(t.tags).length>0)for(var a in t.tags)if(this.templateSrv.variableExists(t.tags[a]))return!0;return!1},t.prototype.performTimeSeriesQuery=function(t,e,a){var r=!1;2===this.tsdbResolution&&(r=!0);var n={start:e,queries:t,msResolution:r,globalAnnotations:!0};3===this.tsdbVersion&&(n.showQuery=!0),a&&(n.end=a);var i={method:"POST",url:this.url+"/api/query",data:n};return this._addCredentialOptions(i),this.backendSrv.datasourceRequest(i)},t.prototype.suggestTagKeys=function(t){return this.$q.when(this.tagKeys[t]||[])},t.prototype._saveTagKeys=function(t){var e=Object.keys(t.tags);A.a.each(t.aggregateTags,function(t){e.push(t)}),this.tagKeys[t.metric]=e},t.prototype._performSuggestQuery=function(t,e){return this._get("/api/suggest",{type:e,q:t,max:1e3}).then(function(t){return t.data})},t.prototype._performMetricKeyValueLookup=function(t,e){if(!t||!e)return this.$q.when([]);var a=e.split(",").map(function(t){return t.trim()}),r=a[0],n=r+"=*";a.length>1&&(n+=","+a.splice(1).join(","));var i=t+"{"+n+"}";return this._get("/api/search/lookup",{m:i,limit:3e3}).then(function(t){t=t.data.results;var e=[];return A.a.each(t,function(t){-1===e.indexOf(t.tags[r])&&e.push(t.tags[r])}),e})},t.prototype._performMetricKeyLookup=function(t){return t?this._get("/api/search/lookup",{m:t,limit:1e3}).then(function(t){t=t.data.results;var e=[];return A.a.each(t,function(t){A.a.each(t.tags,function(t,a){-1===e.indexOf(a)&&e.push(a)})}),e}):this.$q.when([])},t.prototype._get=function(t,e){var a={method:"GET",url:this.url+t,params:e};return this._addCredentialOptions(a),this.backendSrv.datasourceRequest(a)},t.prototype._addCredentialOptions=function(t){(this.basicAuth||this.withCredentials)&&(t.withCredentials=!0),this.basicAuth&&(t.headers={Authorization:this.basicAuth})},t.prototype.metricFindQuery=function(t){if(!t)return this.$q.when([]);var e;try{e=this.templateSrv.replace(t,{},"distributed")}catch(t){return this.$q.reject(t)}var a=function(t){return A.a.map(t,function(t){return{text:t}})},r=e.match(/metrics\((.*)\)/);if(r)return this._performSuggestQuery(r[1],"metrics").then(a);var n=e.match(/tag_names\((.*)\)/);if(n)return this._performMetricKeyLookup(n[1]).then(a);var i=e.match(/tag_values\((.*?),\s?(.*)\)/);if(i)return this._performMetricKeyValueLookup(i[1],i[2]).then(a);var s=e.match(/suggest_tagk\((.*)\)/);if(s)return this._performSuggestQuery(s[1],"tagk").then(a);var o=e.match(/suggest_tagv\((.*)\)/);return o?this._performSuggestQuery(o[1],"tagv").then(a):this.$q.when([])},t.prototype.testDatasource=function(){return this._performSuggestQuery("cpu","metrics").then(function(){return{status:"success",message:"Data source is working"}})},t.prototype.getAggregators=function(){return this.aggregatorsPromise?this.aggregatorsPromise:(this.aggregatorsPromise=this._get("/api/aggregators").then(function(t){return t.data&&A.a.isArray(t.data)?t.data.sort():[]}),this.aggregatorsPromise)},t.prototype.getFilterTypes=function(){return this.filterTypesPromise?this.filterTypesPromise:(this.filterTypesPromise=this._get("/api/config/filters").then(function(t){return t.data?Object.keys(t.data).sort():[]}),this.filterTypesPromise)},t.prototype.transformMetricData=function(t,e,a,r,n){var i=this.createMetricLabel(t,a,e,r),s=[];return A.a.each(t.dps,function(t,e){2===n?s.push([t,1*e]):s.push([t,1e3*e])}),{target:i,datapoints:s}},t.prototype.createMetricLabel=function(t,e,a,r){if(e.alias){var n=A.a.clone(r.scopedVars||{});return A.a.each(t.tags,function(t,e){n["tag_"+e]={value:t}}),this.templateSrv.replace(e.alias,n)}var i=t.metric,s=[];return A.a.isEmpty(t.tags)||A.a.each(A.a.toPairs(t.tags),function(t){A.a.has(a,t[0])&&s.push(t[0]+"="+t[1])}),A.a.isEmpty(s)||(i+="{"+s.join(", ")+"}"),i},t.prototype.convertTargetToQuery=function(t,e,a){if(!t.metric||t.hide)return null;var r={metric:this.templateSrv.replace(t.metric,e.scopedVars,"pipe"),aggregator:"avg"};if(t.aggregator&&(r.aggregator=this.templateSrv.replace(t.aggregator)),t.shouldComputeRate&&(r.rate=!0,r.rateOptions={counter:!!t.isCounter},t.counterMax&&t.counterMax.length&&(r.rateOptions.counterMax=parseInt(t.counterMax,10)),t.counterResetValue&&t.counterResetValue.length&&(r.rateOptions.resetValue=parseInt(t.counterResetValue,10)),a>=2&&(r.rateOptions.dropResets=!(r.rateOptions.counterMax||r.rateOptions.ResetValue&&0!==r.rateOptions.ResetValue))),!t.disableDownsampling){var n=this.templateSrv.replace(t.downsampleInterval||e.interval);n.match(/\.[0-9]+s/)&&(n=1e3*parseFloat(n)+"ms"),r.downsample=n+"-"+t.downsampleAggregator,t.downsampleFillPolicy&&"none"!==t.downsampleFillPolicy&&(r.downsample+="-"+t.downsampleFillPolicy)}if(t.filters&&t.filters.length>0){if(r.filters=P.a.copy(t.filters),r.filters)for(var i in r.filters)r.filters[i].filter=this.templateSrv.replace(r.filters[i].filter,e.scopedVars,"pipe")}else if(r.tags=P.a.copy(t.tags),r.tags)for(var s in r.tags)r.tags[s]=this.templateSrv.replace(r.tags[s],e.scopedVars,"pipe");return t.explicitTags&&(r.explicitTags=!0),r},t.prototype.mapMetricsToTargets=function(t,e,a){var r,n,i=this;return A.a.map(t,function(t){return 3===a?t.query.index:A.a.findIndex(e.targets,function(a){return a.filters&&a.filters.length>0?a.metric===t.metric:a.metric===t.metric&&A.a.every(a.tags,function(a,s){return r=i.templateSrv.replace(a,e.scopedVars,"pipe"),n=r.split("|"),A.a.includes(n,t.tags[s])||"*"===r})})})},t.prototype.convertToTSDBTime=function(t,e){return"now"===t?null:(t=Vt.parse(t,e)).valueOf()},t}(),ja=function(t){function e(e,a){var r=t.call(this,e,a)||this;return r.errors=r.validateTarget(),r.aggregators=["avg","sum","min","max","dev","zimsum","mimmin","mimmax"],r.fillPolicies=["none","nan","null","zero"],r.filterTypes=["wildcard","iliteral_or","not_iliteral_or","not_literal_or","iwildcard","literal_or","regexp"],r.tsdbVersion=r.datasource.tsdbVersion,r.target.aggregator||(r.target.aggregator="sum"),r.target.downsampleAggregator||(r.target.downsampleAggregator="avg"),r.target.downsampleFillPolicy||(r.target.downsampleFillPolicy="none"),r.datasource.getAggregators().then(function(t){0!==t.length&&(r.aggregators=t)}),r.datasource.getFilterTypes().then(function(t){0!==t.length&&(r.filterTypes=t)}),r.suggestMetrics=function(t,e){r.datasource.metricFindQuery("metrics("+t+")").then(r.getTextValues).then(e)},r.suggestTagKeys=function(t,e){r.datasource.suggestTagKeys(r.target.metric).then(e)},r.suggestTagValues=function(t,e){r.datasource.metricFindQuery("suggest_tagv("+t+")").then(r.getTextValues).then(e)},r}return e.$inject=["$scope","$injector"],Rt.d(e,t),e.prototype.targetBlur=function(){this.errors=this.validateTarget(),this.refresh()},e.prototype.getTextValues=function(t){return A.a.map(t,function(t){return t.text})},e.prototype.addTag=function(){this.target.filters&&this.target.filters.length>0&&(this.errors.tags="Please remove filters to use tags, tags and filters are mutually exclusive."),this.addTagMode?(this.target.tags||(this.target.tags={}),this.errors=this.validateTarget(),this.errors.tags||(this.target.tags[this.target.currentTagKey]=this.target.currentTagValue,this.target.currentTagKey="",this.target.currentTagValue="",this.targetBlur()),this.addTagMode=!1):this.addTagMode=!0},e.prototype.removeTag=function(t){delete this.target.tags[t],this.targetBlur()},e.prototype.editTag=function(t,e){this.removeTag(t),this.target.currentTagKey=t,this.target.currentTagValue=e,this.addTag()},e.prototype.closeAddTagMode=function(){this.addTagMode=!1},e.prototype.addFilter=function(){if(this.target.tags&&A.a.size(this.target.tags)>0&&(this.errors.filters="Please remove tags to use filters, tags and filters are mutually exclusive."),this.addFilterMode){if(this.target.filters||(this.target.filters=[]),this.target.currentFilterType||(this.target.currentFilterType="iliteral_or"),this.target.currentFilterGroupBy||(this.target.currentFilterGroupBy=!1),this.errors=this.validateTarget(),!this.errors.filters){var t={type:this.target.currentFilterType,tagk:this.target.currentFilterKey,filter:this.target.currentFilterValue,groupBy:this.target.currentFilterGroupBy};this.target.filters.push(t),this.target.currentFilterType="literal_or",this.target.currentFilterKey="",this.target.currentFilterValue="",this.target.currentFilterGroupBy=!1,this.targetBlur()}this.addFilterMode=!1}else this.addFilterMode=!0},e.prototype.removeFilter=function(t){this.target.filters.splice(t,1),this.targetBlur()},e.prototype.editFilter=function(t,e){this.removeFilter(e),this.target.currentFilterKey=t.tagk,this.target.currentFilterValue=t.filter,this.target.currentFilterType=t.type,this.target.currentFilterGroupBy=t.groupBy,this.addFilter()},e.prototype.closeAddFilterMode=function(){this.addFilterMode=!1},e.prototype.validateTarget=function(){var t={};if(this.target.shouldDownsample)try{this.target.downsampleInterval?J.a.describe_interval(this.target.downsampleInterval):t.downsampleInterval="You must supply a downsample interval (e.g. '1m' or '1h')."}catch(e){t.downsampleInterval=e.message}return this.target.tags&&A.a.has(this.target.tags,this.target.currentTagKey)&&(t.tags="Duplicate tag key '"+this.target.currentTagKey+"'."),t},e.templateUrl="partials/query.editor.html",e}(Qt),Ua=function(){function t(t){this.tsdbVersions=[{name:"<=2.1",value:1},{name:"==2.2",value:2},{name:"==2.3",value:3}],this.tsdbResolutions=[{name:"second",value:1},{name:"millisecond",value:2}],this.current.jsonData=this.current.jsonData||{},this.current.jsonData.tsdbVersion=this.current.jsonData.tsdbVersion||1,this.current.jsonData.tsdbResolution=this.current.jsonData.tsdbResolution||1}return t.$inject=["$scope"],t.templateUrl="public/app/plugins/datasource/opentsdb/partials/config.html",t}(),Ba=function(){function t(){}return t.templateUrl="partials/annotations.editor.html",t}(),Qa=function(){function t(t,e){this.backendSrv=t,this.$q=e}return t.$inject=["backendSrv","$q"],t.prototype.query=function(t){return this.backendSrv.get("/api/tsdb/testdata/random-walk",{from:t.range.from.valueOf(),to:t.range.to.valueOf(),intervalMs:t.intervalMs,maxDataPoints:t.maxDataPoints}).then(function(t){var e=[];return t.results&&A.a.forEach(t.results,function(t){for(var a=0,r=t.series;a<r.length;a++){var n=r[a];e.push({target:n.name,datapoints:n.points})}}),{data:e}})},t.prototype.metricFindQuery=function(t){return this.$q.when({data:[]})},t.prototype.annotationQuery=function(t){var e={from:t.range.from.valueOf(),to:t.range.to.valueOf(),limit:t.annotation.limit,tags:t.annotation.tags};if("dashboard"===t.annotation.type){if(!t.dashboard.id)return this.$q.when([]);e.dashboardId=t.dashboard.id,delete e.tags}else if(!A.a.isArray(t.annotation.tags)||0===t.annotation.tags.length)return this.$q.when([]);return this.backendSrv.get("/api/annotations",e)},t}(),Ha=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Rt.d(e,t),e.templateUrl="partials/query.editor.html",e}(Qt),za=function(){function t(){this.types=[{text:"仪表盘",value:"dashboard"},{text:"标签",value:"tags"}],this.annotation.type=this.annotation.type||"tags",this.annotation.limit=this.annotation.limit||100}return t.templateUrl="partials/annotations.editor.html",t}(),Ya=function(){function t(t){this.series=t.series,this.alias=t.alias,this.annotation=t.annotation}return t.prototype.getTimeSeries=function(){var t,e,a=this,r=[];return 0===this.series.length?r:(A.a.each(this.series,function(n){var i=n.columns.length,s=A.a.map(n.tags,function(t,e){return e+": "+t});for(e=1;e<i;e++){var o=n.name,l=n.columns[e];"value"!==l&&(o=o+"."+l),a.alias?o=a._getSeriesName(n,e):n.tags&&(o=o+" {"+s.join(", ")+"}");var u=[];if(n.values)for(t=0;t<n.values.length;t++)u[t]=[n.values[t][e],n.values[t][0]];r.push({target:o,datapoints:u})}}),r)},t.prototype._getSeriesName=function(t,e){var a=t.name.split(".");return this.alias.replace(/\$(\w+)|\[\[([\s\S]+?)\]\]/g,function(r,n,i){var s=n||i,o=parseInt(s,10);if("m"===s||"measurement"===s)return t.name;if("col"===s)return t.columns[e];if(!isNaN(o))return a[o];if(0!==s.indexOf("tag_"))return r;var l=s.replace("tag_","");return t.tags?t.tags[l]:r})},t.prototype.getAnnotations=function(){var t=this,e=[];return A.a.each(this.series,function(a){var r=null,n=null,i=[],s=null;A.a.each(a.columns,function(e,a){"time"!==e?"sequence_number"!==e&&(r||(r=a),e!==t.annotation.titleColumn?A.a.includes((t.annotation.tagsColumn||"").replace(" ","").split(","),e)?i.push(a):e!==t.annotation.textColumn||(s=a):r=a):n=a}),A.a.each(a.values,function(a){var o={annotation:t.annotation,time:+new Date(a[n]),title:a[r],tags:A.a.flatten(i.filter(function(t){return a[t]}).map(function(t){return a[t].split(",")})),text:a[s]};e.push(o)})}),e},t.prototype.getTable=function(){var t,e,a=new ie.a;return 0===this.series.length?a:(A.a.each(this.series,function(r,n){if(0===n)for(e=0,"time"===r.columns[0]&&(a.columns.push({text:"Time",type:"time"}),e++),A.a.each(A.a.keys(r.tags),function(t){a.columns.push({text:t})});e<r.columns.length;e++)a.columns.push({text:r.columns[e]});if(r.values)for(t=0;t<r.values.length;t++){var i=r.values[t],s=[i[0]];if(r.tags)for(var o in r.tags)r.tags.hasOwnProperty(o)&&s.push(r.tags[o]);for(e=1;e<i.length;e++)s.push(i[e]);a.rows.push(s)}}),a)},t}(),Wa=[],Ga={Aggregations:[],Selectors:[],Transformations:[],Predictors:[],Math:[],Aliasing:[],Fields:[]};function Ka(t){var e=Wa[t.type];if(!e)throw{message:"Could not find query part "+t.type};return new zt.a(t,e)}function Ja(t){Wa[t.type]=new zt.b(t),t.category.push(Wa[t.type])}var Xa=[];function Za(t,e){return"*"===t.params[0]?"*":'"'+t.params[0]+'"'}function tr(t,e){for(var a=0;a<t.length;a++){var r=t[a];if(r.def.category===Ga.Aggregations){if(r.def.type===e.def.type)return;if("count"===r.def.type&&"distinct"===e.def.type)break;if("distinct"===r.def.type){var n=t.length>=a+2;if("count"!==e.def.type&&n)t[a+1].def.category===Ga.Aggregations&&t.splice(a+1,1);else if("count"===e.def.type)return void(n&&"count"===t[a+1].def.type||t.splice(a+1,0,e))}return void(t[a]=e)}if(r.def.category===Ga.Selectors)return void(t[a]=e)}t.splice(1,0,e)}function er(t,e){var a;for(a=0;a<t.length;a++){var r=t[a];if(r.def.category===Ga.Math||r.def.category===Ga.Aliasing)break}t.splice(a,0,e)}Ja({type:"field",addStrategy:function(t,e,a){var r=A.a.map(t,function(t){return Ka({type:t.def.type,params:A.a.clone(t.params)})});a.selectModels.push(r)},category:Ga.Fields,params:[{type:"field",dynamicLookup:!0}],defaultParams:["value"],renderer:Za}),Ja({type:"count",addStrategy:tr,category:Ga.Aggregations,params:[],defaultParams:[],renderer:zt.c}),Ja({type:"distinct",addStrategy:tr,category:Ga.Aggregations,params:[],defaultParams:[],renderer:zt.c}),Ja({type:"integral",addStrategy:tr,category:Ga.Aggregations,params:[],defaultParams:[],renderer:zt.c}),Ja({type:"mean",addStrategy:tr,category:Ga.Aggregations,params:[],defaultParams:[],renderer:zt.c}),Ja({type:"median",addStrategy:tr,category:Ga.Aggregations,params:[],defaultParams:[],renderer:zt.c}),Ja({type:"mode",addStrategy:tr,category:Ga.Aggregations,params:[],defaultParams:[],renderer:zt.c}),Ja({type:"sum",addStrategy:tr,category:Ga.Aggregations,params:[],defaultParams:[],renderer:zt.c}),Ja({type:"derivative",addStrategy:er,category:Ga.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:zt.c}),Ja({type:"spread",addStrategy:er,category:Ga.Transformations,params:[],defaultParams:[],renderer:zt.c}),Ja({type:"non_negative_derivative",addStrategy:er,category:Ga.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:zt.c}),Ja({type:"difference",addStrategy:er,category:Ga.Transformations,params:[],defaultParams:[],renderer:zt.c}),Ja({type:"non_negative_difference",addStrategy:er,category:Ga.Transformations,params:[],defaultParams:[],renderer:zt.c}),Ja({type:"moving_average",addStrategy:er,category:Ga.Transformations,params:[{name:"window",type:"int",options:[5,10,20,30,40]}],defaultParams:[10],renderer:zt.c}),Ja({type:"cumulative_sum",addStrategy:er,category:Ga.Transformations,params:[],defaultParams:[],renderer:zt.c}),Ja({type:"stddev",addStrategy:er,category:Ga.Transformations,params:[],defaultParams:[],renderer:zt.c}),Ja({type:"time",category:Xa,params:[{name:"interval",type:"time",options:["$__interval","1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["$__interval"],renderer:zt.c}),Ja({type:"fill",category:Xa,params:[{name:"fill",type:"string",options:["none","null","0","previous","linear"]}],defaultParams:["null"],renderer:zt.c}),Ja({type:"elapsed",addStrategy:er,category:Ga.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:zt.c}),Ja({type:"holt_winters",addStrategy:er,category:Ga.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:zt.c}),Ja({type:"holt_winters_with_fit",addStrategy:er,category:Ga.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:zt.c}),Ja({type:"bottom",addStrategy:tr,category:Ga.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:zt.c}),Ja({type:"first",addStrategy:tr,category:Ga.Selectors,params:[],defaultParams:[],renderer:zt.c}),Ja({type:"last",addStrategy:tr,category:Ga.Selectors,params:[],defaultParams:[],renderer:zt.c}),Ja({type:"max",addStrategy:tr,category:Ga.Selectors,params:[],defaultParams:[],renderer:zt.c}),Ja({type:"min",addStrategy:tr,category:Ga.Selectors,params:[],defaultParams:[],renderer:zt.c}),Ja({type:"percentile",addStrategy:tr,category:Ga.Selectors,params:[{name:"nth",type:"int"}],defaultParams:[95],renderer:zt.c}),Ja({type:"top",addStrategy:tr,category:Ga.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:zt.c}),Ja({type:"tag",category:Xa,params:[{name:"tag",type:"string",dynamicLookup:!0}],defaultParams:["tag"],renderer:Za}),Ja({type:"math",addStrategy:function(t,e){var a=t.length;if(a>0){if("math"===t[a-1].def.type)return void(t[a-1]=e);if(a>1&&"math"===t[a-2].def.type)return void(t[a-2]=e);if("alias"===t[a-1].def.type)return void t.splice(a-1,0,e)}t.push(e)},category:Ga.Math,params:[{name:"expr",type:"string"}],defaultParams:[" / 100"],renderer:zt.d}),Ja({type:"alias",addStrategy:function(t,e){var a=t.length;a>0&&"alias"===t[a-1].def.type?t[a-1]=e:t.push(e)},category:Ga.Aliasing,params:[{name:"name",type:"string",quote:"double"}],defaultParams:["alias"],renderMode:"suffix",renderer:function(t,e){return e+' AS "'+t.params[0]+'"'}});var ar={create:Ka,getCategories:function(){return Ga},replaceAggregationAdd:tr},rr=function(){function t(t,e,a){this.target=t,this.templateSrv=e,this.scopedVars=a,t.policy=t.policy||"default",t.resultFormat=t.resultFormat||"time_series",t.orderByTime=t.orderByTime||"ASC",t.tags=t.tags||[],t.groupBy=t.groupBy||[{type:"time",params:["$__interval"]},{type:"fill",params:["null"]}],t.select=t.select||[[{type:"field",params:["value"]},{type:"mean",params:[]}]],this.updateProjection()}return t.$inject=["target","templateSrv","scopedVars"],t.prototype.updateProjection=function(){this.selectModels=A.a.map(this.target.select,function(t){return A.a.map(t,ar.create)}),this.groupByParts=A.a.map(this.target.groupBy,ar.create)},t.prototype.updatePersistedParts=function(){this.target.select=A.a.map(this.selectModels,function(t){return A.a.map(t,function(t){return{type:t.def.type,params:t.params}})})},t.prototype.hasGroupByTime=function(){return A.a.find(this.target.groupBy,function(t){return"time"===t.type})},t.prototype.hasFill=function(){return A.a.find(this.target.groupBy,function(t){return"fill"===t.type})},t.prototype.addGroupBy=function(t){var e=t.match(/^(\w+)\((.*)\)$/),a=e[1],r=e[2],n=ar.create({type:a,params:[r]}),i=this.target.groupBy.length;0===i?this.target.groupBy.push(n.part):"time"===a?this.target.groupBy.splice(0,0,n.part):"tag"===a&&"fill"===this.target.groupBy[i-1].type?this.target.groupBy.splice(i-1,0,n.part):this.target.groupBy.push(n.part),this.updateProjection()},t.prototype.removeGroupByPart=function(t,e){var a=ar.getCategories();"time"===t.def.type&&(this.target.groupBy=A.a.filter(this.target.groupBy,function(t){return"fill"!==t.type}),this.target.select=A.a.map(this.target.select,function(t){return A.a.filter(t,function(t){var e=ar.create(t);return e.def.category!==a.Aggregations&&e.def.category!==a.Selectors})})),this.target.groupBy.splice(e,1),this.updateProjection()},t.prototype.removeSelect=function(t){this.target.select.splice(t,1),this.updateProjection()},t.prototype.removeSelectPart=function(t,e){if("field"===e.def.type){if(this.selectModels.length>1){var a=A.a.indexOf(this.selectModels,t);this.selectModels.splice(a,1)}}else{var r=A.a.indexOf(t,e);t.splice(r,1)}this.updatePersistedParts()},t.prototype.addSelectPart=function(t,e){var a=ar.create({type:e});a.def.addStrategy(t,a,this),this.updatePersistedParts()},t.prototype.renderTagCondition=function(t,e,a){var r="",n=t.operator,i=t.value;return e>0&&(r=(t.condition||"AND")+" "),n||(n=/^\/.*\/$/.test(i)?"=~":"="),"=~"!==n&&"!~"!==n?(a&&(i=this.templateSrv.replace(i,this.scopedVars)),">"!==n&&"<"!==n&&(i="'"+i.replace(/\\/g,"\\\\")+"'")):a&&(i=this.templateSrv.replace(i,this.scopedVars,"regex")),r+'"'+t.key+'" '+n+" "+i},t.prototype.getMeasurementAndPolicy=function(t){var e=this.target.policy,a=this.target.measurement||"measurement";return a.match("^/.*/$")?t&&(a=this.templateSrv.replace(a,this.scopedVars,"regex")):a='"'+a+'"',(e="default"!==e?'"'+this.target.policy+'".':"")+a},t.prototype.interpolateQueryStr=function(t,e,a){return e.multi||e.includeAll?"string"==typeof t?J.a.regexEscape(t):"("+A.a.map(t,J.a.regexEscape).join("|")+")":t},t.prototype.render=function(t){var e=this,a=this.target;if(a.rawQuery)return t?this.templateSrv.replace(a.query,this.scopedVars,this.interpolateQueryStr):a.query;var r,n,i="SELECT ";for(r=0;r<this.selectModels.length;r++){var s=this.selectModels[r],o="";for(n=0;n<s.length;n++){o=(c=s[n]).render(o)}r>0&&(i+=", "),i+=o}i+=" FROM "+this.getMeasurementAndPolicy(t)+" WHERE ";var l=A.a.map(a.tags,function(a,r){return e.renderTagCondition(a,r,t)});l.length>0&&(i+="("+l.join(" ")+") AND "),i+="$timeFilter";var u="";for(r=0;r<this.groupByParts.length;r++){var c=this.groupByParts[r];r>0&&(u+="fill"===c.def.type?" ":", "),u+=c.render("")}return u.length&&(i+=" GROUP BY "+u),a.fill&&(i+=" fill("+a.fill+")"),"DESC"===a.orderByTime&&(i+=" ORDER BY time DESC"),a.limit&&(i+=" LIMIT "+a.limit),a.slimit&&(i+=" SLIMIT "+a.slimit),i},t.prototype.renderAdhocFilters=function(t){var e=this;return A.a.map(t,function(t,a){return e.renderTagCondition(t,a,!1)}).join(" ")},t}(),nr=function(){function t(){}return t.prototype.parse=function(t,e){if(!e||0===e.results.length)return[];var a=e.results[0];if(!a.series)return[];var r=t.toLowerCase(),n=r.indexOf("show field keys")>=0||r.indexOf("show retention policies")>=0,i={};return A.a.each(a.series,function(t){A.a.each(t.values,function(t){A.a.isArray(t)?n?ir(i,t[0]):void 0!==t[1]?ir(i,t[1]):ir(i,t[0]):ir(i,t)})}),A.a.map(i,function(t){return{text:t.toString()}})},t}();function ir(t,e){t[e]=e}var sr,or=function(){function t(t,e){this.target=t,this.database=e}return t.prototype.buildExploreQuery=function(t,e,a){var r,n,i;if("TAG_KEYS"===t)r="SHOW TAG KEYS",n=this.target.measurement,i=this.target.policy;else if("TAG_VALUES"===t)r="SHOW TAG VALUES",n=this.target.measurement,i=this.target.policy;else if("MEASUREMENTS"===t)r="SHOW MEASUREMENTS",a&&(r+=" WITH MEASUREMENT =~ /"+a+"/");else{if("FIELDS"===t)return n=this.target.measurement,i=this.target.policy,n.match("^/.*/")||(n='"'+n+'"',i&&"default"!==i&&(n=(i='"'+i+'"')+"."+n)),"SHOW FIELD KEYS FROM "+n;if("RETENTION POLICIES"===t)return r='SHOW RETENTION POLICIES on "'+this.database+'"'}if(n&&(n.match("^/.*/")||n.match(/^merge\(.*\)/)||(n='"'+n+'"'),i&&"default"!==i&&(n=(i='"'+i+'"')+"."+n),r+=" FROM "+n),e&&(r+=' WITH KEY = "'+e+'"'),this.target.tags&&this.target.tags.length>0){var s=A.a.reduce(this.target.tags,function(t,a){return a.key===e?t:(t.push(function(t,e){var a="",r=t.operator,n=t.value;return e>0&&(a=(t.condition||"AND")+" "),r||(r=/^\/.*\/$/.test(t.value)?"=~":"="),"=~"!==r&&"!~"!==r&&isNaN(+n)&&(n="'"+n+"'"),a+'"'+t.key+'" '+r+" "+n}(a,t.length)),t)},[]);s.length>0&&(r+=" WHERE "+s.join(" "))}return"MEASUREMENTS"===t&&(r+=" LIMIT 100"),r},t}(),lr=function(){function t(t,e,a,r){this.$q=e,this.backendSrv=a,this.templateSrv=r,this.type="influxdb",this.urls=A.a.map(t.url.split(","),function(t){return t.trim()}),this.username=t.username,this.password=t.password,this.name=t.name,this.database=t.database,this.basicAuth=t.basicAuth,this.withCredentials=t.withCredentials,this.interval=(t.jsonData||{}).timeInterval,this.supportAnnotations=!0,this.supportMetrics=!0,this.responseParser=new nr}return t.$inject=["instanceSettings","$q","backendSrv","templateSrv"],t.prototype.query=function(t){var e,a,r,n=this,i=this.getTimeFilter(t),s=t.scopedVars,o=A.a.cloneDeep(t.targets),l=[],u=A.a.map(o,function(t){return t.hide?"":(l.push(t),s.interval=s.__interval,(e=new rr(t,n.templateSrv,s)).render(!0))}).reduce(function(t,e){return""!==e&&(t+=";"+e),t});if(""===u)return this.$q.when({data:[]});var c=this.templateSrv.getAdhocFilters(this.name);return c.length>0&&(i+=" AND "+e.renderAdhocFilters(c)),s.timeFilter={value:i},u=this.templateSrv.replace(u,s),this._seriesQuery(u,t).then(function(e){if(!e||!e.results)return[];var i=[];for(a=0;a<e.results.length;a++){var s=e.results[a];if(s&&s.series){var o=l[a],u=o.alias;u&&(u=n.templateSrv.replace(o.alias,t.scopedVars));var c=new Ya({series:e.results[a].series,alias:u});switch(o.resultFormat){case"table":i.push(c.getTable());break;default:var h=c.getTimeSeries();for(r=0;r<h.length;r++)i.push(h[r])}}}return{data:i}})},t.prototype.annotationQuery=function(t){if(!t.annotation.query)return this.$q.reject({message:"Query missing in annotation definition"});var e=this.getTimeFilter({rangeRaw:t.rangeRaw}),a=t.annotation.query.replace("$timeFilter",e);return a=this.templateSrv.replace(a,null,"regex"),this._seriesQuery(a,t).then(function(e){if(!e||!e.results||!e.results[0])throw{message:"No results in response from InfluxDB"};return new Ya({series:e.results[0].series,annotation:t.annotation}).getAnnotations()})},t.prototype.targetContainsTemplate=function(t){for(var e=0,a=t.groupBy;e<a.length;e++)for(var r=0,n=a[e].params;r<n.length;r++){var i=n[r];if(this.templateSrv.variableExists(i))return!0}for(var s in t.tags)if(this.templateSrv.variableExists(t.tags[s].value))return!0;return!1},t.prototype.metricFindQuery=function(t,e){var a=this.templateSrv.replace(t,null,"regex");return this._seriesQuery(a,e).then(A.a.curry(this.responseParser.parse)(t))},t.prototype.getTagKeys=function(t){var e=new or({measurement:"",tags:[]},this.database).buildExploreQuery("TAG_KEYS");return this.metricFindQuery(e,t)},t.prototype.getTagValues=function(t){var e=new or({measurement:"",tags:[]},this.database).buildExploreQuery("TAG_VALUES",t.key);return this.metricFindQuery(e,t)},t.prototype._seriesQuery=function(t,e){if(!t)return this.$q.when({results:[]});if(e&&e.range){var a=this.getTimeFilter({rangeRaw:e.range});t=t.replace("$timeFilter",a)}return this._influxRequest("GET","/query",{q:t,epoch:"ms"},e)},t.prototype.serializeParams=function(t){return t?A.a.reduce(t,function(t,e,a){return null===e||void 0===e?t:(t.push(encodeURIComponent(a)+"="+encodeURIComponent(e)),t)},[]).join("&"):""},t.prototype.testDatasource=function(){var t=new or({measurement:"",tags:[]},this.database).buildExploreQuery("RETENTION POLICIES");return this._seriesQuery(t).then(function(t){var e=A.a.get(t,"results[0].error");return e?{status:"error",message:e}:{status:"success",message:"Data source is working"}}).catch(function(t){return{status:"error",message:t.message}})},t.prototype._influxRequest=function(t,e,a,r){var n=this.urls.shift();this.urls.push(n);var i={};this.username&&(i.u=this.username,i.p=this.password),r&&r.database?i.db=r.database:this.database&&(i.db=this.database),"GET"===t&&(A.a.extend(i,a),a=null);var s={method:t,url:n+e,params:i,data:a,precision:"ms",inspect:{type:"influxdb"},paramSerializer:this.serializeParams};return s.headers=s.headers||{},(this.basicAuth||this.withCredentials)&&(s.withCredentials=!0),this.basicAuth&&(s.headers.Authorization=this.basicAuth),this.backendSrv.datasourceRequest(s).then(function(t){return t.data},function(t){if(0!==t.status||t.status>=300)throw t.data&&t.data.error?{message:"InfluxDB Error: "+t.data.error,data:t.data,config:t.config}:{message:"Network Error: "+t.statusText+"("+t.status+")",data:t.data,config:t.config}})},t.prototype.getTimeFilter=function(t){var e=this.getInfluxTime(t.rangeRaw.from,!1),a=this.getInfluxTime(t.rangeRaw.to,!0),r="ms"===e[e.length-1];return"now()"!==a||r?"time >= "+e+" and time <= "+a:"time >= "+e},t.prototype.getInfluxTime=function(t,e){if(A.a.isString(t)){if("now"===t)return"now()";var a=/^now-(\d+)([d|h|m|s])$/.exec(t);if(a)return"now() - "+parseInt(a[1],10)+a[2];t=Vt.parse(t,e)}return t.valueOf()+"ms"},t}(),ur=function(t){function e(e,a,r,n,i){var s=t.call(this,e,a)||this;s.templateSrv=r,s.$q=n,s.uiSegmentSrv=i,s.target=s.target,s.queryModel=new rr(s.target,r,s.panel.scopedVars),s.queryBuilder=new or(s.target,s.datasource.database),s.groupBySegment=s.uiSegmentSrv.newPlusButton(),s.resultFormats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"}],s.policySegment=i.newSegment(s.target.policy),s.target.measurement?s.measurementSegment=i.newSegment(s.target.measurement):s.measurementSegment=i.newSelectMeasurement(),s.tagSegments=[];for(var o=0,l=s.target.tags;o<l.length;o++){var u=l[o];u.operator||(/^\/.*\/$/.test(u.value)?u.operator="=~":u.operator="="),u.condition&&s.tagSegments.push(i.newCondition(u.condition)),s.tagSegments.push(i.newKey(u.key)),s.tagSegments.push(i.newOperator(u.operator)),s.tagSegments.push(i.newKeyValue(u.value))}return s.fixTagSegments(),s.buildSelectMenu(),s.removeTagFilterSegment=i.newSegment({fake:!0,value:"-- remove tag filter --"}),s}return e.$inject=["$scope","$injector","templateSrv","$q","uiSegmentSrv"],Rt.d(e,t),e.prototype.removeOrderByTime=function(){this.target.orderByTime="ASC"},e.prototype.buildSelectMenu=function(){var t=ar.getCategories();this.selectMenu=A.a.reduce(t,function(t,e,a){var r={text:a,submenu:e.map(function(t){return{text:t.type,value:t.type}})};return t.push(r),t},[])},e.prototype.getGroupByOptions=function(){var t=this,e=this.queryBuilder.buildExploreQuery("TAG_KEYS");return this.datasource.metricFindQuery(e).then(function(e){var a=[];t.queryModel.hasFill()||a.push(t.uiSegmentSrv.newSegment({value:"fill(null)"})),t.target.limit||a.push(t.uiSegmentSrv.newSegment({value:"LIMIT"})),t.target.slimit||a.push(t.uiSegmentSrv.newSegment({value:"SLIMIT"})),"ASC"===t.target.orderByTime&&a.push(t.uiSegmentSrv.newSegment({value:"ORDER BY time DESC"})),t.queryModel.hasGroupByTime()||a.push(t.uiSegmentSrv.newSegment({value:"time($interval)"}));for(var r=0,n=e;r<n.length;r++){var i=n[r];a.push(t.uiSegmentSrv.newSegment({value:"tag("+i.text+")"}))}return a}).catch(this.handleQueryError.bind(this))},e.prototype.groupByAction=function(){switch(this.groupBySegment.value){case"LIMIT":this.target.limit=10;break;case"SLIMIT":this.target.slimit=10;break;case"ORDER BY time DESC":this.target.orderByTime="DESC";break;default:this.queryModel.addGroupBy(this.groupBySegment.value)}var t=this.uiSegmentSrv.newPlusButton();this.groupBySegment.value=t.value,this.groupBySegment.html=t.html,this.panelCtrl.refresh()},e.prototype.addSelectPart=function(t,e,a){this.queryModel.addSelectPart(t,a.value),this.panelCtrl.refresh()},e.prototype.handleSelectPartEvent=function(t,e,a){switch(a.name){case"get-param-options":var r=this.queryBuilder.buildExploreQuery("FIELDS");return this.datasource.metricFindQuery(r).then(this.transformToSegments(!0)).catch(this.handleQueryError.bind(this));case"part-param-changed":this.panelCtrl.refresh();break;case"action":this.queryModel.removeSelectPart(t,e),this.panelCtrl.refresh();break;case"get-part-actions":return this.$q.when([{text:"Remove",value:"remove-part"}])}},e.prototype.handleGroupByPartEvent=function(t,e,a){switch(a.name){case"get-param-options":var r=this.queryBuilder.buildExploreQuery("TAG_KEYS");return this.datasource.metricFindQuery(r).then(this.transformToSegments(!0)).catch(this.handleQueryError.bind(this));case"part-param-changed":this.panelCtrl.refresh();break;case"action":this.queryModel.removeGroupByPart(t,e),this.panelCtrl.refresh();break;case"get-part-actions":return this.$q.when([{text:"Remove",value:"remove-part"}])}},e.prototype.fixTagSegments=function(){var t=this.tagSegments.length,e=this.tagSegments[Math.max(t-1,0)];e&&"plus-button"===e.type||this.tagSegments.push(this.uiSegmentSrv.newPlusButton())},e.prototype.measurementChanged=function(){this.target.measurement=this.measurementSegment.value,this.panelCtrl.refresh()},e.prototype.getPolicySegments=function(){var t=this.queryBuilder.buildExploreQuery("RETENTION POLICIES");return this.datasource.metricFindQuery(t).then(this.transformToSegments(!1)).catch(this.handleQueryError.bind(this))},e.prototype.policyChanged=function(){this.target.policy=this.policySegment.value,this.panelCtrl.refresh()},e.prototype.toggleEditorMode=function(){try{this.target.query=this.queryModel.render(!1)}catch(t){console.log("query render error")}this.target.rawQuery=!this.target.rawQuery},e.prototype.getMeasurements=function(t){var e=this.queryBuilder.buildExploreQuery("MEASUREMENTS",void 0,t);return this.datasource.metricFindQuery(e).then(this.transformToSegments(!0)).catch(this.handleQueryError.bind(this))},e.prototype.handleQueryError=function(t){return this.error=t.message||"Failed to issue metric query",[]},e.prototype.transformToSegments=function(t){var e=this;return function(a){var r=A.a.map(a,function(t){return e.uiSegmentSrv.newSegment({value:t.text,expandable:t.expandable})});if(t)for(var n=0,i=e.templateSrv.variables;n<i.length;n++){var s=i[n];r.unshift(e.uiSegmentSrv.newSegment({type:"value",value:"/^$"+s.name+"$/",expandable:!0}))}return r}},e.prototype.getTagsOrValues=function(t,e){var a,r,n=this;if("condition"===t.type)return this.$q.when([this.uiSegmentSrv.newSegment("AND"),this.uiSegmentSrv.newSegment("OR")]);if("operator"===t.type){var i=this.tagSegments[e+1].value;return/^\/.*\/$/.test(i)?this.$q.when(this.uiSegmentSrv.newOperators(["=~","!~"])):this.$q.when(this.uiSegmentSrv.newOperators(["=","!=","<>","<",">"]))}return"key"===t.type||"plus-button"===t.type?(a=this.queryBuilder.buildExploreQuery("TAG_KEYS"),r=!1):"value"===t.type&&(a=this.queryBuilder.buildExploreQuery("TAG_VALUES",this.tagSegments[e-2].value),r=!0),this.datasource.metricFindQuery(a).then(this.transformToSegments(r)).then(function(e){return"key"===t.type&&e.splice(0,0,P.a.copy(n.removeTagFilterSegment)),e}).catch(this.handleQueryError.bind(this))},e.prototype.getFieldSegments=function(){var t=this.queryBuilder.buildExploreQuery("FIELDS");return this.datasource.metricFindQuery(t).then(this.transformToSegments(!1)).catch(this.handleQueryError)},e.prototype.tagSegmentUpdated=function(t,e){this.tagSegments[e]=t,t.value===this.removeTagFilterSegment.value?(this.tagSegments.splice(e,3),0===this.tagSegments.length?this.tagSegments.push(this.uiSegmentSrv.newPlusButton()):this.tagSegments.length>2&&(this.tagSegments.splice(Math.max(e-1,0),1),"plus-button"!==this.tagSegments[this.tagSegments.length-1].type&&this.tagSegments.push(this.uiSegmentSrv.newPlusButton()))):("plus-button"===t.type&&(e>2&&this.tagSegments.splice(e,0,this.uiSegmentSrv.newCondition("AND")),this.tagSegments.push(this.uiSegmentSrv.newOperator("=")),this.tagSegments.push(this.uiSegmentSrv.newFake("select tag value","value","query-segment-value")),t.type="key",t.cssClass="query-segment-key"),e+1===this.tagSegments.length&&this.tagSegments.push(this.uiSegmentSrv.newPlusButton())),this.rebuildTargetTagConditions()},e.prototype.rebuildTargetTagConditions=function(){var t=this,e=[],a=0,r="";A.a.each(this.tagSegments,function(n,i){"key"===n.type?(0===e.length&&e.push({}),e[a].key=n.value):"value"===n.type?((r=t.getTagValueOperator(n.value,e[a].operator))&&(t.tagSegments[i-1]=t.uiSegmentSrv.newOperator(r),e[a].operator=r),e[a].value=n.value):"condition"===n.type?(e.push({condition:n.value}),a+=1):"operator"===n.type&&(e[a].operator=n.value)}),this.target.tags=e,this.panelCtrl.refresh()},e.prototype.getTagValueOperator=function(t,e){return"=~"!==e&&"!~"!==e&&/^\/.*\/$/.test(t)?"=~":"=~"!==e&&"!~"!==e||!/^(?!\/.*\/$)/.test(t)?null:"="},e.prototype.getCollapsedText=function(){return this.queryModel.render(!1)},e.templateUrl="partials/query.editor.html",e}(Qt),cr=function(){function t(){}return t.templateUrl="partials/config.html",t}(),hr=function(){function t(){}return t.templateUrl="partials/annotations.editor.html",t}();function pr(t,e){var a=t.line,r=t.timestamp,n="EK"+r+e.labels,i=L()(r),s=i.fromNow(),o=i.format("YYYY-MM-DD HH:mm:ss"),l=function(t,e){if(!t||!e)return[];for(var a=new RegExp("(?:"+e+")","g"),r=[],n=a.exec(t);n;)r.push({text:n[0],start:n.index,length:n[0].length}),n=a.exec(t);return r}(a,e.search);return{key:n,logLevel:function(t){var e;if(t)return Object.keys(sr).forEach(function(a){e||new RegExp("\\b"+a+"\\b","i").test(t)&&(e=sr[a])}),e}(a),searchMatches:l,timeFromNow:s,timeLocal:o,entry:a,timestamp:r}}!function(t){t.crit="crit",t.warn="warn",t.err="error",t.error="error",t.info="info",t.debug="debug",t.trace="trace"}(sr||(sr={}));var dr={direction:"BACKWARD",limit:100,regexp:"",query:""},mr=/({\w+="[^"]+"})?\s*(\w[^{]+)?\s*({\w+="[^"]+"})?/;var fr=function(){function t(t,e,a){this.instanceSettings=t,this.backendSrv=e,this.templateSrv=a}return t.$inject=["instanceSettings","backendSrv","templateSrv"],t.prototype._request=function(t,e,a){var r=""+this.instanceSettings.url+t+"?"+(e?function(t){return Object.keys(t).map(function(e){var a=t[e];return encodeURIComponent(e)+"="+encodeURIComponent(a)}).join("&")}(e):""),n=Rt.a({},a,{url:r});return this.backendSrv.datasourceRequest(n)},t.prototype.prepareQueryTarget=function(t,e){var a=this.templateSrv.replace(t.expr),r=this.getTime(e.range.from,!1),n=this.getTime(e.range.to,!0);return Rt.a({},dr,function(t){var e=t.match(mr),a="",r="";return e&&(e[1]&&(a=e[1]),e[2]&&(r=e[2].trim()),e[3]&&(a=e[1]?e[1].slice(0,-1)+","+e[3].slice(1):e[3])),{query:a,regexp:r}}(a),{start:r,end:n})},t.prototype.query=function(t){var e=this,a=t.targets.filter(function(t){return t.expr}).map(function(a){return e.prepareQueryTarget(a,t)});if(0===a.length)return Promise.resolve({data:[]});var r=a.map(function(t){return e._request("/api/prom/query",t)});return Promise.all(r).then(function(t){return{data:function(t,e){var a=t.reduce(function(t,e){return t.concat(e.entries.map(function(t){return pr(t,e)}))},[]);return{rows:A.a.chain(a).sortBy("timestamp").reverse().slice(0,e||a.length).value()}}(t.reduce(function(t,e,r){var n=e.data.streams||[],i=a[r].regexp;return n.forEach(function(t){t.search=i}),t.concat(n)},[]),100)}})},t.prototype.metadataRequest=function(t){var e=t.replace("v1","prom");return this._request(e,{silent:!0}).then(function(t){return{data:{data:t.data.values||[]}}})},t.prototype.getTime=function(t,e){return A.a.isString(t)&&(t=Vt.parse(t,e)),Math.ceil(1e6*t.valueOf())},t.prototype.testDatasource=function(){return this._request("/api/prom/label").then(function(t){return t&&t.data&&t.data.values&&t.data.values.length>0?{status:"success",message:"Data source connected and labels found."}:{status:"error",message:"Data source connected, but no labels received. Verify that logging is configured properly."}}).catch(function(t){return{status:"error",message:t.message}})},t}(),gr=function(){function t(){}return t.templateUrl="partials/config.html",t}(),vr=function(){function t(t,e){this.$q=t,this.datasourceSrv=e}return t.$inject=["$q","datasourceSrv"],t.prototype.query=function(t){var e=this,a=A.a.groupBy(t.targets,"datasource"),r=A.a.map(a,function(a){var r=a[0].datasource;return"-- Mixed --"===r?e.$q([]):e.datasourceSrv.get(r).then(function(e){var r=P.a.copy(t);return r.targets=a,e.query(r)})});return this.$q.all(r).then(function(t){return{data:A.a.flatten(A.a.map(t,"data"))}})},t}(),yr=function(){function t(t){this.$q=t}return t.prototype.processQueryResult=function(t){var e=[];if(!t.data.results)return{data:e};for(var a in t.data.results){var r=t.data.results[a];if(r.series)for(var n=0,i=r.series;n<i.length;n++){var s=i[n];e.push({target:s.name,datapoints:s.points,refId:r.refId,meta:r.meta})}if(r.tables)for(var o=0,l=r.tables;o<l.length;o++){var u=l[o];u.type="table",u.refId=r.refId,u.meta=r.meta,e.push(u)}}return{data:e}},t.prototype.parseMetricFindQueryResult=function(t,e){if(!e||0===e.data.length||0===e.data.results[t].meta.rowCount)return[];var a=e.data.results[t].tables[0].columns,r=e.data.results[t].tables[0].rows,n=this.findColIndex(a,"__text"),i=this.findColIndex(a,"__value");return 2===a.length&&-1!==n&&-1!==i?this.transformToKeyValueList(r,n,i):this.transformToSimpleList(r)},t.prototype.transformToKeyValueList=function(t,e,a){for(var r=[],n=0;n<t.length;n++)this.containsKey(r,t[n][e])||r.push({text:t[n][e],value:t[n][a]});return r},t.prototype.transformToSimpleList=function(t){for(var e=[],a=0;a<t.length;a++)for(var r=0;r<t[a].length;r++){var n=t[a][r];-1===e.indexOf(n)&&e.push(n)}return A.a.map(e,function(t){return{text:t}})},t.prototype.findColIndex=function(t,e){for(var a=0;a<t.length;a++)if(t[a].text===e)return a;return-1},t.prototype.containsKey=function(t,e){for(var a=0;a<t.length;a++)if(t[a].text===e)return!0;return!1},t.prototype.transformAnnotationResponse=function(t,e){for(var a=e.data.results[t.annotation.name].tables[0],r=-1,n=-1,i=-1,s=0;s<a.columns.length;s++)if("time_sec"===a.columns[s].text||"time"===a.columns[s].text)r=s;else{if("title"===a.columns[s].text)return this.$q.reject({message:"The title column for annotations is deprecated, now only a column named text is returned"});"text"===a.columns[s].text?n=s:"tags"===a.columns[s].text&&(i=s)}if(-1===r)return this.$q.reject({message:"Missing mandatory time column (with time_sec column alias) in annotation query."});var o=[];for(s=0;s<a.rows.length;s++){var l=a.rows[s];o.push({annotation:t.annotation,time:Math.floor(l[r]),text:l[n]?l[n].toString():"",tags:l[i]?l[i].trim().split(/\s*,\s*/):[]})}return o},t}(),br=function(){function t(t,e,a,r){this.backendSrv=e,this.$q=a,this.templateSrv=r,this.name=t.name,this.id=t.id,this.responseParser=new yr(this.$q),this.interval=(t.jsonData||{}).timeInterval}return t.$inject=["instanceSettings","backendSrv","$q","templateSrv"],t.prototype.interpolateVariable=function(t,e){return"string"==typeof t?e.multi||e.includeAll?"'"+t.replace(/'/g,"''")+"'":t:"number"==typeof t?t:A.a.map(t,function(e){return"number"==typeof t?t:"'"+e.replace(/'/g,"''")+"'"}).join(",")},t.prototype.query=function(t){var e=this,a=A.a.filter(t.targets,function(t){return!0!==t.hide}).map(function(a){return{refId:a.refId,intervalMs:t.intervalMs,maxDataPoints:t.maxDataPoints,datasourceId:e.id,rawSql:e.templateSrv.replace(a.rawSql,t.scopedVars,e.interpolateVariable),format:a.format}});return 0===a.length?this.$q.when({data:[]}):this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:t.range.from.valueOf().toString(),to:t.range.to.valueOf().toString(),queries:a}}).then(this.responseParser.processQueryResult)},t.prototype.annotationQuery=function(t){var e=this;if(!t.annotation.rawQuery)return this.$q.reject({message:"Query missing in annotation definition"});var a={refId:t.annotation.name,datasourceId:this.id,rawSql:this.templateSrv.replace(t.annotation.rawQuery,t.scopedVars,this.interpolateVariable),format:"table"};return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:t.range.from.valueOf().toString(),to:t.range.to.valueOf().toString(),queries:[a]}}).then(function(a){return e.responseParser.transformAnnotationResponse(t,a)})},t.prototype.metricFindQuery=function(t,e){var a=this,r="tempvar";e&&e.variable&&e.variable.name&&(r=e.variable.name);var n={queries:[{refId:r,datasourceId:this.id,rawSql:this.templateSrv.replace(t,{},this.interpolateVariable),format:"table"}]};return e&&e.range&&e.range.from&&(n.from=e.range.from.valueOf().toString()),e&&e.range&&e.range.to&&(n.to=e.range.to.valueOf().toString()),this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:n}).then(function(t){return a.responseParser.parseMetricFindQueryResult(r,t)})},t.prototype.testDatasource=function(){return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:"5m",to:"now",queries:[{refId:"A",intervalMs:1,maxDataPoints:1,datasourceId:this.id,rawSql:"SELECT 1",format:"table"}]}}).then(function(t){return{status:"success",message:"Database Connection OK"}}).catch(function(t){return console.log(t),t.data&&t.data.message?{status:"error",message:t.data.message}:{status:"error",message:t.status}})},t}(),Sr="SELECT\n  UNIX_TIMESTAMP(<time_column>) as time_sec,\n  <value column> as value,\n  <series name column> as metric\nFROM <table name>\nWHERE $__timeFilter(time_column)\nORDER BY <time_column> ASC\n",xr=function(t){function e(e,a){var r=t.call(this,e,a)||this;return r.target.format=r.target.format||"time_series",r.target.alias="",r.formats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"}],r.target.rawSql||("table"===r.panelCtrl.panel.type?(r.target.format="table",r.target.rawSql="SELECT 1"):r.target.rawSql=Sr),r.panelCtrl.events.on("data-received",r.onDataReceived.bind(r),e),r.panelCtrl.events.on("data-error",r.onDataError.bind(r),e),r}return e.$inject=["$scope","$injector"],Rt.d(e,t),e.prototype.onDataReceived=function(t){this.lastQueryMeta=null,this.lastQueryError=null;var e=A.a.find(t,{refId:this.target.refId});e&&(this.lastQueryMeta=e.meta)},e.prototype.onDataError=function(t){if(t.data&&t.data.results){var e=t.data.results[this.target.refId];e&&(this.lastQueryMeta=e.meta,this.lastQueryError=e.error)}},e.templateUrl="partials/query.editor.html",e}(Qt),wr=function(){function t(){}return t.templateUrl="partials/config.html",t}(),kr="SELECT\n    UNIX_TIMESTAMP(<time_column>) as time_sec,\n    <text_column> as text,\n    <tags_column> as tags\n  FROM <table name>\n  WHERE $__timeFilter(time_column)\n  ORDER BY <time_column> ASC\n  LIMIT 100\n  ",Cr=function(){function t(){this.annotation.rawQuery=this.annotation.rawQuery||kr}return t.templateUrl="partials/annotations.editor.html",t}(),Tr=function(){function t(t){this.$q=t}return t.prototype.processQueryResult=function(t){var e=[];if(!t.data.results)return{data:e};for(var a in t.data.results){var r=t.data.results[a];if(r.series)for(var n=0,i=r.series;n<i.length;n++){var s=i[n];e.push({target:s.name,datapoints:s.points,refId:r.refId,meta:r.meta})}if(r.tables)for(var o=0,l=r.tables;o<l.length;o++){var u=l[o];u.type="table",u.refId=r.refId,u.meta=r.meta,e.push(u)}}return{data:e}},t.prototype.parseMetricFindQueryResult=function(t,e){if(!e||0===e.data.length||0===e.data.results[t].meta.rowCount)return[];var a=e.data.results[t].tables[0].columns,r=e.data.results[t].tables[0].rows,n=this.findColIndex(a,"__text"),i=this.findColIndex(a,"__value");return 2===a.length&&-1!==n&&-1!==i?this.transformToKeyValueList(r,n,i):this.transformToSimpleList(r)},t.prototype.transformToKeyValueList=function(t,e,a){for(var r=[],n=0;n<t.length;n++)this.containsKey(r,t[n][e])||r.push({text:t[n][e],value:t[n][a]});return r},t.prototype.transformToSimpleList=function(t){for(var e=[],a=0;a<t.length;a++)for(var r=0;r<t[a].length;r++){var n=t[a][r];-1===e.indexOf(n)&&e.push(n)}return A.a.map(e,function(t){return{text:t}})},t.prototype.findColIndex=function(t,e){for(var a=0;a<t.length;a++)if(t[a].text===e)return a;return-1},t.prototype.containsKey=function(t,e){for(var a=0;a<t.length;a++)if(t[a].text===e)return!0;return!1},t.prototype.transformAnnotationResponse=function(t,e){for(var a=e.data.results[t.annotation.name].tables[0],r=-1,n=-1,i=-1,s=0;s<a.columns.length;s++)"time"===a.columns[s].text?r=s:"text"===a.columns[s].text?n=s:"tags"===a.columns[s].text&&(i=s);if(-1===r)return this.$q.reject({message:"Missing mandatory time column in annotation query."});var o=[];for(s=0;s<a.rows.length;s++){var l=a.rows[s];o.push({annotation:t.annotation,time:Math.floor(l[r]),title:l[-1],text:l[n],tags:l[i]?l[i].trim().split(/\s*,\s*/):[]})}return o},t}(),_r=function(){function t(t,e,a){this.target=t,this.templateSrv=e,this.scopedVars=a,t.format=t.format||"time_series",t.timeColumn=t.timeColumn||"time",t.metricColumn=t.metricColumn||"none",t.group=t.group||[],t.where=t.where||[{type:"macro",name:"$__timeFilter",params:[]}],t.select=t.select||[[{type:"column",params:["value"]}]],"rawQuery"in this.target||(t.rawQuery="rawSql"in t),this.interpolateQueryStr=this.interpolateQueryStr.bind(this)}return t.$inject=["target","templateSrv","scopedVars"],t.prototype.unquoteIdentifier=function(t){return'"'===t[0]&&'"'===t[t.length-1]?t.substring(1,t.length-1).replace(/""/g,'"'):t},t.prototype.quoteIdentifier=function(t){return'"'+String(t).replace(/"/g,'""')+'"'},t.prototype.quoteLiteral=function(t){return"'"+String(t).replace(/'/g,"''")+"'"},t.prototype.escapeLiteral=function(t){return String(t).replace(/'/g,"''")},t.prototype.hasTimeGroup=function(){return A.a.find(this.target.group,function(t){return"time"===t.type})},t.prototype.hasMetricColumn=function(){return"none"!==this.target.metricColumn},t.prototype.interpolateQueryStr=function(t,e,a){return e.multi||e.includeAll?"string"==typeof t?this.quoteLiteral(t):A.a.map(t,this.quoteLiteral).join(","):this.escapeLiteral(t)},t.prototype.render=function(t){var e=this.target;return this.target.rawQuery||"table"in this.target?(e.rawQuery||(e.rawSql=this.buildQuery()),t?this.templateSrv.replace(e.rawSql,this.scopedVars,this.interpolateQueryStr):e.rawSql):""},t.prototype.hasUnixEpochTimecolumn=function(){return["int4","int8","float4","float8","numeric"].indexOf(this.target.timeColumnType)>-1},t.prototype.buildTimeColumn=function(t){void 0===t&&(t=!0);var e,a=this.hasTimeGroup(),r="$__timeGroup";if(a){var n=void 0;n=a.params.length>1&&"none"!==a.params[1]?a.params.join(","):a.params[0],this.hasUnixEpochTimecolumn()&&(r="$__unixEpochGroup"),t&&(r+="Alias"),e=r+"("+this.target.timeColumn+","+n+")"}else e=this.target.timeColumn,t&&(e+=' AS "time"');return e},t.prototype.buildMetricColumn=function(){return this.hasMetricColumn()?this.target.metricColumn+" AS metric":""},t.prototype.buildValueColumns=function(){for(var t="",e=0,a=this.target.select;e<a.length;e++){var r=a[e];t+=",\n  "+this.buildValueColumn(r)}return t},t.prototype.buildValueColumn=function(t){var e="";e=A.a.find(t,function(t){return"column"===t.type}).params[0];var a=A.a.find(t,function(t){return"aggregate"===t.type||"percentile"===t.type}),r=A.a.find(t,function(t){return"window"===t.type||"moving_window"===t.type});if(a){var n=a.params[0];switch(a.type){case"aggregate":e="first"===n||"last"===n?n+"("+e+","+this.target.timeColumn+")":n+"("+e+")";break;case"percentile":e=n+"("+a.params[1]+") WITHIN GROUP (ORDER BY "+e+")"}}if(r){var i=[];this.hasMetricColumn()&&i.push("PARTITION BY "+this.target.metricColumn),i.push("ORDER BY "+this.buildTimeColumn(!1));var s=i.join(" "),o=void 0,l=void 0;switch(r.type){case"window":switch(r.params[0]){case"increase":e="(CASE WHEN "+(o=e)+" >= "+(l="lag("+o+") OVER ("+s+")")+" THEN "+o+" - "+l,e+=" WHEN "+l+" IS NULL THEN NULL ELSE "+o+" END)";break;case"rate":var u=this.target.timeColumn;a&&(u="min("+u+")"),e="(CASE WHEN "+(o=e)+" >= "+(l="lag("+o+") OVER ("+s+")")+" THEN "+o+" - "+l,e+=" WHEN "+l+" IS NULL THEN NULL ELSE "+o+" END)",e+="/extract(epoch from "+u+" - lag("+u+") OVER ("+s+"))";break;default:e=r.params[0]+"("+e+") OVER ("+s+")"}break;case"moving_window":e=r.params[0]+"("+e+") OVER ("+s+" ROWS "+r.params[1]+" PRECEDING)"}}var c=A.a.find(t,function(t){return"alias"===t.type});return c&&(e+=" AS "+this.quoteIdentifier(c.params[0])),e},t.prototype.buildWhereClause=function(){var t=this,e="",a=A.a.map(this.target.where,function(e,a){switch(e.type){case"macro":return e.name+"("+t.target.timeColumn+")";case"expression":return e.params.join(" ")}});return a.length>0&&(e="\nWHERE\n  "+a.join(" AND\n  ")),e},t.prototype.buildGroupClause=function(){for(var t="",e="",a=0;a<this.target.group.length;a++){var r=this.target.group[a];a>0&&(e+=", "),"time"===r.type?e+="1":e+=r.params[0]}return e.length&&(t="\nGROUP BY "+e,this.hasMetricColumn()&&(t+=",2")),t},t.prototype.buildQuery=function(){var t="SELECT";return t+="\n  "+this.buildTimeColumn(),this.hasMetricColumn()&&(t+=",\n  "+this.buildMetricColumn()),t+=this.buildValueColumns(),t+="\nFROM "+this.target.table,t+=this.buildWhereClause(),t+=this.buildGroupClause(),t+="\nORDER BY 1",this.hasMetricColumn()&&(t+=",2"),t},t}(),Mr=function(){function t(t,e,a,r,n){this.backendSrv=e,this.$q=a,this.templateSrv=r,this.timeSrv=n,this.name=t.name,this.id=t.id,this.jsonData=t.jsonData,this.responseParser=new Tr(this.$q),this.queryModel=new _r({}),this.interval=(t.jsonData||{}).timeInterval}return t.$inject=["instanceSettings","backendSrv","$q","templateSrv","timeSrv"],t.prototype.interpolateVariable=function(t,e){var a=this;return"string"==typeof t?e.multi||e.includeAll?this.queryModel.quoteLiteral(t):t:"number"==typeof t?t:A.a.map(t,function(t){return a.queryModel.quoteLiteral(t)}).join(",")},t.prototype.query=function(t){var e=this,a=A.a.filter(t.targets,function(t){return!0!==t.hide}).map(function(a){var r=new _r(a,e.templateSrv,t.scopedVars);return{refId:a.refId,intervalMs:t.intervalMs,maxDataPoints:t.maxDataPoints,datasourceId:e.id,rawSql:r.render(e.interpolateVariable),format:a.format}});return 0===a.length?this.$q.when({data:[]}):this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:t.range.from.valueOf().toString(),to:t.range.to.valueOf().toString(),queries:a}}).then(this.responseParser.processQueryResult)},t.prototype.annotationQuery=function(t){var e=this;if(!t.annotation.rawQuery)return this.$q.reject({message:"Query missing in annotation definition"});var a={refId:t.annotation.name,datasourceId:this.id,rawSql:this.templateSrv.replace(t.annotation.rawQuery,t.scopedVars,this.interpolateVariable),format:"table"};return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:t.range.from.valueOf().toString(),to:t.range.to.valueOf().toString(),queries:[a]}}).then(function(a){return e.responseParser.transformAnnotationResponse(t,a)})},t.prototype.metricFindQuery=function(t,e){var a=this,r="tempvar";e&&e.variable&&e.variable.name&&(r=e.variable.name);var n={refId:r,datasourceId:this.id,rawSql:this.templateSrv.replace(t,{},this.interpolateVariable),format:"table"},i=this.timeSrv.timeRange(),s={queries:[n],from:i.from.valueOf().toString(),to:i.to.valueOf().toString()};return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:s}).then(function(t){return a.responseParser.parseMetricFindQueryResult(r,t)})},t.prototype.getVersion=function(){return this.metricFindQuery("SELECT current_setting('server_version_num')::int/100",{})},t.prototype.getTimescaleDBVersion=function(){return this.metricFindQuery("SELECT extversion FROM pg_extension WHERE extname = 'timescaledb'",{})},t.prototype.testDatasource=function(){return this.metricFindQuery("SELECT 1",{}).then(function(t){return{status:"success",message:"Database Connection OK"}}).catch(function(t){return console.log(t),t.data&&t.data.message?{status:"error",message:t.data.message}:{status:"error",message:t.status}})},t}(),$r=function(){function t(t,e){this.target=t,this.queryModel=e}return t.prototype.getOperators=function(t){switch(t){case"float4":case"float8":return["=","!=","<","<=",">",">="];case"text":case"varchar":case"char":return["=","!=","<","<=",">",">=","IN","NOT IN","LIKE","NOT LIKE","~","~*","!~","!~*"];default:return["=","!=","<","<=",">",">=","IN","NOT IN"]}},t.prototype.quoteIdentAsLiteral=function(t){return this.queryModel.quoteLiteral(this.queryModel.unquoteIdentifier(t))},t.prototype.findMetricTable=function(){return"\nSELECT\n\tquote_ident(table_name) as table_name,\n\t( SELECT\n\t    quote_ident(column_name) as column_name\n\t  FROM information_schema.columns c\n    WHERE\n      c.table_schema = t.table_schema AND\n      c.table_name = t.table_name AND\n      udt_name IN ('timestamptz','timestamp')\n    ORDER BY ordinal_position LIMIT 1\n  ) AS time_column,\n  ( SELECT\n      quote_ident(column_name) AS column_name\n    FROM information_schema.columns c\n    WHERE\n      c.table_schema = t.table_schema AND\n      c.table_name = t.table_name AND\n      udt_name='float8'\n    ORDER BY ordinal_position LIMIT 1\n  ) AS value_column\nFROM information_schema.tables t\nWHERE\n  table_schema IN (\n\t\tSELECT CASE WHEN trim(unnest) = '\"$user\"' THEN user ELSE trim(unnest) END\n    FROM unnest(string_to_array(current_setting('search_path'),','))\n  ) AND\n  EXISTS\n  ( SELECT 1\n    FROM information_schema.columns c\n    WHERE\n      c.table_schema = t.table_schema AND\n      c.table_name = t.table_name AND\n      udt_name IN ('timestamptz','timestamp')\n  ) AND\n  EXISTS\n  ( SELECT 1\n    FROM information_schema.columns c\n    WHERE\n      c.table_schema = t.table_schema AND\n      c.table_name = t.table_name AND\n      udt_name='float8'\n  )\nLIMIT 1\n;"},t.prototype.buildSchemaConstraint=function(){return"\ntable_schema IN (\n\tSELECT CASE WHEN trim(unnest) = '\"$user\"' THEN user ELSE trim(unnest) END\n  FROM unnest(string_to_array(current_setting('search_path'),','))\n)"},t.prototype.buildTableConstraint=function(t){var e="";if(t.includes(".")){var a=t.split(".");return e="table_schema = "+this.quoteIdentAsLiteral(a[0]),e+=" AND table_name = "+this.quoteIdentAsLiteral(a[1])}return e="\ntable_schema IN (\n\tSELECT CASE WHEN trim(unnest) = '\"$user\"' THEN user ELSE trim(unnest) END\n  FROM unnest(string_to_array(current_setting('search_path'),','))\n)",e+=" AND table_name = "+this.quoteIdentAsLiteral(t)},t.prototype.buildTableQuery=function(){var t="SELECT quote_ident(table_name) FROM information_schema.tables WHERE ";return t+=this.buildSchemaConstraint(),t+=" ORDER BY table_name"},t.prototype.buildColumnQuery=function(t){var e="SELECT quote_ident(column_name) FROM information_schema.columns WHERE ";switch(e+=this.buildTableConstraint(this.target.table),t){case"time":e+=" AND data_type IN ('timestamp without time zone','timestamp with time zone','bigint','integer','double precision','real')";break;case"metric":e+=" AND data_type IN ('text','character','character varying')";break;case"value":e+=" AND data_type IN ('bigint','integer','double precision','real')",e+=" AND column_name <> "+this.quoteIdentAsLiteral(this.target.timeColumn);break;case"group":e+=" AND data_type IN ('text','character','character varying')"}return e+=" ORDER BY column_name"},t.prototype.buildValueQuery=function(t){var e="SELECT DISTINCT quote_literal("+t+")";return e+=" FROM "+this.target.table,e+=" WHERE $__timeFilter("+this.target.timeColumn+")",e+=" ORDER BY 1 LIMIT 100"},t.prototype.buildDatatypeQuery=function(t){var e="\nSELECT udt_name\nFROM information_schema.columns\nWHERE\n  table_schema IN (\n  SELECT schema FROM (\n\t\t  SELECT CASE WHEN trim(unnest) = '\"$user\"' THEN user ELSE trim(unnest) END as schema\n      FROM unnest(string_to_array(current_setting('search_path'),','))\n    ) s\n    WHERE EXISTS (SELECT 1 FROM information_schema.schemata WHERE schema_name = s.schema)\n  )\n";return e+=" AND table_name = "+this.quoteIdentAsLiteral(this.target.table),e+=" AND column_name = "+this.quoteIdentAsLiteral(t)},t.prototype.buildAggregateQuery=function(){var t="SELECT DISTINCT proname FROM pg_aggregate ";return t+="INNER JOIN pg_proc ON pg_aggregate.aggfnoid = pg_proc.oid ",t+="INNER JOIN pg_type ON pg_type.oid=pg_proc.prorettype ",t+="WHERE pronargs=1 AND typname IN ('float8') AND aggkind='n' ORDER BY 1"},t}(),Pr=function(){return function(t){this.type=t.type,t.label?this.label=t.label:this.label=this.type[0].toUpperCase()+this.type.substring(1)+":",this.style=t.style,"function"===this.style?(this.wrapOpen="(",this.wrapClose=")",this.separator=", "):(this.wrapOpen=" ",this.wrapClose=" ",this.separator=" "),this.params=t.params,this.defaultParams=t.defaultParams}}(),Er=function(){function t(t,e){if(this.part=t,this.def=e,!this.def)throw{message:"Could not find sql part "+t.type};this.datatype=t.datatype,t.name?(this.name=t.name,this.label=e.label+" "+t.name):(this.name="",this.label=e.label),t.params=t.params||A.a.clone(this.def.defaultParams),this.params=t.params}return t.prototype.updateParam=function(t,e){""===t&&this.def.params[e].optional?this.params.splice(e,1):this.params[e]=t,this.part.params=this.params},t}(),Ar=[];function Dr(t){Ar[t.type]=new Pr(t)}Dr({type:"column",style:"label",params:[{type:"column",dynamicLookup:!0}],defaultParams:["value"]}),Dr({type:"expression",style:"expression",label:"Expr:",params:[{name:"left",type:"string",dynamicLookup:!0},{name:"op",type:"string",dynamicLookup:!0},{name:"right",type:"string",dynamicLookup:!0}],defaultParams:["value","=","value"]}),Dr({type:"macro",style:"label",label:"Macro:",params:[],defaultParams:[]}),Dr({type:"aggregate",style:"label",params:[{name:"name",type:"string",options:["avg","count","min","max","sum","stddev","variance"]}],defaultParams:["avg"]}),Dr({type:"percentile",label:"Aggregate:",style:"label",params:[{name:"name",type:"string",options:["percentile_cont","percentile_disc"]},{name:"fraction",type:"number",options:["0.5","0.75","0.9","0.95","0.99"]}],defaultParams:["percentile_cont","0.95"]}),Dr({type:"alias",style:"label",params:[{name:"name",type:"string",quote:"double"}],defaultParams:["alias"]}),Dr({type:"time",style:"function",label:"time",params:[{name:"interval",type:"interval",options:["$__interval","1s","10s","1m","5m","10m","15m","1h"]},{name:"fill",type:"string",options:["none","NULL","previous","0"]}],defaultParams:["$__interval","none"]}),Dr({type:"window",style:"label",params:[{name:"function",type:"string",options:["increase","rate","sum"]}],defaultParams:["increase"]}),Dr({type:"moving_window",style:"label",label:"Moving Window:",params:[{name:"function",type:"string",options:["avg"]},{name:"window_size",type:"number",options:["3","5","7","10","20"]}],defaultParams:["avg","5"]});var Fr={create:function(t){var e=Ar[t.type];return e?new Er(t,e):null}},Ir="SELECT\n  $__time(time_column),\n  value1\nFROM\n  metric_table\nWHERE\n  $__timeFilter(time_column)\n",Or=function(t){function e(e,a,r,n,i){var s=t.call(this,e,a)||this;return s.templateSrv=r,s.$q=n,s.uiSegmentSrv=i,s.target=s.target,s.queryModel=new _r(s.target,r,s.panel.scopedVars),s.metaBuilder=new $r(s.target,s.queryModel),s.updateProjection(),s.formats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"}],s.target.rawSql||("table"===s.panelCtrl.panel.type?(s.target.format="table",s.target.rawSql="SELECT 1",s.target.rawQuery=!0):(s.target.rawSql=Ir,s.datasource.metricFindQuery(s.metaBuilder.findMetricTable()).then(function(t){if(t.length>0){s.target.table=t[0].text;var e=s.uiSegmentSrv.newSegment(s.target.table);s.tableSegment.html=e.html,s.tableSegment.value=e.value,s.target.timeColumn=t[1].text,e=s.uiSegmentSrv.newSegment(s.target.timeColumn),s.timeColumnSegment.html=e.html,s.timeColumnSegment.value=e.value,s.target.timeColumnType="timestamp",s.target.select=[[{type:"column",params:[t[2].text]}]],s.updateProjection(),s.panelCtrl.refresh()}}))),s.target.table?s.tableSegment=i.newSegment(s.target.table):s.tableSegment=i.newSegment({value:"select table",fake:!0}),s.timeColumnSegment=i.newSegment(s.target.timeColumn),s.metricColumnSegment=i.newSegment(s.target.metricColumn),s.buildSelectMenu(),s.whereAdd=s.uiSegmentSrv.newPlusButton(),s.groupAdd=s.uiSegmentSrv.newPlusButton(),s.panelCtrl.events.on("data-received",s.onDataReceived.bind(s),e),s.panelCtrl.events.on("data-error",s.onDataError.bind(s),e),s}return e.$inject=["$scope","$injector","templateSrv","$q","uiSegmentSrv"],Rt.d(e,t),e.prototype.updateProjection=function(){this.selectParts=A.a.map(this.target.select,function(t){return A.a.map(t,Fr.create).filter(function(t){return t})}),this.whereParts=A.a.map(this.target.where,Fr.create).filter(function(t){return t}),this.groupParts=A.a.map(this.target.group,Fr.create).filter(function(t){return t})},e.prototype.updatePersistedParts=function(){this.target.select=A.a.map(this.selectParts,function(t){return A.a.map(t,function(t){return{type:t.def.type,datatype:t.datatype,params:t.params}})}),this.target.where=A.a.map(this.whereParts,function(t){return{type:t.def.type,datatype:t.datatype,name:t.name,params:t.params}}),this.target.group=A.a.map(this.groupParts,function(t){return{type:t.def.type,datatype:t.datatype,params:t.params}})},e.prototype.buildSelectMenu=function(){this.selectMenu=[];var t={text:"Aggregate Functions",value:"aggregate",submenu:[{text:"Average",value:"avg"},{text:"Count",value:"count"},{text:"Maximum",value:"max"},{text:"Minimum",value:"min"},{text:"Sum",value:"sum"},{text:"Standard deviation",value:"stddev"},{text:"Variance",value:"variance"}]};if(!0===this.datasource.jsonData.timescaledb&&(t.submenu.push({text:"First",value:"first"}),t.submenu.push({text:"Last",value:"last"})),this.selectMenu.push(t),this.datasource.jsonData.postgresVersion>=904){this.selectMenu.push({text:"Ordered-Set Aggregate Functions",value:"percentile",submenu:[{text:"Percentile (continuous)",value:"percentile_cont"},{text:"Percentile (discrete)",value:"percentile_disc"}]})}this.selectMenu.push({text:"Window Functions",value:"window",submenu:[{text:"Increase",value:"increase"},{text:"Rate",value:"rate"},{text:"Sum",value:"sum"},{text:"Moving Average",value:"avg",type:"moving_window"}]}),this.selectMenu.push({text:"Alias",value:"alias"}),this.selectMenu.push({text:"Column",value:"column"})},e.prototype.toggleEditorMode=function(){var t=this;this.target.rawQuery?et.a.emit("confirm-modal",{title:"Warning",text2:"Switching to query builder may overwrite your raw SQL.",icon:"fa-exclamation",yesText:"Switch",onConfirm:function(){t.target.rawQuery=!t.target.rawQuery}}):this.target.rawQuery=!this.target.rawQuery},e.prototype.resetPlusButton=function(t){var e=this.uiSegmentSrv.newPlusButton();t.html=e.html,t.value=e.value},e.prototype.getTableSegments=function(){return this.datasource.metricFindQuery(this.metaBuilder.buildTableQuery()).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this))},e.prototype.tableChanged=function(){var t=this;this.target.table=this.tableSegment.value,this.target.where=[],this.target.group=[],this.updateProjection();var e=this.uiSegmentSrv.newSegment("none");this.metricColumnSegment.html=e.html,this.metricColumnSegment.value=e.value,this.target.metricColumn="none";var a=this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("time")).then(function(e){if(e.length>0&&!A.a.find(e,function(e){return e.text===t.target.timeColumn})){var a=t.uiSegmentSrv.newSegment(e[0].text);t.timeColumnSegment.html=a.html,t.timeColumnSegment.value=a.value}return t.timeColumnChanged(!1)}),r=this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("value")).then(function(e){e.length>0&&(t.target.select=[[{type:"column",params:[e[0].text]}]],t.updateProjection())});this.$q.all([a,r]).then(function(){t.panelCtrl.refresh()})},e.prototype.getTimeColumnSegments=function(){return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("time")).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this))},e.prototype.timeColumnChanged=function(t){var e=this;return this.target.timeColumn=this.timeColumnSegment.value,this.datasource.metricFindQuery(this.metaBuilder.buildDatatypeQuery(this.target.timeColumn)).then(function(a){if(1===a.length){e.target.timeColumnType!==a[0].text&&(e.target.timeColumnType=a[0].text);var r=void 0;r=e.queryModel.hasUnixEpochTimecolumn()?Fr.create({type:"macro",name:"$__unixEpochFilter",params:[]}):Fr.create({type:"macro",name:"$__timeFilter",params:[]}),e.whereParts.length>=1&&"macro"===e.whereParts[0].def.type?e.whereParts[0]=r:e.whereParts.splice(0,0,r)}e.updatePersistedParts(),!1!==t&&e.panelCtrl.refresh()})},e.prototype.getMetricColumnSegments=function(){return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("metric")).then(this.transformToSegments({addNone:!0})).catch(this.handleQueryError.bind(this))},e.prototype.metricColumnChanged=function(){this.target.metricColumn=this.metricColumnSegment.value,this.panelCtrl.refresh()},e.prototype.onDataReceived=function(t){this.lastQueryMeta=null,this.lastQueryError=null;var e=A.a.find(t,{refId:this.target.refId});e&&(this.lastQueryMeta=e.meta)},e.prototype.onDataError=function(t){if(t.data&&t.data.results){var e=t.data.results[this.target.refId];e&&(this.lastQueryMeta=e.meta,this.lastQueryError=e.error)}},e.prototype.transformToSegments=function(t){var e=this;return function(a){var r=A.a.map(a,function(t){return e.uiSegmentSrv.newSegment({value:t.text,expandable:t.expandable})});if(t.addTemplateVars)for(var n=0,i=e.templateSrv.variables;n<i.length;n++){var s=i[n],o=void 0;o="$"+s.name,t.templateQuoter&&!1===s.multi&&(o=t.templateQuoter(o)),r.unshift(e.uiSegmentSrv.newSegment({type:"template",value:o,expandable:!0}))}return t.addNone&&r.unshift(e.uiSegmentSrv.newSegment({type:"template",value:"none",expandable:!0})),r}},e.prototype.findAggregateIndex=function(t){return A.a.findIndex(t,function(t){return"aggregate"===t.def.type||"percentile"===t.def.type})},e.prototype.findWindowIndex=function(t){return A.a.findIndex(t,function(t){return"window"===t.def.type||"moving_window"===t.def.type})},e.prototype.addSelectPart=function(t,e,a){var r=e.value;a&&a.type&&(r=a.type);var n=Fr.create({type:r});a&&(n.params[0]=a.value);var i=!1;switch(r){case"column":var s=A.a.map(t,function(t){return Fr.create({type:t.def.type,params:A.a.clone(t.params)})});this.selectParts.push(s);break;case"percentile":case"aggregate":0===this.target.group.length&&this.addGroup("time","$__interval");var o=this.findAggregateIndex(t);-1!==o?t[o]=n:t.splice(1,0,n),A.a.find(t,function(t){return"alias"===t.def.type})||(i=!0);break;case"moving_window":case"window":var l=this.findWindowIndex(t);if(-1!==l)t[l]=n;else{var u=this.findAggregateIndex(t);-1!==u?t.splice(u+1,0,n):t.splice(1,0,n)}A.a.find(t,function(t){return"alias"===t.def.type})||(i=!0);break;case"alias":i=!0}i&&(n=Fr.create({type:"alias",params:[t[0].params[0].replace(/"/g,"")]}),"alias"===t[t.length-1].def.type?t[t.length-1]=n:t.push(n)),this.updatePersistedParts(),this.panelCtrl.refresh()},e.prototype.removeSelectPart=function(t,e){if("column"===e.def.type){if(this.selectParts.length>1){var a=A.a.indexOf(this.selectParts,t);this.selectParts.splice(a,1)}}else{var r=A.a.indexOf(t,e);t.splice(r,1)}this.updatePersistedParts()},e.prototype.handleSelectPartEvent=function(t,e,a){switch(a.name){case"get-param-options":switch(e.def.type){case"aggregate":return this.datasource.metricFindQuery(this.metaBuilder.buildAggregateQuery()).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this));case"column":return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("value")).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this))}case"part-param-changed":this.updatePersistedParts(),this.panelCtrl.refresh();break;case"action":this.removeSelectPart(t,e),this.panelCtrl.refresh();break;case"get-part-actions":return this.$q.when([{text:"Remove",value:"remove-part"}])}},e.prototype.handleGroupPartEvent=function(t,e,a){switch(a.name){case"get-param-options":return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery()).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this));case"part-param-changed":this.updatePersistedParts(),this.panelCtrl.refresh();break;case"action":this.removeGroup(t,e),this.panelCtrl.refresh();break;case"get-part-actions":return this.$q.when([{text:"Remove",value:"remove-part"}])}},e.prototype.addGroup=function(t,e){var a=[e];"time"===t&&(a=["$__interval","none"]);var r=Fr.create({type:t,params:a});"time"===t?this.groupParts.splice(0,0,r):this.groupParts.push(r);for(var n=0,i=this.selectParts;n<i.length;n++){var s=i[n];if(!s.some(function(t){return"aggregate"===t.def.type})){var o=Fr.create({type:"aggregate",params:["avg"]});if(s.splice(1,0,o),!s.some(function(t){return"alias"===t.def.type})){var l=Fr.create({type:"alias",params:[s[0].part.params[0]]});s.push(l)}}}this.updatePersistedParts()},e.prototype.removeGroup=function(t,e){"time"===t.def.type&&(this.selectParts=A.a.map(this.selectParts,function(t){return A.a.filter(t,function(t){return"aggregate"!==t.def.type&&"percentile"!==t.def.type})})),this.groupParts.splice(e,1),this.updatePersistedParts()},e.prototype.handleWherePartEvent=function(t,e,a,r){var n=this;switch(a.name){case"get-param-options":switch(a.param.name){case"left":return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery()).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this));case"right":return["int4","int8","float4","float8","timestamp","timestamptz"].indexOf(e.datatype)>-1?this.$q.when([]):this.datasource.metricFindQuery(this.metaBuilder.buildValueQuery(e.params[0])).then(this.transformToSegments({addTemplateVars:!0,templateQuoter:function(t){return n.queryModel.quoteLiteral(t)}})).catch(this.handleQueryError.bind(this));case"op":return this.$q.when(this.uiSegmentSrv.newOperators(this.metaBuilder.getOperators(e.datatype)));default:return this.$q.when([])}case"part-param-changed":this.updatePersistedParts(),this.datasource.metricFindQuery(this.metaBuilder.buildDatatypeQuery(e.params[0])).then(function(t){1===t.length&&(e.datatype=t[0].text)}),this.panelCtrl.refresh();break;case"action":t.splice(r,1),this.updatePersistedParts(),this.panelCtrl.refresh();break;case"get-part-actions":return this.$q.when([{text:"Remove",value:"remove-part"}])}},e.prototype.getWhereOptions=function(){var t=[];return this.queryModel.hasUnixEpochTimecolumn()?t.push(this.uiSegmentSrv.newSegment({type:"macro",value:"$__unixEpochFilter"})):t.push(this.uiSegmentSrv.newSegment({type:"macro",value:"$__timeFilter"})),t.push(this.uiSegmentSrv.newSegment({type:"expression",value:"Expression"})),this.$q.when(t)},e.prototype.addWhereAction=function(t,e){switch(this.whereAdd.type){case"macro":var a=Fr.create({type:"macro",name:this.whereAdd.value,params:[]});this.whereParts.length>=1&&"macro"===this.whereParts[0].def.type?this.whereParts[0]=a:this.whereParts.splice(0,0,a);break;default:this.whereParts.push(Fr.create({type:"expression",params:["value","=","value"]}))}this.updatePersistedParts(),this.resetPlusButton(this.whereAdd),this.panelCtrl.refresh()},e.prototype.getGroupOptions=function(){var t=this;return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("group")).then(function(e){var a=[];t.queryModel.hasTimeGroup()||a.push(t.uiSegmentSrv.newSegment({type:"time",value:"time($__interval,none)"}));for(var r=0,n=e;r<n.length;r++){var i=n[r];a.push(t.uiSegmentSrv.newSegment({type:"column",value:i.text}))}return a}).catch(this.handleQueryError.bind(this))},e.prototype.addGroupAction=function(){this.groupAdd.value,this.addGroup(this.groupAdd.type,this.groupAdd.value),this.resetPlusButton(this.groupAdd),this.panelCtrl.refresh()},e.prototype.handleQueryError=function(t){return this.error=t.message||"Failed to issue metric query",[]},e.templateUrl="partials/query.editor.html",e}(Qt),qr=function(){function t(t,e){this.postgresVersions=[{name:"9.3",value:903},{name:"9.4",value:904},{name:"9.5",value:905},{name:"9.6",value:906},{name:"10",value:1e3}],this.datasourceSrv=e,this.current.jsonData.sslmode=this.current.jsonData.sslmode||"verify-full",this.current.jsonData.postgresVersion=this.current.jsonData.postgresVersion||903,this.showTimescaleDBHelp=!1,this.autoDetectFeatures()}return t.$inject=["$scope","datasourceSrv"],t.prototype.autoDetectFeatures=function(){var t=this;this.current.id&&this.datasourceSrv.loadDatasource(this.current.name).then(function(e){return e.getVersion().then(function(a){(a=Number(a[0].text))>=906&&e.getTimescaleDBVersion().then(function(e){1===e.length&&(t.current.jsonData.timescaledb=!0)});var r=Math.trunc(a/100),n=a%100,i=String(r);a<1e3&&(i=String(r)+"."+String(n)),A.a.find(t.postgresVersions,function(t){return t.value===a})||t.postgresVersions.push({name:i,value:a}),t.current.jsonData.postgresVersion=a})})},t.prototype.toggleTimescaleDBHelp=function(){this.showTimescaleDBHelp=!this.showTimescaleDBHelp},t.templateUrl="partials/config.html",t}(),Rr="SELECT\n  extract(epoch from time_column) AS time,\n  text_column as text,\n  tags_column as tags\nFROM\n  metric_table\nWHERE\n  $__timeFilter(time_column)\n",Nr=function(){function t(){this.annotation.rawQuery=this.annotation.rawQuery||Rr}return t.templateUrl="partials/annotations.editor.html",t}(),Vr=function(){function t(t,e,a){this.datasource=t,this.query=e,this.range=a.timeRange()}return t.prototype.process=function(){var t=this.query.match(/^label_values\((?:(.+),\s*)?([a-zA-Z_][a-zA-Z0-9_]+)\)\s*$/);if(t)return t[1]?this.labelValuesQuery(t[2],t[1]):this.labelValuesQuery(t[2],null);var e=this.query.match(/^metrics\((.+)\)\s*$/);if(e)return this.metricNameQuery(e[1]);var a=this.query.match(/^query_result\((.+)\)\s*$/);return a?this.queryResultQuery(a[1]):this.metricNameAndLabelsQuery(this.query)},t.prototype.labelValuesQuery=function(t,e){var a;if(e){var r=this.datasource.getPrometheusTime(this.range.from,!1),n=this.datasource.getPrometheusTime(this.range.to,!0);return a="/api/v1/series?match[]="+encodeURIComponent(e)+"&start="+r+"&end="+n,this.datasource.metadataRequest(a).then(function(e){var a=A.a.map(e.data.data,function(e){return e[t]||""}).filter(function(t){return""!==t});return A.a.uniq(a).map(function(t){return{text:t,expandable:!0}})})}return a="/api/v1/label/"+t+"/values",this.datasource.metadataRequest(a).then(function(t){return A.a.map(t.data.data,function(t){return{text:t}})})},t.prototype.metricNameQuery=function(t){return this.datasource.metadataRequest("/api/v1/label/__name__/values").then(function(e){return A.a.chain(e.data.data).filter(function(e){return new RegExp(t).test(e)}).map(function(t){return{text:t,expandable:!0}}).value()})},t.prototype.queryResultQuery=function(t){var e=this.datasource.getPrometheusTime(this.range.to,!0);return this.datasource.performInstantQuery({expr:t},e).then(function(t){return A.a.map(t.data.data.result,function(t){var e=t.metric.__name__||"";return delete t.metric.__name__,e+="{"+A.a.map(t.metric,function(t,e){return e+'="'+t+'"'}).join(",")+"}",{text:e+=" "+t.value[1]+" "+1e3*t.value[0],expandable:!0}})})},t.prototype.metricNameAndLabelsQuery=function(t){var e=this.datasource.getPrometheusTime(this.range.from,!1),a=this.datasource.getPrometheusTime(this.range.to,!0),r="/api/v1/series?match[]="+encodeURIComponent(t)+"&start="+e+"&end="+a,n=this;return this.datasource.metadataRequest(r).then(function(t){return A.a.map(t.data.data,function(t){return{text:n.datasource.getOriginalMetricName(t),expandable:!0}})})},t}(),Lr=function(){function t(t){this.templateSrv=t}return t.prototype.transform=function(t,e){var a=t.data.data.result;if("table"===e.format)return[this.transformMetricDataToTable(a,e.responseListLength,e.refId)];if("heatmap"===e.format){var r=[];a.sort(jr);for(var n=0,i=a;n<i.length;n++){var s=i[n];r.push(this.transformMetricData(s,e,e.start,e.end))}return r=this.transformToHistogramOverTime(r)}r=[];for(var o=0,l=a;o<l.length;o++){s=l[o];"matrix"===t.data.data.resultType?r.push(this.transformMetricData(s,e,e.start,e.end)):"vector"===t.data.data.resultType&&r.push(this.transformInstantMetricData(s,e))}return r},t.prototype.transformMetricData=function(t,e,a,r){var n,i=[];n=this.createMetricLabel(t.metric,e);var s=1e3*parseInt(e.step,10),o=1e3*a;if(void 0===t.values)throw new Error("Prometheus heatmap error: data should be a time series");for(var l=0,u=t.values;l<u.length;l++){var c=u[l],h=parseFloat(c[1]);A.a.isNaN(h)&&(h=null);for(var p=1e3*parseFloat(c[0]),d=o;d<p;d+=s)i.push([null,d]);o=p+s,i.push([h,p])}var m=1e3*r;for(d=o;d<=m;d+=s)i.push([null,d]);return{datapoints:i,query:e.query,responseIndex:e.responseIndex,target:n}},t.prototype.transformMetricDataToTable=function(t,e,a){var r,n,i=new ie.a,s={};if(0===t.length)return i;A.a.each(t,function(t){for(var e in t.metric)s.hasOwnProperty(e)||(s[e]=1)});var o=A.a.keys(s).sort();i.columns.push({text:"Time",type:"time"}),A.a.each(o,function(t,e){s[t]=e+1,i.columns.push({text:t,filterable:!t.startsWith("__")})});var l=e>1?"Value #"+a:"Value";return i.columns.push({text:l}),A.a.each(t,function(t){if(t.value&&(t.values=[t.value]),t.values)for(r=0;r<t.values.length;r++){var e=t.values[r],a=[1e3*e[0]];if(t.metric)for(n=0;n<o.length;n++){var s=o[n];t.metric.hasOwnProperty(s)?a.push(t.metric[s]):a.push("")}a.push(parseFloat(e[1])),i.rows.push(a)}}),i},t.prototype.transformInstantMetricData=function(t,e){var a,r=[];return a=this.createMetricLabel(t.metric,e),r.push([parseFloat(t.value[1]),1e3*t.value[0]]),{target:a,datapoints:r,labels:t.metric}},t.prototype.createMetricLabel=function(t,e){var a="";return(a=A.a.isUndefined(e)||A.a.isEmpty(e.legendFormat)?this.getOriginalMetricName(t):this.renderTemplate(this.templateSrv.replace(e.legendFormat),t))&&"{}"!==a||(a=e.query),a},t.prototype.renderTemplate=function(t,e){return t.replace(/\{\{\s*(.+?)\s*\}\}/g,function(t,a){return e[a]?e[a]:a})},t.prototype.getOriginalMetricName=function(t){var e=t.__name__||"";return delete t.__name__,e+"{"+A.a.map(A.a.toPairs(t),function(t){return t[0]+'="'+t[1]+'"'}).join(",")+"}"},t.prototype.transformToHistogramOverTime=function(t){for(var e=t.length-1;e>0;e--){var a=t[e].datapoints,r=t[e-1].datapoints;if(!a||!r)throw new Error("Prometheus heatmap transform error: data should be a time series");for(var n=0;n<a.length;n++){var i=r[n]||[0];a[n][0]-=i[0]}}return t},t}();function jr(t,e){var a,r;try{a=Ur(t.metric.le),r=Ur(e.metric.le)}catch(t){return console.log(t),0}return a>r?1:a<r?-1:0}function Ur(t){return"+Inf"===t?1/0:Number(t)}var Br="by|without|on|ignoring|group_left|group_right",Qr=[Br,"count|count_values|min|max|avg|sum|stddev|stdvar|bottomk|topk|quantile","true|false|null|__name__|job","abs|absent|ceil|changes|clamp_max|clamp_min|count_scalar|day_of_month|day_of_week|days_in_month|delta|deriv","drop_common_labels|exp|floor|histogram_quantile|holt_winters|hour|idelta|increase|irate|label_replace|ln|log2","log10|minute|month|predict_linear|rate|resets|round|scalar|sort|sort_desc|sqrt|time|vector|year|avg_over_time","min_over_time|max_over_time|sum_over_time|count_over_time|quantile_over_time|stddev_over_time|stdvar_over_time"].join("|").split("|");function Hr(t){return"string"==typeof t?t.replace(/'/g,"\\\\'"):t}function zr(t){return"string"==typeof t?Hr(t.replace(/\\/g,"\\\\\\\\").replace(/[$^*{}\[\]+?.()]/g,"\\\\$&")):t}var Yr=function(){function t(t,e,a,r,n){this.$q=e,this.backendSrv=a,this.templateSrv=r,this.timeSrv=n,this.type="prometheus",this.editorSrc="app/features/prometheus/partials/query.editor.html",this.name=t.name,this.supportsExplore=!0,this.supportMetrics=!0,this.url=t.url,this.directUrl=t.directUrl,this.basicAuth=t.basicAuth,this.withCredentials=t.withCredentials,this.interval=t.jsonData.timeInterval||"15s",this.queryTimeout=t.jsonData.queryTimeout,this.httpMethod=t.jsonData.httpMethod||"GET",this.resultTransformer=new Lr(r),this.ruleMappings={}}return t.$inject=["instanceSettings","$q","backendSrv","templateSrv","timeSrv"],t.prototype.init=function(){this.loadRules()},t.prototype._request=function(t,e,a){return"GET"===(a=A.a.defaults(a||{},{url:this.url+t,method:this.httpMethod})).method?A.a.isEmpty(e)||(a.url=a.url+"?"+A.a.map(e,function(t,e){return encodeURIComponent(e)+"="+encodeURIComponent(t)}).join("&")):(a.headers={"Content-Type":"application/x-www-form-urlencoded"},a.transformRequest=function(t){return F.a.param(t)},a.data=e),(this.basicAuth||this.withCredentials)&&(a.withCredentials=!0),this.basicAuth&&(a.headers={Authorization:this.basicAuth}),this.backendSrv.datasourceRequest(a)},t.prototype.metadataRequest=function(t){return this._request(t,null,{method:"GET",silent:!0})},t.prototype.interpolateQueryExpr=function(t,e,a){return e.multi||e.includeAll?"string"==typeof t?zr(t):A.a.map(t,zr).join("|"):Hr(t)},t.prototype.targetContainsTemplate=function(t){return this.templateSrv.variableExists(t.expr)},t.prototype.query=function(t){for(var e=this,a=this.getPrometheusTime(t.range.from,!1),r=this.getPrometheusTime(t.range.to,!0),n=[],i=[],s=0,o=(t=A.a.clone(t)).targets;s<o.length;s++){var l=o[s];l.expr&&!l.hide&&(i.push(l),n.push(this.createQuery(l,t,a,r)))}if(A.a.isEmpty(n))return this.$q.when({data:[]});var u=A.a.map(n,function(t){return t.instant?e.performInstantQuery(t,r):e.performTimeSeriesQuery(t,t.start,t.end)});return this.$q.all(u).then(function(t){var a=[],r=[];return A.a.each(t,function(s,o){if("error"===s.status)throw Rt.a({index:o},s.error);var l={format:i[o].format,step:n[o].step,legendFormat:i[o].legendFormat,start:n[o].start,end:n[o].end,query:n[o].expr,responseListLength:t.length,responseIndex:o,refId:i[o].refId},u=e.resultTransformer.transform(s,l);if(a=a.concat(u),n[o].hinting){var c=function(t,e){return t.map(function(t,a){var r=t.query,n=t.responseIndex;if(void 0===r||void 0===n)return null;if(r.trim().match(/^\w+_bucket$/))return{index:n,label:l="Time series has buckets, you probably wanted a histogram.",fix:{label:"Fix by adding histogram_quantile().",action:{type:"ADD_HISTOGRAM_QUANTILE",query:r,index:n}}};var i=t.datapoints;if(i.length>1){var s=!1,o=i.filter(function(t){return null!==t[0]}).every(function(t,e){return 0===e||(s=s||t[0]>i[e-1][0],t[0]>=i[e-1][0])});if(s&&o){var l="Time series is monotonously increasing.",u=void 0;return r.trim().match(/^\w+$/)?u={label:"Fix by adding rate().",action:{type:"ADD_RATE",query:r,index:n}}:l+=" Try applying a rate() function.",{label:l,index:n,fix:u}}}if(e&&e.ruleMappings){var c=e.ruleMappings,h=Object.keys(c).reduce(function(t,e){var a;return r.search(e)>-1?Rt.a({},t,((a={})[e]=c[e],a)):t},{});if(A.a.size(h)>0)return{label:l="Query contains recording rules.",index:n,fix:{label:"Expand rules",action:{type:"EXPAND_RULES",query:r,index:n,mapping:h}}}}return null})}(u,e);r=r.concat(c)}}),{data:a,hints:r}})},t.prototype.createQuery=function(t,e,a,r){var n={hinting:t.hinting,instant:t.instant},i=Math.ceil(r-a),s=J.a.interval_to_seconds(e.interval),o=J.a.interval_to_seconds(this.templateSrv.replace(t.interval,e.scopedVars)||e.interval),l=t.intervalFactor||1,u=this.adjustInterval(s,o,i,l),c=Rt.a({},e.scopedVars,this.getRangeScopedVars());s!==u&&(s=u,c=Object.assign({},e.scopedVars,Rt.a({__interval:{text:s+"s",value:s+"s"},__interval_ms:{text:1e3*s,value:1e3*s}},this.getRangeScopedVars()))),n.step=s,n.expr=this.templateSrv.replace(t.expr,c,this.interpolateQueryExpr),n.requestId=e.panelId+t.refId;var h=function(t,e,a){return{end:Math.ceil(e/a)*a,start:Math.floor(t/a)*a}}(a,r,n.step);return n.start=h.start,n.end=h.end,n},t.prototype.adjustInterval=function(t,e,a,r){return 0!==t&&a/r/t>11e3&&(t=Math.ceil(a/r/11e3)),Math.max(t*r,e,1)},t.prototype.performTimeSeriesQuery=function(t,e,a){if(e>a)throw{message:"Invalid time range"};var r={query:t.expr,start:e,end:a,step:t.step};return this.queryTimeout&&(r.timeout=this.queryTimeout),this._request("/api/v1/query_range",r,{requestId:t.requestId})},t.prototype.performInstantQuery=function(t,e){var a={query:t.expr,time:e};return this.queryTimeout&&(a.timeout=this.queryTimeout),this._request("/api/v1/query",a,{requestId:t.requestId})},t.prototype.performSuggestQuery=function(t,e){var a=this;void 0===e&&(e=!1);return e&&this.metricsNameCache&&this.metricsNameCache.expire>Date.now()?this.$q.when(A.a.filter(this.metricsNameCache.data,function(e){return 1!==e.indexOf(t)})):this.metadataRequest("/api/v1/label/__name__/values").then(function(e){return a.metricsNameCache={data:e.data.data,expire:Date.now()+6e4},A.a.filter(e.data.data,function(e){return 1!==e.indexOf(t)})})},t.prototype.metricFindQuery=function(t){if(!t)return this.$q.when([]);var e=Rt.a({__interval:{text:this.interval,value:this.interval},__interval_ms:{text:J.a.interval_to_ms(this.interval),value:J.a.interval_to_ms(this.interval)}},this.getRangeScopedVars()),a=this.templateSrv.replace(t,e,this.interpolateQueryExpr);return new Vr(this,a,this.timeSrv).process()},t.prototype.getRangeScopedVars=function(){var t=this.timeSrv.timeRange(),e=t.to.diff(t.from),a=Math.round(e/1e3),r=J.a.secondsToHms(e/1e3);return{__range_ms:{text:e,value:e},__range_s:{text:a,value:a},__range:{text:r,value:r}}},t.prototype.annotationQuery=function(t){var e=t.annotation,a=e.expr||"",r=e.tagKeys||"",n=e.titleFormat||"",i=e.textFormat||"";if(!a)return this.$q.when([]);var s=e.step||"60s",o=this.getPrometheusTime(t.range.from,!1),l=this.getPrometheusTime(t.range.to,!0),u=Rt.a({},t,{interval:"0s"}),c=this.createQuery({expr:a,interval:s},u,o,l),h=this;return this.performTimeSeriesQuery(c,c.start,c.end).then(function(t){var a=[];return r=r.split(","),A.a.each(t.data.data.result,function(t){for(var s=A.a.chain(t.metric).filter(function(t,e){return A.a.includes(r,e)}).value(),o=0,l=t.values;o<l.length;o++){var u=l[o];if("1"===u[1]){var c={annotation:e,time:1e3*Math.floor(parseFloat(u[0])),title:h.resultTransformer.renderTemplate(n,t.metric),tags:s,text:h.resultTransformer.renderTemplate(i,t.metric)};a.push(c)}}}),a})},t.prototype.testDatasource=function(){var t=(new Date).getTime();return this.performInstantQuery({expr:"1+1"},t/1e3).then(function(t){return"success"===t.data.status?{status:"success",message:"Data source is working"}:{status:"error",message:t.error}})},t.prototype.getExploreState=function(t){var e=this,a={};if(t.targets){var r=t.targets.map(function(t){return{query:e.templateSrv.replace(t.expr,{},e.interpolateQueryExpr),format:t.format}});a=Rt.a({},a,{queries:r,datasource:this.name})}return a},t.prototype.loadRules=function(){var t=this;this.metadataRequest("/api/v1/rules").then(function(t){return t.data||t.json()}).then(function(e){var a=A.a.get(e,["data","groups"]);a&&(t.ruleMappings=function(t){return t.reduce(function(t,e){return e.rules.filter(function(t){return"recording"===t.type}).reduce(function(t,e){var a;return Rt.a({},t,((a={})[e.name]=e.query,a))},t)},{})}(a))}).catch(function(t){console.log("Rules API is experimental. Ignore next error."),console.error(t)})},t.prototype.modifyQuery=function(t,e){switch(e.type){case"ADD_FILTER":return function(t,e,a){if(!e||!a)throw new Error("Need label to add to query.");var r;t=t.replace(/([A-Za-z]\w*)\b(?![\(\]{=",])/g,function(e,a,n){var i=t.slice(n).indexOf("{"),s=t.slice(n).indexOf("}"),o=s>-1&&(-1===i||i>s),l=r&&Br.split("|").indexOf(r)>-1;return r=a,o||l||-1!==Qr.indexOf(a)?a:a+"{}"});for(var n=/{([^{]*)}/g,i=n.exec(t),s=[],o=0,l="",u=function(){var r=t.slice(o,i.index),u=i[1].split(",").reduce(function(t,e){var a=e.split("=");return 2===a.length&&(t[a[0]]=a[1]),t},{});u[e]='"'+a+'"';var c=Object.keys(u).sort().map(function(t){return t+"="+u[t]}).join(",");o=i.index+i[1].length+2,l=t.slice(i.index+i[0].length),s.push(r,"{",c,"}"),i=n.exec(t)};i;)u();return s.push(l),s.join("")}(t,e.key,e.value);case"ADD_HISTOGRAM_QUANTILE":return"histogram_quantile(0.95, sum(rate("+t+"[5m])) by (le))";case"ADD_RATE":return"rate("+t+"[5m])";case"EXPAND_RULES":var a=e.mapping;if(a){var r=Object.keys(a),n=new RegExp("(\\s|^)("+r.join("|")+")(\\s|$|\\()","ig");return t.replace(n,function(t,e,r,n){return a[r]})}default:return t}},t.prototype.getPrometheusTime=function(t,e){return A.a.isString(t)&&(t=Vt.parse(t,e)),Math.ceil(t.valueOf()/1e3)},t.prototype.getOriginalMetricName=function(t){return this.resultTransformer.getOriginalMetricName(t)},t}(),Wr=function(){function t(t,e){this.datasource=t,this.templateSrv=e,this.identifierRegexps=[/\[/,/[a-zA-Z0-9_:]/],this.labelQueryCache={},this.labelNameCache={},this.labelValueCache={},this.templateVariableCompletions=this.templateSrv.variables.map(function(t){return{caption:"$"+t.name,value:"$"+t.name,meta:"variable",score:Number.MAX_VALUE}})}return t.prototype.getCompletions=function(t,e,a,r,n){var i=this,s=function(t,e){return e=e.concat(i.templateVariableCompletions),n(t,e)},o=e.getTokenAt(a.row,a.column);switch(o.type){case"entity.name.tag.label-matcher":return void this.getCompletionsForLabelMatcherName(e,a).then(function(t){s(null,t)});case"string.quoted.label-matcher":return void this.getCompletionsForLabelMatcherValue(e,a).then(function(t){s(null,t)});case"entity.name.tag.label-list-matcher":return void this.getCompletionsForBinaryOperator(e,a).then(function(t){s(null,t)})}if("paren.lparen"===o.type&&"["===o.value){for(var l=[],u=0,c=["s","m","h"];u<c.length;u++)for(var h=c[u],p=0,d=[1,5,10,30];p<d.length;p++){var m=d[p];l.push({caption:m+h,value:"["+m+h,meta:"range vector"})}return l.unshift({caption:"$__interval_ms",value:"[$__interval_ms",meta:"range vector"}),l.unshift({caption:"$__interval",value:"[$__interval",meta:"range vector"}),void s(null,l)}var f=r;return this.datasource.performSuggestQuery(f,!0).then(function(t){s(null,t.map(function(t){var e=t;return"("===r&&(e="("+t),{caption:t,value:e,meta:"metric"}}))})},t.prototype.getCompletionsForLabelMatcherName=function(t,e){var a=this,r=this.findMetricName(t,e.row,e.column);return r?this.labelNameCache[r]?Promise.resolve(this.labelNameCache[r]):this.getLabelNameAndValueForExpression(r,"metricName").then(function(t){var e=a.transformToCompletions(A.a.uniq(A.a.flatten(t.map(function(t){return Object.keys(t.metric)}))),"label name");return a.labelNameCache[r]=e,Promise.resolve(e)}):Promise.resolve(this.transformToCompletions(["__name__","instance","job"],"label name"))},t.prototype.getCompletionsForLabelMatcherValue=function(t,e){var a=this,r=this.findMetricName(t,e.row,e.column);if(!r)return Promise.resolve([]);var n=this.findToken(t,e.row,e.column,"entity.name.tag.label-matcher",null,"paren.lparen.label-matcher");if(!n)return Promise.resolve([]);var i=n.value;return this.labelValueCache[r]&&this.labelValueCache[r][i]?Promise.resolve(this.labelValueCache[r][i]):this.getLabelNameAndValueForExpression(r,"metricName").then(function(t){var e=a.transformToCompletions(A.a.uniq(t.map(function(t){return t.metric[i]})),"label value");return a.labelValueCache[r]=a.labelValueCache[r]||{},a.labelValueCache[r][i]=e,Promise.resolve(e)})},t.prototype.getCompletionsForBinaryOperator=function(t,e){var a,r,n=this,i=this.findToken(t,e.row,e.column,"keyword.control",null,"identifier");if(!i)return Promise.resolve([]);switch(i.value){case"by":case"without":return(a=this.findToken(t,i.row,i.column,"paren.rparen",null,"identifier"))?""===(r=this.findExpressionMatchedParen(t,a.row,a.column))?Promise.resolve([]):this.getLabelNameAndValueForExpression(r,"expression").then(function(t){var e=n.transformToCompletions(A.a.uniq(A.a.flatten(t.map(function(t){return Object.keys(t.metric)}))),"label name");return n.labelNameCache[r]=e,e}):Promise.resolve([]);case"on":case"ignoring":case"group_left":case"group_right":var s=this.findToken(t,i.row,i.column,"keyword.operator.binary",null,"identifier");if(!s)return Promise.resolve([]);if(a=this.findToken(t,s.row,s.column,"paren.rparen",null,"identifier"))return""===(r=this.findExpressionMatchedParen(t,a.row,a.column))?Promise.resolve([]):this.getLabelNameAndValueForExpression(r,"expression").then(function(t){var e=n.transformToCompletions(A.a.uniq(A.a.flatten(t.map(function(t){return Object.keys(t.metric)}))),"label name");return n.labelNameCache[r]=e,e});var o=this.findMetricName(t,s.row,s.column);return this.getLabelNameAndValueForExpression(o,"metricName").then(function(t){var e=n.transformToCompletions(A.a.uniq(A.a.flatten(t.map(function(t){return Object.keys(t.metric)}))),"label name");return n.labelNameCache[o]=e,Promise.resolve(e)})}return Promise.resolve([])},t.prototype.getLabelNameAndValueForExpression=function(t,e){var a=this;if(this.labelQueryCache[t])return Promise.resolve(this.labelQueryCache[t]);var r=t;if("metricName"===e){var n="=~";/[a-zA-Z_:][a-zA-Z0-9_:]*/.test(t)&&(n="="),r="{__name__"+n+'"'+t+'"}'}return this.datasource.performInstantQuery({expr:r},(new Date).getTime()/1e3).then(function(e){return a.labelQueryCache[t]=e.data.data.result,e.data.data.result})},t.prototype.transformToCompletions=function(t,e){return t.map(function(t){return{caption:t,value:t,meta:e,score:Number.MAX_VALUE}})},t.prototype.findMetricName=function(t,e,a){var r="",n=this.findToken(t,e,a,"entity.name.tag.label-matcher","__name__","paren.lparen.label-matcher");if(n){var i=t.getTokens(n.row)[n.index+2];i&&"string.quoted.label-matcher"===i.type&&(r=i.value.slice(1,-1))}else{var s=this.findToken(t,e,a,"identifier",null,null);s&&(t.getTokens(s.row),r=s.value)}return r},t.prototype.findToken=function(t,e,a,r,n,i){for(var s,o,l=e;l>=0;l--){var u=void 0;if(s=t.getTokens(l),l===e)for(u=0,o=0;o<s.length;o++){var c=u+s[o].value.length;if(c>=a)break;u=c}else o=s.length-1,u=A.a.sum(s.map(function(t){return t.value.length}))-s[s.length-1].value.length;for(;o>=0;o--){if(s[o].type===i)return null;if(s[o].type===r&&(!n||s[o].value===n))return s[o].row=l,s[o].column=u,s[o].index=o,s[o];u-=s[o].value.length}}return null},t.prototype.findExpressionMatchedParen=function(t,e,a){for(var r,n,i=1,s=")",o=e;o>=0;o--){if(r=t.getTokens(o),o===e){var l=0;for(n=0;n<r.length&&!((l+=r[n].value.length)>=a);n++);}else n=r.length-1;for(;n>=0;n--)if(s=r[n].value+s,"paren.rparen"===r[n].type)i++;else if("paren.lparen"===r[n].type&&0===--i)return s}return s},t}(),Gr=(a(1221),a(1222),function(t){function e(e,a,r){var n=t.call(this,e,a)||this;n.templateSrv=r;var i=n.target;return i.expr=i.expr||"",i.intervalFactor=i.intervalFactor||1,i.format=i.format||n.getDefaultFormat(),n.metric="",n.resolutions=A.a.map([1,2,3,4,5,10],function(t){return{factor:t,label:"1/"+t}}),n.formats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"},{text:"Heatmap",value:"heatmap"}],n.instant=!1,n.updateLink(),n}return e.$inject=["$scope","$injector","templateSrv"],Rt.d(e,t),e.prototype.getCompleter=function(t){return new Wr(this.datasource,this.templateSrv)},e.prototype.getDefaultFormat=function(){return"table"===this.panelCtrl.panel.type?"table":"heatmap"===this.panelCtrl.panel.type?"heatmap":"time_series"},e.prototype.refreshMetricData=function(){A.a.isEqual(this.oldTarget,this.target)||(this.oldTarget=P.a.copy(this.target),this.panelCtrl.refresh(),this.updateLink())},e.prototype.updateLink=function(){var t=this.panelCtrl.range;if(t){var e=Math.ceil((t.to.valueOf()-t.from.valueOf())/1e3),a=t.to.utc().format("YYYY-MM-DD HH:mm"),r={"g0.expr":this.templateSrv.replace(this.target.expr,this.panelCtrl.panel.scopedVars,this.datasource.interpolateQueryExpr),"g0.range_input":e+"s","g0.end_input":a,"g0.step_input":this.target.step,"g0.stacked":this.panelCtrl.panel.stack?1:0,"g0.tab":0},n=A.a.map(r,function(t,e){return e+"="+encodeURIComponent(t)}).join("&");this.linkToPrometheus=this.datasource.directUrl+"/graph?"+n}},e.prototype.getCollapsedText=function(){return this.target.expr},e.templateUrl="partials/query.editor.html",e}(Qt)),Kr=function(){function t(t){this.current.jsonData.httpMethod=this.current.jsonData.httpMethod||"GET"}return t.$inject=["$scope"],t.templateUrl="public/app/plugins/datasource/prometheus/partials/config.html",t}(),Jr=function(){function t(){}return t.templateUrl="partials/annotations.editor.html",t}(),Xr=function(){function t(t){this.$q=t}return t.prototype.processQueryResult=function(t){var e=[];if(!t.data.results)return{data:e};for(var a in t.data.results){var r=t.data.results[a];if(r.series)for(var n=0,i=r.series;n<i.length;n++){var s=i[n];e.push({target:s.name,datapoints:s.points,refId:r.refId,meta:r.meta})}if(r.tables)for(var o=0,l=r.tables;o<l.length;o++){var u=l[o];u.type="table",u.refId=r.refId,u.meta=r.meta,e.push(u)}}return{data:e}},t.prototype.parseMetricFindQueryResult=function(t,e){if(!e||0===e.data.length||0===e.data.results[t].meta.rowCount)return[];var a=e.data.results[t].tables[0].columns,r=e.data.results[t].tables[0].rows,n=this.findColIndex(a,"__text"),i=this.findColIndex(a,"__value");return 2===a.length&&-1!==n&&-1!==i?this.transformToKeyValueList(r,n,i):this.transformToSimpleList(r)},t.prototype.transformToKeyValueList=function(t,e,a){for(var r=[],n=0;n<t.length;n++)this.containsKey(r,t[n][e])||r.push({text:t[n][e],value:t[n][a]});return r},t.prototype.transformToSimpleList=function(t){for(var e=[],a=0;a<t.length;a++)for(var r=0;r<t[a].length;r++){var n=t[a][r];-1===e.indexOf(n)&&e.push(n)}return A.a.map(e,function(t){return{text:t}})},t.prototype.findColIndex=function(t,e){for(var a=0;a<t.length;a++)if(t[a].text===e)return a;return-1},t.prototype.containsKey=function(t,e){for(var a=0;a<t.length;a++)if(t[a].text===e)return!0;return!1},t.prototype.transformAnnotationResponse=function(t,e){for(var a=e.data.results[t.annotation.name].tables[0],r=-1,n=-1,i=-1,s=0;s<a.columns.length;s++)"time"===a.columns[s].text?r=s:"text"===a.columns[s].text?n=s:"tags"===a.columns[s].text&&(i=s);if(-1===r)return this.$q.reject({message:"Missing mandatory time column (with time column alias) in annotation query."});var o=[];for(s=0;s<a.rows.length;s++){var l=a.rows[s];o.push({annotation:t.annotation,time:Math.floor(l[r]),text:l[n],tags:l[i]?l[i].trim().split(/\s*,\s*/):[]})}return o},t}(),Zr=function(){function t(t,e,a,r){this.backendSrv=e,this.$q=a,this.templateSrv=r,this.name=t.name,this.id=t.id,this.responseParser=new Xr(this.$q),this.interval=(t.jsonData||{}).timeInterval}return t.$inject=["instanceSettings","backendSrv","$q","templateSrv"],t.prototype.interpolateVariable=function(t,e){return"string"==typeof t?e.multi||e.includeAll?"'"+t.replace(/'/g,"''")+"'":t:"number"==typeof t?t:A.a.map(t,function(e){return"number"==typeof t?t:"'"+e.replace(/'/g,"''")+"'"}).join(",")},t.prototype.query=function(t){var e=this,a=A.a.filter(t.targets,function(t){return!0!==t.hide}).map(function(a){return{refId:a.refId,intervalMs:t.intervalMs,maxDataPoints:t.maxDataPoints,datasourceId:e.id,rawSql:e.templateSrv.replace(a.rawSql,t.scopedVars,e.interpolateVariable),format:a.format}});return 0===a.length?this.$q.when({data:[]}):this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:t.range.from.valueOf().toString(),to:t.range.to.valueOf().toString(),queries:a}}).then(this.responseParser.processQueryResult)},t.prototype.annotationQuery=function(t){var e=this;if(!t.annotation.rawQuery)return this.$q.reject({message:"Query missing in annotation definition"});var a={refId:t.annotation.name,datasourceId:this.id,rawSql:this.templateSrv.replace(t.annotation.rawQuery,t.scopedVars,this.interpolateVariable),format:"table"};return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:t.range.from.valueOf().toString(),to:t.range.to.valueOf().toString(),queries:[a]}}).then(function(a){return e.responseParser.transformAnnotationResponse(t,a)})},t.prototype.metricFindQuery=function(t,e){var a=this,r="tempvar";e&&e.variable&&e.variable.name&&(r=e.variable.name);var n={refId:r,datasourceId:this.id,rawSql:this.templateSrv.replace(t,{},this.interpolateVariable),format:"table"};return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{queries:[n]}}).then(function(t){return a.responseParser.parseMetricFindQueryResult(r,t)})},t.prototype.testDatasource=function(){return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:"5m",to:"now",queries:[{refId:"A",intervalMs:1,maxDataPoints:1,datasourceId:this.id,rawSql:"SELECT 1",format:"table"}]}}).then(function(t){return{status:"success",message:"Database Connection OK"}}).catch(function(t){return console.log(t),t.data&&t.data.message?{status:"error",message:t.data.message}:{status:"error",message:t.status}})},t}(),tn="SELECT\n  $__timeEpoch(<time_column>),\n  <value column> as value,\n  <series name column> as metric\nFROM\n  <table name>\nWHERE\n  $__timeFilter(time_column)\nORDER BY\n  <time_column> ASC",en=function(t){function e(e,a){var r=t.call(this,e,a)||this;return r.target.format=r.target.format||"time_series",r.target.alias="",r.formats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"}],r.target.rawSql||("table"===r.panelCtrl.panel.type?(r.target.format="table",r.target.rawSql="SELECT 1"):r.target.rawSql=tn),r.panelCtrl.events.on("data-received",r.onDataReceived.bind(r),e),r.panelCtrl.events.on("data-error",r.onDataError.bind(r),e),r}return e.$inject=["$scope","$injector"],Rt.d(e,t),e.prototype.onDataReceived=function(t){this.lastQueryMeta=null,this.lastQueryError=null;var e=A.a.find(t,{refId:this.target.refId});e&&(this.lastQueryMeta=e.meta)},e.prototype.onDataError=function(t){if(t.data&&t.data.results){var e=t.data.results[this.target.refId];e&&(this.lastQueryMeta=e.meta,this.lastQueryError=e.error)}},e.templateUrl="partials/query.editor.html",e}(Qt),an=function(){function t(){}return t.templateUrl="partials/config.html",t}(),rn="SELECT\n    <time_column> as time,\n    <text_column> as text,\n    <tags_column> as tags\n  FROM\n    <table name>\n  WHERE\n    $__timeFilter(time_column)\n  ORDER BY\n    <time_column> ASC",nn=function(){function t(){this.annotation.rawQuery=this.annotation.rawQuery||rn}return t.templateUrl="partials/annotations.editor.html",t}(),sn=function(){function t(t,e,a){this.backendSrv=e,this.$q=a,this.id=t.id}return t.$inject=["instanceSettings","backendSrv","$q"],t.prototype.query=function(t){var e=this,a=A.a.filter(t.targets,function(t){return!0!==t.hide}).map(function(a){return{refId:a.refId,scenarioId:a.scenarioId,intervalMs:t.intervalMs,maxDataPoints:t.maxDataPoints,stringInput:a.stringInput,points:a.points,alias:a.alias,datasourceId:e.id}});return 0===a.length?this.$q.when({data:[]}):this.backendSrv.post("/api/tsdb/query",{from:t.range.from.valueOf().toString(),to:t.range.to.valueOf().toString(),queries:a}).then(function(t){var e=[];return t.results&&A.a.forEach(t.results,function(t){for(var a=0,r=t.series;a<r.length;a++){var n=r[a];e.push({target:n.name,datapoints:n.points})}}),{data:e}})},t.prototype.annotationQuery=function(t){return this.backendSrv.get("/api/annotations",{from:t.range.from.valueOf(),to:t.range.to.valueOf(),limit:t.limit,type:t.type})},t}(),on=function(t){function e(e,a,r){var n=t.call(this,e,a)||this;return n.backendSrv=r,n.target.scenarioId=n.target.scenarioId||"random_walk",n.scenarioList=[],n.newPointTime=L()(),n.selectedPoint={text:"Select point",value:null},n}return e.$inject=["$scope","$injector","backendSrv"],Rt.d(e,t),e.prototype.getPoints=function(){return A.a.map(this.target.points,function(t,e){return{text:L()(t[1]).format("MMMM Do YYYY, H:mm:ss")+" : "+t[0],value:e}})},e.prototype.pointSelected=function(t){this.selectedPoint=t},e.prototype.deletePoint=function(){this.target.points.splice(this.selectedPoint.value,1),this.selectedPoint={text:"Select point",value:null},this.refresh()},e.prototype.addPoint=function(){this.target.points=this.target.points||[],this.target.points.push([this.newPointValue,this.newPointTime.valueOf()]),this.target.points=A.a.sortBy(this.target.points,function(t){return t[1]}),this.refresh()},e.prototype.$onInit=function(){var t=this;return this.backendSrv.get("/api/tsdb/testdata/scenarios").then(function(e){t.scenarioList=e,t.scenario=A.a.find(t.scenarioList,{id:t.target.scenarioId})})},e.prototype.scenarioChanged=function(){this.scenario=A.a.find(this.scenarioList,{id:this.target.scenarioId}),this.target.stringInput=this.scenario.stringInput,"manual_entry"===this.target.scenarioId?this.target.points=this.target.points||[]:delete this.target.points,this.refresh()},e.templateUrl="partials/query.editor.html",e}(Qt),ln=function(){function t(){}return t.template="<h2>test data</h2>",t}(),un=function(t){function e(e,a,r,n){var i=t.call(this,e,a)||this;return i.templateSrv=r,i.$sce=n,i.panelDefaults={mode:"markdown",content:"# title"},A.a.defaults(i.panel,i.panelDefaults),i.events.on("init-edit-mode",i.onInitEditMode.bind(i)),i.events.on("refresh",i.onRefresh.bind(i)),i.events.on("render",i.onRender.bind(i)),e.$watch("ctrl.panel.content",A.a.throttle(function(){i.render()},1e3)),i}return e.$inject=["$scope","$injector","templateSrv","$sce"],Rt.d(e,t),e.prototype.onInitEditMode=function(){this.addEditorTab("选项","public/app/plugins/panel/text/editor.html"),this.editorTabIndex=1,"text"===this.panel.mode&&(this.panel.mode="markdown")},e.prototype.onRefresh=function(){this.render()},e.prototype.onRender=function(){"markdown"===this.panel.mode?this.renderMarkdown(this.panel.content):"html"===this.panel.mode&&this.updateContent(this.panel.content),this.renderingCompleted()},e.prototype.renderText=function(t){t=t.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/\n/g,"<br/>"),this.updateContent(t)},e.prototype.renderMarkdown=function(t){var e=this;this.remarkable||(this.remarkable=new gt.a),this.$scope.$applyAsync(function(){e.updateContent(e.remarkable.render(t))})},e.prototype.updateContent=function(t){try{this.content=this.$sce.trustAsHtml(this.templateSrv.replace(t,this.panel.scopedVars))}catch(e){console.log("Text panel error: ",e),this.content=this.$sce.trustAsHtml(t)}},e.templateUrl="public/app/plugins/panel/text/module.html",e.scrollable=!0,e}(qt);a(1212),a(1214),a(1213),a(1215),a(1216),a(1217),a(1218),a(1219);function cn(t,e,a){var r=P.a.element(document).injector(),n=document.createElement("div");n.innerHTML='<annotation-tooltip event="event" on-edit="onEdit()"></annotation-tooltip>',r.invoke(["$compile","$rootScope",function(r,i){var s=a.getOptions().events.manager,o=i.$new(!0);o.event=e,o.onEdit=function(){s.editEvent(e)},r(n)(o),o.$digest(),o.$destroy();var l=new Qe.a({target:t[0],content:n,position:"bottom center",classes:"drop-popover drop-popover--annotation",openOn:"hover",hoverCloseDelay:200,tetherOptions:{constraints:[{to:"window",pin:!0,attachment:"both"}]}});l.open(),l.on("close",function(){setTimeout(function(){l.destroy()})})}])}var hn=null;function pn(t,e,a){var r=a.getOptions().events.manager;r.editorOpen?hn=t:(r.editorOpened(),hn=t,setTimeout(function(){var t=P.a.element(document).injector(),a=document.createElement("div");a.innerHTML='<event-editor panel-ctrl="panelCtrl" event="event" close="close()"></event-editor>',t.invoke(["$compile","$rootScope",function(t,n){var i,s=n.$new(!0);s.event=e,s.panelCtrl=r.panelCtrl,s.close=function(){i.close()},t(a)(s),s.$digest(),(i=new Qe.a({target:hn[0],content:a,position:"bottom center",classes:"drop-popover drop-popover--form",openOn:"click",tetherOptions:{constraints:[{to:"window",pin:!0,attachment:"both"}]}})).open(),r.editorOpened(),i.on("close",function(){setTimeout(function(){r.editorClosed(),s.$destroy(),i.destroy()})})}])},100))}var dn=function(){function t(t,e,a,r,n,i,s,o){this._object=t,this._drawFunc=e,this._clearFunc=a,this._moveFunc=r,this._position={left:n,top:i},this._width=s,this._height=o}return t.$inject=["object","drawFunc","clearFunc","moveFunc","left","top","width","height"],t.prototype.width=function(){return this._width},t.prototype.height=function(){return this._height},t.prototype.position=function(){return this._position},t.prototype.draw=function(){this._drawFunc(this._object)},t.prototype.clear=function(){this._clearFunc(this._object)},t.prototype.getObject=function(){return this._object},t.prototype.moveTo=function(t){this._position=t,this._moveFunc(this._object,this._position)},t}(),mn=function(){function t(t,e){this._options=t,this._drawableEvent=e,this._hidden=!1}return t.$inject=["options","drawableEvent"],t.prototype.visual=function(){return this._drawableEvent},t.prototype.getOptions=function(){return this._options},t.prototype.getParent=function(){return this._parent},t.prototype.isHidden=function(){return this._hidden},t.prototype.hide=function(){this._hidden=!0},t.prototype.unhide=function(){this._hidden=!1},t}(),fn=function(){function t(t){this._events=[],this._types=[],this._plot=t,this.eventsEnabled=!1}return t.$inject=["plot"],t.prototype.getEvents=function(){return this._events},t.prototype.setTypes=function(t){return this._types=t},t.prototype.setupEvents=function(t){var e=this,a=A.a.partition(t,"isRegion"),r=a[0];t=a[1],F.a.each(t,function(t,a){var r=new mn(a,e._buildDiv(a));e._events.push(r)}),F.a.each(r,function(t,a){var r=new mn(a,e._buildRegDiv(a));e._events.push(r)}),this._events.sort(function(t,e){var a=t.getOptions(),r=e.getOptions();return a.min>r.min?1:a.min<r.min?-1:0})},t.prototype.drawEvents=function(){var t=this;F.a.each(this._events,function(e,a){t._insidePlot(a.getOptions().min)&&!a.isHidden()?a.visual().draw():a.visual().getObject().hide()})},t.prototype.updateEvents=function(){var t,e,a=this,r=this._plot.getPlotOffset(),n=this._plot.getXAxes()[this._plot.getOptions().events.xaxis-1];F.a.each(this._events,function(i,s){e=r.top+a._plot.height()-s.visual().height(),t=n.p2c(s.getOptions().min)+r.left-s.visual().width()/2,s.visual().moveTo({top:e,left:t})})},t.prototype._clearEvents=function(){F.a.each(this._events,function(t,e){e.visual().clear()}),this._events=[]},t.prototype._buildDiv=function(t){var e,a,r,n,i,s,o,l,u=this,c=this._plot.getPlaceholder(),h=this._plot.getPlotOffset(),p=this._plot.getXAxes()[this._plot.getOptions().events.xaxis-1],d=t.eventType;r=null!==this._types&&this._types[d]&&this._types[d].color?this._types[d].color:"#666",n=null!==this._types&&this._types[d]&&this._types[d].markerSize?this._types[d].markerSize:8,i=null===this._types||!this._types[d]||void 0===this._types[d].markerShow||this._types[d].markerShow,l=null===this._types||!this._types[d]||void 0===this._types[d].markerTooltip||this._types[d].markerTooltip,s=null!=this._types&&this._types[d]&&this._types[d].lineStyle?this._types[d].lineStyle.toLowerCase():"dashed",o=null!=this._types&&this._types[d]&&void 0!==this._types[d].lineWidth?this._types[d].lineWidth:1;var m=p.options.eventSectionHeight||0;m/=3,e=h.top+this._plot.height()+m,a=p.p2c(t.min)+h.left;var f=F()('<div class="events_line flot-temp-elem"></div>').css({position:"absolute",opacity:.8,left:a+"px",top:8,width:o+"px",height:this._plot.height()+.8*m,"border-left-width":o+"px","border-left-style":s,"border-left-color":r,color:r}).appendTo(c);if(i){var g=F()('<div class="events_marker"></div>').css({position:"absolute",left:-n-Math.round(o/2)+"px","font-size":0,"line-height":0,width:0,height:0,"border-left":n+"px solid transparent","border-right":n+"px solid transparent"});g.appendTo(f),this._types[d]&&this._types[d].position&&"BOTTOM"===this._types[d].position.toUpperCase()?g.css({top:e-n-8+"px","border-top":"none","border-bottom":n+"px solid "+r}):g.css({top:"0px","border-top":n+"px solid "+r,"border-bottom":"none"}),g.data({event:t});t.editModel&&pn(g,t.editModel,u._plot);l&&(g.css({cursor:"help"}),g.hover(function(){cn(g,F()(this).data("event"),u._plot)},function(){u._plot.clearSelection()}))}return new dn(f,function(t){t.show()},function(t){t.remove()},function(t,e){t.css({top:e.top,left:e.left})},a,e,f.width(),f.height())},t.prototype._buildRegDiv=function(t){var e,a,r,n,i,s,o,l=this,u=this,c=this._plot.getPlaceholder(),h=this._plot.getPlotOffset(),p=this._plot.getXAxes()[this._plot.getOptions().events.xaxis-1],d=t.eventType;s=null!==this._types&&this._types[d]&&this._types[d].color?this._types[d].color:"#666",o=null===this._types||!this._types[d]||void 0===this._types[d].markerTooltip||this._types[d].markerTooltip,r=null!=this._types&&this._types[d]&&void 0!==this._types[d].lineWidth?this._types[d].lineWidth:1,i=null!=this._types&&this._types[d]&&this._types[d].lineStyle?this._types[d].lineStyle.toLowerCase():"dashed";e=h.top+this._plot.height()+2;var m=Math.min(t.min,t.timeEnd),f=Math.max(t.min,t.timeEnd);a=p.p2c(m)+h.left;var g=p.p2c(f)+h.left;n=g-a,A.a.each([a,g],function(t){F()('<div class="events_line flot-temp-elem"></div>').css({position:"absolute",opacity:.8,left:t+"px",top:8,width:r+"px",height:l._plot.height()+2,"border-left-width":r+"px","border-left-style":i,"border-left-color":s,color:s}).appendTo(c)});var v=F()('<div class="events_marker region_marker flot-temp-elem"></div>').css({position:"absolute",opacity:.5,left:a+"px",top:e,width:Math.round(n+r)+"px",height:"0.5rem","border-left-color":s,color:s,"background-color":s});v.appendTo(c),v.data({event:t});t.editModel&&pn(v,t.editModel,u._plot);return o&&(v.css({cursor:"help"}),v.hover(function(){cn(v,F()(this).data("event"),u._plot)},function(){u._plot.clearSelection()})),new dn(v,function(t){t.show()},function(t){t.remove()},function(t,e){t.css({top:e.top,left:e.left})},a,e,v.width(),v.height())},t.prototype._insidePlot=function(t){var e=this._plot.getXAxes()[this._plot.getOptions().events.xaxis-1],a=e.p2c(t);return a>0&&a<e.p2c(e.max)},t}();function gn(t){var e=this,a=new fn(t);t.getEvents=function(){return a._events},t.hideEvents=function(){F.a.each(a._events,function(t,e){e.visual().getObject().hide()})},t.showEvents=function(){t.hideEvents(),F.a.each(a._events,function(t,e){e.hide()}),e.eventMarkers.drawEvents()},t.setEvents=function(t){a.eventsEnabled&&a.setupEvents(t)},t.hooks.processOptions.push(function(t,e){null!=e.events.data&&(a.eventsEnabled=!0)}),t.hooks.draw.push(function(t){var e=t.getOptions();a.eventsEnabled&&(a.getEvents().length<1?(a.setTypes(e.events.types),a.setupEvents(e.events.data)):a.updateEvents()),a.drawEvents()})}F.a.plot.plugins.push({init:gn,options:{events:{data:null,types:null,xaxis:1,position:"BOTTOM"}},name:"events",version:"0.2.5"});var vn=function(){function t(t){this.panelCtrl=t}return t.prototype.getHandleHtml=function(t,e,a){var r=e.colorMode;return"custom"===e.colorMode&&(r="critical"),'\n    <div class="alert-handle-wrapper alert-handle-wrapper--T'+t+'">\n      <div class="alert-handle-line alert-handle-line--'+r+'">\n      </div>\n      <div class="alert-handle" data-handle-index="'+t+'">\n        <i class="icon-gf icon-gf-'+r+" alert-state-"+r+'"></i>\n        <span class="alert-handle-value">'+a+'<i class="alert-handle-grip"></i></span>\n      </div>\n    </div>'},t.prototype.initDragging=function(t){var e,a=F()(t.currentTarget).parents(".alert-handle-wrapper"),r=F()(t.currentTarget).data("handleIndex"),n=null,i=this.plot,s=this.panelCtrl,o=this.thresholds[r];function l(t){if(null===n)n=t.clientY;else{var r=t.clientY-n;e+=r,n=t.clientY,a.css({top:e+r})}}function u(){var t=i.c2p({left:0,top:e}).y;t=parseInt(t.toFixed(0),10),o.value=t,a.off("mousemove",l),a.off("mouseup",l),a.off("mouseleave",l),s.$scope.$apply(function(){s.render(),s.events.emit("threshold-changed",{threshold:o,handleIndex:r})})}n=null,e=a.position().top,a.on("mousemove",l),a.on("mouseup",u),a.on("mouseleave",u)},t.prototype.cleanUp=function(){this.placeholder.find(".alert-handle-wrapper").remove(),this.needsCleanup=!1},t.prototype.renderHandle=function(t,e){var a=this.thresholds[t],r=a.value,n=r,i=0;if(A.a.isNumber(r)){var s=this.plot.p2c({x:0,y:r});i=Math.round(Math.min(Math.max(s.top,0),this.height)-6)}else n="",i=e;var o=F()(this.getHandleHtml(t,a,n));this.placeholder.append(o),o.toggleClass("alert-handle-wrapper--no-value",""===n),o.css({top:i})},t.prototype.shouldDrawHandles=function(){return!this.hasSecondYAxis&&this.panelCtrl.editingThresholds&&this.panelCtrl.panel.thresholds.length>0},t.prototype.prepare=function(t,e){this.hasSecondYAxis=!1;for(var a=0;a<e.length;a++)if(e[a].yaxis>1){this.hasSecondYAxis=!0;break}if(this.shouldDrawHandles()){var r=this.panelCtrl.panel.thresholds.length>1?"220px":"110px";t.css("margin-right",r)}else this.needsCleanup&&t.css("margin-right","0")},t.prototype.draw=function(t){this.thresholds=this.panelCtrl.panel.thresholds,this.plot=t,this.placeholder=t.getPlaceholder(),this.needsCleanup&&this.cleanUp(),this.shouldDrawHandles()&&(this.height=t.height(),this.thresholds.length>0&&this.renderHandle(0,10),this.thresholds.length>1&&this.renderHandle(1,this.height-30),this.placeholder.off("mousedown",".alert-handle"),this.placeholder.on("mousedown",".alert-handle",this.initDragging.bind(this)),this.needsCleanup=!0)},t.prototype.addFlotOptions=function(t,e){if(e.thresholds&&0!==e.thresholds.length){var a,r,n,i=1/0,s=-1/0;for(a=0;a<e.thresholds.length;a++)if(r=e.thresholds[a],A.a.isNumber(r.value)){var o=void 0;switch(r.op){case"gt":o=i,e.thresholds.length>a+1&&(n=e.thresholds[a+1]).value>r.value&&(s=o=n.value);break;case"lt":o=s,e.thresholds.length>a+1&&(n=e.thresholds[a+1]).value<r.value&&(i=o=n.value)}var l=void 0,u=void 0;switch(r.colorMode){case"critical":l="rgba(234, 112, 112, 0.12)",u="rgba(237, 46, 24, 0.60)";break;case"warning":l="rgba(235, 138, 14, 0.12)",u="rgba(247, 149, 32, 0.60)";break;case"ok":l="rgba(11, 237, 50, 0.090)",u="rgba(6,163,69, 0.60)";break;case"custom":l=r.fillColor,u=r.lineColor}r.fill&&("right"===r.yaxis&&this.hasSecondYAxis?t.grid.markings.push({y2axis:{from:r.value,to:o},color:l}):t.grid.markings.push({yaxis:{from:r.value,to:o},color:l})),r.line&&("right"===r.yaxis&&this.hasSecondYAxis?t.grid.markings.push({y2axis:{from:r.value,to:r.value},color:u}):t.grid.markings.push({yaxis:{from:r.value,to:r.value},color:u}))}}},t}();function yn(t,e,a,r,n){return t.map(function(t){var i=function(t){for(var e=[],a=0;a<t.length;a++)for(var r=t[a].datapoints,n=0;n<r.length;n++)null!==r[n][0]&&e.push(r[n][0]);return e}([t]);if(t.histogram=!0,a[t.alias])t.data=[];else{var s=function(t,e,a,r){for(var n={},i=bn(a,e),s=bn(r,e),o=i,l=0;o<=s;)n[o]=0,o=i+e*l,l++;for(var u=0;u<t.length;u++){var c=bn(t[u],e);n[c]=n[c]+1}var h=A.a.map(n,function(t,e){return[Number(e),t]});return A.a.sortBy(h,function(t){return t[0]})}(i,e,r,n);t.data=s}return t})}function bn(t,e){return Math.floor(t/e)*e}function Sn(t,e){if(!isNaN(e)&&function(t){return 2===t.length&&xn(t[0])&&xn(t[1])}(t)){var a=t[0],r=t[1];!function(t,e,a){0!==a&&(t.min-=a,t.max-=a,e.min-=a,e.max-=a)}(a,r,e),function(t,e){t.max===t.min&&(t.min-=.25,t.max+=.25);e.max===e.min&&(e.min-=.25,e.max+=.25)}(a,r);var n=0===a.min||0===r.min||0===a.max||0===r.max,i=wn(a,r);if(n&&i)a.min=a.max>0?0:a.min,a.max=a.max>0?a.max:0,r.min=r.max>0?0:r.min,r.max=r.max>0?r.max:0;else if(function(t,e){return t.min>=0&&e.max<=0||t.max<=0&&e.min>=0}(a,r))a.min>=0?(a.min=-a.max,r.max=-r.min):(a.max=-a.min,r.min=-r.max);else{var s=function(t,e){var a,r;if(kn(t,e))a=e.min?t.min/e.min:0,r=e.max?t.max/e.max:0;else if(wn(t,e)){var n=Math.abs(t.min),i=Math.abs(t.max),s=Math.abs(e.min),o=Math.abs(e.max),l=A.a.max([n,i]),u=A.a.min([n,i]),c=A.a.max([s,o]),h=A.a.min([s,o]);a=u?l/u:l,r=h?c/h:c}else t.min>0||e.min>0?(a=t.max/e.max,r=0):(a=0,r=t.min/e.min);return a>r?a:r}(a,r);i?a.min>0?(a.min=a.max/s,r.min=r.max/s):(a.max=a.min/s,r.max=r.min/s):kn(a,r)?(a.min=r.min?r.min*s:a.min,r.min=a.min?a.min/s:r.min,a.max=r.max?r.max*s:a.max,r.max=a.max?a.max/s:r.max):(a.min=a.min>0?r.min*s:a.min,r.min=r.min>0?a.min/s:r.min,a.max=a.max<0?r.max*s:a.max,r.max=r.max<0?a.max/s:r.max)}!function(t,e,a){0!==a&&(t.min+=a,t.max+=a,e.min+=a,e.max+=a)}(a,r,e)}}function xn(t){return"min"in t&&"max"in t}function wn(t,e){return t.min>=0&&e.min>=0||t.max<=0&&e.max<=0}function kn(t,e){return t.min<=0&&t.max>=0&&e.min<=0&&e.max>=0}var Cn=function(){function t(t,e,a){var r=this;this.scope=t,this.elem=e,this.timeSrv=a,this.ctrl=t.ctrl,this.dashboard=this.ctrl.dashboard,this.panel=this.ctrl.panel,this.annotations=[],this.panelWidth=0,this.eventManager=new W(this.ctrl),this.thresholdManager=new vn(this.ctrl),this.tooltip=new function(t,e,a,r){var n=this,i=a.ctrl.panel,s=F()('<div class="graph-tooltip">');this.destroy=function(){s.remove()},this.findHoverIndexFromDataPoints=function(t,e,a){var r,n=e.datapoints.pointsize,i=a*n,s=e.datapoints.points.length;for(r=i;r<s;r+=n)if(!e.lines.steps&&null!=e.datapoints.points[i]&&null==e.datapoints.points[r]||e.datapoints.points[r]>t)return Math.max(r-n,0)/n;return r/n-1},this.findHoverIndexFromData=function(t,e){for(var a,r=0,n=e.data.length-1;;){if(r>n)return Math.max(n,0);if(a=Math.floor((r+n)/2),e.data[a][0]===t)return a;e.data[a][0]<t?r=a+1:n=a-1}},this.renderAndShow=function(t,e,a,r){"time"===r&&(e='<div class="graph-tooltip-time">'+t+"</div>"+e),s.html(e).place_tt(a.pageX+20,a.pageY)},this.getMultiSeriesPlotHoverInfo=function(t,e){var a,r,n,s,o,l,u,c,h,p=[[],[],[]],d=0;for(r=0;r<t.length;r++)!(n=t[r]).data.length||i.legend.hideEmpty&&n.allIsNull?p[0].push({hidden:!0,value:0}):!n.data.length||i.legend.hideZero&&n.allIsZero?p[0].push({hidden:!0,value:0}):n.hideTooltip?p[0].push({hidden:!0,value:0}):(s=this.findHoverIndexFromData(e.x,n),o=e.x-n.data[s][0],l=n.data[s][0],(!c||o>=0&&(o<c||c<0)||o<0&&o>c)&&(c=o,h=l),a=n.stack?"individual"===i.tooltip.value_type?n.data[s][1]:n.stack?d+=n.data[s][1]:n.data[s][1]:n.data[s][1],(n.lines.steps||n.stack)&&(s=this.findHoverIndexFromDataPoints(e.x,n,s)),u=0,n.yaxis&&(u=n.yaxis.n),p[u].push({value:a,hoverIndex:s,color:n.color,label:n.aliasEscaped,time:l,distance:o,index:r}));return(p=p[0].concat(p[1],p[2])).time=h,p},t.mouseleave(function(){if(i.tooltip.shared){var e=t.data().plot;e&&(s.detach(),e.unhighlight())}j.b.emit("graph-hover-clear")}),t.bind("plothover",function(e,a,r){n.show(a,r),a.panelRelY=(a.pageY-t.offset().top)/t.height(),j.b.emit("graph-hover",{pos:a,panel:i})}),t.bind("plotclick",function(t,e,a){j.b.emit("graph-click",{pos:e,panel:i,item:a})}),this.clear=function(t){s.detach(),t.clearCrosshair(),t.unhighlight()},this.show=function(a,o){var l,u,c,h,p,d,m,f,g=t.data().plot,v=g.getData(),y=g.getXAxes()[0].options.mode,b=r(),S=i.tooltip.shared;if(a.panelRelY){var x=g.pointOffset({x:a.x});if(Number.isNaN(x.left)||x.left<0||x.left>t.width())return void n.clear(g);if(a.pageX=t.offset().left+x.left,a.pageY=t.offset().top+t.height()*a.panelRelY,!(a.pageY>=F()(window).scrollTop()&&a.pageY<=F()(window).innerHeight()+F()(window).scrollTop()))return void n.clear(g);if(g.setCrosshair(a),S=!0,e.sharedCrosshairModeOnly())return}if(0!==b.length)if(f=b[0].hasMsResolution?"YYYY-MM-DD HH:mm:ss.SSS":"YYYY-MM-DD HH:mm:ss",S){g.unhighlight();var w=n.getMultiSeriesPlotHoverInfo(v,a);for(m="",c=e.formatDate(w.time,f),2===i.tooltip.sort?w.sort(function(t,e){return e.value-t.value}):1===i.tooltip.sort&&w.sort(function(t,e){return t.value-e.value}),p=0;p<w.length;p++)if(!(h=w[p]).hidden){var k="";o&&h.index===o.seriesIndex&&(k="graph-tooltip-list-item--highlight"),u=(d=b[h.index]).formatValue(h.value),m+='<div class="graph-tooltip-list-item '+k+'"><div class="graph-tooltip-series-name">',m+='<i class="fa fa-minus" style="color:'+h.color+';"></i> '+h.label+":</div>",m+='<div class="graph-tooltip-value">'+u+"</div></div>",g.highlight(h.index,h.hoverIndex)}n.renderAndShow(c,m,a,y)}else o?(d=b[o.seriesIndex],l='<div class="graph-tooltip-list-item"><div class="graph-tooltip-series-name">',l+='<i class="fa fa-minus" style="color:'+o.series.color+';"></i> '+d.aliasEscaped+":</div>",u=i.stack&&"individual"===i.tooltip.value_type?o.datapoint[1]-o.datapoint[2]:o.datapoint[1],u=d.formatValue(u),c=e.formatDate(o.datapoint[0],f),l+='<div class="graph-tooltip-value">'+u+"</div>",n.renderAndShow(c,l,a,y)):s.detach()}}(this.elem,this.ctrl.dashboard,this.scope,function(){return r.sortedSeries}),this.ctrl.events.on("panel-teardown",this.onPanelteardown.bind(this)),this.ctrl.events.on("render",this.onRender.bind(this)),this.ctrl.events.on("legend-rendering-complete",this.onLegendRenderingComplete.bind(this)),j.b.on("graph-hover",this.onGraphHover.bind(this),t),j.b.on("graph-hover-clear",this.onGraphHoverClear.bind(this),t),this.elem.bind("plotselected",this.onPlotSelected.bind(this)),this.elem.bind("plotclick",this.onPlotClick.bind(this)),t.$on("$destroy",this.onScopeDestroy.bind(this))}return t.prototype.onRender=function(t){if(this.data=t||this.data,this.data){this.annotations=this.ctrl.annotations||[],this.buildFlotPairs(this.data);var e=this.elem.height();Object(j.g)(this.data,this.panel,e),this.ctrl.events.emit("render-legend")}},t.prototype.onGraphHover=function(t){this.dashboard.sharedTooltipModeEnabled()&&this.plot&&t.panel.id!==this.panel.id&&!this.ctrl.otherPanelInFullscreenMode()&&this.tooltip.show(t.pos)},t.prototype.onPanelteardown=function(){this.thresholdManager=null,this.plot&&(this.plot.destroy(),this.plot=null)},t.prototype.onLegendRenderingComplete=function(){this.render_panel()},t.prototype.onGraphHoverClear=function(t,e){this.plot&&this.tooltip.clear(this.plot)},t.prototype.onPlotSelected=function(t,e){var a=this;"time"===this.panel.xaxis.mode?(e.ctrlKey||e.metaKey)&&(this.dashboard.meta.canEdit||this.dashboard.meta.canMakeEditable)?setTimeout(function(){a.eventManager.updateTime(e.xaxis)},100):this.scope.$apply(function(){a.timeSrv.setTime({from:L.a.utc(e.xaxis.from),to:L.a.utc(e.xaxis.to)})}):this.plot.clearSelection()},t.prototype.onPlotClick=function(t,e,a){var r=this;"time"===this.panel.xaxis.mode&&((e.ctrlKey||e.metaKey)&&(this.dashboard.meta.canEdit||this.dashboard.meta.canMakeEditable)&&(e.x!==e.x1||setTimeout(function(){r.eventManager.updateTime({from:e.x,to:null})},100)))},t.prototype.onScopeDestroy=function(){this.tooltip.destroy(),this.elem.off(),this.elem.remove()},t.prototype.shouldAbortRender=function(){return!this.data||0===this.panelWidth},t.prototype.drawHook=function(t){this.panel.yaxes[0].label&&this.panel.yaxes[0].show&&F()("<div class='axisLabel left-yaxis-label flot-temp-elem'></div>").text(this.panel.yaxes[0].label).appendTo(this.elem),this.panel.yaxes[1].label&&this.panel.yaxes[1].show&&F()("<div class='axisLabel right-yaxis-label flot-temp-elem'></div>").text(this.panel.yaxes[1].label).appendTo(this.elem),this.ctrl.dataWarning&&F()('<div class="datapoints-warning flot-temp-elem">'+this.ctrl.dataWarning.title+"</div>").appendTo(this.elem),this.thresholdManager.draw(t)},t.prototype.processOffsetHook=function(t,e){var a=this.panel.yaxes[0],r=this.panel.yaxes[1];a.show&&a.label&&(e.left=20),r.show&&r.label&&(e.right=20);for(var n=t.getYAxes(),i=0;i<n.length;i++){var s=n[i],o=this.panel.yaxes[i];s.options.max=null!==s.options.max?s.options.max:o.max,s.options.min=null!==s.options.min?s.options.min:o.min}},t.prototype.processRangeHook=function(t){var e=t.getYAxes(),a=this.panel.yaxis.align||!1;if(e.length>1&&!0===a){var r=this.panel.yaxis.alignLevel||0;Sn(e,parseFloat(r))}},t.prototype.getMinTimeStepOfSeries=function(t){for(var e=Number.MAX_VALUE,a=0;a<t.length;a++)if(t[a].stats.timeStep){if(this.panel.bars){if(t[a].bars&&!1===t[a].bars.show)continue}else if(void 0===t[a].bars||void 0===t[a].bars.show||!t[a].bars.show)continue;t[a].stats.timeStep<e&&(e=t[a].stats.timeStep)}return e},t.prototype.render_panel=function(){if(this.panelWidth=this.elem.width(),!this.shouldAbortRender()){this.thresholdManager.prepare(this.elem,this.data),this.panel.dashes=!!this.panel.lines&&this.panel.dashes;var t=this.buildFlotOptions(this.panel);this.prepareXAxis(t,this.panel),this.configureYAxisOptions(this.data,t),this.thresholdManager.addFlotOptions(t,this.panel),this.eventManager.addFlotEvents(this.annotations,t),this.sortedSeries=this.sortSeries(this.data,this.panel),this.callPlot(t,!0)}},t.prototype.buildFlotPairs=function(t){for(var e=0;e<t.length;e++){var a=t[e];a.data=a.getFlotPairs(a.nullPointMode||this.panel.nullPointMode),this.ctrl.hiddenSeries[a.alias]&&(a.data=[],a.stack=!1)}},t.prototype.prepareXAxis=function(t,e){switch(e.xaxis.mode){case"series":t.series.bars.barWidth=.7,t.series.bars.align="center";for(var a=0;a<this.data.length;a++){var r=this.data[a];r.data=[[a+1,r.stats[e.xaxis.values[0]]]]}this.addXSeriesAxis(t);break;case"histogram":var n=void 0;if(this.data.length){var i=A.a.min(A.a.map(this.data,function(t){return t.stats.min})),s=A.a.max(A.a.map(this.data,function(t){return t.stats.max})),o=e.xaxis.buckets||this.panelWidth/50;n=Object($e.tickStep)(i,s,o),t.series.bars.barWidth=.8*n,this.data=yn(this.data,n,this.ctrl.hiddenSeries,i,s)}else n=0;this.addXHistogramAxis(t,n);break;case"table":t.series.bars.barWidth=.7,t.series.bars.align="center",this.addXTableAxis(t);break;default:t.series.bars.barWidth=this.getMinTimeStepOfSeries(this.data)/1.5,this.addTimeAxis(t)}},t.prototype.callPlot=function(t,e){try{this.plot=F.a.plot(this.elem,this.sortedSeries,t),this.ctrl.renderError&&(delete this.ctrl.error,delete this.ctrl.inspector)}catch(t){console.log("flotcharts error",t),this.ctrl.error=t.message||"Render Error",this.ctrl.renderError=!0,this.ctrl.inspector={error:t}}e&&this.ctrl.renderingCompleted()},t.prototype.buildFlotOptions=function(t){var e="#c8c8c8";!0===kt.a.bootData.user.lightTheme&&(e="#a1a1a1");var a=!!t.stack||null;return{hooks:{draw:[this.drawHook.bind(this)],processOffset:[this.processOffsetHook.bind(this)],processRange:[this.processRangeHook.bind(this)]},legend:{show:!1},series:{stackpercent:!!t.stack&&t.percentage,stack:t.percentage?null:a,lines:{show:t.lines,zero:!1,fill:this.translateFillOption(t.fill),lineWidth:t.dashes?0:t.linewidth,steps:t.steppedLine},dashes:{show:t.dashes,lineWidth:t.linewidth,dashLength:[t.dashLength,t.spaceLength]},bars:{show:t.bars,fill:1,barWidth:1,zero:!1,lineWidth:0},points:{show:t.points,fill:1,fillColor:!1,radius:t.points?t.pointradius:2},shadowSize:0},yaxes:[],xaxis:{},grid:{minBorderMargin:0,markings:[],backgroundColor:null,borderWidth:0,hoverable:!0,clickable:!0,color:e,margin:{left:0,right:0},labelMarginX:0},selection:{mode:"x",color:"#666"},crosshair:{mode:"x"}}},t.prototype.sortSeries=function(t,e){var a=e.legend.sort,r=e.legend.sortDesc,n=null!==a&&void 0!==a,i=null!==r&&void 0!==r,s=e.stack&&n&&i,o=!0===e.legend.sortDesc?-1:1;return s?A.a.sortBy(t,function(t){return t.stats[a]*o}):A.a.sortBy(t,function(t){return t.zindex})},t.prototype.translateFillOption=function(t){return this.panel.percentage&&this.panel.stack&&0===t?.001:t/10},t.prototype.addTimeAxis=function(t){var e=this.panelWidth/100,a=A.a.isUndefined(this.ctrl.range.from)?null:this.ctrl.range.from.valueOf(),r=A.a.isUndefined(this.ctrl.range.to)?null:this.ctrl.range.to.valueOf();t.xaxis={timezone:this.dashboard.getTimezone(),show:this.panel.xaxis.show,mode:"time",min:a,max:r,label:"Datetime",ticks:e,timeformat:this.time_format(e,a,r)}},t.prototype.addXSeriesAxis=function(t){var e=A.a.map(this.data,function(t,e){return[e+1,t.alias]});t.xaxis={timezone:this.dashboard.getTimezone(),show:this.panel.xaxis.show,mode:null,min:0,max:e.length+1,label:"Datetime",ticks:e}},t.prototype.addXHistogramAxis=function(t,e){var a,r,n,i=this.panelWidth/50;if(this.data.length&&e){for(var s=[],o=0,l=this.data;o<l.length;o++)for(var u=0,c=l[o].data;u<c.length;u++){s[c[u][0]]=!0}a=Object.keys(s).map(function(t){return Number(t)}),r=A.a.min(a),n=A.a.max(a);for(var h=e,p=Math.floor((n-r)/h);p>i;)h*=2,p=Math.ceil((n-r)/h);r=Math.floor(r/h)*h,n=Math.ceil(1.01*n/h)*h,a=[];for(var d=r;d<=n;d+=h)a.push(d)}else a=i/2,r=0,n=1;t.xaxis={timezone:this.dashboard.getTimezone(),show:this.panel.xaxis.show,mode:null,min:r,max:n,label:"Histogram",ticks:a},this.configureAxisMode(t.xaxis,"short")},t.prototype.addXTableAxis=function(t){var e=A.a.map(this.data,function(t,e){return A.a.map(t.datapoints,function(a,r){return[e*t.datapoints.length+r+1,a[1]]})});e=A.a.flatten(e,!0),t.xaxis={timezone:this.dashboard.getTimezone(),show:this.panel.xaxis.show,mode:null,min:0,max:e.length+1,label:"Datetime",ticks:e}},t.prototype.configureYAxisOptions=function(t,e){var a={position:"left",show:this.panel.yaxes[0].show,index:1,logBase:this.panel.yaxes[0].logBase||1,min:this.parseNumber(this.panel.yaxes[0].min),max:this.parseNumber(this.panel.yaxes[0].max),tickDecimals:this.panel.yaxes[0].decimals};if(e.yaxes.push(a),A.a.find(t,{yaxis:2})){var r=A.a.clone(a);r.index=2,r.show=this.panel.yaxes[1].show,r.logBase=this.panel.yaxes[1].logBase||1,r.position="right",r.min=this.parseNumber(this.panel.yaxes[1].min),r.max=this.parseNumber(this.panel.yaxes[1].max),r.tickDecimals=this.panel.yaxes[1].decimals,e.yaxes.push(r),this.applyLogScale(e.yaxes[1],t),this.configureAxisMode(e.yaxes[1],this.panel.percentage&&this.panel.stack?"percent":this.panel.yaxes[1].format)}this.applyLogScale(e.yaxes[0],t),this.configureAxisMode(e.yaxes[0],this.panel.percentage&&this.panel.stack?"percent":this.panel.yaxes[0].format)},t.prototype.parseNumber=function(t){return null===t||void 0===t?null:A.a.toNumber(t)},t.prototype.applyLogScale=function(t,e){if(1!==t.logBase){var a,r,n=0===t.min;t.min<Number.MIN_VALUE&&(t.min=null),t.max<Number.MIN_VALUE&&(t.max=null);var i=t.max,s=t.min;for(r=0;r<e.length;r++)(a=e[r]).yaxis===t.index&&((!i||i<a.stats.max)&&(i=a.stats.max),(!s||s>a.stats.logmin)&&(s=a.stats.logmin));t.transform=function(e){return e<Number.MIN_VALUE?null:Math.log(e)/Math.log(t.logBase)},t.inverseTransform=function(e){return Math.pow(t.logBase,e)},i||s?i?s||(s=i*t.inverseTransform(-4)):i=s*t.inverseTransform(4):(i=t.inverseTransform(2),s=t.inverseTransform(-2)),s=t.min?t.inverseTransform(Math.ceil(t.transform(t.min))):t.min=t.inverseTransform(Math.floor(t.transform(s))),i=t.max?t.inverseTransform(Math.floor(t.transform(t.max))):t.max=t.inverseTransform(Math.ceil(t.transform(i))),!s||s<Number.MIN_VALUE||!i||i<Number.MIN_VALUE||(Number.isFinite(s)&&Number.isFinite(i)?(n&&(t.min=.1,s=1),t.ticks=this.generateTicksForLogScaleYAxis(s,i,t.logBase),n&&t.ticks.unshift(.1),t.ticks[t.ticks.length-1]>t.max&&(t.max=t.ticks[t.ticks.length-1])):(t.ticks=[1,2],delete t.min,delete t.max))}},t.prototype.generateTicksForLogScaleYAxis=function(t,e,a){var r,n=[];for(r=t;r<=e;r*=a)n.push(r);var i=Math.ceil(this.ctrl.height/25),s=n.length;if(s>i){var o=Math.ceil(s/i)*a;for(n=[],r=t;r<=e*o;r*=o)n.push(r)}return n},t.prototype.configureAxisMode=function(t,e){t.tickFormatter=function(t,a){if(!J.a.valueFormats[e])throw new Error("Unit '"+e+"' is not supported");return J.a.valueFormats[e](t,a.tickDecimals,a.scaledDecimals)}},t.prototype.time_format=function(t,e,a){if(e&&a&&t){var r=a-e,n=r/t/1e3;return n<=45?"%H:%M:%S":n<=7200||r<=864e5?"%H:%M":n<=8e4?"%m/%d %H:%M":n<=2419200||r<=31536e6?"%m/%d":"%Y-%m"}return"%H:%M"},t}();function Tn(t,e,a){return{restrict:"A",template:"",link:function(e,a){return new Cn(e,a,t)}}}j.d.directive("grafanaGraph",Tn);var _n=a(275),Mn=a.n(_n);function $n(t,e,a){t.overrideMenu=[],t.currentOverrides=[],t.override=t.override||{},t.addOverrideOption=function(e,a,r){var n={text:e,propertyName:a,index:t.overrideMenu.lenght,values:r,submenu:A.a.map(r,function(t){return{text:String(t),value:t}})};t.overrideMenu.push(n)},t.setOverride=function(e,a){"color"!==e.propertyName?(t.override[e.propertyName]=a.value,"fillBelowTo"===e.propertyName&&(t.override.lines=!1,t.ctrl.addSeriesOverride({alias:a.value,lines:!1})),t.updateCurrentOverrides(),t.ctrl.render()):t.openColorSelector(t.override.color)},t.colorSelected=function(e){t.override.color=e,t.updateCurrentOverrides(),t.ctrl.render()},t.openColorSelector=function(r){var n={color:r};a.show({element:e.find(".dropdown")[0],position:"top center",openOn:"click",template:'<series-color-picker series="series" onColorChange="colorSelected" />',model:{autoClose:!0,colorSelected:t.colorSelected,series:n},onClose:function(){t.ctrl.render()}})},t.removeOverride=function(e){delete t.override[e.propertyName],t.updateCurrentOverrides(),t.ctrl.refresh()},t.getSeriesNames=function(){return A.a.map(t.ctrl.seriesList,function(t){return t.alias})},t.updateCurrentOverrides=function(){t.currentOverrides=[],A.a.each(t.overrideMenu,function(e){var a=t.override[e.propertyName];A.a.isUndefined(a)||t.currentOverrides.push({name:e.text,propertyName:e.propertyName,value:String(a)})})},t.addOverrideOption("条状","bars",[!0,!1]),t.addOverrideOption("线条","lines",[!0,!1]),t.addOverrideOption("填充线条","fill",[0,1,2,3,4,5,6,7,8,9,10]),t.addOverrideOption("线条宽度","linewidth",[0,1,2,3,4,5,6,7,8,9,10]),t.addOverrideOption("空点模式","nullPointMode",["connected","null","null as zero"]),t.addOverrideOption("填满以下","fillBelowTo",t.getSeriesNames()),t.addOverrideOption("楼梯线","steppedLine",[!0,!1]),t.addOverrideOption("虚线","dashes",[!0,!1]),t.addOverrideOption("虚线长度","dashLength",[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]),t.addOverrideOption("虚线空间","spaceLength",[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]),t.addOverrideOption("点状","points",[!0,!1]),t.addOverrideOption("点半径","pointradius",[1,2,3,4,5]),t.addOverrideOption("栈式","stack",[!0,!1,"A","B","C","D"]),t.addOverrideOption("颜色","color",["change"]),t.addOverrideOption("Y-轴","yaxis",[1,2]),t.addOverrideOption("Z-索引","zindex",[-3,-2,-1,0,1,2,3]),t.addOverrideOption("转换","transform",["negative-Y"]),t.addOverrideOption("图例","legend",[!0,!1]),t.addOverrideOption("提示文本框中隐藏","hideTooltip",[!0,!1]),t.updateCurrentOverrides()}P.a.module("grafana.directives").directive("graphLegend",["popoverSrv","$timeout",function(t,e){return{link:function(a,r){var n,i,s,o,l=!0,u=a.ctrl,c=u.panel,h=10,p=r.parent();function d(t){return t.parents("[data-series-index]").data("series-index")}function m(a){if(!F()(a.target).parents(".popover").length){var r=F()(a.currentTarget).find(".fa-minus"),n=d(r),s=i[n];e(function(){t.show({element:r[0],position:"bottom left",targetAttachment:"top left",template:'<series-color-picker series="series" onToggleAxis="toggleAxis" onColorChange="colorSelected"></series-color-picker>',openOn:"hover",model:{series:s,toggleAxis:function(){u.toggleAxis(s)},colorSelected:function(t){u.changeSeriesColor(s,t)}}})})}}function f(t){var e=d(F()(t.currentTarget)),a=i[e],r=o.scroller.scrollTop;u.toggleSeries(a,t),o.scroller.scrollTop=r}function g(t){var e=F()(t.currentTarget).data("stat");if(e!==c.legend.sort&&(c.legend.sortDesc=null),!1===c.legend.sortDesc)return c.legend.sort=null,c.legend.sortDesc=null,void u.render();c.legend.sortDesc=!c.legend.sortDesc,c.legend.sort=e,u.render()}function v(t){if(!c.legend[t])return"";var e='<th class="pointer" data-stat="'+t+'">'+t;c.legend.sort===t&&(e+=' <span class="'+(c.legend.sortDesc?"fa fa-caret-down":"fa fa-caret-up")+'"></span>');return e+"</th>"}function y(t){var e=r.width(),a=function(){var t=[];for(s=0;s<i.length;s++){var e=i[s];if(!e.hideFromLegend(c.legend)){var a='<div class="graph-legend-series';if(2===e.yaxis&&(a+=" graph-legend-series--right-y"),u.hiddenSeries[e.alias]&&(a+=" graph-legend-series-hidden"),a+='" data-series-index="'+s+'">',a+='<div class="graph-legend-icon">',a+='<i class="fa fa-minus pointer" style="color:'+e.color+'"></i>',a+="</div>",a+='<a class="graph-legend-alias pointer" title="'+e.aliasEscaped+'">'+e.aliasEscaped+"</a>",c.legend.values){var r=e.formatValue(e.stats.avg),n=e.formatValue(e.stats.current),o=e.formatValue(e.stats.min),l=e.formatValue(e.stats.max),h=e.formatValue(e.stats.total);c.legend.min&&(a+='<div class="graph-legend-value min">'+o+"</div>"),c.legend.max&&(a+='<div class="graph-legend-value max">'+l+"</div>"),c.legend.avg&&(a+='<div class="graph-legend-value avg">'+r+"</div>"),c.legend.current&&(a+='<div class="graph-legend-value current">'+n+"</div>"),c.legend.total&&(a+='<div class="graph-legend-value total">'+h+"</div>")}a+="</div>",t.push(F()(a))}}return t}();if(c.legend.alignAsTable){var n=F()("<tbody></tbody>");n.append(t),n.append(a),r.append(n),n.wrap('<div class="graph-legend-scroll"></div>')}else r.append('<div class="graph-legend-scroll"></div>'),r.find(".graph-legend-scroll").append(a);!c.legend.rightSide||c.legend.rightSide&&e!==h?function(){var t=r,e=r.find(".graph-legend-scroll");t.find(".baron__track").remove(),t.addClass("baron baron__root"),F()('\n          <div class="baron__track">\n            <div class="baron__bar"></div>\n          </div>\n        ').appendTo(t),e.addClass("baron__scroller");var a={root:t[0],scroller:e[0],bar:".baron__bar",track:".baron__track",barOnCls:"_scrollbar",scrollingCls:"_scrolling"};o?(b(),o=Mn()(a)):o=Mn()(a);e[0].style.marginRight="-"+(e[0].offsetWidth-e[0].clientWidth)+"px",o.scroll()}():b()}function b(){o&&(o.dispose(),o=void 0)}a.$on("$destroy",function(){b()}),u.events.on("render-legend",function(){(n=u.seriesList)&&function(){var t=p.width();if(!u.panel.legend.show)return r.empty(),void(l=!0);l&&(r.on("click",".graph-legend-icon",m),r.on("click",".graph-legend-alias",f),r.on("click","th",g),l=!1);i=n,r.empty();var e,a=c.legend.rightSide&&c.legend.sideWidth?c.legend.sideWidth+"px":"",s=c.legend.rightSide&&c.legend.sideWidth?c.legend.sideWidth-1+"px":"";if(p.css("min-width",a),p.css("width",s),r.toggleClass("graph-legend-table",!0===c.legend.alignAsTable),c.legend.alignAsTable){var o="<tr>";o+='<th colspan="2" style="text-align:left"></th>',c.legend.values&&(o+=v("min"),o+=v("max"),o+=v("avg"),o+=v("current"),o+=v("total")),o+="</tr>",e=F()(o)}c.legend.sort&&(i=A.a.sortBy(i,function(t){var e=t.stats[c.legend.sort];return null===e&&(e=-1/0),e}),c.legend.sortDesc&&(i=i.reverse()));(!c.legend.rightSide||c.legend.rightSide&&t!==h)&&(y(e),r.empty());y(e)}(),u.events.emit("legend-rendering-complete")})}}}]),P.a.module("grafana.controllers").controller("SeriesOverridesCtrl",$n);var Pn=function(){function t(t){var e=this;this.panel=this.panelCtrl.panel,this.panel.alert&&(this.disabled=!0);var a=t.$on("$destroy",function(){e.panelCtrl.editingThresholds=!1,e.panelCtrl.render(),a()});this.panelCtrl.editingThresholds=!0}return t.$inject=["$scope"],t.prototype.addThreshold=function(){this.panel.thresholds.push({value:void 0,colorMode:"critical",op:"gt",fill:!0,line:!0,yaxis:"left"}),this.panelCtrl.render()},t.prototype.removeThreshold=function(t){this.panel.thresholds.splice(t,1),this.panelCtrl.render()},t.prototype.render=function(){this.panelCtrl.render()},t.prototype.onFillColorChange=function(t){var e=this;return function(a){e.panel.thresholds[t].fillColor=a,e.render()}},t.prototype.onLineColorChange=function(t){var e=this;return function(a){e.panel.thresholds[t].lineColor=a,e.render()}},t}();I.a.directive("graphThresholdForm",function(){return{restrict:"E",template:'\n<div class="gf-form-group">\n  <h5>阈值</h5>\n  <p class="muted" ng-show="ctrl.disabled">\n    <strong>已禁用</strong>查看阈值选项\n    查看告警选项卡更新阈值。 <br>\n    要重新启用阈值，必须从该面板中删除告警规则。\n  </p>\n  <div ng-class="{\'thresholds-form-disabled\': ctrl.disabled}">\n    <div class="gf-form-inline" ng-repeat="threshold in ctrl.panel.thresholds">\n      <div class="gf-form">\n        <label class="gf-form-label">T{{$index+1}}</label>\n      </div>\n\n      <div class="gf-form">\n        <div class="gf-form-select-wrapper">\n          <select class="gf-form-input" ng-model="threshold.op"\n                  ng-options="f for f in [\'gt\', \'lt\']" ng-change="ctrl.render()" ng-disabled="ctrl.disabled"></select>\n        </div>\n        <input type="number" ng-model="threshold.value" class="gf-form-input width-8"\n               ng-change="ctrl.render()" placeholder="值" ng-disabled="ctrl.disabled">\n      </div>\n\n      <div class="gf-form">\n        <label class="gf-form-label">颜色</label>\n        <div class="gf-form-select-wrapper">\n          <select class="gf-form-input" ng-model="threshold.colorMode"\n                  ng-options="f for f in [\'custom\', \'critical\', \'warning\', \'ok\']" ng-change="ctrl.render()" ng-disabled="ctrl.disabled">\n          </select>\n        </div>\n      </div>\n\n      <gf-form-switch class="gf-form" label="Fill" checked="threshold.fill"\n                      on-change="ctrl.render()" ng-disabled="ctrl.disabled"></gf-form-switch>\n\n      <div class="gf-form" ng-if="threshold.fill && threshold.colorMode === \'custom\'">\n        <label class="gf-form-label">填充颜色</label>\n        <span class="gf-form-label">\n          <color-picker color="threshold.fillColor" onChange="ctrl.onFillColorChange($index)"></color-picker>\n        </span>\n      </div>\n\n      <gf-form-switch class="gf-form" label="线段" checked="threshold.line"\n                      on-change="ctrl.render()" ng-disabled="ctrl.disabled"></gf-form-switch>\n\n      <div class="gf-form" ng-if="threshold.line && threshold.colorMode === \'custom\'">\n        <label class="gf-form-label">线段颜色</label>\n        <span class="gf-form-label">\n          <color-picker color="threshold.lineColor" onChange="ctrl.onLineColorChange($index)"></color-picker>\n        </span>\n      </div>\n\n      <div class="gf-form">\n        <label class="gf-form-label">Y-轴</label>\n        <div class="gf-form-select-wrapper">\n          <select class="gf-form-input" ng-model="threshold.yaxis"\n                  ng-init="threshold.yaxis = threshold.yaxis === \'left\' || threshold.yaxis === \'right\' ? threshold.yaxis : \'left\'"\n                  ng-options="f for f in [\'left\', \'right\']" ng-change="ctrl.render()" ng-disabled="ctrl.disabled">\n          </select>\n        </div>\n      </div>\n\n      <div class="gf-form">\n        <label class="gf-form-label">\n          <a class="pointer" ng-click="ctrl.removeThreshold($index)" ng-disabled="ctrl.disabled">\n            <i class="fa fa-trash"></i>\n          </a>\n        </label>\n      </div>\n    </div>\n\n    <div class="gf-form-button-row">\n      <button class="btn btn-inverse" ng-click="ctrl.addThreshold()" ng-disabled="ctrl.disabled">\n        <i class="fa fa-plus"></i>&nbsp;Add Threshold\n      </button>\n    </div>\n  </div>\n</div>\n',controller:Pn,bindToController:!0,controllerAs:"ctrl",scope:{panelCtrl:"="}}});var En=function(){function t(t){this.panel=t}return t.prototype.getSeriesList=function(t){var e,a=this;if(!t.dataList||0===t.dataList.length)return[];if(t.dataList&&t.dataList.length>0){e=t.dataList[0];var r=this.getAutoDetectXAxisMode(e);this.panel.xaxis.mode!==r&&(this.panel.xaxis.mode=r,this.setPanelDefaultsForNewXAxisMode())}switch(this.panel.xaxis.mode){case"series":case"time":return t.dataList.map(function(e,r){return a.timeSeriesHandler(e,r,t)});case"histogram":return(this.panel.stack?t.dataList:[{target:"count",datapoints:A.a.concat([],A.a.flatten(A.a.map(t.dataList,"datapoints")))}]).map(function(e,r){return a.timeSeriesHandler(e,r,t)});case"field":return this.customHandler(e)}},t.prototype.getAutoDetectXAxisMode=function(t){switch(t.type){case"docs":case"table":return"field";default:return"series"===this.panel.xaxis.mode?"series":"histogram"===this.panel.xaxis.mode?"histogram":"time"}},t.prototype.setPanelDefaultsForNewXAxisMode=function(){switch(this.panel.xaxis.mode){case"time":this.panel.bars=!1,this.panel.lines=!0,this.panel.points=!1,this.panel.legend.show=!0,this.panel.tooltip.shared=!0,this.panel.xaxis.values=[];break;case"series":this.panel.bars=!0,this.panel.lines=!1,this.panel.points=!1,this.panel.stack=!1,this.panel.legend.show=!1,this.panel.tooltip.shared=!1,this.panel.xaxis.values=["total"];break;case"histogram":this.panel.bars=!0,this.panel.lines=!1,this.panel.points=!1,this.panel.stack=!1,this.panel.legend.show=!1,this.panel.tooltip.shared=!1}},t.prototype.timeSeriesHandler=function(t,e,a){var r=t.datapoints||[],n=t.target,i=e%Y.f.length,s=this.panel.aliasColors[n]||Y.f[i],o=new ne.a({datapoints:r,alias:n,color:s,unit:t.unit});r&&r.length>0&&(r[r.length-1][1]-a.range.from<-1e4&&(o.isOutsideRange=!0));return o},t.prototype.customHandler=function(t){if(!this.panel.xaxis.name)throw{message:"No field name specified to use for x-axis, check your axes settings"};return[]},t.prototype.validateXAxisSeriesValue=function(){switch(this.panel.xaxis.mode){case"series":if(0===this.panel.xaxis.values.length)return void(this.panel.xaxis.values=["total"]);var t=this.getXAxisValueOptions({});return void(A.a.find(t,{value:this.panel.xaxis.values[0]})||(this.panel.xaxis.values=["total"]))}},t.prototype.getDataFieldNames=function(t,e){if(0===t.length)return[];var a=[],r=t[0],n=[];if("docs"===r.type){if(0===r.datapoints.length)return[];!function t(r){A.a.forEach(r,function(r,i){if(A.a.isObject(r))n.push(i),t(r);else if(!e||A.a.isNumber(r)){var s=n.concat(i).join(".");a.push(s)}}),n.pop()}(r.datapoints[0])}return a},t.prototype.getXAxisValueOptions=function(t){switch(this.panel.xaxis.mode){case"series":return[{text:"Avg",value:"avg"},{text:"Min",value:"min"},{text:"Max",value:"max"},{text:"Total",value:"total"},{text:"Count",value:"count"}]}return[]},t.prototype.pluckDeep=function(t,e){for(var a=e.split("."),r=t,n=0;n<a.length;++n){if(!r[a[n]])return;r=r[a[n]]}return r},t}(),An=function(){function t(t,e){this.$scope=t,this.$q=e,this.panelCtrl=t.ctrl,this.panel=this.panelCtrl.panel,this.$scope.ctrl=this,this.unitFormats=J.a.getUnitFormats(),this.logScales={linear:1,"log (base 2)":2,"log (base 10)":10,"log (base 32)":32,"log (base 1024)":1024},this.xAxisModes={Time:"time",Series:"series",Histogram:"histogram"},this.xAxisStatOptions=[{text:"Avg",value:"avg"},{text:"Min",value:"min"},{text:"Max",value:"max"},{text:"Total",value:"total"},{text:"Count",value:"count"},{text:"Current",value:"current"}],"custom"===this.panel.xaxis.mode&&(this.panel.xaxis.name||(this.panel.xaxis.name="specify field"))}return t.$inject=["$scope","$q"],t.prototype.setUnitFormat=function(t,e){t.format=e.value,this.panelCtrl.render()},t.prototype.render=function(){this.panelCtrl.render()},t.prototype.xAxisModeChanged=function(){this.panelCtrl.processor.setPanelDefaultsForNewXAxisMode(),this.panelCtrl.onDataReceived(this.panelCtrl.dataList)},t.prototype.xAxisValueChanged=function(){this.panelCtrl.onDataReceived(this.panelCtrl.dataList)},t.prototype.getDataFieldNames=function(t){var e=this.panelCtrl.processor.getDataFieldNames(this.panelCtrl.dataList,t).map(function(t){return{text:t,value:t}});return this.$q.when(e)},t}();function Dn(){return{restrict:"E",scope:!0,templateUrl:"public/app/plugins/panel/graph/axes_editor.html",controller:An}}var Fn=function(t){function e(e,a,r){var n=t.call(this,e,a)||this;return n.annotationsSrv=r,n.hiddenSeries={},n.seriesList=[],n.dataList=[],n.annotations=[],n.colors=[],n.panelDefaults={datasource:null,renderer:"flot",yaxes:[{label:null,show:!0,logBase:1,min:null,max:null,format:"short"},{label:null,show:!0,logBase:1,min:null,max:null,format:"short"}],xaxis:{show:!0,mode:"time",name:null,values:[],buckets:null},yaxis:{align:!1,alignLevel:null},lines:!0,fill:1,linewidth:1,dashes:!1,dashLength:10,spaceLength:10,points:!1,pointradius:5,bars:!1,stack:!1,percentage:!1,legend:{show:!0,values:!1,min:!1,max:!1,current:!1,total:!1,avg:!1},nullPointMode:"null",steppedLine:!1,tooltip:{value_type:"individual",shared:!0,sort:0},timeFrom:null,timeShift:null,targets:[{}],aliasColors:{},seriesOverrides:[],thresholds:[]},A.a.defaults(n.panel,n.panelDefaults),A.a.defaults(n.panel.tooltip,n.panelDefaults.tooltip),A.a.defaults(n.panel.legend,n.panelDefaults.legend),A.a.defaults(n.panel.xaxis,n.panelDefaults.xaxis),n.processor=new En(n.panel),n.events.on("render",n.onRender.bind(n)),n.events.on("data-received",n.onDataReceived.bind(n)),n.events.on("data-error",n.onDataError.bind(n)),n.events.on("data-snapshot-load",n.onDataSnapshotLoad.bind(n)),n.events.on("init-edit-mode",n.onInitEditMode.bind(n)),n.events.on("init-panel-actions",n.onInitPanelActions.bind(n)),n}return e.$inject=["$scope","$injector","annotationsSrv"],Rt.d(e,t),e.prototype.onInitEditMode=function(){this.addEditorTab("坐标轴",Dn,2),this.addEditorTab("图例","public/app/plugins/panel/graph/tab_legend.html",3),this.addEditorTab("展示","public/app/plugins/panel/graph/tab_display.html",4),kt.a.alertingEnabled&&this.addEditorTab("告警",Wt,5),this.subTabIndex=0},e.prototype.onInitPanelActions=function(t){t.push({text:"导出 CSV",click:"ctrl.exportCsv()"}),t.push({text:"启用图例",click:"ctrl.toggleLegend()"})},e.prototype.issueQueries=function(e){return this.annotationsPromise=this.annotationsSrv.getAnnotations({dashboard:this.dashboard,panel:this.panel,range:this.range}),t.prototype.issueQueries.call(this,e)},e.prototype.zoomOut=function(t){this.publishAppEvent("zoom-out",2)},e.prototype.onDataSnapshotLoad=function(t){this.annotationsPromise=this.annotationsSrv.getAnnotations({dashboard:this.dashboard,panel:this.panel,range:this.range}),this.onDataReceived(t)},e.prototype.onDataError=function(t){this.seriesList=[],this.annotations=[],this.render([])},e.prototype.onDataReceived=function(t){var e=this;if(this.dataList=t,this.seriesList=this.processor.getSeriesList({dataList:t,range:this.range}),this.dataWarning=null,0===this.seriesList.reduce(function(t,e){return t+e.datapoints.length},0))this.dataWarning={title:"暂无数据点",tip:"数据查询中无数据点返回"};else for(var a=0,r=this.seriesList;a<r.length;a++){if(r[a].isOutsideRange){this.dataWarning={title:"数据点不在时间范围内",tip:"由时区失配或时间过滤设置不当引起"};break}}this.annotationsPromise.then(function(t){e.loading=!1,e.alertState=t.alertState,e.annotations=t.annotations,e.render(e.seriesList)},function(){e.loading=!1,e.render(e.seriesList)})},e.prototype.onRender=function(){if(this.seriesList)for(var t=0,e=this.seriesList;t<e.length;t++){var a=e[t];a.applySeriesOverrides(this.panel.seriesOverrides),a.unit&&(this.panel.yaxes[a.yaxis-1].format=a.unit)}},e.prototype.changeSeriesColor=function(t,e){t.setColor(e),this.panel.aliasColors[t.alias]=t.color,this.render()},e.prototype.toggleSeries=function(t,e){e.ctrlKey||e.metaKey||e.shiftKey?this.hiddenSeries[t.alias]?delete this.hiddenSeries[t.alias]:this.hiddenSeries[t.alias]=!0:this.toggleSeriesExclusiveMode(t),this.render()},e.prototype.toggleSeriesExclusiveMode=function(t){var e=this,a=this.hiddenSeries;a[t.alias]&&delete a[t.alias],A.a.every(this.seriesList,function(e){return e.alias===t.alias||a[e.alias]})?A.a.each(this.seriesList,function(t){delete e.hiddenSeries[t.alias]}):A.a.each(this.seriesList,function(a){a.alias!==t.alias&&(e.hiddenSeries[a.alias]=!0)})},e.prototype.toggleAxis=function(t){var e=A.a.find(this.panel.seriesOverrides,{alias:t.alias});e||(e={alias:t.alias},this.panel.seriesOverrides.push(e)),t.yaxis=e.yaxis=2===t.yaxis?1:2,this.render()},e.prototype.addSeriesOverride=function(t){this.panel.seriesOverrides.push(t||{})},e.prototype.removeSeriesOverride=function(t){this.panel.seriesOverrides=A.a.without(this.panel.seriesOverrides,t),this.render()},e.prototype.toggleLegend=function(){this.panel.legend.show=!this.panel.legend.show,this.refresh()},e.prototype.legendValuesOptionChanged=function(){var t=this.panel.legend;t.values=t.min||t.max||t.avg||t.current||t.total,this.render()},e.prototype.exportCsv=function(){var t=this.$scope.$new(!0);t.seriesList=this.seriesList,this.publishAppEvent("show-modal",{templateHtml:'<export-data-modal data="seriesList"></export-data-modal>',scope:t,modalClass:"modal--narrow"})},e.template='\n<div class="graph-panel" ng-class="{\'graph-panel--legend-right\': ctrl.panel.legend.rightSide}">\n  <div class="graph-panel__chart" grafana-graph ng-dblclick="ctrl.zoomOut()">\n  </div>\n\n  <div class="graph-legend">\n    <div class="graph-legend-content" graph-legend></div>\n  </div>\n</div>\n',e}(Bt),In=function(t){function e(e,a,r,n){var i=t.call(this,e,a)||this;return i.backendSrv=r,i.dashboardSrv=n,i.panelDefaults={query:"",limit:10,tags:[],recent:!1,search:!1,starred:!0,headings:!0,folderId:null},A.a.defaults(i.panel,i.panelDefaults),i.panel.tag&&(i.panel.tags=[i.panel.tag],delete i.panel.tag),i.events.on("refresh",i.onRefresh.bind(i)),i.events.on("init-edit-mode",i.onInitEditMode.bind(i)),i.groups=[{list:[],show:!1,header:"收藏的仪表盘"},{list:[],show:!1,header:"最近查看的仪表盘"},{list:[],show:!1,header:"搜索"}],i.panel.mode&&("starred"===i.panel.mode&&(i.panel.starred=!0,i.panel.headings=!1),"recently viewed"===i.panel.mode&&(i.panel.recent=!0,i.panel.starred=!1,i.panel.headings=!1),"search"===i.panel.mode&&(i.panel.search=!0,i.panel.starred=!1,i.panel.headings=!1),delete i.panel.mode),i}return e.$inject=["$scope","$injector","backendSrv","dashboardSrv"],Rt.d(e,t),e.prototype.onInitEditMode=function(){this.editorTabIndex=1,this.modes=["starred","search","recently viewed"],this.addEditorTab("选项","public/app/plugins/panel/dashlist/editor.html")},e.prototype.onRefresh=function(){var t=[];return t.push(this.getRecentDashboards()),t.push(this.getStarred()),t.push(this.getSearch()),Promise.all(t).then(this.renderingCompleted.bind(this))},e.prototype.getSearch=function(){var t=this;if(this.groups[2].show=this.panel.search,!this.panel.search)return Promise.resolve();var e={limit:this.panel.limit,query:this.panel.query,tag:this.panel.tags,folderIds:this.panel.folderId,type:"dash-db"};return this.backendSrv.search(e).then(function(e){t.groups[2].list=e})},e.prototype.getStarred=function(){var t=this;if(this.groups[0].show=this.panel.starred,!this.panel.starred)return Promise.resolve();var e={limit:this.panel.limit,starred:"true"};return this.backendSrv.search(e).then(function(e){t.groups[0].list=e})},e.prototype.starDashboard=function(t,e){this.dashboardSrv.starDashboard(t.id,t.isStarred).then(function(e){t.isStarred=e}),e&&(e.stopPropagation(),e.preventDefault())},e.prototype.getRecentDashboards=function(){var t=this;if(this.groups[1].show=this.panel.recent,!this.panel.recent)return Promise.resolve();var e=A.a.take(Pe.a.getDashboardOpened(),this.panel.limit);return this.backendSrv.search({dashboardIds:e,limit:this.panel.limit}).then(function(a){t.groups[1].list=e.map(function(t){return A.a.find(a,function(e){return e.id===t})}).filter(function(t){return void 0!==t})})},e.prototype.onFolderChange=function(t){this.panel.folderId=t.id,this.refresh()},e.templateUrl="module.html",e.scrollable=!0,e}(qt),On=function(t){function e(e,a,r){var n=t.call(this,e,a)||this;return n.backendSrv=r,n.panelDefaults={},A.a.defaults(n.panel,n.panelDefaults),n.events.on("init-edit-mode",n.onInitEditMode.bind(n)),n.pluginList=[],n.viewModel=[{header:"已安装应用",list:[],type:"app"},{header:"已安装插件",list:[],type:"panel"},{header:"已安装数据源",list:[],type:"datasource"}],n.update(),n}return e.$inject=["$scope","$injector","backendSrv"],Rt.d(e,t),e.prototype.onInitEditMode=function(){this.editorTabIndex=1,this.addEditorTab("Options","public/app/plugins/panel/pluginlist/editor.html")},e.prototype.gotoPlugin=function(t,e){e&&e.stopPropagation(),this.$location.url("plugins/"+t.id+"/edit")},e.prototype.updateAvailable=function(t,e){e.stopPropagation(),e.preventDefault();var a=this.$scope.$new(!0);a.plugin=t,this.publishAppEvent("show-modal",{src:"public/app/features/plugins/partials/update_instructions.html",scope:a})},e.prototype.update=function(){var t=this;this.backendSrv.get("api/plugins",{embedded:0,core:0}).then(function(e){t.pluginList=e,t.viewModel[0].list=A.a.filter(e,{type:"app"}),t.viewModel[1].list=A.a.filter(e,{type:"panel"}),t.viewModel[2].list=A.a.filter(e,{type:"datasource"});for(var a=0,r=t.pluginList;a<r.length;a++){var n=r[a];n.hasUpdate?n.state="has-update":n.enabled||(n.state="not-enabled")}})},e.templateUrl="module.html",e.scrollable=!0,e}(qt),qn=function(t){function e(e,a,r){var n=t.call(this,e,a)||this;for(var i in n.backendSrv=r,n.showOptions=[{text:"当前状态",value:"current"},{text:"近期状态改变",value:"changes"}],n.sortOrderOptions=[{text:"字母序 (升序)",value:1},{text:"字母序 (降序)",value:2},{text:"重要因子",value:3}],n.stateFilter={},n.currentAlerts=[],n.alertHistory=[],n.panelDefaults={show:"current",limit:10,stateFilter:[],onlyAlertsOnDashboard:!1,sortOrder:1,dashboardFilter:"",nameFilter:"",folderId:null},A.a.defaults(n.panel,n.panelDefaults),n.events.on("init-edit-mode",n.onInitEditMode.bind(n)),n.events.on("refresh",n.onRefresh.bind(n)),n.panel.stateFilter)n.stateFilter[n.panel.stateFilter[i]]=!0;return n}return e.$inject=["$scope","$injector","backendSrv"],Rt.d(e,t),e.prototype.sortResult=function(t){if(3===this.panel.sortOrder)return A.a.sortBy(t,function(t){return G.a.alertStateSortScore[t.state]});var e=A.a.sortBy(t,function(t){return t.name.toLowerCase()});return 2===this.panel.sortOrder&&e.reverse(),e},e.prototype.updateStateFilter=function(){var t=[];for(var e in this.stateFilter)this.stateFilter[e]&&t.push(e);this.panel.stateFilter=t,this.onRefresh()},e.prototype.onRefresh=function(){var t,e=this;"current"===this.panel.show&&(t=this.getCurrentAlertState()),"changes"===this.panel.show&&(t=this.getStateChanges()),t.then(function(){e.renderingCompleted()})},e.prototype.onFolderChange=function(t){this.panel.folderId=t.id,this.refresh()},e.prototype.getStateChanges=function(){var t=this,e={limit:this.panel.limit,type:"alert",newState:this.panel.stateFilter};return this.panel.onlyAlertsOnDashboard&&(e.dashboardId=this.dashboard.id),e.from=1e3*Vt.parse(this.dashboard.time.from).unix(),e.to=1e3*Vt.parse(this.dashboard.time.to).unix(),this.backendSrv.get("/api/annotations",e).then(function(e){return t.alertHistory=A.a.map(e,function(e){return e.time=t.dashboard.formatDate(e.time,"MMM D, YYYY HH:mm:ss"),e.stateModel=G.a.getStateDisplayModel(e.newState),e.info=G.a.getAlertAnnotationInfo(e),e}),t.noAlertsMessage=0===t.alertHistory.length?"近期暂无告警状态变更":"",t.alertHistory})},e.prototype.getCurrentAlertState=function(){var t=this,e={state:this.panel.stateFilter};return this.panel.nameFilter&&(e.query=this.panel.nameFilter),this.panel.folderId>=0&&(e.folderId=this.panel.folderId),this.panel.dashboardFilter&&(e.dashboardQuery=this.panel.dashboardFilter),this.panel.onlyAlertsOnDashboard&&(e.dashboardId=this.dashboard.id),this.panel.dashboardTags&&(e.dashboardTag=this.panel.dashboardTags),this.backendSrv.get("/api/alerts",e).then(function(e){return t.currentAlerts=t.sortResult(A.a.map(e,function(t){return t.stateModel=G.a.getStateDisplayModel(t.state),t.newStateDateAgo=L()(t.newStateDate).locale("en").fromNow(!0),t})),t.currentAlerts.length>t.panel.limit&&(t.currentAlerts=t.currentAlerts.slice(0,t.panel.limit)),t.noAlertsMessage=0===t.currentAlerts.length?"没有告警":"",t.currentAlerts})},e.prototype.onInitEditMode=function(){this.addEditorTab("选项","public/app/plugins/panel/alertlist/editor.html")},e.templateUrl="module.html",e.scrollable=!0,e}(qt),Rn=a(1196),Nn=a(1209);function Vn(t,e,a,r){void 0===r&&(r=0);var n=Nn[t.value],i="always"===t.invert||t.invert===(e?"light":"dark"),s=i?a:r,o=i?r:a;return Rn.scaleSequential(n).domain([s,o])}function Ln(t,e,a){var r;return void 0===a&&(a=0),"linear"===t.colorScale?r=Rn.scaleLinear().domain([a,e]).range([0,1]):"sqrt"===t.colorScale&&(r=Rn.scalePow().exponent(t.exponent).domain([a,e]).range([0,1])),r}var jn=P.a.module("grafana.directives"),Un=0,Bn=0;function Qn(t,e,a,r,n,i,s){var o=F()(t).find("svg"),l=Rn.select(o.get(0));if(!(s<=0||0===o.get(0).childNodes.length)){var u=Rn.scaleLinear().domain([0,r]).range([0,s]),c=function(t,e,a,r){for(var n=e-t,i=Object($e.tickStep)(t,e,3),s=Math.round(n/i),o=[],l=0;l<s;l++){var u=i*l;zn(r,u,i)?o.push(r):(r<u&&o.push(r),zn(a,u,i)?o.push(a):(a<u&&o.push(a),o.push(i*l)))}zn(a,e,i)||o.push(a);return o.push(e),o=A.a.sortBy(A.a.uniq(o))}(0,r,n,i),h=Rn.axisBottom(u).tickValues(c).tickSize(Un),p=o.find(":first-child"),d=function(t){var e=t.get(0);return e&&e.height&&e.height.baseVal?e.height.baseVal.value:0}(o)+Bn,m=function(t){var e=t.get(0);return e&&e.x&&e.x.baseVal?e.x.baseVal.value:0}(p);Rn.select(o.get(0)).append("g").attr("class","axis").attr("transform","translate("+m+","+d+")").call(h),l.select(".axis").select(".domain").remove()}}function Hn(t){F()(t).find("svg").empty()}function zn(t,e,a){return Math.abs(t-e)<.3*a}jn.directive("colorLegend",function(){return{restrict:"E",template:'<div class="heatmap-color-legend"><svg width="16.5rem" height="24px"></svg></div>',link:function(t,e,a){var r=t.ctrl,n=t.ctrl.panel;function i(){var t=F()(e).find("svg"),a=Math.floor(t.outerWidth());if("spectrum"===n.color.mode){var i=Vn(A.a.find(r.colorSchemes,{value:n.color.colorScheme}),j.c.user.lightTheme,a);!function(t,e){var a=F()(t).find("svg");Hn(t);var r=Math.floor(a.outerWidth()),n=a.attr("height");if(r){var i=Math.floor(r/2),s=Math.floor(r/i),o=Rn.range(0,r,s),l=Rn.select(a.get(0)),u=l.selectAll(".heatmap-color-legend-rect").data(o);u.enter().append("rect").attr("x",function(t){return t}).attr("y",0).attr("width",s+1).attr("height",n).attr("stroke-width",0).attr("fill",function(t){return e(t)})}}(e,i)}else if("opacity"===n.color.mode){var s=n.color;!function(t,e){var a=F()(t).find("svg");Hn(t);var r=Rn.select(a.get(0)),n=Math.floor(a.outerWidth()),i=a.attr("height");if(n){var s;"linear"===e.colorScale?s=Rn.scaleLinear().domain([0,n]).range([0,1]):"sqrt"===e.colorScale&&(s=Rn.scalePow().exponent(e.exponent).domain([0,n]).range([0,1]));var o=Rn.range(0,n,10),l=r.selectAll(".heatmap-opacity-legend-rect").data(o);l.enter().append("rect").attr("x",function(t){return t}).attr("y",0).attr("width",10).attr("height",i).attr("stroke-width",0).attr("fill",e.cardColor).style("opacity",function(t){return s(t)})}}(e,s)}}i(),r.events.on("render",function(){i()})}}}),jn.directive("heatmapLegend",function(){return{restrict:"E",template:'<div class="heatmap-color-legend"><svg width="100px" height="6px"></svg></div>',link:function(t,e,a){var r=t.ctrl,n=t.ctrl.panel;function i(){if(Hn(e),!A.a.isEmpty(r.data)&&!A.a.isEmpty(r.data.cards)){var t=r.data.cardStats.max,a=n.color.max||t,i=n.color.min||0;if("spectrum"===n.color.mode){var s=A.a.find(r.colorSchemes,{value:n.color.colorScheme});!function(t,e,a,r,n,i){var s=F()(t).find("svg"),o=Rn.select(s.get(0));Hn(t);var l=Math.floor(s.outerWidth())-30,u=s.attr("height"),c=1;r-a>l&&(c=Math.floor((r-a)/l));var h=l/(r-a),p=Rn.range(a,r,c),d=Vn(e,j.c.user.lightTheme,n,i);o.selectAll(".heatmap-color-legend-rect").data(p).enter().append("rect").attr("x",function(t){return t*h}).attr("y",0).attr("width",c*h+1).attr("height",u).attr("stroke-width",0).attr("fill",function(t){return d(t)}),Qn(t,d,a,r,n,i,l)}(e,s,0,t,a,i)}else if("opacity"===n.color.mode){var o=n.color;!function(t,e,a,r,n,i){var s=F()(t).find("svg"),o=Rn.select(s.get(0));Hn(t);var l=Math.floor(s.outerWidth())-30,u=s.attr("height"),c=1;r-a>l&&(c=Math.floor((r-a)/l));var h=l/(r-a),p=Rn.range(a,r,c),d=Ln(e,n,i);o.selectAll(".heatmap-opacity-legend-rect").data(p).enter().append("rect").attr("x",function(t){return t*h}).attr("y",0).attr("width",c*h).attr("height",u).attr("stroke-width",0).attr("fill",e.cardColor).style("opacity",function(t){return d(t)}),Qn(t,d,a,r,n,i,l)}(e,o,0,t,a,i)}}}i(),r.events.on("render",function(){i()})}}});var Yn=function(){function t(t,e){t.editor=this,this.panelCtrl=t.ctrl,this.panel=this.panelCtrl.panel,this.unitFormats=J.a.getUnitFormats(),this.logScales={linear:1,"log (base 2)":2,"log (base 10)":10,"log (base 32)":32,"log (base 1024)":1024},this.dataFormats={"Time series":"timeseries","Time series buckets":"tsbuckets"},this.yBucketBoundModes={Auto:"auto",Upper:"upper",Lower:"lower"}}return t.$inject=["$scope","uiSegmentSrv"],t.prototype.setUnitFormat=function(t){this.panel.yAxis.format=t.value,this.panelCtrl.render()},t}();function Wn(){return{restrict:"E",scope:!0,templateUrl:"public/app/plugins/panel/heatmap/partials/axes_editor.html",controller:Yn}}var Gn=function(){function t(t){t.editor=this,this.panelCtrl=t.ctrl,this.panel=this.panelCtrl.panel,this.panelCtrl.render()}return t.$inject=["$scope"],t}();function Kn(){return{restrict:"E",scope:!0,templateUrl:"public/app/plugins/panel/heatmap/partials/display_editor.html",controller:Gn}}var Jn=0,Xn=1;function Zn(t,e){var a,r;try{a=ti(t.label),r=ti(e.label)}catch(t){return console.log(t.message||t),0}return a>r?1:a<r?-1:0}function ti(t){if("+Inf"===t||"inf"===t)return 1/0;var e=Number(t);if(isNaN(e))throw new Error("Error parsing histogram label: "+t+" is not a number");return e}function ei(t){var e=0,a=0,r=[];return A.a.forEach(t,function(t){A.a.forEach(t.buckets,function(n){var i={x:t.x,y:n.y,yBounds:n.bounds,values:n.values,count:n.count};r.push(i),1===r.length&&(e=n.count,a=n.count),e=n.count<e?n.count:e,a=n.count>a?n.count:a})}),{cards:r,cardStats:{min:e,max:a}}}function ai(t,e,a,r){void 0===r&&(r=1);for(var n={},i=function(t){var e=t.datapoints,r=t.label;A.a.forEach(e,function(t){var e=si(t[Xn],a);!function(t,e,a,r){var n=e[Jn];if(null===n||void 0===n||isNaN(n))return;var i=A.a.concat(e,r);t[a]&&t[a].values?(t[a].values.push(n),t[a].points.push(i)):t[a]={x:a,values:[n],points:[i]}}(n,t,e,r)})},s=0,o=t;s<o.length;s++){i(o[s])}return A.a.forEach(n,function(t){t.buckets=1!==r?function(t,e,a){var r=t.values,n=t.points,i={};return A.a.forEach(r,function(t,r){var s=oi(t,e,a),o=s.bottom;ri(i,o,t,n[r],s)}),i}(t,e,r):function(t,e){var a=t.values,r=t.points,n={};return A.a.forEach(a,function(t,a){var i=ii(t,e),s=i.bottom;ri(n,s,t,r[a],i)}),n}(t,e)}),n}function ri(t,e,a,r,n){var i=1;r.length>3&&(i=parseInt(r[2],10)),t[e]?(t[e].values.push(a),t[e].points.push(r),t[e].count+=i):t[e]={y:e,bounds:n,values:[a],points:[r],count:i}}function ni(t,e,a){return 1===a?si(t,e):function(t,e,a){return oi(t,e,a).bottom}(t,e,a)}function ii(t,e){return{bottom:Math.floor(t/e)*e,top:(Math.floor(t/e)+1)*e}}function si(t,e){return ii(t,e).bottom}function oi(t,e,a){if(0===t)return{bottom:0,top:0};var r,n,i=li(t,a);if(1!==e&&e){var s=1/e,o=i-Math.floor(i);o=Math.floor(o/s)*s,n=(r=Math.floor(i)+o)+s}else n=(r=Math.floor(i))+1;return{bottom:Math.pow(a,r),top:Math.pow(a,n)}}function li(t,e){return Math.log(t)/Math.log(e)}function ui(t,e,a){return void 0===a&&(a=1),1===a?Math.abs(e-t):li(Math.max(t,e)/Math.min(t,e),a)}var ci=function(){function t(t,e){this.scope=e,this.dashboard=e.ctrl.dashboard,this.panelCtrl=e.ctrl,this.panel=e.ctrl.panel,this.heatmapPanel=t,this.mouseOverBucket=!1,this.originalFillColor=null,t.on("mouseleave",this.onMouseLeave.bind(this))}return t.prototype.onMouseLeave=function(){this.destroy()},t.prototype.onMouseMove=function(t){this.panel.tooltip.show&&this.move(t)},t.prototype.add=function(){this.tooltip=Rn.select("body").append("div").attr("class","heatmap-tooltip graph-tooltip grafana-tooltip")},t.prototype.destroy=function(){this.tooltip&&this.tooltip.remove(),this.tooltip=null},t.prototype.show=function(t,e){if(this.panel.tooltip.show&&e&&!t.panelRelY){var a=this.getBucketIndexes(t,e),r=a.xBucketIndex,n=a.yBucketIndex;if(e.buckets[r]){var i,s;this.tooltip||this.add();var o,l,u=e.buckets[r],c=A.a.find(u.buckets,function(t,e){return t.bounds.bottom===n||e===n.toString()}),h=this.dashboard.formatDate(u.x,"YYYY-MM-DD HH:mm:ss");if(A.a.isNumber(this.panel.tooltipDecimals))o=this.countValueFormatter(this.panel.tooltipDecimals,null),l=this.panelCtrl.tickValueFormatter(this.panelCtrl.decimals,null);else{var p=(this.panelCtrl.decimals||-1)+1;o=this.countValueFormatter(p,this.panelCtrl.scaledDecimals+2),l=this.panelCtrl.tickValueFormatter(p,this.panelCtrl.scaledDecimals+2)}var d='<div class="graph-tooltip-time">'+h+'</div>\n      <div class="heatmap-histogram"></div>';if(c)if(c.bounds){if(e.tsBuckets){var m=function(t){return e.tsBucketsFormatted?e.tsBucketsFormatted[t]:e.tsBuckets[t]};i=m(n),s=n<e.tsBuckets.length-1?m(n+1):""}else{i=l(c.y?c.bounds.bottom:0),s=l(c.bounds.top)}d+="<div>\n          bucket: <b>"+i+" - "+s+"</b> <br>\n          count: <b>"+o(c.count)+"</b> <br>\n        </div>"}else d+="<div>count: <b>"+c.count+"</b><br></div>";else{if(!this.panel.tooltip.showHistogram)return void this.destroy();i=n,s="",0}this.tooltip.html(d),this.panel.tooltip.showHistogram&&this.addHistogram(u),this.move(t)}else this.destroy()}},t.prototype.getBucketIndexes=function(t,e){return{xBucketIndex:this.getXBucketIndex(t.x,e),yBucketIndex:this.getYBucketIndex(t.y,e)}},t.prototype.getXBucketIndex=function(t,e){var a=A.a.find(e.buckets,function(a){return t>a.x&&t-a.x<=e.xBucketSize});return a?a.x:ni(t,e.xBucketSize,1)},t.prototype.getYBucketIndex=function(t,e){return e.tsBuckets?Math.floor(t):ni(t,e.yBucketSize,this.panel.yAxis.logBase)},t.prototype.getSharedTooltipPos=function(t){return t.pageX=this.heatmapPanel.offset().left+this.scope.xScale(t.x),t.pageY=this.heatmapPanel.offset().top+this.scope.chartHeight*t.panelRelY,t},t.prototype.addHistogram=function(t){var e,a,r,n=this.scope.ctrl.data.buckets[t.x],i=this.scope.ctrl.data.yBucketSize;this.scope.ctrl.data.tsBuckets?(e=0,a=this.scope.ctrl.data.tsBuckets.length-1,r=this.scope.ctrl.data.tsBuckets.length):(e=this.scope.ctrl.data.yAxis.min,a=this.scope.ctrl.data.yAxis.max,r=this.scope.ctrl.data.yAxis.ticks);var s=A.a.map(n.buckets,function(t){var e=void 0!==t.count?t.count:t.values.length;return[t.bounds.bottom,e]});s=A.a.filter(s,function(t){return t[0]>=e&&t[0]<=a});var o,l=this.scope.yScale.copy().domain([e,a]).range([0,160]);if(1===this.panel.yAxis.logBase)o=Math.floor(160/(a-e)*i*.9);else{var u=i||1;o=Math.floor(160/r/u*.9)}o=Math.max(o,1);var c=A.a.reduce(A.a.map(s,function(t){return t[1]}),function(t,e){return t+e},0),h=Rn.scaleLinear().domain([0,c]).range([0,40]);this.tooltip.select(".heatmap-histogram").append("svg").attr("width",160).attr("height",40).selectAll(".bar").data(s).enter().append("rect").attr("x",function(t){return l(t[0])}).attr("width",o).attr("y",function(t){return 40-h(t[1])}).attr("height",function(t){return h(t[1])})},t.prototype.move=function(t){if(this.tooltip){var e=F()(this.tooltip.node())[0],a=e.clientWidth,r=e.clientHeight,n=t.pageX+30,i=t.pageY+5;return t.pageX+a+40>window.innerWidth&&(n=t.pageX-a-30),t.pageY-window.pageYOffset+r+20>window.innerHeight&&(i=t.pageY-r-5),this.tooltip.style("left",n+"px").style("top",i+"px")}},t.prototype.countValueFormatter=function(t,e){void 0===e&&(e=null);return function(a){return J.a.valueFormats.short(a,t,e)}},t}(),hi=1.2;var pi=function(){function t(t,e,a,r){this.scope=t,this.elem=e,this.ctrl=r,this.$heatmap=this.elem.find(".heatmap-panel"),this.tooltip=new ci(this.$heatmap,this.scope),this.selection={active:!1,x1:-1,x2:-1},this.padding={left:0,right:0,top:0,bottom:0},this.margin={left:25,right:15,top:10,bottom:20},this.dataRangeWidingFactor=hi,this.ctrl.events.on("render",this.onRender.bind(this)),this.ctrl.tickValueFormatter=this.tickValueFormatter.bind(this),j.b.on("graph-hover",this.onGraphHover.bind(this),this.scope),j.b.on("graph-hover-clear",this.onGraphHoverClear.bind(this),this.scope),this.$heatmap.on("mousedown",this.onMouseDown.bind(this)),this.$heatmap.on("mousemove",this.onMouseMove.bind(this)),this.$heatmap.on("mouseleave",this.onMouseLeave.bind(this))}return t.prototype.onGraphHoverClear=function(){this.clearCrosshair()},t.prototype.onGraphHover=function(t){this.drawSharedCrosshair(t.pos)},t.prototype.onRender=function(){this.render(),this.ctrl.renderingCompleted()},t.prototype.setElementHeight=function(){try{var t=this.ctrl.height||this.panel.height||this.ctrl.row.height;return A.a.isString(t)&&(t=parseInt(t.replace("px",""),10)),t-=this.panel.legend.show?28:11,this.$heatmap.css("height",t+"px"),!0}catch(t){return!1}},t.prototype.getYAxisWidth=function(t){var e=t.selectAll(".axis-y text").nodes();return A.a.max(A.a.map(e,function(t){return t.getBBox().width}))},t.prototype.getXAxisHeight=function(t){if(t.select(".axis-x line").empty())return 30;var e=parseFloat(t.select(".axis-x line").attr("y2"));return parseFloat(t.attr("height"))-e},t.prototype.addXAxis=function(){this.scope.xScale=this.xScale=Rn.scaleTime().domain([this.timeRange.from,this.timeRange.to]).range([0,this.chartWidth]);var t,e=this.chartWidth/100,a=$e.grafanaTimeFormat(e,this.timeRange.from,this.timeRange.to);t="utc"===this.ctrl.dashboard.getTimezone()?Rn.utcFormat(a):Rn.timeFormat(a);var r=Rn.axisBottom(this.xScale).ticks(e).tickFormat(t).tickPadding(10).tickSize(this.chartHeight),n=this.margin.top,i=this.yAxisWidth;this.heatmap.append("g").attr("class","axis axis-x").attr("transform","translate("+i+","+n+")").call(r),this.heatmap.select(".axis-x").select(".domain").remove()},t.prototype.addYAxis=function(){var t=Math.ceil(this.chartHeight/50),e=$e.tickStep(this.data.heatmapStats.min,this.data.heatmapStats.max,t),a=this.wideYAxisRange(this.data.heatmapStats.min,this.data.heatmapStats.max,e),r=a.yMin,n=a.yMax;r=null!==this.panel.yAxis.min?this.panel.yAxis.min:r,n=null!==this.panel.yAxis.max?this.panel.yAxis.max:n,e=$e.tickStep(r,n,t),t=Math.ceil((n-r)/e);var i=$e.getPrecision(e),s=null===this.panel.yAxis.decimals?i:this.panel.yAxis.decimals,o=$e.getFlotTickSize(r,n,t,i),l=$e.getScaledDecimals(s,o);this.ctrl.decimals=s,this.ctrl.scaledDecimals=l,A.a.isEmpty(this.data.buckets)&&(n=1,r=-1,t=3,s=1),this.data.yAxis={min:r,max:n,ticks:t},this.scope.yScale=this.yScale=Rn.scaleLinear().domain([r,n]).range([this.chartHeight,0]);var u=Rn.axisLeft(this.yScale).ticks(t).tickFormat(this.tickValueFormatter(s,l)).tickSizeInner(0-this.width).tickSizeOuter(0).tickPadding(5);this.heatmap.append("g").attr("class","axis axis-y").call(u);var c=this.margin.top,h=this.getYAxisWidth(this.heatmap)+5;this.heatmap.select(".axis-y").attr("transform","translate("+h+","+c+")"),this.heatmap.select(".axis-y").select(".domain").remove()},t.prototype.wideYAxisRange=function(t,e,a){var r,n,i=(e*(this.dataRangeWidingFactor-1)-t*(this.dataRangeWidingFactor-1))/2;return 0===a?a=((n=e*this.dataRangeWidingFactor)-(r=t-t*(this.dataRangeWidingFactor-1)))/2:(n=Math.ceil((e+i)/a)*a,r=Math.floor((t-i)/a)*a),t>=0&&r<0&&(r=0),{yMin:r,yMax:n}},t.prototype.addLogYAxis=function(){var t=this.panel.yAxis.logBase,e=this.adjustLogRange(this.data.heatmapStats.minLog,this.data.heatmapStats.max,t),a=e.yMin,r=e.yMax;a=this.panel.yAxis.min&&"0"!==this.panel.yAxis.min?this.adjustLogMin(this.panel.yAxis.min,t):a,r=null!==this.panel.yAxis.max?this.adjustLogMax(this.panel.yAxis.max,t):r,A.a.isEmpty(this.data.buckets)&&(r=Math.pow(t,2),a=1),this.scope.yScale=this.yScale=Rn.scaleLog().base(this.panel.yAxis.logBase).domain([a,r]).range([this.chartHeight,0]);var n=this.yScale.domain(),i=this.logScaleTickValues(n,t),s=$e.getPrecision(a),o=this.panel.yAxis.decimals||s,l=$e.getFlotTickSize(a,r,i.length,s),u=$e.getScaledDecimals(o,l);this.ctrl.decimals=o,this.ctrl.scaledDecimals=u,this.data.yAxis={min:a,max:r,ticks:i.length};var c=Rn.axisLeft(this.yScale).tickValues(i).tickFormat(this.tickValueFormatter(o,u)).tickSizeInner(0-this.width).tickSizeOuter(0).tickPadding(5);this.heatmap.append("g").attr("class","axis axis-y").call(c);var h=this.margin.top,p=this.getYAxisWidth(this.heatmap)+5;this.heatmap.select(".axis-y").attr("transform","translate("+p+","+h+")"),a<1&&this.heatmap.select(".axis-y").select(".tick text").text("0"),this.heatmap.select(".axis-y").select(".domain").remove()},t.prototype.addYAxisFromBuckets=function(){var t=this.data.tsBuckets;this.scope.yScale=this.yScale=Rn.scaleLinear().domain([0,t.length-1]).range([this.chartHeight,0]);var e=A.a.map(t,function(t,e){return e}),a=A.a.max(A.a.map(t,$e.getStringPrecision)),r=null===this.panel.yAxis.decimals?a:this.panel.yAxis.decimals;this.ctrl.decimals=r;var n=this.tickValueFormatter.bind(this);function i(e){var a=t[e];return A.a.isNaN(A.a.toNumber(a))||""===a||(a=n(r)(A.a.toNumber(a))),a}var s=A.a.map(t,function(t,e){return i(e)});this.data.tsBucketsFormatted=s;var o=Rn.axisLeft(this.yScale).tickValues(e).tickFormat(i).tickSizeInner(0-this.width).tickSizeOuter(0).tickPadding(5);this.heatmap.append("g").attr("class","axis axis-y").call(o);var l=this.margin.top,u=this.getYAxisWidth(this.heatmap)+5;this.heatmap.select(".axis-y").attr("transform","translate("+u+","+l+")"),this.heatmap.select(".axis-y").select(".domain").remove()},t.prototype.adjustLogRange=function(t,e,a){return this.data.heatmapStats.minLog,{yMin:this.data.heatmapStats.minLog>1||!this.data.heatmapStats.minLog?1:this.adjustLogMin(this.data.heatmapStats.minLog,a),yMax:this.adjustLogMax(this.data.heatmapStats.max,a)}},t.prototype.adjustLogMax=function(t,e){return Math.pow(e,Math.ceil($e.logp(t,e)))},t.prototype.adjustLogMin=function(t,e){return Math.pow(e,Math.floor($e.logp(t,e)))},t.prototype.logScaleTickValues=function(t,e){var a=t[0],r=t[1],n=[];if(a<1)for(var i=Math.floor($e.logp(a,e));i<0;i++){var s=Math.pow(e,i);n.push(s)}var o=Math.ceil($e.logp(r,e));for(i=0;i<=o;i++){s=Math.pow(e,i);n.push(s)}return n},t.prototype.tickValueFormatter=function(t,e){void 0===e&&(e=null);var a=this.panel.yAxis.format;return function(r){try{return"none"!==a?J.a.valueFormats[a](r,t,e):r}catch(t){return console.error(t.message||t),r}}},t.prototype.fixYAxisTickSize=function(){this.heatmap.select(".axis-y").selectAll(".tick line").attr("x2",this.chartWidth)},t.prototype.addAxes=function(){this.chartHeight=this.height-this.margin.top-this.margin.bottom,this.chartTop=this.margin.top,this.chartBottom=this.chartTop+this.chartHeight,"tsbuckets"===this.panel.dataFormat?this.addYAxisFromBuckets():1===this.panel.yAxis.logBase?this.addYAxis():this.addLogYAxis(),this.yAxisWidth=this.getYAxisWidth(this.heatmap)+5,this.chartWidth=this.width-this.yAxisWidth-this.margin.right,this.fixYAxisTickSize(),this.addXAxis(),this.xAxisHeight=this.getXAxisHeight(this.heatmap),this.panel.yAxis.show||this.heatmap.select(".axis-y").selectAll("line").style("opacity",0),this.panel.xAxis.show||this.heatmap.select(".axis-x").selectAll("line").style("opacity",0)},t.prototype.addHeatmapCanvas=function(){var t=this.$heatmap[0];this.width=Math.floor(this.$heatmap.width())-this.padding.right,this.height=Math.floor(this.$heatmap.height())-this.padding.bottom,this.cardPadding=null!==this.panel.cards.cardPadding?this.panel.cards.cardPadding:1,this.cardRound=null!==this.panel.cards.cardRound?this.panel.cards.cardRound:0,this.heatmap&&this.heatmap.remove(),this.heatmap=Rn.select(t).append("svg").attr("width",this.width).attr("height",this.height)},t.prototype.addHeatmap=function(){var t=this;if(this.addHeatmapCanvas(),this.addAxes(),1!==this.panel.yAxis.logBase&&"tsbuckets"!==this.panel.dataFormat){var e=this.panel.yAxis.logBase,a=this.yScale.domain(),r=this.logScaleTickValues(a,e);this.data.buckets=function(t,e){return A.a.forEach(t,function(t){var a=t.buckets,r={bounds:{bottom:0,top:0},values:[],points:[],count:0},n=a[0]||r,i=a[e]||r,s={y:0,bounds:{bottom:e,top:i.bounds.top||e},values:[],points:[],count:0};s.points=n.points.concat(i.points),s.values=n.values.concat(i.values),s.count=s.values.length,0!==s.count&&(delete a[e],a[0]=s)}),t}(this.data.buckets,A.a.min(r))}var n=this.data.cards,i=this.data.cardStats.max,s=this.panel.color.max||i,o=this.panel.color.min||0,l=A.a.find(this.ctrl.colorSchemes,{value:this.panel.color.colorScheme});this.colorScale=Vn(l,j.c.user.lightTheme,s,o),this.opacityScale=Ln(this.panel.color,s),this.setCardSize();var u=this.heatmap.selectAll(".heatmap-card").data(n);u.append("title"),u=u.enter().append("rect").attr("x",this.getCardX.bind(this)).attr("width",this.getCardWidth.bind(this)).attr("y",this.getCardY.bind(this)).attr("height",this.getCardHeight.bind(this)).attr("rx",this.cardRound).attr("ry",this.cardRound).attr("class","bordered heatmap-card").style("fill",this.getCardColor.bind(this)).style("stroke",this.getCardColor.bind(this)).style("stroke-width",0).style("opacity",this.getCardOpacity.bind(this)),this.$heatmap.find(".heatmap-card").on("mouseenter",function(e){t.tooltip.mouseOverBucket=!0,t.highlightCard(e)}).on("mouseleave",function(e){t.tooltip.mouseOverBucket=!1,t.resetCardHighLight(e)})},t.prototype.highlightCard=function(t){var e=Rn.select(t.target).style("fill"),a=Rn.color(e).darker(2),r=Rn.color(e).brighter(4),n=Rn.select(t.target);this.tooltip.originalFillColor=e,n.style("fill",a.toString()).style("stroke",r.toString()).style("stroke-width",1)},t.prototype.resetCardHighLight=function(t){Rn.select(t.target).style("fill",this.tooltip.originalFillColor).style("stroke",this.tooltip.originalFillColor).style("stroke-width",0)},t.prototype.setCardSize=function(){var t=Math.floor(this.xScale(this.data.xBucketSize)-this.xScale(0)),e=Math.floor(this.yScale(this.yScale.invert(0)-this.data.yBucketSize));if(1!==this.panel.yAxis.logBase){var a=this.panel.yAxis.logBase,r=this.data.yBucketSize||1;e=Math.floor((this.yScale(1)-this.yScale(a))/r)}this.cardWidth=t-2*this.cardPadding,this.cardHeight=e?e-2*this.cardPadding:0},t.prototype.getCardX=function(t){return this.xScale(t.x)<0?this.yAxisWidth+this.cardPadding:this.xScale(t.x)+this.yAxisWidth+this.cardPadding},t.prototype.getCardWidth=function(t){var e;if(this.xScale(t.x)<0){var a=this.xScale(t.x)+this.cardWidth;e=a>0?a:0}else e=this.xScale(t.x)+this.cardWidth>this.chartWidth?this.chartWidth-this.xScale(t.x)-this.cardPadding:this.cardWidth;return e=Math.max(e,1)},t.prototype.getCardY=function(t){var e=this.yScale(t.y)+this.chartTop-this.cardHeight-this.cardPadding;return 1!==this.panel.yAxis.logBase&&0===t.y?e=this.chartBottom-this.cardHeight-this.cardPadding:e<this.chartTop&&(e=this.chartTop),e},t.prototype.getCardHeight=function(t){var e=this.yScale(t.y)+this.chartTop-this.cardHeight-this.cardPadding,a=this.cardHeight;return 1!==this.panel.yAxis.logBase&&0===t.y?this.cardHeight:(e<this.chartTop?a=this.yScale(t.y)-this.cardPadding:this.yScale(t.y)>this.chartBottom?a=this.chartBottom-e:e+this.cardHeight>this.chartBottom&&(a=this.chartBottom-e),a=Math.min(a,this.chartHeight),a=Math.max(a,1))},t.prototype.getCardColor=function(t){return"opacity"===this.panel.color.mode?this.panel.color.cardColor:this.colorScale(t.count)},t.prototype.getCardOpacity=function(t){return"opacity"===this.panel.color.mode?this.opacityScale(t.count):1},t.prototype.getEventOffset=function(t){var e=this.$heatmap.offset();return{x:Math.floor(t.clientX-e.left),y:Math.floor(t.clientY-e.top)}},t.prototype.onMouseDown=function(t){var e=this,a=this.getEventOffset(t);this.selection.active=!0,this.selection.x1=a.x,this.mouseUpHandler=function(){e.onMouseUp()},F()(document).one("mouseup",this.mouseUpHandler.bind(this))},t.prototype.onMouseUp=function(){F()(document).unbind("mouseup",this.mouseUpHandler.bind(this)),this.mouseUpHandler=null,this.selection.active=!1;var t=Math.abs(this.selection.x2-this.selection.x1);if(this.selection.x2>=0&&t>2){var e=this.xScale.invert(Math.min(this.selection.x1,this.selection.x2)-this.yAxisWidth),a=this.xScale.invert(Math.max(this.selection.x1,this.selection.x2)-this.yAxisWidth);this.ctrl.timeSrv.setTime({from:L.a.utc(e),to:L.a.utc(a)})}this.clearSelection()},t.prototype.onMouseLeave=function(){j.b.emit("graph-hover-clear"),this.clearCrosshair()},t.prototype.onMouseMove=function(t){if(this.heatmap){var e=this.getEventOffset(t);if(this.selection.active)this.clearCrosshair(),this.tooltip.destroy(),this.selection.x2=this.limitSelection(e.x),this.drawSelection(this.selection.x1,this.selection.x2);else{var a=this.getEventPos(t,e);this.drawCrosshair(e.x),this.tooltip.show(a,this.data),this.emitGraphHoverEvent(a)}}},t.prototype.getEventPos=function(t,e){var a=this.xScale.invert(e.x-this.yAxisWidth).valueOf(),r=this.yScale.invert(e.y-this.chartTop);return{pageX:t.pageX,pageY:t.pageY,x:a,x1:a,y:r,y1:r,panelRelY:null,offset:e}},t.prototype.emitGraphHoverEvent=function(t){t.panelRelY=Math.max(t.offset.y/this.height,.001),j.b.emit("graph-hover",{pos:t,panel:this.panel})},t.prototype.limitSelection=function(t){return t=Math.max(t,this.yAxisWidth),t=Math.min(t,this.chartWidth+this.yAxisWidth)},t.prototype.drawSelection=function(t,e){if(this.heatmap){this.heatmap.selectAll(".heatmap-selection").remove();var a=Math.min(t,e),r=Math.abs(t-e);r>2&&this.heatmap.append("rect").attr("class","heatmap-selection").attr("x",a).attr("width",r).attr("y",this.chartTop).attr("height",this.chartHeight)}},t.prototype.clearSelection=function(){this.selection.x1=-1,this.selection.x2=-1,this.heatmap&&this.heatmap.selectAll(".heatmap-selection").remove()},t.prototype.drawCrosshair=function(t){if(this.heatmap){this.heatmap.selectAll(".heatmap-crosshair").remove();var e=t;e=Math.max(e,this.yAxisWidth),e=Math.min(e,this.chartWidth+this.yAxisWidth),this.heatmap.append("g").attr("class","heatmap-crosshair").attr("transform","translate("+e+",0)").append("line").attr("x1",1).attr("y1",this.chartTop).attr("x2",1).attr("y2",this.chartBottom).attr("stroke-width",1)}},t.prototype.drawSharedCrosshair=function(t){if(this.heatmap&&0!==this.ctrl.dashboard.graphTooltip){var e=this.xScale(t.x)+this.yAxisWidth;this.drawCrosshair(e)}},t.prototype.clearCrosshair=function(){this.heatmap&&this.heatmap.selectAll(".heatmap-crosshair").remove()},t.prototype.render=function(){if(this.data=this.ctrl.data,this.panel=this.ctrl.panel,this.timeRange=this.ctrl.range,this.setElementHeight()&&this.data){if(A.a.isEmpty(this.data.buckets))return this.addHeatmapCanvas(),void this.addAxes();this.addHeatmap(),this.scope.yAxisWidth=this.yAxisWidth,this.scope.xAxisHeight=this.xAxisHeight,this.scope.chartHeight=this.chartHeight,this.scope.chartWidth=this.chartWidth,this.scope.chartTop=this.chartTop}},t}(),di={heatmap:{},cards:{cardPadding:null,cardRound:null},color:{mode:"spectrum",cardColor:"#b4ff00",colorScale:"sqrt",exponent:.5,colorScheme:"interpolateOranges"},legend:{show:!1},dataFormat:"timeseries",yBucketBound:"auto",xAxis:{show:!0},yAxis:{show:!0,format:"short",decimals:null,logBase:1,splitFactor:null,min:null,max:null},xBucketSize:null,xBucketNumber:null,yBucketSize:null,yBucketNumber:null,tooltip:{show:!0,showHistogram:!1},highlightCards:!0},mi=["opacity","spectrum"],fi=["linear","sqrt"],gi=[{name:"Spectral",value:"interpolateSpectral",invert:"always"},{name:"RdYlGn",value:"interpolateRdYlGn",invert:"always"},{name:"Blues",value:"interpolateBlues",invert:"dark"},{name:"Greens",value:"interpolateGreens",invert:"dark"},{name:"Greys",value:"interpolateGreys",invert:"dark"},{name:"Oranges",value:"interpolateOranges",invert:"dark"},{name:"Purples",value:"interpolatePurples",invert:"dark"},{name:"Reds",value:"interpolateReds",invert:"dark"},{name:"Viridis",value:"interpolateViridis",invert:"light"},{name:"Magma",value:"interpolateMagma",invert:"light"},{name:"Inferno",value:"interpolateInferno",invert:"light"},{name:"Plasma",value:"interpolatePlasma",invert:"light"},{name:"Warm",value:"interpolateWarm",invert:"light"},{name:"Cool",value:"interpolateCool",invert:"light"},{name:"Cubehelix",value:"interpolateCubehelixDefault",invert:"light"},{name:"BuGn",value:"interpolateBuGn",invert:"dark"},{name:"BuPu",value:"interpolateBuPu",invert:"dark"},{name:"GnBu",value:"interpolateGnBu",invert:"dark"},{name:"OrRd",value:"interpolateOrRd",invert:"dark"},{name:"PuBuGn",value:"interpolatePuBuGn",invert:"dark"},{name:"PuBu",value:"interpolatePuBu",invert:"dark"},{name:"PuRd",value:"interpolatePuRd",invert:"dark"},{name:"RdPu",value:"interpolateRdPu",invert:"dark"},{name:"YlGnBu",value:"interpolateYlGnBu",invert:"dark"},{name:"YlGn",value:"interpolateYlGn",invert:"dark"},{name:"YlOrBr",value:"interpolateYlOrBr",invert:"dark"},{name:"YlOrRd",value:"interpolateYlOrRd",invert:"dark"}],vi=["prometheus","elasticsearch"],yi=function(t){function e(e,a,r){var n=t.call(this,e,a)||this;return n.opacityScales=[],n.colorModes=[],n.colorSchemes=[],n.timeSrv=r,n.selectionActivated=!1,A.a.defaultsDeep(n.panel,di),n.opacityScales=fi,n.colorModes=mi,n.colorSchemes=gi,n.events.on("render",n.onRender.bind(n)),n.events.on("data-received",n.onDataReceived.bind(n)),n.events.on("data-error",n.onDataError.bind(n)),n.events.on("data-snapshot-load",n.onDataReceived.bind(n)),n.events.on("init-edit-mode",n.onInitEditMode.bind(n)),n.onCardColorChange=n.onCardColorChange.bind(n),n}return e.$inject=["$scope","$injector","timeSrv"],Rt.d(e,t),e.prototype.onInitEditMode=function(){this.addEditorTab("Axes",Wn,2),this.addEditorTab("Display",Kn,3),this.unitFormats=J.a.getUnitFormats()},e.prototype.zoomOut=function(t){this.publishAppEvent("zoom-out",2)},e.prototype.onRender=function(){this.range&&("tsbuckets"===this.panel.dataFormat?this.convertHistogramToHeatmapData():this.convertTimeSeriesToHeatmapData())},e.prototype.convertTimeSeriesToHeatmapData=function(){var t,e,a,r,n=this.panel.yAxis.logBase,i=this.panel.xBucketNumber||30,s=Math.floor((this.range.to-this.range.from)/i);t=J.a.interval_regex.test(this.panel.xBucketSize)?J.a.interval_to_ms(this.panel.xBucketSize):isNaN(Number(this.panel.xBucketSize))||""===this.panel.xBucketSize||null===this.panel.xBucketSize?s:Number(this.panel.xBucketSize),r=this.parseSeries(this.series);var o=this.panel.yBucketNumber||10;1!==n?e=this.panel.yAxis.splitFactor:(e=r.max===r.min?r.max?r.max/10:1:(r.max-r.min)/o,e=this.panel.yBucketSize||e),a=ai(this.series,e,t,n),r.min||r.max||(r={min:-1,max:1,minLog:1},e=1);var l=ei(a),u=l.cards,c=l.cardStats;this.data={buckets:a,heatmapStats:r,xBucketSize:t,yBucketSize:e,cards:u,cardStats:c}},e.prototype.convertHistogramToHeatmapData=function(){var t,e,a,r=this.getPanelDataSourceType();A.a.includes(vi,r)||this.series.sort(Zn),e=function(t){for(var e={},a=0;a<t.length;a++){var r=t[a],n=a;if(isNaN(n))return e;for(var i=0,s=r.datapoints;i<s.length;i++){var o=s[i],l=o[Jn],u=o[Xn];if(A.a.isNumber(l)){var c=e[u];c||(c=e[u]={x:u,buckets:{}}),c.buckets[n]={y:n,count:l,bounds:{top:null,bottom:n},values:[],points:[]}}}}return e}(this.series),a=A.a.map(this.series,"label");var n=this.panel.yBucketBound;"prometheus"===r&&"lower"!==n||"upper"===n?a=[""].concat(a):a.push(""),t=function(t,e){void 0===e&&(e=1);var a=1/0;if(0===t.length)return 0;if(1===t.length)return t[0];t=A.a.sortBy(t);for(var r=1;r<t.length;r++){var n=ui(t[r],t[r-1],e);a=n<a?n:a}return a}(A.a.map(A.a.keys(e),function(t){return Number(t)}));var i=ei(e),s=i.cards,o=i.cardStats;this.data={buckets:e,xBucketSize:t,yBucketSize:1,tsBuckets:a,cards:s,cardStats:o}},e.prototype.getPanelDataSourceType=function(){return this.datasource.meta&&this.datasource.meta.id?this.datasource.meta.id:"unknown"},e.prototype.onDataReceived=function(t){if(this.series=t.map(this.seriesHandler.bind(this)),this.dataWarning=null,0===A.a.reduce(this.series,function(t,e){return t+e.datapoints.length},0))this.dataWarning={title:"No data points",tip:"No datapoints returned from data query"};else for(var e=0,a=this.series;e<a.length;e++){if(a[e].isOutsideRange){this.dataWarning={title:"Data points outside time range",tip:"Can be caused by timezone mismatch or missing time filter in query"};break}}this.render()},e.prototype.onDataError=function(){this.series=[],this.render()},e.prototype.onCardColorChange=function(t){this.panel.color.cardColor=t,this.render()},e.prototype.seriesHandler=function(t){if(void 0===t.datapoints)throw new Error("Heatmap error: data should be a time series");var e=new ne.a({datapoints:t.datapoints,alias:t.target});e.flotpairs=e.getFlotPairs(this.panel.nullPointMode);var a=t.datapoints||[];a&&a.length>0&&(a[a.length-1][1]-this.range.from<-1e4&&(e.isOutsideRange=!0));return e},e.prototype.parseSeries=function(t){var e=A.a.min(A.a.map(t,function(t){return t.stats.min})),a=A.a.min(A.a.map(t,function(t){return t.stats.logmin}));return{max:A.a.max(A.a.map(t,function(t){return t.stats.max})),min:e,minLog:a}},e.prototype.parseHistogramSeries=function(t){var e=A.a.map(t,function(t){return Number(t.alias)}),a=A.a.min(e),r=A.a.min(e);return{max:A.a.max(e),min:a,minLog:r}},e.prototype.link=function(t,e,a,r){!function(t,e,a,r){new pi(t,e,a,r)}(t,e,a,r)},e.templateUrl="module.html",e}(Bt),bi={};bi.timeseries_to_rows={description:"Time series to rows",getColumns:function(){return[]},transform:function(t,e,a){a.columns=[{text:"Time",type:"date"},{text:"Metric"},{text:"Value"}];for(var r=0;r<t.length;r++)for(var n=t[r],i=0;i<n.datapoints.length;i++){var s=n.datapoints[i];a.rows.push([s[1],n.target,s[0]])}}},bi.timeseries_to_columns={description:"Time series to columns",getColumns:function(){return[]},transform:function(t,e,a){a.columns.push({text:"Time",type:"date"});for(var r={},n=0;n<t.length;n++){var i=t[n];a.columns.push({text:i.target});for(var s=0;s<i.datapoints.length;s++){var o=i.datapoints[s],l=o[1].toString();r[l]?r[l][n]=o[0]:(r[l]={time:o[1]},r[l][n]=o[0])}}for(var u in r){var c=r[u],h=[c.time];for(n=0;n<t.length;n++){var p=c[n];h.push(p)}a.rows.push(h)}}},bi.timeseries_aggregations={description:"Time series aggregations",getColumns:function(){return[{text:"Avg",value:"avg"},{text:"Min",value:"min"},{text:"Max",value:"max"},{text:"Total",value:"total"},{text:"Current",value:"current"},{text:"Count",value:"count"}]},transform:function(t,e,a){var r,n;for(a.columns.push({text:"Metric"}),r=0;r<e.columns.length;r++)a.columns.push({text:e.columns[r].text});for(r=0;r<t.length;r++){var i=new ne.a({datapoints:t[r].datapoints,alias:t[r].target});i.getFlotPairs("connected");var s=[i.alias];for(n=0;n<e.columns.length;n++)s.push(i.stats[e.columns[n].value]);a.rows.push(s)}}},bi.annotations={description:"Annotations",getColumns:function(){return[]},transform:function(t,e,a){if(a.columns.push({text:"Time",type:"date"}),a.columns.push({text:"Title"}),a.columns.push({text:"Text"}),a.columns.push({text:"Tags"}),t&&t.annotations&&0!==t.annotations.length)for(var r=0;r<t.annotations.length;r++){var n=t.annotations[r];a.rows.push([n.time,n.title,n.text,n.tags])}}},bi.table={description:"Table",getColumns:function(t){if(!t||0===t.length)return[];if(1===t.length)return t[0].columns.slice();var e={};return t.reduce(function(t,a){return a.columns.forEach(function(a){var r=a.text;void 0===e[r]&&(e[r]=t.length,t.push(a))}),t},[])},transform:function(t,e,a){if(t&&0!==t.length){var r=A.a.findIndex(t,function(t){return"table"!==t.type});if(r>-1)throw{message:"查询为 #"+String.fromCharCode(65+r)+" 的结果不是表格格式，尝试使用其他的转换格式。"};if(1===t.length)return a.columns=t[0].columns.slice(),void(a.rows=t[0].rows.slice());var n={},i=t.reduce(function(t,e){return e.columns.forEach(function(e){var a=e.text;void 0===n[a]&&(n[a]=t.length,t.push(e))}),t},[]),s=t.map(function(t){return t.columns.map(function(t){return n[t.text]})}),o=t.reduce(function(t,e,a){var r=s[a];return e.rows.forEach(function(e){var a=[];r.forEach(function(t,r){a[t]=e[r]}),t.push(a)}),t},[]),l={},u=o.reduce(function(t,e,a){if(!l[a]){for(var r=a+1;r<o.length;){var n=A.a.findIndex(o,function(t){return c(i,e,t)},r);if(!(n>-1))break;for(var s=o[n],u=0;u<i.length;u++)void 0===e[u]&&void 0!==s[u]&&(e[u]=s[u]);l[n]=s,r=n+1}t.push(e)}return t},[]);a.columns=i,a.rows=u}function c(t,e,a){for(var r=!1,n=0;n<t.length;n++)if(void 0!==e[n]&&void 0!==a[n]){if(e[n]!==a[n])return!1}else void 0!==e[n]&&void 0!==a[n]||(r=!0);return r}}},bi.json={description:"JSON Data",getColumns:function(t){if(!t||0===t.length)return[];for(var e={},a=0;a<t.length;a++){var r=t[a];if("docs"===r.type)for(var n=Math.min(r.datapoints.length,100),i=0;i<n;i++){var s=Me(r.datapoints[i],null);for(var o in s)e[o]=!0}}return A.a.map(e,function(t,e){return{text:e,value:e}})},transform:function(t,e,a){for(var r,n,i,s=0,o=e.columns;s<o.length;s++){var l={text:o[s].text};t.length>0&&t[0].filterable&&(l.filterable=!0),a.columns.push(l)}for(0===a.columns.length&&a.columns.push({text:"JSON"}),r=0;r<t.length;r++){var u=t[r];for(n=0;n<u.datapoints.length;n++){var c=u.datapoints[n],h=[];if(A.a.isObject(c)&&e.columns.length>0){var p=Me(c,null);for(i=0;i<e.columns.length;i++)h.push(p[e.columns[i].value])}else h.push(JSON.stringify(c));a.rows.push(h)}}}};var Si=function(){function t(t,e,a){this.$q=e,this.uiSegmentSrv=a,t.editor=this,this.panelCtrl=t.ctrl,this.panel=this.panelCtrl.panel,this.transformers=bi,this.fontSizes=["80%","90%","100%","110%","120%","130%","150%","160%","180%","200%","220%","250%"],this.addColumnSegment=a.newPlusButton(),this.updateTransformHints()}return t.$inject=["$scope","$q","uiSegmentSrv"],t.prototype.updateTransformHints=function(){switch(this.canSetColumns=!1,this.columnsHelpMessage="",this.panel.transform){case"timeseries_aggregations":case"json":this.canSetColumns=!0;break;case"table":this.columnsHelpMessage="列的内容及顺序由数据查询决定"}},t.prototype.getColumnOptions=function(){var t=this;if(!this.panelCtrl.dataRaw)return this.$q.when([]);var e=this.transformers[this.panel.transform].getColumns(this.panelCtrl.dataRaw),a=A.a.map(e,function(e){return t.uiSegmentSrv.newSegment({value:e.text})});return this.$q.when(a)},t.prototype.addColumn=function(){var t=bi[this.panel.transform].getColumns(this.panelCtrl.dataRaw),e=A.a.find(t,{text:this.addColumnSegment.value});e&&(this.panel.columns.push(e),this.render());var a=this.uiSegmentSrv.newPlusButton();this.addColumnSegment.html=a.html,this.addColumnSegment.value=a.value},t.prototype.transformChanged=function(){this.panel.columns=[],"timeseries_aggregations"===this.panel.transform&&this.panel.columns.push({text:"Avg",value:"avg"}),this.updateTransformHints(),this.render()},t.prototype.render=function(){this.panelCtrl.render()},t.prototype.removeColumn=function(t){this.panel.columns=A.a.without(this.panel.columns,t),this.panelCtrl.render()},t}();function xi(t,e){return{restrict:"E",scope:!0,templateUrl:"public/app/plugins/panel/table/editor.html",controller:Si}}var wi=function(){function t(t){var e=this;t.editor=this,this.activeStyleIndex=0,this.panelCtrl=t.ctrl,this.panel=this.panelCtrl.panel,this.unitFormats=J.a.getUnitFormats(),this.colorModes=[{text:"关闭",value:null},{text:"单元格",value:"cell"},{text:"值",value:"value"},{text:"行",value:"row"}],this.columnTypes=[{text:"数值",value:"number"},{text:"字符串",value:"string"},{text:"日期",value:"date"},{text:"隐藏",value:"hidden"}],this.fontSizes=["80%","90%","100%","110%","120%","130%","150%","160%","180%","200%","220%","250%"],this.dateFormats=[{text:"YYYY-MM-DD HH:mm:ss",value:"YYYY-MM-DD HH:mm:ss"},{text:"YYYY-MM-DD HH:mm:ss.SSS",value:"YYYY-MM-DD HH:mm:ss.SSS"},{text:"MM/DD/YY h:mm:ss a",value:"MM/DD/YY h:mm:ss a"},{text:"MMMM D, YYYY LT",value:"MMMM D, YYYY LT"}],this.mappingTypes=[{text:"数据值转文本",value:1},{text:"数值范围转文本",value:2}],this.getColumnNames=function(){return e.panelCtrl.table?A.a.map(e.panelCtrl.table.columns,function(t){return t.text}):[]},this.onColorChange=this.onColorChange.bind(this)}return t.$inject=["$scope"],t.prototype.render=function(){this.panelCtrl.render()},t.prototype.setUnitFormat=function(t,e){t.unit=e.value,this.panelCtrl.render()},t.prototype.addColumnStyle=function(){var t=this.panel.styles,e=t.length,a=e;e>0&&("/.*/"===t[e-1].pattern&&(a=e-1));t.splice(a,0,{unit:"short",type:"number",alias:"",decimals:2,colors:["rgba(245, 54, 54, 0.9)","rgba(237, 129, 40, 0.89)","rgba(50, 172, 45, 0.97)"],colorMode:null,pattern:"",dateFormat:"YYYY-MM-DD HH:mm:ss",thresholds:[],mappingType:1}),this.activeStyleIndex=a},t.prototype.removeColumnStyle=function(t){this.panel.styles=A.a.without(this.panel.styles,t)},t.prototype.invertColorOrder=function(t){var e=this.panel.styles[t].colors,a=e[0];e[0]=e[2],e[2]=a,this.panelCtrl.render()},t.prototype.onColorChange=function(t,e){var a=this;return function(r){a.panel.styles[t].colors[e]=r,a.render()}},t.prototype.addValueMap=function(t){t.valueMaps||(t.valueMaps=[]),t.valueMaps.push({value:"",text:""}),this.panelCtrl.render()},t.prototype.removeValueMap=function(t,e){t.valueMaps.splice(e,1),this.panelCtrl.render()},t.prototype.addRangeMap=function(t){t.rangeMaps||(t.rangeMaps=[]),t.rangeMaps.push({from:"",to:"",text:""}),this.panelCtrl.render()},t.prototype.removeRangeMap=function(t,e){t.rangeMaps.splice(e,1),this.panelCtrl.render()},t}();function ki(t,e){return{restrict:"E",scope:!0,templateUrl:"public/app/plugins/panel/table/column_options.html",controller:wi}}var Ci=function(){function t(t,e,a,r,n){this.panel=t,this.table=e,this.isUtc=a,this.sanitize=r,this.templateSrv=n,this.initColumns()}return t.prototype.setTable=function(t){this.table=t,this.initColumns()},t.prototype.initColumns=function(){this.formatters=[],this.colorState={};for(var t=0;t<this.table.columns.length;t++){var e=this.table.columns[t];e.title=e.text;for(var a=0;a<this.panel.styles.length;a++){var r=this.panel.styles[a],n=J.a.stringToJsRegex(r.pattern);if(e.text.match(n)){e.style=r,r.alias&&(e.title=e.text.replace(n,r.alias));break}}this.formatters[t]=this.createColumnFormatter(e)}},t.prototype.getColorForValue=function(t,e){if(!e.thresholds)return null;for(var a=e.thresholds.length;a>0;a--)if(t>=e.thresholds[a-1])return e.colors[a];return A.a.first(e.colors)},t.prototype.defaultCellFormatter=function(t,e){return null===t||void 0===t||void 0===t?"":(A.a.isArray(t)&&(t=t.join(", ")),e&&e.sanitize?this.sanitize(t):A.a.escape(t))},t.prototype.createColumnFormatter=function(t){var e=this;if(!t.style)return this.defaultCellFormatter;if("hidden"===t.style.type)return function(t){};if("date"===t.style.type)return function(a){if(void 0===a||null===a)return"-";A.a.isArray(a)&&(a=a[0]);var r=L()(a);return e.isUtc&&(r=r.utc()),r.format(t.style.dateFormat)};if("string"===t.style.type)return function(a){A.a.isArray(a)&&(a=a.join(", "));var r=t.style.mappingType||0;if(1===r&&t.style.valueMaps)for(var n=0;n<t.style.valueMaps.length;n++){var i=t.style.valueMaps[n];if(null!==a){if(!A.a.isString(a)&&Number(i.value)===Number(a)||i.value===a)return e.setColorState(a,t.style),e.defaultCellFormatter(i.text,t.style)}else if("null"===i.value)return i.text}if(2===r&&t.style.rangeMaps)for(n=0;n<t.style.rangeMaps.length;n++){i=t.style.rangeMaps[n];if(null!==a){if(Number(i.from)<=Number(a)&&Number(i.to)>=Number(a))return e.setColorState(a,t.style),e.defaultCellFormatter(i.text,t.style)}else if("null"===i.from&&"null"===i.to)return i.text}return null===a||void 0===a?"-":(e.setColorState(a,t.style),e.defaultCellFormatter(a,t.style))};if("number"===t.style.type){var a=J.a.valueFormats[t.unit||t.style.unit];return function(r){return null===r||void 0===r?"-":A.a.isString(r)||A.a.isArray(r)?e.defaultCellFormatter(r,t.style):(e.setColorState(r,t.style),a(r,t.style.decimals,null))}}return function(a){return e.defaultCellFormatter(a,t.style)}},t.prototype.setColorState=function(t,e){if(e.colorMode&&null!==t&&void 0!==t&&!A.a.isArray(t)){var a=Number(t);isNaN(a)||(this.colorState[e.colorMode]=this.getColorForValue(a,e))}},t.prototype.renderRowVariables=function(t){for(var e={},a=this.table.rows[t],r=0;r<a.length;r++)e["__cell_"+r]={value:a[r]};return e},t.prototype.formatColumnValue=function(t,e){return this.formatters[t]?this.formatters[t](e):e},t.prototype.renderCell=function(t,e,a,r){void 0===r&&(r=!1),a=this.formatColumnValue(t,a);var n=this.table.columns[t],i="",s=[],o="";this.colorState.cell?(i=' style="background-color:'+this.colorState.cell+'"',s.push("table-panel-color-cell"),this.colorState.cell=null):this.colorState.value&&(i=' style="color:'+this.colorState.value+'"',this.colorState.value=null);var l="";if(r&&(l='<div class="table-panel-width-hack">'+this.table.columns[t].title+"</div>"),void 0===a?(i=' style="display:none;"',n.hidden=!0):n.hidden=!1,!0===n.hidden)return"";if(n.style&&n.style.preserveFormat&&s.push("table-panel-cell-pre"),n.style&&n.style.link){var u=this.renderRowVariables(e);u.__cell={value:a};var c=this.templateSrv.replace(n.style.linkUrl,u,encodeURIComponent),h=this.templateSrv.replace(n.style.linkTooltip,u),p=n.style.linkTargetBlank?"_blank":"";s.push("table-panel-cell-link"),l+='\n        <a href="'+c+'" target="'+p+'" data-link-tooltip data-original-title="'+h+'" data-placement="right"'+i+">\n          "+a+"\n        </a>\n      "}else l+=a;return n.filterable&&(s.push("table-panel-cell-filterable"),l+='\n        <a class="table-panel-filter-link" data-link-tooltip data-original-title="Filter out value" data-placement="bottom"\n           data-row="'+e+'" data-column="'+t+'" data-operator="!=">\n          <i class="fa fa-search-minus"></i>\n        </a>\n        <a class="table-panel-filter-link" data-link-tooltip data-original-title="Filter for value" data-placement="bottom"\n           data-row="'+e+'" data-column="'+t+'" data-operator="=">\n          <i class="fa fa-search-plus"></i>\n        </a>'),s.length&&(o=' class="'+s.join(" ")+'"'),l="<td"+o+i+">"+l+"</td>"},t.prototype.render=function(t){for(var e=this.panel.pageSize||100,a=t*e,r=Math.min(a+e,this.table.rows.length),n="",i=[],s="",o=a;o<r;o++){for(var l=this.table.rows[o],u="",c="",h=0;h<this.table.columns.length;h++)u+=this.renderCell(h,o,l[h],o===a);this.colorState.row&&(c=' style="background-color:'+this.colorState.row+'"',i.push("table-panel-color-row"),this.colorState.row=null),i.length&&(s=' class="'+i.join(" ")+'"'),n+="<tr "+s+c+">"+u+"</tr>"}return n},t.prototype.render_values=function(){for(var t=[],e=0;e<this.table.rows.length;e++){for(var a=this.table.rows[e],r=[],n=0;n<this.table.columns.length;n++)r.push(this.formatColumnValue(n,a[n]));t.push(r)}return{columns:this.table.columns,rows:t}},t}(),Ti=function(t){function e(e,a,r,n,i,s){var o=t.call(this,e,a)||this;return o.annotationsSrv=n,o.$sanitize=i,o.variableSrv=s,o.panelDefaults={targets:[{}],transform:"timeseries_to_columns",pageSize:null,showHeader:!0,styles:[{type:"date",pattern:"Time",alias:"日期",dateFormat:"YYYY-MM-DD HH:mm:ss"},{unit:"short",type:"number",alias:"",decimals:2,colors:["rgba(245, 54, 54, 0.9)","rgba(237, 129, 40, 0.89)","rgba(50, 172, 45, 0.97)"],colorMode:null,pattern:"/.*/",thresholds:[]}],columns:[],scroll:!0,fontSize:"100%",sort:{col:0,desc:!0}},o.pageIndex=0,void 0===o.panel.styles&&(o.panel.styles=o.panel.columns,o.panel.columns=o.panel.fields,delete o.panel.columns,delete o.panel.fields),A.a.defaults(o.panel,o.panelDefaults),o.events.on("data-received",o.onDataReceived.bind(o)),o.events.on("data-error",o.onDataError.bind(o)),o.events.on("data-snapshot-load",o.onDataReceived.bind(o)),o.events.on("init-edit-mode",o.onInitEditMode.bind(o)),o.events.on("init-panel-actions",o.onInitPanelActions.bind(o)),o}return e.$inject=["$scope","$injector","templateSrv","annotationsSrv","$sanitize","variableSrv"],Rt.d(e,t),e.prototype.onInitEditMode=function(){this.addEditorTab("选项",xi,2),this.addEditorTab("列风格",ki,3)},e.prototype.onInitPanelActions=function(t){t.push({text:"导出 CSV",click:"ctrl.exportCsv()"})},e.prototype.issueQueries=function(e){return this.pageIndex=0,"annotations"===this.panel.transform?(this.setTimeQueryStart(),this.annotationsSrv.getAnnotations({dashboard:this.dashboard,panel:this.panel,range:this.range}).then(function(t){return{data:t}})):t.prototype.issueQueries.call(this,e)},e.prototype.onDataError=function(t){this.dataRaw=[],this.render()},e.prototype.onDataReceived=function(t){this.dataRaw=t,this.pageIndex=0,this.dataRaw&&this.dataRaw.length&&("table"===this.dataRaw[0].type?this.panel.transform="table":"docs"===this.dataRaw[0].type?this.panel.transform="json":"table"!==this.panel.transform&&"json"!==this.panel.transform||(this.panel.transform="timeseries_to_rows")),this.render()},e.prototype.render=function(){return this.table=function(t,e){var a=new ie.a;if(!t||0===t.length)return a;var r=bi[e.transform];if(!r)throw{message:"Transformer "+e.transform+" not found"};return r.transform(t,e,a),a}(this.dataRaw,this.panel),this.table.sort(this.panel.sort),this.renderer=new Ci(this.panel,this.table,this.dashboard.isTimezoneUtc(),this.$sanitize,this.templateSrv),t.prototype.render.call(this,this.table)},e.prototype.toggleColumnSort=function(t,e){this.table.columns[this.panel.sort.col]&&(this.table.columns[this.panel.sort.col].sort=!1),this.panel.sort.col===e?this.panel.sort.desc?this.panel.sort.desc=!1:this.panel.sort.col=null:(this.panel.sort.col=e,this.panel.sort.desc=!0),this.render()},e.prototype.moveQuery=function(e,a){t.prototype.moveQuery.call(this,e,a),t.prototype.refresh.call(this)},e.prototype.exportCsv=function(){var t=this.$scope.$new(!0);t.tableData=this.renderer.render_values(),t.panel="table",this.publishAppEvent("show-modal",{templateHtml:'<export-data-modal panel="panel" data="tableData"></export-data-modal>',scope:t,modalClass:"modal--narrow"})},e.prototype.link=function(t,e,a,r){var n,i=r.panel,s=0;function o(){var t=e.parents(".panel-content"),a=e.find(".table-panel-scroll"),o=e.find("tbody"),l=e.find(".table-panel-footer");e.css({"font-size":i.fontSize}),t.addClass("table-panel-content"),function(t){r.renderer.setTable(n),t.empty(),t.html(r.renderer.render(r.pageIndex))}(o),function(t){t.empty();var e=i.pageSize||100;if(1!==(s=Math.ceil(n.rows.length/e))){for(var a=Math.max(r.pageIndex-3,0),o=Math.min(s,a+9),l=F()("<ul></ul>"),u=a;u<o;u++){var c=u===r.pageIndex?"active":"",h=F()('<li><a class="table-panel-page-link pointer '+c+'">'+(u+1)+"</a></li>");l.append(h)}t.append(l)}}(l),a.css({"max-height":i.scroll?function(){var t=r.height;return s>1&&(t-=26),t-31+"px"}():""})}e.tooltip({selector:"[data-link-tooltip]"}),e.on("click",".table-panel-page-link",function(t){var e=F()(t.currentTarget);r.pageIndex=parseInt(e.text(),10)-1,o()}),e.on("click",".table-panel-filter-link",function(t){var e=F()(t.currentTarget).data(),a={datasource:i.datasource,key:n.columns[e.column].text,value:n.rows[e.row][e.column],operator:e.operator};r.variableSrv.setAdhocFilter(a)});var l=t.$on("$destroy",function(){e.off("click",".table-panel-page-link"),e.off("click",".table-panel-filter-link"),l()});r.events.on("render",function(t){(n=t||n)&&o(),r.renderingCompleted()})},e.templateUrl="module.html",e}(Bt),_i=(a(1220),function(){function t(t,e){this.templateSrv=t,this.timeSrv=e}return t.$inject=["templateSrv","timeSrv"],t.prototype.getLinkUrl=function(t){var e=this.templateSrv.replace(t.url||""),a={};if(t.keepTime){var r=this.timeSrv.timeRangeForUrl();a.from=r.from,a.to=r.to}return t.includeVars&&this.templateSrv.fillVariableValuesForUrl(a),this.addParamsToUrl(e,a)},t.prototype.addParamsToUrl=function(t,e){var a=[];return A.a.each(e,function(t,e){null!==t&&(!0===t?a.push(e):A.a.isArray(t)?A.a.each(t,function(t){a.push(e+"="+encodeURIComponent(t))}):a.push(e+"="+encodeURIComponent(t)))}),0===a.length?t:this.appendToQueryString(t,a.join("&"))},t.prototype.appendToQueryString=function(t,e){if(!A.a.isUndefined(e)&&null!==e&&""!==e){var a=t.indexOf("?");-1!==a?t.length-a>1&&(t+="&"):t+="?",t+=e}return t},t.prototype.getAnchorInfo=function(t){var e={};return e.href=this.getLinkUrl(t),e.title=this.templateSrv.replace(t.title||""),e},t.prototype.getPanelLinkAnchorInfo=function(t,e){var a={};if("absolute"===t.type)a.target=t.targetBlank?"_blank":"_self",a.href=this.templateSrv.replace(t.url||"",e),a.title=this.templateSrv.replace(t.title||"",e);else if(t.url)a.href=t.url,a.title=this.templateSrv.replace(t.title||"",e),a.target=t.targetBlank?"_blank":"";else if(t.dashUri)a.href="dashboard/"+t.dashUri+"?",a.title=this.templateSrv.replace(t.title||"",e),a.target=t.targetBlank?"_blank":"";else{a.title=this.templateSrv.replace(t.title||"",e);var r=J.a.slugifyForUrl(t.dashboard||"");a.href="dashboard/db/"+r+"?"}var n={};if(t.keepTime){var i=this.timeSrv.timeRangeForUrl();n.from=i.from,n.to=i.to}return t.includeVars&&this.templateSrv.fillVariableValuesForUrl(n,e),a.href=this.addParamsToUrl(a.href,n),t.params&&(a.href=this.appendToQueryString(a.href,this.templateSrv.replace(t.params,e))),a},t}());P.a.module("grafana.services").service("linkSrv",_i);var Mi=function(t){function e(e,a,r){var n=t.call(this,e,a)||this;return n.linkSrv=r,n.dataType="timeseries",n.valueNameOptions=[{value:"min",text:"最小"},{value:"max",text:"最大"},{value:"avg",text:"平均"},{value:"current",text:"当前"},{value:"total",text:"总和"},{value:"name",text:"名称"},{value:"first",text:"首个"},{value:"delta",text:"Delta"},{value:"diff",text:"差值"},{value:"range",text:"范围"},{value:"last_time",text:"上个数据点的时间"}],n.panelDefaults={links:[],datasource:null,maxDataPoints:100,interval:null,targets:[{}],cacheTimeout:null,format:"none",prefix:"",postfix:"",nullText:null,valueMaps:[{value:"null",op:"=",text:"N/A"}],mappingTypes:[{name:"value to text",value:1},{name:"range to text",value:2}],rangeMaps:[{from:"null",to:"null",text:"N/A"}],mappingType:1,nullPointMode:"connected",valueName:"avg",prefixFontSize:"50%",valueFontSize:"80%",postfixFontSize:"50%",thresholds:"",colorBackground:!1,colorValue:!1,colors:["#299c46","rgba(237, 129, 40, 0.89)","#d44a3a"],sparkline:{show:!1,full:!1,lineColor:"rgb(31, 120, 193)",fillColor:"rgba(31, 118, 189, 0.18)"},gauge:{show:!1,minValue:0,maxValue:100,thresholdMarkers:!0,thresholdLabels:!1},tableColumn:""},A.a.defaults(n.panel,n.panelDefaults),n.events.on("data-received",n.onDataReceived.bind(n)),n.events.on("data-error",n.onDataError.bind(n)),n.events.on("data-snapshot-load",n.onDataReceived.bind(n)),n.events.on("init-edit-mode",n.onInitEditMode.bind(n)),n.onSparklineColorChange=n.onSparklineColorChange.bind(n),n.onSparklineFillChange=n.onSparklineFillChange.bind(n),n}return e.$inject=["$scope","$injector","linkSrv"],Rt.d(e,t),e.prototype.onInitEditMode=function(){this.fontSizes=["20%","30%","50%","70%","80%","100%","110%","120%","150%","170%","200%"],this.addEditorTab("选项","public/app/plugins/panel/singlestat/editor.html",2),this.addEditorTab("值映射","public/app/plugins/panel/singlestat/mappings.html",3),this.unitFormats=J.a.getUnitFormats()},e.prototype.setUnitFormat=function(t){this.panel.format=t.value,this.refresh()},e.prototype.onDataError=function(t){this.onDataReceived([])},e.prototype.onDataReceived=function(t){var e={};if(t.length>0&&"table"===t[0].type){this.dataType="table";var a=t.map(this.tableHandler.bind(this));this.setTableValues(a,e)}else this.dataType="timeseries",this.series=t.map(this.seriesHandler.bind(this)),this.setValues(e);this.data=e,this.render()},e.prototype.seriesHandler=function(t){var e=new ne.a({datapoints:t.datapoints||[],alias:t.target});return e.flotpairs=e.getFlotPairs(this.panel.nullPointMode),e},e.prototype.tableHandler=function(t){var e=[],a={};return t.columns.forEach(function(t,e){a[e]=t.text}),this.tableColumnOptions=a,A.a.find(t.columns,["text",this.panel.tableColumn])||this.setTableColumnToSensibleDefault(t),t.rows.forEach(function(t){var r={};t.forEach(function(t,e){var n=a[e];r[n]=t}),e.push(r)}),e},e.prototype.setTableColumnToSensibleDefault=function(t){1===t.columns.length?this.panel.tableColumn=t.columns[0].text:this.panel.tableColumn=A.a.find(t.columns,function(t){return"time"!==t.type}).text},e.prototype.setTableValues=function(t,e){if(t&&0!==t.length&&0!==t[0].length&&void 0!==t[0][0][this.panel.tableColumn]){var a=t[0][0];if(e.value=a[this.panel.tableColumn],A.a.isString(e.value))e.valueFormatted=A.a.escape(e.value),e.value=0,e.valueRounded=0;else{var r=this.getDecimalsForValue(e.value),n=J.a.valueFormats[this.panel.format];e.valueFormatted=n(a[this.panel.tableColumn],r.decimals,r.scaledDecimals),e.valueRounded=J.a.roundValue(e.value,this.panel.decimals||0)}this.setValueMapping(e)}},e.prototype.canModifyText=function(){return!this.panel.gauge.show},e.prototype.setColoring=function(t){t.background?(this.panel.colorValue=!1,this.panel.colors=["rgba(71, 212, 59, 0.4)","rgba(245, 150, 40, 0.73)","rgba(225, 40, 40, 0.59)"]):(this.panel.colorBackground=!1,this.panel.colors=["rgba(50, 172, 45, 0.97)","rgba(237, 129, 40, 0.89)","rgba(245, 54, 54, 0.9)"]),this.render()},e.prototype.invertColorOrder=function(){var t=this.panel.colors[0];this.panel.colors[0]=this.panel.colors[2],this.panel.colors[2]=t,this.render()},e.prototype.onColorChange=function(t){var e=this;return function(a){e.panel.colors[t]=a,e.render()}},e.prototype.onSparklineColorChange=function(t){this.panel.sparkline.lineColor=t,this.render()},e.prototype.onSparklineFillChange=function(t){this.panel.sparkline.fillColor=t,this.render()},e.prototype.getDecimalsForValue=function(t){if(A.a.isNumber(this.panel.decimals))return{decimals:this.panel.decimals,scaledDecimals:null};var e,a=t/2,r=-Math.floor(Math.log(a)/Math.LN10),n=Math.pow(10,-r),i=a/n;i<1.5?e=1:i<3?(e=2,i>2.25&&(e=2.5,++r)):e=i<7.5?5:10,e*=n,Math.floor(t)===t&&(r=0);var s={};return s.decimals=Math.max(0,r),s.scaledDecimals=s.decimals-Math.floor(Math.log(e)/Math.LN10)+2,s},e.prototype.setValues=function(t){if(t.flotpairs=[],this.series.length>1){var e=new Error;throw e.message="Multiple Series Error",e.data="Metric query returns "+this.series.length+" series. Single Stat Panel expects a single series.\n\nResponse:\n"+JSON.stringify(this.series),e}if(this.series&&this.series.length>0){var a=A.a.last(this.series[0].datapoints),r=A.a.isArray(a)?a[0]:null;if("name"===this.panel.valueName)t.value=0,t.valueRounded=0,t.valueFormatted=this.series[0].alias;else if(A.a.isString(r))t.value=0,t.valueFormatted=A.a.escape(r),t.valueRounded=0;else if("last_time"===this.panel.valueName){var n=J.a.valueFormats[this.panel.format];t.value=a[1],t.valueRounded=t.value,t.valueFormatted=n(t.value,this.dashboard.isTimezoneUtc())}else{t.value=this.series[0].stats[this.panel.valueName],t.flotpairs=this.series[0].flotpairs;var i=this.getDecimalsForValue(t.value);n=J.a.valueFormats[this.panel.format];t.valueFormatted=n(t.value,i.decimals,i.scaledDecimals),t.valueRounded=J.a.roundValue(t.value,i.decimals)}t.scopedVars=A.a.extend({},this.panel.scopedVars),t.scopedVars.__name={value:this.series[0].label}}this.setValueMapping(t)},e.prototype.setValueMapping=function(t){if(1===this.panel.mappingType)for(var e=0;e<this.panel.valueMaps.length;e++){if("null"!==(a=this.panel.valueMaps[e]).value){if(parseFloat(a.value)===t.valueRounded)return void(t.valueFormatted=a.text)}else if(null===t.value||void 0===t.value)return void(t.valueFormatted=a.text)}else if(2===this.panel.mappingType)for(e=0;e<this.panel.rangeMaps.length;e++){var a;if("null"!==(a=this.panel.rangeMaps[e]).from||"null"!==a.to){var r=parseFloat(a.from);if(parseFloat(a.to)>=t.valueRounded&&r<=t.valueRounded)return void(t.valueFormatted=a.text)}else if(null===t.value||void 0===t.value)return void(t.valueFormatted=a.text)}null!==t.value&&void 0!==t.value||(t.valueFormatted="no value")},e.prototype.removeValueMap=function(t){var e=A.a.indexOf(this.panel.valueMaps,t);this.panel.valueMaps.splice(e,1),this.render()},e.prototype.addValueMap=function(){this.panel.valueMaps.push({value:"",op:"=",text:""})},e.prototype.removeRangeMap=function(t){var e=A.a.indexOf(this.panel.rangeMaps,t);this.panel.rangeMaps.splice(e,1),this.render()},e.prototype.addRangeMap=function(){this.panel.rangeMaps.push({from:"",to:"",text:""})},e.prototype.link=function(t,e,a,r){var n,i,s=this.$location,o=this.linkSrv,l=this.$timeout,u=r.panel,c=this.templateSrv,h=e.find(".panel-container");function p(t,e){var a=$i(n,t);return a?'<span style="color:'+a+'">'+e+"</span>":e}function d(t,e,a){return'<span class="'+t+'" style="font-size:'+e+'">'+(a=c.replace(a,n.scopedVars))+"</span>"}function m(){var t=e.width(),a=e.height(),i=Math.min(t,1.3*a);if(r.invalidGaugeRange=!1,u.gauge.minValue>u.gauge.maxValue)r.invalidGaugeRange=!0;else{var s=F()("<div></div>"),o={top:"10px",margin:"auto",position:"relative",height:.9*a+"px",width:i+"px"};s.css(o);for(var l=[],h=0;h<n.thresholds.length;h++)l.push({value:n.thresholds[h],color:n.colorMap[h]});l.push({value:u.gauge.maxValue,color:n.colorMap[n.colorMap.length-1]});var p=kt.a.bootData.user.lightTheme?"rgb(230,230,230)":"rgb(38,38,38)",d=parseInt(u.valueFontSize,10)/100,m=Math.min(i/5,100)*d,f=u.gauge.thresholdLabels?1.5:1,g=Math.min(i/6,60)/f,v=g/5,y=m/2.5,b={series:{gauges:{gauge:{min:u.gauge.minValue,max:u.gauge.maxValue,background:{color:p},border:{color:null},shadow:{show:!1},width:g},frame:{show:!1},label:{show:!1},layout:{margin:0,thresholdWidth:0},cell:{border:{width:0}},threshold:{values:l,label:{show:u.gauge.thresholdLabels,margin:v+1,font:{size:y}},show:u.gauge.thresholdMarkers,width:v},value:{color:u.colorValue?$i(n,n.valueRounded):null,formatter:function(){return function(){var t=u.prefix?c.replace(u.prefix,n.scopedVars):"";return t+=n.valueFormatted,t+=u.postfix?c.replace(u.postfix,n.scopedVars):""}()},font:{size:m,family:'"Helvetica Neue", Helvetica, Arial, sans-serif'}},show:!0}}};e.append(s);var S={data:[[0,n.valueRounded]]};F.a.plot(s,[S],b)}}function f(){var t=e.width()+20;if(t<30)setTimeout(f,30);else{var a=r.height,i=F()("<div></div>"),s={position:"absolute"};if(u.sparkline.full){s.bottom="5px",s.left="-5px",s.width=t-10+"px";var o=a<=100?5:15*Math.round(a/100)+5;s.height=a-o+"px"}else s.bottom="0px",s.left="-5px",s.width=t-10+"px",s.height=Math.floor(.25*a)+"px";i.css(s);var l={legend:{show:!1},series:{lines:{show:!0,fill:1,zero:!1,lineWidth:1,fillColor:u.sparkline.fillColor}},yaxes:{show:!1},xaxis:{show:!1,mode:"time",min:r.range.from.valueOf(),max:r.range.to.valueOf()},grid:{hoverable:!1,show:!1}};e.append(i);var c={data:n.flotpairs,color:u.sparkline.lineColor};F.a.plot(i,[c],l)}}function g(){if(r.data){(n=r.data).thresholds=u.thresholds.split(",").map(function(t){return Number(t.trim())}),n.colorMap=u.colors;var a=u.gauge.show?"":function(){var t='<div class="singlestat-panel-value-container">';if(u.prefix){var e=u.prefix;u.colorPrefix&&(e=p(n.value,u.prefix)),t+=d("singlestat-panel-prefix",u.prefixFontSize,e)}var a=n.valueFormatted;if(u.colorValue&&(a=p(n.value,a)),t+=d("singlestat-panel-value",u.valueFontSize,a),u.postfix){var r=u.postfix;u.colorPostfix&&(r=p(n.value,u.postfix)),t+=d("singlestat-panel-postfix",u.postfixFontSize,r)}return t+="</div>"}();if(u.colorBackground){var s=$i(n,n.value);s&&(h.css("background-color",s),t.fullscreen?e.css("background-color",s):e.css("background-color",""))}else h.css("background-color",""),e.css("background-color","");e.html(a),u.sparkline.show&&f(),u.gauge.show&&m(),e.toggleClass("pointer",u.links.length>0),i=u.links.length>0?o.getPanelLinkAnchorInfo(u.links[0],n.scopedVars):null}}e=e.find(".singlestat-panel"),function(){var t=F()('<div id="tooltip" class="">hello</div>"');e.mouseleave(function(){0!==u.links.length&&l(function(){t.detach()})}),e.click(function(e){i&&(F()(e).parents(".panel-header").length>0||("_blank"!==i.target?(0===i.href.indexOf("http")?window.location.href=i.href:l(function(){s.url(i.href)}),t.detach()):window.open(i.href,"_blank")))}),e.mousemove(function(e){i&&(t.text("click to go to: "+i.title),t.place_tt(e.pageX,e.pageY-50))})}(),this.events.on("render",function(){g(),r.renderingCompleted()})},e.templateUrl="module.html",e}(Bt);function $i(t,e){if(!A.a.isFinite(e))return null;for(var a=t.thresholds.length;a>0;a--)if(e>=t.thresholds[a-1])return t.colorMap[a];return A.a.first(t.colorMap)}var Pi=function(t){function e(e,a,r,n,i){var s=t.call(this,e,a)||this;return s.backendSrv=r,s.$q=i,s.stepIndex=0,s.steps=[],s.steps.push({title:"安装 Grafana",icon:"icon-gf icon-gf-check",href:"http://docs.grafana.org/",target:"_blank",note:"查看安装过程文档",check:function(){return i.when(!0)}}),s.steps.push({title:"添加你的第一个数据源",cta:"添加数据源",icon:"icon-gf icon-gf-datasources",href:"datasources/new?gettingstarted",check:function(){return i.when(n.getMetricSources().filter(function(t){return!0!==t.meta.builtIn}).length>0)}}),s.steps.push({title:"添加你的第一个仪表盘",cta:"创建仪表盘",icon:"icon-gf icon-gf-dashboard",href:"dashboard/new?gettingstarted",check:function(){return s.backendSrv.search({limit:1}).then(function(t){return t.length>0})}}),s.steps.push({title:"邀请你的团队",cta:"添加成员",icon:"icon-gf icon-gf-users",href:"org/users?gettingstarted",check:function(){return s.backendSrv.get("/api/org/users").then(function(t){return t.length>1})}}),s.steps.push({title:"安装应用与插件",cta:"探索插件仓库",icon:"icon-gf icon-gf-apps",href:"https://grafana.com/plugins?utm_source=grafana_getting_started",check:function(){return s.backendSrv.get("/api/plugins",{embedded:0,core:0}).then(function(t){return t.length>0})}}),s}return e.$inject=["$scope","$injector","backendSrv","datasourceSrv","$q"],Rt.d(e,t),e.prototype.$onInit=function(){var t=this;return this.stepIndex=-1,this.nextStep().then(function(e){t.checksDone=!0})},e.prototype.nextStep=function(){var t=this;if(this.stepIndex===this.steps.length-1)return this.$q.when();this.stepIndex+=1;var e=this.steps[this.stepIndex];return e.check().then(function(a){return a?(e.cssClass="completed",t.nextStep()):(e.cssClass="active",t.$q.when())})},e.prototype.dismiss=function(){this.dashboard.removePanel(this.panel,!1),this.backendSrv.request({method:"PUT",url:"/api/user/helpflags/1",showSuccessAlert:!1}).then(function(t){j.c.user.helpFlags1=t.helpFlags1})},e.templateUrl="public/app/plugins/panel/gettingstarted/module.html",e}(qt),Ei={"app/plugins/datasource/graphite/module":s,"app/plugins/datasource/cloudwatch/module":o,"app/plugins/datasource/elasticsearch/module":l,"app/plugins/datasource/opentsdb/module":u,"app/plugins/datasource/grafana/module":c,"app/plugins/datasource/influxdb/module":h,"app/plugins/datasource/logging/module":p,"app/plugins/datasource/mixed/module":d,"app/plugins/datasource/mysql/module":m,"app/plugins/datasource/postgres/module":f,"app/plugins/datasource/mssql/module":v,"app/plugins/datasource/prometheus/module":g,"app/plugins/datasource/testdata/module":y,"app/plugins/panel/text/module":b,"app/plugins/panel/graph/module":S,"app/plugins/panel/dashlist/module":x,"app/plugins/panel/pluginlist/module":w,"app/plugins/panel/alertlist/module":k,"app/plugins/panel/heatmap/module":C,"app/plugins/panel/table/module":T,"app/plugins/panel/singlestat/module":_,"app/plugins/panel/gettingstarted/module":M},Ai=a(42),Di=a(1202),Fi=(a(1203),a(1204),a(1205),a(1206),a(1223),"?_cache="+Date.now());function Ii(t,e){Dt.a.registerDynamic(t,[],!0,function(t,a,r){r.exports=e})}Dt.a.registry.set("plugin-loader",Dt.a.newModule({locate:function(t){return t.address+Fi}})),Dt.a.config({baseURL:"public",defaultExtension:"js",packages:{plugins:{defaultExtension:"js"}},map:{text:"vendor/plugin-text/text.js",css:"vendor/plugin-css/css.js"},meta:{"/*":{esModule:!0,authorization:!0,loader:"plugin-loader"}}}),Ii("lodash",A.a),Ii("moment",L.a),Ii("jquery",F.a),Ii("angular",P.a),Ii("d3",Rn),Ii("rxjs/Subject",Di.Subject),Ii("rxjs/Observable",Ai.Observable),Ii("prismjs",Kt.a),Ii("slate",Jt.o),Ii("slate-react",Xt.b),Ii("slate-plain-serializer",Zt.a),Ii("react",ee.a),Ii("react-dom",re.a),Ii("vendor/npm/rxjs/Rx",{Subject:Di.Subject,Observable:Ai.Observable}),Ii("app/features/dashboard/impression_store",{impressions:Pe.a,__esModule:!0}),Ii("app/plugins/sdk",r),Ii("app/core/utils/datemath",Vt),Ii("app/core/utils/file_export",n),Ii("app/core/utils/flatten",i),Ii("app/core/utils/kbn",J.a),Ii("app/core/utils/ticks",$e),Ii("app/core/config",kt.a),Ii("app/core/time_series",ne.a),Ii("app/core/time_series2",ne.a),Ii("app/core/table_model",ie.a),Ii("app/core/app_events",j.b),Ii("app/core/core_module",j.d),Ii("app/core/core",{coreModule:j.d,appEvents:j.b,contextSrv:j.c,__esModule:!0});for(var Oi=0,qi=["jquery.flot","jquery.flot.pie","jquery.flot.time","jquery.flot.fillbelow","jquery.flot.crosshair","jquery.flot.stack","jquery.flot.selection","jquery.flot.stackpercent","jquery.flot.events","jquery.flot.gauge"];Oi<qi.length;Oi++){Ii(qi[Oi],{fakeDep:1})}function Ri(t){var e=Ei[t];return e?Promise.resolve(e):Dt.a.import(t)}function Ni(t){kt.a.bootData.user.lightTheme?Dt.a.import(t.light+"!css"):Dt.a.import(t.dark+"!css")}var Vi=function(){function t(t,e,a,r){this.$q=t,this.$injector=e,this.$rootScope=a,this.templateSrv=r,this.init()}return t.$inject=["$q","$injector","$rootScope","templateSrv"],t.prototype.init=function(){this.datasources={}},t.prototype.get=function(t){return t?"default"===(t=this.templateSrv.replace(t))?this.get(kt.a.defaultDatasource):this.datasources[t]?this.$q.when(this.datasources[t]):this.loadDatasource(t):this.get(kt.a.defaultDatasource)},t.prototype.loadDatasource=function(t){var e=this,a=kt.a.datasources[t];if(!a)return this.$q.reject({message:"找不到名为： "+t+" 的数据源"});var r=this.$q.defer(),n=a.meta;return Ri(n.module).then(function(i){if(e.datasources[t])r.resolve(e.datasources[t]);else{if(!i.Datasource)throw new Error("Plugin module is missing Datasource constructor");var s=e.$injector.instantiate(i.Datasource,{instanceSettings:a});s.meta=n,s.name=t,e.datasources[t]=s,r.resolve(s)}}).catch(function(t){e.$rootScope.appEvent("alert-error",[a.name+" plugin failed",t.toString()])}),r.promise},t.prototype.getAll=function(){return kt.a.datasources},t.prototype.getAnnotationSources=function(){var t=[];return this.addDataSourceVariables(t),A.a.each(kt.a.datasources,function(e){e.meta&&e.meta.annotations&&t.push(e)}),t},t.prototype.getExploreSources=function(){var t=kt.a.datasources,e=Object.keys(t).map(function(e){return t[e]}).filter(function(t){return t.meta&&t.meta.explore});return A.a.sortBy(e,["name"])},t.prototype.getMetricSources=function(t){var e=[];return A.a.each(kt.a.datasources,function(t,a){if(t.meta&&t.meta.metrics){var r={value:a,name:a,meta:t.meta,sort:a};"grafana"===t.meta.id?r.sort=String.fromCharCode(253):"mixed"===t.meta.id&&(r.sort=String.fromCharCode(254)),e.push(r),a===kt.a.defaultDatasource&&(r={value:null,name:"default",meta:t.meta,sort:a},e.push(r))}}),t&&t.skipVariables||this.addDataSourceVariables(e),e.sort(function(t,e){return t.sort.toLowerCase()>e.sort.toLowerCase()?1:t.sort.toLowerCase()<e.sort.toLowerCase()?-1:0}),e},t.prototype.addDataSourceVariables=function(t){for(var e=0;e<this.templateSrv.variables.length;e++){var a=this.templateSrv.variables[e];if("datasource"===a.type){var r=a.current.value;"default"===r&&(r=kt.a.defaultDatasource);var n=kt.a.datasources[r];if(n){var i="$"+a.name;t.push({name:i,value:i,meta:n.meta,sort:i})}}}},t}();I.a.service("datasourceSrv",Vi);var Li=function(t){function e(e,a){return t.call(this,e,a)||this}return e.$inject=["$scope","$injector"],Rt.d(e,t),e.templateUrl="public/app/plugins/panel/unknown/module.html",e}(qt);function ji(t,e,a,r,n,i){function s(t,e){if(t)return 0===t.indexOf("public")?t:e+"/"+t}function o(t,e){var a={name:"panel-plugin-"+t.panel.type,bindings:{dashboard:"=",panel:"=",row:"="},attrs:{dashboard:"dashboard",panel:"panel",class:"panel-height-helper"}},o=kt.a.panels[t.panel.type],l=Promise.resolve(Li);return o&&(l=Ri(o.module).then(function(t){return t.PanelCtrl})),l.then(function(t){return a.Component=t,!t||t.registered?a:t.templatePromise?t.templatePromise.then(function(t){return a}):(o&&(t.templateUrl=s(t.templateUrl,o.baseUrl)),t.templatePromise=function(t){if(t.template)return r.when(t.template);var e=i.get(t.templateUrl);return e?r.when(e):n.get(t.templateUrl).then(function(t){return t.data})}(t).then(function(e){return t.templateUrl=null,t.template='<grafana-panel ctrl="ctrl" class="panel-height-helper">'+e+"</grafana-panel>",a}),t.templatePromise)})}function l(e,a,r,n){if(n.notFound)a.empty();else{if(!n.Component)throw{message:"Failed to find exported plugin component for "+n.name};if(!n.Component.registered){var i=r.$normalize(n.name),o=function(t){return t.Component.templateUrl=s(t.Component.templateUrl,t.baseUrl),function(){return{templateUrl:t.Component.templateUrl,template:t.Component.template,restrict:"E",controller:t.Component,controllerAs:"ctrl",bindToController:!0,scope:t.bindings,link:function(t,e,a,r){r.link&&r.link(t,e,a,r),r.init&&r.init()}}}}(n);I.a.directive(i,o),n.Component.registered=!0}!function(e,a,r){var n=P.a.element(document.createElement(r.name));A.a.each(r.attrs,function(t,e){n.attr(e,t)}),t(n)(e),a.empty(),setTimeout(function(){a.append(n),e.$applyAsync(function(){e.$broadcast("component-did-mount"),e.$broadcast("refresh")})})}(e,a,n)}}return{restrict:"E",link:function(t,n,i){(function(t,a){switch(a.type){case"query-ctrl":var n=t.target.datasource||t.ctrl.panel.datasource;return e.get(n).then(function(e){return t.datasource=e,Ri(e.meta.module).then(function(t){return{baseUrl:e.meta.baseUrl,name:"query-ctrl-"+e.meta.id,bindings:{target:"=",panelCtrl:"=",datasource:"="},attrs:{target:"target","panel-ctrl":"ctrl.panelCtrl",datasource:"datasource"},Component:t.QueryCtrl}})});case"annotations-query-ctrl":return Ri(t.ctrl.currentDatasource.meta.module).then(function(e){return{baseUrl:t.ctrl.currentDatasource.meta.baseUrl,name:"annotations-query-ctrl-"+t.ctrl.currentDatasource.meta.id,bindings:{annotation:"=",datasource:"="},attrs:{annotation:"ctrl.currentAnnotation",datasource:"ctrl.currentDatasource"},Component:e.AnnotationsQueryCtrl}});case"datasource-config-ctrl":var i=t.ctrl.datasourceMeta;return Ri(i.module).then(function(t){return t.ConfigCtrl?{baseUrl:i.baseUrl,name:"ds-config-"+i.id,bindings:{meta:"=",current:"="},attrs:{meta:"ctrl.datasourceMeta",current:"ctrl.current"},Component:t.ConfigCtrl}:{notFound:!0}});case"app-config-ctrl":var s=t.ctrl.model;return Ri(s.module).then(function(t){return{baseUrl:s.baseUrl,name:"app-config-"+s.id,bindings:{appModel:"=",appEditCtrl:"="},attrs:{"app-model":"ctrl.model","app-edit-ctrl":"ctrl"},Component:t.ConfigCtrl}});case"app-page":var l=t.ctrl.appModel;return Ri(l.module).then(function(e){return{baseUrl:l.baseUrl,name:"app-page-"+l.id+"-"+t.ctrl.page.slug,bindings:{appModel:"="},attrs:{"app-model":"ctrl.appModel"},Component:e[t.ctrl.page.component]}});case"panel":return o(t);default:return r.reject({message:"Could not find component type: "+a.type})}})(t,i).then(function(e){l(t,n,i,e)}).catch(function(t){a.appEvent("alert-error",["插件报错",t.message||t]),console.log("Plugin component error",t)})}}}I.a.directive("pluginComponent",ji);var Ui=function(){function t(t,e,a,r,n,i,s,o,l,u,c){this.$scope=t,this.$rootScope=e,this.keybindingSrv=a,this.timeSrv=r,this.variableSrv=n,this.alertingSrv=i,this.dashboardSrv=s,this.unsavedChangesSrv=o,this.dashboardViewStateSrv=l,this.playlistSrv=u,this.panelLoader=c,t.ctrl=this,this.editTab=0,this.getPanelContainer=this.getPanelContainer.bind(this)}return t.$inject=["$scope","$rootScope","keybindingSrv","timeSrv","variableSrv","alertingSrv","dashboardSrv","unsavedChangesSrv","dashboardViewStateSrv","playlistSrv","panelLoader"],t.prototype.setupDashboard=function(t){try{this.setupDashboardInternal(t)}catch(t){this.onInitFailed(t,"仪表盘初始化失败",!0)}},t.prototype.setupDashboardInternal=function(t){var e=this,a=this.dashboardSrv.create(t.dashboard,t.meta);this.dashboardSrv.setCurrent(a),this.timeSrv.init(a),this.alertingSrv.init(a,t.alerts),this.variableSrv.init(a).catch(this.onInitFailed.bind(this,"模板初始化失败",!1)).finally(function(){e.dashboard=a,e.dashboard.processRepeats(),e.dashboard.updateSubmenuVisibility(),e.dashboard.autoFitPanels(window.innerHeight),e.unsavedChangesSrv.init(a,e.$scope),e.$scope.dashboard=a,e.dashboardViewState=e.dashboardViewStateSrv.create(e.$scope),e.keybindingSrv.setupDashboardBindings(e.$scope,a),e.setWindowTitleAndTheme(),e.$scope.appEvent("dashboard-initialized",a)}).catch(this.onInitFailed.bind(this,"仪表盘初始化失败",!0))},t.prototype.onInitFailed=function(t,e,a){console.log(t,a),a.data&&a.data.message?a.message=a.data.message:a.message||(a={message:a.toString()}),this.$scope.appEvent("alert-error",[t,a.message]),e&&!this.loadedFallbackDashboard&&(this.loadedFallbackDashboard=!0,this.setupDashboard({dashboard:{title:"仪表盘初始化失败"}}))},t.prototype.templateVariableUpdated=function(){this.dashboard.processRepeats()},t.prototype.setWindowTitleAndTheme=function(){window.document.title=kt.a.windowTitlePrefix+this.dashboard.title},t.prototype.showJsonEditor=function(t,e){var a=this.$rootScope.$new();a.object=e.object,a.updateHandler=e.updateHandler,this.$scope.appEvent("show-dash-editor",{src:"public/app/partials/edit_json.html",scope:a})},t.prototype.getDashboard=function(){return this.dashboard},t.prototype.getPanelLoader=function(){return this.panelLoader},t.prototype.timezoneChanged=function(){this.$rootScope.$broadcast("refresh")},t.prototype.getPanelContainer=function(){return this},t.prototype.onRemovingPanel=function(t,e){if((e=e||{}).panelId){var a=this.dashboard.getPanelInfoById(e.panelId);this.removePanel(a.panel,!0)}},t.prototype.removePanel=function(t,e){var a=this;if(!1!==e){var r=void 0,n=void 0;return t.alert&&(r="面板包含告警规则，删除面板也将删除告警规则",n="确认"),void this.$scope.appEvent("confirm-modal",{title:"删除面板",text:"确定要删除此面板吗?",text2:r,icon:"fa-trash",confirmText:n,yesText:"删除",onConfirm:function(){a.removePanel(t,!1)}})}this.dashboard.removePanel(t)},t.prototype.init=function(t){this.$scope.onAppEvent("show-json-editor",this.showJsonEditor.bind(this)),this.$scope.onAppEvent("template-variable-value-updated",this.templateVariableUpdated.bind(this)),this.$scope.onAppEvent("panel-remove",this.onRemovingPanel.bind(this)),this.setupDashboard(t)},t}();I.a.controller("DashboardCtrl",Ui);var Bi=function(){function t(){}return t.prototype.init=function(t,e){this.dashboard=t,this.alerts=e||[]},t}();I.a.service("alertingSrv",Bi);var Qi=function(){function t(t){this.backendSrv=t}return t.$inject=["backendSrv"],t.prototype.getHistoryList=function(t,e){var a=t&&t.id?t.id:void 0;return a?this.backendSrv.get("api/dashboards/id/"+a+"/versions",e):Promise.resolve([])},t.prototype.calculateDiff=function(t){return this.backendSrv.post("api/dashboards/calculate-diff",t)},t.prototype.restoreDashboard=function(t,e){var a=t&&t.id?t.id:void 0,r="api/dashboards/id/"+a+"/restore";return a&&A.a.isNumber(e)?this.backendSrv.post(r,{version:e}):Promise.resolve({})},t}();I.a.service("historySrv",Qi);var Hi=function(){function t(t,e,a,r,n,i){this.$route=t,this.$rootScope=e,this.$location=a,this.$q=r,this.historySrv=n,this.$scope=i,this.appending=!1,this.diff="basic",this.limit=10,this.loading=!1,this.max=2,this.mode="list",this.start=0,this.canCompare=!1,this.$rootScope.onAppEvent("dashboard-saved",this.onDashboardSaved.bind(this),i),this.resetFromSource()}return t.$inject=["$route","$rootScope","$location","$q","historySrv","$scope"],t.prototype.onDashboardSaved=function(){this.resetFromSource()},t.prototype.switchMode=function(t){this.mode=t,"list"===this.mode&&this.reset()},t.prototype.dismiss=function(){this.$rootScope.appEvent("hide-dash-editor")},t.prototype.addToLog=function(){this.start=this.start+this.limit,this.getLog(!0)},t.prototype.revisionSelectionChanged=function(){var t=A.a.filter(this.revisions,{checked:!0}).length;this.canCompare=2===t},t.prototype.formatDate=function(t){return this.dashboard.formatDate(t)},t.prototype.formatBasicDate=function(t){var e="browser"===this.dashboard.timezone?L()():L.a.utc();return("browser"===this.dashboard.timezone?L()(t):L.a.utc(t)).from(e)},t.prototype.getDiff=function(t){var e=this;if(this.diff=t,this.mode="compare",this.delta[this.diff])return this.$q.when(this.delta[this.diff]);var a=A.a.filter(this.revisions,{checked:!0});this.newInfo=a[0],this.baseInfo=a[1],this.isNewLatest=this.newInfo.version===this.dashboard.version,this.loading=!0;var r={new:{dashboardId:this.dashboard.id,version:this.newInfo.version},base:{dashboardId:this.dashboard.id,version:this.baseInfo.version},diffType:t};return this.historySrv.calculateDiff(r).then(function(t){e.delta[e.diff]=t}).catch(function(){e.mode="list"}).finally(function(){e.loading=!1})},t.prototype.getLog=function(t){var e=this;void 0===t&&(t=!1),this.loading=!t,this.appending=t;var a={limit:this.limit,start:this.start};return this.historySrv.getHistoryList(this.dashboard,a).then(function(a){for(var r=0,n=a;r<n.length;r++){var i=n[r];i.createdDateString=e.formatDate(i.created),i.ageString=e.formatBasicDate(i.created),i.checked=!1}e.revisions=t?e.revisions.concat(a):a}).catch(function(t){e.loading=!1}).finally(function(){e.loading=!1,e.appending=!1})},t.prototype.isLastPage=function(){return A.a.find(this.revisions,function(t){return 1===t.version})},t.prototype.reset=function(){this.delta={basic:"",json:""},this.diff="basic",this.mode="list",this.revisions=A.a.map(this.revisions,function(t){return A.a.extend({},t,{checked:!1})}),this.canCompare=!1,this.start=0,this.isNewLatest=!1},t.prototype.resetFromSource=function(){return this.revisions=[],this.getLog().then(this.reset.bind(this))},t.prototype.restore=function(t){this.$rootScope.appEvent("confirm-modal",{title:"还原版本",text:"",text2:"您确定要将仪表盘还原到版本 "+t+"吗？ 所有未保存的更改都将丢失。",icon:"fa-history",yesText:"是的，恢复到版本 "+t,onConfirm:this.restoreConfirm.bind(this,t)})},t.prototype.restoreConfirm=function(t){var e=this;return this.loading=!0,this.historySrv.restoreDashboard(this.dashboard,t).then(function(a){e.$location.url(Lt.b.stripBaseFromUrl(a.url)).replace(),e.$route.reload(),e.$rootScope.appEvent("alert-success",["仪表盘已恢复","恢复到版本 "+t])}).catch(function(){e.mode="list",e.loading=!1})},t}();P.a.module("grafana.directives").directive("gfDashboardHistory",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/history/history.html",controller:Hi,bindToController:!0,controllerAs:"ctrl",scope:{dashboard:"="}}});var zi=function(){function t(t,e,a,r,n,i,s,o,l){this.backendSrv=t,this.dashboardSrv=e,this.datasourceSrv=a,this.$http=r,this.$q=n,this.$timeout=i,this.$routeParams=o,this.$rootScope=l}return t.$inject=["backendSrv","dashboardSrv","datasourceSrv","$http","$q","$timeout","contextSrv","$routeParams","$rootScope"],t.prototype._dashboardLoadFailed=function(t,e){return{meta:{canStar:!1,isSnapshot:e=e||!1,canDelete:!1,canSave:!1,canEdit:!1,dashboardNotFound:!0},dashboard:{title:t}}},t.prototype.loadDashboard=function(t,e,a){var r,n=this;return(r="script"===t?this._loadScriptedDashboard(e):"snapshot"===t?this.backendSrv.get("/api/snapshots/"+e).catch(function(){return n._dashboardLoadFailed("未找到快照",!0)}):this.backendSrv.getDashboardByUid(a).then(function(t){if(t.meta.isFolder)throw n.$rootScope.appEvent("alert-error",["未找到仪表盘"]),new Error("Dashboard not found");return t}).catch(function(){return n._dashboardLoadFailed("未找到",!0)})).then(function(t){return!0!==t.meta.dashboardNotFound&&Pe.a.addDashboardImpression(t.dashboard.id),t}),r},t.prototype._loadScriptedDashboard=function(t){var e=this,a="public/dashboards/"+t.replace(/\.(?!js)/,"/")+"?"+(new Date).getTime();return this.$http({url:a,method:"GET"}).then(this._executeScript.bind(this)).then(function(t){return{meta:{fromScript:!0,canDelete:!1,canSave:!1,canStar:!1},dashboard:t.data}},function(t){return console.log("Script dashboard error "+t),e.$rootScope.appEvent("alert-error",["脚本错误","请确保它存在并返回有效的仪表盘"]),e._dashboardLoadFailed("Scripted dashboard")})},t.prototype._executeScript=function(t){var e=this,a={dashboardSrv:this.dashboardSrv,datasourceSrv:this.datasourceSrv,$q:this.$q},r=new Function("ARGS","kbn","dateMath","_","moment","window","document","$","jQuery","services",t.data)(this.$routeParams,J.a,Vt,A.a,L.a,window,document,F.a,F.a,a);if(A.a.isFunction(r)){var n=this.$q.defer();return r(function(t){e.$timeout(function(){n.resolve({data:t})})}),n.promise}return{data:r}},t}();P.a.module("grafana.services").service("dashboardLoaderSrv",zi);var Yi=function(){function t(t,e,a,r){if(this.$scope=t,this.dashboardSrv=e,this.$location=a,this.playlistSrv=r,j.b.on("save-dashboard",this.saveDashboard.bind(this),t),this.dashboard.meta.isSnapshot){var n=this.dashboard.meta;this.titleTooltip="创建于: &nbsp;"+L()(n.created).calendar(),n.expires&&(this.titleTooltip+="<br>失效于: &nbsp;"+L()(n.expires).fromNow()+"<br>")}}return t.$inject=["$scope","dashboardSrv","$location","playlistSrv"],t.prototype.toggleSettings=function(){var t=this.$location.search();t.editview?delete t.editview:t.editview="settings",this.$location.search(t)},t.prototype.toggleViewMode=function(){j.b.emit("toggle-kiosk-mode")},t.prototype.close=function(){var t=this.$location.search();t.editview?delete t.editview:t.fullscreen&&(delete t.fullscreen,delete t.edit),this.$location.search(t)},t.prototype.starDashboard=function(){var t=this;this.dashboardSrv.starDashboard(this.dashboard.id,this.dashboard.meta.isStarred).then(function(e){t.dashboard.meta.isStarred=e})},t.prototype.shareDashboard=function(t){var e=this.$scope.$new();e.tabIndex=t,e.dashboard=this.dashboard,j.b.emit("show-modal",{src:"public/app/features/dashboard/partials/shareModal.html",scope:e})},t.prototype.hideTooltip=function(t){P.a.element(t.currentTarget).tooltip("hide")},t.prototype.saveDashboard=function(){return this.dashboardSrv.saveDashboard()},t.prototype.showSearch=function(){j.b.emit("show-dash-search")},t.prototype.addPanel=function(){j.b.emit("dash-scroll",{animate:!0,evt:0}),this.dashboard.panels.length>0&&"add-panel"===this.dashboard.panels[0].type||this.dashboard.addPanel({type:"add-panel",gridPos:{x:0,y:0,w:12,h:9},title:"面板标题"})},t.prototype.navItemClicked=function(t,e){t.clickHandler&&(t.clickHandler(),e.preventDefault())},t}();P.a.module("grafana.directives").directive("dashnav",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/dashnav/dashnav.html",controller:Yi,bindToController:!0,controllerAs:"ctrl",transclude:!0,scope:{dashboard:"="}}});var Wi=function(){function t(t,e,a){this.$rootScope=t,this.variableSrv=e,this.$location=a,this.annotations=this.dashboard.templating.list,this.variables=this.variableSrv.variables}return t.$inject=["$rootScope","variableSrv","$location"],t.prototype.annotationStateChanged=function(){this.$rootScope.$broadcast("refresh")},t.prototype.variableUpdated=function(t){this.variableSrv.variableUpdated(t,!0)},t.prototype.openEditView=function(t){var e=A.a.extend(this.$location.search(),{editview:t});this.$location.search(e)},t}();P.a.module("grafana.directives").directive("dashboardSubmenu",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/submenu/submenu.html",controller:Wi,bindToController:!0,controllerAs:"ctrl",scope:{dashboard:"="}}});var Gi='\n<div class="modal-body">\n\t<div class="modal-header">\n\t\t<h2 class="modal-header-title">\n\t\t\t<i class="fa fa-copy"></i>\n\t\t\t<span class="p-l-1">另存为...</span>\n\t\t</h2>\n\n\t\t<a class="modal-header-close" ng-click="ctrl.dismiss();">\n\t\t\t<i class="fa fa-remove"></i>\n\t\t</a>\n\t</div>\n\n\t<form name="ctrl.saveForm" class="modal-content" novalidate>\n\t\t<div class="p-t-2">\n\t\t\t<div class="gf-form">\n\t\t\t\t<label class="gf-form-label width-7">新名称</label>\n\t\t\t\t<input type="text" class="gf-form-input" ng-model="ctrl.clone.title" give-focus="true" required>\n\t\t\t</div>\n      <div class="gf-form">\n        <folder-picker initial-folder-id="ctrl.folderId"\n                       on-change="ctrl.onFolderChange($folder)"\n                       enter-folder-creation="ctrl.onEnterFolderCreation()"\n                       exit-folder-creation="ctrl.onExitFolderCreation()"\n                       enable-create-new="true"\n                       label-class="width-7">\n        </folder-picker>\n      </div>\n\t\t</div>\n\n\t\t<div class="gf-form-button-row text-center">\n\t\t\t<button type="submit" class="btn btn-success" ng-click="ctrl.save()" ng-disabled="!ctrl.isValidFolderSelection">保存</button>\n\t\t\t<a class="btn-text" ng-click="ctrl.dismiss();">取消</a>\n\t\t</div>\n\t</form>\n</div>\n',Ki=function(){function t(t){this.dashboardSrv=t,this.isValidFolderSelection=!0;var e=this.dashboardSrv.getCurrent();this.clone=e.getSaveModelClone(),this.clone.id=null,this.clone.uid="",this.clone.title+=" 副本",this.clone.editable=!0,this.clone.hideControls=!1,this.folderId=e.meta.folderId,e.id>0&&this.clone.panels.forEach(function(t){"graph"===t.type&&t.alert&&delete t.thresholds,delete t.alert}),delete this.clone.autoUpdate}return t.$inject=["dashboardSrv"],t.prototype.save=function(){return this.dashboardSrv.save(this.clone,{folderId:this.folderId}).then(this.dismiss)},t.prototype.keyDown=function(t){13===t.keyCode&&this.save()},t.prototype.onFolderChange=function(t){this.folderId=t.id},t.prototype.onEnterFolderCreation=function(){this.isValidFolderSelection=!1},t.prototype.onExitFolderCreation=function(){this.isValidFolderSelection=!0},t}();I.a.directive("saveDashboardAsModal",function(){return{restrict:"E",template:Gi,controller:Ki,bindToController:!0,controllerAs:"ctrl",scope:{dismiss:"&"}}});var Ji='\n<div class="modal-body">\n  <div class="modal-header">\n    <h2 class="modal-header-title">\n      <i class="fa fa-save"></i>\n      <span class="p-l-1">保存更改</span>\n    </h2>\n\n    <a class="modal-header-close" ng-click="ctrl.dismiss();">\n      <i class="fa fa-remove"></i>\n    </a>\n  </div>\n\n  <form name="ctrl.saveForm" ng-submit="ctrl.save()" class="modal-content" novalidate>\n    <div class="p-t-1">\n      <div class="gf-form-group" ng-if="ctrl.timeChange || ctrl.variableValueChange">\n\t\t    <gf-form-switch class="gf-form"\n\t\t\t    label="保存当前的时间范围" ng-if="ctrl.timeChange" label-class="width-12" switch-class="max-width-6"\n\t\t\t    checked="ctrl.saveTimerange" on-change="buildUrl()">\n\t\t    </gf-form-switch>\n\t\t    <gf-form-switch class="gf-form"\n\t\t\t    label="保存当前的所有变量" ng-if="ctrl.variableValueChange" label-class="width-12" switch-class="max-width-6"\n\t\t\t    checked="ctrl.saveVariables" on-change="buildUrl()">\n\t\t    </gf-form-switch>\n\t    </div>\n      <div class="gf-form">\n        <label class="gf-form-hint">\n          <input\n            type="text"\n            name="message"\n            class="gf-form-input"\n            placeholder="添加备注以描述您的更改 &hellip;"\n            give-focus="true"\n            ng-model="ctrl.message"\n            ng-model-options="{allowInvalid: true}"\n            ng-maxlength="this.max"\n            maxlength="64"\n            autocomplete="off" />\n          <small class="gf-form-hint-text muted" ng-cloak>\n            <span ng-class="{\'text-error\': ctrl.saveForm.message.$invalid && ctrl.saveForm.message.$dirty }">\n              {{ctrl.message.length || 0}}\n            </span>\n            / {{ctrl.max}} 字符\n          </small>\n        </label>\n      </div>\n    </div>\n\n    <div class="gf-form-button-row text-center">\n      <button\n        id="saveBtn"\n        type="submit"\n        class="btn btn-success"\n        ng-class="{\'btn-success--processing\': ctrl.isSaving}"\n        ng-disabled="ctrl.saveForm.$invalid || ctrl.isSaving"\n      >\n        <span ng-if="!ctrl.isSaving">保存</span>\n        <span ng-if="ctrl.isSaving === true">保存中...</span>\n      </button>\n      <button class="btn btn-inverse" ng-click="ctrl.dismiss();">取消</button>\n    </div>\n  </form>\n</div>\n',Xi=function(){function t(t){this.dashboardSrv=t,this.saveVariables=!1,this.saveTimerange=!1,this.current=[],this.originalCurrent=[],this.timeChange=!1,this.variableValueChange=!1,this.message="",this.max=64,this.isSaving=!1,this.timeChange=this.dashboardSrv.getCurrent().hasTimeChanged(),this.variableValueChange=this.dashboardSrv.getCurrent().hasVariableValuesChanged()}return t.$inject=["dashboardSrv"],t.prototype.save=function(){if(this.saveForm.$valid){var t={saveVariables:this.saveVariables,saveTimerange:this.saveTimerange,message:this.message},e=this.dashboardSrv.getCurrent().getSaveModelClone(t);return this.isSaving=!0,this.dashboardSrv.save(e,t).then(this.postSave.bind(this,t))}},t.prototype.postSave=function(t){t.saveVariables&&this.dashboardSrv.getCurrent().resetOriginalVariables(),t.saveTimerange&&this.dashboardSrv.getCurrent().resetOriginalTime(),this.dismiss()},t}();I.a.directive("saveDashboardModal",function(){return{restrict:"E",template:Ji,controller:Xi,bindToController:!0,controllerAs:"ctrl",scope:{dismiss:"&"}}});var Zi='\n<div class="modal-body">\n  <div class="modal-header">\n    <h2 class="modal-header-title">\n      <i class="fa fa-save"></i><span class="p-l-1">无法保存配置的仪表盘</span>\n    </h2>\n\n    <a class="modal-header-close" ng-click="ctrl.dismiss();">\n      <i class="fa fa-remove"></i>\n    </a>\n  </div>\n\n  <div class="modal-content">\n    <small>\n      此仪表盘无法从Grafana的UI中保存，因为它已从其他来源进行配置。\n      复制JSON或将其保存到下面的文件中。 然后，您可以在相应的配置源中更新仪表盘。<br/>\n      <i>查看 <a class="external-link" href="http://docs.grafana.org/administration/provisioning/#dashboards" target="_blank">\n      文档</a> 获取有关配置的更多信息。</i>\n    </small>\n    <div class="p-t-2">\n      <div class="gf-form">\n        <code-editor content="ctrl.dashboardJson" data-mode="json" data-max-lines=15></code-editor>\n      </div>\n      <div class="gf-form-button-row">\n        <button class="btn btn-success" clipboard-button="ctrl.getJsonForClipboard()">\n          <i class="fa fa-clipboard"></i>&nbsp;将JSON复制到剪贴板\n        </button>\n        <button class="btn btn-secondary" clipboard-button="ctrl.save()">\n          <i class="fa fa-save"></i>&nbsp;将JSON保存到文件\n        </button>\n        <a class="btn btn-link" ng-click="ctrl.dismiss();">取消</a>\n      </div>\n    </div>\n  </div>\n</div>\n',ts=function(){function t(t){this.dash=t.getCurrent().getSaveModelClone(),delete this.dash.id,this.dashboardJson=P.a.toJson(this.dash,!0)}return t.$inject=["dashboardSrv"],t.prototype.save=function(){var t=new Blob([P.a.toJson(this.dash,!0)],{type:"application/json;charset=utf-8"});Object(se.saveAs)(t,this.dash.title+"-"+(new Date).getTime()+".json")},t.prototype.getJsonForClipboard=function(){return this.dashboardJson},t}();function es(t,e,a,r,n,i,s){t.options={forCurrent:!0,includeTemplateVars:!0,theme:"current"},t.editor={index:t.tabIndex||0},t.init=function(){t.modeSharePanel=!!t.panel,t.tabs=[{title:"链接",src:"shareLink.html"}],t.modeSharePanel?(t.modalTitle="共享面板",t.tabs.push({title:"嵌入式",src:"shareEmbed.html"})):t.modalTitle="共享",t.dashboard.meta.isSnapshot||t.tabs.push({title:"快照",src:"shareSnapshot.html"}),t.dashboard.meta.isSnapshot||t.modeSharePanel||t.tabs.push({title:"导出",src:"shareExport.html"}),t.buildUrl()},t.buildUrl=function(){var e=a.absUrl(),r=e.indexOf("?");-1!==r&&(e=e.substring(0,r));var o=P.a.copy(a.search()),l=n.timeRange();o.from=l.from.valueOf(),o.to=l.to.valueOf(),o.orgId=kt.a.bootData.user.orgId,t.options.includeTemplateVars&&i.fillVariableValuesForUrl(o),t.options.forCurrent||(delete o.from,delete o.to),"current"!==t.options.theme&&(o.theme=t.options.theme),t.modeSharePanel?(o.panelId=t.panel.id,o.fullscreen=!0):(delete o.panelId,delete o.fullscreen),t.shareUrl=s.addParamsToUrl(e,o);var u=e.replace(kt.a.appSubUrl+"/dashboard/",kt.a.appSubUrl+"/dashboard-solo/");u=u.replace(kt.a.appSubUrl+"/d/",kt.a.appSubUrl+"/d-solo/"),delete o.fullscreen,delete o.edit,u=s.addParamsToUrl(u,o),t.iframeHtml='<iframe src="'+u+'" width="450" height="200" frameborder="0"></iframe>',t.imageUrl=u.replace(kt.a.appSubUrl+"/dashboard-solo/",kt.a.appSubUrl+"/render/dashboard-solo/"),t.imageUrl=t.imageUrl.replace(kt.a.appSubUrl+"/d-solo/",kt.a.appSubUrl+"/render/d-solo/"),t.imageUrl+="&width=1000&height=500"+t.getLocalTimeZone()},t.getLocalTimeZone=function(){var t="&tz=UTC"+encodeURIComponent(L()().format("Z"));if(!window.Intl)return t;var e=window.Intl.DateTimeFormat();if(!e.resolvedOptions)return t;var a=e.resolvedOptions();return a.timeZone?"&tz="+encodeURIComponent(a.timeZone):t},t.getShareUrl=function(){return t.shareUrl}}I.a.directive("saveProvisionedDashboardModal",function(){return{restrict:"E",template:Zi,controller:ts,bindToController:!0,controllerAs:"ctrl",scope:{dismiss:"&"}}}),P.a.module("grafana.controllers").controller("ShareModalCtrl",es);var as=function(){function t(t,e,a,r,n,i){t.snapshot={name:t.dashboard.title,expires:0,timeoutSeconds:4},t.step=1,t.expireOptions=[{text:"1 小时",value:3600},{text:"1 天",value:86400},{text:"7 天",value:604800},{text:"从不",value:0}],t.accessOptions=[{text:"拥有链接的任何人",value:1},{text:"组织用户",value:2},{text:"在网上公开",value:3}],t.init=function(){r.get("/api/snapshot/shared-options").then(function(e){t.externalUrl=e.externalSnapshotURL,t.sharingButtonText=e.externalSnapshotName,t.externalEnabled=e.externalEnabled})},t.apiUrl="/api/snapshots",t.createSnapshot=function(r){t.dashboard.snapshot={timestamp:new Date},r||(t.dashboard.snapshot.originalUrl=a.absUrl()),t.loading=!0,t.snapshot.external=r,e.$broadcast("refresh"),n(function(){t.saveSnapshot(r)},1e3*t.snapshot.timeoutSeconds)},t.saveSnapshot=function(e){var n=t.dashboard.getSaveModelClone();t.scrubDashboard(n);var i={dashboard:n,name:n.title,expires:t.snapshot.expires},s=e?t.externalUrl+t.apiUrl:t.apiUrl;r.post(s,i).then(function(r){if(t.loading=!1,e)t.deleteUrl=r.deleteUrl,t.snapshotUrl=r.url,t.saveExternalSnapshotRef(i,r);else{var n=a.url(),s=a.absUrl();"/"!==n&&(s=s.replace(n,"")+"/"),t.snapshotUrl=s+"dashboard/snapshot/"+r.key,t.deleteUrl=s+"api/snapshots-delete/"+r.deleteKey}t.step=2},function(){t.loading=!1})},t.getSnapshotUrl=function(){return t.snapshotUrl},t.scrubDashboard=function(e){if(e.title=t.snapshot.name,e.time=i.timeRange(),A.a.each(e.panels,function(t){t.targets=[],t.links=[],t.datasource=null}),e.annotations.list=A.a.chain(e.annotations.list).filter(function(t){return t.enable}).map(function(t){return{name:t.name,enable:t.enable,iconColor:t.iconColor,snapshotData:t.snapshotData,type:t.type,builtIn:t.builtIn,hide:t.hide}}).value(),A.a.each(e.templating.list,function(t){t.query="",t.options=t.current,t.refresh=!1}),t.modeSharePanel){var a=t.panel.getSaveModel();a.gridPos.w=24,a.gridPos.x=0,a.gridPos.y=0,a.gridPos.h=20,e.panels=[a]}delete t.dashboard.snapshot,t.dashboard.forEachPanel(function(t){delete t.snapshotData}),A.a.each(t.dashboard.annotations.list,function(t){delete t.snapshotData})},t.deleteSnapshot=function(){r.get(t.deleteUrl).then(function(){t.step=3})},t.saveExternalSnapshotRef=function(t,e){t.external=!0,t.key=e.key,t.deleteKey=e.deleteKey,r.post("/api/snapshots/",t)}}return t.$inject=["$scope","$rootScope","$location","backendSrv","$timeout","timeSrv"],t}();P.a.module("grafana.controllers").controller("ShareSnapshotCtrl",as);var rs=a(277),ns=function(){function t(t,e,a){this.backendSrv=t,this.$rootScope=e,this.$location=a}return t.$inject=["backendSrv","$rootScope","$location"],t.prototype.create=function(t,e){return new rs.a(t,e)},t.prototype.setCurrent=function(t){this.dash=t},t.prototype.getCurrent=function(){return this.dash},t.prototype.handleSaveDashboardError=function(t,e,a){var r=this;(e=e||{}).overwrite=!0,a.data&&"version-mismatch"===a.data.status&&(a.isHandled=!0,this.$rootScope.appEvent("confirm-modal",{title:"冲突",text:"其他人已更新此仪表盘。",text2:"你还想保存这个仪表盘吗?",yesText:"保存并覆盖",icon:"fa-warning",onConfirm:function(){r.save(t,e)}})),a.data&&"name-exists"===a.data.status&&(a.isHandled=!0,this.$rootScope.appEvent("confirm-modal",{title:"冲突",text:"所选文件夹中已存在相同名称的仪表盘。",text2:"你还想保存这个仪表盘吗?",yesText:"保存并覆盖",icon:"fa-warning",onConfirm:function(){r.save(t,e)}})),a.data&&"plugin-dashboard"===a.data.status&&(a.isHandled=!0,this.$rootScope.appEvent("confirm-modal",{title:"插件仪表盘",text:a.data.message,text2:"更新插件时，您的更改将丢失。 使用“另存为”创建自定义版本。",yesText:"覆盖",icon:"fa-warning",altActionText:"另存为",onAltAction:function(){r.showSaveAsModal()},onConfirm:function(){r.save(t,{overwrite:!0})}}))},t.prototype.postSave=function(t,e){this.dash.version=e.version;var a=Lt.b.stripBaseFromUrl(e.url);return a!==this.$location.path()&&this.$location.url(a).replace(),this.$rootScope.appEvent("dashboard-saved",this.dash),this.$rootScope.appEvent("alert-success",["仪表盘已保存"]),this.dash},t.prototype.save=function(t,e){return(e=e||{}).folderId=e.folderId>=0?e.folderId:this.dash.meta.folderId||t.folderId,this.backendSrv.saveDashboard(t,e).then(this.postSave.bind(this,t)).catch(this.handleSaveDashboardError.bind(this,t,e))},t.prototype.saveDashboard=function(t,e){return e&&this.setCurrent(this.create(e,this.dash.meta)),this.dash.meta.provisioned?this.showDashboardProvisionedModal():this.dash.meta.canSave||!0===t.makeEditable?"New dashboard"===this.dash.title?this.showSaveAsModal():this.dash.version>0?this.showSaveModal():this.save(this.dash.getSaveModelClone(),t):Promise.resolve()},t.prototype.saveJSONDashboard=function(t){return this.save(JSON.parse(t),{})},t.prototype.showDashboardProvisionedModal=function(){this.$rootScope.appEvent("show-modal",{templateHtml:'<save-provisioned-dashboard-modal dismiss="dismiss()"></save-provisioned-dashboard-modal>'})},t.prototype.showSaveAsModal=function(){this.$rootScope.appEvent("show-modal",{templateHtml:'<save-dashboard-as-modal dismiss="dismiss()"></save-dashboard-as-modal>',modalClass:"modal--narrow"})},t.prototype.showSaveModal=function(){this.$rootScope.appEvent("show-modal",{templateHtml:'<save-dashboard-modal dismiss="dismiss()"></save-dashboard-modal>',modalClass:"modal--narrow"})},t.prototype.starDashboard=function(t,e){var a=this;return(e?this.backendSrv.delete("/api/user/stars/dashboard/"+t).then(function(){return!1}):this.backendSrv.post("/api/user/stars/dashboard/"+t).then(function(){return!0})).then(function(e){return a.dash&&a.dash.id===t&&(a.dash.meta.isStarred=e),e})},t}();I.a.service("dashboardSrv",ns);var is=function(){function t(t,e,a,r){this.$location=e,this.$timeout=a,this.$rootScope=r;var n=this;n.state={},n.panelScopes=[],n.$scope=t,n.dashboard=t.dashboard,t.onAppEvent("$routeUpdate",function(){var t=n.getQueryStringState();n.needsSync(t)&&n.update(t,!0)}),t.onAppEvent("panel-change-view",function(t,e){n.update(e)}),t.onAppEvent("panel-initialized",function(t,e){n.registerPanel(e.scope)}),e.replace(),this.update(this.getQueryStringState())}return t.$inject=["$scope","$location","$timeout","$rootScope"],t.prototype.needsSync=function(t){return!1===A.a.isEqual(this.state,t)},t.prototype.getQueryStringState=function(){var t=this.$location.search();return t.panelId=parseInt(t.panelId,10)||null,t.fullscreen=!!t.fullscreen||null,t.edit="true"===t.edit||!0===t.edit||null,t.editview=t.editview||null,t.orgId=kt.a.bootData.user.orgId,t},t.prototype.serializeToUrl=function(){var t=A.a.clone(this.state);return t.fullscreen=!!this.state.fullscreen||null,t.edit=!!this.state.edit||null,t},t.prototype.update=function(t,e){t.toggle&&(delete t.toggle,this.state.fullscreen&&t.fullscreen&&this.state.edit===t.edit&&(t.fullscreen=!t.fullscreen)),this.editStateChanged=(t.edit||!1)!==(this.state.edit||!1),A.a.extend(this.state,t),this.dashboard.meta.fullscreen=this.state.fullscreen,this.state.fullscreen||(this.state.fullscreen=null,this.state.edit=null,this.dashboard.meta.soloMode||(this.state.panelId=null)),(this.state.fullscreen||this.dashboard.meta.soloMode)&&this.state.panelId&&this.toggleCollapsedPanelRow(this.state.panelId),this.state.edit||delete this.state.tab,!0!==e&&this.$location.search(this.serializeToUrl()),this.syncState()},t.prototype.toggleCollapsedPanelRow=function(t){for(var e=0,a=this.dashboard.panels;e<a.length;e++){var r=a[e];if(r.collapsed)for(var n=0,i=r.panels;n<i.length;n++){if(i[n].id===t)return void this.dashboard.toggleRow(r)}}},t.prototype.syncState=function(){if(0!==this.panelScopes.length)if(this.dashboard.meta.fullscreen){var t=this.getPanelScope(this.state.panelId);if(!t)return;if(this.fullscreenPanel){if(this.fullscreenPanel===t&&!1===this.editStateChanged)return;this.leaveFullscreen(!1)}t.ctrl.editModeInitiated||t.ctrl.initEditMode(),t.ctrl.fullscreen||this.enterFullscreen(t)}else this.fullscreenPanel&&this.leaveFullscreen(!0)},t.prototype.getPanelScope=function(t){return A.a.find(this.panelScopes,function(e){return e.ctrl.panel.id===t})},t.prototype.leaveFullscreen=function(t){var e=this,a=e.fullscreenPanel.ctrl;return a.editMode=!1,a.fullscreen=!1,this.dashboard.setViewMode(a.panel,!1,!1),this.$scope.appEvent("panel-fullscreen-exit",{panelId:a.panel.id}),this.$scope.appEvent("dash-scroll",{restore:!0}),!!t&&(this.$timeout(function(){e.oldTimeRange!==a.range?e.$rootScope.$broadcast("refresh"):e.$rootScope.$broadcast("render"),delete e.fullscreenPanel}),!0)},t.prototype.enterFullscreen=function(t){var e=t.ctrl;e.editMode=this.state.edit&&this.dashboard.meta.canEdit,e.fullscreen=!0,this.oldTimeRange=e.range,this.fullscreenPanel=t,this.$scope.appEvent("dash-scroll",{animate:!1,pos:0}),this.dashboard.setViewMode(e.panel,!0,e.editMode),this.$scope.appEvent("panel-fullscreen-enter",{panelId:e.panel.id})},t.prototype.registerPanel=function(t){var e=this;e.panelScopes.push(t),e.dashboard.meta.soloMode||e.state.panelId===t.ctrl.panel.id&&(e.state.edit?t.ctrl.editPanel():t.ctrl.viewPanel());var a=t.$on("$destroy",function(){e.panelScopes=A.a.without(e.panelScopes,t),a()})},t}();function ss(t,e,a){return{create:function(r){return new is(r,t,e,a)}}}P.a.module("grafana.services").factory("dashboardViewStateSrv",ss);var os="dash-folder",ls="dash-db",us=function(){function t(t,e){this.$q=t,this.backendSrv=e,this.rootName="general"}return t.$inject=["$q","backendSrv"],t.prototype.validateNewDashboardName=function(t,e){return this.validate(t,e,"此文件夹中已存在同名的仪表盘")},t.prototype.validateNewFolderName=function(t){return this.validate(0,t,"默认文件夹中已存在同名的仪表盘或文件夹")},t.prototype.validate=function(t,e,a){var r=(e=(e||"").trim()).toLowerCase();if(0===e.length)return this.$q.reject({type:"REQUIRED",message:"名称是必需的"});if(0===t&&r===this.rootName)return this.$q.reject({type:"EXISTING",message:"这是保留名称，不能用于文件夹命名。"});var n=this.$q.defer(),i=[];return i.push(this.backendSrv.search({type:os,folderIds:[t],query:e})),i.push(this.backendSrv.search({type:ls,folderIds:[t],query:e})),this.$q.all(i).then(function(t){var e=[];t.length>0&&t[0].length>0&&(e=t[0]),t.length>1&&t[1].length>0&&(e=e.concat(t[1]));for(var i=0,s=e;i<s.length;i++){var o=s[i];if(r===o.title.toLowerCase()){n.reject({type:"EXISTING",message:a});break}}n.resolve()}),n.promise},t}();I.a.service("validationSrv",us);var cs=function(){function t(t,e,a,r,n){var i=this;this.$rootScope=t,this.$timeout=e,this.$location=a,this.timer=r,this.contextSrv=n,this.time={from:"6h",to:"now"},t.$on("zoom-out",this.zoomOut.bind(this)),t.$on("$routeUpdate",this.routeUpdated.bind(this)),document.addEventListener("visibilitychange",function(){i.autoRefreshBlocked&&"visible"===document.visibilityState&&(i.autoRefreshBlocked=!1,i.refreshDashboard())})}return t.$inject=["$rootScope","$timeout","$location","timer","contextSrv"],t.prototype.init=function(t){this.timer.cancelAll(),this.dashboard=t,this.time=t.time,this.refresh=t.refresh,this.initTimeFromUrl(),this.parseTime(),this.timeAtLoad=A.a.cloneDeep(this.time),this.refresh&&this.setAutoRefresh(this.refresh)},t.prototype.parseTime=function(){A.a.isString(this.time.from)&&this.time.from.indexOf("Z")>=0&&(this.time.from=L()(this.time.from).utc()),A.a.isString(this.time.to)&&this.time.to.indexOf("Z")>=0&&(this.time.to=L()(this.time.to).utc())},t.prototype.parseUrlParam=function(t){if(-1!==t.indexOf("now"))return t;if(8===t.length)return L.a.utc(t,"YYYYMMDD");if(15===t.length)return L.a.utc(t,"YYYYMMDDTHHmmss");if(!isNaN(t)){var e=parseInt(t,10);return L.a.utc(e)}return null},t.prototype.initTimeFromUrl=function(){var t=this.$location.search();t.from&&(this.time.from=this.parseUrlParam(t.from)||this.time.from),t.to&&(this.time.to=this.parseUrlParam(t.to)||this.time.to),t.refresh&&(this.refresh=t.refresh||this.refresh)},t.prototype.routeUpdated=function(){var t=this.$location.search(),e=this.timeRangeForUrl();t.from&&t.to?t.from===e.from&&t.to===e.to||(this.initTimeFromUrl(),this.setTime(this.time,!0)):this.timeHasChangedSinceLoad()&&this.setTime(this.timeAtLoad,!0)},t.prototype.timeHasChangedSinceLoad=function(){return this.timeAtLoad.from!==this.time.from||this.timeAtLoad.to!==this.time.to},t.prototype.setAutoRefresh=function(t){var e=this;if(this.dashboard.refresh=t,this.cancelNextRefresh(),t){var a=J.a.interval_to_ms(t);this.refreshTimer=this.timer.register(this.$timeout(function(){e.startNextRefreshTimer(a),e.refreshDashboard()},a))}var r=this.$location.search();t?(r.refresh=t,this.$location.search(r)):r.refresh&&(delete r.refresh,this.$location.search(r))},t.prototype.refreshDashboard=function(){this.$rootScope.$broadcast("refresh")},t.prototype.startNextRefreshTimer=function(t){var e=this;this.cancelNextRefresh(),this.refreshTimer=this.timer.register(this.$timeout(function(){e.startNextRefreshTimer(t),e.contextSrv.isGrafanaVisible()?e.refreshDashboard():e.autoRefreshBlocked=!0},t))},t.prototype.cancelNextRefresh=function(){this.timer.cancel(this.refreshTimer)},t.prototype.setTime=function(t,e){if(A.a.extend(this.time,t),L.a.isMoment(t.to)?(this.oldRefresh=this.dashboard.refresh||this.oldRefresh,this.setAutoRefresh(!1)):this.oldRefresh&&this.oldRefresh!==this.dashboard.refresh&&(this.setAutoRefresh(this.oldRefresh),this.oldRefresh=null),!0!==e){var a=this.timeRangeForUrl(),r=this.$location.search();r.from=a.from,r.to=a.to,this.$location.search(r)}this.$rootScope.appEvent("time-range-changed",this.time),this.$timeout(this.refreshDashboard.bind(this),0)},t.prototype.timeRangeForUrl=function(){var t=this.timeRange().raw;return L.a.isMoment(t.from)&&(t.from=t.from.valueOf().toString()),L.a.isMoment(t.to)&&(t.to=t.to.valueOf().toString()),t},t.prototype.timeRange=function(){var t={from:L.a.isMoment(this.time.from)?L()(this.time.from):this.time.from,to:L.a.isMoment(this.time.to)?L()(this.time.to):this.time.to},e=this.dashboard&&this.dashboard.getTimezone();return{from:Vt.parse(t.from,!1,e),to:Vt.parse(t.to,!0,e),raw:t}},t.prototype.zoomOut=function(t,e){var a=this.timeRange(),r=a.to.valueOf()-a.from.valueOf(),n=a.to.valueOf()-r/2,i=n+r*e/2,s=n-r*e/2;i>Date.now()&&a.to<=Date.now()&&(s-=i-Date.now(),i=Date.now());this.setTime({from:L.a.utc(s),to:L.a.utc(i)})},t}();I.a.service("timeSrv",cs);var hs=function(){function t(t,e,a,r,n,i,s,o){var l=this;this.$location=r,this.$timeout=i,this.contextSrv=s,this.$rootScope=o,this.$location=r,this.$window=n,this.current=t,this.originalPath=r.path(),this.scope=e,e.onAppEvent("dashboard-saved",function(){l.original=l.current.getSaveModelClone(),l.originalPath=r.path()}),n.onbeforeunload=function(){if(!l.ignoreChanges())return l.hasChanges()?"此仪表盘有未保存的更改":void 0},e.$on("$locationChangeStart",function(t,e){return l.originalPath===r.path()||(!!l.ignoreChanges()||(l.hasChanges()&&(t.preventDefault(),l.next=e,l.$timeout(function(){l.open_modal()})),!1))}),a?this.$timeout(function(){l.original=t.getSaveModelClone()},a):this.original=t.getSaveModelClone()}return t.$inject=["dashboard","scope","originalCopyDelay","$location","$window","$timeout","contextSrv","$rootScope"],t.prototype.ignoreChanges=function(){if(!this.original)return!0;if(!this.contextSrv.isEditor)return!0;if(!this.current||!this.current.meta)return!0;var t=this.current.meta;return!t.canSave||t.fromScript||t.fromFile},t.prototype.cleanDashboardFromIgnoredChanges=function(t){var e=new rs.a(t);e.expandRows();var a=e.getSaveModelClone();return a.time=0,a.refresh=0,a.schemaVersion=0,delete a.iteration,a.panels=A.a.filter(a.panels,function(t){return!t.repeatPanelId&&(t.scopedVars=null,t.legend&&(delete t.legend.sort,delete t.legend.sortDesc),!0)}),A.a.each(a.templating.list,function(t){t.current=null,t.options=null,t.filters=null}),a},t.prototype.hasChanges=function(){var t=this.cleanDashboardFromIgnoredChanges(this.current.getSaveModelClone()),e=this.cleanDashboardFromIgnoredChanges(this.original),a=A.a.find(t.nav,{type:"timepicker"}),r=A.a.find(e.nav,{type:"timepicker"});return a&&r&&(a.now=r.now),P.a.toJson(t,!0)!==P.a.toJson(e,!0)},t.prototype.discardChanges=function(){this.original=null,this.gotoNext()},t.prototype.open_modal=function(){this.$rootScope.appEvent("show-modal",{templateHtml:'<unsaved-changes-modal dismiss="dismiss()"></unsaved-changes-modal>',modalClass:"modal--narrow confirm-modal"})},t.prototype.saveChanges=function(){var t=this,e=this,a=this.$rootScope.$on("dashboard-saved",function(){a(),t.$timeout(function(){e.gotoNext()})});this.$rootScope.appEvent("save-dashboard")},t.prototype.gotoNext=function(){var t=this.$location.absUrl().length-this.$location.url().length,e=this.next.substring(t);this.$location.url(e)},t}();function ps(t,e,a,r,n,i,s){this.init=function(e,i){return this.tracker=new hs(e,i,1e3,a,s,r,n,t),this.tracker}}P.a.module("grafana.services").service("unsavedChangesSrv",ps);var ds='\n<div class="modal-body">\n  <div class="modal-header">\n    <h2 class="modal-header-title">\n      <i class="fa fa-exclamation"></i>\n      <span class="p-l-1">未保存的更改</span>\n    </h2>\n\n    <a class="modal-header-close" ng-click="ctrl.dismiss();">\n      <i class="fa fa-remove"></i>\n    </a>\n  </div>\n\n  <div class="modal-content text-center">\n\n    <div class="confirm-modal-text">\n      要保存更改吗?\n    </div>\n\n    <div class="confirm-modal-buttons">\n      <button type="button" class="btn btn-success" ng-click="ctrl.save()">保存</button>\n      <button type="button" class="btn btn-danger" ng-click="ctrl.discard()">放弃</button>\n      <button type="button" class="btn btn-inverse" ng-click="ctrl.dismiss()">取消</button>\n    </div>\n  </div>\n</div>\n',ms=function(){function t(t){this.unsavedChangesSrv=t}return t.$inject=["unsavedChangesSrv"],t.prototype.discard=function(){this.dismiss(),this.unsavedChangesSrv.tracker.discardChanges()},t.prototype.save=function(){this.dismiss(),this.unsavedChangesSrv.tracker.saveChanges()},t}();I.a.directive("unsavedChangesModal",function(){return{restrict:"E",template:ds,controller:ms,bindToController:!0,controllerAs:"ctrl",scope:{dismiss:"&"}}});var fs=function(){function t(e,a,r){var n=this;this.$scope=e,this.$rootScope=a,this.timeSrv=r,this.$scope.ctrl=this,a.onAppEvent("shift-time-forward",function(){return n.move(1)},e),a.onAppEvent("shift-time-backward",function(){return n.move(-1)},e),a.onAppEvent("refresh",this.onRefresh.bind(this),e),a.onAppEvent("closeTimepicker",this.openDropdown.bind(this),e),this.panel=this.dashboard.timepicker,A.a.defaults(this.panel,t.defaults),this.firstDayOfWeek=L.a.localeData().firstDayOfWeek(),this.onRefresh()}return t.$inject=["$scope","$rootScope","timeSrv"],t.prototype.onRefresh=function(){var t=P.a.copy(this.timeSrv.timeRange()),e=P.a.copy(t.raw);this.dashboard.isTimezoneUtc()?this.isUtc=!0:(t.from.local(),t.to.local(),L.a.isMoment(e.from)&&e.from.local(),L.a.isMoment(e.to)&&e.to.local(),this.isUtc=!1),this.rangeString=Nt.b(e),this.absolute={fromJs:t.from.toDate(),toJs:t.to.toDate()},this.tooltip=this.dashboard.formatDate(t.from)+" <br>to<br>",this.tooltip+=this.dashboard.formatDate(t.to),this.timeRaw=e,this.isAbsolute=L.a.isMoment(this.timeRaw.to)},t.prototype.zoom=function(t){this.$rootScope.appEvent("zoom-out",2)},t.prototype.move=function(t){var e,a,r=this.timeSrv.timeRange(),n=(r.to.valueOf()-r.from.valueOf())/2;-1===t?(e=r.to.valueOf()-n,a=r.from.valueOf()-n):1===t?(e=r.to.valueOf()+n,a=r.from.valueOf()+n,e>Date.now()&&r.to<Date.now()&&(e=Date.now(),a=r.from.valueOf())):(e=r.to.valueOf(),a=r.from.valueOf()),this.timeSrv.setTime({from:L.a.utc(a),to:L.a.utc(e)})},t.prototype.openDropdown=function(){this.isOpen?this.closeDropdown():(this.onRefresh(),this.editTimeRaw=this.timeRaw,this.timeOptions=Nt.c(this.panel,this.rangeString),this.refresh={value:this.dashboard.refresh,options:A.a.map(this.panel.refresh_intervals,function(t){return{text:t,value:t}})},this.refresh.options.unshift({text:"off"}),this.isOpen=!0,this.$rootScope.appEvent("timepickerOpen"))},t.prototype.closeDropdown=function(){this.isOpen=!1,this.$rootScope.appEvent("timepickerClosed")},t.prototype.applyCustom=function(){this.refresh.value!==this.dashboard.refresh&&this.timeSrv.setAutoRefresh(this.refresh.value),this.timeSrv.setTime(this.editTimeRaw),this.closeDropdown()},t.prototype.absoluteFromChanged=function(){this.editTimeRaw.from=this.getAbsoluteMomentForTimezone(this.absolute.fromJs)},t.prototype.absoluteToChanged=function(){this.editTimeRaw.to=this.getAbsoluteMomentForTimezone(this.absolute.toJs)},t.prototype.getAbsoluteMomentForTimezone=function(t){return this.dashboard.isTimezoneUtc()?L()(t).utc():L()(t)},t.prototype.setRelativeFilter=function(t){var e={from:t.from,to:t.to};this.panel.nowDelay&&"now"===e.to&&(e.to="now-"+this.panel.nowDelay),this.timeSrv.setTime(e),this.closeDropdown()},t.tooltipFormat="MMM D, YYYY HH:mm:ss",t.defaults={time_options:["5m","15m","1h","6h","12h","24h","2d","7d","30d"],refresh_intervals:["5s","10s","30s","1m","5m","15m","30m","1h","2h","1d"]},t}();P.a.module("grafana.directives").directive("gfTimePickerSettings",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/timepicker/settings.html",controller:fs,bindToController:!0,controllerAs:"ctrl",scope:{dashboard:"="}}}),P.a.module("grafana.directives").directive("gfTimePicker",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/timepicker/timepicker.html",controller:fs,bindToController:!0,controllerAs:"ctrl",scope:{dashboard:"="}}}),P.a.module("grafana.directives").directive("inputDatetime",function(){return{restrict:"A",require:"ngModel",link:function(t,e,a,r){var n="YYYY-MM-DD HH:mm:ss";r.$parsers.push(function(e){return-1!==e.indexOf("now")?Vt.isValid(e)?(r.$setValidity("error",!0),e):void r.$setValidity("error",!1):(a=t.ctrl.isUtc?L.a.utc(e,n):L()(e,n)).isValid()?(r.$setValidity("error",!0),a):void r.$setValidity("error",!1);var a}),r.$formatters.push(function(t){return L.a.isMoment(t)?t.format(n):t})}}});var gs='\n<input type="file" id="dashupload" name="dashupload" class="hide"/>\n<label class="btn btn-success" for="dashupload">\n  <i class="fa fa-upload"></i>\n  上传 .json 文件\n</label>\n';function vs(t,e,a){return{restrict:"E",template:gs,scope:{onUpload:"&"},link:function(t){var a=window;a.File&&a.FileReader&&a.FileList&&a.Blob?document.getElementById("dashupload").addEventListener("change",function(e){for(var a=e.target.files,r=0,n=a[r];n;){var i=new FileReader;i.onload=function(e){var a;try{a=JSON.parse(e.target.result)}catch(e){return console.log(e),void t.appEvent("alert-error",["导入失败","JSON -> JS序列化失败: "+e.message])}t.$apply(function(){t.onUpload({dash:a})})},i.readAsText(n),n=a[r+=1]}},!1):e.set("Oops","抱歉，此浏览器不完全支持HTML5文件API","error")}}}I.a.directive("dashUpload",vs);var ys=function(){function t(t){this.datasourceSrv=t}return t.prototype.makeExportable=function(t){var e=this;t.cleanUpRepeats();var a=t.getSaveModelClone();a.id=null,t.processRepeats();for(var r=[],n={},i={},s=[],o={},l=0,u=a.templating.list;l<u.length;l++){var c=u[l];o[c.name]=c}for(var h=function(t){t.datasource&&0===t.datasource.indexOf("$")&&o[t.datasource.substring(1)]||s.push(e.datasourceSrv.get(t.datasource).then(function(e){if(!e.meta.builtIn){var a="DS_"+e.name.replace(" ","_").toUpperCase();i[a]={name:a,label:e.name,description:"",type:"datasource",pluginId:e.meta.id,pluginName:e.meta.name},t.datasource="${"+a+"}",n["datasource"+e.meta.id]={type:"datasource",id:e.meta.id,name:e.meta.name,version:e.meta.info.version||"1.0.0"}}}))},p=function(t){if(void 0!==t.datasource&&h(t),t.targets)for(var e=0,a=t.targets;e<a.length;e++){var r=a[e];void 0!==r.datasource&&h(r)}var i=kt.a.panels[t.type];i&&(n["panel"+i.id]={type:"panel",id:i.id,name:i.name,version:i.info.version})},d=0,m=a.panels;d<m.length;d++){var f=m[d];if(p(f),void 0!==f.collapsed&&!0===f.collapsed&&f.panels)for(var g=0,v=f.panels;g<v.length;g++){p(v[g])}}for(var y=0,b=a.templating.list;y<b.length;y++){"query"===(c=b[y]).type&&(h(c),c.options=[],c.current={},c.refresh=c.refresh>0?c.refresh:1)}for(var S=0,x=a.annotations.list;S<x.length;S++){var w=x[S];h(w)}return n.grafana={type:"grafana",id:"grafana",name:"Grafana",version:kt.a.buildInfo.version},Promise.all(s).then(function(){A.a.each(i,function(t,e){r.push(t)});for(var t=0,e=a.templating.list;t<e.length;t++){var s=e[t];if("constant"===s.type){var o="VAR_"+s.name.replace(" ","_").toUpperCase();r.push({name:o,type:"constant",label:s.label||s.name,value:s.current.value,description:""}),s.query="${"+o+"}",s.options[0]=s.current={value:s.query,text:s.query}}}var l={};return l.__inputs=r,l.__requires=A.a.sortBy(n,["id"]),A.a.defaults(l,a),l}).catch(function(t){return console.log("Export failed:",t),{error:t}})},t}(),bs=function(){function t(t,e,a,r){var n=this;this.dashboardSrv=t,this.$scope=a,this.$rootScope=r,this.exporter=new ys(e),this.exporter.makeExportable(this.dashboardSrv.getCurrent()).then(function(t){n.$scope.$apply(function(){n.dash=t})})}return t.$inject=["dashboardSrv","datasourceSrv","$scope","$rootScope"],t.prototype.save=function(){var t=new Blob([P.a.toJson(this.dash,!0)],{type:"application/json;charset=utf-8"});Object(se.saveAs)(t,this.dash.title+"-"+(new Date).getTime()+".json")},t.prototype.saveJson=function(){var t=this.dash,e=this.$rootScope.$new();e.object=t,e.enableCopy=!0,this.$rootScope.appEvent("show-modal",{src:"public/app/partials/edit_json.html",scope:e}),this.dismiss()},t}();I.a.directive("dashExportModal",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/export/export_modal.html",controller:bs,bindToController:!0,controllerAs:"ctrl",scope:{dismiss:"&"}}});var Ss=function(){function t(){this.asRows=!0,this.dateTimeFormat="YYYY-MM-DDTHH:mm:ssZ",this.excel=!1}return t.prototype.export=function(){"table"===this.panel?Te(this.data,this.excel):this.asRows?xe(this.data,this.dateTimeFormat,this.excel):ke(this.data,this.dateTimeFormat,this.excel),this.dismiss()},t.prototype.dismiss=function(){et.a.emit("hide-modal")},t}();P.a.module("grafana.directives").directive("exportDataModal",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/export_data/export_data_modal.html",controller:Ss,controllerAs:"ctrl",scope:{panel:"<",data:"<"},bindToController:!0}});var xs=function(){function t(t,e,a,r,n,i){this.uiSegmentSrv=t,this.datasourceSrv=e,this.$q=a,this.variableSrv=r,this.$rootScope=i,this.removeTagFilterSegment=t.newSegment({fake:!0,value:"-- remove filter --"}),this.buildSegmentModel(),this.$rootScope.onAppEvent("template-variable-value-updated",this.buildSegmentModel.bind(this),n)}return t.$inject=["uiSegmentSrv","datasourceSrv","$q","variableSrv","$scope","$rootScope"],t.prototype.buildSegmentModel=function(){this.segments=[],this.variable.value&&A.a.isArray(this.variable.value);for(var t=0,e=this.variable.filters;t<e.length;t++){var a=e[t];this.segments.length>0&&this.segments.push(this.uiSegmentSrv.newCondition("AND")),void 0!==a.key&&void 0!==a.value&&(this.segments.push(this.uiSegmentSrv.newKey(a.key)),this.segments.push(this.uiSegmentSrv.newOperator(a.operator)),this.segments.push(this.uiSegmentSrv.newKeyValue(a.value)))}this.segments.push(this.uiSegmentSrv.newPlusButton())},t.prototype.getOptions=function(t,e){var a=this;return"operator"===t.type?this.$q.when(this.uiSegmentSrv.newOperators(["=","!=","<",">","=~","!~"])):"condition"===t.type?this.$q.when([this.uiSegmentSrv.newSegment("AND")]):this.datasourceSrv.get(this.variable.datasource).then(function(r){var n={},i=null;return"value"!==t.type?i=r.getTagKeys():(n.key=a.segments[e-2].value,i=r.getTagValues(n)),i.then(function(e){return e=A.a.map(e,function(t){return a.uiSegmentSrv.newSegment({value:t.text})}),"key"===t.type&&e.splice(0,0,P.a.copy(a.removeTagFilterSegment)),e})})},t.prototype.segmentChanged=function(t,e){this.segments[e]=t,t.value===this.removeTagFilterSegment.value?(this.segments.splice(e,3),0===this.segments.length?this.segments.push(this.uiSegmentSrv.newPlusButton()):this.segments.length>2&&(this.segments.splice(Math.max(e-1,0),1),"plus-button"!==this.segments[this.segments.length-1].type&&this.segments.push(this.uiSegmentSrv.newPlusButton()))):("plus-button"===t.type&&(e>2&&this.segments.splice(e,0,this.uiSegmentSrv.newCondition("AND")),this.segments.push(this.uiSegmentSrv.newOperator("=")),this.segments.push(this.uiSegmentSrv.newFake("select tag value","value","query-segment-value")),t.type="key",t.cssClass="query-segment-key"),e+1===this.segments.length&&this.segments.push(this.uiSegmentSrv.newPlusButton())),this.updateVariableModel()},t.prototype.updateVariableModel=function(){var t=[],e=-1,a=!1;this.segments.forEach(function(r){if("value"===r.type&&r.fake)a=!0;else switch(r.type){case"key":t.push({key:r.value}),e+=1;break;case"value":t[e].value=r.value;break;case"operator":t[e].operator=r.value;break;case"condition":t[e].condition=r.value}}),a||(this.variable.setFilters(t),this.variableSrv.variableUpdated(this.variable,!0))},t}(),ws='\n<div class="gf-form-inline">\n  <div class="gf-form" ng-repeat="segment in ctrl.segments">\n    <metric-segment segment="segment" get-options="ctrl.getOptions(segment, $index)"\n                    on-change="ctrl.segmentChanged(segment, $index)"></metric-segment>\n  </div>\n</div>\n';I.a.directive("adHocFilters",function(){return{restrict:"E",template:ws,controller:xs,bindToController:!0,controllerAs:"ctrl",scope:{variable:"="}}});var ks='\n<div class="gf-form-select-wrapper max-width-18">\n  <select class="gf-form-input" ng-model="panel.repeat" ng-options="f.value as f.text for f in variables" ng-change="optionChanged()">\n  <option value=""></option>\n</div>\n';function Cs(t){return{restrict:"E",template:ks,scope:{panel:"="},link:function(e,a){a.css({display:"block",width:"100%"}),e.variables=t.variables.map(function(t){return{text:t.name,value:t.name}}),0===e.variables.length&&e.variables.unshift({text:"暂无模板变量",value:null}),e.variables.unshift({text:"Disabled",value:null}),e.panel.repeat&&!e.panel.repeatDirection&&(e.panel.repeatDirection="h"),e.optionChanged=function(){e.panel.repeat&&(e.panel.repeatDirection="h")}}}}j.d.directive("dashRepeatOption",Cs);var Ts=a(58),_s=a(1207),Ms=a.n(_s),$s=a(41),Ps=a.n($s),Es=function(t){function e(e){var a=t.call(this,e)||this;return a.state={collapsed:a.props.panel.collapsed},a.panelContainer=a.props.getPanelContainer(),a.dashboard=a.panelContainer.getDashboard(),a.toggle=a.toggle.bind(a),a.openSettings=a.openSettings.bind(a),a.delete=a.delete.bind(a),a.update=a.update.bind(a),a}return Rt.d(e,t),e.prototype.toggle=function(){this.dashboard.toggleRow(this.props.panel),this.setState(function(t){return{collapsed:!t.collapsed}})},e.prototype.update=function(){this.dashboard.processRepeats(),this.forceUpdate()},e.prototype.openSettings=function(){et.a.emit("show-modal",{templateHtml:'<row-options row="model.row" on-updated="model.onUpdated()" dismiss="dismiss()"></row-options>',modalClass:"modal--narrow",model:{row:this.props.panel,onUpdated:this.update.bind(this)}})},e.prototype.delete=function(){var t=this;et.a.emit("confirm-modal",{title:"删除行",text:"确定想要删除删除该行及下属所有面板?",altActionText:"只删除行",icon:"fa-trash",onConfirm:function(){t.props.getPanelContainer().getDashboard().removeRow(t.props.panel,!0)},onAltAction:function(){t.props.getPanelContainer().getDashboard().removeRow(t.props.panel,!1)}})},e.prototype.render=function(){var t=Ps()({"dashboard-row":!0,"dashboard-row--collapsed":this.state.collapsed}),e=Ps()({fa:!0,"fa-chevron-down":!this.state.collapsed,"fa-chevron-right":this.state.collapsed}),a=nt.replaceWithText(this.props.panel.title,this.props.panel.scopedVars),r=this.props.panel.panels?this.props.panel.panels.length:0,n=1===r?"panel":"panels";return ee.a.createElement("div",{className:t},ee.a.createElement("a",{className:"dashboard-row__title pointer",onClick:this.toggle},ee.a.createElement("i",{className:e}),a,ee.a.createElement("span",{className:"dashboard-row__panel_count"},"(",r," ",n,")")),!0===this.dashboard.meta.canEdit&&ee.a.createElement("div",{className:"dashboard-row__actions"},ee.a.createElement("a",{className:"pointer",onClick:this.openSettings},ee.a.createElement("i",{className:"fa fa-cog"})),ee.a.createElement("a",{className:"pointer",onClick:this.delete},ee.a.createElement("i",{className:"fa fa-trash"}))),!0===this.state.collapsed&&ee.a.createElement("div",{className:"dashboard-row__toggle-target",onClick:this.toggle}," "),ee.a.createElement("div",{className:"dashboard-row__drag grid-drag-handle"}))},e}(ee.a.Component),As=function(t){function e(e){var a=t.call(this,e)||this;return a.handleRef=function(t){a.container=t},a}return Rt.d(e,t),e.prototype.componentDidMount=function(){this.scrollbar=Mn()({root:this.container.parentElement,scroller:this.container,bar:".baron__bar",barOnCls:"_scrollbar",scrollingCls:"_scrolling",track:".baron__track"})},e.prototype.componentDidUpdate=function(){this.scrollbar.update()},e.prototype.componentWillUnmount=function(){this.scrollbar.dispose()},e.prototype.setScrollTop=function(t){return!!this.container&&(this.container.scrollTop=t,this.scrollbar.update(),!0)},e.prototype.setScrollLeft=function(t){return!!this.container&&(this.container.scrollLeft=t,this.scrollbar.update(),!0)},e.prototype.update=function(){this.scrollbar.update()},e.prototype.render=function(){return ee.a.createElement("div",{className:"baron baron__root baron__clipper"},ee.a.createElement("div",{className:this.props.className+" baron__scroller",ref:this.handleRef},this.props.children),ee.a.createElement("div",{className:"baron__track"},ee.a.createElement("div",{className:"baron__bar"})))},e}(ee.a.Component),Ds=a(439),Fs=a.n(Ds),Is=function(t){function e(e){var a=t.call(this,e)||this;return a.onAddPanel=function(t){var e=a.props.getPanelContainer().getDashboard(),r=a.props.panel.gridPos,n={type:t.id,title:"面板标题",gridPos:{x:r.x,y:r.y,w:r.w,h:r.h}};"row"===t.id&&(n.title="行标题",n.gridPos={x:0,y:0}),t.defaults&&(A.a.defaults(n,t.defaults),n.gridPos.w=t.defaults.gridPos.w,n.gridPos.h=t.defaults.gridPos.h,n.title=t.defaults.title,Ot.a.delete(It.f)),e.addPanel(n),e.removePanel(a.props.panel)},a.handleCloseAddPanel=a.handleCloseAddPanel.bind(a),a.renderPanelItem=a.renderPanelItem.bind(a),a.panelSizeChanged=a.panelSizeChanged.bind(a),a.state={panelPlugins:a.getPanelPlugins(""),copiedPanelPlugins:a.getCopiedPanelPlugins(""),filter:"",tab:"Add"},a}return Rt.d(e,t),e.prototype.componentDidMount=function(){this.props.panel.events.on("panel-size-changed",this.panelSizeChanged)},e.prototype.componentWillUnmount=function(){this.props.panel.events.off("panel-size-changed",this.panelSizeChanged)},e.prototype.panelSizeChanged=function(){var t=this;setTimeout(function(){t.scrollbar.update()})},e.prototype.getPanelPlugins=function(t){var e=A.a.chain(kt.a.panels).filter({hideFromList:!1}).map(function(t){return t}).value();return e.push({id:"row",name:"Row",sort:8,info:{logos:{small:"public/img/icn-row.svg"}}}),e=this.filterPanels(e,t),A.a.sortBy(e,"sort")},e.prototype.getCopiedPanelPlugins=function(t){var e=A.a.chain(kt.a.panels).filter({hideFromList:!1}).map(function(t){return t}).value(),a=[],r=Ot.a.get(It.f);if(r){var n=JSON.parse(r),i=A.a.find(e,{id:n.type});if(i){var s=A.a.cloneDeep(i);s.name=n.title,s.sort=-1,s.defaults=n,a.push(s)}}return a=this.filterPanels(a,t),A.a.sortBy(a,"sort")},e.prototype.handleCloseAddPanel=function(t){t.preventDefault();var e=this.props.getPanelContainer().getDashboard();e.removePanel(e.panels[0])},e.prototype.renderText=function(t){var e=this.state.filter.split("");return ee.a.createElement(Fs.a,{highlightClassName:"highlight-search-match",textToHighlight:t,searchWords:e})},e.prototype.renderPanelItem=function(t,e){var a=this;return ee.a.createElement("div",{key:e,className:"add-panel__item",onClick:function(){return a.onAddPanel(t)},title:t.name},ee.a.createElement("img",{className:"add-panel__item-img",src:t.info.logos.small}),ee.a.createElement("div",{className:"add-panel__item-name"},this.renderText(t.name)))},e.prototype.noCopiedPanelPlugins=function(){return ee.a.createElement("div",{className:"add-panel__no-panels"},"暂无面板副本。")},e.prototype.filterChange=function(t){this.setState({filter:t.target.value,panelPlugins:this.getPanelPlugins(t.target.value),copiedPanelPlugins:this.getCopiedPanelPlugins(t.target.value)})},e.prototype.filterKeyPress=function(t){if("Enter"===t.key){var e=A.a.head(this.state.panelPlugins);e&&this.onAddPanel(e)}},e.prototype.filterPanels=function(t,e){var a=new RegExp(e,"i");return t.filter(function(t){return a.test(t.name)})},e.prototype.openCopy=function(){this.setState({tab:"Copy",filter:"",panelPlugins:this.getPanelPlugins(""),copiedPanelPlugins:this.getCopiedPanelPlugins("")})},e.prototype.openAdd=function(){this.setState({tab:"Add",filter:"",panelPlugins:this.getPanelPlugins(""),copiedPanelPlugins:this.getCopiedPanelPlugins("")})},e.prototype.render=function(){var t,e=this,a=Ps()({"active active--panel":"Add"===this.state.tab,"":"Copy"===this.state.tab}),r=Ps()({"":"Add"===this.state.tab,"active active--panel":"Copy"===this.state.tab});return"Add"===this.state.tab?t=this.state.panelPlugins.map(this.renderPanelItem):"Copy"===this.state.tab&&(t=this.state.copiedPanelPlugins.length>0?this.state.copiedPanelPlugins.map(this.renderPanelItem):this.noCopiedPanelPlugins()),ee.a.createElement("div",{className:"panel-container add-panel-container"},ee.a.createElement("div",{className:"add-panel"},ee.a.createElement("div",{className:"add-panel__header"},ee.a.createElement("i",{className:"gicon gicon-add-panel"}),ee.a.createElement("span",{className:"add-panel__title"},"添加面板"),ee.a.createElement("ul",{className:"gf-tabs"},ee.a.createElement("li",{className:"gf-tabs-item"},ee.a.createElement("div",{className:"gf-tabs-link pointer "+a,onClick:this.openAdd.bind(this)},"添加")),ee.a.createElement("li",{className:"gf-tabs-item"},ee.a.createElement("div",{className:"gf-tabs-link pointer "+r,onClick:this.openCopy.bind(this)},"粘贴"))),ee.a.createElement("button",{className:"add-panel__close",onClick:this.handleCloseAddPanel},ee.a.createElement("i",{className:"fa fa-close"}))),ee.a.createElement(As,{ref:function(t){return e.scrollbar=t},className:"add-panel__items"},ee.a.createElement("div",{className:"add-panel__searchbar"},ee.a.createElement("label",{className:"gf-form gf-form--grow gf-form--has-input-icon"},ee.a.createElement("input",{type:"text",autoFocus:!0,className:"gf-form-input gf-form--grow",placeholder:"过滤搜索面板插件",value:this.state.filter,onChange:this.filterChange.bind(this),onKeyPress:this.filterKeyPress.bind(this)}),ee.a.createElement("i",{className:"gf-form-input-icon fa fa-search"}))),t)))},e}(ee.a.Component),Os=function(t){function e(e){var a=t.call(this,e)||this;return a.state={},a}return Rt.d(e,t),e.prototype.componentDidMount=function(){if(this.element){var t=this.props.getPanelContainer(),e=t.getDashboard(),a=t.getPanelLoader();this.attachedPanel=a.load(this.element,this.props.panel,e)}},e.prototype.componentWillUnmount=function(){this.attachedPanel&&this.attachedPanel.destroy()},e.prototype.render=function(){var t=this;return"row"===this.props.panel.type?ee.a.createElement(Es,{panel:this.props.panel,getPanelContainer:this.props.getPanelContainer}):"add-panel"===this.props.panel.type?ee.a.createElement(Is,{panel:this.props.panel,getPanelContainer:this.props.getPanelContainer}):ee.a.createElement("div",{ref:function(e){return t.element=e},className:"panel-height-helper"})},e}(ee.a.Component),qs=a(1208),Rs=1200;var Ns=a.n(qs)()({monitorWidth:!0})(function(t){var e=t.size,a=t.layout,r=t.onLayoutChange,n=t.children,i=t.onDragStop,s=t.onResize,o=t.onResizeStop,l=t.onWidthChange,u=t.className,c=t.isResizable,h=t.isDraggable;0===e.width&&console.log("size is zero!");var p=e.width>0?e.width:Rs;return p!==Rs&&(l(),Rs=p),ee.a.createElement(Ms.a,{width:Rs,className:u,isDraggable:h,isResizable:c,measureBeforeMount:!1,containerPadding:[0,0],useCSSTransforms:!0,margin:[It.d,It.d],cols:It.e,rowHeight:It.c,draggableHandle:".grid-drag-handle",layout:a,onResize:s,onResizeStop:o,onDragStop:i,onLayoutChange:r},n)}),Vs=function(t){function e(e){var a=t.call(this,e)||this;return a.panelContainer=a.props.getPanelContainer(),a.onLayoutChange=a.onLayoutChange.bind(a),a.onResize=a.onResize.bind(a),a.onResizeStop=a.onResizeStop.bind(a),a.onDragStop=a.onDragStop.bind(a),a.onWidthChange=a.onWidthChange.bind(a),a.state={animated:!1},a.dashboard=a.panelContainer.getDashboard(),a.dashboard.on("panel-added",a.triggerForceUpdate.bind(a)),a.dashboard.on("panel-removed",a.triggerForceUpdate.bind(a)),a.dashboard.on("repeats-processed",a.triggerForceUpdate.bind(a)),a.dashboard.on("view-mode-changed",a.triggerForceUpdate.bind(a)),a.dashboard.on("row-collapsed",a.triggerForceUpdate.bind(a)),a.dashboard.on("row-expanded",a.triggerForceUpdate.bind(a)),a}return Rt.d(e,t),e.prototype.buildLayout=function(){var t=[];this.panelMap={};for(var e=0,a=this.dashboard.panels;e<a.length;e++){var r=a[e],n=r.id.toString();if(this.panelMap[n]=r,r.gridPos){var i={i:n,x:r.gridPos.x,y:r.gridPos.y,w:r.gridPos.w,h:r.gridPos.h};"row"===r.type&&(i.w=It.e,i.h=1,i.isResizable=!1,i.isDraggable=r.collapsed),t.push(i)}else console.log("panel without gridpos")}return t},e.prototype.onLayoutChange=function(t){for(var e=0,a=t;e<a.length;e++){var r=a[e];this.panelMap[r.i].updateGridPos(r)}this.dashboard.sortPanelsByGridPos()},e.prototype.triggerForceUpdate=function(){this.forceUpdate()},e.prototype.onWidthChange=function(){for(var t=0,e=this.dashboard.panels;t<e.length;t++){e[t].resizeDone()}},e.prototype.updateGridPos=function(t,e){this.panelMap[t.i].updateGridPos(t),this.onLayoutChange(e)},e.prototype.onResize=function(t,e,a){this.panelMap[a.i].updateGridPos(a)},e.prototype.onResizeStop=function(t,e,a){this.updateGridPos(a,t),this.panelMap[a.i].resizeDone()},e.prototype.onDragStop=function(t,e,a){this.updateGridPos(a,t)},e.prototype.componentDidMount=function(){var t=this;setTimeout(function(){t.setState(function(){return{animated:!0}})})},e.prototype.renderPanels=function(){for(var t=[],e=0,a=this.dashboard.panels;e<a.length;e++){var r=a[e],n=Ps()({panel:!0,"panel--fullscreen":r.fullscreen});t.push(ee.a.createElement("div",{key:r.id.toString(),className:n,id:"panel-"+r.id.toString()},ee.a.createElement(Os,{panel:r,getPanelContainer:this.props.getPanelContainer})))}return t},e.prototype.render=function(){return ee.a.createElement(Ns,{className:Ps()({layout:!0,animated:this.state.animated}),layout:this.buildLayout(),isResizable:this.dashboard.meta.canEdit,isDraggable:this.dashboard.meta.canEdit,onLayoutChange:this.onLayoutChange,onWidthChange:this.onWidthChange,onDragStop:this.onDragStop,onResize:this.onResize,onResizeStop:this.onResizeStop},this.renderPanels())},e}(ee.a.Component);Object(Ts.a)("dashboardGrid",Vs,[["getPanelContainer",{watchDepth:"reference",wrapApply:!1}]]);var Ls=function(){function t(t,e){this.$compile=t,this.$rootScope=e}return t.$inject=["$compile","$rootScope"],t.prototype.load=function(t,e,a){var r=this.$rootScope.$new();r.panel=e,r.dashboard=a;var n=this.$compile('<plugin-component type="panel" class="panel-height-helper"></plugin-component>')(r);return P.a.element(t).append(n),{destroy:function(){r.$destroy(),n.remove()}}},t}();I.a.service("panelLoader",Ls);var js=function(){function t(){this.source=this.row,this.row=this.row.getSaveModel()}return t.prototype.update=function(){this.source.title=this.row.title,this.source.repeat=this.row.repeat,this.onUpdated(),this.dismiss()},t}();j.d.directive("rowOptions",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/partials/row_options.html",controller:js,bindToController:!0,controllerAs:"ctrl",scope:{row:"=",dismiss:"&",onUpdated:"&"}}});var Us=function(){function t(t,e,a){this.backendSrv=t,this.validationSrv=e,this.contextSrv=a,this.rootName="通用",this.isEditor=this.contextSrv.isEditor,this.labelClass||(this.labelClass="width-7"),this.loadInitialValue()}return t.$inject=["backendSrv","validationSrv","contextSrv"],t.prototype.getOptions=function(t){var e=this,a={query:t,type:"dash-folder",permission:"Edit"};return this.backendSrv.get("api/search",a).then(function(a){return!e.isEditor||""!==t&&"g"!==t.toLowerCase()&&"ge"!==t.toLowerCase()&&"gen"!==t.toLowerCase()&&"gene"!==t.toLowerCase()&&"gener"!==t.toLowerCase()&&"genera"!==t.toLowerCase()&&"general"!==t.toLowerCase()||a.unshift({title:e.rootName,id:0}),e.isEditor&&e.enableCreateNew&&""===t&&a.unshift({title:"-- 新建文件夹 --",id:-1}),e.enableReset&&""===t&&""!==e.initialTitle&&a.unshift({title:e.initialTitle,id:null}),A.a.map(a,function(t){return{text:t.title,value:t.id}})})},t.prototype.onFolderChange=function(t){if(t){if(-1===t.value)return this.createNewFolder=!0,void this.enterFolderCreation()}else t={value:0,text:this.rootName};this.onChange({$folder:{id:t.value,title:t.text}})},t.prototype.newFolderNameChanged=function(){var t=this;this.newFolderNameTouched=!0,this.validationSrv.validateNewFolderName(this.newFolderName).then(function(){t.hasValidationError=!1}).catch(function(e){t.hasValidationError=!0,t.validationError=e.message})},t.prototype.createFolder=function(t){var e=this;return t&&(t.stopPropagation(),t.preventDefault()),this.backendSrv.createFolder({title:this.newFolderName}).then(function(t){et.a.emit("alert-success",["文件夹已创建","OK"]),e.closeCreateFolder(),e.folder={text:t.title,value:t.id},e.onFolderChange(e.folder)})},t.prototype.cancelCreateFolder=function(t){t&&(t.stopPropagation(),t.preventDefault()),this.closeCreateFolder(),this.loadInitialValue()},t.prototype.closeCreateFolder=function(){this.exitFolderCreation(),this.createNewFolder=!1,this.hasValidationError=!1,this.validationError=null,this.newFolderName="",this.newFolderNameTouched=!1},t.prototype.loadInitialValue=function(){var t=this,e={text:this.initialTitle,value:null},a={text:this.rootName,value:0};this.getOptions("").then(function(r){var n;t.initialFolderId?n=A.a.find(r,{value:t.initialFolderId}):t.enableReset&&t.initialTitle&&null===t.initialFolderId&&(n=e),n||(n=t.isEditor?a:r.length>0?r[0]:e),t.folder=n,t.folder.value!==t.initialFolderId&&t.onChange({$folder:{id:t.folder.value,title:t.folder.text}})})},t}();I.a.directive("folderPicker",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/folder_picker/folder_picker.html",controller:Us,bindToController:!0,controllerAs:"ctrl",scope:{initialTitle:"<",initialFolderId:"<",labelClass:"@",rootName:"@",onChange:"&",onCreateFolder:"&",enterFolderCreation:"&",exitFolderCreation:"&",enableCreateNew:"@",enableReset:"@"}}});var Bs=function(){function t(t){this.backendSrv=t,this.isValidFolderSelection=!0}return t.$inject=["backendSrv"],t.prototype.onFolderChange=function(t){this.folder=t},t.prototype.save=function(){var t=this;return this.backendSrv.moveDashboards(this.dashboards,this.folder).then(function(e){if(e.successCount>0){var a=(1===e.successCount?"":"s")+" 个仪表盘已移动",r=e.successCount+" 个仪表盘 "+(1===e.successCount?"":"s")+" 移动到 "+t.folder.title;et.a.emit("alert-success",[a,r])}return e.totalCount===e.alreadyInFolderCount&&et.a.emit("alert-error",["错误","该仪表盘已存在文件夹 "+t.folder.title+" 中"]),t.dismiss(),t.afterSave()})},t.prototype.onEnterFolderCreation=function(){this.isValidFolderSelection=!1},t.prototype.onExitFolderCreation=function(){this.isValidFolderSelection=!0},t}();I.a.directive("moveToFolderModal",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/move_to_folder_modal/move_to_folder.html",controller:Bs,bindToController:!0,controllerAs:"ctrl",scope:{dismiss:"&",dashboards:"=",afterSave:"&"}}});var Qs=function(){function t(t,e,a,r,n,i){var s=this;this.$scope=t,this.$route=e,this.$location=a,this.$rootScope=r,this.backendSrv=n,this.dashboardSrv=i,t.dashboard=this.dashboard,this.$scope.$on("$destroy",function(){s.dashboard.updateSubmenuVisibility(),s.$rootScope.$broadcast("refresh"),setTimeout(function(){s.$rootScope.appEvent("dash-scroll",{restore:!0})})}),this.canSaveAs=this.dashboard.meta.canEdit&&j.c.hasEditPermissionInFolders,this.canSave=this.dashboard.meta.canSave,this.canDelete=this.dashboard.meta.canSave,this.buildSectionList(),this.onRouteUpdated(),this.$rootScope.onAppEvent("$routeUpdate",this.onRouteUpdated.bind(this),t),this.$rootScope.appEvent("dash-scroll",{animate:!1,pos:0}),this.$rootScope.onAppEvent("dashboard-saved",this.onPostSave.bind(this),t)}return t.$inject=["$scope","$route","$location","$rootScope","backendSrv","dashboardSrv"],t.prototype.buildSectionList=function(){this.sections=[],this.dashboard.meta.canEdit&&(this.sections.push({title:"通用",id:"settings",icon:"gicon gicon-preferences"}),this.sections.push({title:"注释",id:"annotations",icon:"gicon gicon-annotation"}),this.sections.push({title:"变量",id:"templating",icon:"gicon gicon-variable"}),this.sections.push({title:"链接",id:"links",icon:"gicon gicon-link"})),this.dashboard.id&&this.dashboard.meta.canSave&&this.sections.push({title:"版本",id:"versions",icon:"fa fa-fw fa-history"}),this.dashboard.id&&this.dashboard.meta.canAdmin&&this.sections.push({title:"权限",id:"permissions",icon:"fa fa-fw fa-lock"}),this.dashboard.meta.canMakeEditable&&this.sections.push({title:"通用",icon:"gicon gicon-preferences",id:"make_editable"}),this.sections.push({title:"JSON 模型",id:"dashboard_json",icon:"gicon gicon-json"});for(var t=this.$location.search(),e=this.$location.path(),a=0,r=this.sections;a<r.length;a++){var n=r[a],i=A.a.defaults({editview:n.id},t);n.url=kt.a.appSubUrl+e+"?"+F.a.param(i)}},t.prototype.onRouteUpdated=function(){this.viewId=this.$location.search().editview,this.viewId&&(this.json=P.a.toJson(this.dashboard.getSaveModelClone(),!0)),"settings"===this.viewId&&this.dashboard.meta.canMakeEditable&&(this.viewId="make_editable"),A.a.find(this.sections,{id:this.viewId})||(this.sections.unshift({title:"暂无",id:"404",icon:"fa fa-fw fa-warning"}),this.viewId="404")},t.prototype.openSaveAsModal=function(){this.dashboardSrv.showSaveAsModal()},t.prototype.saveDashboard=function(){this.dashboardSrv.saveDashboard()},t.prototype.saveDashboardJson=function(){var t=this;this.dashboardSrv.saveJSONDashboard(this.json).then(function(){t.$route.reload()})},t.prototype.onPostSave=function(){this.hasUnsavedFolderChange=!1},t.prototype.hideSettings=function(){var t=this,e=this.$location.search();delete e.editview,setTimeout(function(){t.$rootScope.$apply(function(){t.$location.search(e)})})},t.prototype.makeEditable=function(){this.dashboard.editable=!0,this.dashboard.meta.canMakeEditable=!1,this.dashboard.meta.canEdit=!0,this.dashboard.meta.canSave=!0,this.canDelete=!0,this.viewId="settings",this.buildSectionList();var t=A.a.find(this.sections,{id:this.viewId});this.$location.url(t.url)},t.prototype.deleteDashboard=function(){var t=this,e="",a=this.dashboard.title,r=A.a.sumBy(this.dashboard.panels,function(t){return t.alert?1:0});r>0&&(e="删除",a="此仪表盘包含 "+r+" 告警。 删除此仪表盘也会删除这些告警"),j.b.emit("confirm-modal",{title:"删除",text:"希望删除此仪表盘?",text2:a,icon:"fa-trash",confirmText:e,yesText:"删除",onConfirm:function(){t.dashboard.meta.canSave=!1,t.deleteDashboardConfirmed()}})},t.prototype.deleteDashboardConfirmed=function(){var t=this;this.backendSrv.deleteDashboard(this.dashboard.uid).then(function(){j.b.emit("alert-success",["仪表盘已删除",t.dashboard.title+" 已删除"]),t.$location.url("/")})},t.prototype.onFolderChange=function(t){this.dashboard.meta.folderId=t.id,this.dashboard.meta.folderTitle=t.title,this.hasUnsavedFolderChange=!0},t.prototype.getFolder=function(){return{id:this.dashboard.meta.folderId,title:this.dashboard.meta.folderTitle,url:this.dashboard.meta.folderUrl}},t}();j.d.directive("dashboardSettings",function(){return{restrict:"E",templateUrl:"public/app/features/dashboard/settings/settings.html",controller:Qs,bindToController:!0,controllerAs:"ctrl",transclude:!0,scope:{dashboard:"="}}});var Hs=function(){function t(t,e){t.panel.links=t.panel.links||[],t.addLink=function(){t.panel.links.push({type:"dashboard"})},t.searchDashboards=function(t,a){e.search({query:t}).then(function(t){var e=A.a.map(t,function(t){return t.title});a(e)})},t.dashboardChanged=function(t){e.search({query:t.dashboard}).then(function(e){var a=A.a.find(e,{title:t.dashboard});a&&(a.url?t.url=a.url:t.dashUri=a.uri,t.title=a.title)})},t.deleteLink=function(e){t.panel.links=A.a.without(t.panel.links,e)}}return t.$inject=["$scope","backendSrv"],t}();P.a.module("grafana.directives").directive("panelLinksEditor",function(){return{scope:{panel:"="},restrict:"E",controller:"PanelLinksEditorCtrl",templateUrl:"public/app/features/dashboard/panellinks/module.html",link:function(){}}}).controller("PanelLinksEditorCtrl",Hs);var zs={"external link":"fa-external-link",dashboard:"fa-th-large",question:"fa-question",info:"fa-info",bolt:"fa-bolt",doc:"fa-file-text-o",cloud:"fa-cloud"},Ys=function(){function t(t,e){this.iconMap=zs,this.dashboard.links=this.dashboard.links||[],this.mode="list",t.$on("$destroy",function(){e.appEvent("dash-links-updated")})}return t.$inject=["$scope","$rootScope"],t.prototype.backToList=function(){this.mode="list"},t.prototype.setupNew=function(){this.mode="new",this.link={type:"dashboards",icon:"external link"}},t.prototype.addLink=function(){this.dashboard.links.push(this.link),this.mode="list"},t.prototype.editLink=function(t){this.link=t,this.mode="edit",console.log(this.link)},t.prototype.saveLink=function(){this.backToList()},t.prototype.moveLink=function(t,e){A.a.move(this.dashboard.links,t,t+e)},t.prototype.deleteLink=function(t){this.dashboard.links.splice(t,1),this.dashboard.updateSubmenuVisibility()},t}();function Ws(t,e,a){return{restrict:"E",link:function(r,n){var i=r.link,s='<div class="gf-form"><a class="pointer gf-form-label" data-placement="bottom"'+(i.asDropdown?' ng-click="fillDropdown(link)" data-toggle="dropdown"':"")+"><i></i> <span></span></a>";function o(){var t=a.getAnchorInfo(i),s=n.find("a");n.find("span").text(t.title),i.asDropdown||(s.attr("href",t.href),function(){var t=n.find("a"),a=e(t.parent().html());t.parent().html(a)}()),s.attr("data-placement","bottom"),s.tooltip({title:e(r.link.tooltip),html:!0,container:"body"})}i.asDropdown&&(s+='<ul class="dropdown-menu" role="menu"><li ng-repeat="dash in link.searchHits"><a href="{{dash.url}}" target="{{dash.target}}">{{dash.title}}</a></li></ul>'),s+="</div>",n.html(s),t(n.contents())(r),n.find("i").attr("class","fa fa-fw "+r.link.icon),n.find("a").attr("target",r.link.target),i.asDropdown&&r.$last&&n.find(".dropdown-menu").addClass("pull-right"),o(),r.$on("refresh",o)}}}P.a.module("grafana.directives").directive("dashLinksEditor",function(){return{restrict:"E",controller:Ys,templateUrl:"public/app/features/dashboard/dashlinks/editor.html",bindToController:!0,controllerAs:"ctrl",scope:{dashboard:"="}}});var Gs=function(){function t(t,e,a,r,n,i){var s=n.getCurrent().id;function o(e){return"dashboards"===e.type?e.tags?e.asDropdown?a.when([{title:e.title,tags:e.tags,keepTime:e.keepTime,includeVars:e.includeVars,target:e.targetBlank?"_blank":"_self",icon:"fa fa-bars",asDropdown:!0}]):t.searchDashboards(e,7):(console.log("Dashboard link missing tag"),a.when([])):"link"===e.type?a.when([{url:e.url,title:e.title,icon:zs[e.icon],tooltip:e.tooltip,target:e.targetBlank?"_blank":"_self",keepTime:e.keepTime,includeVars:e.includeVars}]):a.when([])}function l(){var e=A.a.map(t.links,o);a.all(e).then(function(e){t.generatedLinks=A.a.flatten(e)})}t.searchDashboards=function(t,e){return r.search({tag:t.tags,limit:e}).then(function(e){return A.a.reduce(e,function(e,a){return a.id!==s&&e.push({title:a.title,url:a.url,target:"_self"===t.target?"":t.target,icon:"fa fa-th-large",keepTime:t.keepTime,includeVars:t.includeVars}),e},[])})},t.fillDropdown=function(e){t.searchDashboards(e,100).then(function(t){A.a.each(t,function(t){t.url=i.getLinkUrl(t)}),e.searchHits=t})},l(),e.onAppEvent("dash-links-updated",l,t)}return t.$inject=["$scope","$rootScope","$q","backendSrv","dashboardSrv","linkSrv"],t}();P.a.module("grafana.directives").directive("dashLinksContainer",function(){return{scope:{links:"="},restrict:"E",controller:"DashLinksContainerCtrl",template:'<dash-link ng-repeat="link in generatedLinks" link="link"></dash-link>',link:function(){}}}),P.a.module("grafana.directives").directive("dashLink",Ws),P.a.module("grafana.directives").controller("DashLinksContainerCtrl",Gs);var Ks=function(){function t(t){this.backendSrv=t}return t.prototype.load=function(t,e,a){return t.navModel={main:{icon:"fa fa-folder-open",id:"manage-folder",subTitle:"管理文件夹仪表盘与权限",url:"",text:"",breadcrumbs:[{title:"仪表盘",url:"dashboards"}],children:[{active:"manage-folder-dashboards"===a,icon:"fa fa-fw fa-th-large",id:"manage-folder-dashboards",text:"仪表盘",url:"dashboards"},{active:"manage-folder-permissions"===a,icon:"fa fa-fw fa-lock",id:"manage-folder-permissions",text:"权限",url:"dashboards/permissions"},{active:"manage-folder-settings"===a,icon:"fa fa-fw fa-cog",id:"manage-folder-settings",text:"设置",url:"dashboards/settings"}]}},this.backendSrv.getFolderByUid(e).then(function(e){t.folderId=e.id;var a=e.title,r=e.url;t.navModel.main.text=a;var n=t.navModel.main.children.find(function(t){return"manage-folder-dashboards"===t.id});(n.url=r,e.canAdmin)?(t.navModel.main.children.find(function(t){return"manage-folder-permissions"===t.id}).url=r+"/permissions",t.navModel.main.children.find(function(t){return"manage-folder-settings"===t.id}).url=r+"/settings"):t.navModel.main.children=[n];return e})},t}(),Js=function(){function t(t,e,a,r){(this.backendSrv=t,this.$routeParams=a,this.$routeParams.uid)&&(this.uid=a.uid,new Ks(this.backendSrv).load(this,this.uid,"manage-folder-dashboards").then(function(t){var e=Lt.b.stripBaseFromUrl(t.url);e!==r.path()&&r.path(e).replace()}))}return t.$inject=["backendSrv","navModelSrv","$routeParams","$location"],t}(),Xs=function(){function t(t,e,a,r){var n=this;this.backendSrv=t,this.$routeParams=a,this.$location=r,this.canSave=!1,this.$routeParams.uid&&(this.uid=a.uid,this.folderPageLoader=new Ks(this.backendSrv),this.folderPageLoader.load(this,this.uid,"manage-folder-settings").then(function(t){r.path()!==t.meta.url&&r.path(t.meta.url+"/settings").replace(),n.folder=t,n.canSave=n.folder.canSave,n.title=n.folder.title}))}return t.$inject=["backendSrv","navModelSrv","$routeParams","$location"],t.prototype.save=function(){var t=this;if(this.titleChanged(),this.hasChanged)return this.folder.title=this.title.trim(),this.backendSrv.updateFolder(this.folder).then(function(e){e.url!==t.$location.path()&&t.$location.url(e.url+"/settings"),et.a.emit("dashboard-saved"),et.a.emit("alert-success",["文件夹已保存"])}).catch(this.handleSaveFolderError)},t.prototype.titleChanged=function(){this.hasChanged=this.folder.title.toLowerCase()!==this.title.trim().toLowerCase()},t.prototype.delete=function(t){var e=this;t&&(t.stopPropagation(),t.preventDefault()),et.a.emit("confirm-modal",{title:"删除",text:"要删除此文件夹及其所有仪表盘吗?",icon:"fa-trash",yesText:"删除",onConfirm:function(){return e.backendSrv.deleteFolder(e.uid).then(function(){et.a.emit("alert-success",["文件夹已删除",e.folder.title+" 已被删除"]),e.$location.url("dashboards")})}})},t.prototype.handleSaveFolderError=function(t){var e=this;t.data&&"version-mismatch"===t.data.status&&(t.isHandled=!0,et.a.emit("confirm-modal",{title:"冲突",text:"其他人已更新此文件夹。",text2:"你还想保存这个文件夹吗?",yesText:"保存 & 覆盖",icon:"fa-warning",onConfirm:function(){e.backendSrv.updateFolder(e.folder,{overwrite:!0})}}))},t}(),Zs=function(){function t(t,e,a,r,n){this.backendSrv=t,this.validationSrv=e,this.$location=r,this.navModel=a.getNav("create","import"),this.step=1,this.nameExists=!1,this.uidExists=!1,this.autoGenerateUid=!0,this.autoGenerateUidValue="auto-generated",this.folderId=n.folderId?Number(n.folderId)||0:null,this.initialFolderTitle="选择一个文件夹",n.gnetId&&(this.gnetUrl=n.gnetId,this.checkGnetDashboard())}return t.$inject=["backendSrv","validationSrv","navModelSrv","$location","$routeParams"],t.prototype.onUpload=function(t){if(this.dash=t,this.dash.id=null,this.step=2,this.inputs=[],this.dash.__inputs)for(var e=0,a=this.dash.__inputs;e<a.length;e++){var r=a[e],n={name:r.name,label:r.label,info:r.description,value:r.value,type:r.type,pluginId:r.pluginId,options:[]};"datasource"===r.type?this.setDatasourceOptions(r,n):n.info||(n.info="指定字符串常量"),this.inputs.push(n)}this.inputsValid=0===this.inputs.length,this.titleChanged(),this.uidChanged(!0)},t.prototype.setDatasourceOptions=function(t,e){var a=A.a.filter(kt.a.datasources,function(e){return e.type===t.pluginId});0===a.length?e.info="没有找到 "+t.pluginName+" 类型的数据源":e.info||(e.info="选择一个 "+t.pluginName+" 数据源"),e.options=a.map(function(t){return{text:t.name,value:t.name}})},t.prototype.inputValueChanged=function(){this.inputsValid=!0;for(var t=0,e=this.inputs;t<e.length;t++){e[t].value||(this.inputsValid=!1)}},t.prototype.titleChanged=function(){var t=this;this.titleTouched=!0,this.nameExists=!1,this.validationSrv.validateNewDashboardName(this.folderId,this.dash.title).then(function(){t.nameExists=!1,t.hasNameValidationError=!1}).catch(function(e){"EXISTING"===e.type&&(t.nameExists=!0),t.hasNameValidationError=!0,t.nameValidationError=e.message})},t.prototype.uidChanged=function(t){var e=this;this.uidExists=!1,this.hasUidValidationError=!1,!0===t&&this.dash.uid&&(this.autoGenerateUidValue="value set"),this.backendSrv.getDashboardByUid(this.dash.uid).then(function(t){e.uidExists=!0,e.hasUidValidationError=!0,e.uidValidationError="名为 '"+t.dashboard.title+"' 的仪表盘在文件夹 '"+t.meta.folderTitle+"' 中存在相同的 uid"}).catch(function(t){t.isHandled=!0})},t.prototype.onFolderChange=function(t){this.folderId=t.id,this.titleChanged()},t.prototype.onEnterFolderCreation=function(){this.inputsValid=!1},t.prototype.onExitFolderCreation=function(){this.inputValueChanged()},t.prototype.isValid=function(){return this.inputsValid&&null!==this.folderId},t.prototype.saveDashboard=function(){var t=this,e=this.inputs.map(function(t){return{name:t.name,type:t.type,pluginId:t.pluginId,value:t.value}});return this.backendSrv.post("api/dashboards/import",{dashboard:this.dash,overwrite:!0,inputs:e,folderId:this.folderId}).then(function(e){var a=Lt.b.stripBaseFromUrl(e.importedUrl);t.$location.url(a)})},t.prototype.loadJsonText=function(){try{this.parseError="";var t=JSON.parse(this.jsonText);this.onUpload(t)}catch(t){return console.log(t),void(this.parseError=t.message)}},t.prototype.checkGnetDashboard=function(){var t=this;this.gnetError="";var e,a=/(^\d+$)|dashboards\/(\d+)/.exec(this.gnetUrl);return a&&a[1]?e=a[1]:a&&a[2]?e=a[2]:this.gnetError="Could not find dashboard",this.backendSrv.get("api/gnet/dashboards/"+e).then(function(e){t.gnetInfo=e,e.json.gnetId=e.id,t.onUpload(e.json)}).catch(function(e){e.isHandled=!0,t.gnetError=e.data.message||e})},t.prototype.back=function(){this.gnetUrl="",this.step=1,this.gnetError="",this.gnetInfo=""},t}(),to=function(){function t(t,e,a,r){this.backendSrv=t,this.$location=e,this.validationSrv=a,this.title="",this.titleTouched=!1,this.navModel=r.getNav("dashboards","manage-dashboards",0)}return t.$inject=["backendSrv","$location","validationSrv","navModelSrv"],t.prototype.create=function(){var t=this;if(!this.hasValidationError)return this.backendSrv.createFolder({title:this.title}).then(function(e){et.a.emit("alert-success",["文件夹已创建","完成"]),t.$location.url(Lt.b.stripBaseFromUrl(e.url))})},t.prototype.titleChanged=function(){var t=this;this.titleTouched=!0,this.validationSrv.validateNewFolderName(this.title).then(function(){t.hasValidationError=!1}).catch(function(e){t.hasValidationError=!0,t.validationError=e.message})},t}();I.a.controller("FolderDashboardsCtrl",Js),I.a.controller("FolderSettingsCtrl",Xs),I.a.controller("DashboardImportCtrl",Zs),I.a.controller("CreateFolderCtrl",to);var eo=function(){function t(t,e,a){var r=this;this.$scope=t,this.backendSrv=e,this.navModel=a.getNav("dashboards","playlists",0),e.get("/api/playlists").then(function(t){r.playlists=t.map(function(t){return t.startUrl="playlists/play/"+t.id,t})})}return t.$inject=["$scope","backendSrv","navModelSrv"],t.prototype.removePlaylistConfirmed=function(t){var e=this;A.a.remove(this.playlists,{id:t.id}),this.backendSrv.delete("/api/playlists/"+t.id).then(function(){e.$scope.appEvent("alert-success",["播放列表已删除",""])},function(){e.$scope.appEvent("alert-error",["无法删除播放列表",""]),e.playlists.push(t)})},t.prototype.removePlaylist=function(t){var e=this;this.$scope.appEvent("confirm-modal",{title:"删除",text:"确定想要删除播放列表 "+t.name+"?",yesText:"删除",icon:"fa-trash",onConfirm:function(){e.removePlaylistConfirmed(t)}})},t}();I.a.controller("PlaylistsCtrl",eo);var ao=function(){function t(t,e){var a=this;this.backendSrv=e,this.query={query:"",tag:[],starred:!1,limit:20},t(function(){a.query.query="",a.query.type="dash-db",a.searchDashboards()},100)}return t.$inject=["$timeout","backendSrv"],t.prototype.searchDashboards=function(){this.tagsMode=!1;var t={};t.promise=this.backendSrv.search(this.query).then(function(t){return{dashboardResult:t,tagResult:[]}}),this.searchStarted(t)},t.prototype.showStarred=function(){this.query.starred=!this.query.starred,this.searchDashboards()},t.prototype.queryHasNoFilters=function(){return""===this.query.query&&!1===this.query.starred&&0===this.query.tag.length},t.prototype.filterByTag=function(t,e){this.query.tag.push(t),this.searchDashboards(),e&&(e.stopPropagation(),e.preventDefault())},t.prototype.getTags=function(){var t={};t.promise=this.backendSrv.get("/api/dashboards/tags").then(function(t){return{dashboardResult:[],tagResult:t}}),this.searchStarted(t)},t}();I.a.directive("playlistSearch",function(){return{restrict:"E",templateUrl:"public/app/features/playlist/partials/playlist_search.html",controller:ao,bindToController:!0,controllerAs:"ctrl",scope:{searchStarted:"&"}}});var ro=a(181),no=function(){function t(t,e,a){this.$location=t,this.$timeout=e,this.backendSrv=a}return t.$inject=["$location","$timeout","backendSrv"],t.prototype.next=function(){var t=this;if(this.$timeout.cancel(this.cancelPromise),this.index>this.dashboards.length-1)window.location.href=this.startUrl;else{var e=this.dashboards[this.index],a=this.$location.search(),r=A.a.pickBy(a,function(t){return null!==t});this.$location.url("dashboard/"+e.uri+"?"+Object(ro.a)(r)),this.index++,this.cancelPromise=this.$timeout(function(){return t.next()},this.interval)}},t.prototype.prev=function(){this.index=Math.max(this.index-2,0),this.next()},t.prototype.start=function(t){var e=this;this.stop(),this.startUrl=window.location.href,this.index=0,this.isPlaying=!0,this.backendSrv.get("/api/playlists/"+t).then(function(a){e.backendSrv.get("/api/playlists/"+t+"/dashboards").then(function(t){e.dashboards=t,e.interval=J.a.interval_to_ms(a.interval),e.next()})})},t.prototype.stop=function(){this.isPlaying&&(this.$location.search().kiosk&&et.a.emit("toggle-kiosk-mode",{exit:!0}));this.index=0,this.isPlaying=!1,this.cancelPromise&&this.$timeout.cancel(this.cancelPromise)},t}();I.a.service("playlistSrv",no);var io=function(){function t(t,e,a,r,n){var i=this;if(this.$scope=t,this.backendSrv=e,this.$location=a,this.filteredDashboards=[],this.filteredTags=[],this.searchQuery="",this.loading=!1,this.playlist={interval:"5m"},this.playlistItems=[],this.dashboardresult=[],this.tagresult=[],this.navModel=n.getNav("dashboards","playlists",0),this.isNew=!r.current.params.id,r.current.params.id){var s=r.current.params.id;e.get("/api/playlists/"+s).then(function(t){i.playlist=t}),e.get("/api/playlists/"+s+"/items").then(function(t){i.playlistItems=t})}}return t.$inject=["$scope","backendSrv","$location","$route","navModelSrv"],t.prototype.filterFoundPlaylistItems=function(){var t=this;this.filteredDashboards=A.a.reject(this.dashboardresult,function(e){return A.a.find(t.playlistItems,function(t){return parseInt(t.value,10)===e.id})}),this.filteredTags=A.a.reject(this.tagresult,function(e){return A.a.find(t.playlistItems,function(t){return t.value===e.term})})},t.prototype.addPlaylistItem=function(t){t.value=t.id.toString(),t.type="dashboard_by_id",t.order=this.playlistItems.length+1,this.playlistItems.push(t),this.filterFoundPlaylistItems()},t.prototype.addTagPlaylistItem=function(t){var e={value:t.term,type:"dashboard_by_tag",order:this.playlistItems.length+1,title:t.term};this.playlistItems.push(e),this.filterFoundPlaylistItems()},t.prototype.removePlaylistItem=function(t){A.a.remove(this.playlistItems,function(e){return t===e}),this.filterFoundPlaylistItems()},t.prototype.savePlaylist=function(t,e){var a=this;t.items=e,(t.id?this.backendSrv.put("/api/playlists/"+t.id,t):this.backendSrv.post("/api/playlists",t)).then(function(){a.$scope.appEvent("alert-success",["播放列表已保存",""]),a.$location.path("/playlists")},function(){a.$scope.appEvent("alert-error",["无法保存播放列表",""])})},t.prototype.isPlaylistEmpty=function(){return!this.playlistItems.length},t.prototype.backToList=function(){this.$location.path("/playlists")},t.prototype.searchStarted=function(t){var e=this;t.then(function(t){e.dashboardresult=t.dashboardResult,e.tagresult=t.tagResult,e.filterFoundPlaylistItems()})},t.prototype.movePlaylistItem=function(t,e){var a=this.playlistItems.indexOf(t),r=a+e;r>=0&&r<this.playlistItems.length&&(this.playlistItems.splice(a,1),this.playlistItems.splice(r,0,t))},t.prototype.movePlaylistItemUp=function(t){this.movePlaylistItem(t,-1)},t.prototype.movePlaylistItemDown=function(t){this.movePlaylistItem(t,1)},t}();function so(t){t.when("/playlists",{templateUrl:"public/app/features/playlist/partials/playlists.html",controllerAs:"ctrl",controller:"PlaylistsCtrl"}).when("/playlists/create",{templateUrl:"public/app/features/playlist/partials/playlist.html",controllerAs:"ctrl",controller:"PlaylistEditCtrl"}).when("/playlists/edit/:id",{templateUrl:"public/app/features/playlist/partials/playlist.html",controllerAs:"ctrl",controller:"PlaylistEditCtrl"}).when("/playlists/play/:id",{template:"",resolve:{init:["playlistSrv","$route",function(t,e){var a=e.current.params.id;t.start(a)}]}})}I.a.controller("PlaylistEditCtrl",io),P.a.module("grafana.routes").config(so);var oo='\n<span class="panel-title">\n  <span class="icon-gf panel-alert-icon"></span>\n  <span class="panel-title-text">{{ctrl.panel.title | interpolateTemplateVars:this}}</span>\n  <span class="panel-menu-container dropdown">\n    <span class="fa fa-caret-down panel-menu-toggle" data-toggle="dropdown"></span>\n    <ul class="dropdown-menu dropdown-menu--menu panel-menu" role="menu">\n      <li>\n        <a ng-click="ctrl.addDataQuery(datasource);">\n          <i class="fa fa-cog"></i> 编辑 <span class="dropdown-menu-item-shortcut">e</span>\n        </a>\n      </li>\n      <li class="dropdown-submenu">\n        <a ng-click="ctrl.addDataQuery(datasource);"><i class="fa fa-cube"></i> Actions</a>\n        <ul class="dropdown-menu panel-menu">\n          <li><a ng-click="ctrl.addDataQuery(datasource);"><i class="fa fa-flash"></i> 添加注释</a></li>\n          <li><a ng-click="ctrl.addDataQuery(datasource);"><i class="fa fa-bullseye"></i> 切换图例</a></li>\n          <li><a ng-click="ctrl.addDataQuery(datasource);"><i class="fa fa-download"></i> 导出CSV</a></li>\n          <li><a ng-click="ctrl.addDataQuery(datasource);"><i class="fa fa-eye"></i> 查看JSON</a></li>\n        </ul>\n      </li>\n      <li><a ng-click="ctrl.addDataQuery(datasource);"><i class="fa fa-trash"></i> 移除</a></li>\n    </ul>\n  </span>\n  <span class="panel-time-info" ng-if="ctrl.timeInfo"><i class="fa fa-clock-o"></i> {{ctrl.timeInfo}}</span>\n</span>';function lo(t,e){var a="",r="";if(t.divider)return'<li class="divider"></li>';if(t.submenu&&(r="dropdown-submenu"),a+='<li class="'+r+'"><a ',t.click&&(a+=' ng-click="'+t.click+'"'),t.href&&(a+=' href="'+t.href+'"'),a+='><i class="'+t.icon+'"></i>',a+='<span class="dropdown-item-text">'+t.text+"</span>",t.shortcut&&(a+='<span class="dropdown-menu-item-shortcut">'+t.shortcut+"</span>"),a+="</a>",t.submenu){a+='<ul class="dropdown-menu dropdown-menu--menu panel-menu">';for(var n=0,i=t.submenu;n<i.length;n++){a+=lo(i[n],e)}a+="</ul>"}return a+="</li>"}function uo(t){return{restrict:"E",template:oo,link:function(e,a,r){var n,i,s,o,l=a.find(".panel-menu");function u(){var t=a.find("[data-toggle=dropdown]").parentsUntil(".panel").parent(),e=a.find("[data-toggle=dropdown]").parent();if(t=t&&t.length?t[0]:void 0){t=F()(t),F()(".react-grid-item.panel").removeClass("dropdown-menu-open");var r=!e.hasClass("open");t.toggleClass("dropdown-menu-open",r)}}a.click(function(r){var s=r.target.className;n&&n.$destroy(),n=e.$new();var o=function(t){for(var e="",a=0,r=t.getMenu();a<r.length;a++)e+=lo(r[a],t);return e}(e.ctrl);l.html(o),t(l)(n),(s.indexOf("panel-title-text")>=0||s.indexOf("panel-title")>=0)&&function(t){i||(t.stopPropagation(),u(),a.find("[data-toggle=dropdown]").dropdown("toggle"))}(r)}),a.find(".panel-menu-toggle").click(function(){u()}),a.mousedown(function(t){s=t.pageX,o=t.pageY}),a.mouseup(function(t){i=s!==t.pageX||o!==t.pageY})}}}j.d.directive("panelHeader",uo);var co=P.a.module("grafana.directives");co.directive("grafanaPanel",["$rootScope","$document","$timeout",function(t,e,a){return{restrict:"E",template:'\n  <div class="panel-container">\n    <div class="panel-header" ng-class="{\'grid-drag-handle\': !ctrl.fullscreen}">\n      <span class="panel-info-corner">\n        <i class="fa"></i>\n        <span class="panel-info-corner-inner"></span>\n      </span>\n\n      <span class="panel-loading" ng-show="ctrl.loading">\n        <i class="fa fa-spinner fa-spin"></i>\n      </span>\n\n      <panel-header class="panel-title-container" panel-ctrl="ctrl"></panel-header>\n    </div>\n\n    <div class="panel-content">\n      <ng-transclude class="panel-height-helper"></ng-transclude>\n    </div>\n  </div>\n\n  <div class="panel-full-edit" ng-if="ctrl.editMode">\n    <div class="tabbed-view tabbed-view--panel-edit">\n      <div class="tabbed-view-header">\n        <h3 class="tabbed-view-panel-title">\n          {{ctrl.pluginName}}\n        </h3>\n\n        <ul class="gf-tabs">\n          <li class="gf-tabs-item" ng-repeat="tab in ::ctrl.editorTabs">\n            <a class="gf-tabs-link" ng-click="ctrl.changeTab($index)" ng-class="{active: ctrl.editorTabIndex === $index}">\n              {{::tab.title}}\n            </a>\n          </li>\n        </ul>\n\n        <button class="tabbed-view-close-btn" ng-click="ctrl.exitFullscreen();">\n          <i class="fa fa-remove"></i>\n        </button>\n      </div>\n\n      <div class="tabbed-view-body">\n        <div ng-repeat="tab in ctrl.editorTabs" ng-if="ctrl.editorTabIndex === $index">\n          <panel-editor-tab editor-tab="tab" ctrl="ctrl" index="$index"></panel-editor-tab>\n        </div>\n      </div>\n    </div>\n  </div>\n',transclude:!0,scope:{ctrl:"="},link:function(t,e){var r,n,i,s,o=e.find(".panel-container"),l=e.find(".panel-content"),u=e.find(".panel-info-corner"),c=t.ctrl,h=!1,p=!1;function d(){l.css({height:c.height+"px"})}function m(){var t=c.getInfoMode();u[0].className="panel-info-corner panel-info-corner--"+t,t&&(r&&r.destroy(),r=new Qe.a({target:u[0],content:function(){return c.getInfoContent({mode:"tooltip"})},classes:c.error?"drop-error":"drop-help",openOn:"hover",hoverOpenDelay:100,tetherOptions:{attachment:"bottom left",targetAttachment:"top left",constraints:[{to:"window",attachment:"together",pin:!0}]}}))}c.panel.transparent&&(h=!0,o.addClass("panel-transparent",!0)),c.events.on("component-did-mount",function(){if(c.__proto__.constructor.scrollable){var t=l,e=l.find(":first").find(":first");t.addClass("baron baron__root baron__clipper panel-content--scrollable"),F()('\n            <div class="baron__track">\n              <div class="baron__bar"></div>\n            </div>\n          ').appendTo(t),e.addClass("baron__scroller"),(n=Mn()({root:t[0],scroller:e[0],bar:".baron__bar",barOnCls:"_scrollbar",scrollingCls:"_scrolling"})).scroll()}}),c.events.on("panel-size-changed",function(){c.calculatePanelHeight(),d(),a(function(){n&&n.update(),c.render()})}),c.calculatePanelHeight(),d(),c.events.on("render",function(){h!==c.panel.transparent&&(o.toggleClass("panel-transparent",!0===c.panel.transparent),h=c.panel.transparent),s=void 0!==c.panel.alert,p!==s&&(o.toggleClass("panel-has-alert",s),p=s),c.alertState?(i&&o.removeClass("panel-alert-state--"+i),"ok"!==c.alertState.state&&"alerting"!==c.alertState.state||o.addClass("panel-alert-state--"+c.alertState.state),i=c.alertState.state):i&&(o.removeClass("panel-alert-state--"+i),i=null)}),t.$watchGroup(["ctrl.error","ctrl.panel.description"],m),t.$watchCollection("ctrl.panel.links",m),u.on("click",function(){r.close(),t.$apply(c.openInspector.bind(c))}),e.on("mouseenter",function(){o.toggleClass("panel-hover-highlight",!0),c.dashboard.setPanelFocus(c.panel.id)}),e.on("mouseleave",function(){o.toggleClass("panel-hover-highlight",!1),c.dashboard.setPanelFocus(0)}),t.$on("$destroy",function(){e.off(),u.off(),r&&r.destroy(),n&&n.dispose()})}}}]),co.directive("panelHelpCorner",["$rootScope",function(t){return{restrict:"E",template:'\n    <span class="alert-error panel-error small pointer" ng-if="ctrl.error" ng-click="ctrl.openInspector()">\n    <span data-placement="top" bs-tooltip="ctrl.error">\n    <i class="fa fa-exclamation"></i><span class="panel-error-arrow"></span>\n    </span>\n    </span>\n    ',link:function(t,e){}}}]);var ho=function(){function t(t,e,a,r,n,i){var s;t.init=function(){n.sidemenu=!1,et.a.emit("toggle-sidemenu-hidden");var o=a.search();s=parseInt(o.panelId,10),t.onAppEvent("dashboard-initialized",t.initPanelScope),"script"===e.type||"snapshot"===e.type||e.uid?r.loadDashboard(e.type,e.slug,e.uid).then(function(e){e.meta.soloMode=!0,t.initDashboard(e,t)}):i.getDashboardBySlug(e.slug).then(function(t){if(t){var e=Lt.b.stripBaseFromUrl(t.meta.url.replace("/d/","/d-solo/"));a.path(e).replace()}})},t.initPanelScope=function(){var e=t.dashboard.getPanelInfoById(s);t.ctrl={dashboard:t.dashboard},t.panel=e.panel,t.panel.soloMode=!0,t.$index=0,t.panel||t.appEvent("alert-error",["未找到面板",""])},t.init()}return t.$inject=["$scope","$routeParams","$location","dashboardLoaderSrv","contextSrv","backendSrv"],t}();function po(t){return t.create({scope:{ctrl:"=",editorTab:"=",index:"="},directive:function(t){var e=t.ctrl.pluginId,a=t.index;return Promise.resolve({name:"panel-editor-tab-"+e+a,fn:function(){return t.editorTab.directiveFn()}})}})}P.a.module("grafana.routes").controller("SoloPanelCtrl",ho),P.a.module("grafana.directives").directive("panelEditorTab",po);var mo=P.a.module("grafana.directives"),fo=function(){function t(){this.panelCtrl=this.queryCtrl.panelCtrl,this.target=this.queryCtrl.target,this.panel=this.panelCtrl.panel,this.target.refId||(this.target.refId=this.panelCtrl.dashboard.getNextQueryLetter(this.panel)),this.toggleCollapse(!0),this.target.isNew&&(delete this.target.isNew,this.toggleCollapse(!1)),this.panel.targets.length<4&&(this.collapsed=!1)}return t.prototype.toggleHideQuery=function(){this.target.hide=!this.target.hide,this.panelCtrl.refresh()},t.prototype.toggleCollapse=function(t){if(this.canCollapse){this.panelCtrl.__collapsedQueryCache||(this.panelCtrl.__collapsedQueryCache={}),t?this.collapsed=!1!==this.panelCtrl.__collapsedQueryCache[this.target.refId]:(this.collapsed=!this.collapsed,this.panelCtrl.__collapsedQueryCache[this.target.refId]=this.collapsed);try{this.collapsedText=this.queryCtrl.getCollapsedText()}catch(t){var e=t.message||t.toString();this.collapsedText="Error: "+e}}},t.prototype.toggleEditorMode=function(){this.canCollapse&&this.collapsed&&(this.collapsed=!1),this.queryCtrl.toggleEditorMode()},t.prototype.removeQuery=function(){this.panelCtrl.__collapsedQueryCache&&delete this.panelCtrl.__collapsedQueryCache[this.target.refId],this.panelCtrl.removeQuery(this.target)},t.prototype.duplicateQuery=function(){var t=P.a.copy(this.target);this.panelCtrl.addQuery(t)},t.prototype.moveQuery=function(t){this.panelCtrl.moveQuery(this.target,t)},t}();mo.directive("queryEditorRow",function(){return{restrict:"E",controller:fo,bindToController:!0,controllerAs:"ctrl",templateUrl:"public/app/features/panel/partials/query_editor_row.html",transclude:!0,scope:{queryCtrl:"=",canCollapse:"=",hasTextEditMode:"="}}});var go='\n<div class="query-troubleshooter" ng-if="ctrl.isOpen">\n  <div class="query-troubleshooter__header">\n    <a class="pointer" ng-click="ctrl.toggleMocking()">模拟响应</a>\n    <a class="pointer" ng-click="ctrl.toggleExpand()" ng-hide="ctrl.allNodesExpanded">\n      <i class="fa fa-plus-square-o"></i> 展开全部\n    </a>\n    <a class="pointer" ng-click="ctrl.toggleExpand()" ng-show="ctrl.allNodesExpanded">\n      <i class="fa fa-minus-square-o"></i> 折叠全部\n    </a>\n    <a class="pointer" clipboard-button="ctrl.getClipboardText()"><i class="fa fa-clipboard"></i> 复制到剪贴板</a>\n  </div>\n  <div class="query-troubleshooter__body" ng-hide="ctrl.isMocking">\n    <i class="fa fa-spinner fa-spin" ng-show="ctrl.isLoading"></i>\n    <div class="query-troubleshooter-json"></div>\n  </div>\n  <div class="query-troubleshooter__body" ng-show="ctrl.isMocking">\n    <div class="gf-form p-l-1 gf-form--v-stretch">\n\t\t\t<textarea class="gf-form-input" style="width: 95%" rows="10" ng-model="ctrl.mockedResponse"  placeholder="JSON"></textarea>\n    </div>\n  </div>\n</div>\n',vo=function(){function t(t,e){this.$timeout=e,this.onRequestErrorEventListener=this.onRequestError.bind(this),this.onRequestResponseEventListener=this.onRequestResponse.bind(this),et.a.on("ds-request-response",this.onRequestResponseEventListener),et.a.on("ds-request-error",this.onRequestErrorEventListener),t.$on("$destroy",this.removeEventsListeners.bind(this)),t.$watch("ctrl.isOpen",this.stateChanged.bind(this))}return t.$inject=["$scope","$timeout"],t.prototype.removeEventsListeners=function(){et.a.off("ds-request-response",this.onRequestResponseEventListener),et.a.off("ds-request-error",this.onRequestErrorEventListener)},t.prototype.toggleMocking=function(){this.isMocking=!this.isMocking},t.prototype.onRequestError=function(t){this.isOpen&&(this.isOpen=!0,this.hasError=!0,this.onRequestResponse(t))},t.prototype.stateChanged=function(){this.isOpen&&(this.panelCtrl.refresh(),this.isLoading=!0)},t.prototype.getClipboardText=function(){return this.jsonExplorer?JSON.stringify(this.jsonExplorer.json,null,2):""},t.prototype.handleMocking=function(t){var e;try{e=JSON.parse(this.mockedResponse)}catch(t){return void et.a.emit("alert-error",["无法解析模拟的响应"])}t.data=e},t.prototype.onRequestResponse=function(t){this.isOpen&&(this.isMocking?this.handleMocking(t):(this.isLoading=!1,(t=A.a.cloneDeep(t)).headers&&delete t.headers,t.config&&(t.request=t.config,delete t.config,delete t.request.transformRequest,delete t.request.transformResponse,delete t.request.paramSerializer,delete t.request.jsonpCallbackParam,delete t.request.headers,delete t.request.requestId,delete t.request.inspect,delete t.request.retry,delete t.request.timeout),t.data&&(t.response=t.data,200===t.status&&this.hasError&&(this.hasError=!1,this.isOpen=!1),delete t.data,delete t.status,delete t.statusText,delete t.$$config),this.$timeout(A.a.partial(this.renderJsonExplorer,t))))},t.prototype.toggleExpand=function(t){this.jsonExplorer&&(this.allNodesExpanded=!this.allNodesExpanded,this.jsonExplorer.openAtDepth(this.allNodesExpanded?20:1))},t}();j.d.directive("queryTroubleshooter",function(){return{restrict:"E",template:go,controller:vo,bindToController:!0,controllerAs:"ctrl",scope:{panelCtrl:"=",isOpen:"="},link:function(t,e,a,r){r.renderJsonExplorer=function(t){var a=e.find(".query-troubleshooter-json");r.jsonExplorer=new j.a(t,3,{animateOpen:!0});var n=r.jsonExplorer.render(!0);a.html(n)}}}});var yo=function(){function t(t,e,a,r){this.$scope=t,this.backendSrv=e,this.navModel=a.getNav("cfg","users",0),this.get(),this.externalUserMngLinkUrl=kt.a.externalUserMngLinkUrl,this.externalUserMngLinkName=kt.a.externalUserMngLinkName,this.canInvite=!kt.a.disableLoginForm&&!kt.a.externalUserMngLinkName,kt.a.externalUserMngInfo&&(this.externalUserMngInfo=new gt.a({linkTarget:"__blank"}).render(kt.a.externalUserMngInfo))}return t.$inject=["$scope","backendSrv","navModelSrv","$sce"],t.prototype.get=function(){var t=this;this.backendSrv.get("/api/org/users").then(function(e){t.users=e,t.unfiltered=e}),this.backendSrv.get("/api/org/invites").then(function(e){t.pendingInvites=e})},t.prototype.onQueryUpdated=function(){var t=new RegExp(this.searchQuery,"ig");this.users=A.a.filter(this.unfiltered,function(e){return t.test(e.email)||t.test(e.login)})},t.prototype.updateOrgUser=function(t){this.backendSrv.patch("/api/org/users/"+t.userId,t)},t.prototype.removeUser=function(t){var e=this;this.$scope.appEvent("confirm-modal",{title:"删除",text:"您确定要删除用户 "+t.login+"?",yesText:"删除",icon:"fa-warning",onConfirm:function(){e.removeUserConfirmed(t)}})},t.prototype.removeUserConfirmed=function(t){this.backendSrv.delete("/api/org/users/"+t.userId).then(this.get.bind(this))},t.prototype.revokeInvite=function(t,e){e.stopPropagation(),this.backendSrv.patch("/api/org/invites/"+t.code+"/revoke").then(this.get.bind(this))},t.prototype.copyInviteToClipboard=function(t){t.stopPropagation()},t.prototype.getInviteUrl=function(t){return t.url},t}();I.a.controller("OrgUsersCtrl",yo);var bo=function(){function t(t,e,a,r){this.backendSrv=t,this.contextSrv=e,this.$location=a,this.teams=[],this.orgs=[],this.showTeamsList=!1,this.showOrgsList=!1,this.readonlyLoginFields=kt.a.disableLoginForm,this.getUser(),this.getUserTeams(),this.getUserOrgs(),this.navModel=r.getNav("profile","profile-settings",0)}return t.$inject=["backendSrv","contextSrv","$location","navModelSrv"],t.prototype.getUser=function(){var t=this;this.backendSrv.get("/api/user").then(function(e){t.user=e,t.user.theme=e.theme||"dark"})},t.prototype.getUserTeams=function(){var t=this;this.backendSrv.get("/api/user/teams").then(function(e){t.teams=e,t.showTeamsList=t.teams.length>0})},t.prototype.getUserOrgs=function(){var t=this;this.backendSrv.get("/api/user/orgs").then(function(e){t.orgs=e,t.showOrgsList=e.length>1})},t.prototype.setUsingOrg=function(t){this.backendSrv.post("/api/user/using/"+t.orgId).then(function(){window.location.href=kt.a.appSubUrl+"/profile"})},t.prototype.update=function(){var t=this;this.userForm.$valid&&this.backendSrv.put("/api/user/",this.user).then(function(){t.contextSrv.user.name=t.user.name||t.user.login,t.oldTheme!==t.user.theme&&(window.location.href=kt.a.appSubUrl+t.$location.path())})},t}();j.d.controller("ProfileCtrl",bo);var So=function(){function t(t,e,a){a.sidemenu=!1,t.navModel={main:{icon:"gicon gicon-branding",subTitle:"偏好",text:"选择活跃组织"}},t.init=function(){t.getUserOrgs()},t.getUserOrgs=function(){e.get("/api/user/orgs").then(function(e){t.orgs=e})},t.setUsingOrg=function(t){e.post("/api/user/using/"+t.orgId).then(function(){window.location.href=kt.a.appSubUrl+"/"})},t.init()}return t.$inject=["$scope","backendSrv","contextSrv"],t}();P.a.module("grafana.controllers").controller("SelectOrgCtrl",So);var xo=function(){function t(t,e,a,r){t.command={},t.authProxyEnabled=kt.a.authProxyEnabled,t.ldapEnabled=kt.a.ldapEnabled,t.navModel=r.getNav("profile","change-password",0),t.changePassword=function(){t.userForm.$valid&&(t.command.newPassword===t.command.confirmNew?e.put("/api/user/password",t.command).then(function(){a.path("profile")}):t.appEvent("alert-warning",["新旧密码不匹配",""]))}}return t.$inject=["$scope","backendSrv","$location","navModelSrv"],t}();P.a.module("grafana.controllers").controller("ChangePasswordCtrl",xo);var wo=function(){function t(t,e,a,r){t.navModel=r.getNav("cfg","admin","global-orgs",1),t.newOrg={name:""},t.createOrg=function(){a.post("/api/orgs/",t.newOrg).then(function(t){a.post("/api/user/using/"+t.orgId).then(function(){window.location.href=kt.a.appSubUrl+"/org"})})}}return t.$inject=["$scope","$http","backendSrv","navModelSrv"],t}();P.a.module("grafana.controllers").controller("NewOrgCtrl",wo);var ko=function(){function t(t,e,a){this.backendSrv=t,this.$location=a,this.navModel=e.getNav("cfg","users",0),this.invite={name:"",email:"",role:"Editor",sendEmail:!0}}return t.$inject=["backendSrv","navModelSrv","$location"],t.prototype.sendInvite=function(){var t=this;if(this.inviteForm.$valid)return this.backendSrv.post("/api/org/invites",this.invite).then(function(){t.$location.path("org/users/")})},t}();I.a.controller("UserInviteCtrl",ko);var Co=function(){function t(t,e,a){this.backendSrv=t,this.$location=e,this.navModel=a.getNav("cfg","teams",0)}return t.$inject=["backendSrv","$location","navModelSrv"],t.prototype.create=function(){var t=this,e={name:this.name,email:this.email};this.backendSrv.post("/api/teams",e).then(function(e){e.teamId&&t.$location.path("/org/teams/edit/"+e.teamId)})},t}();I.a.controller("CreateTeamCtrl",Co);var To=function(){function t(t,e,a,r){t.navModel=r.getNav("cfg","apikeys",0),t.roleTypes=[{text:"观看者",value:"Viewer"},{text:"编辑者",value:"Editor"},{text:"管理员",value:"Admin"}],t.token={role:"Viewer"},t.init=function(){t.getTokens()},t.getTokens=function(){a.get("/api/auth/keys").then(function(e){t.tokens=e})},t.removeToken=function(e){a.delete("/api/auth/keys/"+e).then(t.getTokens)},t.addToken=function(){a.post("/api/auth/keys",t.token).then(function(e){var a=t.$new(!0);a.key=e.key,a.rootPath=window.location.origin+t.$root.appSubUrl,t.appEvent("show-modal",{src:"public/app/features/org/partials/apikeyModal.html",scope:a}),t.getTokens()})},t.init()}return t.$inject=["$scope","$http","backendSrv","navModelSrv"],t}();P.a.module("grafana.controllers").controller("OrgApiKeysCtrl",To);var _o=function(){function t(t,e,a,r,n){t.init=function(){t.getOrgInfo(),t.navModel=n.getNav("cfg","org-settings",0)},t.getOrgInfo=function(){a.get("/api/org").then(function(e){t.org=e,t.address=e.address,r.user.orgName=e.name})},t.update=function(){if(t.orgForm.$valid){var e={name:t.org.name};a.put("/api/org",e).then(t.getOrgInfo)}},t.updateAddress=function(){t.addressForm.$valid&&a.put("/api/org/address",t.address).then(t.getOrgInfo)},t.init()}return t.$inject=["$scope","$http","backendSrv","contextSrv","navModelSrv"],t}();P.a.module("grafana.controllers").controller("OrgDetailsCtrl",_o);var Mo=function(){function t(t,e){this.backendSrv=t,this.$location=e,this.timezones=[{value:"",text:"默认"},{value:"browser",text:"本地浏览器时间"},{value:"utc",text:"UTC"}],this.themes=[{value:"",text:"默认"},{value:"dark",text:"Dark"},{value:"light",text:"Light"}]}return t.$inject=["backendSrv","$location"],t.prototype.$onInit=function(){var t=this;return this.backendSrv.get("/api/"+this.mode+"/preferences").then(function(e){t.prefs=e,t.oldTheme=e.theme})},t.prototype.updatePrefs=function(){var t=this;if(this.prefsForm.$valid){var e={theme:this.prefs.theme,timezone:this.prefs.timezone,homeDashboardId:this.prefs.homeDashboardId};this.backendSrv.put("/api/"+this.mode+"/preferences",e).then(function(){window.location.href=kt.a.appSubUrl+t.$location.path()})}},t}(),$o='\n<form name="ctrl.prefsForm" class="section gf-form-group">\n  <h3 class="page-heading">偏好</h3>\n\n  <div class="gf-form">\n    <span class="gf-form-label width-11">UI主题</span>\n    <div class="gf-form-select-wrapper max-width-20">\n      <select class="gf-form-input" ng-model="ctrl.prefs.theme" ng-options="f.value as f.text for f in ctrl.themes"></select>\n    </div>\n  </div>\n\n  <div class="gf-form">\n    <span class="gf-form-label width-11">\n      主页仪表盘\n      <info-popover mode="right-normal">\n        找不到你想要的仪表盘？ 首先加注星标收藏，然后它将出现在此下拉框中。\n      </info-popover>\n    </span>\n    <dashboard-selector class="gf-form-select-wrapper max-width-20" model="ctrl.prefs.homeDashboardId">\n    </dashboard-selector>\n  </div>\n\n  <div class="gf-form">\n    <label class="gf-form-label width-11">时区</label>\n    <div class="gf-form-select-wrapper max-width-20">\n      <select class="gf-form-input" ng-model="ctrl.prefs.timezone" ng-options="f.value as f.text for f in ctrl.timezones"></select>\n    </div>\n  </div>\n\n  <div class="gf-form-button-row">\n    <button type="submit" class="btn btn-success" ng-click="ctrl.updatePrefs()">保存</button>\n  </div>\n</form>\n';I.a.directive("prefsControl",function(){return{restrict:"E",controller:Mo,bindToController:!0,controllerAs:"ctrl",template:$o,scope:{mode:"@"}}});var Po=function(){function t(t,e,a){this.$scope=t,this.backendSrv=e,this.pages=[],this.perPage=50,this.page=1,this.showPaging=!1,this.navModel=a.getNav("cfg","admin","global-users",1),this.query="",this.getUsers()}return t.$inject=["$scope","backendSrv","navModelSrv"],t.prototype.getUsers=function(){var t=this;this.backendSrv.get("/api/users/search?perpage="+this.perPage+"&page="+this.page+"&query="+this.query).then(function(e){t.users=e.users,t.page=e.page,t.perPage=e.perPage,t.totalPages=Math.ceil(e.totalCount/e.perPage),t.showPaging=t.totalPages>1,t.pages=[];for(var a=1;a<t.totalPages+1;a++)t.pages.push({page:a,current:a===t.page})})},t.prototype.navigateToPage=function(t){this.page=t.page,this.getUsers()},t.prototype.deleteUser=function(t){var e=this;this.$scope.appEvent("confirm-modal",{title:"删除",text:"确定希望删除 "+t.login+"?",icon:"fa-trash",yesText:"删除",onConfirm:function(){e.backendSrv.delete("/api/admin/users/"+t.id).then(function(){e.getUsers()})}})},t}(),Eo=function(){function t(t,e,a,r,n){t.user={},t.newOrg={name:"",role:"Editor"},t.permissions={},t.navModel=n.getNav("cfg","admin","global-users",1),t.init=function(){e.id&&(t.getUser(e.id),t.getUserOrgs(e.id))},t.getUser=function(e){a.get("/api/users/"+e).then(function(a){t.user=a,t.user_id=e,t.permissions.isGrafanaAdmin=a.isGrafanaAdmin})},t.setPassword=function(){if(t.passwordForm.$valid){var e={password:t.password};a.put("/api/admin/users/"+t.user_id+"/password",e).then(function(){r.path("/admin/users")})}},t.updatePermissions=function(){var e=t.permissions;a.put("/api/admin/users/"+t.user_id+"/permissions",e).then(function(){r.path("/admin/users")})},t.create=function(){t.userForm.$valid&&a.post("/api/admin/users",t.user).then(function(){r.path("/admin/users")})},t.getUserOrgs=function(e){a.get("/api/users/"+e+"/orgs").then(function(e){t.orgs=e})},t.update=function(){t.userForm.$valid&&a.put("/api/users/"+t.user_id,t.user).then(function(){r.path("/admin/users")})},t.updateOrgUser=function(e){a.patch("/api/orgs/"+e.orgId+"/users/"+t.user_id,e).then(function(){})},t.removeOrgUser=function(e){a.delete("/api/orgs/"+e.orgId+"/users/"+t.user_id).then(function(){t.getUser(t.user_id),t.getUserOrgs(t.user_id)})},t.orgsSearchCache=[],t.searchOrgs=function(e,r){t.orgsSearchCache.length>0?r(A.a.map(t.orgsSearchCache,"name")):a.get("/api/orgs",{query:""}).then(function(e){t.orgsSearchCache=e,r(A.a.map(e,"name"))})},t.addOrgUser=function(){if(t.addOrgForm.$valid){var e=A.a.find(t.orgsSearchCache,{name:t.newOrg.name});e&&(t.newOrg.loginOrEmail=t.user.login,a.post("/api/orgs/"+e.id+"/users/",t.newOrg).then(function(){t.getUser(t.user_id),t.getUserOrgs(t.user_id)}))}},t.init()}return t.$inject=["$scope","$routeParams","backendSrv","$location","navModelSrv"],t}(),Ao=function(){function t(t,e,a){t.init=function(){t.navModel=a.getNav("cfg","admin","global-orgs",1),t.getOrgs()},t.getOrgs=function(){e.get("/api/orgs").then(function(e){t.orgs=e})},t.deleteOrg=function(a){t.appEvent("confirm-modal",{title:"删除",text:"希望删除组织 "+a.name+"?",text2:"该组织下的所有仪表盘也会被删除!",icon:"fa-trash",yesText:"删除",onConfirm:function(){e.delete("/api/orgs/"+a.id).then(function(){t.getOrgs()})}})},t.init()}return t.$inject=["$scope","backendSrv","navModelSrv"],t}(),Do=function(){function t(t,e,a,r,n){t.init=function(){t.navModel=n.getNav("cfg","admin","global-orgs",1),e.id&&(t.getOrg(e.id),t.getOrgUsers(e.id))},t.getOrg=function(e){a.get("/api/orgs/"+e).then(function(e){t.org=e})},t.getOrgUsers=function(e){a.get("/api/orgs/"+e+"/users").then(function(e){t.orgUsers=e})},t.update=function(){t.orgDetailsForm.$valid&&a.put("/api/orgs/"+t.org.id,t.org).then(function(){r.path("/admin/orgs")})},t.updateOrgUser=function(t){a.patch("/api/orgs/"+t.orgId+"/users/"+t.userId,t)},t.removeOrgUser=function(e){a.delete("/api/orgs/"+e.orgId+"/users/"+e.userId).then(function(){t.getOrgUsers(t.org.id)})},t.init()}return t.$inject=["$scope","$routeParams","backendSrv","$location","navModelSrv"],t}(),Fo=function(){function t(t,e,a){this.$routeParams=t,this.backendSrv=e,this.buttonNames=["primary","secondary","inverse","success","warning","danger"],this.buttonSizes=["btn-small","","btn-large"],this.buttonVariants=["-"],this.navModel=a.getNav("cfg","admin","styleguide",1),this.theme=kt.a.bootData.user.lightTheme?"light":"dark"}return t.$inject=["$routeParams","backendSrv","navModelSrv"],t.prototype.switchTheme=function(){this.$routeParams.theme="dark"===this.theme?"light":"dark";var t={theme:this.$routeParams.theme};this.backendSrv.put("/api/user/preferences",t).then(function(){window.location.href=window.location.href})},t}(),Io=function(){function t(t,e,a){this.navModel=a.getNav("cfg","admin","server-settings",1),e.get("/api/admin/settings").then(function(e){t.settings=e})}return t.$inject=["$scope","backendSrv","navModelSrv"],t}(),Oo=function(){function t(t){this.navModel=t.getNav("cfg","admin",1)}return t.$inject=["navModelSrv"],t}();I.a.controller("AdminListUsersCtrl",Po),I.a.controller("AdminEditUserCtrl",Eo),I.a.controller("AdminListOrgsCtrl",Ao),I.a.controller("AdminEditOrgCtrl",Do),I.a.controller("AdminSettingsCtrl",Io),I.a.controller("AdminHomeCtrl",Oo),I.a.controller("StyleGuideCtrl",Fo);var qo=function(){function t(t,e,a,r,n){var i=this;this.$routeParams=t,this.backendSrv=e,this.$location=a,this.$templateCache=r,this.testSeverity="critical",this.defaults={type:"email",sendReminder:!1,frequency:"15m",settings:{httpMethod:"POST",autoResolve:!0,uploadImage:!0},isDefault:!1},this.navModel=n.getNav("alerting","channels",0),this.isNew=!this.$routeParams.id,this.getFrequencySuggestion=function(){return["1m","5m","10m","15m","30m","1h"]},this.backendSrv.get("/api/alert-notifiers").then(function(t){i.notifiers=t;for(var e=0,a=i.notifiers;e<a.length;e++){var r=a[e];i.$templateCache.put(i.getNotifierTemplateId(r.type),r.optionsTemplate)}return i.$routeParams.id?i.backendSrv.get("/api/alert-notifications/"+i.$routeParams.id).then(function(t){return i.navModel.breadcrumbs.push({text:t.name}),i.navModel.node={text:t.name},t.settings=A.a.defaults(t.settings,i.defaults.settings),t}):(i.navModel.breadcrumbs.push({text:"New channel"}),i.navModel.node={text:"New channel"},A.a.defaults(i.model,i.defaults))}).then(function(t){i.model=t,i.notifierTemplateId=i.getNotifierTemplateId(i.model.type)})}return t.$inject=["$routeParams","backendSrv","$location","$templateCache","navModelSrv"],t.prototype.save=function(){var t=this;this.theForm.$valid&&(this.model.id?this.backendSrv.put("/api/alert-notifications/"+this.model.id,this.model).then(function(e){t.model=e,j.b.emit("alert-success",["通知已更新",""])}).catch(function(t){t.data&&t.data.error&&j.b.emit("alert-error",[t.data.error])}):this.backendSrv.post("/api/alert-notifications",this.model).then(function(e){j.b.emit("alert-success",["通知已创建",""]),t.$location.path("alerting/notifications")}).catch(function(t){t.data&&t.data.error&&j.b.emit("alert-error",[t.data.error])}))},t.prototype.getNotifierTemplateId=function(t){return"notifier-options-"+t},t.prototype.typeChanged=function(){this.model.settings=A.a.defaults({},this.defaults.settings),this.notifierTemplateId=this.getNotifierTemplateId(this.model.type)},t.prototype.testNotification=function(){if(this.theForm.$valid){var t={name:this.model.name,type:this.model.type,frequency:this.model.frequency,settings:this.model.settings};this.backendSrv.post("/api/alert-notifications/test",t).then(function(t){j.b.emit("alert-success",["通知测试已发出",""])})}},t}();j.d.controller("AlertNotificationEditCtrl",qo);var Ro=function(){function t(t,e){this.backendSrv=t,this.loadNotifications(),this.navModel=e.getNav("alerting","channels",0)}return t.$inject=["backendSrv","navModelSrv"],t.prototype.loadNotifications=function(){var t=this;this.backendSrv.get("/api/alert-notifications").then(function(e){t.notifications=e})},t.prototype.deleteNotification=function(t){var e=this;this.backendSrv.delete("/api/alert-notifications/"+t).then(function(){e.notifications=e.notifications.filter(function(e){return e.id!==t})})},t}();j.d.controller("AlertNotificationsListCtrl",Ro);var No=function(){function t(t){this.navModel=t.getNav("dashboards","manage-dashboards",0)}return t.$inject=["navModelSrv"],t}(),Vo=function(){function t(t,e,a){var r=this;this.$rootScope=t,this.backendSrv=e,this.navModel=a.getNav("dashboards","snapshots",0),this.backendSrv.get("/api/dashboard/snapshots").then(function(t){r.snapshots=t})}return t.$inject=["$rootScope","backendSrv","navModelSrv"],t.prototype.removeSnapshotConfirmed=function(t){var e=this;A.a.remove(this.snapshots,{key:t.key}),this.backendSrv.delete("/api/snapshots/"+t.key).then(function(){},function(){e.snapshots.push(t)})},t.prototype.removeSnapshot=function(t){var e=this;this.$rootScope.appEvent("confirm-modal",{title:"删除",text:"确定要删除快照： "+t.name+"?",yesText:"删除",icon:"fa-trash",onConfirm:function(){e.removeSnapshotConfirmed(t)}})},t}();I.a.controller("DashboardListCtrl",No),I.a.controller("SnapshotListCtrl",Vo)}}]);
//# sourceMappingURL=5.b128b55476dbe39ba413.js.map